     1                                  ; ****************************************************************************
     2                                  ; COMMAND.COM (PCDOS 7.1 Command Interpreter) - RETRO DOS v5.0 by ERDOGAN TAN
     3                                  ; ----------------------------------------------------------------------------
     4                                  ; Last Update: 06/08/2024
     5                                  ; ----------------------------------------------------------------------------
     6                                  ; Beginning: 18/07/2024 (v7.1) - ((Previous: 19/06/2023 COMMAND.COM v6.22))
     7                                  ; ----------------------------------------------------------------------------
     8                                  ; Assembler: NASM version 2.15
     9                                  ; ----------------------------------------------------------------------------
    10                                  ;	    ((nasm command7.s -l command7.txt -o COMMAND.COM)) 	
    11                                  ; ****************************************************************************
    12                                  ; Modified from 'command6.s' 
    13                                  ;		(Retro DOS 4.2 - MSDOS 6.22 COMMAND.COM) source code
    14                                  ; 		in NASM syntax (by Erdogan Tan), 19/06/2023
    15                                  ; ----------------------------------------------------------------------------
    16                                  ; Labels and comments etc. are based on MSDOS 6.0 COMMAND.COM source code.
    17                                  ; However, this source code is mainly developed from the source code of
    18                                  ; Retro DOS v4.2 COMMAND.COM and PCDOS 7.1 COMMAND.COM disassembly.
    19                                  ; ----------------------------------------------------------------------------
    20                                  ; MSDOS 6.0 source files:
    21                                  ;;============================================================================
    22                                  ;; This PCDOS source code is verified & modified by using IDA Pro Disassembler
    23                                  ;;============================================================================
    24                                  ;
    25                                  ; COMMAND.COM v6.0 source files:
    26                                  ;      command1.asm, command2.asm, rucode.asm, stub.asm, rdata.asm, init.asm,
    27                                  ;      iparse.asm, uinit.asm, tcode.asm, tbatch.asm, tbatch2.asm, tfor.asm,
    28                                  ;      dir.asm, cratio.asm, tcmd1b.asm, tcmd2a.asm, tcmd2b.asm, tenv.asm,
    29                                  ;      tenv2.asm, tmisc1.asm, tmisc2.asm, tpipe.asm, parse2.asm, path1.asm,
    30                                  ;      path2.asm, tucode.asm, copy.asm, copypr1.asm, copypr2.asm, cparse.asm,
    31                                  ;      tparse.asm, tprintf.asm, loadhi.asm, tdata.asm, tspc.asm
    32                                  ;
    33                                  ; COMMAND.COM v2.11 source files:
    34                                  ;      COMMAND.ASM (+ DOSYM.ASM,DEVSYM.ASM,COMSW.ASM,COMEQU.ASM,IFEQU.ASM)
    35                                  ;      RUCODE.ASM, RDATA.ASM, INIT.ASM, UINIT.ASM
    36                                  ;      TCODE.ASM, TCODE2.ASM, TCODE3.ASM, TCODE4.ASM, TCODE5.ASM,
    37                                  ;      TUCODE.ASM, COPY.ASM, COPYPROC.ASM, CPARSE.ASM, TDATA.ASM, TSPC.ASM
    38                                  ;
    39                                  ; ----------------------------------------------------------------------------
    40                                  ; 09/01/2023 - COMMAND.COM v5.0 (Multi Section Binary File Format)
    41                                  
    42                                  ;============================================================================
    43                                  ; MSDOS 6.22 COMMAND.COM, DISASSEMBLED by Erdogan Tan, 17/05/2023-05/06/2023
    44                                  ;============================================================================
    45                                  
    46                                  ; -=========================================================================¬
    47                                  ; ¦     This file is generated by The Interactive Disassembler (IDA)        ¦
    48                                  ; ¦     Copyright (c) 2010 by Hex-Rays SA, <support@hex-rays.com>           ¦
    49                                  ; ¦                      Licensed to: Freeware version                      ¦
    50                                  ; L=========================================================================-
    51                                  ;
    52                                  ; Input MD5   : FAF051453F215165981F10BD73071D88
    53                                  ;
    54                                  ; File Name   : C:\Users\Erdo­an\Desktop\COMMAND.COM
    55                                  ; Format      : MS-DOS COM-file
    56                                  ; Base Address: 0h Range: 100h-D675h Loaded length: D575h
    57                                  
    58                                  ;============================================================================
    59                                  ; SYSCALL.INC, MSDOS 6.0, 1991
    60                                  ;============================================================================
    61                                  ; 21/09/2018 - Retro DOS v3.0
    62                                  
    63                                  ;	SCCSID = @(#)syscall.asm	1.1 85/04/10
    64                                  ;BREAK <system call definitions>
    65                                  
    66                                  ;
    67                                  ;	Microsoft Confidential
    68                                  ;	Copyright (C) Microsoft Corporation 1991
    69                                  ;	All Rights Reserved.
    70                                  ;
    71                                  
    72                                  ;SUBTTL	system call definitions
    73                                  ;PAGE
    74                                  
    75                                  Abort				EQU 0	;  0	  0
    76                                  STD_CON_INPUT			EQU 1	;  1	  1
    77                                  Std_Con_Output			EQU 2	;  2	  2
    78                                  Std_Aux_Input			EQU 3	;  3	  3
    79                                  Std_Aux_Output			EQU 4	;  4	  4
    80                                  Std_Printer_Output		EQU 5	;  5	  5
    81                                  Raw_Con_IO			EQU 6	;  6	  6
    82                                  RAW_CON_INPUT			EQU 7	;  7	  7
    83                                  Std_Con_Input_No_Echo		EQU 8	;  8	  8
    84                                  STD_CON_STRING_OUTPUT		EQU 9	;  9	  9
    85                                  Std_Con_String_Input		EQU 10	; 10	  A
    86                                  Std_Con_Input_Status		EQU 11	; 11	  B
    87                                  STD_CON_INPUT_FLUSH		EQU 12	; 12	  C
    88                                  DISK_RESET			EQU 13	; 13	  D
    89                                  Set_Default_Drive		EQU 14	; 14	  E
    90                                  FCB_Open			EQU 15	; 15	  F
    91                                  FCB_Close			EQU 16	; 16	 10
    92                                  Dir_Search_First		EQU 17	; 17	 11
    93                                  Dir_Search_Next 		EQU 18	; 18	 12
    94                                  FCB_Delete			EQU 19	; 19	 13
    95                                  FCB_Seq_Read			EQU 20	; 20	 14
    96                                  FCB_Seq_Write			EQU 21	; 21	 15
    97                                  FCB_Create			EQU 22	; 22	 16
    98                                  FCB_Rename			EQU 23	; 23	 17
    99                                  GET_DEFAULT_DRIVE		EQU 25	; 25	 19
   100                                  Set_DMA 			EQU 26	; 26	 1A
   101                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   102                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   103                                  ;									   ;
   104                                  Get_Default_DPB 		EQU 31	; 31	 1F
   105                                  ;									   ;
   106                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   107                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   108                                  FCB_Random_Read 		EQU 33	; 33	 21
   109                                  FCB_Random_Write		EQU 34	; 34	 22
   110                                  Get_FCB_File_Length		EQU 35	; 35	 23
   111                                  Get_FCB_Position		EQU 36	; 36	 24
   112                                  SET_INTERRUPT_VECTOR		EQU 37	; 37	 25
   113                                  Create_Process_Data_Block	EQU 38	; 38	 26
   114                                  FCB_Random_Read_Block		EQU 39	; 39	 27
   115                                  FCB_Random_Write_Block		EQU 40	; 40	 28
   116                                  Parse_File_Descriptor		EQU 41	; 41	 29
   117                                  Get_Date			EQU 42	; 42	 2A
   118                                  Set_Date			EQU 43	; 43	 2B
   119                                  Get_Time			EQU 44	; 44	 2C
   120                                  Set_Time			EQU 45	; 45	 2D
   121                                  SET_VERIFY_ON_WRITE		EQU 46	; 46	 2E
   122                                  ; Extended functionality group
   123                                  Get_DMA 			EQU 47	; 47	 2F
   124                                  GET_VERSION			EQU 48	; 48	 30
   125                                  Keep_Process			EQU 49	; 49	 31
   126                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   127                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   128                                  ;									   ;
   129                                  Get_DPB 			EQU 50	; 50	 32
   130                                  ;									   ;
   131                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   132                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   133                                  Set_CTRL_C_Trapping		EQU 51	; 51	 33
   134                                  Get_InDOS_Flag			EQU 52	; 52	 34
   135                                  Get_Interrupt_Vector		EQU 53	; 53	 35
   136                                  Get_Drive_Freespace		EQU 54	; 54	 36
   137                                  CHAR_OPER			EQU 55	; 55	 37
   138                                  International			EQU 56	; 56	 38
   139                                  ;   Directory Group
   140                                  MKDir				EQU 57	; 57	 39
   141                                  RMDir				EQU 58	; 58	 3A
   142                                  CHDir				EQU 59	; 59	 3B
   143                                  ;   File Group
   144                                  Creat				EQU 60	; 60	 3C
   145                                  OPEN				EQU 61	; 61	 3D
   146                                  CLOSE				EQU 62	; 62	 3E
   147                                  READ				EQU 63	; 63	 3F
   148                                  Write				EQU 64	; 64	 40
   149                                  Unlink				EQU 65	; 65	 41
   150                                  LSEEK				EQU 66	; 66	 42
   151                                  CHMod				EQU 67	; 67	 43
   152                                  IOCTL				EQU 68	; 68	 44
   153                                  XDUP				EQU 69	; 69	 45
   154                                  XDup2				EQU 70	; 70	 46
   155                                  Current_Dir			EQU 71	; 71	 47
   156                                  ;    Memory Group
   157                                  ALLOC				EQU 72	; 72	 48
   158                                  DEALLOC				EQU 73	; 73	 49
   159                                  SETBLOCK			EQU 74	; 74	 4A
   160                                  ;    Process Group
   161                                  Exec				EQU 75	; 75	 4B
   162                                  EXIT				EQU 76	; 76	 4C
   163                                  WAITPROCESS			EQU 77	; 77	 4D
   164                                  Find_First			EQU 78	; 78	 4E
   165                                  ;   Special Group
   166                                  Find_Next			EQU 79	; 79	 4F
   167                                  ; SPECIAL SYSTEM GROUP
   168                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   169                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   170                                  ;									   ;
   171                                  SET_CURRENT_PDB 		EQU 80	; 80	 50
   172                                  GET_CURRENT_PDB 		EQU 81	; 81	 51
   173                                  Get_In_Vars			EQU 82	; 82	 52
   174                                  SetDPB				EQU 83	; 83	 53
   175                                  ;									   ;
   176                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   177                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   178                                  Get_Verify_On_Write		EQU 84	; 84	 54
   179                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   180                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   181                                  ;									   ;
   182                                  Dup_PDB 			EQU 85	; 85	 55
   183                                  ;									   ;
   184                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   185                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   186                                  Rename				EQU 86	; 86	 56
   187                                  File_Times			EQU 87	; 87	 57
   188                                  AllocOper			EQU 88	; 88	 58
   189                                  ; Network extention system calls
   190                                  GetExtendedError		EQU 89	; 89	 59
   191                                  CreateTempFile			EQU 90	; 90	 5A
   192                                  CreateNewFile			EQU 91	; 91	 5B
   193                                  LockOper			EQU 92	; 92	 5C Lock and Unlock
   194                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   195                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   196                                  ;									   ;
   197                                  ServerCall			EQU 93	; 93	 5D CommitAll, ServerDOSCall,
   198                                  					;	    CloseByName, CloseUser,
   199                                  					;	    CloseUserProcess,
   200                                  					;	    GetOpenFileList
   201                                  ;									   ;
   202                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   203                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   204                                  UserOper			EQU 94	; 94	 5E Get and Set
   205                                  AssignOper			EQU 95	; 95	 5F On, Off, Get, Set, Cancel
   206                                  xNameTrans			EQU 96	; 96	 60
   207                                  PathParse			EQU 97	; 97	 61
   208                                  GetCurrentPSP			EQU 98	; 98	 62
   209                                  Hongeul 			EQU 99	; 99	 63
   210                                  ECS_CALL			EQU 99	; 99	 63  ;; DBCS support
   211                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   212                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   213                                  ;									   ;
   214                                  Set_Printer_Flag		EQU 100 ; 100	 64
   215                                  ;									   ;
   216                                  ;	     C	A  V  E  A  T	  P  R	O  G  R  A  M  M  E  R		   ;
   217                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   218                                  GetExtCntry			EQU 101 ; 101	 65
   219                                  GetSetCdPg			EQU 102 ; 102	 66
   220                                  ExtHandle			EQU 103 ; 103	 67
   221                                  Commit				EQU 104 ; 104	 68
   222                                  GetSetMediaID			EQU 105 ; 105	 69
   223                                  IFS_IOCTL			EQU 107 ; 107	 6B
   224                                  ExtOpen 			EQU 108 ; 108	 6C
   225                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   226                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   227                                  ;                                                                          ;
   228                                  ;ifdef ROMEXEC
   229                                  ;ROM_FIND_FIRST			EQU 109 ; 109    6D
   230                                  ;ROM_FIND_NEXT			EQU 110 ; 110    6E
   231                                  ;ROM_EXCLUDE			EQU 111 ; 111	 6F		; M035
   232                                  ;endif
   233                                  ;                                                                          ;
   234                                  ;            C  A  V  E  A  T     P  R  O  G  R  A  M  M  E  R             ;
   235                                  ;----+----+----+----+----+----+----+----+----+----+----+----+----+----+----;
   236                                  ;
   237                                  ;
   238                                  Set_Oem_Handler 		EQU 248 ; 248	 F8
   239                                  OEM_C1				EQU 249 ; 249	 F9
   240                                  OEM_C2				EQU 250 ; 250	 FA
   241                                  OEM_C3				EQU 251 ; 251	 FB
   242                                  OEM_C4				EQU 252 ; 252	 FC
   243                                  OEM_C5				EQU 253 ; 253	 FD
   244                                  OEM_C6				EQU 254 ; 254	 FE
   245                                  OEM_C7				EQU 255 ; 255	 FF
   246                                  
   247                                  ;============================================================================
   248                                  ; DOSSYM.INC, MSDOS 6.0, 1991
   249                                  ;============================================================================
   250                                  ; 21/09/2018 - Retro DOS v3.0
   251                                  
   252                                  ;BREAK <Control character definitions>
   253                                  
   254                                  c_DEL	    EQU     7Fh 	;    ASCII rubout or delete previous char
   255                                  c_BS	    EQU     08h 	; ^H ASCII backspace
   256                                  c_CR	    EQU     0Dh 	; ^M ASCII carriage return
   257                                  c_LF	    EQU     0Ah 	; ^J ASCII linefeed
   258                                  c_ETB	    EQU     17h 	; ^W ASCII end of transmission
   259                                  c_NAK	    EQU     15h 	; ^U ASCII negative acknowledge
   260                                  c_ETX	    EQU     03h 	; ^C ASCII end of text
   261                                  c_HT	    EQU     09h 	; ^I ASCII tab
   262                                  
   263                                  ;============================================================================
   264                                  ; DIRENT.INC, MSDOS 6.0, 1991
   265                                  ;============================================================================
   266                                  ; 21/09/2018 - Retro DOS v3.0
   267                                  
   268                                  ;Break <Directory entry>
   269                                  
   270                                  ;	NOTE:  These offsets are also used in the DTA for
   271                                  ;	extended FCB SearchFirst/Next. DIR_NAME lines up
   272                                  ;	with the FCB filename field, and the rest of the
   273                                  ;	DIR_ENTRY fields follow. -DavidOls
   274                                  
   275                                  ;**	DIRENT.INC - FAT Directory Entry Definition
   276                                  ;
   277                                  ;	+---------------------------+
   278                                  ;	|  (12 BYTE) filename/ext   |	    0	    0
   279                                  ;	+---------------------------+
   280                                  ;	|     (BYTE) attributes     |	    11	    B
   281                                  ;	+---------------------------+
   282                                  ;	|    (10 BYTE) reserved     |	    12	    C
   283                                  ;	+---------------------------+
   284                                  ;	| (WORD) time of last write |	    22	    16
   285                                  ;	+---------------------------+
   286                                  ;	| (WORD) date of last write |	    24	    18
   287                                  ;	+---------------------------+
   288                                  ;	|   (WORD) First cluster    |	    26	    1A
   289                                  ;	+---------------------------+
   290                                  ;	|     (DWORD) file size     |	    28	    1C
   291                                  ;	+---------------------------+
   292                                  ;
   293                                  ;   First byte of filename  = E5 -> free directory entry
   294                                  ;			    = 00 -> end of allocated directory
   295                                  ;   Time:   Bits 0-4=seconds/2, bits 5-10=minute, 11-15=hour
   296                                  ;   Date:   Bits 0-4=day, bits 5-8=month, bits 9-15=year-1980
   297                                  ;
   298                                  
   299                                  STRUC DIR_ENTRY
   300 00000000 <res Bh>                .DIR_NAME:	RESB  11	; file name
   301 0000000B ??                      .DIR_ATTR:	RESB  1		; attribute bits
   302 0000000C ????                    .DIR_CODEPG:	RESW  1		; code page DOS 4.00
   303 0000000E ????                    .DIR_EXTCLUSTER: RESW 1		; extended attribute starting cluster
   304 00000010 ??                      .DIR_ATTR2:	RESB  1		; reserved
   305 00000011 ??????????              .DIR_PAD:	RESB  5		; reserved for expansion
   306 00000016 ????                    .DIR_TIME:	RESW  1		; time of last write
   307 00000018 ????                    .DIR_DATE:	RESW  1		; date of last write
   308 0000001A ????                    .DIR_FIRST:	RESW  1		; first allocation unit of file
   309 0000001C ????                    .DIR_SIZE_L:	RESW  1		; low 16 bits of file size
   310 0000001E ????                    .DIR_SIZE_H:	RESW  1		; high 16 bits of file size
   311                                  .size:
   312                                  
   313                                  ;	    Caution: An extended FCB SearchFirst/Next on a network
   314                                  ;	    drive under Novell Netware 286 or 386 returns the time/date
   315                                  ;	    in the SIZE fields for subdirectory files. Ordinarily,
   316                                  ;	    this field is zero for subdirectory files.
   317                                  
   318                                  ENDSTRUC
   319                                  
   320                                  ATTR_READ_ONLY	equ	 1h
   321                                  ATTR_HIDDEN	equ	 2h
   322                                  ATTR_SYSTEM	equ	 4h
   323                                  ATTR_VOLUME_ID	equ	 8h
   324                                  ATTR_DIRECTORY	equ	10h
   325                                  ATTR_ARCHIVE	equ	20h
   326                                  ATTR_DEVICE	equ	40h	; This is a VERY special bit.
   327                                  				;   NO directory entry on a disk EVER
   328                                  				;   has this bit set. It is set non-zero
   329                                  				;   when a device is found by GETPATH
   330                                  
   331                                  ATTR_ALL	equ	ATTR_HIDDEN+ATTR_SYSTEM+ATTR_DIRECTORY
   332                                  				; OR of hard attributes for FINDENTRY
   333                                  
   334                                  ATTR_IGNORE	equ	ATTR_READ_ONLY+ATTR_ARCHIVE+ATTR_DEVICE
   335                                  				; ignore this(ese) attribute(s) during
   336                                  				; search first/next
   337                                  
   338                                  ATTR_CHANGEABLE equ	ATTR_READ_ONLY+ATTR_HIDDEN+ATTR_SYSTEM+ATTR_ARCHIVE
   339                                  				; changeable via CHMOD
   340                                  
   341                                  DIRFREE 	equ	0E5h	; stored in dir_name[0] to indicate free slot
   342                                  
   343                                  ;============================================================================
   344                                  ; ERROR.INC, MSDOS 6.0, 1991
   345                                  ;============================================================================
   346                                  ; 21/09/2018 - Retro DOS v3.0
   347                                  
   348                                  ;**	ERROR.INC - DOS Error Codes
   349                                  ;
   350                                  ;    The newer (DOS 2.0 and above) "XENIX-style" calls
   351                                  ;    return error codes through AX.	If an error occurred then
   352                                  ;    the carry bit will be set and the error code is in AX.	If no error
   353                                  ;    occurred then the carry bit is reset and AX contains returned info.
   354                                  ;
   355                                  ;    Since the set of error codes is being extended as we extend the operating
   356                                  ;    system, we have provided a means for applications to ask the system for a
   357                                  ;    recommended course of action when they receive an error.
   358                                  ;
   359                                  ;    The GetExtendedError system call returns a universal error, an error
   360                                  ;    location and a recommended course of action.	The universal error code is
   361                                  ;    a symptom of the error REGARDLESS of the context in which GetExtendedError
   362                                  ;    is issued.
   363                                  
   364                                  
   365                                  ;	2.0 error codes
   366                                  
   367                                  error_invalid_function		EQU	1
   368                                  ERROR_FILE_NOT_FOUND		EQU	2
   369                                  ERROR_PATH_NOT_FOUND		EQU	3
   370                                  ERROR_TOO_MANY_OPEN_FILES	EQU	4
   371                                  ERROR_ACCESS_DENIED		EQU	5
   372                                  error_invalid_handle		EQU	6
   373                                  error_arena_trashed		EQU	7
   374                                  ERROR_NOT_ENOUGH_MEMORY 	EQU	8
   375                                  error_invalid_block		EQU	9
   376                                  error_bad_environment		EQU	10
   377                                  ERROR_BAD_FORMAT		EQU	11
   378                                  error_invalid_access		EQU	12
   379                                  ERROR_INVALID_DATA		EQU	13
   380                                  ;**** reserved			EQU	14	; *****
   381                                  error_invalid_drive		EQU	15
   382                                  error_current_directory 	EQU	16
   383                                  error_not_same_device		EQU	17
   384                                  ERROR_NO_MORE_FILES		EQU	18
   385                                  
   386                                  ;	These are the universal int 24 mappings for the old INT 24 set of errors
   387                                  
   388                                  ERROR_WRITE_PROTECT		EQU	19
   389                                  error_bad_unit			EQU	20
   390                                  error_not_ready 		EQU	21
   391                                  error_bad_command		EQU	22
   392                                  error_CRC			EQU	23
   393                                  error_bad_length		EQU	24
   394                                  error_Seek			EQU	25
   395                                  error_not_DOS_disk		EQU	26
   396                                  error_sector_not_found		EQU	27
   397                                  error_out_of_paper		EQU	28
   398                                  error_write_fault		EQU	29
   399                                  error_read_fault		EQU	30
   400                                  ERROR_GEN_FAILURE		EQU	31
   401                                  
   402                                  ;	the new 3.0 error codes reported through INT 24
   403                                  
   404                                  error_sharing_violation 	EQU	32
   405                                  error_lock_violation		EQU	33
   406                                  error_wrong_disk		EQU	34
   407                                  ERROR_FCB_UNAVAILABLE		EQU	35
   408                                  ERROR_SHARING_BUFFER_EXCEEDED	EQU	36
   409                                  error_Code_Page_Mismatched	EQU	37    ; DOS 4.00	;AN000;
   410                                  error_handle_EOF		EQU	38    ; DOS 4.00	;AN000;
   411                                  ERROR_HANDLE_DISK_FULL		EQU	39    ; DOS 4.00	;AN000;
   412                                  
   413                                  ;	New OEM network-related errors are 50-79
   414                                  
   415                                  error_not_supported		EQU	50
   416                                  
   417                                  error_net_access_denied		EQU	65	;M028
   418                                  
   419                                  ;	End of INT 24 reportable errors
   420                                  
   421                                  error_file_exists		EQU	80
   422                                  error_DUP_FCB			EQU	81	; *****
   423                                  error_cannot_make		EQU	82
   424                                  error_FAIL_I24			EQU	83
   425                                  
   426                                  ;	New 3.0 network related error codes
   427                                  
   428                                  error_out_of_structures 	EQU	84
   429                                  error_Already_assigned		EQU	85
   430                                  error_invalid_password		EQU	86
   431                                  error_invalid_parameter 	EQU	87
   432                                  error_NET_write_fault		EQU	88
   433                                  error_sys_comp_not_loaded	EQU	90    ; DOS 4.00	;AN000;
   434                                  
   435                                  ;============================================================================
   436                                  ; DEVSYM.INC, MSDOS 6.0, 1991
   437                                  ;============================================================================
   438                                  ; 22/09/2018 - Retro DOS v3.0
   439                                  
   440                                  ;**	DevSym.inc - Device Symbols
   441                                  
   442                                  ;	THE DEVICE TABLE LIST HAS THE FORM:
   443                                  
   444                                  STRUC SYSDEV
   445 00000000 ????????                .NEXT:	RESD 1			;POINTER TO NEXT DEVICE HEADER
   446 00000004 ????                    .ATT:	RESW 1			;ATTRIBUTES OF THE DEVICE
   447 00000006 ????                    .STRAT:	RESW 1			;STRATEGY ENTRY POINT
   448 00000008 ????                    .INT:	RESW 1			;INTERRUPT ENTRY POINT
   449 0000000A ????????????????        .NAME:	RESB 8			;NAME OF DEVICE (ONLY FIRST BYTE USED FOR BLOCK)
   450                                  .size:
   451                                  ENDSTRUC
   452                                  
   453                                  ; 24/09/2018
   454                                  DEVTYP	EQU   8000H	; BIT 15 - 1  IF CHAR, 0 IF BLOCK
   455                                  
   456                                  ;============================================================================
   457                                  ; CURDIR.INC, MSDOS 6.0, 1991
   458                                  ;============================================================================
   459                                  ; 21/09/2018 - Retro DOS v3.0
   460                                  
   461                                  DIRSTRLEN	EQU	64+3	; Max length in bytes of directory strings
   462                                  
   463                                  ;============================================================================
   464                                  ; COMEQU.ASM, MSDOS 6.0, 1991
   465                                  ;============================================================================
   466                                  ; 21/09/2018 - Retro DOS v3.0
   467                                  
   468                                  ;/*
   469                                  ; *                      Microsoft Confidential
   470                                  ; *                      Copyright (C) Microsoft Corporation 1991
   471                                  ; *                      All Rights Reserved.
   472                                  ; */
   473                                  ;	SCCSID = @(#)comequ.asm 1.1 85/05/14
   474                                  ;	SCCSID = @(#)comequ.asm 1.1 85/05/14
   475                                  ;*************************************
   476                                  ; COMMAND EQUs which are not switch dependant
   477                                  
   478                                  ;		include	curdir.inc	; to get DIRSTRLEN
   479                                  ;		Note dossym.inc must already have been included!
   480                                  
   481                                  GET_COMMAND_STATE	equ	5500h	; check for existing COMMAND
   482                                  GET_ROMCOMMAND_STATE	equ	5501h	; check for existing ROM COMMAND
   483                                  
   484                                  SYM		EQU	">"
   485                                  
   486                                  LINESPERPAGE	EQU	25		;AC000; default lines per page
   487                                  
   488                                  NORMPERLIN	EQU	1
   489                                  WIDEPERLIN	EQU	5
   490                                  COMBUFLEN	EQU	128		; Length of commmand buffer
   491                                  BatLen		EQU	32		; buffer for batch files
   492                                  YES_ECHO	EQU	1		; echo line
   493                                  NO_ECHO 	EQU	0		; don't echo line
   494                                  No_Echo_Char	EQU	"@"             ; don't echo line if this is first char
   495                                  call_in_progress EQU	1		; indicate we're in the CALL command
   496                                  length_call	EQU	4		; length of CALL
   497                                  max_nest	EQU    10		; max # levels of batch nesting allowed
   498                                  FAIL_ALLOWED	EQU    00001000b	; critical error
   499                                  RETRY_ALLOWED	EQU    00010000b	; critical error
   500                                  IGNORE_ALLOWED	EQU    00100000b	; critical error
   501                                  nullcommand	EQU     1		; no command on command line
   502                                  END_OF_LINE	EQU    -1		;AN000; end of line return from parser
   503                                  END_OF_LINE_OUT EQU	0		;AN000; end of line for output
   504                                  END_OF_LINE_IN	EQU	0Dh		;AN000; end of line for input
   505                                  result_number	EQU	1		;AN000; number returned from parser
   506                                  result_string	EQU	3		;AN000; string returned from parser
   507                                  RESULT_FILESPEC EQU	5		;AN000; filespec returned from parser
   508                                  result_drive	EQU	6		;AN000; drive returned from parser
   509                                  result_date	EQU	7		;AN000; date returned from parser
   510                                  result_time	EQU	8		;AN000; time returned from parser
   511                                  RESULT_NO_ERROR EQU	0		;AN000; no error returned from parser
   512                                  no_cont_flag	EQU	0		;AN000; no control flags for message
   513                                  util_msg_class	EQU	-1		;AN000; message class for utility
   514                                  ext_msg_class	EQU	1		;AN000; message class for extended error
   515                                  parse_msg_class EQU	2		;AN000; message class for parse error
   516                                  crit_msg_class	EQU	3		;AN000; message class for critical error
   517                                  ext_crlf_class	EQU	081h		;AN054; message class for extended error with no CRLF
   518                                  colon_char	EQU	":"             ;AN000; colon character
   519                                  crt_ioctl_ln	EQU	14		;AN000; default length of data for display ioctl
   520                                  text_mode	EQU	1		;AN000; text mode return from ioctl
   521                                  get_generic	EQU	07Fh		;AN000; generic ioctl - get device info
   522                                  set_crit_dev	EQU	0100H		;AN000; device attribute for critical error on I/0
   523                                  mult_ansi	EQU	01Ah		;AC064; multiplex for ansi.sys
   524                                  mult_shell_get	EQU	01902h		;AC065; multiplex for Shell - get next command
   525                                  mult_shell_brk	EQU	01903h		;AN000; multiplex for Shell - ^C batch check
   526                                  shell_action	equ	0FFh		;AN000; SHELL - return for taking SHELL specific action
   527                                  bat_not_open	EQU	-1		;AN000; batch handle will be set to this if not open
   528                                  bat_open_handle EQU	19		;AN000; handle will be in this position in JFN table
   529                                  Ptr_seg_pos	equ	7		;AN000; Offset from start of message block for subst segment
   530                                  Ptr_off_pos	equ	5		;AN000; Offset from start of message block for subst offset
   531                                  %define Parm_off_pos	word [2]	;AN000; Offset from start of subst list for subst offset
   532                                  parm_block_size equ	11		;AN000; size of message subst block
   533                                  blank		equ	" "             ;AN000; blank character
   534                                  no_subst	equ	0		;AN000; no substitutions for messages
   535                                  one_subst	equ	1		;AN000; one substitution for messages
   536                                  no_handle_out	equ	-1		;AN000; use function 1 thru 12 for message retriever
   537                                  res_subst	equ	2		;AN000; offset from start of message definition to number of subst
   538                                  read_open_mode	equ   0000000000000000b ;AN024; extended open mode for read
   539                                  deny_write	equ   0000000000100000b	; deny write sharing mode ;M031
   540                                  deny_none	equ   0000000001000000b	; deny none sharing mode ;Myyy	
   541                                  read_open_flag	equ   0000000100000001b ;AN000; extended open flags for read
   542                                  write_open_mode equ   0000000000000001b ;AN024; extended open mode for read
   543                                  write_open_flag equ   0000000100000001b ;AN000; extended open flags for read
   544                                  creat_open_flag equ   0000000100010010b ;AN000; extended open flags for read
   545                                  capital_A	equ	'A'             ;AC000;
   546                                  vbar		equ	'|'             ;AC000;
   547                                  labracket	equ	'<'             ;AC000;
   548                                  rabracket	equ	'>'             ;AC000;
   549                                  dollar		equ	'$'             ;AC000;
   550                                  lparen		equ	'('             ;AC000;
   551                                  rparen		equ	')'             ;AC000;
   552                                  nullrparen	equ	29h		;AC000;
   553                                  in_word 	equ	4E49h		;AC000; 'NI'  ('IN' backwards)
   554                                  do_word 	equ	4F44h		;AC000; 'OD'  ('DO' backwards)
   555                                  star		equ	'*'             ;AC000;
   556                                  plus_chr	equ	'+'             ;AC000;
   557                                  small_a 	equ	'a'             ;AC000;
   558                                  small_z 	equ	'z'             ;AC000;
   559                                  dot_chr 	equ	'.'             ;AC000;
   560                                  tab_chr 	equ	9		;AN032;
   561                                  equal_chr	equ	'='             ;AN032;
   562                                  semicolon	equ	';'             ;AN049;
   563                                  dot_qmark	equ	2e3fh		;AC000; '.?'
   564                                  dot_colon	equ	2e3ah		;AC000; '.:'
   565                                  capital_n	equ	0		;AC000; result from Y/N call if N entered
   566                                  capital_y	equ	1		;AC000; result from Y/N call if Y entered
   567                                  AppendInstall	equ	0B700H		;AN020; append install check
   568                                  AppendDOS	equ	0B702H		;AN020; append DOS version check
   569                                  AppendGetState	equ	0B706H		;AN020; append get current state
   570                                  AppendSetState	equ	0B707H		;AN020; append set current state
   571                                  AppendTruename	equ	0B711H		;AN042; Get file's real location for Batch
   572                                  search_attr	equ	ATTR_READ_ONLY+ATTR_HIDDEN+ATTR_DIRECTORY  ;AC042;
   573                                  
   574                                  ;*************************************
   575                                  ;* PARSE ERROR MESSAGES
   576                                  ;*************************************
   577                                  
   578                                  MoreArgs_Ptr	equ	1		;AN000;"Too many parameters" message number
   579                                  LessArgs_Ptr	equ	2		;AN000;"Required parameter missing" message number
   580                                  BadSwt_Ptr	equ	3		;AN000;"Invalid switch" message number
   581                                  BadParm_Ptr	equ	10		;AN000;"Invalid parameter" message number
   582                                  
   583                                  ;*************************************
   584                                  ;* EQUATES FOR MESSAGE RETRIEVER
   585                                  ;*************************************
   586                                  
   587                                  GET_EXTENDED_MSG	EQU	0	;AN000;  get extended message address
   588                                  SET_EXTENDED_MSG	EQU	1	;AN000;  set extended message address
   589                                  GET_PARSE_MSG		EQU	2	;AN000;  get parse message address
   590                                  SET_PARSE_MSG		EQU	3	;AN000;  set parse message address
   591                                  GET_CRITICAL_MSG	EQU	4	;AN000;  get critical message address
   592                                  SET_CRITICAL_MSG	EQU	5	;AN000;  set critical message address
   593                                  MESSAGE_2F		EQU	46	;AN000;  minor code for message retriever
   594                                  
   595                                  ;*********************************
   596                                  ;* EQUATES FOR INT 10H
   597                                  ;*********************************
   598                                  
   599                                  VIDEO_IO_INT		EQU	10H	;AN000;  equate for int 10h
   600                                  SET_VIDEO_MODE		EQU	0	;AN000;  set video mode
   601                                  SET_CURSOR_POSITION	EQU	2	;AN000;  set new cursor position
   602                                  SCROLL_VIDEO_PAGE	EQU	6	;AN000;  scroll active page up
   603                                  VIDEO_ATTRIBUTE 	EQU	7	;AN000;  attribute to be used on blank line
   604                                  SET_COLOR_PALETTE	EQU	11	;AN000;  set color for video
   605                                  GET_VIDEO_STATE 	EQU	15	;AN000;  get current video state
   606                                  VIDEO_ALPHA		EQU	3	;AN000;  alpha video is 3 or below
   607                                  VIDEO_BW		EQU	7	;AN000;  mode for 80X25 black & white
   608                                  
   609                                  AltPipeChr	equ	"|"             ; alternate pipe character
   610                                  
   611                                  FCB		equ	5Ch
   612                                  
   613                                  STRUC VARSTRUC
   614 00000000 ??                      .ISDIR:		RESB	1
   615 00000001 ??                      .SIZ:		RESB	1
   616 00000002 ????                    .TTAIL:		RESW	1
   617 00000004 ??                      .INFO:		RESB	1
   618 00000005 <res 57h>               .BUF:		RESB	DIRSTRLEN + 20
   619                                  .size:
   620                                  ENDSTRUC
   621                                  ;
   622                                  ; Flags for internal command parsing
   623                                  ;
   624                                  fCheckDrive	equ	00000001b	; validate drive letter
   625                                  fSwitchAllowed	equ	00000010b	; switches allowed
   626                                  fLimitHelp	equ	00000100b	; /? must appear alone
   627                                  
   628                                  ;
   629                                  ; Test switches
   630                                  ;
   631                                  fParse		EQU	0001h		; display results of parseline
   632                                  
   633                                  ;
   634                                  ; Batch segment structure
   635                                  ;
   636                                  ;   BYTE    type of segment
   637                                  ;   BYTE    echo state of parent on entry to batch file
   638                                  ;   WORD    segment of last batch file
   639                                  ;   WORD    segment for FOR command
   640                                  ;   BYTE    FOR flag state on entry to batch file
   641                                  ;   DWORD   offset for next line
   642                                  ;   10 WORD pointers to parameters. -1 is empty parameter
   643                                  ;   ASCIZ   file name (with . and ..)
   644                                  ;   BYTES   CR-terminated parameters
   645                                  ;   BYTE    0 flag to indicate end of parameters
   646                                  ;
   647                                  
   648                                  BATCHTYPE   equ 0
   649                                  
   650                                  STRUC BATCHSEGMENT
   651 00000000 ??                      .BatType:	RESB	1		; signature
   652 00000001 ??                      .BatEchoFlag:	RESB	1		; G state of echo
   653                                  ; MSDOS 5.0 (& 6.0) - 11/01/2023
   654 00000002 ??                      .BatchEOF:	RESB	1		; records if EOF reached on file
   655 00000003 ????                    .BatLast: 	RESW	1		; G segment of last batch file
   656 00000005 ????                    .BatForPtr:	RESW	1		; G segment for FOR command
   657 00000007 ??                      .BatForFlag:	RESB	1		; G state of FOR
   658 00000008 ????????                .BatSeek:	RESD	1		; lseek position of next char
   659 0000000C <res 14h>               .BatParm:	RESW	10		; pointers to parameters
   660 00000020 ??                      .BatFile:	RESB	1		; beginning of batch file name
   661                                  .SIZE:
   662                                  ENDSTRUC
   663                                  
   664                                  ANULL		equ	0		; terminates an argv string
   665                                  ARGMAX		equ	64		; max args on a command line
   666                                  ;ARGBLEN 	equ	2*128		; 1char each plus term NUL
   667                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM ;*
   668                                  ARGBLEN 	equ	2*64
   669                                  tplen		equ	64		; max size of one argument
   670                                  arg_cnt_error	equ	1		; number of args > MAXARG
   671                                  arg_buf_ovflow	equ	2		; overflowed argbuffer
   672                                  
   673                                  STRUC ARGV_ELE				; elements in the argv array
   674 00000000 ????                    .argpointer:	RESW	1		; pointer to the argstring
   675 00000002 ??                      .argflags:	RESB	1		; cparse flags for this argstring
   676 00000003 ????                    .argstartel:	RESW	1		; the result of cparse's [STARTEL]
   677 00000005 ????                    .arglen:	RESW	1		; cparse's char count + one (for null)
   678 00000007 ????                    .argsw_word:	RESW	1		; any switches after this? what kinds?
   679 00000009 ????                    .arg_ocomptr:	RESW	1		; pointer into original command string
   680                                  .SIZE:	; 11 ; 27/07/2024
   681                                  ENDSTRUC
   682                                  
   683                                  STRUC ARG_UNIT
   684 00000000 <res 2C0h>              .argv:		RESB	ARGMAX * ARGV_ELE.SIZE ; 704 ; 27/07/2024
   685 000002C0 ????                    .argvcnt:	RESW	1		; number of arguments
   686 000002C2 ????                    .argswinfo:	RESW	1		; Switch information for entire line
   687 000002C4 <res 100h>              .argbuf:	RESW	ARGBLEN		; storage for argv strings
   688 000003C4 <res 80h>               .argforcombuf:	RESB	COMBUFLEN	; Original for loop command string
   689                                  .SIZE:	; 1092 ; 27/07/2024 ; (it was 1348 in MSDOS 5.0-6.22 COMMAND.COM) ;*
   690                                  ENDSTRUC
   691                                  
   692                                  ; Equates for initialization
   693                                  ;
   694                                  INITINIT	equ	01h		; initialization in progress
   695                                  INITSPECIAL	equ	02h		; in initialization time/date routine
   696                                  INITCTRLC	equ	04h		; already in ^C handler
   697                                  
   698                                  ;============================================================================
   699                                  ;  INTNAT.INC, MSDOS 6.0, 1991
   700                                  ;============================================================================
   701                                  ; 16/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM 
   702                                  
   703                                  ; Current structure of the data returned by the international call
   704                                  
   705                                  struc INTERNAT_BLOCK
   706 00000000 ????                    .date_tim_format: resw 1		; 0-USA, 1-EUR, 2-JAP
   707 00000002 ??????????              .currency_sym:	resb 5			; Currency Symbol 5 bytes
   708 00000007 ????                    .thous_sep:	resb 2			; Thousands separator 2 bytes
   709 00000009 ????                    .decimal_sep:	resb 2			; Decimal separator 2 bytes
   710 0000000B ????                    .date_sep:	resb 2			; Date separator 2 bytes
   711 0000000D ????                    .time_sep:	resb 2			; Decimal separator 2 bytes
   712 0000000F ??                      .bit_field:	resb 1			; Bit values
   713                                  					;   Bit 0 = 0 if currency symbol first
   714                                  					;	  = 1 if currency symbol last
   715                                  					;   Bit 1 = 0 if No space after currency symbol
   716                                  					;	  = 1 if space after currency symbol
   717                                  .currency_cents:
   718 00000010 ??                      		resb 1			; Number of places after currency dec point
   719 00000011 ??                      .time_24:	resb 1			; 1 if 24 hour time, 0 if 12 hour time
   720 00000012 ????????                .map_call:	resw 2			; Address of case mapping call (DWORD)
   721                                  					; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
   722                                  					;  in pieces.
   723 00000016 ??                      .data_sep:	resb 1			; Data list separator character
   724 00000017 ??                      		resb 1
   725                                  endstruc
   726                                  
   727                                  ; Max size of the block returned by the INTERNATIONAL call
   728                                  
   729                                  internat_block_max equ 32
   730                                  
   731                                  ;============================================================================
   732                                  ; FIND.INC (MSDOS 3.3, 1987) - REDIRSYM.INC (MSDOS 6.0, 1991) 
   733                                  ;============================================================================
   734                                  ; 13/10/2018 - Retro DOS v3.0
   735                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM 
   736                                  
   737                                  ;Break	<find first/next buffer>
   738                                  
   739                                  	; MSDOS 3.3 & MSDOS 6.0
   740                                  
   741                                  struc FIND_BUF
   742 00000000 ??                      .DRIVE:	    resb 1	; drive of search
   743 00000001 <res Bh>                .NAME:	    resb 11	; formatted name
   744 0000000C ??                      .SATTR:	    resb 1	; attribute of search
   745 0000000D ????                    .LASTENT:   resw 1	; LastEnt
   746 0000000F ????                    .DIRSTART:  resw 1	; DirStart
   747 00000011 ????????                .NETID:	    resb 4	; Reserved for NET
   748 00000015 ??                      .ATTR:	    resb 1	; attribute found
   749 00000016 ????                    .TIMR:	    resw 1	; time
   750 00000018 ????                    .DATE:	    resw 1	; date
   751 0000001A ????                    .SIZE_L:    resw 1	; low(size)
   752 0000001C ????                    .SIZE_H:    resw 1	; high(size)
   753 0000001E <res Dh>                .PNAME:	    resb 13	; packed name
   754                                  .size:
   755                                  endstruc
   756                                  
   757                                  ;=============================================================================
   758                                  ; PDB.INC, MSDOS 6.0, 1991
   759                                  ;=============================================================================
   760                                  ; 24/09/2018 - Retro DOS v3.0 (08/07/2018, 'msdos3.s')
   761                                  
   762                                  ;**	Process data block (otherwise known as program header)
   763                                  
   764                                  ;	These offset are documented in the MSDOS Encyclopedia, so nothing
   765                                  ;	can be rearranged here, ever. Reserved areas are probably safe
   766                                  ;	for use.
   767                                  
   768                                  FILPERPROC	EQU     20
   769                                  
   770                                  struc PDB	; Process_data_block
   771 00000000 ????                    .EXIT_CALL:	resw 1   	; INT int_abort system terminate
   772 00000002 ????                    .BLOCK_LEN:	resw 1		; size of execution block
   773 00000004 ??                                      resb 1
   774 00000005 ??????????              .CPM_CALL:	resb 5		; ancient call to system
   775 0000000A ????????                .EXIT:		resd 1		; pointer to exit routine
   776 0000000E ????????                .CTRL_C:	resd 1		; pointer to ^C routine
   777 00000012 ????????                .FATAL_ABORT:	resd 1		; pointer to fatal error
   778 00000016 ????                    .PARENT_PID:	resw 1		; PID of parent (terminate PID)
   779 00000018 <res 14h>               .JFN_TABLE:     resb FILPERPROC ; indices into system table
   780 0000002C ????                    .ENVIRON:	resw 1		; seg addr of environment
   781 0000002E ????????                .USER_STACK:	resd 1		; stack of self during system calls
   782 00000032 ????                    .JFN_Length:	resw 1		; number of handles allowed
   783 00000034 ????????                .JFN_Pointer:	resd 1		; pointer to JFN table
   784 00000038 ????????                .Next_PDB:	resd 1		; pointer to nested PDB's
   785 0000003C ??                      .InterCon:	resb 1	; MSDOS 6.0 ; *** jh-3/28/90 *** 
   786 0000003D ??                      .Append:	resb 1	; MSDOS 6.0 ; *** Not sure if still used ***
   787 0000003E ????                    .Novell_Used:	resb 2	; MSDOS 6.0 ; Novell shell (redir) uses these
   788 00000040 ????                    .Version:	resw 1	; MSDOS 6.0 ; DOS version reported to this app
   789 00000042 <res Eh>                .PAD1:		resb 14 ; 0Eh
   790 00000050 ??????????              .CALL_SYSTEM:	resb 5		; portable method of system call
   791 00000055 ??????????????          .PAD2:		resb 7		; reserved so FCB 1 can be used as
   792                                  				;  an extended FCB
   793                                  ;endstruc 	; MSDOS 3.3
   794                                  	  	; MSDOS 6.0
   795 0000005C <res 10h>               .FCB1:		resb 16 ; 10h	; default FCB 1
   796 0000006C <res 10h>               .FCB2:		resb 16 ; 10h	; default FCB 2
   797 0000007C ????????                .PAD3:		resb 4		; not sure if this is used by PDB_FCB2
   798 00000080 <res 80h>               .TAIL:		resb 128	; command tail and default DTA
   799                                  endstruc
   800                                  
   801                                  ;=============================================================================
   802                                  ; VERSIONA.INC, MSDOS 6.0, 1991
   803                                  ;=============================================================================
   804                                  ; 24/09/2018 - Retro DOS v3.0
   805                                  
   806                                  ;major_version	equ 6		; Major DOS version
   807                                  ;minor_version	equ 0		; Minor DOS Version
   808                                  
   809                                  ;expected_version    equ     (MINOR_VERSION SHL 8)+MAJOR_VERSION
   810                                  
   811                                  ; MSDOS 3.3 COMMAND.COM
   812                                  ;MAJOR_VERSION	EQU 3
   813                                  ;MINOR_VERSION	EQU 30
   814                                  
   815                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1)
   816                                  ;MAJOR_VERSION	EQU 5
   817                                  ;MINOR_VERSION	EQU 0
   818                                  
   819                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
   820                                  ;MAJOR_VERSION	EQU 6		; Major DOS version
   821                                  ;MINOR_VERSION	EQU 22		; Minor DOS version
   822                                  
   823                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
   824                                  MAJOR_VERSION	EQU 7		; Major DOS version
   825                                  MINOR_VERSION	EQU 10		; Minor DOS version
   826                                  
   827                                  EXPECTED_VERSION EQU (MINOR_VERSION<<8)+MAJOR_VERSION	
   828                                  
   829                                  ;-----------------------------------------------------------------------------
   830                                  ; 21/09/2018
   831                                  ;-----------------------------------------------------------------------------
   832                                  ; Retro DOS v3.0 NOTE:  
   833                                  ;	Following source code is as disassembled code of MSDOS 3.3 COMMAND.COM
   834                                  ;	with minor modifications which are done by me (Erdogan Tan).
   835                                  ;	.. but comments and descriptions are from MSDOS 6.0 COMMAND.COM
   836                                  ;	source code files (written by using MASM syntax).
   837                                  ;-----------------------------------------------------------------------------
   838                                  ; All of this Retro DOS 3.0 (2018) source code has been written by using
   839                                  ; NASM (2.11) x86 assembly language/compiler syntax.	
   840                                  ;----------------------------------------------------------------------------- 	
   841                                  
   842                                  ;=============================================================================
   843                                  ; COMMAND1.ASM, MSDOS 6.0, 1991
   844                                  ;=============================================================================
   845                                  ; 21/09/2018 - Retro DOS v3.0
   846                                  
   847                                  ;	page ,132
   848                                  ;	title	COMMAND - resident code for COMMAND.COM
   849                                  ;	name	COMMAND
   850                                  
   851                                  ;/*
   852                                  ; *                      Microsoft Confidential
   853                                  ; *                      Copyright (C) Microsoft Corporation 1991
   854                                  ; *                      All Rights Reserved.
   855                                  ; */
   856                                  
   857                                  ;*****************************************************************************
   858                                  ;
   859                                  ; MODULE:	       COMMAND.COM
   860                                  ;
   861                                  ; DESCRIPTIVE NAME:    Default DOS command interpreter
   862                                  ;
   863                                  ; FUNCTION:	       This version of COMMAND is divided into three distinct
   864                                  ;		       parts.  First is the resident portion, which includes
   865                                  ;		       handlers for interrupts	23H (Cntrl-C), 24H (fatal
   866                                  ;		       error), and 2EH (command line execute); it also has
   867                                  ;		       code to test and, if necessary, reload the transient
   868                                  ;		       portion. Following the resident is the init code, which
   869                                  ;		       is overwritten after use.  Then comes the transient
   870                                  ;		       portion, which includes all command processing (whether
   871                                  ;		       internal or external).  The transient portion loads at
   872                                  ;		       the end of physical memory, and it may be overlayed by
   873                                  ;		       programs that need as much memory as possible. When the
   874                                  ;		       resident portion of command regains control from a user
   875                                  ;		       program, a check sum is performed on the transient
   876                                  ;		       portion to see if it must be reloaded.  Thus programs
   877                                  ;		       which do not need maximum memory will save the time
   878                                  ;		       required to reload COMMAND when they terminate.
   879                                  ;
   880                                  ; ENTRY POINT:	       PROGSTART
   881                                  ;
   882                                  ; INPUT:	       command line at offset 81H
   883                                  ;
   884                                  ; EXIT_NORMAL:	       No exit from root level command processor.  Can exit
   885                                  ;		       from a secondary command processor via the EXIT
   886                                  ;		       internal command.
   887                                  ;
   888                                  ; EXIT_ERROR:	       Exit to prior command processor if possible, otherwise
   889                                  ;		       hang the system.
   890                                  ;
   891                                  ; INTERNAL REFERENCES:
   892                                  ;
   893                                  ;     ROUTINES:        See the COMMAND Subroutine Description Document
   894                                  ;		       (COMMAND.DOC)
   895                                  ;
   896                                  ;     DATA AREAS:      See the COMMAND Subroutine Description Document
   897                                  ;		       (COMMAND.DOC)
   898                                  ;
   899                                  ; EXTERNAL REFERENCES:
   900                                  ;
   901                                  ;      ROUTINES:       none
   902                                  ;
   903                                  ;      DATA AREAS:     none
   904                                  ;
   905                                  ;*****************************************************************************
   906                                  ;
   907                                  ;			      REVISION HISTORY
   908                                  ;			      ----------------
   909                                  ;
   910                                  ; DOS 1.00 to DOS 3.30
   911                                  ; --------------------------
   912                                  ; SEE REVISION LOG IN COPY.ASM ALSO
   913                                  ;
   914                                  ; REV 1.17
   915                                  ;    05/19/82  Fixed bug in BADEXE error (relocation error must return to
   916                                  ;	       resident since the EXELOAD may have overwritten the transient.
   917                                  ;
   918                                  ; REV 1.18
   919                                  ;    05/21/82  IBM version always looks on drive A
   920                                  ;	       MSVER always looks on default drive
   921                                  ;
   922                                  ; REV 1.19
   923                                  ;    06/03/82  Drive spec now entered in command line
   924                                  ;    06/07/82  Added VER command (print DOS version number) and VOL command
   925                                  ;	       (print volume label)
   926                                  ;
   927                                  ; REV 1.20
   928                                  ;    06/09/82  Prints "directory" after directories
   929                                  ;    06/13/82  MKDIR, CHDIR, PWD, RMDIR added
   930                                  ;
   931                                  ; REV 1.50
   932                                  ;	       Some code for new 2.0 DOS, sort of HACKey.  Not enough time to
   933                                  ;	       do it right.
   934                                  ;
   935                                  ; REV 1.70
   936                                  ;	       EXEC used to fork off new processes
   937                                  ;
   938                                  ; REV 1.80
   939                                  ;	       C switch for single command execution
   940                                  ;
   941                                  ; REV 1.90
   942                                  ;	       Batch uses XENIX
   943                                  ;
   944                                  ; Rev 2.00
   945                                  ;	       Lots of neato stuff
   946                                  ;	       IBM 2.00 level
   947                                  ;
   948                                  ; Rev 2.01
   949                                  ;	       'D' switch for date time suppression
   950                                  ;
   951                                  ; Rev 2.02
   952                                  ;	       Default userpath is NUL rather than BIN
   953                                  ;		       same as IBM
   954                                  ;	       COMMAND split into pieces
   955                                  ;
   956                                  ; Rev 2.10
   957                                  ;	       INTERNATIONAL SUPPORT
   958                                  ;
   959                                  ; Rev 2.50
   960                                  ;	       all the 2.x new stuff -MU
   961                                  ;
   962                                  ; Rev 3.30     (Ellen G)
   963                                  ;	       CALL internal command (TBATCH2.ASM)
   964                                  ;	       CHCP internal command (TCMD2B.ASM)
   965                                  ;	       INT 24H support of abort, retry, ignore, and fail prompt
   966                                  ;	       @ sign suppression of batch file line
   967                                  ;	       Replaceable environment value support in batch files
   968                                  ;	       INT 2FH calls for APPEND
   969                                  ;	       Lots of PTR fixes!
   970                                  ;
   971                                  ; Beyond 3.30 to forever  (Ellen G)
   972                                  ; ----------------------
   973                                  ;
   974                                  ; A000 DOS 4.00  -	Use SYSPARSE for internal commands
   975                                  ;			Use Message Retriever services
   976                                  ;			/MSG switch for resident extended error msg
   977                                  ;			Convert to new capitalization support
   978                                  ;			Better error recovery on CHCP command
   979                                  ;			Code page file tag support
   980                                  ;			TRUENAME internal command
   981                                  ;			Extended screen line support
   982                                  ;			/P switch on DEL/ERASE command
   983                                  ;			Improved file redirection error recovery
   984                                  ;	(removed)	Improved batch file performance
   985                                  ;			Unconditional DBCS support
   986                                  ;			Volume serial number support
   987                                  ;	(removed)	COMMENT=?? support
   988                                  ;
   989                                  ; A001	PTM P20 	Move system_cpage from TDATA to TSPC
   990                                  ;
   991                                  ; A002	PTM P74 	Fix PRESCAN so that redirection symbols do not
   992                                  ;			require delimiters.
   993                                  ;
   994                                  ; A003	PTM P5,P9,P111	Included in A000 development
   995                                  ;
   996                                  ; A004	PTM P86 	Fix IF command to turn off piping before
   997                                  ;			executing
   998                                  ;
   999                                  ; A005	DCR D17 	If user specifies an extension on the command
  1000                                  ;			line search for that extension only.
  1001                                  ;
  1002                                  ; A006	DCR D15 	New message for MkDir - "Directory already
  1003                                  ;			exists"
  1004                                  ;
  1005                                  ; A007	DCR D2		Change CTTY so that a write is done before XDUP
  1006                                  ;
  1007                                  ; A008	PTM P182	Change COPY to set default if invalid function
  1008                                  ;			returned from code page call.
  1009                                  ;
  1010                                  ; A009	PTM P179	Add CRLF to invalid disk change message
  1011                                  ;
  1012                                  ; A010	DCR D43 	Allow APPEND to do a far call to SYSPARSE in
  1013                                  ;			transient COMMAND.
  1014                                  ;
  1015                                  ; A011	DCR D130	Change redirection to overwrite an EOF mark
  1016                                  ;			before appending to a file.
  1017                                  ;
  1018                                  ; A012	PTM P189	Fix redirection error recovery.
  1019                                  ;
  1020                                  ; A013	PTM P330	Change date format
  1021                                  ;
  1022                                  ; A014	PTM P455	Fix echo parsing
  1023                                  ;
  1024                                  ; A015	PTM P517	Fix DIR problem with * vs *.
  1025                                  ;
  1026                                  ; A016	PTM P354	Fix extended error message addressing
  1027                                  ;
  1028                                  ; A017	PTM P448	Fix appending to 0 length files
  1029                                  ;
  1030                                  ; A018	PTM P566,P3903	Fix parse error messages to print out parameter
  1031                                  ;			the parser fails on. Fail on duplicate switches.
  1032                                  ;
  1033                                  ; A019	PTM P542	Fix device name to be printed correctly during
  1034                                  ;			critical error
  1035                                  ;
  1036                                  ; A020	DCR D43 	Set append state off while in DIR
  1037                                  ;
  1038                                  ; A021	PTM P709	Fix CTTY printing ascii characters.
  1039                                  ;
  1040                                  ; A022	DCR D209	Enhanced error recovery
  1041                                  ;
  1042                                  ; A023	PTM P911	Fix ANSI.SYS IOCTL structure.
  1043                                  ;
  1044                                  ; A024	PTM P899	Fix EXTOPEN open modes.
  1045                                  ;
  1046                                  ; A025	PTM P922	Fix messages and optimize PARSE switches
  1047                                  ;
  1048                                  ; A026	DCR D191	Change redirection error recovery support.
  1049                                  ;
  1050                                  ; A027	PTM P991	Fix so that KAUTOBAT & AUTOEXEC are terminated
  1051                                  ;			with a carriage return.
  1052                                  ;
  1053                                  ; A028	PTM P1076	Print a blank line before printing invalid
  1054                                  ;			date and invalid time messages.
  1055                                  ;
  1056                                  ; A029	PTM P1084	Eliminate calls to parse_check_eol in DATE
  1057                                  ;			and TIME.
  1058                                  ;
  1059                                  ; A030	DCR D201	New extended attribute format.
  1060                                  ;
  1061                                  ; A031	PTM P1149	Fix DATE/TIME add blank before prompt.
  1062                                  ;
  1063                                  ; A032	PTM P931	Fix =ON, =OFF for BREAK, VERIFY, ECHO
  1064                                  ;
  1065                                  ; A033	PTM P1298	Fix problem with system crashes on ECHO >""
  1066                                  ;
  1067                                  ; A034	PTM P1387	Fix COPY D:fname+,, to work
  1068                                  ;
  1069                                  ; A035	PTM P1407	Fix so that >> (appending) to a device does
  1070                                  ;			do a read to determine eof.
  1071                                  ;
  1072                                  ; A036	PTM P1406	Use 69h instead of 44h to get volume serial
  1073                                  ;			so that ASSIGN works correctly.
  1074                                  ;
  1075                                  ; A037	PTM P1335	Fix COMMAND /C with FOR
  1076                                  ;
  1077                                  ; A038	PTM P1635	Fix COPY so that it doesn't accept /V /V
  1078                                  ;
  1079                                  ; A039	DCR D284	Change invalid code page tag from -1 to 0.
  1080                                  ;
  1081                                  ; A040	PTM P1787	Fix redirection to cause error when no file is
  1082                                  ;			specified.
  1083                                  ;
  1084                                  ; A041	PTM P1705	Close redirected files after internal APPEND
  1085                                  ;			executes.
  1086                                  ;
  1087                                  ; A042	PTM P1276	Fix problem of APPEND paths changes in batch
  1088                                  ;			files causing loss of batch file.
  1089                                  ;
  1090                                  ; A043	PTM P2208	Make sure redirection is not set up twice for
  1091                                  ;			CALL'ed batch files.
  1092                                  ;
  1093                                  ; A044	PTM P2315	Set switch on PARSE so that 0ah is not used
  1094                                  ;			as an end of line character
  1095                                  ;
  1096                                  ; A045	PTM P2560	Make sure we don't lose parse, critical error,
  1097                                  ;			and extended message pointers when we EXIT if
  1098                                  ;			COMMAND /P is the top level process.
  1099                                  ;
  1100                                  ; A046	PTM P2690	Change COPY message "fn File not found" to
  1101                                  ;			"File not found - fn"
  1102                                  ;
  1103                                  ; A047	PTM P2819	Fix transient reload prompt message
  1104                                  ;
  1105                                  ; A048	PTM P2824	Fix COPY path to be upper cased.  This was broken
  1106                                  ;			when DBCS code was added.
  1107                                  ;
  1108                                  ; A049	PTM P2891	Fix PATH so that it doesn't accept extra characters
  1109                                  ;			on line.
  1110                                  ;
  1111                                  ; A050	PTM P3030	Fix TYPE to work properly on files > 64K
  1112                                  ;
  1113                                  ; A051	PTM P3011	Fix DIR header to be compatible with prior releases.
  1114                                  ;
  1115                                  ; A052	PTM P3063,P3228 Fix COPY message for invalid filename on target.
  1116                                  ;
  1117                                  ; A053	PTM P2865	Fix DIR to work in 40 column mode.
  1118                                  ;
  1119                                  ; A054	PTM P3407	Code reduction and critical error on single line
  1120                                  ;	PTM P3672	(Change to single parser exported under P3407)
  1121                                  ;
  1122                                  ; A055	PTM P3282	Reset message service variables in INT 23h to fix
  1123                                  ;			problems with breaking out of INT 24h
  1124                                  ;
  1125                                  ; A056	PTM P3389	Fix problem of environment overlaying transient.
  1126                                  ;
  1127                                  ; A057	PTM P3384	Fix COMMAND /C so that it works if there is no space
  1128                                  ;			before the "string".  EX: COMMAND /CDIR
  1129                                  ;
  1130                                  ; A058	PTM P3493	Fix DBCS so that CPARSE eats second character of
  1131                                  ;			DBCS switch.
  1132                                  ;
  1133                                  ; A059	PTM P3394	Change the TIME command to right align the display of
  1134                                  ;			the time.
  1135                                  ;
  1136                                  ; A060	PTM P3672	Code reduction - change PARSE and EXTENDED ERROR
  1137                                  ;			messages to be disk based.  Only keep them if /MSG
  1138                                  ;			is used.
  1139                                  ;
  1140                                  ; A061	PTM P3928	Fix so that transient doesn't reload when breaking
  1141                                  ;			out of internal commands, due to substitution blocks
  1142                                  ;			not being reset.
  1143                                  ;
  1144                                  ; A062	PTM P4079	Fix segment override for fetching address of environment
  1145                                  ;			of parent copy of COMMAND when no COMSPEC exists in
  1146                                  ;			secondary copy of environment.	Change default slash in
  1147                                  ;			default comspec string to backslash.
  1148                                  ;
  1149                                  ; A063	PTM P4140	REDIRECTOR and IFSFUNC changed interface for getting
  1150                                  ;			text for critical error messages.
  1151                                  ;
  1152                                  ; A064	PTM P4934	Multiplex number for ANSI.SYS changed due to conflict
  1153                                  ;	5/20/88 	with Microsoft product already shipped.
  1154                                  ;
  1155                                  ; A065	PTM P4935	Multiplex number for SHELL changed due to conflict
  1156                                  ;	 5/20/88	with Microsoft product already shipped.
  1157                                  ;
  1158                                  ; A066	PTM P4961	DIR /W /P scrolled first line off the screen in some
  1159                                  ;	 5/24/88	cases; where the listing would barely fit without the
  1160                                  ;			header and space remaining.
  1161                                  ;
  1162                                  ; A067	PTM P5011	For /E: values of 993 to 1024 the COMSPEC was getting
  1163                                  ;	 6/6/88 	trashed.  Turns out that the SETBLOCK for the new
  1164                                  ;			environment was putting a "Z block" marker in the old
  1165                                  ;			environment.  The fix is to move to the old environment
  1166                                  ;			to the new environment before doing the SETBLOCK.
  1167                                  ;
  1168                                  ; A068  PTM P5568       IR79754 APPEND /x:on not working properly with DIR/VOL
  1169                                  ;        09/19/88       because the check for APPEND needed to be performed
  1170                                  ;                       before the DIR's findfirst.
  1171                                  ;
  1172                                  ; A069  PTM P5726       IR80540 COMSPEC_flag not properly initialized and
  1173                                  ;        10/30/88       executed.  Causing AUSTIN problem testing LAN/DW4 re-
  1174                                  ;                       loading trans w/new comspec with no user change comspec.
  1175                                  ;
  1176                                  ; A070  PTM P5734       IR80484 Batch file causes sys workspace to be corrupted.
  1177                                  ;        11/05/88       Expansion of environment variables into batch line of
  1178                                  ;                       128 chars was not being counted and "%" which should be
  1179                                  ;                       ignored were being counted.
  1180                                  ;
  1181                                  ; A071  PTM P5854       IR82061 Invalid COMMAND.COM when Word Perfect, Prompt
  1182                                  ;        03/02/89       used.  Comspec_flag was not in protected data file be-
  1183                                  ;                       ing included in checksum and was being overwritten by
  1184                                  ;                       WP.  Moved var from Tspc to Tdata so Trans would reload.
  1185                                  ;                       Also removed fix A069 (because flag now protected).
  1186                                  ;
  1187                                  ; C001  VERSION 4.1     Add new internal command - SERVICE - to display the DOS
  1188                                  ;        07/25/89       version and CSD version in U.S. date format.  Files
  1189                                  ;                       changed - TRANMSG,.SKL,COMMAND1,TDATA,TCMD2A,USA.MSG
  1190                                  ;
  1191                                  ;***********************************************************************************
  1192                                  
  1193                                  ;
  1194                                  ;	Revision History
  1195                                  ;	================
  1196                                  ;
  1197                                  ;	M021	SR	08/23/90	Fixed Ctrl-C handler to handle Ctrl-C
  1198                                  ;					at init time (date/time prompt)
  1199                                  ;
  1200                                  
  1201                                  ;
  1202                                  ;.xcref
  1203                                  ;.xlist
  1204                                  ;	include dossym.inc		; basic DOS symbol set
  1205                                  ;	include syscall.inc		; DOS function names
  1206                                  ;	include comsw.asm		; build version info
  1207                                  ;	include comequ.asm		; common command.com symbols
  1208                                  ;	include resmsg.equ		; resident message names
  1209                                  ;
  1210                                  ;	include comseg.asm		;segment ordering
  1211                                  ;.list
  1212                                  ;.cref
  1213                                  
  1214                                  ;CODERES segment public byte
  1215                                  ;CODERES ends
  1216                                  ;
  1217                                  ;DATARES 	segment public byte
  1218                                  ;		extrn	AccDen:byte
  1219                                  ;		extrn	Batch:word
  1220                                  ;		extrn	EchoFlag:byte
  1221                                  ;		extrn	ExeBad:byte
  1222                                  ;		extrn	ExecEMes:byte
  1223                                  ;		extrn	ExecErrSubst:byte
  1224                                  ;		extrn	ExtCom:byte
  1225                                  ;		extrn	ForFlag:byte
  1226                                  ;		extrn	IfFlag:byte
  1227                                  ;		extrn	InitFlag:BYTE
  1228                                  ;		extrn	Nest:word
  1229                                  ;		extrn	PipeFlag:byte
  1230                                  ;		extrn	RBadNam:byte
  1231                                  ;		extrn	RetCode:word
  1232                                  ;		extrn	SingleCom:word
  1233                                  ;		extrn	TooBig:byte
  1234                                  ;
  1235                                  ;		extrn	OldDS:word
  1236                                  ;
  1237                                  ;DATARES 	ends
  1238                                  ;
  1239                                  ;
  1240                                  ;INIT		segment public para
  1241                                  ;		extrn	ConProc:near
  1242                                  ;		extrn	Init_Contc_SpecialCase:near
  1243                                  ;INIT		ends
  1244                                  
  1245                                  ; 09/01/2023 - Erdogan Tan - Istanbul
  1246                                  ; --------------------------------------
  1247                                  ; 'command5.s' source code reference(s):
  1248                                  
  1249                                  ;	1) MSDOS 6.0 COMMAND.COM source files
  1250                                  ;	2) Disassembled MSDOS 5.0 COMMAND.COM - 11/11/1991 - 47845 bytes  
  1251                                  ;	   (Disassembler: HEX-RAYS IDA Pro Freeware Version 5.0)
  1252                                  ; ----------------------------------------------------------------------				 	 	
  1253                                  
  1254                                  ; -----------------------------------------------------------------------------
  1255                                  ; START OF RESIDENT PORTION
  1256                                  ; -----------------------------------------------------------------------------
  1257                                  ; SEGMENT - DATARES
  1258                                  ; -----------------------------------------------------------------------------
  1259                                  
  1260                                  section .RESGROUP ; vstart=100h  ; 09/01/2023 - Retro DOS v4.0 (& v4.1) 
  1261                                  
  1262                                  ; 09/01/2023 - Retro DOS v4.0 (Modified COMMAND.COM v5.0)
  1263                                  
  1264                                  ;==============================================================================
  1265                                  ; STUB.ASM - MSDOS 6.0 - 1991
  1266                                  ;==============================================================================
  1267                                  
  1268                                  ;This file contains the low memory stub for command.com which hooks all the
  1269                                  ;entry points into the resident command.com and directs the calls to the
  1270                                  ;appropriate routines in the resident code which may be located in HIMEM. 
  1271                                  ;
  1272                                  ;The stub has been made part of the resident data and will always
  1273                                  ;be duplicated on every invocation of command.com. However, the only stubs
  1274                                  ;that actually hook the interrupt vectors belong to either the first 
  1275                                  ;command.com or to any other command.com executed with the /p switch. 
  1276                                  ;
  1277                                  ;The stub also keeps track of the current active data segment. The 
  1278                                  ;INIT code of each command.com updates this variable via an int 2fh mechanism
  1279                                  ;with its own data segment. The INIT code also updates a pointer in its data
  1280                                  ;segment to the previous resident data segment. Whenever a command.com exits,
  1281                                  ;the exit code picks up the previous data segment pointer from the current
  1282                                  ;data segment and patches it into the CurResDataSeg variable in the stub.
  1283                                  ;
  1284                                  ;Right now the stub does not bother about A20 switching. We assume
  1285                                  ;A20 is always on. It just does a far jump to the resident code with the 
  1286                                  ;value of the current data segment in one of the registers. A20 toggle 
  1287                                  ;support maybe added as a future enhancement, if the need is felt.
  1288                                  
  1289                                  	; 09/01/2023 - Retro DOS v4.0 (& v4.1)
  1290                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  1291                                  
  1292                                  	; 18/07/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
  1293                                  
  1294                                  	[ORG 100H]
  1295                                  
  1296                                  	; 21/09/2018 - Retro DOS v3.0
  1297                                  StartCode:
  1298 00000000 E98D15                  	jmp	ConProc	; 10/01/2023 
  1299                                  
  1300                                  	; 09/01/2023
  1301                                  
  1302                                  ; Make following table word-aligned, and at the same time, provide a
  1303                                  ; signature that sysinit can use to (attempt to) validate the interpreter
  1304                                  
  1305                                  	;db	0	; MSDOS 5.0 COMMAND.COM - DATARES:0103h
  1306                                  	;db	7Ah	; PCDOS 7.10 (7.1) COMMAND.COM ; 18/07/2024
  1307 00000003 7A                      	db      ((MAJOR_VERSION&0Fh)<<4)|(MINOR_VERSION&0Fh)
  1308                                  
  1309                                  word_104:
  1310 00000004 0000                    	dw	0	; PCDOS 7.1 COMMAND.COM - DATARES:0104h
  1311                                  ;RESGROUP:0106h
  1312 00000006 000000000000000000-     	db	0Ch dup(0), 0Dh
  1312 0000000F 0000000D           
  1313                                  ;RESGROUP:0113h
  1314                                  a@Ibm12_01_2003:
  1315 00000013 402349424D3A31322E-     	db '@#IBM:12.01.2003.build_1.32#@ COMMAND.COM(USA)',0
  1315 0000001C 30312E323030332E62-
  1315 00000025 75696C645F312E3332-
  1315 0000002E 234020434F4D4D414E-
  1315 00000037 442E434F4D28555341-
  1315 00000040 2900               
  1316                                  ;RESGROUP:0142h:
  1317 00000042 000000000000000000-     	db 22h dup(0), 1Ah, 0
  1317 0000004B 000000000000000000-
  1317 00000054 000000000000000000-
  1317 0000005D 000000000000001A00 
  1318                                  
  1319                                  ;All the entry points declared below are patched in at INIT time with the
  1320                                  ;proper segment and offset values after the resident code segment has been
  1321                                  ;moved to its final location
  1322                                  
  1323                                  ;!!!WARNING!!!
  1324                                  ; All the dword ptrs from Int2f_Entry till MsgRetrv_Entry should be contiguous
  1325                                  ;because the init routine 'Patch_stub' (in init.asm) relies on this to patch
  1326                                  ;in the correct segments and offsets
  1327                                  
  1328                                  Int2f_Entry:
  1329 00000066 [A014]                  	dw	MsgInt2fHandler		; Address of int 2fh handler
  1330 00000068 0000                    	dw	0
  1331                                  Int2e_Entry:
  1332 0000006A [860E]                  	dw	Int_2e			; Address of int 2eh handler
  1333 0000006C 0000                    	dw	0
  1334                                  Ctrlc_Entry:
  1335 0000006E [430D]                  	dw	ContC			; Address of Ctrl-C handler
  1336 00000070 0000                    	dw	0
  1337                                  CritErr_Entry:
  1338 00000072 [8B11]                  	dw	DSKERR			; Address of critical error handler
  1339 00000074 0000                    	dw	0
  1340                                  
  1341                                  Exec_Entry:
  1342 00000076 00000000                	dd	0			; Entry from transient to Ext_Exec
  1343                                  RemCheck_Entry:
  1344 0000007A 00000000                	dd	0			; Entry from transient to TRemCheck
  1345                                  TrnLodCom1_Entry:
  1346 0000007E 00000000                	dd	0			; Entry from transient to LodCom1
  1347                                  LodCom_Entry:
  1348 00000082 00000000                	dd	0			; Entry after exit from command.com
  1349                                  MsgRetrv_Entry:
  1350 00000086 00000000                	dd	0			; Entry from external to MsgRetriever
  1351                                  HeadFix_Entry:
  1352 0000008A 00000000                	dd	0			; Entry from trans to HeadFix
  1353                                  UMBOff_Entry:
  1354 0000008E 00000000                	dd	0			; Entry from here to UMBOff routine; M003
  1355                                  XMMCallAddr:
  1356 00000092 00000000                	dd	0			; Call address for XMM functions
  1357                                  ComInHMA:
  1358 00000096 00                      	db	0			; Flags if command.com in HMA
  1359                                  
  1360                                  ; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:0197h)
  1361                                  
  1362                                  Int2f_Trap:
  1363                                  	;sti	; 19/04/2023 (MSDOS 5.0 COMMAND.COM - RESGROUP:0135h)
  1364 00000097 E86400                  	call	CheckA20
  1365 0000009A 1E                      	push	ds			; push current ds value
  1366 0000009B 0E                      	push	cs			; push resident data segment value
  1367                                  	;jmp	cs:Int2f_Entry
  1368 0000009C 2EFF2E[6600]            	jmp	far [cs:Int2f_Entry]
  1369                                  
  1370                                  Int2e_Trap:
  1371 000000A1 FB                      	sti
  1372 000000A2 E85900                  	call	CheckA20
  1373 000000A5 1E                      	push	ds			; push current ds value
  1374 000000A6 0E                      	push	cs			; push resident data segment value
  1375                                  	;jmp	cs:Int2e_Entry
  1376 000000A7 2EFF2E[6A00]            	jmp	far [cs:Int2e_Entry]
  1377                                  
  1378                                  Ctrlc_Trap:
  1379 000000AC FB                      	sti
  1380 000000AD E84E00                  	call	CheckA20
  1381 000000B0 1E                      	push	ds			; push current ds value
  1382 000000B1 0E                      	push	cs			; push resident data segment value
  1383                                  	;jmp	cs:Ctrlc_Entry
  1384 000000B2 2EFF2E[6E00]            	jmp	far [cs:Ctrlc_Entry]
  1385                                  
  1386                                  CritErr_Trap:
  1387 000000B7 FB                      	sti
  1388 000000B8 E84300                  	call	CheckA20
  1389 000000BB 1E                      	push	ds			; push current ds value
  1390 000000BC 0E                      	push	cs			; push resident data segment value
  1391                                  	;jmp	cs:CritErr_Entry
  1392 000000BD 2EFF2E[7200]            	jmp	far [cs:CritErr_Entry]
  1393                                  
  1394                                  Exec_Trap:
  1395 000000C2 E83900                  	call	CheckA20
  1396 000000C5 1E                      	push	ds			; push current ds value
  1397 000000C6 0E                      	push	cs			; push resident data segment value
  1398                                  	;jmp	cs:Exec_Entry
  1399 000000C7 2EFF2E[7600]            	jmp	far [cs:Exec_Entry]
  1400                                  
  1401                                  RemCheck_Trap:
  1402 000000CC E82F00                  	call	CheckA20
  1403 000000CF 1E                      	push	ds			; push current ds value
  1404 000000D0 0E                      	push	cs			; push resident data segment value
  1405                                  	;jmp	cs:RemCheck_Entry
  1406 000000D1 2EFF2E[7A00]            	jmp	far [cs:RemCheck_Entry]
  1407                                  
  1408                                  TrnLodCom1_Trap:
  1409 000000D6 E82500                  	call	CheckA20
  1410 000000D9 1E                      	push	ds			; push current ds value
  1411 000000DA 0E                      	push	cs			; push resident data segment value
  1412                                  	;jmp	cs:TrnLodCom1_Entry
  1413 000000DB 2EFF2E[7E00]            	jmp	far [cs:TrnLodCom1_Entry]
  1414                                  
  1415                                  LodCom_Trap:
  1416 000000E0 E81B00                  	call	CheckA20
  1417 000000E3 1E                      	push	ds			; push current ds value
  1418 000000E4 0E                      	push	cs			; push resident data segment value
  1419                                  	;jmp	cs:LodCom_Entry
  1420 000000E5 2EFF2E[8200]            	jmp	far [cs:LodCom_Entry]
  1421                                  
  1422                                  MsgRetrv_Trap:
  1423 000000EA E81100                  	call	CheckA20
  1424 000000ED 1E                      	push	ds			; push current ds value
  1425 000000EE 0E                      	push	cs			; push resident data segment value
  1426                                  	;jmp	cs:MsgRetrv_Entry
  1427 000000EF 2EFF2E[8600]            	jmp	far [cs:MsgRetrv_Entry]
  1428                                  
  1429                                  HeadFix_Trap:
  1430 000000F4 E80700                  	call	CheckA20
  1431 000000F7 1E                      	push	ds			; push current ds value
  1432 000000F8 0E                      	push	cs			; push resident data segment value
  1433                                  	;jmp	cs:HeadFix_Entry
  1434 000000F9 2EFF2E[8A00]            	jmp	far [cs:HeadFix_Entry]
  1435                                  
  1436                                  ; ----------------------------------------------------------------------------
  1437                                  
  1438                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1439                                  %if 0
  1440                                  	; 09/01/2023
  1441                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:019Dh
  1442                                  
  1443                                  	; 05/06/2023
  1444                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:019Ch
  1445                                  CheckA20:
  1446                                  	pushf				; save current flags
  1447                                  	cmp	byte [cs:ComInHMA],0	; is resident in HMA?
  1448                                  	jz	short A20_on		; no, jump to resident
  1449                                  
  1450                                  	call	QueryA20
  1451                                  	jnc	short A20_on		; A20 is on, jump to resident
  1452                                  
  1453                                  	call	EnableA20		; turn A20 on
  1454                                  A20_on:
  1455                                  	popf				; flags have to be unchanged
  1456                                  	retn
  1457                                  %else
  1458                                  	; 18/07/2024
  1459                                  	XMM_QUERY_A20 equ 7 ; 09/01/2023
  1460                                  	XMM_LOCAL_ENABLE_A20 equ 5
  1461                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:01FFh
  1462                                  CheckA20:
  1463 000000FE 9C                      	pushf				; save current flags
  1464 000000FF 2E803E[9600]00          	cmp	byte [cs:ComInHMA],0	; is resident in HMA?
  1465 00000105 741A                    	jz	short A20_on		; no, jump to resident
  1466                                  	; 18/07/2024
  1467 00000107 50                      	push	ax
  1468 00000108 53                      	push	bx
  1469                                  QueryA20:
  1470                                  	;mov	ah,7
  1471 00000109 B407                    	mov	ah,XMM_QUERY_A20
  1472                                  	;call	cs:XMMCallAddr
  1473 0000010B 2EFF1E[9200]            	call	far [cs:XMMCallAddr]
  1474 00000110 09C0                    	or	ax,ax
  1475                                  	; 16/04/2023
  1476 00000112 750B                    	jnz	short QA20_ON		; A20 is on, jump to resident
  1477                                  	; 18/07/2024
  1478                                  EnableA20:
  1479                                  	;mov	ah,5
  1480 00000114 B405                    	mov	ah,XMM_LOCAL_ENABLE_A20	; turn A20 on
  1481                                  	;call	cs:XMMCallAddr
  1482 00000116 2EFF1E[9200]            	call	far [cs:XMMCallAddr]
  1483 0000011B 09C0                    	or	ax,ax
  1484 0000011D 7404                    	jz	short XMMerror		; AX = 0 fatal error
  1485                                  QA20_ON:
  1486 0000011F 5B                      	pop	bx
  1487 00000120 58                      	pop	ax
  1488                                  A20_on:
  1489 00000121 9D                      	popf				; flags have to be unchanged
  1490 00000122 C3                      	retn
  1491                                  ;If we get an error, we just loop forever
  1492                                  XMMerror:
  1493 00000123 EBFE                    	jmp	short XMMerror
  1494                                  %endif
  1495                                  
  1496                                  ; ----------------------------------------------------------------------------
  1497                                  
  1498                                  ; M005; This is a far jump to the actual int 2fh entry point. The renormalized
  1499                                  ; M005; int 2fh cs:ip points here. We hardcode a far jump here to the int 2fh
  1500                                  ; M005; handler. Note that we have to hardcode a jump and we cannot use any
  1501                                  ; M005; pointers because our cs is going to be different. The segment to
  1502                                  ; M005; jump to is patched in at init time. (in init.asm)
  1503                                  
  1504                                  Carousel_i2f_Hook:			; M005
  1505 00000125 EA                      	db	0EAh			; far jump opcode; M005
  1506 00000126 [9700]                  	dw	Int2f_Trap ; DATARES	; int 2fh offset ; M005
  1507                                  int2fh_segm:	; 22/07/2024
  1508 00000128 0000                    	dw	0			; int 2fh segment; M005
  1509                                  
  1510                                  ; ----------------------------------------------------------------------------
  1511                                  
  1512                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1513                                  %if 0
  1514                                  	XMM_QUERY_A20 equ 7 ; 09/01/2023
  1515                                  QueryA20:
  1516                                  	push	bx
  1517                                  	push	ax
  1518                                  	;mov	ah,7
  1519                                  	mov	ah,XMM_QUERY_A20
  1520                                  	;call	cs:XMMCallAddr
  1521                                  	call	far [cs:XMMCallAddr]
  1522                                  	or	ax,ax
  1523                                  	pop	ax
  1524                                  	pop	bx
  1525                                  	; 16/04/2023
  1526                                  	jnz	short QA20_ON	; cf = 0	; AX = 1 => ON
  1527                                  	stc					; OFF
  1528                                  	;retn
  1529                                  QA20_ON:
  1530                                  	;clc					; ON
  1531                                  	retn
  1532                                  %endif
  1533                                  
  1534                                  ; ----------------------------------------------------------------------------
  1535                                  
  1536                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  1537                                  %if 0
  1538                                  	XMM_LOCAL_ENABLE_A20 equ 5
  1539                                  EnableA20:
  1540                                  	push	bx
  1541                                  	push	ax
  1542                                  	;mov	ah,5
  1543                                  	mov	ah,XMM_LOCAL_ENABLE_A20
  1544                                  	;call	cs:XMMCallAddr
  1545                                  	call	far [cs:XMMCallAddr]
  1546                                  	or	ax,ax
  1547                                  	jz	short XMMerror			; AX = 0 fatal error
  1548                                  	pop	ax
  1549                                  	pop	bx
  1550                                  	retn
  1551                                  ;If we get an error, we just loop forever
  1552                                  XMMerror:
  1553                                  	jmp	short XMMerror
  1554                                  %endif
  1555                                  
  1556                                  ; -----------------------------------------------------------------------------
  1557                                  
  1558                                  ; 05/06/2023
  1559                                  ;HV_Extern	equ	1
  1560                                  ;HV_LoadHigh	equ	1
  1561                                  ;HV_Stub	equ	1
  1562                                  ;	include	highvar.inc	; Make high-memory variables external here
  1563                                  ;	include	highexit.inc	; And add code for UnHideUMBs
  1564                                  
  1565                                  ;==============================================================================
  1566                                  ; HIGHEXIT.INC, MSDOS 6.0, 1992
  1567                                  ;==============================================================================
  1568                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  1569                                  
  1570                                  DOS_STRATEGY_GET equ  5800h	; Int 21h, Func 58h, Svc 0 = get alloc strategy
  1571                                  DOS_STRATEGY_SET equ  5801h	; Int 21h, Func 58h, Svc 1 = set alloc strategy
  1572                                  DOS_UMBLINK_GET	equ   5802h	; Int 21h, Func 58h, Svc 2 = get link state
  1573                                  DOS_UMBLINK_SET	equ   5803h	; Int 21h, Func 58h, Svc 3 = set link state
  1574                                  DOS_GET_LISTS	equ     52h	; Int 21h, Func 52h = get list of lists
  1575                                  
  1576                                  UMB_HeadIdx	equ     8Ch	; Offset from ES (after func52h) to get UMBHead
  1577                                  
  1578                                  	; 05/06/2023
  1579                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:01D9h
  1580                                  
  1581                                  ; -----------------------------------------------------------------------------
  1582                                  ;*** UnHideUMBs - Marks HIDDEN elements as FREE
  1583                                  ; -----------------------------------------------------------------------------
  1584                                  ; ENTRY:  None; perhaps, earlier, HideUMBs was called... if not, we have
  1585                                  ;               very little to do, as no elelments will be marked as HIDDEN.
  1586                                  ; EXIT:   Sets InHigh to zero; carry clear if HideUMBs was called earlier.
  1587                                  ; ERROR:  None
  1588                                  ; USES:   fInHigh (from highvar.inc), carry flag
  1589                                  ; -----------------------------------------------------------------------------
  1590                                  
  1591                                  UnHideUMBs:
  1592 0000012A 50                      	push	ax		; Save ax for what we're about to do
  1593                                  
  1594                                  ; -----------------------------------------------------------------------------
  1595                                  ; BUGBUG t-richj 11-8-92: The following six lines were commented out for a good
  1596                                  ;    length of time. Those six constitute a check of whether or not we should
  1597                                  ;    indeed clean up the upper-memory chain; without such a check, COMMAND.COM
  1598                                  ;    will destroy the current link-state and memory-allocation strategy after
  1599                                  ;    every command execution.
  1600                                  ; -----------------------------------------------------------------------------
  1601                                  
  1602                                  	; 05/06/2023
  1603                                  	;getdata al,fInHigh	; Get InHigh from data segment
  1604                                  	;
  1605                                  	;push	ds
  1606 0000012B A0[3005]                	mov	al,[fInHigh]
  1607                                  	;pop	ds
  1608                                  
  1609                                  	;or	al, al
  1610                                  	;jnz	short uhu10	; If didn't call loadhigh/devicehigh earlier,
  1611                                  
  1612                                  	;pop	ax		; then there's nothing to do here... so
  1613                                  	;stc			; restore everything and return.  Just like
  1614                                  	;retn			; that.
  1615                                  
  1616                                  	; 05/06/2023
  1617 0000012E 3C01                    	cmp	al,1
  1618 00000130 720F                    	jb	short uhu20	; cf=1
  1619                                  uhu10:	
  1620 00000132 E8A000                  	call	linkumb		; Make sure UMBs are linked in.
  1621 00000135 E82000                  	call	FreeUMBs
  1622                                  
  1623                                  	;putdata fInHigh, 0	; We're leaving, so update fInHigh.
  1624                                  	;
  1625                                  	;push	es
  1626                                  	;mov	byte [es:fInHigh],0
  1627                                  	;pop	es
  1628                                  	; 05/06/2023
  1629 00000138 C606[3005]00            	mov	byte [fInHigh],0
  1630                                  
  1631 0000013D E80300                  	call	he_unlink	; Unlink UMBs
  1632                                  
  1633                                  	;pop	ax
  1634                                  	;clc
  1635                                  	;retn
  1636                                  
  1637 00000140 F8                      	clc
  1638                                  uhu20:
  1639 00000141 58                      	pop	ax
  1640 00000142 C3                      	retn
  1641                                  
  1642                                  ; -----------------------------------------------------------------------------
  1643                                  ;*** he_unlink - unlinks UMBs if fm_umb is set to 0
  1644                                  ; -----------------------------------------------------------------------------
  1645                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
  1646                                  ; EXIT:     None
  1647                                  ; ERROR:    None
  1648                                  ; USES:     AX, BX
  1649                                  ; -----------------------------------------------------------------------------
  1650                                  
  1651                                  	; 05/06/2023
  1652                                  he_unlink:
  1653 00000143 30FF                    	xor	bh, bh
  1654                                  	
  1655                                  	;getdata bl,fm_umb		; Restore original link-state
  1656                                  	;
  1657                                  	;push	ds
  1658 00000145 8A1E[3505]              	mov     bl,[fm_umb]
  1659                                  	;pop	ds
  1660                                  
  1661 00000149 B80358                  	mov	ax,DOS_UMBLINK_SET ; 5803h
  1662 0000014C CD21                    	int	21h
  1663                                  
  1664                                  	;xor	bh, bh
  1665                                  	
  1666                                  	;getdata bl,fm_strat		; Restore original mem-alloc strategy
  1667                                  	;push	ds
  1668 0000014E 8A1E[3605]              	mov     bl,[fm_strat]
  1669                                  	;pop	ds
  1670                                  
  1671 00000152 B80158                  	mov	ax,DOS_STRATEGY_SET ; 5801h
  1672 00000155 CD21                    	int	21h
  1673                                  
  1674 00000157 C3                      	retn
  1675                                  
  1676                                  ; -----------------------------------------------------------------------------
  1677                                  ;*** freeUMBs - frees all HIDDEN memory elements in upper-memory.
  1678                                  ; -----------------------------------------------------------------------------
  1679                                  ; ENTRY:    None
  1680                                  ; EXIT:     None; HIDDEN memory elements returned to FREE
  1681                                  ; ERROR:    None (ignore CF)
  1682                                  ; USES:     Flags
  1683                                  ; -----------------------------------------------------------------------------
  1684                                  
  1685                                  	; 05/06/2023
  1686                                  arena_signature_end equ 5Ah ; 'Z'
  1687                                  arena_signature equ 0
  1688                                  arena_size equ 3
  1689                                  
  1690                                  FreeUMBs:
  1691 00000158 50                      	push	ax
  1692 00000159 06                      	push	es
  1693                                  
  1694 0000015A E86900                  	call	HeadUmb		; Returns with carry if err, else ES == MCB
  1695 0000015D 721C                    	jc	short fusX
  1696                                  fus10:
  1697 0000015F 8EC0                    	mov	es,ax		; Prepare for the loop; ES = current MCB addr.
  1698 00000161 E81A00                  	call	isHideMCB	; Returns with ZF set if owner is 0
  1699 00000164 7503                    	jnz	short fus20
  1700 00000166 E84200                  	call	freeMCB
  1701                                  fus20:	
  1702 00000169 26A00000                	mov	al,[es:arena_signature] ; mov al,[es:0]
  1703 0000016D 3C5A                    	cmp	al,arena_signature_end ; 'Z' ; 5Ah
  1704 0000016F 740A                    	jz	short fusX	; That means this was the last MCB--that's it.
  1705                                  
  1706 00000171 8CC0                    	mov	ax,es
  1707 00000173 2603060300              	add	ax,[es:arena_size] ; add ax,[es:3]
  1708 00000178 40                      	inc	ax
  1709                                  	;mov	es,ax		; Go on forward.
  1710                                  	;jmp	short fus10
  1711                                  	; 18/07/2024
  1712 00000179 EBE4                    	jmp	short fus10
  1713                                  fusX:
  1714 0000017B 07                      	pop	es
  1715 0000017C 58                      	pop	ax
  1716 0000017D C3                      	retn
  1717                                  
  1718                                  ; -----------------------------------------------------------------------------
  1719                                  ;*** isHideMCB - returns with ZF set if current MCB (ES:0) is HIDDEN
  1720                                  ; -----------------------------------------------------------------------------
  1721                                  ; ENTRY:    ES:0 should point to an MCB
  1722                                  ; EXIT:     ZF set if MCB is hidden, else !ZF
  1723                                  ; ERROR:    None
  1724                                  ; USES:     Flags
  1725                                  ; -----------------------------------------------------------------------------
  1726                                  
  1727                                  	; 05/06/2023
  1728                                  SystemPSPOwner	equ 8
  1729                                  arena_owner	equ 1
  1730                                  arena_name	equ 8
  1731                                  
  1732                                  isHideMCB:
  1733 0000017E 50                      	push	ax
  1734                                  
  1735 0000017F 26833E010008            	cmp	word [es:arena_owner],SystemPSPOwner ; If the owner's SYSTEM
  1736 00000185 7522                    	jne	short ihm_x			     ; then check for HIDDEN
  1737                                  
  1738 00000187 26A10800                	mov	ax,[es:arena_name]   ; [es:8]
  1739 0000018B 3D4849                  	cmp	ax,'HI' ; 4948h
  1740 0000018E 7519                    	jne	short ihm_x
  1741 00000190 26A10A00                	mov	ax,[es:arena_name+2] ; [es:10]
  1742 00000194 3D4444                  	cmp	ax,'DD' ; 4444h
  1743 00000197 7510                    	jne	short ihm_x
  1744 00000199 26A10C00                	mov	ax,[es:arena_name+4] ; [es:12]
  1745 0000019D 3D454E                  	cmp	ax,'EN' ; 4E45h
  1746 000001A0 7507                    	jne	short ihm_x
  1747 000001A2 26A10E00                	mov	ax,[es:arena_name+6] ; [es:14]
  1748 000001A6 3D2020                  	cmp	ax,'  ' ; 2020h
  1749                                  ihm_x:
  1750 000001A9 58                      	pop	ax
  1751 000001AA C3                      	retn
  1752                                  
  1753                                  ; -----------------------------------------------------------------------------
  1754                                  ;*** freeMCB - marks as free the MCB at ES:0
  1755                                  ; -----------------------------------------------------------------------------
  1756                                  ; ENTRY:    ES:0 should point to an MCB
  1757                                  ; EXIT:     None; MCB free'd
  1758                                  ; ERROR:    None
  1759                                  ; USES:     AX
  1760                                  ; -----------------------------------------------------------------------------
  1761                                  
  1762                                  	; 05/06/2023
  1763                                  freeMCB:
  1764 000001AB 26C70601000000          	mov	word [es:arena_owner],0	; [es:1]
  1765 000001B2 B82020                  	mov	ax,'  '
  1766 000001B5 26A30800                	mov	[es:arena_name+0],ax	; [es:8]
  1767 000001B9 26A30A00                	mov	[es:arena_name+2],ax
  1768 000001BD 26A30C00                	mov	[es:arena_name+4],ax
  1769 000001C1 26A30E00                	mov	[es:arena_name+6],ax	; [es:14]
  1770 000001C5 C3                      	retn
  1771                                  
  1772                                  ; -----------------------------------------------------------------------------
  1773                                  ;*** HeadUmb - returns in AX the address of the first UMB block (0x9FFF)
  1774                                  ; -----------------------------------------------------------------------------
  1775                                  ; ENTRY:  Nothing
  1776                                  ; EXIT:   AX contains 0x9FFF for most systems
  1777                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
  1778                                  ; USES:   Flags, AX
  1779                                  ; -----------------------------------------------------------------------------
  1780                                  
  1781                                  	; 05/06/2023
  1782                                  HeadUmb:
  1783                                  	; 18/07/2024 - PCDOS 7.1 - RESGROUP:02CDh
  1784                                  	;push	si
  1785                                  	;push	ds
  1786 000001C6 06                      	push	es
  1787                                  
  1788 000001C7 B452                    	mov	ah,DOS_GET_LISTS	; Call int 21h, function 52h...
  1789 000001C9 CD21                    	int	21h	; DOS - 2+ internal - GET LIST OF LISTS
  1790                                  			; Return: ES:BX -> DOS list of lists
  1791                                  
  1792 000001CB 26A18C00                	mov	ax,[es:UMB_HeadIdx]	; And read what's in ES:008Ch
  1793 000001CF 83F8FF                  	cmp	ax,0FFFFh
  1794                                  	;je	short xhu_e		; If it's 0xFFFF, it's an error...
  1795                                  	;clc				; Else, it isn't.
  1796                                  	;jmp	short xhu_x
  1797                                  ;xhu_e:
  1798                                  	;stc
  1799                                  	; 05/06/2023
  1800 000001D2 F5                      	cmc	; cf=0 -> cf=1
  1801                                  ;xhu_x:
  1802 000001D3 07                      	pop	es
  1803                                  	; 18/07/2024
  1804                                  	;pop	ds
  1805                                  	;pop	si
  1806 000001D4 C3                      	retn
  1807                                  
  1808                                  ; -----------------------------------------------------------------------------
  1809                                  ;*** linkumb - links UMBs not already linked in; updates fm_umb as needed
  1810                                  ; -----------------------------------------------------------------------------
  1811                                  ; ENTRY:    None
  1812                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
  1813                                  ; ERROR:    None
  1814                                  ; USES:     AX, BX, fm_umb
  1815                                  ; -----------------------------------------------------------------------------
  1816                                  
  1817                                  	; 05/06/2023
  1818                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:029Dh
  1819                                  linkumb:
  1820 000001D5 B80258                  	mov	ax,DOS_UMBLINK_GET ; 5802h
  1821 000001D8 CD21                    	int	21h			; Current link-state is now in al
  1822                                  
  1823 000001DA 08C0                    	or	al,al			; BUGBUG: proper check?
  1824 000001DC 7508                    	jnz	short lumbX		; Jumps if UMBs already linked in
  1825                                  
  1826 000001DE B80358                  	mov	ax,DOS_UMBLINK_SET ; 5803h
  1827 000001E1 BB0100                  	mov	bx,1
  1828 000001E4 CD21                    	int	21h
  1829                                  lumbX:
  1830 000001E6 C3                      	retn
  1831                                  
  1832                                  ;==============================================================================
  1833                                  ; STUB.ASM, MSDOS 6.0, 1991
  1834                                  ;==============================================================================
  1835                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  1836                                  
  1837                                  	; 09/01/2023 - Retro DOS v4.0 (& 4.1)
  1838                                  	; 05/06/2023 - Retro DOS 4.2
  1839                                  
  1840                                  ;The Exec call has to be issued from the data segment. The reason for this 
  1841                                  ;is TSRs. When a TSR does a call to terminate and stay resident, the call
  1842                                  ;returns with all registers preserved and so all our segment registers are
  1843                                  ;still set up. However, if the TSR unloads itself later on, it still 
  1844                                  ;comes back here. In this case the segment registers and the stack are
  1845                                  ;not set up and random things can happen. The only way to setup all the 
  1846                                  ;registers is to use the cs value and this can only be done when we are in
  1847                                  ;the data segment ourselves. So, this piece of code had to be moved from
  1848                                  ;the code segment to the data segment.
  1849                                  
  1850                                  	; MSDOS 6.22 COMMAND.COM RESGROUP:02AFh
  1851                                  Issue_Exec_Call:
  1852 000001E7 CD21                    	int 	21h
  1853                                  
  1854                                  ;We disable interrupts while changing the stack because there is a bug in 
  1855                                  ;some old 8088 processors where interrupts are let through while ss & sp
  1856                                  ;are being changed.
  1857                                  
  1858 000001E9 FA                      	cli
  1859 000001EA 0E                      	push	cs
  1860 000001EB 17                      	pop	ss
  1861                                  
  1862                                  	;;;mov	sp,53Eh ; MSDOS 5.0 COMMAND.COM RESGROUP:01DFh
  1863                                  	;;mov	sp,60Ah	; MSDOS 6.22 COMMAND.COM RESGROUP:02B4h
  1864                                  	;mov	sp,637h ; PCDOS 7.1 COMMAND.COM RESGROUP:02F8h
  1865                                  	;mov	sp,offset DATARES:RStack ; stack is set up
  1866 000001EC BC[2E05]                	mov	sp,RStack		; stack is set up
  1867                                  
  1868                                  ; 05/06/2023	
  1869                                  %if 0	
  1870                                  	; 20/04/2023
  1871                                  	;sti
  1872                                  	;push	cs
  1873                                  	;pop	ds			; ds = DATARES
  1874                                  
  1875                                  ; M009; Restore UMB state to that before Exec
  1876                                  
  1877                                  	;pushf				;    This call frees HIDDEN umb's,
  1878                                  	;call	UnHideUMBs		; <- restores the memory-allocation
  1879                                  	;popf				;    strategy and link state, as app.
  1880                                  
  1881                                  	; 09/01/2023 - Retro DOS v4.0
  1882                                  	; MSDOS 5.0 COMMAND.COM RESGROUP:01E2h
  1883                                  	; ----------------------
  1884                                  	sti
  1885                                  	push    cs
  1886                                  	pop     ds
  1887                                  	pushf
  1888                                  	;mov	al,[cs:fInHigh]
  1889                                  	; 18/04/2023
  1890                                  	mov	al,[fInHigh]
  1891                                  	test	al,80h
  1892                                  	jz      short uhu10
  1893                                  	and     al,7Fh
  1894                                  	;;call	cs:UMBOff_Entry
  1895                                  	;call	far [cs:UMBOff_Entry]
  1896                                  	call	far [UMBOff_Entry]
  1897                                  uhu10:
  1898                                  	;and	byte [cs:fInHigh],7Fh
  1899                                  	; 18/04/2023
  1900                                  	and	byte [fInHigh],7Fh
  1901                                  	popf
  1902                                  	; ----------------------
  1903                                  
  1904                                  %endif
  1905                                  	; 05/06/2023 - Retro DOS 4.2
  1906                                  	; MSDOS 6.22 COMMAND.COM RESGROUP:02B7h
  1907 000001EF FB                      	sti
  1908 000001F0 0E                      	push	cs
  1909 000001F1 1F                      	pop	ds			; ds = DATARES
  1910                                  
  1911                                  ; M009; Restore UMB state to that before Exec
  1912                                  
  1913 000001F2 9C                      	pushf				;    This call frees HIDDEN umb's,
  1914 000001F3 E834FF                  	call	UnHideUMBs		; <- restores the memory-allocation
  1915 000001F6 9D                      	popf				;    strategy and link state, as app
  1916                                  
  1917                                  ;We now jump to the stub trap which returns us to the resident code. All
  1918                                  ;flags are preserved by the stub code.
  1919                                  
  1920 000001F7 E9C8FE                  	jmp	Exec_Trap
  1921                                  
  1922                                  ;==============================================================================
  1923                                  ; RDATA.ASM, MSDOS 6.0, 1992
  1924                                  ;==============================================================================
  1925                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1)
  1926                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  1927                                  
  1928                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:02C2h (DATARES:02C2h) (*)
  1929                                  ; -----------------------------------------------------------------------------
  1930 000001FA 636F78                  cox_location:	db 'cox' ; (*)	
  1931 000001FD 0000                    cox_Y_option:	dw 0     ; (*)
  1932                                  ; -----------------------------------------------------------------------------
  1933                                  
  1934                                  ;***	Message substitution blocks
  1935                                  
  1936                                  ; 09/01/2023 - MSDOS 5.0 COMMAND.COM RESGROUP:01FFh (DATARES:01FFh)
  1937                                  
  1938                                  ;BlkDevErrSubst	label	byte
  1939                                  ;BlkDevErrRw	subst	<STRING,>		; "reading" or "writing"
  1940                                  ;		subst	<CHAR,DATARES:DrvLet>	; block device drive letter
  1941                                  
  1942 000001FF 02                      BlkDevErrSubst: db	2
  1943 00000200 0000                    BlkDevErrRw:	dw	0
  1944 00000202 01                      		db	1
  1945 00000203 [0502]                  		dw	DrvLet
  1946                                  
  1947 00000205 41                      DrvLet:		db	'A'			; drive letter
  1948                                  
  1949                                  
  1950                                  ;CharDevErrSubst label	byte
  1951                                  ;CharDevErrRw	subst	<STRING,>		 ; "reading" or "writing"
  1952                                  ;CharDevErrDev	subst	<STRING,DATARES:DevName> ; character device name
  1953                                  
  1954 00000206 02                      CharDevErrSubst: db	2
  1955 00000207 0000                    CharDevErrRw:	dw	0
  1956 00000209 02                      		db	2
  1957 0000020A [1802]                  		dw	DevName
  1958                                  
  1959                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:0318h
  1960                                  ;DevName:	times 8 db 0  ; db 8 dup (?),0	; device name, asciiz
  1961                                  ;		db	0
  1962                                  
  1963                                  ;NeedVolSubst	label	byte
  1964                                  ;		subst	<STRING,DATARES:VolName> ; volume name
  1965                                  ;		subst	<HEX,DATARES:VolSer+2>	 ; hi word of serial #
  1966                                  ;		subst	<HEX,DATARES:VolSer>	 ; lo word of serial #
  1967                                  
  1968 0000020C 02                      NeedVolSubst:	db	2
  1969 0000020D [1502]                  		dw	VolName
  1970 0000020F 03                      		db	3
  1971 00000210 [2302]                  		dw	VolSer+2
  1972 00000212 03                      		db	3
  1973 00000213 [2102]                  		dw	VolSer
  1974                                  
  1975                                  ; 18/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:0321h
  1976                                  	; NOTE:	VolName and VolSer must be adjacent
  1977                                  ;VolName:	times 11 db 0 ; db 11 dup (?),0	; volume name
  1978                                  		; 18/07/2024
  1979 00000215 000000                  VolName:	db	3 dup(0)
  1980 00000218 0000000000000000        DevName:	db	8 dup(0)
  1981                                  	
  1982 00000220 00                      		db	0
  1983 00000221 00000000                VolSer:		dd	0			; volume serial #
  1984                                  
  1985 00000225 00                      CDevAt:		db	0
  1986                                  
  1987                                  ;BadFatSubst	label	byte
  1988                                  ;		subst	<CHAR,DATARES:DrvLet>	; drive letter
  1989                                  
  1990 00000226 01                      BadFatSubst:	db	1
  1991 00000227 [0502]                  		dw	DrvLet
  1992                                  
  1993                                  ;PutBackSubst	label	byte
  1994                                  ;PutBackComSpec	subst	<STRING,>		  ; comspec string
  1995                                  ;		subst	<CHAR,DATARES:PutBackDrv> ; drive to put it in
  1996                                  
  1997 00000229 02                      PutBackSubst:	db	2
  1998 0000022A 0000                    PutBackComSpec:	dw	0
  1999 0000022C 01                      		db	1
  2000 0000022D [2F02]                  		dw	PutBackDrv
  2001                                  
  2002 0000022F 20                      PutBackDrv:	db	' '	; db 20h	; drive letter
  2003                                  
  2004                                  ;ExecErrSubst	subst	<STRING,DATARES:SafePathBuffer>
  2005                                  
  2006 00000230 02                      ExecErrSubst:	db	2
  2007 00000231 [5E04]                  		dw	SafePathBuffer
  2008                                  
  2009 00000233 00000000                NeedVol:	dd	0	; ptr to volume name from get ext err
  2010 00000237 00                      ErrType: 	db	0	; critical error message style, 0=old, 1=new
  2011                                  
  2012 00000238 00000000                Int_2e_Ret:	dd	0	; magic command executer return address
  2013 0000023C 0000                    Save_Pdb:	dw	0
  2014 0000023E 0000                    Parent:		dw	0
  2015 00000240 00000000                OldTerm:	dd	0
  2016 00000244 0000                    ErrCd_24:	dw	0
  2017 00000246 0000                    Handle01:	dw	0
  2018 00000248 00                      Loading:	db	0
  2019 00000249 0000                    Batch:		dw	0	; assume no batch mode initially
  2020                                  
  2021                                  ;;;;SR;
  2022                                  ;;;; This flag has been added for a gross hack introduced in batch processing. 
  2023                                  ;;;;We use it to indicate that this batch file has no CR-LF before EOF and that
  2024                                  ;;;;we need to fake the CR-LF for the line to be properly processed
  2025                                  ;;;;
  2026                                  ;;;BatchEOF:	db	0
  2027                                  
  2028                                  	; Bugbug: ComSpec should be 64+3+12+1?
  2029                                  	; What's this comspec_end about?
  2030                                  ; 21/07/2024
  2031                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0364h
  2032 0000024B 00<rep 40h>             ComSpec:	times 64 db 0 ; db 64 dup (0)
  2033 0000028B 0000                    ComSpec_End:	dw	0
  2034                                  
  2035                                  ;Trans		label	dword
  2036                                  ;		dw	TRANGROUP:Command
  2037                                  
  2038                                  Trans:		;dw	12Ch
  2039                                  		; MSDOS 5.0 COMMAND.COM RESGROUP:0296h (DATARES:0296h)
  2040 0000028D [2E01]                  		dw	COMMAND ; 16/04/2023
  2041 0000028F 0000                    TrnSeg:		dw	0
  2042                                  
  2043 00000291 00                      TrnMvFlg:	db	0	; set if transient portion has been moved
  2044                                  
  2045 00000292 00                      In_Batch:	db	0	; set if we are in batch processing mode
  2046 00000293 00                      Batch_Abort:	db	0	; set if user wants to abort from batch mode
  2047                                  
  2048 00000294 00                      ComDrv:		db	0	; drive spec to load autoexec and command
  2049 00000295 0000                    MemSiz:		dw	0
  2050 00000297 0000                    Sum:		dw	0
  2051 00000299 01                      ExtCom:		db	1	; for init, pretend just did an external
  2052 0000029A 0000                    RetCode: 	dw	0
  2053 0000029C 00                      Crit_Err_Info:	db	0	; hold critical error flags for r,i,f
  2054                                  
  2055                                  
  2056                                  ; The echo flag needs to be pushed and popped around pipes and batch files.
  2057                                  ; We implement this as a bit queue that is shr/shl for push and pop.
  2058                                  
  2059 0000029D 01                      EchoFlag:	db	00000001b ; low bit true => echo commands
  2060 0000029E 01                      Suppress:	db	1	; used for echo, 1=echo line
  2061 0000029F 0000                    Io_Save: 	dw	0
  2062 000002A1 00                      RestDir: 	db	0
  2063 000002A2 00                      PermCom: 	db	0	; true => permanent command
  2064                                  ; 05/06/2023
  2065 000002A3 FFFF                    SemiPermCom:	dw      -1	; MSDOS 6.0 COMMAND.COM 
  2066                                  				; true => semi-permanent command (/K)
  2067 000002A5 0000                    SingleCom:	dw	0	; true => single command version
  2068 000002A7 FFFF                    VerVal:		dw	-1
  2069 000002A9 00                      fFail:		db	0	; true => fail all int 24s
  2070 000002AA 00                      IfFlag:		db	0	; true => IF statement in progress
  2071                                  
  2072 000002AB 00                      ForFlag: 	db	0	; true => FOR statement in progress
  2073 000002AC 0000                    ForPtr:		dw	0
  2074                                  
  2075 000002AE 0000                    Nest:		dw	0	; nested batch file counter
  2076 000002B0 00                      Call_Flag:	db	0	; no CALL (batch command) in progress
  2077 000002B1 00                      Call_Batch_Flag: db	0
  2078 000002B2 0000                    Next_Batch:	dw	0	; address of next batch segment
  2079 000002B4 00                      NullFlag:	db	0	; flag if no command on command line
  2080 000002B5 00<rep 5h>              FUCase_Addr:	times 5 db 0 ; db 5 dup (0)
  2081                                  				; buffer for file ucase address
  2082                                  ; Bugbug: don't need crit_msg_ anymore?
  2083                                  
  2084                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
  2085                                  %if 0
  2086                                  Crit_Msg_Off:	dw	0	; saved critical error message offset
  2087                                  Crit_Msg_Seg:	dw	0	; saved critical error message segment
  2088                                  %endif
  2089                                  
  2090 000002BA 0000                    Dbcs_Vector_Addr: dw	0	; DBCS vector offset
  2091 000002BC 0000                    		 dw	0	; DBCS vector segment
  2092 000002BE 0000                    Append_State:	dw	0	; current state of append
  2093                                  				;  (if Append_Flag is set)
  2094 000002C0 00                      Append_Flag:	db	0	; set if append state is valid
  2095 000002C1 00                      Re_Out_App:	db	0
  2096 000002C2 00<rep 50h>             Re_OutStr:	times 64+3+13 db 0 ; db 64+3+13 dup (?)
  2097                                  
  2098                                  ; We flag the state of COMMAND in order to correctly handle the ^Cs at
  2099                                  ; various times. Here is the breakdown:
  2100                                  ;
  2101                                  ;   INITINIT	We are in the init code.
  2102                                  ;   INITSPECIAL We are in the date/time prompt
  2103                                  ;   INITCTRLC	We are handling a ^C already.
  2104                                  ;
  2105                                  ; If we get a ^C in the initialization but not in the date/time prompt, we
  2106                                  ; ignore the ^C. This is so the system calls work on nested commands.
  2107                                  ;
  2108                                  ; If we are in the date/time prompt at initialization, we stuff the user's
  2109                                  ; input buffer with a CR to pretend an empty response.
  2110                                  ;
  2111                                  ; If we are already handling a ^C, we set the carry bit and return to the user
  2112                                  ; (ourselves). We can then detect the carry set and properly retry the
  2113                                  ; operation.
  2114                                  
  2115                                  InitFlag:	;db	1
  2116 00000312 01                      		db	INITINIT
  2117                                  
  2118                                  ; Note: these two bytes are referenced as a word
  2119 00000313 00                      PipeFlag:	db	0
  2120 00000314 00                      PipeFiles:	db	0
  2121                                  
  2122                                  ; (rdata.asm, msdos 6.0, 1992)
  2123                                  ; ----------------------------------------------------------------------------
  2124                                  ; 09/01/2023 - MSDOS 5.0 COMMAND.COM RESGROUP:0320h (DATARES:0320h)
  2125                                  
  2126                                  ;;SR
  2127                                  ;; Pipe1 & Pipe2 now need to store full-fledged pathnames
  2128                                  ;;
  2129                                  ;
  2130                                  ;; Bugbug: can we find any way around maintaining these
  2131                                  ;; large buffers?
  2132                                  ;
  2133                                  ;Pipe1		db	67+12 dup (?)
  2134                                  ;Pipe2		db	67+12 dup (?)
  2135                                  ;
  2136                                  ;PipePtr 	dw	?
  2137                                  ;
  2138                                  ;PipeStr 	db	129 dup (?)
  2139                                  ;
  2140                                  ;EndPipe	label	byte	; marks end of buffers; M004
  2141                                  ;
  2142                                  ;;SR;
  2143                                  ;; We can move our EndInit code into above buffers. This way, the code will
  2144                                  ;;automatically be discarded after init.
  2145                                  ;;
  2146                                  ;; M004; We overlap our code with the Pipe buffers located above by changing
  2147                                  ;; M004; the origin.
  2148                                  ;;
  2149                                  ;	ORG	Pipe1	; M004
  2150                                  ;
  2151                                  ;; Bugbug: really need a procedure header for EndInit, describing
  2152                                  ;; what it expects, what it does.
  2153                                  ;
  2154                                  
  2155                                  ; 09/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  2156                                  
  2157                                  Pipe1	equ	EndInit
  2158                                  Pipe2	equ	Pipe1+67+12
  2159                                  PipePtr	equ	Pipe2+67+12
  2160                                  PipeStr	equ	PipePtr+2
  2161                                  EndPipe	equ	PipeStr+129	; EndInit+289
  2162                                  
  2163                                  ; Bugbug: really need a procedure header for EndInit, describing
  2164                                  ; what it expects, what it does.
  2165                                  
  2166                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:0320h
  2167                                  
  2168                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM (compatible with MSDOS 6.22)
  2169                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:03EAh 
  2170                                  
  2171                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  2172                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:041Eh
  2173                                  
  2174                                  EndInit:
  2175 00000315 1E                      	push	ds
  2176 00000316 06                      	push	es		; save segments
  2177                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM (ds=cs=RESGROUP)
  2178                                  	;push	cs
  2179                                  	;pop	ds		
  2180                                  	;assume	ds:RESGROUP
  2181                                  
  2182                                  ; M004; Save size of transient here before INIT segment is deallocated
  2183                                  
  2184 00000317 8B16[9720]              	mov	dx,[TrnSize]		; M004
  2185                                  ;M027
  2186                                  ; These variables are also defined in the INIT segment and need to be saved
  2187                                  ;before we resize
  2188                                  ;
  2189 0000031B A1[8B20]                	mov	ax,[OldEnv]	; Old Environment seg ;M027
  2190 0000031E 8B1E[8720]              	mov	bx,[EnvSiz]	; Size of new environment ;M027
  2191 00000322 8B0E[8D20]              	mov	cx,[UsedEnv]	; Size of old environment ;M027
  2192 00000326 50                      	push	ax		; Save all these values ;M027
  2193 00000327 53                      	push	bx		; M027
  2194 00000328 51                      	push	cx		; M027
  2195                                  
  2196                                  
  2197                                  ; Bugbug: push ds, pop es here.
  2198                                  	;mov	bx,ds
  2199                                  	;mov	es,bx		; es = RESGROUP
  2200                                  	; 09/01/2023
  2201 00000329 1E                      	push	ds
  2202 0000032A 07                      	pop	es
  2203                                  
  2204                                  ;ResSize is the actual size to be retained -- only data for HIMEM COMMAND, 
  2205                                  ; code + data for low COMMAND
  2206                                  
  2207 0000032B 8B1E[B404]              	mov	bx,[ResSize]	; Total size of resident
  2208 0000032F B44A                    	mov	ah,4Ah	; SETBLOCK
  2209                                  
  2210                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2211                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:043Ah
  2212                                  %if 1
  2213 00000331 803E[0E04]02            	cmp	byte [COMMAND_HIGH],2
  2214 00000336 7517                    	jne	short set_block
  2215                                  
  2216 00000338 31DB                    	xor	bx,bx		; low memory first
  2217 0000033A B80158                  	mov	ax,5801h	; set allocation strategy
  2218 0000033D CD21                    	int     21h     ; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2219                                  			; AL = function code: set allocation strategy
  2220 0000033F 8B0E7E00                	mov	cx,[7Eh]	; environment segment
  2221 00000343 E308                    	jcxz	skip_dealloc_env_seg
  2222 00000345 06                      	push	es
  2223 00000346 8EC1                    	mov	es,cx
  2224 00000348 B449                    	mov	ah,49h
  2225 0000034A CD21                    	int	21h 	; DOS - 2+ - FREE MEMORY
  2226                                  			; ES = segment address of area to be freed
  2227 0000034C 07                      	pop     es
  2228                                  skip_dealloc_env_seg:
  2229 0000034D B449                    	mov	ah,49h	; DEALLOC
  2230                                  set_block:	
  2231                                  %endif
  2232                                  	;mov	ah,SETBLOCK
  2233 0000034F CD21                    	int	21h		; Set block to resident size
  2234                                  
  2235                                  		; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
  2236                                  		; ES = segment address of block to change
  2237                                  		; BX = new size in paragraphs
  2238                                  
  2239                                  ;We check if this is for autoexec.bat (PermCom = 1). If so, we then
  2240                                  ;allocate a new batch segment, copy the old one into new batchseg and free
  2241                                  ;the old batchseg. Remember that the old batchseg was allocated on top of the
  2242                                  ;transient and we will leave a big hole if TSRs are loaded by autoexec.bat
  2243                                  ;
  2244                                  ; Bugbug: also describe why we alloc & copy batch seg BEFORE environment.
  2245                                  	
  2246 00000351 803E[A202]01            	cmp	byte [PermCom],1 ; permanent command.com?
  2247 00000356 7530                    	jne	short adjust_env ; no, do not free batchseg
  2248                                  
  2249 00000358 833E[4902]00            	cmp	word [Batch],0	 ; was there a valid batchseg?
  2250 0000035D 7429                    	je	short adjust_env ; no, dont juggle
  2251                                  
  2252                                  	;mov	bx,((SIZE BatchSegment) + 15 + 1 + 0Fh)/16 ; batchseg size
  2253                                  	; 21/01/2023
  2254 0000035F BB0400                  	mov	bx,((BATCHSEGMENT.SIZE)+16+0Fh)/16 ; (33+16+15)/16
  2255                                  	;mov	bx,4	; 09/01/2023
  2256                                  			; (MSDOS 5.0 COMMAND COM RESGROUP:0350h)
  2257 00000362 B448                    	mov	ah,48h
  2258                                  	;mov	ah,ALLOC
  2259 00000364 CD21                    	int	21h
  2260                                  
  2261                                  		; DOS - 2+ - ALLOCATE MEMORY
  2262                                  		; BX = number of 16-byte paragraphs desired
  2263                                  
  2264                                  ; Bugbug: I just had a thought. If DOS or SHARE or somebody leaves
  2265                                  ; a hole, the batch segment COULD already be in the ideal place. We
  2266                                  ; could be making it worse! We're second-guessing where memory
  2267                                  ; allocations go, which might not be such a great idea. Is there
  2268                                  ; a strategy, short of doing something even worse like diddling
  2269                                  ; arena headers, where we can minimize the possibility of fragmentation
  2270                                  ; under all cases? Hmm..
  2271                                  	
  2272 00000366 7220                    	jc	short adjust_env ; no memory, use old batchseg
  2273                                  
  2274 00000368 8EC0                    	mov	es,ax		 ; es = New batch segment
  2275 0000036A 31FF                    	xor	di,di
  2276 0000036C 31F6                    	xor	si,si
  2277                                  
  2278 0000036E 1E                      	push	ds
  2279 0000036F 8E1E[4902]              	mov	ds,[Batch]	 ; ds = Old Batch Segment
  2280                                  	;assume	ds:nothing
  2281                                  	;mov	cx,SIZE BatchSegment
  2282                                  	; 23/01/2023
  2283                                  	;mov	cx,BATCHSEGMENT.SIZE
  2284                                  	;;mov	cx,33	; 09/01/2023
  2285                                  	;		; (MSDOS 5.0 COMMAND COM RESGROUP:0364h)
  2286                                  	;
  2287                                  	;add	cx,16		 ; for the filename
  2288                                  	; 20/04/2023
  2289 00000373 B93100                  	mov	cx,BATCHSEGMENT.SIZE+16
  2290                                  
  2291                                  	; Bugbug: 16? Shouldn't this be a common equate or something?
  2292                                  	; It's sure be bad if we copied more bytes than the batch segment
  2293                                  	; holds!
  2294                                  	
  2295 00000376 FC                      	cld
  2296 00000377 F3A4                    	rep	movsb
  2297 00000379 1F                      	pop	ds
  2298                                  	;assume	ds:RESGROUP
  2299                                  
  2300 0000037A 8CC1                    	mov	cx,es		; save new batch segment 
  2301 0000037C 8E06[4902]              	mov	es,[Batch]
  2302 00000380 B449                    	mov	ah,49h
  2303                                  	;mov	ah,DEALLOC
  2304 00000382 CD21                    	int	21h		; free the old batch segment
  2305                                  
  2306                                  	; Bugbug: should we check for error?
  2307                                  
  2308 00000384 890E[4902]              	mov	[Batch],cx	; store new batch segment address
  2309                                  
  2310                                  adjust_env:
  2311                                  
  2312                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2313                                  ; PCDOS 7.1 COMMAND.COM
  2314                                  %if 1
  2315 00000388 BB8000                  	mov     bx,80h		; first fit, try high then low memory
  2316 0000038B B80158                  	mov     ax,5801h
  2317 0000038E CD21                    	int     21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2318                                  			; AL = function code: set allocation strategy
  2319                                  %endif
  2320 00000390 59                      	pop	cx		; cx = size of old env ;M027
  2321 00000391 5B                      	pop	bx		; bx = size of new env needed ;M027
  2322 00000392 5D                      	pop	bp		; bp = old env seg ;M027
  2323                                  
  2324                                  ;Allocate the correct size for the environment
  2325                                  
  2326 00000393 B448                    	mov	ah,48h
  2327                                  	;mov	ah,ALLOC
  2328 00000395 CD21                    	int	21h		; get memory
  2329 00000397 7272                    	jc	short nomem_err	; out of memory,signal error
  2330                                  	
  2331                                  	; Bugbug: why not continue, leaving environment where it is?
  2332                                  
  2333 00000399 A3[3A04]                	mov	[EnvirSeg],ax	; Store new environment segment
  2334                                  	;;mov	[ds:2Ch],ax
  2335                                  	;mov	[2Ch],ax
  2336                                  	;mov	[PDB_Environ],ax ; Put new env seg in PSP
  2337 0000039C A32C00                  	mov	[PDB.ENVIRON],ax
  2338 0000039F 8EC0                    	mov	es,ax		; es = address of allocated memory
  2339                                  	;assume	es:nothing
  2340                                  
  2341                                  ;Copy the environment to the newly allocated segment
  2342                                  
  2343 000003A1 1E                      	push	ds
  2344 000003A2 8EDD                    	mov	ds,bp		; ds = Old environment segment
  2345                                  	;assume	ds:nothing
  2346                                  
  2347 000003A4 31F6                    	xor	si,si
  2348 000003A6 89F7                    	mov	di,si		; Start transfer from 0
  2349                                  
  2350 000003A8 FC                      	cld
  2351 000003A9 F3A4                    	rep	movsb		; Do the copy
  2352                                  
  2353 000003AB 1F                      	pop	ds		; ds = RESGROUP
  2354                                  	;assume	ds:RESGROUP
  2355                                  
  2356                                  ; We have to free the old environment block if it was allocated by INIT
  2357                                  
  2358                                  ; Bugbug: is this only for the case when we were NOT passed an environment,
  2359                                  ; or does it also apply to passed environments?
  2360                                  
  2361                                  ;M036
  2362                                  ; Free up old env segment always because this is a copy passed by Exec and
  2363                                  ; takes up memory that is never used
  2364                                  
  2365                                  ;M044
  2366                                  ; Go back to the old strategy of not freeing the environment. Freeing it leaves
  2367                                  ; a hole behind that Ventura does not like. Basically, Ventura gives strange
  2368                                  ; errors if it gets a memory alloc that it is below its load segment. The
  2369                                  ; freed environment creates a large enough hole for some of its allocs to fit
  2370                                  ; in
  2371                                  
  2372                                  	;cmp	byte [AllocedEnv],0 ; has env been allocated by INIT?
  2373                                          ;je	short no_free	    ; no, do not free it
  2374                                  	; 21/01/2023
  2375                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0398h
  2376 000003AC 803E[5920]00            	cmp	byte [AllocedEnv],0 ; flag - old environment segment
  2377 000003B1 7506                    	jne	short no_free
  2378                                  
  2379 000003B3 8EC5                    	mov	es,bp
  2380 000003B5 B449                    	mov	ah,49h
  2381                                  	;mov	ah,DEALLOC
  2382 000003B7 CD21                    	int	21h		    ; Free it
  2383                                  no_free:
  2384                                  
  2385                                  ; M004; Start of changes
  2386                                  
  2387                                  ; Move the transient now. We will allocate the biggest block available
  2388                                  ; now and move the transient to the top of the block. We will then
  2389                                  ; deallocate this block. When the resident starts executing, it will
  2390                                  ; hopefully allocate this block again and find the transient intact.
  2391                                  
  2392                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2393                                  ; PCDOS 7.1 COMMAND.COM
  2394                                  %if 1
  2395 000003B9 31DB                    	xor	bx,bx	; low memory first fit
  2396 000003BB B80158                  	mov	ax,5801h
  2397 000003BE CD21                    	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2398                                  			; AL = function code: set allocation strategy
  2399 000003C0 31DB                    	xor	bx,bx	; remove UMBs from DOS memory chain
  2400 000003C2 B80358                  	mov	ax,5803h ; set UMB link state
  2401 000003C5 CD21                    	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  2402                                  			; AL = function code: (DOS 5beta) set UMB link state
  2403                                  %endif
  2404 000003C7 C606[9102]01            	mov	byte [TrnMvFlg],1 ; Indicate that transient has been moved
  2405 000003CC 06                      	push	es
  2406                                  	;;mov	si,offset ResGroup:TranStart
  2407                                  	; 09/01/2023
  2408                                  	;;mov	si,2320h	; MSDOS 5.0 COMMAND.COM RESGROUP:03ABh
  2409                                  	; 05/06/2023
  2410                                  	;mov	si,26E0h	; MSDOS 6.22 COMMAND.COM RESGROUP:0475h
  2411                                  	; 19/07/2024
  2412                                  	;mov	si,2890h	; PCDOS 7.1 COMMAND.COM RESGROUP:04DDh
  2413 000003CD BEE027                  	mov	si,TRANSTART	; (End of the resident portion)
  2414                                  	;mov	di,0
  2415 000003D0 31FF                    	xor	di,di ; 0
  2416                                  	;;mov	cx,offset TranGroup:TranSpaceEnd ; size to move
  2417                                  	;mov	cx,98C5h
  2418                                  	; 05/06/2023 - MSDOS 6.22 COMMAND.COM RESGROUP:047Bh
  2419                                  	;mov	cx,0AF95h	; TRANSIENT portion size
  2420                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  2421                                  	;mov	cx,0AA9Ah
  2422 000003D2 B96BA6                  	mov	cx,TRANSPACEEND
  2423                                  	
  2424                                  ; Find the largest block available
  2425                                  
  2426 000003D5 BBFFFF                  	mov	bx,0FFFFh
  2427 000003D8 B448                    	mov	ah,48h
  2428                                  	;mov	ah,ALLOC
  2429 000003DA CD21                    	int	21h
  2430                                  
  2431                                  ; dx = size of transient saved previously 
  2432                                  
  2433 000003DC 39D3                    	cmp	bx,dx		; enough memory?
  2434 000003DE 722B                    	jb	short nomem_err	; not enough memory for transient
  2435                                  
  2436 000003E0 B448                    	mov	ah,48h
  2437                                  	;mov	ah,ALLOC
  2438 000003E2 CD21                    	int	21h		; get the largest block
  2439 000003E4 7225                    	jc	short nomem_err	; something is really screwed up
  2440                                  
  2441 000003E6 50                      	push	ax		; save memory address
  2442 000003E7 01D8                    	add	ax,bx		; ax = top of my memory block
  2443 000003E9 29D0                    	sub	ax,dx		; less size of transient
  2444 000003EB A3[8F02]                	mov	[TrnSeg],ax	; save transient segment
  2445 000003EE 8EC0                    	mov	es,ax		;
  2446 000003F0 58                      	pop	ax		; restore our seg addr
  2447                                  
  2448                                  ; Everything is set for a move. We need to move in the reverse direction to
  2449                                  ; make sure we dont overwrite ourselves while copying
  2450                                  
  2451 000003F1 01CE                    	add	si,cx
  2452 000003F3 4E                      	dec	si
  2453 000003F4 01CF                    	add	di,cx
  2454 000003F6 4F                      	dec	di
  2455 000003F7 FD                      	std
  2456 000003F8 F3A4                    	rep	movsb
  2457 000003FA FC                      	cld
  2458                                  
  2459                                  ; Now we have to free up this block so that resident can get hold of it
  2460                                  
  2461 000003FB 8EC0                    	mov	es,ax
  2462 000003FD B449                    	mov	ah,49h
  2463                                  	;mov	ah,DEALLOC
  2464 000003FF CD21                    	int	21h		; release the memory block
  2465                                  
  2466                                  ; M004; End of changes
  2467                                  
  2468                                  	;mov	InitFlag,FALSE	; indicate INIT is done
  2469                                  	; 09/01/2023
  2470 00000401 C606[1203]00            	mov	byte [InitFlag],0	
  2471                                  
  2472 00000406 07                      	pop	es
  2473 00000407 1F                      	pop	ds
  2474                                  	;assume	ds:nothing
  2475                                  	
  2476                                  	; Bugbug: did we need to save & restore seg reg's during EndInit?
  2477                                  	
  2478 00000408 E9D5FC                  	jmp	LodCom_Trap	; allocate transient
  2479                                  
  2480                                  nomem_err:
  2481                                  
  2482                                  ;We call the error routine which will never return. It will either exit
  2483                                  ;with an error ( if not the first COMMAND ) or just hang after an error 
  2484                                  ;message ( if first COMMAND )
  2485                                  
  2486 0000040B E9B71B                  	jmp	Alloc_error
  2487                                  
  2488                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2489                                  ; ---------------------------------------
  2490                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0520h
  2491                                  %if 1
  2492                                  COMMAND_HIGH:
  2493 0000040E 00                      	db	0	; load high status of COMMAND.COM (/H switch)
  2494                                  %endif
  2495                                  ; ---------------------------------------
  2496                                  
  2497                                  ;EndCodeInit:	; label	byte		; M004
  2498                                  
  2499                                  	; 16/04/2023
  2500                                  	EndCodeInit equ $
  2501                                  
  2502                                  ;; M004; Check if the EndInit code will fit into the Pipe buffers above.
  2503                                  ;; M004; If not, we signal an assembly error
  2504                                  ;
  2505                                  ;IF2
  2506                                  ;	IF ($ GT EndPipe)
  2507                                  ;		.err
  2508                                  ;		%out	"ENDINIT CODE TOO BIG"
  2509                                  ;	ENDIF
  2510                                  ;ENDIF
  2511                                  
  2512                                  ;; M004; Set the origin back to what it was at the end of the buffers
  2513                                  ;;
  2514                                  ;		ORG	EndPipe		; M004
  2515                                  
  2516                                  ; 09/01/2023
  2517                                  ; MSDOS 5.0 COMMAND.COM - CODERES:03EDh
  2518                                  ; 05/06/2023
  2519                                  ; MSDOS 6.22 COMMAND.COM - CODERES:04B7h
  2520                                  ;	times 84 db 0	; db (EndPipe-EndCodeInit) dup(0)
  2521                                  
  2522                                  ; 16/04/2023
  2523                                  	FillBytes equ EndPipe - EndCodeInit
  2524                                  
  2525                                  ;%if EndCodeInit<EndPipe ; if (EndCodeInit < (EndInit+289))
  2526                                  ; 16/04/2023
  2527                                  %if FillBytes>0
  2528                                  	;times EndPipe - EndCodeInit db 0
  2529 0000040F 00<rep 27h>             	times FillBytes db 0   
  2530                                  %endif
  2531                                  
  2532                                  ; 09/01/2023 - Retrodos v4.0 (& v4.1)
  2533                                  ; MSDOS 5.0 COMMAND.COM - CODERES:0441h ; EndInit+289 
  2534                                  
  2535                                  ; 05/06/2023 - Retrodos v4.2
  2536                                  ; MSDOS 6.22 COMMAND.COM - CODERES:050Bh ; EndInit+289
  2537                                  
  2538                                  ; 19/07/2024 - Retrodos v5.0 COMMAND.COM
  2539                                  ; PCDOS 7.1 COMMAND.COM - CODERES:053Fh ; EndInit+289
  2540                                  
  2541                                  ;InPipePtr	dw	offset DATARES:Pipe1	; 320h
  2542                                  ;OutPipePtr	dw	offset DATARES:Pipe2	; 36Fh
  2543                                  
  2544 00000436 [1503]                  InPipePtr:	dw	Pipe1 ;; 320h for MSDOS 5.0 COMMAND.COM
  2545                                  			      ; 3EAh for MSDOS 6.22 COMMAND.COM
  2546                                  		 ; 19/07/2024 ; 41Eh for PCDOS 7.1 COMMAND.COM
  2547 00000438 [6403]                  OutPipePtr:	dw	Pipe2 ;; 36Fh for MSDOS 5.0 COMMAND.COM
  2548                                  			      ; 439h for MSDOS 6.22 COMMAND.COM
  2549                                  		 ; 19/07/2024 ; 46Dh for PCDOS 7.1 COMMAND.COM
  2550                                  
  2551                                  Exec_Block:	; label	byte	; the data block for exec calls
  2552 0000043A 0000                    EnvirSeg:	dw	0
  2553                                  Com_Ptr:	; label	dword
  2554 0000043C 8000                    		dw	80h	; point at unformatted parameters
  2555 0000043E 0000                    		dw	0
  2556                                  Com_Fcb1:	; label	dword
  2557 00000440 5C00                    		dw	5Ch
  2558 00000442 0000                    		dw	0
  2559                                  Com_Fcb2:	; label	dword
  2560 00000444 6C00                    		dw	6Ch
  2561 00000446 0000                    		dw	0
  2562                                  
  2563                                  ; variables passed to transient
  2564                                  TranVars:	; label	byte
  2565                                  		;dw	offset DATARES:HeadFix_Trap
  2566 00000448 [F400]                  		dw	HeadFix_Trap
  2567 0000044A 0000                    MySeg:		dw	0	; put our own segment here
  2568 0000044C 0000                    LTpa:		dw	0	; will store tpa segment here
  2569 0000044E 2F                      RSwitChar:	db	"/"
  2570 0000044F 5C                      RDirChar:	db	"\"
  2571                                  		;dw	offset DATARES:Issue_Exec_Call
  2572 00000450 [E701]                  		dw	Issue_Exec_Call
  2573 00000452 0000                    MySeg1:		dw	0
  2574                                  		;dw	offset DATARES:RemCheck_Trap
  2575 00000454 [CC00]                  		dw	RemCheck_Trap
  2576 00000456 0000                    MySeg2:		dw	0
  2577                                  
  2578                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2579                                  ; PCDOS 7.1 COMMAND.COM
  2580                                  %if 0
  2581                                  ResTest: 	dw	0
  2582                                  %endif
  2583                                  
  2584                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0561h
  2585                                  
  2586 00000458 0000                    Res_Tpa:	dw	0	; original tpa (not rounded to 64k)
  2587                                  
  2588                                  ; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
  2589 0000045A 0000                    Y_Flag:		dw	0
  2590                                  
  2591                                  TranVarEnd:	; label	byte
  2592                                  
  2593 0000045C 0000                    OldErrNo:	dw	0
  2594                                  
  2595                                  ;* NOTE: MsgBuffer and SafePathBuffer use the same memory.
  2596                                  ;  MsgBuffer is only used while a command is being executed.
  2597                                  ;  SafePathBuffer is no longer needed, since it is used for
  2598                                  ;  unsuccessful program launches.
  2599                                  
  2600                                  MsgBuffer:	; label	byte	; buffer for messages from disk
  2601                                  SafePathBuffer: ; label	byte	; resident pathname for EXEC
  2602                                  	;Bugbug: Why so big a buffer?
  2603                                  		;db	64+3+13 dup (0)	; path + 'd:\' 'file.ext' + null
  2604 0000045E 00<rep 50h>             		times	64+3+13 db 0		
  2605                                  
  2606                                  LENMSGORPATHBUF	equ $ - MsgBuffer
  2607                                  
  2608 000004AE 00000000                Int2fHandler:	dd	0	; address of next int 2f handler
  2609 000004B2 0000                    ResMsgEnd:	dw	0	; holds offset of msg end (end of resident)
  2610                                  
  2611                                  ;SR;
  2612                                  ; The three vars below have been added for a pure COMMAND.COM
  2613                                  
  2614 000004B4 0000                    ResSize:	dw	0
  2615                                  
  2616                                  ;SR;
  2617                                  ; Moved the stack here from the code segment
  2618                                  ;
  2619                                  ; bugbug: Why this odd stack size? And what should stack size be?
  2620                                  	
  2621                                  		;db	(80h - 3) dup (?)
  2622                                  ;align 2
  2623                                  		;times	124 db 0
  2624                                  		; 19/07/2024 - PCDOS 7.1 COMMAND.COM - RESGROUP:05BFh
  2625 000004B6 00<rep 78h>             		times	120 db 0
  2626                                  
  2627                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2628                                  align 2	
  2629                                  		
  2630                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:053Eh (offset RStack)
  2631                                  ; 05/06/2023
  2632                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:060Ah (offset RStack)
  2633                                  ; 19/07/2024
  2634                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:0637h (offset RStack)
  2635                                  
  2636                                  RStack:		; label	word
  2637 0000052E 0000                    OldDS:		dw	0	; keeps old ds value when jumping to
  2638                                  				; resident code segments
  2639                                  ;LoadHiFlg	db	0	; Flag set to 1 if UMB loading enabled ; M003
  2640                                  
  2641                                  ; include highvar.inc		; Add variables for 6.0 loadhigh functionality
  2642                                  ; -------------------------------
  2643                                  
  2644                                  ; fInHigh  - Is set to 1 during HideUMBs(), and back to zero in UnHideUMBs().
  2645                                  ; fUmbTiny - Is set to 1 if the user has specified /S on the command line.
  2646                                  ; SegLoad  - Segment address for first UMB specified; set automatically.
  2647                                  ; UmbLoad  - The load UMB number; for example, this is 3 if the user has
  2648                                  ;            given a command-line like "/L:3,500;4"
  2649                                  ; UmbUsed  - An array of characters, each of which is 1 iff the UMB
  2650                                  ;            matching its index number was specified on the command-line;
  2651                                  ;            for example, after "/L:3,500;4;7", UmbUsed[3], [4] and [7]
  2652                                  ;            will be set to 1. All others will be set to 0.
  2653                                  ; UmbSize  - An array of words, each of which is interpereted as a size
  2654                                  ;            specified by the user for a UMB (in the above example, all
  2655                                  ;            elements would be zero save UmbSize[3], which would be 500.
  2656                                  ; fm_umb   - Set to the old UMB link-state (0x80 or 0x00)
  2657                                  ; fm_strat - Set to the old memory-allocation strategy (0$00000???)
  2658                                  ; fm_argc  - Number of arguments received by ParseVar() (see ParseVar()
  2659                                  ;            for details).
  2660                                  
  2661                                  ; - MSDOS 6.0 COMMAND.COM -
  2662                                  ;; To keep track of which UMBs were specified on the DH/LH command lines, and
  2663                                  ;; to keep track of the minimum sizes given for each, there're two arrays kept
  2664                                  ;; in { IO.SYS: sysinitseg / COMMAND.COM: DATARES }... each is MAXUMB elements
  2665                                  ;; big. 16 should be around 14 too many for most users, so there's no expected
  2666                                  ;; space problem (it's just such a nice round number, eh?).
  2667                                  
  2668                                  ; 05/06/2023
  2669                                  MAXUMB	equ	16
  2670                                  
  2671                                  ; 10/01/2023 - Retro DOS v4.0 COMMAND.COM
  2672                                  ; MSDOS 5.0 COMMAND.COM RESGROUP:0540h (DATARES:0540h)
  2673                                  
  2674 00000530 00                      fInHigh:	db	0
  2675                                  
  2676                                  ; MSDOS 6.0 COMMAND.COM
  2677                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  2678                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:060Dh (DATARES:060Dh)
  2679                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2680                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:063Ah (DATARES:063Ah)
  2681                                  
  2682 00000531 00                      fUmbTiny:	db	0
  2683 00000532 0000                    SegLoad:	dw	0
  2684 00000534 00                      UmbLoad:	db	0
  2685                                  
  2686                                  ; 19/07/2024
  2687                                  ; PCDOS 7.1 COMMAND.COM
  2688                                  %if 0
  2689                                  UmbUsed:	times MAXUMB db 0 ; db MAXUMB dup (?)
  2690                                  UmbSize:	times MAXUMB dw 0 ; dw MAXUMB dup (?)
  2691                                  %else
  2692                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2693                                  	UmbUsed equ MsgBuffer	; 16 bytes
  2694                                  	UmbSize equ UmbUsed+MAXUMB ; UmbUsed+16; 16 words
  2695                                  %endif
  2696                                  
  2697 00000535 00                      fm_umb:		db	0
  2698 00000536 00                      fm_strat:	db	0
  2699 00000537 00                      fm_argc:	db	0
  2700                                  
  2701                                  ; UmbLoad is set to UNSPECIFED, below, until /L:umb is read; at which point
  2702                                  ; UmbLoad is set to the UMB number given.
  2703                                  
  2704                                  ;*** MESSAGES
  2705                                  ;    and other translatable text
  2706                                  
  2707                                  ; include comrmsg.inc	; M00
  2708                                  ; ------------------------------
  2709                                  
  2710                                  ; 10/01/2023 - Retro DOS v4.0 COMMAND.COM
  2711                                  ; MSDOS 5.0 COMMAND.COM RESGROUP:0541h (DATARES:0541h)
  2712                                  
  2713                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  2714                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0644h (DATARES:0644h)
  2715                                  
  2716                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  2717                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0641h (DATARES:0641h)
  2718                                  
  2719 00000538 41                      ABORT_CHAR:	db 'A'
  2720 00000539 52                      RETRY_CHAR:	db 'R'
  2721 0000053A 49                      IGNORE_CHAR:	db 'I'
  2722 0000053B 46                      FAIL_CHAR:	db 'F'
  2723 0000053C 59                      YES_CHAR:	db 'Y'
  2724 0000053D 4E                      NO_CHAR:	db 'N'
  2725 0000053E 05                      REQ_ABORT:	db 5
  2726 0000053F 41626F7274              		db 'Abort'
  2727 00000544 07                      REQ_RETRY:	db 7
  2728 00000545 2C205265747279          		db ', Retry'
  2729 0000054C 08                      REQ_IGNORE:	db 8
  2730 0000054D 2C2049676E6F7265        		db ', Ignore'
  2731 00000555 06                      REQ_FAIL:	db 6
  2732 00000556 2C204661696C            		db ', Fail'
  2733 0000055C 01                      REQ_END:	db 1
  2734 0000055D 3F                      		db '?'
  2735 0000055E 08                      MREAD:		db 8
  2736 0000055F 72656164696E6700        		db 'reading', 0
  2737 00000567 08                      MWRITE:		db 8
  2738 00000568 77726974696E6700        		db 'writing', 0
  2739 00000570 0E                      MDRIVE:		db 14
  2740 00000571 202531206472697665-     		db ' %1 drive %2',0Dh,0Ah
  2740 0000057A 2025320D0A         
  2741 0000057F 0F                      MDEVICE:	db 15
  2742 00000580 202531206465766963-     		db ' %1 device %2',0Dh,0Ah
  2742 00000589 652025320D0A       
  2743 0000058F 26                      MVOLSERIAL:	db 38
  2744 00000590 506C6561736520696E-     		db 'Please insert volume %1 serial %2-%3',0Dh,0Ah
  2744 00000599 7365727420766F6C75-
  2744 000005A2 6D6520253120736572-
  2744 000005AB 69616C2025322D2533-
  2744 000005B4 0D0A               
  2745 000005B6 25                      BADFATMSG:	db 37
  2746 000005B7 46696C6520616C6C6F-     		db 'File allocation table bad, drive %1',0Dh,0Ah
  2746 000005C0 636174696F6E207461-
  2746 000005C9 626C65206261642C20-
  2746 000005D2 64726976652025310D-
  2746 000005DB 0A                 
  2747 000005DC 15                      COMBAD:		db 21
  2748 000005DD 496E76616C69642043-     		db 'Invalid COMMAND.COM',0Dh,0Ah
  2748 000005E6 4F4D4D414E442E434F-
  2748 000005EF 4D0D0A             
  2749 000005F2 21                      PUTBACKMSG:	db 33
  2750 000005F3 496E73657274206469-     		db 'Insert disk with %1 in drive %2',0Dh,0Ah
  2750 000005FC 736B20776974682025-
  2750 00000605 3120696E2064726976-
  2750 0000060E 652025320D0A       
  2751 00000614 21                      PROMPT:		db 33
  2752 00000615 507265737320616E79-     		db 'Press any key to continue . . .',0Dh,0Ah
  2752 0000061E 206B657920746F2063-
  2752 00000627 6F6E74696E7565202E-
  2752 00000630 202E202E0D0A       
  2753 00000636 1C                      ENDBATMES:	db 28
  2754 00000637 0D0A                    		db 0Dh,0Ah
  2755 00000639 5465726D696E617465-     		db 'Terminate batch job (Y/N)?'
  2755 00000642 206261746368206A6F-
  2755 0000064B 622028592F4E293F   
  2756 00000653 13                      EXECEMES:	db 19
  2757 00000654 43616E6E6F74206578-     		db 'Cannot execute %1',0Dh,0Ah
  2757 0000065D 65637574652025310D-
  2757 00000666 0A                 
  2758 00000667 13                      EXEBAD:		db 19
  2759 00000668 4572726F7220696E20-     		db 'Error in EXE file',0Dh,0Ah
  2759 00000671 4558452066696C650D-
  2759 0000067A 0A                 
  2760 0000067B 22                      TOOBIG:		db 34
  2761 0000067C 50726F6772616D2074-     		db 'Program too big to fit in memory',0Dh,0Ah
  2761 00000685 6F6F2062696720746F-
  2761 0000068E 2066697420696E206D-
  2761 00000697 656D6F72790D0A     
  2762 0000069E 16                      NOHANDMES:	db 22
  2763 0000069F 0D0A                    		db 0Dh,0Ah
  2764 000006A1 4E6F20667265652066-     		db 'No free file handles'
  2764 000006AA 696C652068616E646C-
  2764 000006B3 6573               
  2765 000006B5 1A                      RBADNAM:	db 26
  2766 000006B6 42616420436F6D6D61-     		db 'Bad Command or file name',0Dh,0Ah
  2766 000006BF 6E64206F722066696C-
  2766 000006C8 65206E616D650D0A   
  2767                                  ACCDENIED:	; 14/01/2023
  2768                                  		; 10/01/2023
  2769                                  ACCDEN:		;db 14
  2770                                  		;db 'Access denied '
  2771                                  		; 19/07/2024 - PCDOS 7.1
  2772 000006D0 0D                      		db 13
  2773 000006D1 416363657373206465-     		db 'Access denied'
  2773 000006DA 6E696564           
  2774 000006DE 19                      BMEMMES:	db 25
  2775 000006DF 0D0A4D656D6F727920-     		db 0Dh,0Ah,'Memory allocation error'
  2775 000006E8 616C6C6F636174696F-
  2775 000006F1 6E206572726F72     
  2776 000006F8 26                      HALTMES:	db 38
  2777 000006F9 0D0A                    		db 0Dh,0Ah
  2778 000006FB 43616E6E6F74206C6F-     		db 'Cannot load COMMAND, system halted',0Dh,0Ah
  2778 00000704 616420434F4D4D414E-
  2778 0000070D 442C2073797374656D-
  2778 00000716 2068616C7465640D0A 
  2779 0000071F 21                      FRETMES:	db 33
  2780 00000720 0D0A                    		db 0Dh,0Ah,
  2781 00000722 43616E6E6F74207374-     		db 'Cannot start COMMAND, exiting',0Dh,0Ah
  2781 0000072B 61727420434F4D4D41-
  2781 00000734 4E442C206578697469-
  2781 0000073D 6E670D0A           
  2782                                  ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  2783                                  %if 0
  2784                                  ;%if 1  ; 20/07/2024 - Retro DOS v5.1 COMMAND.COM
  2785                                  PATRICIDE:	db 46
  2786                                  		db 0Dh,0Ah
  2787                                  		db 'Top level process aborted, cannot continue'
  2788                                  		db 0Dh,0Ah
  2789                                  %endif
  2790 00000741 02                      NEWLINE:	db 2
  2791 00000742 0D0A                    		db 0Dh, 0Ah
  2792                                  
  2793                                  ; 10/01/2023
  2794                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:077Dh
  2795                                  ; 05/06/2023
  2796                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0880h
  2797                                  
  2798                                  ; 19/07/2024
  2799                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0832h
  2800                                  
  2801 00000744 [280C]                  MsgPtrLists:	dw EXTMSGPTRS		; extended error messages
  2802 00000746 0100                    		dw 1
  2803 00000748 [E309]                  		dw PARSMSGPTRS		; parse	error messages
  2804 0000074A 0100                    		dw 1
  2805 0000074C [280C]                  		dw EXTMSGPTRS		; critical error messages
  2806 0000074E 0100                    		dw 1
  2807 00000750 0000                    		dw 0			; File system error messages
  2808 00000752 0000                    		dw 0			; are not supported.
  2809 00000754 [EA00]                  		dw MsgRetrv_Trap	; disk retriever routine
  2810 00000756 0000                    MySeg3:		dw 0			; segment of retriever routine
  2811                                  
  2812                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0791h
  2813                                  ; 05/06/2023
  2814                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0894h
  2815                                  
  2816                                  ; 19/07/2024
  2817                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0846h
  2818                                  
  2819 00000758 13                      CRMSG0:		db 19
  2820 00000759 57726974652070726F-     		db 'Write protect error'
  2820 00000762 74656374206572726F-
  2820 0000076B 72                 
  2821 0000076C 0C                      CRMSG1:		db 12
  2822 0000076D 496E76616C69642075-     		db 'Invalid unit'
  2822 00000776 6E6974             
  2823 00000779 09                      CRMSG2:		db 9
  2824 0000077A 4E6F74207265616479      		db 'Not ready'
  2825 00000783 16                      CRMSG3:		db 22
  2826 00000784 496E76616C69642064-     		db 'Invalid device request'
  2826 0000078D 657669636520726571-
  2826 00000796 75657374           
  2827 0000079A 0A                      CRMSG4:		db 10
  2828 0000079B 44617461206572726F-     		db 'Data error'
  2828 000007A4 72                 
  2829 000007A5 21                      CRMSG5:		db 33
  2830 000007A6 496E76616C69642064-     		db 'Invalid device request parameters'
  2830 000007AF 657669636520726571-
  2830 000007B8 756573742070617261-
  2830 000007C1 6D6574657273       
  2831 000007C7 0A                      CRMSG6:		db 10
  2832 000007C8 5365656B206572726F-     		db 'Seek error'
  2832 000007D1 72                 
  2833 000007D2 12                      CRMSG7:		db 18
  2834 000007D3 496E76616C6964206D-     		db 'Invalid media type'
  2834 000007DC 656469612074797065 
  2835 000007E5 10                      CRMSG8:		db 16
  2836 000007E6 536563746F72206E6F-     		db 'Sector not found'
  2836 000007EF 7420666F756E64     
  2837 000007F6 1A                      CRMSG9:		db 26
  2838 000007F7 5072696E746572206F-     		db 'Printer out of paper error'
  2838 00000800 7574206F6620706170-
  2838 00000809 6572206572726F72   
  2839 00000811 11                      CRMSG10:	db 17
  2840 00000812 577269746520666175-     		db 'Write fault error'
  2840 0000081B 6C74206572726F72   
  2841 00000823 10                      CRMSG11:	db 16
  2842 00000824 52656164206661756C-     		db 'Read fault error'
  2842 0000082D 74206572726F72     
  2843 00000834 0F                      CRMSG12:	db 15
  2844 00000835 47656E6572616C2066-     		db 'General failure'
  2844 0000083E 61696C757265       
  2845 00000844 11                      CRMSG13:	db 17
  2846 00000845 53686172696E672076-     		db 'Sharing violation'
  2846 0000084E 696F6C6174696F6E   
  2847 00000856 0E                      CRMSG14:	db 14
  2848 00000857 4C6F636B2076696F6C-     		db 'Lock violation'
  2848 00000860 6174696F6E         
  2849 00000865 13                      CRMSG15:	db 19
  2850 00000866 496E76616C69642064-     		db 'Invalid disk change'
  2850 0000086F 69736B206368616E67-
  2850 00000878 65                 
  2851 00000879 0F                      CRMSG16:	db 15
  2852 0000087A 46434220756E617661-     		db 'FCB unavailable'
  2852 00000883 696C61626C65       
  2853 00000889 19                      CRMSG17:	db 25
  2854 0000088A 53797374656D207265-     		db 'System resource exhausted'
  2854 00000893 736F75726365206578-
  2854 0000089C 68617573746564     
  2855 000008A3 12                      CRMSG18:	db 18
  2856 000008A4 436F64652070616765-     		db 'Code page mismatch'
  2856 000008AD 206D69736D61746368 
  2857 000008B6 0C                      CRMSG19:	db 12
  2858 000008B7 4F7574206F6620696E-     		db 'Out of input'
  2858 000008C0 707574             
  2859 000008C3 17                      CRMSG20:	db 23
  2860 000008C4 496E73756666696369-     		db 'Insufficient disk space'
  2860 000008CD 656E74206469736B20-
  2860 000008D6 7370616365         
  2861                                  
  2862                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0914h
  2863                                  ; 05/06/2023
  2864                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0A17h
  2865                                  
  2866                                  ; 19/07/2024
  2867                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:09C9h
  2868                                  
  2869 000008DB [5807]                  CRITMSGPTRS:	dw CRMSG0
  2870 000008DD [6C07]                  		dw CRMSG1
  2871 000008DF [7907]                  		dw CRMSG2
  2872 000008E1 [8307]                  		dw CRMSG3
  2873 000008E3 [9A07]                  		dw CRMSG4
  2874 000008E5 [A507]                  		dw CRMSG5
  2875 000008E7 [C707]                  		dw CRMSG6
  2876 000008E9 [D207]                  		dw CRMSG7
  2877 000008EB [E507]                  		dw CRMSG8
  2878 000008ED [F607]                  		dw CRMSG9
  2879 000008EF [1108]                  		dw CRMSG10
  2880 000008F1 [2308]                  		dw CRMSG11
  2881 000008F3 [3408]                  		dw CRMSG12
  2882 000008F5 [4408]                  		dw CRMSG13
  2883 000008F7 [5608]                  		dw CRMSG14
  2884 000008F9 [6508]                  		dw CRMSG15
  2885 000008FB [7908]                  		dw CRMSG16
  2886 000008FD [8908]                  		dw CRMSG17
  2887 000008FF [A308]                  		dw CRMSG18
  2888 00000901 [B608]                  		dw CRMSG19
  2889 00000903 [C308]                  		dw CRMSG20
  2890                                  
  2891                                  		; 14/01/2023
  2892                                  ;DataresEnd:	;; MSDOS 5.0 COMMAND.COM - DATARES:093Eh (RESGROUP:093Eh)
  2893                                  		; 05/06/2023
  2894                                  DataresEnd:	; MSDOS 6.22 COMMAND.COM - DATARES:0A41h (RESGROUP:0A41h)
  2895                                  
  2896 00000905 13                      PAERRMSG0:	db 19
  2897 00000906 546F6F206D616E7920-     		db 'Too many parameters'
  2897 0000090F 706172616D65746572-
  2897 00000918 73                 
  2898 00000919 1A                      PAERRMSG1:	db 26
  2899 0000091A 526571756972656420-     		db 'Required parameter missing'
  2899 00000923 706172616D65746572-
  2899 0000092C 206D697373696E67   
  2900 00000934 0E                      PAERRMSG2:	db 14
  2901 00000935 496E76616C69642073-     		db 'Invalid switch'
  2901 0000093E 7769746368         
  2902 00000943 0F                      PAERRMSG3:	db 15
  2903 00000944 496E76616C6964206B-     		db 'Invalid keyword'
  2903 0000094D 6579776F7264       
  2904 00000953 01                      PAERRMSG4:	db 1
  2905 00000954 20                      		db 20h
  2906 00000955 24                      PAERRMSG5:	db 36
  2907 00000956 506172616D65746572-     		db 'Parameter value not in allowed range'
  2907 0000095F 2076616C7565206E6F-
  2907 00000968 7420696E20616C6C6F-
  2907 00000971 7765642072616E6765 
  2908                                  PAERRMSG6:	; 10/01/2023
  2909 0000097A 1B                      PAERRMSG7:	db 27
  2910 0000097B 506172616D65746572-     		db 'Parameter value not allowed'
  2910 00000984 2076616C7565206E6F-
  2910 0000098D 7420616C6C6F776564 
  2911                                  ;PAERRMSG7:	db 27
  2912                                  ;		db 'Parameter value not allowed'
  2913 00000996 1C                      PAERRMSG8:	db 28
  2914 00000997 506172616D65746572-     		db 'Parameter format not correct'
  2914 000009A0 20666F726D6174206E-
  2914 000009A9 6F7420636F72726563-
  2914 000009B2 74                 
  2915 000009B3 11                      PAERRMSG9:	db 17
  2916 000009B4 496E76616C69642070-     		db 'Invalid parameter'
  2916 000009BD 6172616D65746572   
  2917 000009C5 1D                      PAERRMSG10:	db 29
  2918 000009C6 496E76616C69642070-     		db 'Invalid parameter combination'
  2918 000009CF 6172616D6574657220-
  2918 000009D8 636F6D62696E617469-
  2918 000009E1 6F6E               
  2919                                  
  2920                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0A38h
  2921                                  ; 05/06/2023
  2922                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0B3Bh
  2923                                  
  2924                                  ; 19/07/2024
  2925                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0AD1h
  2926                                  
  2927 000009E3 [0509]                  PARSMSGPTRS:	dw PAERRMSG0
  2928 000009E5 [1909]                  		dw PAERRMSG1
  2929 000009E7 [3409]                  		dw PAERRMSG2
  2930 000009E9 [4309]                  		dw PAERRMSG3
  2931 000009EB [5309]                  		dw PAERRMSG4
  2932 000009ED [5509]                  		dw PAERRMSG5
  2933 000009EF [7A09]                  		dw PAERRMSG6
  2934 000009F1 [7A09]                  		dw PAERRMSG7
  2935 000009F3 [9609]                  		dw PAERRMSG8
  2936 000009F5 [B309]                  		dw PAERRMSG9
  2937 000009F7 [C509]                  		dw PAERRMSG10
  2938                                  ; 21/04/2023
  2939                                  NUMPARSMSGS equ ($-PARSMSGPTRS)>>1 ; 14/01/2023
  2940                                  
  2941 000009F9 10                      INVLFUNCT:	db 16
  2942 000009FA 496E76616C69642066-     		db 'Invalid function'
  2942 00000A03 756E6374696F6E     
  2943 00000A0A 0E                      FNOTFOUND:	db 14
  2944 00000A0B 46696C65206E6F7420-     		db 'File not found'
  2944 00000A14 666F756E64         
  2945 00000A19 0E                      PNOTFOUND:	db 14
  2946 00000A1A 50617468206E6F7420-     		db 'Path not found'
  2946 00000A23 666F756E64         
  2947 00000A28 13                      TOOMANYOF:	db 19
  2948 00000A29 546F6F206D616E7920-     		db 'Too many open files'
  2948 00000A32 6F70656E2066696C65-
  2948 00000A3B 73                 
  2949                                  ; 14/01/2023
  2950                                  ;ACCDEN:	; 10/01/2023
  2951                                  ;ACCDENIED:	db 14
  2952                                  ;		db 'Access denied '
  2953 00000A3C 0E                      INVHANDLE:	db 14
  2954 00000A3D 496E76616C69642068-     		db 'Invalid handle'
  2954 00000A46 616E646C65         
  2955 00000A4B 1F                      MEMCBDEST:	db 31
  2956 00000A4C 4D656D6F727920636F-     		db 'Memory control blocks destroyed'
  2956 00000A55 6E74726F6C20626C6F-
  2956 00000A5E 636B73206465737472-
  2956 00000A67 6F796564           
  2957 00000A6B 13                      INSUFFMEM:	db 19
  2958 00000A6C 496E73756666696369-     		db 'Insufficient memory'
  2958 00000A75 656E74206D656D6F72-
  2958 00000A7E 79                 
  2959 00000A7F 1C                      INVMEMBLA:	db 28
  2960 00000A80 496E76616C6964206D-     		db 'Invalid memory block address'
  2960 00000A89 656D6F727920626C6F-
  2960 00000A92 636B20616464726573-
  2960 00000A9B 73                 
  2961 00000A9C 13                      INVENVIRO:	db 19
  2962 00000A9D 496E76616C69642045-     		db 'Invalid Environment'
  2962 00000AA6 6E7669726F6E6D656E-
  2962 00000AAF 74                 
  2963 00000AB0 0E                      INVFORMAT:	db 14
  2964 00000AB1 496E76616C69642066-     		db 'Invalid format'
  2964 00000ABA 6F726D6174         
  2965 00000ABF 1A                      INVFNPARM:	db 26
  2966 00000AC0 496E76616C69642066-     		db 'Invalid function parameter'
  2966 00000AC9 756E6374696F6E2070-
  2966 00000AD2 6172616D65746572   
  2967 00000ADA 0C                      INVLDDATA:	db 12
  2968 00000ADB 496E76616C69642064-     		db 'Invalid data'
  2968 00000AE4 617461             
  2969 00000AE7 1B                      INVDRVSPC:	db 27
  2970 00000AE8 496E76616C69642064-     		db 'Invalid drive specification'
  2970 00000AF1 726976652073706563-
  2970 00000AFA 696669636174696F6E 
  2971 00000B03 23                      ATRCURDIR:	db 35
  2972 00000B04 417474656D70742074-     		db 'Attempt to remove current directory'
  2972 00000B0D 6F2072656D6F766520-
  2972 00000B16 63757272656E742064-
  2972 00000B1F 69726563746F7279   
  2973 00000B27 0F                      NOTSAMDEV:	db 15
  2974 00000B28 4E6F742073616D6520-     		db 'Not same device'
  2974 00000B31 646576696365       
  2975 00000B37 0D                      NOMOREFIL:	db 13
  2976 00000B38 4E6F206D6F72652066-     		db 'No more files'
  2976 00000B41 696C6573           
  2977 00000B45 0B                      FILEXISTS:	db 11
  2978 00000B46 46696C652065786973-     		db 'File exists'
  2978 00000B4F 7473               
  2979 00000B51 1B                      CANTMKDIR:	db 27
  2980 00000B52 43616E6E6F74206D61-     		db 'Cannot make directory entry'
  2980 00000B5B 6B6520646972656374-
  2980 00000B64 6F727920656E747279 
  2981 00000B6D 0E                      FAILINT24:	db 14
  2982 00000B6E 4661696C206F6E2049-     		db 'Fail on INT 24'
  2982 00000B77 4E54203234         
  2983 00000B7C 15                      TOOMANYRD:	db 21
  2984 00000B7D 546F6F206D616E7920-     		db 'Too many redirections'
  2984 00000B86 726564697265637469-
  2984 00000B8F 6F6E73             
  2985 00000B92 15                      DUPLREDIR:	db 21
  2986 00000B93 4475706C6963617465-     		db 'Duplicate redirection'
  2986 00000B9C 207265646972656374-
  2986 00000BA5 696F6E             
  2987 00000BA8 10                      INVPASSWD:	db 16
  2988 00000BA9 496E76616C69642070-     		db 'Invalid password'
  2988 00000BB2 617373776F7264     
  2989 00000BB9 11                      INVLDPARM:	db 17
  2990 00000BBA 496E76616C69642070-     		db 'Invalid parameter'
  2990 00000BC3 6172616D65746572   
  2991 00000BCB 12                      NETDATFAU:	db 18
  2992 00000BCC 4E6574776F726B2064-     		db 'Network data fault'
  2992 00000BD5 617461206661756C74 
  2993 00000BDE 21                      FNOSUPNET:	db 33
  2994 00000BDF 46756E6374696F6E20-     		db 'Function not supported by network'
  2994 00000BE8 6E6F7420737570706F-
  2994 00000BF1 72746564206279206E-
  2994 00000BFA 6574776F726B       
  2995 00000C00 27                      RSCNOTINS:	db 39
  2996 00000C01 526571756972656420-     		db 'Required system component not installed'
  2996 00000C0A 73797374656D20636F-
  2996 00000C13 6D706F6E656E74206E-
  2996 00000C1C 6F7420696E7374616C-
  2996 00000C25 6C6564             
  2997                                  
  2998                                  ;; MSDOS 5.0 COMMAND.COM RESGROUP:0C8Ch
  2999                                  ; 05/06/2023
  3000                                  ; MSDOS 6.22 COMMAND.COM RESGROUP:0D8Fh
  3001                                  
  3002                                  ; 19/07/2024
  3003                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0D24h
  3004                                  
  3005 00000C28 [F909]                  EXTMSGPTRS:	dw INVLFUNCT
  3006 00000C2A [0A0A]                  		dw FNOTFOUND
  3007 00000C2C [190A]                  		dw PNOTFOUND
  3008 00000C2E [280A]                  		dw TOOMANYOF
  3009 00000C30 [D006]                  		dw ACCDENIED
  3010 00000C32 [3C0A]                  		dw INVHANDLE
  3011 00000C34 [4B0A]                  		dw MEMCBDEST
  3012 00000C36 [6B0A]                  		dw INSUFFMEM
  3013 00000C38 [7F0A]                  		dw INVMEMBLA
  3014 00000C3A [9C0A]                  		dw INVENVIRO
  3015 00000C3C [B00A]                  		dw INVFORMAT
  3016 00000C3E [BF0A]                  		dw INVFNPARM
  3017 00000C40 [DA0A]                  		dw INVLDDATA
  3018 00000C42 0000                    		dw 0
  3019 00000C44 [E70A]                  		dw INVDRVSPC
  3020 00000C46 [030B]                  		dw ATRCURDIR
  3021 00000C48 [270B]                  		dw NOTSAMDEV
  3022 00000C4A [370B]                  		dw NOMOREFIL
  3023 00000C4C [5807]                  		dw CRMSG0
  3024 00000C4E [6C07]                  		dw CRMSG1
  3025 00000C50 [7907]                  		dw CRMSG2
  3026 00000C52 [8307]                  		dw CRMSG3
  3027 00000C54 [9A07]                  		dw CRMSG4
  3028 00000C56 [A507]                  		dw CRMSG5
  3029 00000C58 [C707]                  		dw CRMSG6
  3030 00000C5A [D207]                  		dw CRMSG7
  3031 00000C5C [E507]                  		dw CRMSG8
  3032 00000C5E [F607]                  		dw CRMSG9
  3033 00000C60 [1108]                  		dw CRMSG10
  3034 00000C62 [2308]                  		dw CRMSG11
  3035 00000C64 [3408]                  		dw CRMSG12
  3036 00000C66 [4408]                  		dw CRMSG13
  3037 00000C68 [5608]                  		dw CRMSG14
  3038 00000C6A [6508]                  		dw CRMSG15
  3039 00000C6C [7908]                  		dw CRMSG16
  3040 00000C6E [8908]                  		dw CRMSG17
  3041 00000C70 [A308]                  		dw CRMSG18
  3042 00000C72 [B608]                  		dw CRMSG19
  3043 00000C74 [C308]                  		dw CRMSG20
  3044 00000C76 0000<rep 28h>           		times 40 dw 0	; db 80 dup(0)
  3045 00000CC6 [450B]                  		dw FILEXISTS
  3046 00000CC8 0000                    		dw 0
  3047 00000CCA [510B]                  		dw CANTMKDIR
  3048 00000CCC [6D0B]                  		dw FAILINT24
  3049 00000CCE [7C0B]                  		dw TOOMANYRD
  3050 00000CD0 [920B]                  		dw DUPLREDIR
  3051 00000CD2 [A80B]                  		dw INVPASSWD
  3052 00000CD4 [B90B]                  		dw INVLDPARM
  3053 00000CD6 [CB0B]                  		dw NETDATFAU
  3054 00000CD8 [DE0B]                  		dw FNOSUPNET
  3055 00000CDA [000C]                  		dw RSCNOTINS
  3056                                  ; ----------------------------------------------------------------------------
  3057                                  	; 17/04/2023
  3058                                  ExtMsgEnd:
  3059                                  
  3060                                  ; 21/04/2023
  3061                                  NUMEXTMSGS equ ($-EXTMSGPTRS)>>1 ; 14/01/2023
  3062                                  
  3063                                  ; ----------------------------------------------------------------------------
  3064                                  ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3065                                  %if 1	;  20/07/2024
  3066 00000CDC 2E                      PATRICIDE:	db 46
  3067 00000CDD 0D0A                    		db 0Dh,0Ah
  3068 00000CDF 546F70206C6576656C-     		db 'Top level process aborted, cannot continue'
  3068 00000CE8 2070726F6365737320-
  3068 00000CF1 61626F727465642C20-
  3068 00000CFA 63616E6E6F7420636F-
  3068 00000D03 6E74696E7565       
  3069 00000D09 0D0A                    		db 0Dh,0Ah
  3070                                  %endif
  3071                                  
  3072                                  ; ----------------------------------------------------------------------------
  3073                                  
  3074                                  ; 20/04/2023
  3075                                  
  3076 00000D0B 90<rep 5h>              align 16
  3077                                  
  3078                                  ; ----------------------------------------------------------------------------
  3079                                  
  3080                                  ; 10/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3081                                  ;; MSDOS 5.0 COMMAND.COM - RESGROUP:0D40h (CODERES:0000h)
  3082                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  3083                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:0E50h (CODERES:0000h)
  3084                                  
  3085                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3086                                  ; PCDOS 7.1 COMMAND.COM RESGROUP:0E10h (CODERES:0000h)
  3087                                  
  3088                                  ; ----------------------------------------------------------------------------
  3089                                  ; SEGMENT - CODERES
  3090                                  ; ----------------------------------------------------------------------------
  3091                                  
  3092                                  ; 11/01/2023
  3093                                  RCODE_START:	
  3094                                  
  3095                                  ; ----------------------------------------------------------------------------
  3096                                  ;***	EXEC error handling
  3097                                  ;
  3098                                  ;	COMMAND has issued an EXEC system call and it has returned an error.
  3099                                  ;	We examine the error code and select an appropriate message.
  3100                                  ; --------------------------
  3101                                  ;	Bugbug:	optimize reg usage in following code? Careful of DX!
  3102                                  ;	Condense the error scan?
  3103                                  ;	RBADNAM is checked by transient, no need here?
  3104                                  ;	Move below Ext_Exec.
  3105                                  ; ----------------------------------------------------------------------------
  3106                                  
  3107                                  Exec_Err:
  3108                                  ;SR;
  3109                                  ; ds,es are setup when the transient jumps to Ext_Exec. So segment regs are
  3110                                  ; in order here
  3111                                  
  3112                                  ;	Bugbug:	can we use byte compares here?
  3113                                  ;	Might be able to use byte msg#s, too.
  3114                                  
  3115                                  ;	Store errors in a 3 or 4 byte table. Msg #s in another.
  3116                                  ;	Speed not high priority here.
  3117                                  
  3118                                  ;	Move this to transient.
  3119                                  
  3120                                  	; 10/01/2023
  3121                                  
  3122                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3123                                  ;if 0	; PCDOS 7.1 COMMAND.COM doesn't use 'RBADNAM' error msg here 
  3124                                  %if 1	; Retro DOS v5.0 COMMAND.COM (and MSDOS 6.22 COMMAND.COM)
  3125                                  	;mov	bx,RBADNAM	; offset DATARES:RBadNam
  3126 00000D10 BA[B506]                	mov	dx,RBADNAM
  3127 00000D13 3C02                    	cmp	al,ERROR_FILE_NOT_FOUND ; 2
  3128 00000D15 741B                    	je	short GotExecEMes		; bad command
  3129                                  %endif
  3130                                  	;mov	bx,TOOBIG	; offset DATARES:TooBig
  3131 00000D17 BA[7B06]                	mov	dx,TOOBIG
  3132 00000D1A 3C08                    	cmp	al,ERROR_NOT_ENOUGH_MEMORY ; 8
  3133 00000D1C 7414                    	je	short GotExecEMes		; file not found
  3134                                  	;mov	bx,EXEBAD	; offset DATARES:ExeBad
  3135 00000D1E BA[6706]                	mov	dx,EXEBAD
  3136 00000D21 3C0B                    	cmp	al,ERROR_BAD_FORMAT ; 11 ; 0Bh
  3137 00000D23 740D                    	je	short GotExecEMes		; bad exe file
  3138                                  	;mov	bx,ACCDEN	; offset DATARES:AccDen
  3139 00000D25 BA[D006]                	mov	dx,ACCDEN
  3140 00000D28 3C05                    	cmp	al,ERROR_ACCESS_DENIED ; 5
  3141 00000D2A 7406                    	je	short GotExecEMes		; access denied
  3142                                  
  3143                                  Default_Message:
  3144                                  	;mov	bx,EXECEMES	; offset DATARES:ExecEMes
  3145 00000D2C BA[5306]                	mov	dx,EXECEMES
  3146                                  						; default message
  3147 00000D2F BE[3002]                	mov	si,ExecErrSubst ; offset DATARES:ExecErrSubst
  3148                                  						; get address of subst block
  3149                                  GotExecEMes:
  3150                                  	;mov	dx,bx				; DX = ptr to msg
  3151 00000D32 E8A606                  	call	RPrint ; invoke	RPrint
  3152 00000D35 EB09                    	jmp	short NoExec
  3153                                  
  3154                                  ; ----------------------------------------------------------------------------
  3155                                  ;***	EXEC call
  3156                                  ;
  3157                                  ;	The transient has set up everything for an EXEC system call.
  3158                                  ;	For cleanliness, we issue the EXEC here in the resident 
  3159                                  ;	so that we may be able to recover cleanly upon success.
  3160                                  ;
  3161                                  ;	CS,DS,ES,SS = DATARES seg addr
  3162                                  ; ----------------------------------------------------------------------------
  3163                                  
  3164                                  Ext_Exec:
  3165                                  ;SR;
  3166                                  ; The words put on the stack by the stub will be popped off when we finally
  3167                                  ;jump to LodCom (by LodCom).
  3168                                  
  3169                                  	; 10/01/2023
  3170                                  	;int	21h			; do the exec
  3171                                  	; 10/01/2023 - MSDOS 5.0 COMMAND.COM - RESGROUP:0D69h (CODERES:0029h)
  3172                                  Exec_Ret:
  3173 00000D37 72D7                    	jc	short Exec_Err		; exec failed
  3174                                  
  3175                                  ;	The exec has completed. Retrieve the exit code.
  3176                                  
  3177                                  Exec_Wait:
  3178 00000D39 B44D                    	mov	ah,4Dh
  3179                                  	;mov	ah,WAITPROCESS ; 4Dh	; get errorlevel
  3180 00000D3B CD21                    	int	21h			; get the return code
  3181                                  	;mov	[cs:RetCode],ax
  3182                                  	; 11/01/2023
  3183 00000D3D A3[9A02]                	mov	[RetCode],ax
  3184                                  
  3185                                  ;	See if we can reload the transient. The external command
  3186                                  ;	may have overwritten part of the transient.
  3187                                  
  3188                                  NoExec:
  3189                                  ;SR;
  3190                                  ; ds = es = ss = DATARES when we jump to LodCom
  3191                                  ;
  3192 00000D40 E97A01                  	jmp	LodCom
  3193                                  
  3194                                  ; ----------------------------------------------------------------------------
  3195                                  ;***	Int 23 (ctrl-c) handler
  3196                                  ;
  3197                                  ;	This is the default system INT 23 handler. All processes
  3198                                  ;	(including COMMAND) get it by default. There are some
  3199                                  ;	games that are played: We ignore ^C during most of the
  3200                                  ;	INIT code. This is because we may perform an ALLOC and
  3201                                  ;	diddle the header! Also, if we are prompting for date/time
  3202                                  ;	in the init code, we are to treat ^C as empty responses.
  3203                                  ; ---------------------------
  3204                                  ;	Bugbug:	put init ctrl-c handling in init module.
  3205                                  ; ----------------------------------------------------------------------------
  3206                                  
  3207                                  ;SR;
  3208                                  ;The stub has pushed the previous ds and DATARES onto the stack. We get
  3209                                  ;both these values off the stack now
  3210                                  ;
  3211                                  ;ContC	proc	far
  3212                                  
  3213                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  3214                                  
  3215                                  	; 11/01/2023 - Retro DOS v5.40 COMMAND.COM
  3216                                  	; MSDOS 5.0 COMMAND.COM RESGROUP:0D75h (CODERES:0035h)
  3217                                  ContC:
  3218 00000D43 1F                      	pop	ds			; ds = DATARES
  3219                                  ;	assume	ds:DATARES
  3220                                  ;;	pop	word [OldDS]		; OldDS = old ds
  3221                                  
  3222 00000D44 F606[1203]01            	test	byte [InitFlag],INITINIT ; 1
  3223                                  	;test	byte [cs:INITFLAG],INITINIT ; 1	; in initialization?
  3224 00000D49 740D                    	jz	short NotAtInit		; no
  3225 00000D4B F606[1203]02            	test	byte [InitFlag],INITSPECIAL ; 2 
  3226                                  	;test	byte [cs:INITFLAG],INITSPECIAL ; 2 ; doing special stuff?
  3227 00000D50 7404                    	jz	short CmdIret		; no, ignore ^C
  3228 00000D52 1F                      	pop	ds			; restore before jumping; M021
  3229                                  	;jmp	RESGROUP:Init_ContC_SpecialCase ; Yes, go handle it
  3230 00000D53 E9E90F                  	jmp	init_contc_specialcase
  3231                                  CmdIret:
  3232                                  ;SR;
  3233                                  ; Restore ds to its previous value
  3234                                  ;
  3235                                  
  3236                                  ;;	mov	ds,[OLdDS]		;
  3237 00000D56 1F                      	pop	ds
  3238 00000D57 CF                      	iret				; yes, ignore the ^C
  3239                                  
  3240                                  NotAtInit:
  3241 00000D58 F606[1203]04            	test	byte [InitFlag],INITCTRLC ; 4
  3242                                  	;test	byte [cs:INITFLAG],INITCTRLC ; 4 ; are we already in a ^C?
  3243 00000D5D 7411                    	jz	short NotInit 		; nope too.
  3244                                  
  3245                                  ;*	We are interrupting ourselves in this ^C handler. We need
  3246                                  ;	to set carry and return to the user sans flags only if the
  3247                                  ;	system call was a 1-12 one. Otherwise, we ignore the ^C.
  3248                                  
  3249                                  	;cmp	ah,1
  3250                                  	;jb	short CmdIret
  3251                                  	; 19/07/2024
  3252 00000D5F 84E4                    	test	ah,ah
  3253 00000D61 74F3                    	jz	short CmdIret
  3254                                  
  3255 00000D63 80FC0C                  	cmp	ah,12
  3256 00000D66 77EE                    	ja	short CmdIret
  3257                                  
  3258 00000D68 1F                      	pop	ds			;restore ds to old value
  3259 00000D69 83C406                  	add	sp,6			; remove int frame
  3260 00000D6C F9                      	stc
  3261                                  
  3262                                  ;;	mov	ds,[OldDS]		;restore ds to its old value
  3263 00000D6D CA0200                  	retf	2			; remove those flags...
  3264                                  
  3265                                  NotInit:
  3266                                  
  3267                                  ;*	We have now received a ^C for some process (maybe ourselves
  3268                                  ;	but not at INIT).
  3269                                  ;	
  3270                                  ;	Note that we are running on the user's stack!!! Bad news if
  3271                                  ;	any of the system calls below go and issue another INT
  3272                                  ;	24... Massive stack overflow! Another bad point is that
  3273                                  ;	SavHand will save an already saved handle, thus losing a
  3274                                  ;	possible redirection...
  3275                                  ;	
  3276                                  ;	All we need to do is set the flag to indicate nested ^C. 
  3277                                  ;	The above code will correctly flag the ^C diring the
  3278                                  ;	message output and prompting while ignoring the ^C the rest
  3279                                  ;	of the time.
  3280                                  ;	
  3281                                  ;	Clean up: flush disk. If we are in the middle of a batch
  3282                                  ;	file, we ask if he wants to terminate it. If he does, then
  3283                                  ;	we turn off all internal flags and let the DOS abort.
  3284                                  
  3285 00000D70 800E[1203]04            	or	byte [InitFlag],INITCTRLC ; 4
  3286                                  	;or	byte [cs:INITFLAG],INITCTRLC ; 4 ; nested ^c is on
  3287 00000D75 FB                      	sti
  3288                                  
  3289                                  ;	push	cs			; el yucko! change the user's ds!!
  3290                                  ;	pop	ds
  3291                                  
  3292                                  ;	assume	ds:RESGROUP
  3293                                  
  3294 00000D76 58                      	pop	ax			; discard the old ds value
  3295                                  
  3296 00000D77 A1[A502]                	mov	ax,[SingleCom]
  3297 00000D7A 09C0                    	or	ax,ax
  3298 00000D7C 7506                    	jnz	short NoReset
  3299 00000D7E 50                      	push	ax
  3300 00000D7F B40D                    	mov	ah,DISK_RESET ; 0Dh
  3301 00000D81 CD21                    	int	21h			; reset disks in case files were open
  3302 00000D83 58                      	pop	ax
  3303                                  
  3304                                  NoReset:
  3305                                  
  3306                                  ;	In the generalized version of FOR, PIPE and BATCH, we would
  3307                                  ;	walk the entire active list and free each segment. Here,
  3308                                  ;	we just free the single batch segment.
  3309                                  
  3310 00000D84 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
  3311 00000D8A 7452                    	jz	short ContCTerm
  3312 00000D8C 09C0                    	or	ax,ax
  3313 00000D8E 754E                    	jnz	short ContCTerm
  3314 00000D90 E89402                  	call	SavHand
  3315 00000D93 E8D903                  	call	AskEnd			; ask if user wants to end batch
  3316                                  
  3317                                  ;	If the carry flag is clear, we do NOT free up the batch file
  3318                                  
  3319 00000D96 7340                    	jnc	short ContBatch
  3320 00000D98 8A0E[9D02]              	mov	cl,[EchoFlag]		; get current echo flag
  3321 00000D9C 53                      	push	bx
  3322                                  
  3323                                  ClearBatch:
  3324 00000D9D 8E06[4902]              	mov	es,[Batch]		; get batch segment
  3325                                  	;mov	di,20h
  3326 00000DA1 8B3E2000                	mov	di,[BATCHSEGMENT.BatFile] ; get offset of batch file name
  3327                                  	; MSDOS 5.0 & MSDOS 6.0 (ES:5)
  3328                                  	;mov	bx,es:BatForPtr		; get old FOR segment
  3329 00000DA5 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:5]
  3330                                  	; MSDOS 3.3 ([ES:4])
  3331                                  	;mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:4] ; get old FOR segment
  3332                                  	;
  3333                                  	; 19/07/2024
  3334                                  	;cmp	bx,0			; is a FOR in progress
  3335                                  	;je	short No_Bat_For	; no - don't deallocate
  3336 00000DAA 85DB                    	test	bx,bx
  3337 00000DAC 7408                    	jz	short No_Bat_For
  3338                                  
  3339 00000DAE 06                      	push	es			;
  3340 00000DAF 8EC3                    	mov	es,bx			; yes - free it up...
  3341 00000DB1 B449                    	mov	ah,49h
  3342                                  	;mov	ah,DEALLOC ; 49h	;
  3343 00000DB3 CD21                    	int	21h			;
  3344 00000DB5 07                      	pop	es			; restore to batch segment
  3345                                  
  3346                                  No_Bat_For:
  3347                                  	;mov	cl,[es:1]
  3348 00000DB6 268A0E0100              	mov	cl,[es:BATCHSEGMENT.BatEchoFlag] ; get old echo flag
  3349                                  	;mov	bx,[es:3]
  3350 00000DBB 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast] ; get old batch segment
  3351 00000DC0 B449                    	mov	ah,49h
  3352                                  	;mov	ah,DEALLOC ; 49h	; free it up...
  3353 00000DC2 CD21                    	int	21h
  3354 00000DC4 891E[4902]              	mov	[Batch],bx		; get ready to deallocate next batch
  3355 00000DC8 FF0E[AE02]              	dec	word [Nest]		; is there another batch file?
  3356 00000DCC 75CF                    	jnz	short ClearBatch	; keep going until no batch file
  3357                                  
  3358                                  ;	We are terminating a batch file; restore the echo status
  3359                                  
  3360                                  ;Shell_Bat_Cont: 			; continue batch for SHELL
  3361 00000DCE 5B                      	pop	bx
  3362 00000DCF 880E[9D02]              	mov	[EchoFlag],cl		; reset echo status
  3363                                  	; 29/05/2018
  3364 00000DD3 C606[1303]00            	mov	byte [PipeFlag],0	; turn off pipeflag
  3365                                  
  3366                                  ContBatch:
  3367 00000DD8 E8FD05                  	call	crlf			; print out crlf before returning
  3368 00000DDB E87302                  	call	RestHand
  3369                                  
  3370                                  ;	Yes, we are terminating. Turn off flags and allow the DOS to abort.
  3371                                  
  3372                                  ContCTerm:
  3373 00000DDE 31C0                    	xor	ax,ax			; indicate no read
  3374 00000DE0 89C5                    	mov	bp,ax
  3375                                  
  3376                                  ;	The following resetting of the state flags is good for the
  3377                                  ;	generalized batch processing.
  3378                                  
  3379 00000DE2 A2[AA02]                	mov	[IfFlag],al		; turn off iffing
  3380 00000DE5 A2[AB02]                	mov	[ForFlag],al		; turn off for processing
  3381 00000DE8 E81C00                  	call	ResPipeOff
  3382 00000DEB 3906[A502]              	cmp	[SingleCom],ax		; see if we need to set SingleCom
  3383 00000DEF 7406                    	jz	short NoSetSing
  3384 00000DF1 C706[A502]FFFF          	mov	word [SingleCom],-1	; cause termination on 
  3385                                  					;  pipe, batch, for
  3386                                  NoSetSing:
  3387                                  
  3388                                  ;	If we are doing an internal command, go through the reload process.
  3389                                  ;	If we are doing an external, let DOS abort the process.
  3390                                  ;	In both cases, we are now done with the ^C processing.
  3391                                  
  3392 00000DF7 8026[1203]FB            	and	byte [InitFlag],~INITCTRLC ; 0FBh
  3393 00000DFC 3806[9902]              	cmp	[ExtCom],al
  3394 00000E00 7503                    	jnz	short DoDAb		; internal ^c
  3395 00000E02 E94701                  	jmp	LodCom1
  3396                                  DoDAb:
  3397 00000E05 F9                      	stc				; tell dos to abort
  3398                                  
  3399                                  ;SR;
  3400                                  ;We dont need to restore ds here because we are forcing DOS to do an abort
  3401                                  ;by setting carry and leaving flags on the stack
  3402                                  
  3403 00000E06 CB                      	retf				; Leave flags on stack
  3404                                  
  3405                                  ;ContC	endp
  3406                                  
  3407                                  ;SR;
  3408                                  ;ds = DATARES on entry. This routine is called from DskErr and LodCom1 and
  3409                                  ;both have ds = DATARES
  3410                                  
  3411                                  	; 11/01/2023
  3412                                  ResPipeOff:
  3413 00000E07 50                      	push	ax
  3414 00000E08 31C0                    	xor	ax,ax
  3415                                  	;xchg	al,[cs:PIPEFLAG]
  3416 00000E0A 8606[1303]              	xchg	al,[PipeFlag]
  3417 00000E0E 08C0                    	or	al,al
  3418 00000E10 7404                    	jz	short NoPipePop
  3419                                  	;shr	byte [cs:ECHOFLAG],1
  3420 00000E12 D02E[9D02]              	shr	byte [EchoFlag],1
  3421                                  NoPipePop:
  3422 00000E16 58                      	pop	ax
  3423 00000E17 C3                      	retn
  3424                                  
  3425                                  ;CODERES ends
  3426                                  
  3427                                  ;=============================================================================
  3428                                  ; COMMAND2.ASM, MSDOS 6.0, 1991
  3429                                  ;=============================================================================
  3430                                  ; 21/09/2018 - Retro DOS v3.0
  3431                                  
  3432                                  ;	title	COMMAND2 - resident code for COMMAND.COM part II
  3433                                  ;	name	COMMAND2
  3434                                  
  3435                                  ;/*
  3436                                  ; *                      Microsoft Confidential
  3437                                  ; *                      Copyright (C) Microsoft Corporation 1991
  3438                                  ; *                      All Rights Reserved.
  3439                                  ; */
  3440                                  
  3441                                  ;
  3442                                  ;	Revision History
  3443                                  ;	================
  3444                                  ;
  3445                                  ; M038	SR  11/5/90	Changed stuff for Novell RPL. These guys cannot
  3446                                  ;			reserve memory by changing int 12h and then give it
  3447                                  ;			back to DOS by changing arenas in autoexec.bat.
  3448                                  ;			This makes command.com reload transient and this
  3449                                  ;			cannot be done at this stage.
  3450                                  ;
  3451                                  
  3452                                  ;CODERES segment public byte
  3453                                  
  3454                                  ;*	If we cannot allocate enough memory for the transient or there
  3455                                  ;	was some other allocation error, we display a message and
  3456                                  ;	then die.
  3457                                  
  3458                                  ;SR;
  3459                                  ; We will have to make sure that at this entry point and at FatalC, 
  3460                                  ;ds = DATARES. All jumps to these points are made from only within this file
  3461                                  ;and so we should be able to do this
  3462                                  
  3463                                  ; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3464                                  ; MSDOS 5.0 COMMAND.COM - RESGROUP:0E4Bh (CODERES:010Bh)
  3465                                  
  3466                                  	;assume	ds:DATARES
  3467                                  BadMemErr:
  3468 00000E18 BA[DE06]                	mov	dx,BMEMMES			; DX = ptr to msg
  3469                                  FatalC:
  3470                                  	; 12/01/2023
  3471                                  ;;	push	cs
  3472                                  ;;	pop	ds
  3473                                  ;;	assume	ds:ResGroup
  3474                                  ;	invoke	RPrint
  3475                                  
  3476                                  	; 12/01/2023
  3477                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3478 00000E1B E8BD05                  	call	RPrint
  3479                                  
  3480                                  	; MSDOS 3.3
  3481                                  	;call	RDISPMSG
  3482                                  
  3483                                  ;	If this is NOT a permanent (top-level) COMMAND, then we exit;
  3484                                  ;	we can't do anything else!
  3485                                  
  3486 00000E1E 803E[A202]00            	cmp	byte [PermCom],0
  3487 00000E23 7410                    	je	short FatalRet
  3488                                  
  3489                                  ;	We are a permanent command. If we are in the process of the
  3490                                  ;	magic interrupt (Singlecom) then exit too.
  3491                                  
  3492 00000E25 833E[A502]00            	cmp	word [SingleCom],0		; if PermCom and SingleCom
  3493 00000E2A 7509                    	jne	short FatalRet			; must take int_2e exit
  3494                                  
  3495                                  ;	Permanent command. We can't do ANYthing except halt.
  3496                                  
  3497 00000E2C BA[F806]                	mov	dx,HALTMES			; DX = ptr to msg
  3498                                  	;invoke	RPrint
  3499                                  	; 12/01/2023	
  3500                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3501 00000E2F E8A905                  	call	RPrint	
  3502                                  	; MSDOS 3.3
  3503                                  	;call	RDISPMSG
  3504 00000E32 FB                      	sti
  3505                                  Stall:
  3506 00000E33 EBFE                    	jmp	short Stall			; crash the system nicely
  3507                                  
  3508                                  FatalRet:
  3509 00000E35 BA[1F07]                	mov	dx,FRETMES			; DX = ptr to msg
  3510                                  	;call	RDISPMSG
  3511                                  	; 12/01/2023	
  3512 00000E38 E8A005                  	call	RPrint	
  3513                                  FatalRet2:
  3514 00000E3B 803E[A202]00            	cmp	byte [PermCom],0		; if we get here and PermCom,
  3515 00000E40 7519                    	jne	short Ret_2e			; must be int_2e
  3516                                  
  3517                                  ;	Bugbug:	this is where we'd want to unhook int 2F, *if* we
  3518                                  ;	were a non-permanent COMMAND that had hooked it! (Just in 
  3519                                  ;	case we decide to do that.)
  3520                                  
  3521 00000E42 A1[3E02]                	mov	ax,[Parent]
  3522                                  	;mov	[16h],ax
  3523 00000E45 A31600                  	mov	[PDB.PARENT_PID],ax	; mov [cs:16h],ax
  3524 00000E48 A1[4002]                	mov	ax,[OldTerm]
  3525                                  	;mov	[0Ah],ax
  3526 00000E4B A30A00                  	mov	[PDB.EXIT],ax		; mov [cs:0Ah],ax
  3527 00000E4E A1[4202]                	mov	ax,[OldTerm+2]
  3528                                  	;mov	[0Ch],ax
  3529 00000E51 A30C00                  	mov	[PDB.EXIT+2],ax 	; mov [cs:0Ch],ax
  3530                                  	;mov	ax,4C00h
  3531                                  	;;mov	ax,(EXIT<<8) ; 4C00h	; return to lower level
  3532                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3533 00000E54 B44C                    	mov	ah,4Ch ; EXIT
  3534 00000E56 A0[9A02]                	mov	al,[RetCode] 
  3535 00000E59 CD21                    	int	21h
  3536                                  Ret_2e:
  3537                                  ;SR;
  3538                                  ; We will ensure that ds = DATARES for all entries to this place
  3539                                  ;
  3540                                  
  3541                                  ;;	push	cs
  3542                                  ;;	pop	ds
  3543                                  ;;	assume	ds:resgroup,es:nothing,ss:nothing
  3544                                    	
  3545                                  ;	assume	ds:DATARES
  3546                                  
  3547                                  	;PUSH	CS
  3548                                  	;POP	DS
  3549                                  
  3550 00000E5B C706[A502]0000          	mov	word [SingleCom],0	; turn off SingleCom
  3551 00000E61 8E06[5804]              	mov	es,[Res_Tpa]
  3552                                  	;mov	ah,49h	; 12/01/2023
  3553 00000E65 B449                    	mov	ah,DEALLOC
  3554 00000E67 CD21                    	int	21h			; free up space used by transient
  3555 00000E69 8B1E[3C02]              	mov	bx,[Save_Pdb]
  3556 00000E6D B450                    	mov	ah,50h
  3557                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  3558 00000E6F CD21                    	int	21h			; current process is user
  3559 00000E71 A1[9A02]                	mov	ax,[RetCode]
  3560 00000E74 803E[9902]00            	cmp	byte [ExtCom],0
  3561 00000E79 7502                    	jne	short GotECode
  3562 00000E7B 31C0                    	xor	ax,ax			; internals always return 0
  3563                                  GotECode:
  3564 00000E7D C606[9902]01            	mov	byte [ExtCom],1		; force external
  3565                                  
  3566                                  ;SR; This is actually returning to the caller. However, the old code had
  3567                                  ;ds = RESGROUP so I guess we can keep ds = DATARES for us.
  3568                                  ;Yes, int 2eh can corrupt all registers so we are ok.
  3569                                  
  3570                                  	; 12/01/2023
  3571 00000E82 FF2E[3802]              	jmp	far [Int_2e_Ret]	; "iret"
  3572                                  
  3573                                  ;***	Int_2e, magic command executer
  3574                                  
  3575                                  Int_2e:
  3576                                  	;assume	ds:NOTHING,es:NOTHING,ss:NOTHING
  3577                                  ;SR;
  3578                                  ;We are going to come here from the stub with the old ds and DATARES value
  3579                                  ;pushed on the stack in that order. Pick up this stuff off the stack
  3580                                  
  3581                                  	; 12/01/2023 - Retro DOS v4.0 COMMAND.COM
  3582                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0EB7h (CODERES:0177h)
  3583                                  
  3584 00000E86 1F                      	pop	ds			; ds = DATARES
  3585                                  	;assume	ds:DATARES
  3586 00000E87 58                      	pop	ax
  3587                                  ;	;pop	ds:OldDS 		; Save old value of ds
  3588                                  
  3589                                  	;pop	word [cs:Int_2e_Ret]
  3590                                  	;pop	word [cs:Int_2e_Ret+2]	; store return address
  3591                                  	;pop	ax			; chuck flags
  3592 00000E88 8F06[3802]              	pop	word [Int_2e_Ret]
  3593 00000E8C 8F06[3A02]              	pop	word [Int_2e_Ret+2]
  3594                                  	
  3595 00000E90 83C402                  	add	sp,2
  3596                                  
  3597                                  ;;	push	cs
  3598                                  ;;	pop	es
  3599                                  
  3600 00000E93 1E                      	push	ds
  3601 00000E94 07                      	pop	es			; es = DATARES
  3602                                  ;	;mov	ds,OldDS
  3603 00000E95 8ED8                    	mov	ds,ax
  3604                                  	;assume	ds:nothing		; ds = old value
  3605                                  
  3606 00000E97 BF8000                  	mov	di,80h
  3607 00000E9A B94000                  	mov	cx,64
  3608                                  ;	Bugbug:	cld
  3609 00000E9D F3A5                    	rep	movsw
  3610 00000E9F B451                    	mov	ah,51h
  3611                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  3612 00000EA1 CD21                    	int	21h			; get user's header
  3613                                  	; 12/01/2023
  3614 00000EA3 26891E[3C02]            	mov	[es:Save_Pdb],bx
  3615                                  	;mov	[cs:Save_Pdb],bx
  3616 00000EA8 B450                    	mov	ah,50h
  3617                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  3618                                  
  3619                                  ;;	mov	bx,cs
  3620                                  ;SR;
  3621                                  ;Set ds = DATARES because BadMemErr expects this
  3622                                  
  3623                                  	; 12/01/2023
  3624 00000EAA 06                      	push	es
  3625 00000EAB 1F                      	pop	ds
  3626                                  	;assume	ds:DATARES
  3627                                  
  3628 00000EAC 8CDB                    	mov	bx,ds			; es = our PSP now
  3629                                  	;mov	bx,cs
  3630                                  
  3631 00000EAE CD21                    	int	21h			; current process is me
  3632                                  	;mov	word [cs:SingleCom],81h
  3633                                  	;mov	byte [cs:ExtCom],1	; make sure this case forced
  3634                                  	; 12/01/2023
  3635 00000EB0 C706[A502]8100          	mov	word [SingleCom],81h
  3636 00000EB6 C606[9902]01            	mov	byte [ExtCom],1		; make sure this case forced
  3637                                  
  3638                                  ;SR;
  3639                                  ;We can enter LodCom directly after a command shell is terminated or we
  3640                                  ;can fall thru from above. When we enter directly from the stub, the stack
  3641                                  ;has the old ds value and the data seg value on the stack, so that ds can
  3642                                  ;be properly set. To fake this, we push dummy values here.
  3643                                  
  3644                                  	; 12/01/2023
  3645 00000EBB 1E                      	push	ds			; old value of ds
  3646 00000EBC 1E                      	push	ds			; data seg value, ds = DATARES
  3647                                  LodCom: 				; termination handler
  3648 00000EBD 1F                      	pop	ds			; ds = DATARES
  3649                                  	;assume	ds:DATARES
  3650 00000EBE 83C402                  	add	sp,2
  3651                                  ;	;pop	OldDS			; store old ds
  3652                                  	;cmp	ExtCom,0
  3653 00000EC1 803E[9902]00            	cmp	byte [ExtCom],0
  3654                                  	;cmp	byte [cs:ExtCom],0
  3655                                  	;jne	short @f	 	; internal cmd - memory allocated
  3656                                  	; 16/04/2023
  3657 00000EC6 7503                    	jne	short LodCom0 ; 24/09/2018
  3658 00000EC8 E98100                  	jmp	LodCom1
  3659                                  	;je	short LodCom1 ; 25/09/2018	
  3660                                  ;@@:
  3661                                  LodCom0: ; 24/09/2018
  3662 00000ECB BBFFFF                  	mov	bx,0FFFFh
  3663 00000ECE B448                    	mov	ah,48h	; 12/01/2023
  3664                                  	;mov	ah,ALLOC ; 48h	
  3665 00000ED0 CD21                    	int	21h		; DOS - 2+ - ALLOCATE MEMORY
  3666                                  				; BX = number of 16-byte paragraphs desired
  3667 00000ED2 E80A00                  	call	SetSize
  3668 00000ED5 83C020                  	add	ax,20h
  3669 00000ED8 39C3                    	cmp	bx,ax
  3670 00000EDA 730B                    	jnb	short MemOk		; > 512 byte buffer - good enough
  3671                                  BadMemErrJ:
  3672 00000EDC E939FF                  	jmp	BadMemErr		; not enough memory
  3673                                  
  3674                                  ;***	SetSize - get transient size in paragraphs
  3675                                  
  3676                                  SetSize:
  3677                                  	; 12/01/2023
  3678                                  	;;;mov	ax,offset TRANGROUP:TranSpaceEnd + 15
  3679                                  	;;mov	ax,98D4h		; MSDOS 5.0 COMMAND.COM
  3680                                  	; 05/06/2023
  3681                                  	;mov	ax,0AFA4h		; MSDOS 6.22 COMMAND.COM
  3682 00000EDF B87AA6                  	mov	ax,TRANSPACEEND+15	; mov AX,4D6Bh ; MSDOS 3.3
  3683 00000EE2 B104                    	mov	cl,4
  3684 00000EE4 D3E8                    	shr	ax,cl
  3685 00000EE6 C3                      	retn
  3686                                  
  3687                                  MemOk:
  3688                                  	;assume	ds:DATARES		;we have set ds = DATARES 
  3689                                  
  3690 00000EE7 B448                    	mov	ah,48h
  3691                                  	;mov	ah,ALLOC  ; 48h
  3692 00000EE9 CD21                    	int	21h
  3693 00000EEB 72EF                    	jc	short BadMemErrJ	; memory arenas probably trashed
  3694                                  	;mov	byte [cs:ExtCom],0
  3695                                  	;mov	[cs:Res_Tpa],ax
  3696                                  	; 12/01/2023
  3697 00000EED C606[9902]00            	mov	byte [ExtCom],0		; flag not to alloc again
  3698 00000EF2 A3[5804]                	mov	[Res_Tpa],ax		; save current tpa segment
  3699                                  
  3700 00000EF5 2500F0                  	and	ax,0F000h
  3701 00000EF8 050010                  	add	ax,1000h		; round up to next 64k boundary
  3702 00000EFB 7212                    	jc	short Bad_Tpa		; memory wrap if carry set
  3703                                  
  3704                                  ;	Make sure that new boundary is within allocated range
  3705                                  
  3706                                  	;mov	dx,[cs:Res_Tpa]
  3707                                  	; 12/01/2023
  3708 00000EFD 8B16[5804]              	mov	dx,[Res_Tpa]
  3709 00000F01 01DA                    	add	dx,bx			; compute maximum address
  3710 00000F03 39C2                    	cmp	dx,ax			; is 64k address out of range?
  3711 00000F05 7608                    	jbe	short Bad_Tpa
  3712                                  
  3713                                  ;	Must have 64K of usable space.
  3714                                  
  3715 00000F07 29C2                    	sub	dx,ax			; compute the usable space
  3716 00000F09 81FA0010                	cmp	dx,1000h		; is space >= 64k ?
  3717 00000F0D 7303                    	jae	short LTpaSet
  3718                                  Bad_Tpa:
  3719                                  	;mov	ax,[cs:Res_Tpa]
  3720                                  	; 12/01/2023
  3721 00000F0F A1[5804]                	mov	ax,[Res_Tpa]
  3722                                  LTpaSet:
  3723                                  	;mov	[cs:LTPA],ax
  3724                                  	;mov	ax,[cs:Res_Tpa]
  3725                                  	; 12/01/2023
  3726 00000F12 A3[4C04]                	mov	[LTpa],ax		; usable tpa is 64k buffer aligned
  3727 00000F15 A1[5804]                	mov	ax,[Res_Tpa]		; actual tpa is buffer allocated
  3728 00000F18 01C3                    	add	bx,ax
  3729                                  	;mov	[cs:MemSiz],bx
  3730 00000F1A 891E[9502]              	mov	[MemSiz],bx
  3731 00000F1E E8BEFF                  	call	SetSize
  3732 00000F21 29C3                    	sub	bx,ax
  3733                                  
  3734                                  	; MSDOS 6.0
  3735                                  
  3736                                  ;M038; Start of changes
  3737                                  ;Changes for Novell RPL. These guys reserve memory for themselves by
  3738                                  ;reducing int 12h size and add this memory to the system at autoexec time by
  3739                                  ;running a program that changes arenas. This changes the largest block that
  3740                                  ;command.com gets and so changes the transient segment. So, command.com does
  3741                                  ;a checksum at the wrong address and thinks that the transient is destroyed
  3742                                  ;and tries to reload it. At this point, no Comspec is defined and so the
  3743                                  ;reload fails, hanging the system. To get around this we just copy the
  3744                                  ;transient from the previous address to the new address(if changed) and
  3745                                  ;then let command.com do the checksum. So, if the transient area is not
  3746                                  ;corrupted, there will not be any reload. In Novell's case, the transient
  3747                                  ;is not really corrupted and so this should work.
  3748                                  
  3749                                  	; 12/01/2023
  3750                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:0F5Ah (CODERES:021Ah)
  3751                                  
  3752 00000F23 3B1E[8F02]              	cmp	bx,[TrnSeg]		; Segment still the same?
  3753 00000F27 7423                    	je	short LodCom1		; yes, dont copy
  3754                                  
  3755                                  ;Check if the new segment is above or below the current move. If the new
  3756                                  ;segment is above (i.e new block is larger than previous block), then we
  3757                                  ;have to move in the reverse direction
  3758                                  
  3759                                  	;;mov	cx,98C5h
  3760                                  	; 05/06/2023
  3761                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:106Ah (CODERES:021Ah)
  3762                                  	;mov	cx,0AF95h
  3763                                  	;;mov	cx,0AA9Ah ; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  3764 00000F29 B96BA6                  	mov	cx,TRANSPACEEND		; cx = length to move
  3765 00000F2C 7707                    	ja	short mov_down		; new seg > old seg, reverse move
  3766 00000F2E 31F6                    	xor	si,si			; normal move
  3767 00000F30 89F7                    	mov	di,si
  3768 00000F32 FC                      	cld
  3769 00000F33 EB06                    	jmp	short copy_trans
  3770                                  mov_down:
  3771 00000F35 89CE                    	mov	si,cx			; reverse move, start from end
  3772 00000F37 4E                      	dec	si
  3773 00000F38 89F7                    	mov	di,si
  3774 00000F3A FD                      	std
  3775                                  copy_trans:
  3776 00000F3B 1E                      	push	ds
  3777 00000F3C 06                      	push	es
  3778 00000F3D 8EC3                    	mov	es,bx			; dest segment
  3779 00000F3F 8E1E[8F02]              	mov	ds,[TrnSeg]		; source segment
  3780                                  	;assume	ds:nothing
  3781                                  
  3782 00000F43 F3A4                    	rep	movsb			; copy transient
  3783 00000F45 FC                      	cld
  3784 00000F46 07                      	pop	es
  3785 00000F47 1F                      	pop	ds
  3786                                  	;assume	ds:DATARES
  3787                                  
  3788                                  ;M038; End of changes
  3789                                  
  3790                                  	;mov	[cs:TrnSeg],bx		; new location of transient
  3791                                  	; 12/01/2023
  3792 00000F48 891E[8F02]              	mov	[TrnSeg],bx
  3793                                  
  3794                                  LodCom1:
  3795                                  ;;	mov	ax,cs
  3796                                  ;;	mov	ss,ax
  3797                                  ;SR; At this point ds = DATARES which is where the stack is located
  3798                                  
  3799                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  3800                                  	; MSDOS 5.0 (& MSDOS 6.0-6.22)
  3801 00000F4C 8CD8                    	mov	ax,ds
  3802 00000F4E 8ED0                    	mov	ss,ax
  3803                                  	;assume	ss:DATARES
  3804                                  	;;;mov	sp,offset DATARES:RStack
  3805                                  	;;mov	sp,53Eh
  3806                                  	; 05/06/2023
  3807                                  	;;mov	sp,60Ah ; MSDOS 6.22 COMMAND.COM
  3808                                  	;mov	sp,637h ; PCDOS 7.1 COMMAND.COM ; 19/07/2024
  3809 00000F50 BC[2E05]                	mov	sp,RStack
  3810                                  
  3811                                  ;;	mov	ds,ax
  3812                                  
  3813                                  	;assume	ds:DATARES
  3814                                  	
  3815                                  	; MSDOS 3.3
  3816                                  	;mov	ax,cs
  3817                                  	;mov	ss,ax
  3818                                  	;mov	sp,RSTACK
  3819                                  	;mov	ds,ax
  3820                                  
  3821 00000F53 E88500                  	call	HeadFix			; close files, restore stdin, stdout
  3822 00000F56 31ED                    	xor	bp,bp			; flag command ok
  3823 00000F58 B8FFFF                  	mov	ax,-1
  3824 00000F5B 8706[A702]              	xchg	ax,[VerVal]
  3825 00000F5F 83F8FF                  	cmp	ax,-1
  3826 00000F62 7404                    	je	short NoSetVer
  3827 00000F64 B42E                    	mov	ah,2Eh
  3828                                  	;mov	ah,SET_VERIFY_ON_WRITE ; 2Eh ; AL has correct value
  3829 00000F66 CD21                    	int	21h 		; DOS - SET VERIFY FLAG
  3830                                  				; DL = 00h, AL = 01h VERIFY on / 00h VERIFY off
  3831                                  NoSetVer:
  3832 00000F68 833E[A502]FF            	cmp	word [SingleCom],-1
  3833 00000F6D 7503                    	jne	short NoSng
  3834 00000F6F E9C9FE                  	jmp	FatalRet2		; we have finished the single command
  3835                                  NoSng:
  3836 00000F72 E88101                  	call	ChkSum			; check the transient
  3837                                  	;cmp	dx,[Sum]
  3838                                  	;je	short HavCom		; transient ok
  3839                                  
  3840                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3841                                  %if 0
  3842                                  	; 12/01/2023
  3843                                  	jz	short HavCom
  3844                                  
  3845                                  %else	; PCDOS 7.1 COMMAND.COM
  3846 00000F75 7505                    	jnz	short Bogus_Com
  3847 00000F77 E8A701                  	call	chk_transient
  3848 00000F7A 7417                    	jz	short HavCom
  3849                                  %endif
  3850                                  
  3851                                  Bogus_Com:
  3852 00000F7C C606[4802]01            	mov	byte [Loading],1	; flag DskErr routine
  3853 00000F81 E82801                  	call	LoadCom
  3854                                  ChkSame:
  3855 00000F84 E86F01                  	call	ChkSum
  3856                                  	;cmp	dx,[Sum]
  3857                                  	;je	short HavCom		; same command
  3858                                  
  3859                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3860                                  %if 0
  3861                                  	; 12/01/2023
  3862                                  	jz	short HavCom
  3863                                  
  3864                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  3865                                  %else	; PCDOS 7.1 COMMAND.COM
  3866 00000F87 7505                    	jnz	short Also_Bogus
  3867 00000F89 E89501                  	call	chk_transient
  3868 00000F8C 7405                    	jz	short HavCom
  3869                                  %endif
  3870                                  Also_Bogus:
  3871 00000F8E E85D01                  	call	WrongCom
  3872 00000F91 EBF1                    	jmp	short ChkSame
  3873                                  
  3874                                  	; 12/01/2023
  3875                                  ;HavCom:
  3876                                  ;	; 25/09/2018
  3877                                  ;	mov     ax,(CHAR_OPER*256) ; 3700h
  3878                                  ;	int     21h	; DOS - 2+ internal - GET SWITCHAR/AVAILDEV
  3879                                  ;			; Return: AL = FFh unsupported subfunction
  3880                                  ;			; DL = current switch character
  3881                                  ;	mov     [RSWITCHAR],dl
  3882                                  ;	cmp     dl,'/'
  3883                                  ;	jnz     short USESLASH
  3884                                  ;	;mov	cl,'\'
  3885                                  ;	;mov	[RDIRCHAR],cl
  3886                                  ;	mov	byte [RDIRCHAR],'\'
  3887                                  ;USESLASH:
  3888                                  
  3889                                  HavCom:
  3890                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM	
  3891 00000F93 C606[4802]00            	mov	byte [Loading],0		; flag to DskErr
  3892                                  	;;;mov	si,offset DATARES:TranVars
  3893                                  	;;mov	si,453h		; MSDOS 5.0 COMMAND.COM
  3894                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  3895                                  	;mov	si,51Dh		; MSDOS 6.22 COMMAND.COM
  3896                                  	; 19/07/2024
  3897                                  	;mov	si,551h		; PCDOS 7.1 COMMAND.COM
  3898 00000F98 BE[4804]                	mov	si,TranVars
  3899                                  	;;;mov	di,offset TRANGROUP:HeadCall
  3900                                  	;;mov	di,8D75h	; MSDOS 5.0 COMMAND.COM
  3901                                  	; 05/06/2023
  3902                                  	;mov	di,0A303h	; MSDOS 6.22 COMMAND.COM
  3903                                  	; 19/07/2024
  3904                                  	;mov	di,0A082h	; PCDOS 7.1 COMMAND.COM
  3905 00000F9B BF[519C]                	mov	di,HEADCALL
  3906 00000F9E 8E06[8F02]              	mov	es,[TrnSeg]
  3907 00000FA2 FC                      	cld
  3908                                  	;;;mov	cx,467h		; MSDOS 5.0 COMMAND.COM	
  3909                                  	;;mov	cx,533h		; MSDOS 6.22 COMMAND.COM	
  3910                                  	;mov	cx,565h		; PCDOS 7.1 COMMAND.COM
  3911 00000FA3 B9[5C04]                	mov	cx,TranVarEnd
  3912 00000FA6 29F1                    	sub	cx,si
  3913 00000FA8 F3A4                    	rep	movsb			; transfer info to transient
  3914 00000FAA A1[9502]                	mov	ax,[MemSiz]
  3915 00000FAD A30200                  	mov	[PDB.BLOCK_LEN],ax ; mov [ds:2],ax ; adjust my own header
  3916                                  
  3917                                  ;***	TJmp - jump-off to transient
  3918                                  ;
  3919                                  ;	Public label so debugger can find this spot.
  3920                                  
  3921                                  TJmp:	; 12/01/2023
  3922 00000FB0 FF2E[8D02]              	jmp	far [Trans]		; jmp dword ptr Trans
  3923                                  
  3924                                  ;***	TRemCheck - far version of RemCheck for transient
  3925                                  
  3926                                  TRemCheck:
  3927                                  	; 12/01/2023
  3928 00000FB4 1F                      	pop	ds			; ds = DATARES
  3929 00000FB5 83C402                  	add	sp,2			; discard old value of ds
  3930                                  
  3931 00000FB8 E80100                  	call	RemCheck
  3932 00000FBB CB                      	retf
  3933                                  
  3934                                  ;***	RemCheck
  3935                                  ;
  3936                                  ;	ENTRY	AL = drive (0=default, 1=A, ...)
  3937                                  ;
  3938                                  ;	EXIT	ZR set if removeable media
  3939                                  ;		ZR clear if fixed media
  3940                                  ;
  3941                                  ;	USED	none
  3942                                  
  3943                                  	; 12/01/2023
  3944                                  RemCheck:
  3945 00000FBC 50                      	push	ax
  3946 00000FBD 53                      	push	bx
  3947 00000FBE 89C3                    	mov	bx,ax
  3948 00000FC0 B80844                  	mov	ax,4408h
  3949                                  	;mov	ax,(IOCTL<<8)+8 ; 4408h
  3950 00000FC3 CD21                    	int	21h		; DOS - 2+ - IOCTL -
  3951 00000FC5 7304                    	jnc	short rcCont		
  3952                                  
  3953                                  ;	If an error occurred, assume the media is non-removable.
  3954                                  ;	AX contains the non-zero error code from the int 21, so
  3955                                  ;	'or ax,ax; sets non-zero. This behavior makes network drives
  3956                                  ;	appear to be non-removable.				
  3957                                  					
  3958 00000FC7 09C0                    	or	ax,ax			
  3959 00000FC9 EB05                    	jmp	short ResRegs
  3960                                  rcCont:
  3961 00000FCB 83E001                  	and	ax,1
  3962 00000FCE F7D0                    	not	ax
  3963                                  ResRegs:
  3964 00000FD0 5B                      	pop	bx
  3965 00000FD1 58                      	pop	ax
  3966 00000FD2 C3                      	retn
  3967                                  
  3968                                  ;***	THeadFix
  3969                                  ;
  3970                                  ;	Far version of HeadFix, called from transient.
  3971                                  
  3972                                  THeadFix:
  3973                                  	; 12/01/2023
  3974 00000FD3 1F                      	pop	ds			; ds = DATARES
  3975 00000FD4 83C402                  	add	sp,2			; discard old ds value on stack
  3976                                  
  3977 00000FD7 E80100                  	call	HeadFix
  3978 00000FDA CB                      	retf
  3979                                  
  3980                                  ;***	HeadFix
  3981                                  
  3982                                  	; 12/01/2023
  3983                                  HeadFix:
  3984 00000FDB E85001                  	call	SetVect			; set vectors to our values
  3985                                  
  3986                                  ;	Clean up header
  3987                                  
  3988                                  ;	Bugbug:	optimize:
  3989                                  ;	mov	word ptr ds:Pdb_Jfn_Table,cx  instead of separate bytes
  3990                                  
  3991 00000FDE 31DB                    	xor	bx,bx			; BX = handle = 0
  3992 00000FE0 8B0E[9F02]              	mov	cx,[Io_Save]		; CX = original stdin, stdout
  3993                                  	;mov	dx,[18h] 
  3994 00000FE4 8B161800                	mov	dx,[PDB.JFN_TABLE]	; DX = current stdin, stdout
  3995 00000FE8 38D1                    	cmp	cl,dl
  3996 00000FEA 7407                    	je	short Chk1		; stdin matches
  3997                                  
  3998                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  3999                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4000                                  	mov	ah,3Eh
  4001                                  	;mov	ah,CLOSE  ; 3Eh
  4002                                  	int	21h			; close stdin
  4003                                  %else
  4004                                  	;mov	ah,3Eh
  4005                                  	;call	int21h
  4006                                  	; 19/07/2024
  4007 00000FEC E86E01                  	call	int21h_close
  4008                                  %endif
  4009                                  	;mov	[18h],cl
  4010 00000FEF 880E1800                	mov	[PDB.JFN_TABLE],cl	; restore stdin
  4011                                  Chk1:
  4012 00000FF3 43                      	inc	bx			; BX = handle = 1
  4013 00000FF4 38F5                    	cmp	ch,dh			
  4014 00000FF6 7407                    	je	short ChkOtherHand	; stdout matches
  4015                                  
  4016                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4017                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4018                                  	mov	ah,3Eh
  4019                                  	;mov	ah,CLOSE  ; 3Eh
  4020                                  	int	21h			; close stdout
  4021                                  %else
  4022                                  	;mov	ah,3Eh
  4023                                  	;call	int21h
  4024                                  	; 19/07/2024
  4025 00000FF8 E86201                  	call	int21h_close
  4026                                  %endif
  4027                                  	;mov	[19h],ch
  4028 00000FFB 882E1900                	mov	[PDB.JFN_TABLE+1],ch	; restore stdout
  4029                                  ChkOtherHand:
  4030 00000FFF 83C304                  	add	bx,4			; skip handles 2,3,4
  4031 00001002 B90F00                  	mov	cx,FILPERPROC-5	; 15	; CX = # handles to close
  4032                                  					; (handles 0-4 already done)
  4033                                  CloseLoop:
  4034                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4035                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4036                                  	mov	ah,3Eh
  4037                                  	;mov	ah,CLOSE  ; 3Eh
  4038                                  	int	21h			; close file
  4039                                  %else
  4040                                  	;cmp	byte [bx+18h],0FFh
  4041 00001005 807F18FF                	cmp	byte [bx+PDB.JFN_TABLE],0FFh
  4042 00001009 7403                    	je	short CloseLoopNxt
  4043                                  
  4044                                  	;mov	ah,3Eh
  4045                                  	;call	int21h
  4046                                  	; 19/07/2024
  4047 0000100B E84F01                  	call	int21h_close
  4048                                  CloseLoopNxt:
  4049                                  %endif
  4050 0000100E 43                      	inc	bx			; BX = next handle
  4051 0000100F E2F4                    	loop	CloseLoop
  4052                                  
  4053                                  	; MSDOS 6.0
  4054                                  ;	Bugbug:	since this is for transient code, move it there
  4055                                  	
  4056                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4057                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:103Dh)
  4058                                  	; 19/07/2024
  4059                                  	; (PCDOS 7.1 COMMAND.COM - RESGROUP:1119h)
  4060                                  
  4061                                  ;	M012: remove this CS -> DS. Must've been missed during
  4062                                  ;	purification.
  4063                                  ;;	push	ds			; save data segment
  4064                                  ;;	push	cs			; get local segment into DS
  4065                                  ;;	pop	ds			;
  4066 00001011 803E[C002]FF            	cmp	byte [Append_Flag],-1	; do we need to reset APPEND?
  4067 00001016 750E                    	jne	short Append_Fix_End	; no - just exit
  4068 00001018 B807B7                  	mov	ax,0B707h
  4069                                  	;mov	ax,AppendSetState	; set the state of Append
  4070 0000101B 8B1E[BE02]              	mov	bx,[Append_State] 	; back to the original state
  4071 0000101F CD2F                    	int	2Fh			;
  4072 00001021 C606[C002]00            	mov	byte [Append_Flag],0	; set append flag to invalid
  4073                                  Append_Fix_End: 			;
  4074                                  ;;	pop	ds			; get data segment back
  4075 00001026 C3                      	retn
  4076                                  
  4077                                  	; MSDOS 3.3
  4078                                  	;retn
  4079                                  
  4080                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4081                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:112Fh
  4082                                  
  4083                                  ;***	SavHand - save current program's stdin/out & set to our stderr
  4084                                  ;
  4085                                  ;	ENTRY	nothing
  4086                                  ;
  4087                                  ;	EXIT	nothing
  4088                                  ;
  4089                                  ;	USED	flags
  4090                                  ;
  4091                                  ;	EFFECTS
  4092                                  ;	  Handle01 = current program's stdin,stdout JFN entries
  4093                                  ;	  current program's stdin,stdout set to our stderr
  4094                                  ;
  4095                                  
  4096                                  ;SR;
  4097                                  ; Changed ds = DATARES. We need it to access our JFN_Table
  4098                                  ; Called from ContC ( ds = DATARES ) and DskErr ( ds = DATARES ).
  4099                                  
  4100                                  SavHand:
  4101                                  	;assume	ds:DATARES,es:NOTHING,ss:NOTHING
  4102                                  
  4103                                  	; 12/01/2023
  4104                                  	;push	ds ; MSDOS 3.3
  4105                                  
  4106 00001027 53                      	push	bx			;preserve registers
  4107 00001028 50                      	push	ax
  4108                                  	; 12/01/2023
  4109 00001029 06                      	push	es
  4110 0000102A 1E                      	push	ds			; save DATARES value
  4111                                  
  4112 0000102B B451                    	mov	ah,51h
  4113                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  4114                                  
  4115                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4116                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4117                                  	int	21h			; BX = user's header seg addr
  4118                                  %else
  4119 0000102D E82F01                  	call	int21h
  4120                                  %endif
  4121 00001030 8EDB                    	mov	ds,bx			; DS = user's header seg addr
  4122                                  	;lds	bx,[34h]	
  4123 00001032 C51E3400                	lds	bx,[PDB.JFN_Pointer]	; DS:BX = ptr to JFN table
  4124 00001036 8B07                    	mov	ax,[bx]			; AX = stdin,stdout JFN's
  4125                                  	; 12/01/2023
  4126 00001038 07                      	pop	es			; es = DATARES
  4127 00001039 06                      	push	es			; save it back on stack
  4128 0000103A 26A3[4602]              	mov	[es:Handle01],ax	; save user's stdin, stdout
  4129                                  	;mov	[cs:HANDLE01],ax
  4130                                  
  4131                                  ;SR;
  4132                                  ; Use es to address Handle01 & our JFN_Table
  4133                                  
  4134                                  	; 12/01/2023
  4135                                  	;mov	al,[es:1Ah]
  4136 0000103E 26A01A00                	mov	al,[es:PDB.JFN_TABLE+2] ; AL = COMMAND stderr
  4137                                  	;mov	al,[cs:PDB.JFN_TABLE+2] ; mov al,[cs:1Ah]
  4138 00001042 88C4                    	mov	ah,al			; AH = COMMAND stderr
  4139 00001044 8907                    	mov	[bx],ax			; set user's stdin/out to our stderr
  4140                                  	; 12/01/2023
  4141 00001046 1F                      	pop	ds			; restore registers
  4142 00001047 07                      	pop	es
  4143 00001048 58                      	pop	ax
  4144 00001049 5B                      	pop	bx
  4145                                  	;pop	ds ; MSDOS 3.3
  4146 0000104A C3                      	retn
  4147                                  
  4148                                  	;assume	ds:DATARES
  4149                                  GetComDsk2:
  4150 0000104B E81F00                  	call	GetComDsk
  4151 0000104E E9FBFE                  	jmp	LodCom1			; memory already allocated
  4152                                  
  4153                                  RestHand:
  4154 00001051 1E                      	push	ds
  4155 00001052 53                      	push	bx			; restore stdin, stdout to user
  4156 00001053 50                      	push	ax
  4157                                  	; 12/01/2023
  4158 00001054 B451                    	mov	ah,51h
  4159                                  	;mov	ah,GET_CURRENT_PDB ; 51h
  4160 00001056 CD21                    	int	21h			; point to user's header
  4161 00001058 A1[4602]                	mov	ax,[Handle01]
  4162 0000105B 8EDB                    	mov	ds,bx
  4163                                  	;assume ds:NOTHING
  4164                                  	;lds	bx,[34h] 
  4165 0000105D C51E3400                	lds	bx,[PDB.JFN_Pointer]	; DS:BX = ptr to jfn table
  4166 00001061 8907                    	mov	[bx],ax			; stuff his old 0 and 1
  4167 00001063 58                      	pop	ax
  4168 00001064 5B                      	pop	bx
  4169 00001065 1F                      	pop	ds
  4170 00001066 C3                      	retn
  4171                                  
  4172                                  	;assume ds:DATARES,ss:DATARES
  4173                                  Hopeless:
  4174 00001067 BA[DC05]                	mov	dx,COMBAD
  4175 0000106A E9AEFD                  	jmp	FatalC
  4176                                  
  4177                                  GetComDsk:
  4178 0000106D A0[9402]                	mov	al,[ComDrv]
  4179 00001070 E849FF                  	call	RemCheck
  4180 00001073 75F2                    	jnz	short Hopeless		; non-removable media
  4181                                  GetComDsk3:
  4182 00001075 81FA[DC05]              	cmp	dx,COMBAD		; cmp dx,offset DATARES:ComBad
  4183 00001079 7503                    	jne	short GetComDsk4
  4184                                  	;;mov	dx,offset DATARES:ComBad ; DX = ptr to msg
  4185                                  	; 12/01/2023
  4186                                  	;;mov	dx,COMBAD ; (MSDOS 5.0 COMMAND.COM - RESGROUP:10A6h)
  4187                                  	; 05/06/2023
  4188                                  	;mov	dx,COMBAD ; (MSDOS 6.22 COMMAND.COM - RESGROUP:11B6h)
  4189                                  	;invoke	RPrint			; say COMMAND is invalid
  4190 0000107B E85D03                  	call	RPrint
  4191                                  	;call	RDISPMSG
  4192                                  
  4193                                  GetComDsk4:
  4194                                  
  4195                                  ;	Bugbug:	there's always a drive here? No need to check?
  4196                                  
  4197 0000107E 803E[2F02]00            	cmp	byte [PutBackDrv],0	; is there a drive in the comspec?
  4198 00001083 750A                    	jne	short Users_Drive	; yes - use it
  4199 00001085 B419                    	mov	ah,19h
  4200                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h ; use default drive
  4201                                  
  4202                                  ; 19/07/2024 - Retro DOS v5 COMMAND.COM
  4203                                  %if 0	; PCDOS 7.1 COMMAND.COM
  4204                                  	int	21h			; BX = user's header seg addr
  4205                                  %else
  4206 00001087 E8D500                  	call	int21h
  4207                                  %endif
  4208 0000108A 0441                    	add	al,"A"                  ; convert to ascii
  4209 0000108C A2[2F02]                	mov	[PutBackDrv],al		; put in message to print out
  4210                                  
  4211                                  Users_Drive:
  4212                                  	; 12/01/2023
  4213                                  	; MSDOS 6.0
  4214 0000108F BA[F205]                	mov	dx,PUTBACKMSG		; prompt for diskette
  4215                                  	;mov	si,offset DATARES:PutBackSubst
  4216                                  	;invoke	RPrint
  4217 00001092 BE[2902]                	mov	si,PutBackSubst		; containing COMMAND
  4218 00001095 E84303                  	call	RPrint
  4219                                  	;mov	dx,offset DATARES:Prompt
  4220                                  	;invoke	RPrint
  4221 00001098 BA[1406]                	mov	dx,PROMPT		; "Press any key"
  4222 0000109B E83D03                  	call	RPrint
  4223                                  
  4224                                  	; MSDOS 3.3
  4225                                  	;mov	dx,PUTBACKMSG		; prompt for diskette
  4226                                  	;call	RDISPMSG
  4227                                  	;mov	dx,[PUTBACKSUBSTPTR]
  4228                                  	;mov	si,[COMSPEC_END]
  4229                                  	;mov	byte [si+1],'$'
  4230                                  	;call	RDISPMSG
  4231                                  	;mov	byte [si+1],0
  4232                                  	;mov	dx,PROMPT
  4233                                  	;call	RDISPMSG
  4234                                  
  4235                                  	;call	GetRawFlushedByte
  4236                                  	;retn
  4237                                  	; 12/01/2023
  4238                                  	;jmp	short GetRawFlushedByte
  4239                                  
  4240                                  ;***	GetRawFlushedByte - flush world and get raw input
  4241                                  
  4242                                  GetRawFlushedByte:
  4243                                  	; 12/01/2023
  4244 0000109E B8070C                  	mov	ax,0C07h
  4245                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) | RAW_CON_INPUT ; 0C07h
  4246 000010A1 CD21                    	int	21h			; get char without testing or echo
  4247 000010A3 B8000C                  	mov	ax,0C00h
  4248                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + 0 ; 0C00h
  4249 000010A6 CD21                    	int	21h
  4250                                  
  4251                                  ;	Bugbug:	get rid of this return and the following retz.
  4252                                  
  4253                                  LoadCom_retn:
  4254 000010A8 C3                      	retn
  4255                                  
  4256                                  	; 21/04/2023
  4257                                  TryDoOpen:
  4258 000010A9 E8C1FF                  	call	GetComDsk
  4259                                  	;jmp	short LoadCom
  4260                                  
  4261                                  ;***	LoadCom - load in transient
  4262                                  
  4263                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4264                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:10DAh - CODERES:039Ah)
  4265                                  
  4266                                  LoadCom:
  4267                                  	;assume	ds:DATARES
  4268                                  	
  4269 000010AC 45                      	inc	bp				; flag command read
  4270                                  
  4271 000010AD BA[4B02]                	mov	dx,ComSpec
  4272 000010B0 B8003D                  	mov	ax,3D00h
  4273                                  	;mov	ax,OPEN<<8	; 3D00h
  4274 000010B3 CD21                    	int	21h				; open command.com
  4275 000010B5 730B                    	jnc	short ReadCom
  4276                                  	;cmp	ax,4
  4277 000010B7 83F804                  	cmp	ax,ERROR_TOO_MANY_OPEN_FILES
  4278 000010BA 75ED                    	jnz	short TryDoOpen
  4279 000010BC BA[9E06]                	mov	dx,NOHANDMES
  4280 000010BF E959FD                  	jmp	FatalC				; will never find a handle
  4281                                  
  4282                                  	; 21/04/2023
  4283                                  ;TryDoOpen:
  4284                                  	;call	GetComDsk
  4285                                  	;jmp	short LoadCom
  4286                                  
  4287                                  ReadCom:
  4288 000010C2 89C3                    	mov	bx,ax				; BX = handle
  4289                                  	;mov	dx,offset RESGROUP:TranStart
  4290                                  	; 05/06/2023
  4291                                  	;mov	dx,26E0h ; MSDOS 6.22 COMMAND.COM
  4292                                  	; 19/07/2024
  4293                                  	;mov	dx,2980h ; PCDOS 7.1 COMMAND.COM
  4294 000010C4 BAE027                  	mov	dx,TRANSTART
  4295 000010C7 31C9                    	xor	cx,cx				; CX:DX = seek loc
  4296 000010C9 B80042                  	mov	ax,4200h
  4297                                  	;mov	ax,LSEEK<<8	; 4200h
  4298 000010CC CD21                    	int	21h
  4299 000010CE 7210                    	jc	short WrongCom1
  4300                                  	; 12/01/2023
  4301                                  	;;mov	cx,offset TRANGROUP:TranSpaceEnd - 100h
  4302                                  	;mov	cx,97C5h		 ; MSDOS 5.0 COMMAND.COM
  4303                                  	; 05/06/2023
  4304                                  	;mov	cx,0AE95h		 ; MSDOS 6.22 COMMAND.COM
  4305                                  	; 19/07/2024
  4306                                  	;mov	cx,0A99Ah ; PCDOS 7.1 COMMAND.COM
  4307 000010D0 B96BA5                  	mov	cx,TRANSPACEEND-100h ; 4C5Ch (for original MSDOS 3.3!)
  4308 000010D3 1E                      	push	ds
  4309 000010D4 8E1E[8F02]              	mov	ds,[TrnSeg]
  4310                                  	;assume	ds:NOTHING
  4311 000010D8 BA0001                  	mov	dx,100h
  4312 000010DB B43F                    	mov	ah,3Fh
  4313                                  	;mov	ah,READ	; 3Fh
  4314 000010DD CD21                    	int     21h	; DOS - 2+ - READ FROM FILE WITH HANDLE
  4315                                  			; BX = file handle, CX = number of bytes to read
  4316                                  			; DS:DX -> buffer
  4317 000010DF 1F                      	pop	ds
  4318                                  	;assume	ds:DATARES
  4319                                  WrongCom1:
  4320 000010E0 9C                      	pushf
  4321 000010E1 50                      	push	ax
  4322 000010E2 B43E                    	mov	ah,3Eh
  4323                                  	;mov	ah,CLOSE ; 3Eh
  4324 000010E4 CD21                    	int	21h			; close command.com
  4325 000010E6 58                      	pop	ax
  4326 000010E7 9D                      	popf
  4327 000010E8 7204                    	jc	short WrongCom		; error on read
  4328 000010EA 39C8                    	cmp	ax,cx
  4329                                  	;retz				; size matched
  4330 000010EC 74BA                    	jz	short LoadCom_retn
  4331                                  WrongCom:
  4332 000010EE BA[DC05]                	mov	dx,COMBAD
  4333 000010F1 E879FF                  	call	GetComDsk
  4334 000010F4 EBB6                    	jmp	short LoadCom		; try again
  4335                                  
  4336                                  ;***	ChkSum - compute transient checksum
  4337                                  
  4338                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4339                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1129h
  4340                                  	
  4341                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  4342                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1239h
  4343                                  
  4344                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4345                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1207h
  4346                                  ChkSum:
  4347 000010F6 1E                      	push	ds
  4348 000010F7 8E1E[8F02]              	mov	ds,[TrnSeg]
  4349 000010FB BE0001                  	mov	si,100h
  4350                                  	;;;mov	cx,offset TRANGROUP:TranDataEnd - 100h
  4351                                  	;;mov	cx,87C2h ; MSDOS 5.0
  4352                                  	; 05/06/2023
  4353                                  	;mov	cx,9D53h ; MSDOS 6.22
  4354                                  	; 19/07/2024
  4355                                  	;mov	cx,9B47h ; PCDOS 7.1 COMMAND.COM
  4356 000010FE B9[A196]                	mov	cx,TRANDATAEND-100h ; 3E44h (for original MSDOS 3.3!)
  4357                                  Check_Sum:
  4358 00001101 FC                      	cld
  4359 00001102 D1E9                    	shr	cx,1
  4360 00001104 31D2                    	xor	dx,dx
  4361                                  
  4362                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4363                                  %if 1  ; PCDOS 7.1 COMMAND.COM
  4364 00001106 C606[C98F]FF            	mov	byte [msg_disp_class],0FFh
  4365 0000110B 8916[CB8F]              	mov     [extend_buf_ptr],dx ; 0
  4366 0000110F 8816[CD8F]              	mov     [extend_buf_sub],dl ; 0
  4367                                  %endif	
  4368                                  
  4369                                  Chk:
  4370 00001113 AD                      	lodsw
  4371 00001114 01C2                    	add	dx,ax
  4372 00001116 83D200                  	adc	dx,0
  4373 00001119 E2F8                    	loop	Chk
  4374                                  
  4375                                  	; 04/05/2023
  4376 0000111B 1F                      	pop	ds
  4377                                  
  4378                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4379 0000111C 3B16[9702]              	cmp	dx,[Sum]
  4380                                  
  4381                                  	;pop	ds ; 04/05/2023
  4382 00001120 C3                      	retn
  4383                                  
  4384                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4385                                  ; ---------------------------------------
  4386                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:122Eh
  4387                                  %if 1
  4388                                  chk_transient:	; check transient portion is valid or not
  4389 00001121 1E                      	push    ds
  4390 00001122 8E1E[8F02]              	mov     ds,[TrnSeg]
  4391 00001126 813E[0401]9090          	cmp	word [TCOMMAND],9090h ; nop, nop
  4392 0000112C 1F                      	pop     ds
  4393 0000112D C3                      	retn
  4394                                  %endif
  4395                                  ; ---------------------------------------
  4396                                  
  4397                                  ;***	SetVect - set interrupt vectors
  4398                                  
  4399                                  SetVect:
  4400                                  
  4401                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4402                                  ; PCDOS 7.1 COMMAND.COM
  4403                                  %if 0
  4404                                  	;mov	dx,offset DATARES:LodCom_Trap 
  4405                                  	; 12/01/2023
  4406                                  	mov	dx,LodCom_Trap
  4407                                  	;mov	dx,LODCOM ; MSDOS 3.3
  4408                                  	mov	[PDB.EXIT],dx	; mov ds:0Ah,dx
  4409                                  	mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4410                                  
  4411                                  	mov	ax,2522h
  4412                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8) | 22h  ; 2522h
  4413                                  	int	21h
  4414                                  	;mov	dx,offset DATARES:Ctrlc_Trap
  4415                                  	mov	dx,Ctrlc_Trap
  4416                                  	;mov	dx,CONTC ; MSDOS 3.3
  4417                                  	inc	al	; 23h
  4418                                  	int	21h
  4419                                  	;mov	dx,offset DATARES:CritErr_Trap
  4420                                  	mov	dx,CritErr_Trap
  4421                                  	;mov	dx,CRITERR ; MSDOS 3.3
  4422                                  	inc	al	; 24h
  4423                                  	int	21h
  4424                                  	retn
  4425                                  %else
  4426                                  	; PCDOS 7.1 COMMAND.COM
  4427                                  	;mov	dx,LodCom_Trap
  4428                                  	;mov	[PDB.EXIT],dx	; mov ds:0Ah,dx
  4429                                  	;mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4430                                  
  4431                                  	;push	es
  4432                                  	;push	bx
  4433                                  	;xor	bx,bx
  4434                                  	;mov	es,bx
  4435                                  	;mov 	bl,88h		; INT 22h vector
  4436                                  	;cli
  4437                                  	;mov	[es:bx],dx
  4438                                  	;mov	[es:bx+2],ds
  4439                                  	;mov	dx,Ctrlc_Trap
  4440                                  	;mov	bl,8Ch		; INT 23h vector
  4441                                  	;mov	[es:bx],dx
  4442                                  	;mov	[es:bx+2],ds
  4443                                  	;mov	dx,CritErr_Trap
  4444                                  	;mov	bl,90h		; INT 24h vector
  4445                                  	;mov 	[es:bx],dx
  4446                                  	;mov	[es:bx+2],ds
  4447                                  	;sti
  4448                                  	;pop	bx
  4449                                  	;pop	es
  4450                                  	;retn
  4451                                  
  4452                                  	; 19/07/2024
  4453                                  	; Retro DOS v5.0 COMMAND.COM
  4454                                  
  4455 0000112E 06                      	push	es
  4456                                  	;push	di
  4457 0000112F 31FF                    	xor	di,di
  4458 00001131 8EC7                    	mov	es,di
  4459 00001133 BF8800                  	mov	di,88h
  4460 00001136 1E                      	push	ds
  4461 00001137 1E                      	push	ds
  4462 00001138 1E                      	push	ds
  4463 00001139 B8[E000]                	mov	ax,LodCom_Trap
  4464 0000113C A30A00                  	mov	[PDB.EXIT],ax	; mov ds:0Ah,ax
  4465 0000113F 8C1E0C00                	mov	[PDB.EXIT+2],ds ; mov ds:0Ch,ds
  4466 00001143 FA                      	cli	
  4467 00001144 AB                      	stosw
  4468 00001145 58                      	pop	ax	; segment (ds)
  4469 00001146 AB                      	stosw
  4470 00001147 B8[AC00]                	mov	ax,Ctrlc_Trap
  4471 0000114A AB                      	stosw
  4472 0000114B 58                      	pop	ax	; segment (ds)
  4473 0000114C AB                      	stosw
  4474 0000114D B8[B700]                	mov	ax,CritErr_Trap
  4475 00001150 AB                      	stosw
  4476 00001151 58                      	pop	ax	; segment (ds)
  4477 00001152 AB                      	stosw
  4478 00001153 FB                      	sti
  4479                                  	;pop	di
  4480 00001154 07                      	pop	es
  4481 00001155 C3                      	retn
  4482                                  %endif
  4483                                  
  4484                                  ; ----------------------
  4485                                  	; MSDOS 6.0
  4486                                  ;;SR;
  4487                                  ;We have this to take care of the extra values pushed on the stack by
  4488                                  ;the stub before jumping to LodCom1. We set up ds here and then jump to
  4489                                  ;Lodcom1
  4490                                  
  4491                                  ;public	TrnLodCom1
  4492                                  	; 12/01/2023
  4493                                  TrnLodCom1:
  4494 00001156 1F                      	pop	ds			; ds = DATARES
  4495 00001157 83C402                  	add	sp,2
  4496                                  ;	pop	ds:OldDS
  4497 0000115A E9EFFD                  	jmp	LodCom1
  4498                                  ; ----------------------
  4499                                  
  4500                                  ; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4501                                  ; ---------------------------------------
  4502                                  %if 1	; PCDOS 7.1 COMMAND.COM
  4503                                  int21h_close:
  4504 0000115D B43E                    	mov	ah,3Eh ; CLOSE file
  4505                                  int21h:
  4506                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1272h
  4507 0000115F 06                      	push	es
  4508 00001160 53                      	push	bx
  4509 00001161 31DB                    	xor	bx,bx
  4510 00001163 8EC3                    	mov	es,bx ; 0
  4511 00001165 5B                      	pop	bx
  4512 00001166 9C                      	pushf			; Int 21h simulation (ES=0)
  4513 00001167 FA                      	cli
  4514                                  	;call	dword ptr es:84h
  4515 00001168 26FF1E8400              	call	far [es:84h]	; INT 21h handler
  4516 0000116D 07                      	pop	es
  4517 0000116E C3                      	retn
  4518                                  %endif
  4519                                  ; ---------------------------------------
  4520                                  
  4521                                  ;=============================================================================
  4522                                  ; RUCODE.ASM, MSDOS 6.0, 1991
  4523                                  ;=============================================================================
  4524                                  ; 22/09/2018 - Retro DOS v3.0
  4525                                  
  4526                                  ;	title	Localizable code for resident COMMAND
  4527                                  
  4528                                  	;assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  4529                                  
  4530                                  ; ----------------------------------------------------------------------------
  4531                                  ;***	AskEnd - ask user to confirm batch file termination
  4532                                  ;
  4533                                  ;	Confirm with user before freeing batch ...
  4534                                  ;
  4535                                  ;	ENTRY	nothing
  4536                                  ;
  4537                                  ;	EXIT	CY = set if batch termination is confirmed
  4538                                  ;
  4539                                  ;		CY = clear if batch should continue
  4540                                  ;
  4541                                  ;	USED	AX,DX,...
  4542                                  ;
  4543                                  ;	Bugbug:	move this to transient, copy to batch segment.
  4544                                  ;	Bugbug:	or move it to command1 1st.
  4545                                  ;
  4546                                  ;	Bugbug: No_Char and Yes_Char should be constants.
  4547                                  ; ----------------------------------------------------------------------------
  4548                                  
  4549                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4550                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1169h (CODERES:0429h)
  4551                                  
  4552                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  4553                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1279h (CODERES:0429h)
  4554                                  
  4555                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4556                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1289h
  4557                                  AskEnd:
  4558                                  	;assume	ds:DATARES
  4559                                  
  4560 0000116F BA[3606]                	mov	dx,ENDBATMES			; DX = message #
  4561 00001172 E86602                  	call	RPrint
  4562                                  	;call	RDISPMSG  ; MSDOS 3.3
  4563 00001175 B8010C                  	mov	ax,0C01h
  4564                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + STD_CON_INPUT  ;0C01h
  4565 00001178 CD21                    	int     21h             ; DOS - CLEAR KEYBOARD BUFFER
  4566                                  				; AL must be 01h, 06h, 07h, 08h, or 0Ah.
  4567 0000117A E8F702                  	call	CharToUpper			; change to upper case
  4568 0000117D 3A06[3D05]              	cmp	al,[NO_CHAR]
  4569 00001181 7407                    	je	short aeRet			; answer is no (CY is clear)
  4570 00001183 3A06[3C05]              	cmp	al,[YES_CHAR]
  4571 00001187 75E6                    	jne	short AskEnd			; invalid response, try again
  4572 00001189 F9                      	stc					; answer is yes
  4573                                  aeRet:	
  4574 0000118A C3                      	retn
  4575                                  
  4576                                  ; ----------------------------------------------------------------------------
  4577                                  ;***	DskErr - critical error handler
  4578                                  ;
  4579                                  ;	Default critical error handler unless user intercepts int 24h.
  4580                                  ;
  4581                                  ;	ENTRY	int 24h
  4582                                  ;
  4583                                  ;	EXIT
  4584                                  ;
  4585                                  ;	USED
  4586                                  ;
  4587                                  ;	EFFECTS
  4588                                  ; ----------------------------------------------------------------------------
  4589                                  
  4590                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4591                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1185h (CODERES:0445h)
  4592                                  
  4593                                  	; 19/07/2024 - Retro DOS v5.0 COMMAND.COM
  4594                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:12A5h
  4595                                  
  4596                                  ;SR; 
  4597                                  ;The stub is going to push the old ds value and the resident data segment
  4598                                  ;onto the stack in that order. Get it off the stack
  4599                                  
  4600                                  ;DskErr	proc	far
  4601                                  DSKERR:
  4602                                  	;assume	ds:NOTHING,es:NOTHING,ss:NOTHING
  4603                                  	; 12/01/2023
  4604 0000118B 1F                      	pop	ds			; ds = DATARES
  4605                                  	;assume ds:DATARES
  4606 0000118C 8F06[2E05]              	pop	word [OldDS]		; save old ds value
  4607                                  
  4608                                  ;CRITERR: ; MSDOS 3.3
  4609 00001190 FB                      	sti
  4610                                  	; 12/01/2023
  4611                                  	;push	ds ; 25/09/2018
  4612 00001191 06                      	push	es
  4613 00001192 56                      	push	si
  4614 00001193 51                      	push	cx
  4615 00001194 57                      	push	di
  4616 00001195 51                      	push	cx
  4617 00001196 50                      	push	ax
  4618                                  
  4619 00001197 1E                      	push	ds			;save our data segment
  4620                                  	;push	cs ; 25/09/2018
  4621 00001198 07                      	pop	es			;es = DATARES
  4622                                  
  4623 00001199 8EDD                    	mov	ds,bp
  4624                                  	;assume	ds:nothing
  4625                                  
  4626                                  	;mov	ax,[si].SDEVATT
  4627 0000119B 8B4404                  	mov	ax,[si+SYSDEV.ATT] ; mov ax,[si+4]	
  4628 0000119E 268826[2502]            	mov	[es:CDevAt],ah
  4629                                  
  4630                                  	;push	cs
  4631                                  	;pop	es
  4632                                  
  4633 000011A3 BF[1802]                	mov	di,DevName
  4634 000011A6 B90800                  	mov	cx,8
  4635                                  	;add	si,SDEVNAME  ; add si,10
  4636 000011A9 83C60A                  	add	si,SYSDEV.NAME	; save device name (even for block device)
  4637                                  				
  4638 000011AC FC                      	cld
  4639 000011AD F3A4                    	rep	movsb
  4640 000011AF 58                      	pop	ax
  4641 000011B0 59                      	pop	cx
  4642 000011B1 5F                      	pop	di
  4643                                  
  4644                                  ;	Stack still contains DS and ES.
  4645                                  
  4646                                  ;SR;
  4647                                  ;We need ds = DATARES for SavHand
  4648                                  
  4649                                  	 ;12/01/2023
  4650 000011B2 06                      	push	es
  4651 000011B3 1F                      	pop	ds
  4652                                  	;assume	ds:DATARES
  4653                                  
  4654                                  	;invoke	SavHand		; save user's stdin/out, set to our stderr
  4655 000011B4 E870FE                  	call	SavHand
  4656                                  
  4657                                  	; 12/01/2023
  4658                                  	; 25/09/2018
  4659                                  	;;push	cs
  4660                                  	;push	es
  4661                                  	;pop	ds		; set up local data segment
  4662                                  	;assume	ds:resgroup
  4663                                  
  4664 000011B7 52                      	push	dx
  4665 000011B8 E81D02                  	call	crlf
  4666 000011BB 5A                      	pop	dx
  4667                                  
  4668                                  ;	Bugbug:	rename Crit_Err_Info to CritErrAH?
  4669                                  
  4670 000011BC 8826[9C02]              	mov	[Crit_Err_Info],ah	; save critical error flags
  4671                                  
  4672                                  ;	Compute and save ASCII drive letter (nonsense for char devices)
  4673                                  
  4674 000011C0 0441                    	add	al,'A'
  4675 000011C2 A2[0502]                	mov	[DrvLet],al
  4676                                  
  4677                                  ;	Bugbug:	These labels are awful. Change, especially 'NoHardE'.
  4678                                  
  4679 000011C5 F6C480                  	test	ah,80h
  4680 000011C8 740A                    	jz	short NoHardE		; it's a disk-device error
  4681 000011CA F606[2502]80            	test	byte [CDevAt],DEVTYP>>8 ; 80h
  4682 000011CF 7503                    	jnz	short NoHardE		; it's a character device
  4683 000011D1 E9F701                  	jmp	FatErr			; it's a FAT error
  4684                                  
  4685                                  NoHardE:
  4686 000011D4 BE[5E05]                	mov	si,MREAD		; SI = "read" msg #
  4687 000011D7 F6C401                  	test	ah,1
  4688 000011DA 7403                    	jz	short SavMes		; it's a read error
  4689 000011DC BE[6705]                	mov	si,MWRITE		; SI = "write" msg #
  4690                                  SavMes:
  4691 000011DF 893E[5C04]              	mov	[OldErrNo],di		; save critical error code
  4692                                  
  4693                                  ;	Bugbug:	don't need to save/restore all here?
  4694                                  
  4695 000011E3 06                      	push	es
  4696                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  4697                                  	;push	ds			; GetExtendedError likes to STOMP
  4698                                  	; 12/01/2023
  4699                                  	; (all registers are changed -in dos service- except bp) *
  4700                                  	;push	bp
  4701                                  	; 19/07/2024
  4702                                  	;push	si
  4703                                  	;push	dx
  4704 000011E4 51                      	push	cx
  4705 000011E5 53                      	push	bx
  4706                                  	; 05/06/2023
  4707 000011E6 B459                    	mov	ah,59h ; *
  4708                                  	;mov	ah,GetExtendedError ; 59h ; get extended error info
  4709 000011E8 CD21                    	int	21h
  4710 000011EA 5B                      	pop	bx
  4711 000011EB 59                      	pop	cx
  4712                                  	; 19/07/2024
  4713                                  	;pop	dx
  4714                                  	;pop	si
  4715                                  	; 12/01/2023
  4716                                  	;pop	bp
  4717                                  	; 19/07/2024
  4718                                  	;pop	ds
  4719 000011EC 893E[3302]              	mov	[NeedVol],di		; save possible ptr to volume label
  4720 000011F0 8C06[3502]              	mov	[NeedVol+2],es
  4721 000011F4 07                      	pop	es
  4722                                  
  4723                                  ;	Bugbug:	AX has extended error code, so no need to zero AH?
  4724                                  
  4725                                  	; 19/07/2024 - PCDOS 7.1 COMMAND.COM
  4726                                  	;xor	ah,ah
  4727 000011F5 89C7                    	mov	di,ax			; DI = error code
  4728                                  
  4729                                  ; Bugbug: somewhat obsolete documentation?
  4730                                  ;
  4731                                  ; DI is now the correct error code. Classify things to see what we are
  4732                                  ; allowed to report. We convert DI into a 0-based index into a message table.
  4733                                  ; This presumes that the int 24 errors (oldstyle) and new errors (sharing and
  4734                                  ; the like) are contiguous.
  4735                                  
  4736                                  ;	Bugbug:	simplify following code by cmp'ing instead of sub'ing.
  4737                                  ;	Check use of ErrCd_24, though.
  4738                                  
  4739 000011F7 83EF13                  	sub	di,ERROR_WRITE_PROTECT ; 13h
  4740 000011FA 7303                    	jae	short HavCod
  4741                                  
  4742                                  ;	Bugbug:	wouldn't it be better to display the original error msg,
  4743                                  ;	even though it's not a critical error?
  4744                                  
  4745 000011FC BF0C00                  	mov	di,ERROR_GEN_FAILURE - ERROR_WRITE_PROTECT ; mov di,0Ch
  4746                                  
  4747                                  ; DI now has the mapped error code. Old style errors are:
  4748                                  ;   FOOBAR <read|writ>ing drive ZZ.
  4749                                  ; New style errors are:
  4750                                  ;   FOOBAR
  4751                                  ; We need to figure out which the particular error belongs to.
  4752                                  
  4753                                  HavCod:
  4754 000011FF C606[3702]00            	mov	byte [ErrType],0	; assume old style
  4755 00001204 83FF10                  	cmp	di,ERROR_FCB_UNAVAILABLE - ERROR_WRITE_PROTECT  ; cmp di,10h
  4756 00001207 7405                    	je	short SetStyle
  4757 00001209 83FF11                  	cmp	di,ERROR_SHARING_BUFFER_EXCEEDED - ERROR_WRITE_PROTECT ; cmp di,11h
  4758 0000120C 7504                    	jne	short GotStyle
  4759                                  
  4760                                  SetStyle:
  4761                                  ;	Bugbug:	use INC
  4762                                  	;mov	byte [ErrType],1		; must be new type
  4763 0000120E FE06[3702]              	inc	byte [ErrType] ; Retro DOS v3.0 COMMAND.COM - 22/09/2018
  4764                                  
  4765                                  GotStyle:
  4766 00001212 893E[4402]              	mov	[ErrCd_24],di
  4767                                  	; 12/01/2023
  4768                                  	; 25/09/2018
  4769                                  	; MSDOS 6.0
  4770 00001216 83FF14                  	cmp	di,ERROR_HANDLE_DISK_FULL - ERROR_WRITE_PROTECT ; cmp di,14h
  4771                                  	; MSDOS 3.3
  4772                                  	;cmp	di,ERROR_SHARING_BUFFER_EXCEEDED - ERROR_WRITE_PROTECT ; cmp di,11h
  4773                                  
  4774                                  						; If the error message is unknown
  4775 00001219 7641                    	jbe	short NormalError		;  redirector, continue. Otherwise,
  4776                                  
  4777                                  ; We do not know how to handle this error. Ask IFSFUNC if she knows
  4778                                  ; how to handle things
  4779                                  
  4780                                  ;input to IFSFUNC:    AL=1
  4781                                  ;		      BX=extended error number
  4782                                  ;
  4783                                  ;output from IFSFUNC: AL=error type (0 or 1)
  4784                                  ;			 0=<message> error (read/writ)ing (drive/device) xxx
  4785                                  ;			   Abort, Retry, Ignore
  4786                                  ;			 1=<message>
  4787                                  ;			   Abort, Retry, Ignore
  4788                                  ;		      ES:DI=pointer to message text
  4789                                  ;		      carry set=>no message
  4790                                  
  4791 0000121B 89C7                    	mov	di,ax			; retrieve correct extended error...
  4792 0000121D B80005                  	mov	ax,0500h		; is the redir there?
  4793 00001220 CD2F                    	int	2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER - INSTALLATION CHECK
  4794                                  			; Return: AL = 00h not installed, OK to install
  4795                                  			; 01h not installed, can't install
  4796                                  			; FFh installed
  4797 00001222 3CFF                    	cmp	al,0FFh
  4798 00001224 7529                    	jne	short NoHandler		; no, go to NoHandler
  4799                                  
  4800                                  	; 12/01/2023
  4801                                  	; MSDOS 6.0
  4802 00001226 53                      	push	bx
  4803 00001227 89FB                    	mov	bx,di			; get ErrType and ptr to error msg
  4804 00001229 B80105                  	mov	ax,0501h
  4805 0000122C CD2F                    	int	2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER -
  4806 0000122E 5B                      	pop	bx 
  4807 0000122F 721E                    	jc	short NoHandler
  4808                                  	
  4809                                  	; MSDOS 3.3
  4810                                  	;mov     ax,di
  4811                                  	;mov     ah,5
  4812                                  	;int     2Fh	; Multiplex - DOS 3+ CRITICAL ERROR HANDLER -
  4813                                  	;jc      short NOHANDLER
  4814                                  
  4815                                  ;	Bugbug:	need to record error type?
  4816                                  
  4817 00001231 A2[3702]                	mov	[ErrType],al
  4818                                  
  4819 00001234 1E                      	push	ds
  4820 00001235 06                      	push	es
  4821 00001236 1F                      	pop	ds
  4822 00001237 89FA                    	mov	dx,di
  4823 00001239 B9FFFF                  	mov	cx,-1			; find end of msg
  4824 0000123C 30C0                    	xor	al,al
  4825                                  
  4826 0000123E FC                      	cld
  4827 0000123F F2AE                    	repnz	scasb
  4828                                  
  4829                                  ;	Bugbug:	we can do better than this.
  4830                                  
  4831                                  	;mov	byte [di-1],'$'
  4832                                  	; 19/07/2024
  4833 00001241 4F                      	dec	di
  4834 00001242 C60524                  	mov	byte [di],'$'
  4835                                  
  4836                                  	;CALL	RDISPMSG ; MSDOS 3.3
  4837                                  	
  4838 00001245 B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9	; print the message
  4839 00001247 CD21                    	int	21h
  4840                                  
  4841                                  	;mov	byte [di-1],0			; restore terminal byte
  4842                                  	; 19/07/2024
  4843 00001249 C60500                  	mov	byte [di],0
  4844                                  
  4845 0000124C 1F                      	pop	ds				; clean up and continue
  4846 0000124D EB15                    	jmp	short CheckErrType
  4847                                  
  4848                                  ;*	Redir isn't available or doesn't recognize the error.
  4849                                  ;	Restore regs to unextended error.
  4850                                  
  4851                                  NoHandler:
  4852 0000124F C606[3702]00            	mov	byte [ErrType],0
  4853                                  ;	Bugbug:	won't this break, since we add error_write_protect back in?
  4854 00001254 8B3E[5C04]              	mov	di,[OldErrNo]
  4855 00001258 893E[4402]              	mov	[ErrCd_24],di
  4856                                  
  4857                                  NormalError:
  4858                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4859                                  	; MSDOS 6.0
  4860 0000125C 83C713                  	add	di,ERROR_WRITE_PROTECT
  4861 0000125F 87FA                    	xchg	di,dx			; may need dx later
  4862 00001261 E89001                  	call	RPrintCrit		; print error type
  4863                                  
  4864                                  	; MSDOS 3.3
  4865                                  	;shl     di,1
  4866                                  	;mov     di,[CRMSGTBL+di]
  4867                                  	;xchg    di,dx
  4868                                  	;call    RDISPMSG
  4869                                  
  4870                                  CheckErrType:
  4871 00001264 803E[3702]00            	cmp	byte [ErrType],0	; Check error style...
  4872 00001269 7405                    	je	short ContOld
  4873 0000126B E86A01                  	call	crlf			; if new style then done printing
  4874 0000126E EB31                    	jmp	short Ask
  4875                                  
  4876                                  ContOld:
  4877                                  	; 12/01/2023
  4878                                  	; MSDOS 6.0
  4879 00001270 46                      	inc	si			; DS:SI = ptr to asciiz string
  4880                                  
  4881                                  ;	Bugbug:	combine some of the following two sections?
  4882                                  
  4883                                  	; 12/01/2023
  4884 00001271 F606[2502]80            	test	byte [CDevAt],DEVTYP>>8 ; 80h
  4885                                  	;test	byte [CDevAt],DEVTYP shr 8 ; 80h
  4886 00001276 740F                    	jz	short BlkErr
  4887                                  	;;mov	dx,offset DATARES:CharDevErr	; DX = ptr to device message
  4888                                  	;mov	dx,ChardevErr
  4889 00001278 BA[7F05]                	mov	dx,MDEVICE
  4890                                  	;mov	[CharDevErrRw.SubstPtr],si	; point to read/write string
  4891 0000127B 8936[0702]              	mov	[CharDevErrRw],si
  4892                                  	;mov	si,offset DATARES:CharDevErrSubst; SI = ptr to subst block
  4893 0000127F BE[0602]                	mov	si,CharDevErrSubst
  4894                                  
  4895 00001282 E85601                  	call	RPrint				; print the message
  4896 00001285 EB1A                    	jmp	short Ask			; don't ralph on command
  4897                                  
  4898                                  	; 12/01/2023
  4899                                  	; MSDOS 3.3
  4900                                  	;mov	dx,ERRMES
  4901                                  	;call	RDISPMSG
  4902                                  	;mov	dx,si
  4903                                  	;call	RDISPMSG
  4904                                  	;
  4905                                  	;test	byte [CDevAt],80h
  4906                                  	;jz	short BLKERR
  4907                                  	;mov	dx,CHARDEVERR	; " device "
  4908                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  4909                                  	;int	21h		; DOS - PRINT STRING
  4910                                  	;			; DS:DX -> string terminated by "$"
  4911                                  	;jmp	short ASK
  4912                                  
  4913                                  BlkErr:
  4914                                  	; 12/01/2023
  4915                                  	; MSDOS 6.0
  4916                                  	;;mov	dx,offset DATARES:BlkDevErr	; DX = error msg #
  4917                                  	;mov	dx,BlkDevErr
  4918 00001287 BA[7005]                	mov	dx,MDRIVE
  4919                                  	;mov	[BlkDevErrRw.SubstPtr],si	; "reading","writing" ptr
  4920 0000128A 8936[0002]              	mov	[BlkDevErrRw],si
  4921                                  	;mov	si,offset DATARES:BlkDevErrSubst ; SI = ptr to subst block
  4922 0000128E BE[FF01]                	mov	si,BlkDevErrSubst
  4923 00001291 E84701                  	call	RPrint
  4924                                  
  4925                                  	; MSDOS 3.3
  4926                                  	;mov	dx,BLKDEVERR
  4927                                  	;call	RDISPMSG
  4928                                  
  4929 00001294 803E[4802]00            	cmp	byte [Loading],0
  4930 00001299 7406                    	jz	short Ask
  4931 0000129B E8B3FD                  	call	RestHand
  4932 0000129E E9AAFD                  	jmp	GetComDsk2		; if error loading COMMAND, re-prompt
  4933                                  Ask:
  4934 000012A1 833E[4402]0F            	cmp	word [ErrCd_24],15	; error 15 has an extra message
  4935 000012A6 751E                    	jne	short Not15		; not error 15
  4936                                  
  4937                                  ;*	For error 15, tell the user which volume/serial # are needed.
  4938                                  
  4939 000012A8 51                      	push	cx
  4940                                  
  4941                                  ;	Bugbug:	does this push/pop need to be done?
  4942                                  
  4943 000012A9 1E                      	push	ds
  4944 000012AA 07                      	pop	es
  4945 000012AB C536[3302]              	lds	si,[NeedVol]
  4946                                  	;assume	ds:NOTHING
  4947 000012AF 57                      	push	di
  4948 000012B0 BF[1502]                	mov	di,VolName
  4949                                  	; 12/01/2023
  4950                                  	; MSDOS 6.0
  4951 000012B3 B91000                  	mov	cx,16			; copy volume name & serial #
  4952                                  	; MSDOS 3.3
  4953                                  	;mov	cx,11			; copy volume name
  4954 000012B6 FC                      	cld
  4955 000012B7 F3A4                    	rep	movsb
  4956 000012B9 5F                      	pop	di
  4957 000012BA 06                      	push	es
  4958 000012BB 1F                      	pop	ds
  4959 000012BC 59                      	pop	cx
  4960                                  	;assume	ds:DATARES
  4961                                  	; 12/01/2023
  4962                                  	; MSDOS 6.0
  4963                                  	;mov	dx,offset DATARES:NeedVolMsg	; DX = ptr to msg
  4964                                  	;mov	si,offset DATARES:NeedVolSubst	; DS:SI = ptr to subst block
  4965                                  	;mov	dx,NeedVolMsg
  4966 000012BD BA[8F05]                	mov	dx,MVOLSERIAL
  4967 000012C0 BE[0C02]                	mov	si,NeedVolSubst
  4968 000012C3 E81501                  	call	RPrint
  4969                                  
  4970                                  	; MSDOS 3.3
  4971                                  	;mov	dx,NEEDVOLMSG
  4972                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  4973                                  	;int	21h		; DOS - PRINT STRING
  4974                                  	;			; DS:DX -> string terminated by "$"
  4975                                  Not15:
  4976                                  ;*	Print abort, retry, ignore, fail message.
  4977                                  ;	Print only options that are valid.
  4978                                  
  4979                                  ;	Bugbug:	sizzle this.
  4980                                  
  4981                                  	; 12/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  4982 000012C6 BA[3E05]                	mov	dx,REQ_ABORT
  4983 000012C9 E80F01                  	call	RPrint
  4984                                  	;call	RDISPMSG
  4985 000012CC F606[9C02]10            	test	byte [Crit_Err_Info],RETRY_ALLOWED  ; 10h
  4986 000012D1 7406                    	jz	short Try_Ignore
  4987 000012D3 BA[4405]                	mov	dx,REQ_RETRY
  4988 000012D6 E80201                  	call	RPrint
  4989                                  	;call	RDISPMSG
  4990                                  Try_Ignore:
  4991 000012D9 F606[9C02]20            	test	byte [Crit_Err_Info],IGNORE_ALLOWED ; 20h
  4992 000012DE 7406                    	jz	short Try_Fail
  4993 000012E0 BA[4C05]                	mov	dx,REQ_IGNORE
  4994 000012E3 E8F500                  	call	RPrint
  4995                                  	;call	RDISPMSG
  4996                                  Try_Fail:
  4997 000012E6 F606[9C02]08            	test	byte [Crit_Err_Info],FAIL_ALLOWED   ; 08h
  4998 000012EB 7406                    	jz	short Term_Question
  4999 000012ED BA[5505]                	mov	dx,REQ_FAIL
  5000 000012F0 E8E800                  	call	RPrint
  5001                                  	;call	RDISPMSG
  5002                                  Term_Question:
  5003 000012F3 BA[5C05]                	mov	dx,REQ_END
  5004 000012F6 E8E200                  	call	RPrint
  5005                                  	;call	RDISPMSG
  5006                                  
  5007                                  ;	If the /f switch was given, we fail all requests.
  5008                                  
  5009 000012F9 F606[A902]FF            	test	byte [fFail],-1
  5010 000012FE 741B                    	jz	short DoPrompt
  5011 00001300 B403                    	mov	ah,3				; signal fail
  5012 00001302 E9B700                  	jmp	EExit
  5013                                  
  5014                                  	; 16/04/2023
  5015                                  Abort_Process:
  5016 00001305 F606[1203]01            	test	byte [InitFlag],INITINIT ; 1	; COMMAND init interrupted?
  5017 0000130A 746C                    	jz	short AbortCont			; no, handle it normally
  5018 0000130C 803E[A202]00            	cmp	byte [PermCom],0		; are we top level process?
  5019 00001311 745A                    	jz	short JustExit			; yes, just exit
  5020                                  
  5021 00001313 BA[DC0C]                	mov	dx,PATRICIDE			; no, load ptr to error msg
  5022                                  	; 12/01/2023
  5023 00001316 E8C200                  	call	RPrint				; print it
  5024                                  	;call	RDISPMSG
  5025                                  DeadInTheWater:
  5026 00001319 EBFE                    	jmp	short DeadInTheWater		; loop until the user reboots
  5027                                  
  5028                                  DoPrompt:
  5029                                  	; 12/01/2023
  5030 0000131B B8010C                  	mov	ax,0C01h
  5031                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8) + STD_CON_INPUT ; 0C01h
  5032 0000131E CD21                    	int	21h				; get response
  5033                                  
  5034                                  ; 21/07/2024 - PCDOS 7.1 COMMAND.COM
  5035                                  %if 1
  5036                                  ;ifdef DBCS
  5037                                  	;invoke	TestKanjR			; 3/3/KK
  5038 00001320 E85A01                  	call	ITestKanj
  5039 00001323 740A                    	jz	short NotKanj			; 3/3/KK
  5040                                   
  5041                                  	;mov	ax,(STD_CON_INPUT shl 8) ; eat the 2nd byte of ECS code  3/3/KK
  5042 00001325 B80001                  	mov	ax,0100h
  5043 00001328 CD21                    	int	21h				; 3/3/KK
  5044 0000132A E8AB00                  	call	crlf				; 3/3/KK
  5045                                  	;jmp	short Ask			; 3/3/KK
  5046                                  	; 22/07/2024
  5047 0000132D EB3B                    	jmp	short AskJ
  5048                                  NotKanj:
  5049                                  ;endif
  5050                                  %endif
  5051 0000132F E8A600                  	call	crlf
  5052 00001332 E83F01                  	call	CharToUpper			; convert to upper case
  5053 00001335 B400                    	mov	ah,0				; return code for ignore
  5054 00001337 F606[9C02]20            	test	byte [Crit_Err_Info],IGNORE_ALLOWED ; 20h ; is ignore allowed?
  5055 0000133C 7406                    	jz	short User_Retry
  5056 0000133E 3A06[3A05]              	cmp	al,[IGNORE_CHAR]		; ignore?
  5057                                  	;jz	short EExitJ
  5058                                  	; 16/04/2023
  5059 00001342 7478                    	jz	short EExit
  5060                                  
  5061                                  ;	Bugbug:	optimize following code.
  5062                                  
  5063                                  User_Retry:
  5064 00001344 FEC4                    	inc	ah				; return code for retry
  5065 00001346 F606[9C02]10            	test	byte [Crit_Err_Info],RETRY_ALLOWED ; 10h ; is retry allowed?
  5066 0000134B 7406                    	jz	short User_Abort
  5067 0000134D 3A06[3905]              	cmp	al,[RETRY_CHAR]			; retry?
  5068                                  	;jz	short EExitJ
  5069                                  	; 16/04/2023
  5070 00001351 7469                    	jz	short EExit
  5071                                  User_Abort:
  5072 00001353 FEC4                    	inc	ah				; return code for abort
  5073                                  						;  (abort always allowed)
  5074 00001355 3A06[3805]              	cmp	al,[ABORT_CHAR]			; abort?
  5075 00001359 74AA                    	jz	short Abort_Process		; exit user program
  5076 0000135B FEC4                    	inc	ah				; return code for fail
  5077 0000135D F606[9C02]08            	test	byte [Crit_Err_Info],FAIL_ALLOWED ; 08h ; is fail allowed?
  5078 00001362 7406                    	jz	short AskJ
  5079 00001364 3A06[3B05]              	cmp	al,[FAIL_CHAR]			; fail?
  5080                                  	;jz	short EExitJ
  5081                                  	; 16/04/2023
  5082 00001368 7452                    	jz	short EExit
  5083                                  AskJ:
  5084 0000136A E934FF                  	jmp	Ask
  5085                                  
  5086                                  	; 12/01/2023
  5087                                  ;EExitJ:
  5088                                  	;jmp	short EExit
  5089                                  
  5090                                  JustExit:
  5091                                  	;assume	ds:DATARES
  5092                                  	; 12/01/2023
  5093 0000136D A1[3E02]                	mov	ax,[Parent]			; load real parent pid
  5094                                  	;mov	[16h],ax
  5095 00001370 A31600                  	mov	[PDB.PARENT_PID],ax		; put it back where it belongs
  5096 00001373 B8FF4C                  	mov	ax,4CFFh
  5097                                  	;mov	ax,(EXIT<<8) | 255 ; 4CFFh
  5098 00001376 CD21                    	int     21h             ; DOS - 2+ - QUIT WITH EXIT CODE (EXIT)
  5099                                  				; AL = exit code
  5100                                  AbortCont:
  5101 00001378 F606[9202]FF            	test	byte [In_Batch],-1		; Are we accessing a batch file?
  5102 0000137D 7405                    	jz	short Not_Batch_Abort
  5103 0000137F C606[9302]01            	mov	byte [Batch_Abort],1		; set flag for abort
  5104                                  
  5105                                  Not_Batch_Abort:
  5106 00001384 8A16[1303]              	mov	dl,[PipeFlag]
  5107 00001388 E87CFA                  	call	ResPipeOff
  5108 0000138B 08D2                    	or	dl,dl
  5109 0000138D 740D                    	je	short CheckForA
  5110 0000138F 833E[A502]00            	cmp	word [SingleCom],0
  5111 00001394 7406                    	je	short CheckForA
  5112 00001396 C706[A502]FFFF          	mov	word [SingleCom],-1		; make sure SingleCom exits
  5113                                  
  5114                                  CheckForA:
  5115 0000139C 833E[4402]00            	cmp	word [ErrCd_24],0		; write protect?
  5116 000013A1 7407                    	je	short abortfor
  5117 000013A3 833E[4402]02            	cmp	word [ErrCd_24],2		; drive not ready?
  5118 000013A8 7512                    	jne	short EExit			; don't abort the FOR
  5119                                  
  5120                                  abortfor:
  5121 000013AA C606[AB02]00            	mov	byte [ForFlag],0		; abort a FOR in progress
  5122 000013AF 833E[A502]00            	cmp	word [SingleCom],0
  5123 000013B4 7406                    	je	short EExit
  5124 000013B6 C706[A502]FFFF          	mov	word [SingleCom],-1		; make sure SingleCom exits
  5125                                  
  5126                                  EExit:
  5127 000013BC 88E0                    	mov	al,ah
  5128 000013BE 89FA                    	mov	dx,di
  5129                                  RestHd:
  5130 000013C0 E88EFC                  	call    RestHand
  5131 000013C3 59                      	pop	cx
  5132 000013C4 5E                      	pop	si				; restore registers
  5133 000013C5 07                      	pop	es
  5134                                  
  5135                                  	; 12/01/2023	
  5136                                  	; MSDOS 6.0
  5137                                  ;;	pop	ds
  5138                                  ;SR;
  5139                                  ;ds has to be got from the variable we saved it in
  5140                                  
  5141 000013C6 8E1E[2E05]               	mov	ds,[OldDS]			; restore old value of ds
  5142                                  
  5143                                  ;	pop	ds
  5144                                  ;	assume	ds:nothing
  5145                                  
  5146                                  	; MSDOS 3.3
  5147                                  	;pop	ds
  5148                                  
  5149 000013CA CF                      	iret
  5150                                  
  5151                                  FatErr:
  5152                                  	; 12/01/2023
  5153                                  	; MSDOS 6.0
  5154                                  	;mov	dx,offset DATARES:BadFatMsg
  5155                                  	;mov	si,offset DATARES:BadFatSubst
  5156 000013CB BA[B605]                	mov	dx,BADFATMSG
  5157 000013CE BE[2602]                	mov	si,BadFatSubst
  5158 000013D1 E80700                  	call	RPrint
  5159                                  
  5160                                  	; MSDOS 3.3
  5161                                  	;mov	dx,BADFATMSG
  5162                                  	;call	RDISPMSG
  5163                                  	;mov	dx,BLKDEVERR
  5164                                  	;call	RDISPMSG
  5165                                  
  5166 000013D4 B002                    	mov	al,2				; abort
  5167 000013D6 EBE8                    	jmp	short RestHd
  5168                                  
  5169                                  ;DskErr	endp
  5170                                  
  5171                                  	; MSDOS 6.0
  5172                                  ; ----------------------------------------------------------------------------
  5173                                  ;***	RPrint - print message
  5174                                  ;***	Crlf - display cr/lf
  5175                                  ;
  5176                                  ;	ENTRY	DS:DX = ptr to count byte, followed by message text
  5177                                  ;		DS:SI = ptr to 1st substitution block for this msg, if any
  5178                                  ;		variable fields related to substitution blocks are set
  5179                                  ;
  5180                                  ;	EXIT	nothing
  5181                                  ;
  5182                                  ;	USED	flags
  5183                                  ;
  5184                                  ;	EFFECTS
  5185                                  ;	  Message is displayed on stdout.
  5186                                  ;
  5187                                  ;	NOTE
  5188                                  ;	  Number of substitutions (%1, %2,...) in message text must not
  5189                                  ;	  be greater than number of substition blocks present.
  5190                                  ; ----------------------------------------------------------------------------
  5191                                  
  5192                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5193                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:13D1h (CODERES:0691h)
  5194                                  
  5195                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5196                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:14F6h
  5197                                  crlf: 
  5198                                  	;mov	dx,offset DATARES:Newlin ; cheap newline
  5199                                  	; 14/01/2023
  5200 000013D8 BA[4107]                	mov	dx,NEWLINE
  5201                                  
  5202                                  ;RPrint	proc
  5203                                  ;
  5204                                  ;	assume	ds:DATARES,ss:DATARES
  5205                                  ;
  5206                                  	; 14/01/2023
  5207                                  RPrint:
  5208                                  
  5209                                  ;	Bugbug:	do we need to save all reg's?
  5210                                  
  5211 000013DB 56                      	push	si			; preserve registers
  5212 000013DC 50                      	push	ax
  5213 000013DD 53                      	push	bx
  5214 000013DE 51                      	push	cx
  5215 000013DF 52                      	push	dx
  5216                                  
  5217 000013E0 89F3                    	mov	bx,si			; DS:BX = ptr to subst block
  5218 000013E2 89D6                    	mov	si,dx			; DS:SI = ptr to count byte
  5219 000013E4 AC                      	lodsb				; AL = message length
  5220                                  					; DS:SI = ptr to message text
  5221 000013E5 31C9                    	xor	cx,cx
  5222 000013E7 88C1                    	mov	cl,al			; CX = message length
  5223 000013E9 E303                    	jcxz	rpRet
  5224                                  
  5225 000013EB E81900                  	call	RDispMsg
  5226                                  
  5227 000013EE 5A                      rpRet:	pop	dx
  5228 000013EF 59                      	pop	cx
  5229 000013F0 5B                      	pop	bx
  5230 000013F1 58                      	pop	ax
  5231 000013F2 5E                      	pop	si
  5232 000013F3 C3                      	retn
  5233                                  
  5234                                  ;RPrint	endp
  5235                                  
  5236                                  	; 14/01/2023
  5237                                  ;	; MSDOS 3.3
  5238                                  ;CRLF:
  5239                                  ;	mov     dx,NEWLIN
  5240                                  ;
  5241                                  ;RDISPMSG: ; Display message/text
  5242                                  ;	; DS:DX = ($ terminated) Message/Text address 
  5243                                  ;	push    ax
  5244                                  ;	mov     ah,STD_CON_STRING_OUTPUT ; 9
  5245                                  ;	clc
  5246                                  ;	int     21h             ; DOS - PRINT STRING
  5247                                  ;				; DS:DX -> string terminated by "$"
  5248                                  ;	pop     ax
  5249                                  ;	retn
  5250                                  
  5251                                  
  5252                                  	; MSDOS 6.0
  5253                                  ; ----------------------------------------------------------------------------
  5254                                  ;***	RPrintCrit - print critical error message
  5255                                  ;
  5256                                  ;	ENTRY	DX = extended error # (19-39)
  5257                                  ;
  5258                                  ;	EXIT	nothing
  5259                                  ;
  5260                                  ;	USED	flags
  5261                                  ;
  5262                                  ;	EFFECTS
  5263                                  ;	  Message is displayed on stdout
  5264                                  ; ----------------------------------------------------------------------------
  5265                                  
  5266                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5267                                  
  5268                                  ;RPrintCrit	proc
  5269                                  ;	assume	ds:DATARES,ss:DATARES
  5270                                  
  5271                                  	; 14/01/2023
  5272                                  RPrintCrit:
  5273 000013F4 52                      	push	dx			; preserve DX
  5274 000013F5 87DA                    	xchg	bx,dx			; BX = extended error #
  5275                                  					; DX = saved BX
  5276 000013F7 83EB13                  	sub	bx,19			; BX = critical error index, from 0
  5277 000013FA D1E3                    	shl	bx,1			; BX = offset in word table
  5278 000013FC 8B9F[DB08]              	mov	bx,[bx+CRITMSGPTRS]	; BX = ptr to error msg
  5279 00001400 87DA                    	xchg	bx,dx			; DX = ptr to error msg
  5280                                  					; BX = restored
  5281 00001402 E8D6FF                  	call	RPrint			; print the message
  5282 00001405 5A                      	pop	dx			; restore DX
  5283 00001406 C3                      	retn
  5284                                  
  5285                                  ;RPrintCrit	endp
  5286                                  
  5287                                  ; ----------------------------------------------------------------------------
  5288                                  ;***	RDispMsg - display message
  5289                                  ;
  5290                                  ;	Display message, with substitutions, for RPrint.
  5291                                  ;
  5292                                  ;	ENTRY	DS:SI = ptr to message text
  5293                                  ;		CX = message length
  5294                                  ;		DS:BX = ptr to substitution block, if any
  5295                                  ;
  5296                                  ;	EXIT	nothing
  5297                                  ;
  5298                                  ;	USED	AX,CX,DX,SI
  5299                                  ; ----------------------------------------------------------------------------
  5300                                  
  5301                                  ;RDispMsg	proc
  5302                                  ;	assume	ds:DATARES,ss:DATARES
  5303                                  
  5304                                  RDispMsg:
  5305                                  	; 14/01/2023
  5306                                  rdNextChar:
  5307 00001407 AC                      	lodsb				; AL = next char
  5308 00001408 3C25                    	cmp	al,'%'
  5309 0000140A 7511                    	jne	short rdOutChar		; not a substitution
  5310 0000140C 8A14                    	mov	dl,[si]			; DL = possible '1' - '9'
  5311 0000140E 80EA31                  	sub	dl,'1'			; DL = 0 - 8 = '1' - '9'
  5312 00001411 80FA09                  	cmp	dl,9
  5313 00001414 7307                    	jae	short rdOutChar		; not a substitution
  5314                                  
  5315                                  ;*	A substitution code %1 - %9 has been encountered.
  5316                                  ;	DL = 0-8, indicating %1-%9
  5317                                  ;	DS:BX = ptr to substitution block
  5318                                  
  5319 00001416 E80D00                  	call	SubstMsg		; display the substitution
  5320 00001419 46                      	inc	si			; SI = ptr past %n
  5321 0000141A 49                      	dec	cx			; count extra character in %n
  5322 0000141B EB06                    	jmp	short rdCharDone
  5323                                  
  5324                                  ;*	Normal character output.
  5325                                  
  5326                                  rdOutChar:
  5327 0000141D 88C2                    	mov	dl,al			; DL = char
  5328 0000141F B402                    	mov	ah,2			; AH = DOS Character Output code
  5329 00001421 CD21                    	int	21h			; call DOS
  5330                                  rdCharDone:
  5331 00001423 E2E2                    	loop	rdNextChar
  5332 00001425 C3                      	retn
  5333                                  
  5334                                  ;RDispMsg	endp
  5335                                  
  5336                                  ; ----------------------------------------------------------------------------
  5337                                  ;***	SubstMsg - display message substitution
  5338                                  ;
  5339                                  ;	Display a substitution string within a message.
  5340                                  ;	Substitution can be a char, an ASCIIZ string, or
  5341                                  ;	a word to be displayed as hex digits.
  5342                                  ;
  5343                                  ;	ENTRY	DL = substitution index 0-8 (for codes %1-%9)
  5344                                  ;		DS:BX = ptr to substitution block
  5345                                  ;
  5346                                  ;	EXIT	nothing
  5347                                  ;
  5348                                  ;	USED	AX,DX
  5349                                  ; ----------------------------------------------------------------------------
  5350                                  
  5351                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5352                                  
  5353                                  ;SubstMsg	proc
  5354                                  ;	assume	ds:DATARES,ss:DATARES
  5355                                  	
  5356                                  	; 14/01/2023
  5357                                  SubstMsg:
  5358 00001426 53                      	push	bx			; preserve BX
  5359 00001427 51                      	push	cx			; preserve CX
  5360                                  
  5361                                  	;mov	al,size SUBST		; AL = size of substitution block
  5362 00001428 B003                    	mov	al,3
  5363 0000142A F6E2                    	mul	dl			; AX = offset of desired subst block
  5364 0000142C 01C3                    	add	bx,ax			; DS:BX = ptr to desired subst block
  5365                                  
  5366                                  	;mov	al,[bx].SubstType	; AX = substitution type flag
  5367 0000142E 8A07                    	mov	al,[bx]
  5368                                  	;mov	bx,[bx].SubstPtr	; BX = ptr to char, str, or hex value
  5369 00001430 8B5F01                  	mov	bx,[bx+1]
  5370                                  
  5371                                  ;	AL = 1, 2, or 3 for char, string, or hex type
  5372                                  
  5373 00001433 FEC8                    	dec	al
  5374 00001435 7428                    	jz	short smChar
  5375 00001437 FEC8                    	dec	al
  5376 00001439 742C                    	jz	short smStr
  5377                                  
  5378                                  ;*	Hex number substitution.
  5379                                  
  5380                                  	;mov	ax,ds:[bx]		; AX = word value
  5381 0000143B 8B07                    	mov	ax,[bx]
  5382 0000143D B90400                  	mov	cx,4			; CX = # digits to display
  5383                                  smDigit:
  5384 00001440 D1C0                    	rol	ax,1
  5385 00001442 D1C0                    	rol	ax,1
  5386 00001444 D1C0                    	rol	ax,1
  5387 00001446 D1C0                    	rol	ax,1			; AL<3:0> = next digit
  5388                                  
  5389 00001448 50                      	push	ax			; save other digits
  5390 00001449 240F                    	and	al,0Fh			; AL = binary digit
  5391 0000144B 0430                    	add	al,'0'			; AL = ascii digit if 0-9
  5392 0000144D 3C39                    	cmp	al,'9'
  5393 0000144F 7602                    	jbe	short smDigit09		; it's 0-9
  5394                                  	;add	al,7
  5395 00001451 0407                    	add	al,('A' - '0') - 10	; AL = ascii digit A-F
  5396                                  smDigit09:
  5397 00001453 88C2                    	mov	dl,al			; DL = ascii digit
  5398 00001455 B402                    	mov	ah,2
  5399 00001457 CD21                    	int	21h			; output the ascii digit
  5400 00001459 58                      	pop	ax			; restore all digits
  5401                                  
  5402 0000145A E2E4                    	loop	smDigit
  5403                                  	;jmp	short smRet
  5404                                  	; 14/01/2023
  5405                                  smRet:	
  5406 0000145C 59                      	pop	cx
  5407 0000145D 5B                      	pop	bx
  5408 0000145E C3                      	retn
  5409                                  
  5410                                  ;*	Char substitution.
  5411                                  
  5412                                  smChar:
  5413                                  	;mov	dl,ds:[bx]		; DL = char to output
  5414 0000145F 8A17                    	mov	dl,[bx]
  5415 00001461 B402                    	mov	ah,2
  5416 00001463 CD21                    	int	21h
  5417 00001465 EBF5                    	jmp	short smRet
  5418                                  
  5419                                  ;*	String substitution.
  5420                                  
  5421                                  smStr:
  5422                                  	;mov	dl,ds:[bx]		; DL = next char
  5423 00001467 8A17                    	mov	dl,[bx]
  5424 00001469 08D2                    	or	dl,dl
  5425 0000146B 74EF                    	jz	short smRet		; null char - we're done
  5426 0000146D B402                    	mov	ah,2
  5427 0000146F CD21                    	int	21h			; display char
  5428 00001471 43                      	inc	bx			; DS:BX = ptr to next char
  5429 00001472 EBF3                    	jmp	short smStr
  5430                                  
  5431                                  ;smRet:	pop	cx
  5432                                  ;	pop	bx
  5433                                  ;	retn
  5434                                  
  5435                                  ;SubstMsg	endp
  5436                                  
  5437                                  	; MSDOS 6.0
  5438                                  ; ----------------------------------------------------------------------------
  5439                                  ;***	CharToUpper - convert character to uppercase
  5440                                  ;
  5441                                  ;	ENTRY	AL = char
  5442                                  ;
  5443                                  ;	EXIT	AL = uppercase char
  5444                                  ;
  5445                                  ;	USED	AX
  5446                                  ; ----------------------------------------------------------------------------
  5447                                  
  5448                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5449                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
  5450                                  
  5451                                  ;CharToUpper	proc
  5452                                  ;	assume	ds:DATARES
  5453                                  CharToUpper:
  5454 00001474 50                      	push	ax		; put char on stack as arg to int 2F
  5455 00001475 B81312                  	mov	ax,1213h	; AX = DOS int 2F 'Convert Char to Uppercase'
  5456 00001478 CD2F                    	int	2Fh
  5457 0000147A 44                      	inc	sp		; throw away old char on stack
  5458 0000147B 44                      	inc	sp
  5459 0000147C C3                      	retn
  5460                                  
  5461                                  ;CharToUpper	endp
  5462                                  
  5463                                  	; 14/01/2023
  5464                                  ;	; MSDOS 3.3
  5465                                  ;CHARTOUPPER:
  5466                                  ;	cmp	al,80h
  5467                                  ;	jb	short CHARTOUPPER1
  5468                                  ;	sub	al,80h
  5469                                  ;	push	ds
  5470                                  ;	push	bx
  5471                                  ;	lds	bx,[UPPERCASETBL]
  5472                                  ;	add	bx,2
  5473                                  ;	xlat
  5474                                  ;	pop	bx
  5475                                  ;	pop	ds
  5476                                  ;	jmp	short CHARTOUPPER_RETN
  5477                                  ;CHARTOUPPER1:
  5478                                  ;	cmp	al,'a'
  5479                                  ;	jb	short CHARTOUPPER_RETN
  5480                                  ;	cmp	al,'z'
  5481                                  ;	ja	short CHARTOUPPER_RETN
  5482                                  ;	sub	al,20h
  5483                                  ;CHARTOUPPER_RETN:
  5484                                  ;	retn
  5485                                  
  5486                                  ; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5487                                  ; ----------------------------------------------------------------------------
  5488                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:159Dh
  5489                                  
  5490                                  ;ifdef	DBCS
  5491                                  %if 1
  5492                                  
  5493                                  ;***	ITestKanj - DBCS lead byte check
  5494                                  
  5495                                  ITestKanj:
  5496                                  TestKanjR:				; 3/3/KK
  5497 0000147D 1E                      	push	ds
  5498 0000147E 56                      	push	si
  5499 0000147F 50                      	push	ax
  5500 00001480 C536[BA02]              	lds	si,[Dbcs_Vector_Addr]
  5501                                  ktLop:
  5502 00001484 833C00                  	cmp	word [si],0		; end of Lead Byte Table
  5503 00001487 740C                    	je	short NotLead
  5504                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
  5505                                  	;pop	ax
  5506                                  	;push	ax
  5507 00001489 3A04                    	cmp	al,[si]
  5508 0000148B 7208                    	jb	short NotLead
  5509 0000148D 46                      	inc	si
  5510 0000148E 3A04                    	cmp	al,[si]
  5511 00001490 7607                    	jbe	short IsLead
  5512 00001492 46                      	inc	si
  5513 00001493 EBEF                    	jmp	short ktLop		; try another range
  5514                                  NotLead:
  5515 00001495 31C0                    	xor	ax,ax			; set zero
  5516 00001497 EB03                    	jmp	short ktRet
  5517                                  IsLead:
  5518 00001499 31C0                    	xor	ax,ax			; reset zero
  5519 0000149B 40                      	inc	ax
  5520                                  ktRet:
  5521 0000149C 58                      	pop	ax
  5522 0000149D 5E                      	pop	si
  5523 0000149E 1F                      	pop	ds
  5524 0000149F C3                      	retn
  5525                                  
  5526                                  %endif
  5527                                  ;endif
  5528                                  
  5529                                  ; ----------------------------------------------------------------------------
  5530                                  
  5531                                  ;public	EndCode
  5532                                  ;EndCode label byte
  5533                                  
  5534                                  	; MSDOS 6.0
  5535                                  ; ----------------------------------------------------------------------------
  5536                                  ;***	MsgInt2fHandler - int 2f handler for message retrieval
  5537                                  ;
  5538                                  ;	ENTRY	If we handle it -
  5539                                  ;		  AX = ((MULTDOS shl 8) or MESSAGE_2F) = 122Eh
  5540                                  ;		  DL = operation =
  5541                                  ;		     0 = get extended error messages
  5542                                  ;		     1 = set extended error messages
  5543                                  ;		     2 = get parse error messages
  5544                                  ;		     3 = set parse error messages
  5545                                  ;		     4 = get critical error messages
  5546                                  ;		     5 = set critical error messages
  5547                                  ;		     6 = get file system error messages
  5548                                  ;		     7 = set file system error messages
  5549                                  ;		     8 = get disk retriever routine
  5550                                  ;		     9 = set disk retriever routine
  5551                                  ;		  ES:DI = address for 'set' operations
  5552                                  ;
  5553                                  ;	EXIT	ES:DI = ptr to list of message ptrs, for 'get' operations
  5554                                  ;
  5555                                  ;	NOTE
  5556                                  ;	  This handler replaces the one that used to reside in DOS.
  5557                                  ;	  'Set' operations are ignored.
  5558                                  ;	  'File system error messages' are not supported.
  5559                                  ; ----------------------------------------------------------------------------
  5560                                  
  5561                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5562                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1478h (CODERES:0738h)
  5563                                  
  5564                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  5565                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1588h (CODERES:0738h)
  5566                                  
  5567                                  ;SR;
  5568                                  ;At the int 2fh entry point we push the old ds value and the resident data
  5569                                  ;segment address. Get them off the stack
  5570                                  
  5571                                  ;MsgInt2fHandler proc	far
  5572                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  5573                                  
  5574                                  	; 14/01/2023
  5575                                  MsgInt2fHandler:
  5576 000014A0 1F                      	pop	ds			; ds = DATARES
  5577                                  	;assume	ds:DATARES
  5578                                  ;	pop	word [OldDS]		; save old value of ds
  5579                                  
  5580 000014A1 3D2E12                  	cmp	ax,122Eh
  5581                                  	;cmp	ax,(MULTDOS<<8)|MESSAGE_2F
  5582                                  	;;cmp	ax,(MULTDOS shl 8) or MESSAGE_2F
  5583 000014A4 742A                    	je	short miOurs		; it's ours
  5584                                  
  5585                                  ;ifndef ROMDOS
  5586                                  	;cmp	ax,5500h
  5587 000014A6 3D0055                  	cmp	ax,GET_COMMAND_STATE	; is it first COMMAND query?
  5588                                  ;else
  5589                                  ;	cmp	ax,GET_ROMCOMMAND_STATE	; is it first ROM COMMAND query?
  5590                                  ;endif	;ROMDOS
  5591 000014A9 741C                    	je	short fcOurs
  5592                                  
  5593                                  ;SR;
  5594                                  ;We cannot do a far jump any more because cs cannot be used. Push the cs:ip
  5595                                  ;onto the stack and do a far return to jump to the next 2fh handler. 
  5596                                  ;Our old ds is on the stack. We need to restore it but we cannot lose the
  5597                                  ;current value of ds as it points at the data segment. So we do some kinky
  5598                                  ;stack manipulations.
  5599                                  
  5600 000014AB 50                      	push	ax
  5601 000014AC 50                      	push	ax			; create 2 words on stack for retf
  5602                                  
  5603 000014AD 55                      	push	bp
  5604 000014AE 50                      	push	ax
  5605                                  
  5606 000014AF 89E5                    	mov	bp,sp			; bp can be used to address stack
  5607                                  
  5608                                  ;Swap the old ds value with the second dummy word on the stack. Now, we can
  5609                                  ;do a 'pop ds' at the end to restore our ds
  5610                                  
  5611 000014B1 8B4608                  	mov	ax,[bp+8]		; ax = old ds value
  5612 000014B4 894604                  	mov	[bp+4],ax
  5613                                  	
  5614                                  	;mov	ax,word ptr ds:Int2fHandler+2
  5615 000014B7 A1[B004]                	mov	ax,[Int2fHandler+2]
  5616 000014BA 894608                  	mov	[bp+8],ax		; put segment address
  5617                                  	;mov	ax,word ptr ds:Int2fHandler
  5618 000014BD A1[AE04]                	mov	ax,[Int2fHandler]
  5619 000014C0 894606                  	mov	[bp+6],ax		; put offset address
  5620                                  
  5621 000014C3 58                      	pop	ax
  5622 000014C4 5D                      	pop	bp
  5623 000014C5 1F                      	pop	ds
  5624                                  
  5625 000014C6 CB                      	retf				; chain on to next handler
  5626                                  
  5627                                  ;;	jmp	Int2fHandler		; hand off to next 2f handler
  5628                                  
  5629                                  fcOurs:
  5630                                  
  5631                                  ;We have to clear ax, and return in ds:si a pointer to the stub jump table
  5632                                  
  5633 000014C7 58                      	pop	ax			; discard ds currently on stack
  5634 000014C8 1E                      	push	ds			; store our data segment
  5635                                  
  5636                                  	;mov	si,offset DATARES:Int2f_Entry ; start of table
  5637 000014C9 BE[6600]                	mov	si,Int2f_Entry
  5638                                  
  5639 000014CC 31C0                    	xor	ax,ax			; indicate COMMAND present
  5640 000014CE EB11                    	jmp	short miRet		; return to caller
  5641                                  
  5642                                  miOurs:
  5643 000014D0 F6C201                  	test	dl,1
  5644 000014D3 750C                    	jnz	short miRet		; ignore 'set' operations
  5645                                  
  5646 000014D5 53                      	push	bx			; preserve BX
  5647 000014D6 89D3                    	mov	bx,dx
  5648 000014D8 30FF                    	xor	bh,bh			; BX = index in word table
  5649 000014DA D1E3                    	shl	bx,1			; BX = index in dword table
  5650                                  	;les	di,MsgPtrLists[bx]	; ES:DI = ptr to msg ptr list
  5651 000014DC C4BF[4407]              	les	di,[bx+MsgPtrLists]
  5652 000014E0 5B                      	pop	bx			; restore BX
  5653                                  miRet:
  5654                                  ;	mov	ds,[OldDS]		; restore ds
  5655 000014E1 1F                      	pop	ds
  5656                                  	;assume	ds:nothing
  5657                                  
  5658 000014E2 CF                      	iret
  5659                                  
  5660                                  ;MsgInt2fHandler endp
  5661                                  
  5662                                  	; MSDOS 6.0
  5663                                  ; ----------------------------------------------------------------------------
  5664                                  ;***	MsgRetriever - message retrieval routine for utilities
  5665                                  ;
  5666                                  ;	Address of this routine is passed to utility programs via 
  5667                                  ;	message services int 2f. We try to find the desired message
  5668                                  ;	in memory or in our disk image.
  5669                                  ;
  5670                                  ;	ENTRY	AX = message #
  5671                                  ;		DI = offset in RESGROUP of msg ptr list
  5672                                  ;		ComSpec = asciiz pathname to our disk image
  5673                                  ;
  5674                                  ;	EXIT	CY clear for success
  5675                                  ;		ES:DI = ptr to count byte, followed by message text
  5676                                  ;
  5677                                  ;		CY set for failure
  5678                                  ;		ES,DI undefined
  5679                                  ;
  5680                                  ;	USED	flags
  5681                                  ;
  5682                                  ;	NOTE
  5683                                  ;	  The message # in AX is used to compute an offset into
  5684                                  ;	  the message ptr list pointed to by DI. The lists must
  5685                                  ;	  start with message # 1 and proceed through consecutive
  5686                                  ;	  message #'s.  
  5687                                  ;
  5688                                  ;	  It is assumed that the msg ptr list is either ParsMsgPtrs or
  5689                                  ;	  ExtMsgPtrs. We use NUMPARSEMSGS and NUMEXTMSGS to check for
  5690                                  ;	  valid message #.  ;M033
  5691                                  ;
  5692                                  ;	  List positions with no corresponding message text are
  5693                                  ;	  indicated by null pointers, which this routine detects.
  5694                                  ; ----------------------------------------------------------------------------
  5695                                  
  5696                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5697                                  
  5698                                  ;SR; This routine will be called directly by the utilities. So, we have
  5699                                  ; trap for it in the stub. The stub pushes the old value of ds and the 
  5700                                  ; DATARES value on the stack. We get them off the stack to setup ds here
  5701                                  
  5702                                  ;MsgRetriever	proc	far
  5703                                  ;	assume	cs:CODERES,ds:NOTHING,es:NOTHING,ss:NOTHING
  5704                                  
  5705                                  	; 14/01/2023
  5706                                  MsgRetriever:
  5707 000014E3 1F                      	pop	ds			; ds = DATARES
  5708                                  	;assume	ds:DATARES
  5709                                  ;	pop	word [OldDS]		; save old ds
  5710                                  
  5711 000014E4 50                      	push	ax			; preserve registers
  5712 000014E5 53                      	push	bx
  5713 000014E6 51                      	push	cx
  5714 000014E7 52                      	push	dx
  5715 000014E8 56                      	push	si
  5716                                  
  5717                                  ;;	push	ds
  5718                                  ;;	push	cs
  5719                                  ;;	pop	ds			; DS = DATARES seg addr
  5720                                  ;;	assume	ds:RESGROUP
  5721                                  ;;	push	cs
  5722                                  
  5723 000014E9 1E                      	push	ds			; get es from ds
  5724 000014EA 07                      	pop	es			; ES = DATARES seg addr
  5725                                  
  5726                                  ;	Begin modification M033.
  5727                                  
  5728                                  ;	Make sure msg # is valid.
  5729                                  ;	Assume msg ptr list is either ParsMsgPtrs or ExtMsgPtrs.
  5730                                  
  5731                                  	;mov	bx,11
  5732 000014EB BB0B00                  	mov	bx,NUMPARSMSGS		; BX = # parse error msgs in list
  5733                                  	;cmp	di,offset DATARES:ParsMsgPtrs
  5734 000014EE 81FF[E309]              	cmp	di,PARSMSGPTRS
  5735 000014F2 7403                    	je	short chkmsgnum		; it's ParsMsgPtrs
  5736                                  	;mov	bx,90
  5737 000014F4 BB5A00                  	mov	bx,NUMEXTMSGS		; BX = # extended error msgs in list
  5738                                  chkmsgnum:
  5739 000014F7 39C3                    	cmp	bx,ax
  5740 000014F9 725A                    	jc	short mrRet		; msg # too high, return carry
  5741                                  
  5742                                  ;	Msg # is valid.
  5743                                  
  5744                                  ;	End modification M033.
  5745                                  
  5746 000014FB 48                      	dec	ax
  5747 000014FC D1E0                    	shl	ax,1			; AX = offset into msg ptr list
  5748 000014FE 01C7                    	add	di,ax			; DI = ptr to msg ptr
  5749                                  
  5750 00001500 81FF[B204]              	cmp	di,ResMsgEnd
  5751 00001504 7247                    	jb	short mrInMem		; ptr (and message) in memory
  5752                                  
  5753                                  ;*	Retrieve message from disk (or ROM) image.
  5754                                  ;	Read once to get the ptr to the message, then again for the message.
  5755                                  
  5756                                  ;ifndef	ROMDOS
  5757                                  	; 14/01/2023
  5758                                  	;mov	si,offset DATARES:ComSpec	; DS:SI = ptr to pathname
  5759 00001506 BE[4B02]                	mov	si,ComSpec
  5760 00001509 BA0100                  	mov	dx,1 ; EXT_EXISTS_OPEN		; DX = 'open existing file'
  5761 0000150C BB0020                  	mov	bx,2000h ; INT_24_ERROR		; BX = 'fail on crit error'
  5762 0000150F B8006C                  	mov	ax,6C00h
  5763                                  	;mov	ax,ExtOpen shl 8		; AX = 'Extended Open File'
  5764 00001512 CD21                    	int	21h				; call DOS
  5765 00001514 723F                    	jc	short mrRet			; return failure
  5766                                  
  5767 00001516 89C3                    	mov	bx,ax				; BX = file handle
  5768 00001518 89FA                    	mov	dx,di				; DX = ptr to msg ptr
  5769 0000151A 31F6                    	xor	si,si				; SI = read count
  5770                                  mrRead:
  5771 0000151C 81EA0001                	sub	dx,100h				; DX = LSW of file offset
  5772 00001520 31C9                    	xor	cx,cx				; CX = MSW of file offset
  5773 00001522 B80042                  	mov	ax,4200h
  5774                                  	;mov	ax,LSEEK shl 8			; AX = 'Set File Pointer'
  5775 00001525 CD21                    	int	21h				; call DOS
  5776 00001527 721A                    	jc	short mrCloseFile		; handle error
  5777                                  
  5778                                  	;mov	dx,offset DATARES:MsgBuffer	; DS:DX = input buffer
  5779 00001529 BA[5E04]                	mov	dx,MsgBuffer
  5780 0000152C B94000                  	mov	cx,64				; CX = # bytes to read
  5781 0000152F B43F                    	mov	ah,3Fh
  5782                                  	;mov	ah,READ				; AH = 'Read File'
  5783 00001531 CD21                    	int	21h				; call DOS
  5784 00001533 720E                    	jc	short mrCloseFile		; handle error
  5785                                  
  5786 00001535 09F6                    	or	si,si				; (CY cleared)
  5787 00001537 750A                    	jnz	short mrCloseFile		; 2nd time thru - we're done
  5788 00001539 46                      	inc	si				; mark one read done
  5789 0000153A 8B16[5E04]              	mov	dx,[MsgBuffer]			; DX = ptr to message
  5790 0000153E 09D2                    	or	dx,dx
  5791 00001540 75DA                    	jnz	short mrRead			; go read the message
  5792 00001542 F9                      	stc					; null ptr found- no msg
  5793                                  
  5794                                  mrCloseFile:
  5795 00001543 9C                      	pushf				; save success/failure (CY)
  5796 00001544 B43E                    	mov	ah,3Eh
  5797                                  	;mov	ah,CLOSE		; AH = 'Close File'
  5798 00001546 CD21                    	int	21h			; call DOS
  5799                                  ;	Bugbug: should we avoid this popf?
  5800 00001548 9D                      	popf				; CY = success/failure
  5801 00001549 89D7                    	mov	di,dx			; ES:DI = ptr to msg, if successful
  5802 0000154B EB08                    	jmp	short mrRet		; we're done
  5803                                  
  5804                                  ;else	;ROMDOS
  5805                                  ;
  5806                                  ;;	DI = ptr to msg ptr
  5807                                  ;
  5808                                  ;	mov	si,di			; SI = ptr to msg ptr
  5809                                  ;	sub	si,100h			; SI = offset into image of msg ptr
  5810                                  ;	mov	cx,2			; CX = # bytes to copy from image
  5811                                  ;
  5812                                  ;;	ASSUME ES:NOTHING is still in effect.
  5813                                  ;
  5814                                  ;	push	ds
  5815                                  ;	pop	es				; ES = DATARES seg addr
  5816                                  ;	mov	di,offset DATARES:MsgBuffer	; ES:DI = ptr to buffer
  5817                                  ;	invoke	LoadFromROM			; copy msg ptr from ROM
  5818                                  ;	mov	si,word ptr MsgBuffer		; SI = ptr to message
  5819                                  ;	or	si,si
  5820                                  ;	jz	mrNoMsg			; null ptr- no message text
  5821                                  ;
  5822                                  ;	sub	si,100h			; SI = offset into image of msg
  5823                                  ;	mov	cx,64			; CX = # bytes to copy from image
  5824                                  ;	mov	di,offset DATARES:MsgBuffer
  5825                                  ;	invoke	LoadFromROM
  5826                                  ;	clc					; success
  5827                                  ;	mov	di,offset DATARES:MsgBuffer	; ES:DI = ptr to msg
  5828                                  ;	jmp	short mrRet
  5829                                  ;
  5830                                  ;mrNoMsg:
  5831                                  ;	stc
  5832                                  ;	jmp	short mrRet
  5833                                  ;
  5834                                  ;;;	mov	ax,COMMAND_SEG-10h	; AX = seg addr of COMMAND image
  5835                                  ;;;	mov	es,ax			; ES:DI = ptr to msg ptr in image
  5836                                  ;	assume	es:NOTHING
  5837                                  ;
  5838                                  ;endif	;ROMDOS
  5839                                  
  5840                                  ;*	Message ptr is in memory.
  5841                                  ;	If ptr is in memory, assume message is in memory (/msg).
  5842                                  
  5843                                  mrInMem:
  5844                                  	; 14/01/2023
  5845 0000154D 268B3D                  	mov	di,[es:di]		; ES:DI = ptr to msg
  5846 00001550 09FF                    	or	di,di			; (CY cleared)
  5847 00001552 7501                    	jnz	short mrRet		; found message
  5848 00001554 F9                      	stc				; null ptr found - no message
  5849                                  mrRet:	
  5850 00001555 5E                      	pop	si			; restore all registers
  5851 00001556 5A                      	pop	dx
  5852 00001557 59                      	pop	cx
  5853 00001558 5B                      	pop	bx
  5854 00001559 58                      	pop	ax
  5855                                  
  5856                                  ;	mov	ds,[OldDS]		; restore ds
  5857 0000155A 1F                      	pop	ds
  5858                                  	;assume	ds:nothing
  5859                                  
  5860 0000155B CB                      	retf	; 21/04/2023
  5861                                  
  5862                                  ;MsgRetriever endp
  5863                                  
  5864                                  ; M003; Start of changes for UMB support
  5865                                  
  5866                                  ; ----------------------------------------------------------------------------
  5867                                  ;***	Lh_OffUnlink -- Restore allocation strat and link state
  5868                                  ;
  5869                                  ;	ENTRY	al = Saved alloc strat and link state
  5870                                  ;			b0 = 1 if alloc strat to restore is HighFirst
  5871                                  ;			b1 = 1 if link state to restore is Linked
  5872                                  ;
  5873                                  ;	EXIT	None
  5874                                  ;
  5875                                  ;	USED	ax, bx, cx
  5876                                  ; ----------------------------------------------------------------------------
  5877                                  
  5878                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5879                                  
  5880                                  ;public	Lh_OffUnlink
  5881                                  Lh_OffUnlink:	; proc	far
  5882                                  	; 14/01/2023
  5883 0000155C 88C5                    	mov	ch,al
  5884 0000155E 88C1                    	mov	cl,al
  5885                                  	;;mov	ax,(ALLOCOPER shl 8) OR 0
  5886                                  	;mov	ax,(ALLOCOPER<<8)
  5887 00001560 B80058                  	mov	ax,5800h
  5888 00001563 CD21                    	int	21h
  5889 00001565 89C3                    	mov	bx,ax
  5890 00001567 D0C9                    	ror	cl,1				; b7 = HighFirst bit
  5891 00001569 80E180                  	and	cl,80h				; mask off b6-b0
  5892 0000156C 80E37F                  	and	bl,7fh				; mask off HighFirst bit
  5893 0000156F 08CB                    	or	bl,cl				; set HighFirst bit state
  5894                                  	;;mov	ax,(ALLOCOPER shl 8) OR 1
  5895                                  	;mov	ax,(ALLOCOPER<<8)|1
  5896 00001571 B80158                  	mov	ax,5801h
  5897 00001574 CD21                    	int	21h				; set alloc strat
  5898                                  
  5899 00001576 88EB                    	mov	bl,ch
  5900 00001578 D0EB                    	shr	bl,1
  5901 0000157A 30FF                    	xor	bh,bh				; bx = linkstate
  5902                                  	;mov	ax,(ALLOCOPER shl 8) OR 3
  5903                                  	;mov	ax,(ALLOCOPER<<8)|3
  5904 0000157C B80358                  	mov	ax,5803h
  5905 0000157F CD21                    	int	21h				; set linkstate
  5906                                  
  5907 00001581 CB                      	retf
  5908                                  
  5909                                  ;Lh_OffUnlink endp
  5910                                  
  5911                                  ; M003; End of changes for UMB support
  5912                                  ;public	EndCode
  5913                                  ; 14/01/2023
  5914                                  ;EndCode: ; label byte
  5915                                  ; 06/06/2023
  5916                                  ; 16/04/2023
  5917                                  EndCode equ ($-StartCode)+100h
  5918                                  ; 06/06/2023
  5919                                  ;EndCode equ $-StartCode
  5920                                  
  5921                                  ;CODERES ends
  5922                                  ;	end
  5923                                  
  5924                                  ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5925                                  
  5926 00001582 00<rep Eh>              	times	(((EndCode+15)>>4)<<4)-EndCode db 0
  5927                                  
  5928                                  ;align 16
  5929                                  
  5930                                  ;=============================================================================
  5931                                  ; INIT.ASM, MSDOS 6.0 (COMMAND.COM), 1991
  5932                                  ;=============================================================================
  5933                                  ; 22/09/2018 - Retro DOS v3.0 ('command3.s')
  5934                                  
  5935                                  ; INIT.ASM (MSDOS 2.11 COMMAND.COM, Retro DOS v2.0, 30/04/2018)
  5936                                  
  5937                                  ;TITLE   COMMAND Initialization
  5938                                  
  5939                                  ;ENVIRONSIZ EQU  0A0H		; Must agree with values in ENVIRONMENT segment
  5940                                  ;ENVIRONSIZ2 EQU 092H
  5941                                  ;MAX_COMSPEC EQU ENVIRONSIZ2 ; = 146  ; 22/09/2018
  5942                                  
  5943                                  ; UINIT.ASM, MSDOS 6.0, 1991
  5944                                  ; 23/09/2018
  5945                                  ENVBIG	EQU 32768		;AN000; maximum environment size
  5946                                  ; 14/01/2023
  5947                                  ;ENVSML	EQU 160			;AN000; minimum environment size
  5948                                  
  5949                                  ; ----------------------------------------------------------------------------
  5950                                  
  5951                                  ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  5952                                  
  5953                                  ; 06/06/2023
  5954                                  ; (MSDOS 5.0 COMMAND.COM -initial- Environment Structure size)
  5955                                  ;ENVIRONSIZ equ 160
  5956                                  
  5957                                  ENVSML	equ 256	; minimum environment size
  5958                                  ;MAX_COMSPEC equ ENVIRONSIZ - Env_ComSpec
  5959                                  MAX_COMSPEC equ 146
  5960                                  ECOMSPEC equ 14
  5961                                  
  5962                                  ; 14/01/2023
  5963                                  TAB_CHAR equ 09h
  5964                                  SPACE_CHAR equ 20h	
  5965                                  
  5966                                  ; 06/06/2023
  5967                                  ; (MSDOS 6.22 COMMAND.COM -initial- Environment Structure size)
  5968                                  ;ENVIRONSIZ equ 180	; SIZE Environment
  5969                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  5970                                  ; (PCDOS 7.1 COMMAND.COM -initial- Environment Structure size)
  5971                                  ENVIRONSIZ equ 166	; SIZE Environment 
  5972                                  
  5973                                  ;----------------------------------------------------
  5974                                  ; MSDOS 6.0 - ENVDATA.ASM - 1991
  5975                                  ;----------------------------------------------------
  5976                                  ;Environment Struc	; Default COMMAND environment
  5977                                  ;
  5978                                  ;Env_PathString  db	"path="
  5979                                  ;Env_PathSpec	 db	"c:\msdos"
  5980                                  ;                db	0
  5981                                  ;Env_PrmptString db	"prompt="
  5982                                  ;Env_PrmptSpec   db	"$p$g"
  5983                                  ;                db	0
  5984                                  ;Env_ComString   db	"comspec="
  5985                                  ;Env_ComSpec     db	"\command.com"
  5986                                  ;		 db	134 dup (0)
  5987                                  ;
  5988                                  ;Environment ends
  5989                                  ;----------------------------------------------------
  5990                                  
  5991                                  ;-----------------------------------------------------------------------------
  5992                                  
  5993                                  ;-----------------------------------------------------------------------------
  5994                                  ; START OF INIT PORTION
  5995                                  ; This code is deallocated after initialization.
  5996                                  ;-----------------------------------------------------------------------------
  5997                                  
  5998                                  ;INIT	SEGMENT PUBLIC PARA
  5999                                  
  6000                                  ; 	EXTRN   HEADER:BYTE
  6001                                  ;	EXTRN   BADCOMLKMES:BYTE
  6002                                  
  6003                                  ;	PUBLIC  CONPROC
  6004                                  
  6005                                  ;ASSUME  CS:RESGROUP,DS:RESGROUP,ES:RESGROUP,SS:RESGROUP
  6006                                  
  6007                                          ;ORG 0
  6008                                  ;ZERO = $
  6009                                  	; 23/09/2018
  6010                                  ZERO equ $	; Offset 0E30h for original MSDOS 3.3 COMMAND.COM
  6011                                  
  6012                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  6013                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1560h (CODERES:0820h)
  6014                                  
  6015                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6016                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1670h (CODERES:0820h)
  6017                                  ConProc:
  6018                                  	;mov	sp,offset ResGroup:RStack	; must be first instruction
  6019 00001590 BC[2E05]                	mov	sp,RStack
  6020                                  
  6021                                  ; We need to set the PSP to us right at start because Carousel needs
  6022                                  ; to be lied to and it does not set PSP when it transfers control to
  6023                                  ; us after loading us as an overlay. By setting PSP, we ensure that
  6024                                  ; command.com is also not lied to.
  6025                                  
  6026                                  	; 14/01/2023
  6027                                  	; MSDOS 6.0
  6028 00001593 B450                            mov	ah,50h
  6029                                  	;mov	ah,SET_CURRENT_PDB
  6030 00001595 8CC3                            mov	bx,es
  6031 00001597 CD21                            int	21h
  6032                                  
  6033                                  	; 14/01/2023
  6034                                  	;mov	ah,30h 
  6035                                  	;;mov	ax,GET_VERSION<<8 ; 3000h
  6036                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6037 00001599 B80030                  	mov	ax,3000h
  6038 0000159C CD21                    	int	21h
  6039                                  	;;;cmp	ax,EXPECTED_VERSION ; 1E03h
  6040                                  	;;cmp	ax,5
  6041                                  	;cmp	ax,EXPECTED_VERSION ; 0005h
  6042                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6043 0000159E 3D070A                  	cmp	ax,EXPECTED_VERSION ; 1606h
  6044                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  6045                                  	;cmp	ax,0A07h
  6046 000015A1 7411                    	je	short okdos			; DOS version is ok
  6047                                  
  6048 000015A3 BA[6821]                	mov	dx,BADVERMSG			; DX = ptr to msg
  6049 000015A6 E832FE                  	call	RPrint
  6050                                  
  6051                                  	; MSDOS 3.3
  6052                                  	;mov	ah,STD_CON_STRING_OUTPUT ; 9
  6053                                  	;int	21h             ; DOS - PRINT STRING
  6054                                  				; DS:DX -> string terminated by "$"
  6055 000015A9 8CC0                    	mov	ax,es
  6056 000015AB 2639061600              	cmp	[es:PDB.PARENT_PID],ax
  6057                                  	;cmp	[es:16h],ax			; if COMMAND is own parent,
  6058                                  Here:	
  6059 000015B0 74FE                    	jz	short Here			;  loop forever
  6060                                  	
  6061 000015B2 CD20                    	int	20h				; otherwise, exit
  6062                                  okdos:
  6063                                  	; 23/09/2018
  6064                                  
  6065                                  ;  Calculate and save the end of the INIT segment (which is also
  6066                                  ;  the beginning of TRANGROUP).
  6067                                  
  6068                                  	; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  6069                                  	; MSDOS 3.3
  6070                                  	;mov	ah,65h
  6071                                  	;mov	al,2
  6072                                  	;mov	dx,-1
  6073                                  	;mov	bx,-1
  6074                                  	;mov	cx,5
  6075                                  	;mov	di,UCASE_ADDR
  6076                                  	;int	21h	; AH = 65h : GET EXTENDED COUNTRY INFORMATION (DOS 3.3+)
  6077                                  	;		; AL = 02h : Get pointer to character translation table
  6078                                  	;		; BX = code page (-1 = current global code page)
  6079                                  	;		; DX = country ID (-1 = current country)
  6080                                  	;		; CX = amount of data to return
  6081                                  	;; ES:DI = pointer to output buffer
  6082                                  	;; Buffer offset :
  6083                                  	;;	00h -  byte,  country Id
  6084                                  	;;  	01h -  dword, pointer to uppercase table	
  6085                                  
  6086                                  	; 14/01/2023
  6087                                  	; MSDOS 6.0 (& MSDOS 3.3)
  6088                                    	;mov	dx,232Fh     ; MSDOS 5.0 COMMAND.COM
  6089                                  	; 06/06/2023
  6090                                  	;mov	dx,26EFh     ; MSDOS 6.22 COMMAND.COM
  6091                                  	; 18/07/2024
  6092                                  	;mov	dx,289Fh     ; PCDOS 7.1 COMMAND.COM
  6093 000015B4 BAEF27                  	mov	dx,TRANSTART+15			; get end of init code
  6094                                  	; 27/09/2018
  6095                                  	;mov	dx,TRANSTART ; (paragraph aligned address)
  6096 000015B7 B104                    	mov	cl,4				; change to paragraphs
  6097 000015B9 D3EA                            shr	dx,cl				;
  6098 000015BB 8CC8                            mov     ax,cs                           ; get current segment
  6099 000015BD 01D0                            add     ax,dx                           ; calculate segment of end of init
  6100 000015BF A3[9520]                        mov     [initend],ax			; save this
  6101                                  
  6102                                  	; 14/01/2023
  6103                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1591h 
  6104                                  
  6105                                  ;  Check for /? on the command line. If found, display help text and exit.
  6106                                  ;  NOTE: this routine may terminate the program, never returning.
  6107                                  
  6108 000015C2 E8EA07                  	call	CheckHelp
  6109                                  
  6110                                  ; We have to patch the segment values for the various interrupt entry points.
  6111                                  ; This is because we need to have the default addresses of the handlers in our
  6112                                  ; stub before the relocation is done. These values will then be changed once
  6113                                  ; the resident is relocated
  6114                                  
  6115 000015C5 E81B0A                  	call	patch_segs
  6116                                  
  6117                                  ;  Turn APPEND off during initialization processing
  6118                                  
  6119                                  	; 14/01/2023
  6120 000015C8 B800B7                  	mov     ax,0B700h
  6121                                  	;mov	ax,APPENDINSTALL                ; see if append installed
  6122 000015CB CD2F                    	int	2Fh				;
  6123                                  	;cmp	al,0				; append installed?
  6124 000015CD 08C0                    	or	al,al
  6125 000015CF 7418                    	jz	short set_msg_addr		; no - continue
  6126                                  	
  6127 000015D1 B802B7                  	mov	ax,0B702h
  6128                                  	;mov	ax,APPENDDOS			; see if append DOS version right
  6129 000015D4 CD2F                    	int	2Fh				;
  6130                                  	;cmp	ax,-1				; append version correct?
  6131                                  	;jne	short set_msg_addr		; no - continue
  6132 000015D6 40                      	inc	ax ; -1 -> 0
  6133 000015D7 7510                    	jnz	short set_msg_addr        
  6134                                  	
  6135 000015D9 B806B7                  	mov     ax,0B706h
  6136                                  	;mov	ax,APPENDGETSTATE               ; Get the state of Append
  6137 000015DC CD2F                    	int	2Fh				;
  6138 000015DE 891E[BE02]                      mov     [Append_State],bx		; save append state
  6139                                         
  6140 000015E2 31DB                    	xor	bx,bx                           ; clear out state
  6141 000015E4 B807B7                  	mov	ax,0B707h
  6142                                  	;mov	ax,APPENDSETSTATE               ; Set the state of Append
  6143 000015E7 CD2F                    	int	2Fh				; set everything off
  6144                                  
  6145                                  set_msg_addr:
  6146                                  	; 14/01/2023
  6147                                  	;;mov	di,offset resgroup:DataresEnd 	; get address of resident end
  6148                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:15BAh) 
  6149                                  	;mov	di,093Eh  ; mov di,PAERRMSG0 ; MSDOS 5.0 COMMAND.COM
  6150                                  	; 06/06/2023
  6151                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:16CBh) 
  6152                                  	;mov	di,0A41h  ; mov di,PAERRMSG0 ; MSDOS 6.22 COMMAND.COM
  6153                                  	; 18/07/2024
  6154                                  	;mov	di,9F3h   ; mov di,PAERRMSG0 ; PCDOS 7.1 COMMAND.COM	
  6155 000015E9 BF[0509]                	mov	di,DataresEnd
  6156 000015EC 893E[B204]              	mov	[ResMsgEnd],di			; save it
  6157                                  
  6158 000015F0 E8020A                          call    get_XMMAddr                     ; get XMM call address
  6159                                  
  6160                                  ; Check if this is the first instance of command.com. If not, we just exit
  6161                                  ; this routine without moving any code.
  6162                                  ; After the int 2fh, ds:si points at the resident jump table in the previous
  6163                                  ; stub. We just have to copy this over
  6164                                  	
  6165                                  ;ifndef ROMDOS
  6166 000015F3 B80055                  	mov	ax,5500h
  6167                                  	;mov	ax,GET_COMMAND_STATE	
  6168                                  ;else
  6169                                  ;	mov	ax,GET_ROMCOMMAND_STATE	
  6170                                  ;endif ; ROMDOS
  6171                                  
  6172 000015F6 CD2F                    	int	2Fh	;  (Int 2Fh/AX=5500h - DOS 5+ - COMMAND.COM INTERFACE)
  6173                                  	;assume	ds:nothing
  6174                                  
  6175                                  	; 03/05/2023
  6176                                  	; Return:
  6177                                  	;   AX = 0000h if an instance of COMMAND.COM is already running
  6178                                  	;   DS:SI -> entry point table
  6179                                  
  6180                                  	; (si = offset Int2f_Entry)  ; (('MsgInt2fHandler:', 'fcOurs:'))
  6181                                  
  6182 000015F8 09C0                    	or	ax,ax
  6183 000015FA 750C                    	jnz	short first_com			; this is the first instance
  6184                                  
  6185                                  	; 14/01/2023
  6186 000015FC 268936[9A26]            	mov	[es:ResJmpTable],si		; save old stub jump table
  6187 00001601 268C1E[9C26]            	mov	[es:ResJmpTable+2],ds
  6188 00001606 EB06                    	jmp	short init_cntry
  6189                                  
  6190                                  first_com:
  6191 00001608 26C606[9E26]01          	mov	byte [es:FirstCom],1		; indicate first command.com
  6192                                  
  6193                                  init_cntry:
  6194                                  	; 14/01/2023
  6195 0000160E 06                      	push	es
  6196 0000160F 1F                      	pop	ds
  6197                                  	;assume	ds:RESGROUP
  6198                                  
  6199 00001610 B465                    	mov	ah,65h
  6200                                  	;mov	ah,GETEXTCNTRY			; get extended country info
  6201 00001612 B004                    	mov	al,4				; get file ucase table
  6202 00001614 BAFFFF                  	mov	dx,-1				;
  6203                                  	;mov	bx,-1				;
  6204 00001617 89D3                    	mov	bx,dx
  6205 00001619 B90500                  	mov	cx,5				; number of bytes we want
  6206                                  	;mov	di,offset resgroup:FUCase_Addr	; buffer for address
  6207 0000161C BF[B502]                	mov	di,FUCase_Addr
  6208 0000161F CD21                    	int	21h
  6209                                  		; DOS - 4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
  6210                                  		; AL = function -
  6211                                  
  6212                                  ;	Bugbug:	conditionalize dbcs_vector stuff?
  6213                                  
  6214 00001621 1E                      	push	ds				;
  6215 00001622 B80063                  	mov	ax,6300h
  6216                                  	;mov	ax,(ECS_CALL shl 8) or GETLEADBTBL ;
  6217 00001625 CD21                    	int	21h				;
  6218                                  		; DOS - 3.2+ only - GET DOUBLE BYTE CHARACTER SET LEAD TABLE
  6219                                  			
  6220 00001627 8CDB                    	mov	bx,ds				; get segment to bx
  6221 00001629 1F                      	pop	ds				;
  6222 0000162A 8936[BA02]              	mov	[Dbcs_Vector_Addr],si		; save address of
  6223 0000162E 891E[BC02]              	mov	[Dbcs_Vector_Addr+2],bx		; dbcs vector
  6224                                  
  6225                                  	;mov	ax,[16h]
  6226 00001632 A11600                  	mov	ax,[PDB.PARENT_PID]
  6227                                  				; mov ax,ds:16h	; Init PARENT so we can exit
  6228 00001635 A3[3E02]                	mov	[Parent],ax			;  correctly.
  6229 00001638 A10A00                  	mov	ax,[PDB.EXIT]   ; mov ax,ds:0Ah
  6230 0000163B A3[4002]                	mov	[OldTerm],ax
  6231 0000163E A10C00                  	mov	ax,[PDB.EXIT+2] ; mov ax,ds:0Ch
  6232 00001641 A3[4202]                	mov	[OldTerm+2],ax
  6233                                  
  6234                                  	; 14/01/2023
  6235                                  	;;;mov	ax,offset ResGroup:EndCode + 15
  6236                                  	;;mov	ax,1569h	; MSDOS 5.0 COMMAND.COM
  6237                                  	; 06/06/2023
  6238                                  	;mov	ax,1679h	; MSDOS 6.22 COMMAND.COM
  6239                                  	; 18/07/2024
  6240                                  	;mov	ax,16B3h	; PCDOS 7.1 COMMAND.COM
  6241                                  	
  6242                                  	;mov	ax,EndCode+15
  6243                                  	;;mov	ax,INITSTART+15 ; 24/09/2018
  6244                                  	; 14/01/2023
  6245                                  	;mov	cl,4				; ax = size of resident part of
  6246                                  	;shr	ax,cl				;  command in paragraphs. Add
  6247                                  	;mov	cx,cs				;  this to CS and you get the
  6248                                  	;add	ax,cx				;  segment of the TPA.
  6249                                  
  6250 00001644 8CC8                    	mov	ax,cs
  6251 00001646 056901                  	add	ax,(EndCode+15)>>4
  6252                                  	
  6253 00001649 A3[5804]                	mov	[Res_Tpa],ax			; Temporarily save the TPA segment
  6254 0000164C 2500F0                  	and	ax,0F000h
  6255 0000164F 050010                  	add	ax,1000h			; Round up to next 64K boundary
  6256 00001652 7303                    	jnc	short TpaSet			; Memory wrap if carry set
  6257 00001654 A1[5804]                	mov	ax,[Res_Tpa]
  6258                                  TpaSet:
  6259 00001657 A3[4C04]                	mov	[LTpa],ax			; Good enough for the moment
  6260                                  	;mov	ax,[2]
  6261 0000165A A10200                  	mov	ax,[PDB.BLOCK_LEN]		; ax = # of paras given to command
  6262                                  
  6263 0000165D 8C1E[5204]              	mov	[MySeg1],ds			; These 3 variables are used as part of
  6264 00001661 8C1E[5604]              	mov	[MySeg2],ds			;  3 long ptrs that the transient will
  6265 00001665 8C1E[4A04]              	mov	[MySeg],ds			;  use to call resident routines.
  6266                                  	; 19/04/2023
  6267                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1641h
  6268 00001669 8C1E[5607]              	mov	[MySeg3],ds			; segment of msg retriever routine 
  6269                                  
  6270 0000166D A3[9502]                	mov	[MemSiz],ax			; Needed for execing other programs
  6271                                  
  6272                                  	; 14/01/2023 - Retro DOS v4.0 COMMAND.COM
  6273                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1648h
  6274                                  
  6275                                  ; First reallocate the COMMAND size to its memory image
  6276                                  	
  6277 00001670 50                      	push	ax    
  6278                                    	;;;mov	bx,2320h  ; MSDOS 5.0 COMMAND.COM
  6279                                  	;;mov	bx,offset RESGROUP:TranStart    ;
  6280                                  	;mov	bx,TRANSTART
  6281                                  	;;add	bx,98C5h  ; MSDOS 5.0 COMMAND.COM
  6282                                          ;add	bx,offset TRANGROUP:TranSpaceEnd;
  6283                                  	;add	bx,15 ; *			; round up the size
  6284                                  	; 06/06/2023
  6285                                  	;mov	bx,26E0h  ; MSDOS 6.22 COMMAND.COM ; mov bx,offset RESGROUP:TranStart
  6286                                  	;add	bx,0AF95h ; MSDOS 6.22 COMMAND.COM ; add bx,offset TRANGROUP:TranSpaceEnd
  6287                                  	;add	bx,15 ; *			; round up the size
  6288                                  
  6289                                  	; 03/05/2023
  6290                                  	;mov	bx,TRANSTART+15 ; * ; 14/01/2023
  6291                                  	;add	bx,TRANSPACEEND
  6292                                  	; 06/06/2023
  6293                                  	;mov	bx,TRANSTART+TRANSPACEEND+15 
  6294                                          ;mov	cl,4				;
  6295                                          ;shr	bx,cl				; size of command.com
  6296 00001671 BBE50C                  	mov	bx,(TRANSTART+TRANSPACEEND+15)>>4
  6297                                  
  6298 00001674 B44A                    	mov	ah,4Ah
  6299                                  	;mov	ah,SETBLOCK			; free all memory above pgm
  6300 00001676 CD21                            int     21h				;
  6301 00001678 58                              pop     ax				;
  6302                                  	
  6303                                  ; Compute maximum size of environment
  6304                                  
  6305                                  	;;mov	word [ENVMAX],69 ; = (160/16)+(973/16)-1 ; (11EEh-0E30h+0Fh/10h) = 3Ch
  6306                                          ;mov	word [ENVMAX],((ENVIRONSIZ+15)/16) + ((ENVMAXIMUM-ZERO+15)/16) - 1
  6307                                  	; 14/01/2023 - Retro DOS v4.0 COMMAND.COM
  6308                                  	;mov	word [EnvMax],81	; 10+72-1  ; MSDOS 5.0 COMMAND.COM
  6309                                  	;mov	word [EndMax],90	; 12+79-1  ; MSDOS 6.22 COMMAND.COM	
  6310                                  	; 22/07/2024
  6311                                  	;mov	word [EndMax],95	; 
  6312 00001679 C706[8920]5800          	mov	word [EnvMax],((ENVIRONSIZ+15)/16) + ((EnvMaximum-ZERO+15)/16) - 1
  6313                                  			; MSDOS 6.22	; 12+(((1B53h-1670h)+15)/16)-1 = 90
  6314                                  			; PCDOS 7.1	; ((166+15+)/16)+(1BF5h-16B0h+15)/16)-1 = 95
  6315                                  ;
  6316                                  ; Compute minimum size of environment
  6317                                  ;
  6318                                  	;;mov	word [EnvSiz],10 ; = 160/16	; MSDOS 3.3 COMMAND.COM
  6319                                  	;mov	word [EnvSiz],16 ; = 256/16	; MSDOS 5.0 COMMAND.COM
  6320 0000167F C706[8720]1000          	mov	word [EnvSiz],ENVSML/16 ; 256/16
  6321                                  
  6322                                  	;;;mov	dx,offset TranGroup:Transpaceend + 15 ; dx = size of transient
  6323                                  	;;mov	dx,98D4h	; MSDOS 5.0 COMMAND.COM
  6324                                  	; 06/06/2023
  6325                                  	;;mov	dx,0AFA4h	; MSDOS 6.22 COMMAND.COM
  6326                                  	;mov	dx,TRANSPACEEND+15 ; 4D5Ch+0Fh (for MSDOS 3.3 COMMAND.COM)
  6327                                  	; 22/07/2024
  6328                                  	;mov	dx,0AAA9h	; PCDOS 7.1 COMMAND.COM (0AA9Ah+0Fh)
  6329                                  	;mov	cl,4				;  in paragraphs.
  6330                                  	;shr	dx,cl
  6331 00001685 BA670A                  	mov	dx,(TRANSPACEEND+15)>>4
  6332                                  
  6333 00001688 8916[9720]                      mov     [TrnSize],dx			; save size of transient in paragraphs
  6334                                  
  6335 0000168C 29D0                    	sub	ax,dx				; max seg addr - # para's needed for transient
  6336 0000168E A3[8F02]                	mov	[TrnSeg],ax			;  = seg addr to load the transient at.
  6337                                  	;mov	ax,[2Ch]
  6338 00001691 A12C00                  	mov	ax,[PDB.ENVIRON]		; ax = environment segment
  6339                                  
  6340                                  	; 14/01/2023
  6341                                          ; MSDOS 6.0
  6342                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6343 00001694 A3[3A04]                	mov	[EnvirSeg],ax
  6344                                          
  6345                                  	; 21/01/2023
  6346 00001697 09C0                    	or	ax,ax				; if there is no environment segment,
  6347 00001699 7407                    	jz	short buildenv			; make one
  6348                                    
  6349                                  	; 21/01/2023
  6350                                  	; MSDOS 3.3 & MSDOS 5.0
  6351                                  	;;inc	byte [CHUCKENV]
  6352                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6353                                  	;inc	byte [AllocedEnv]		; Flag - old environment segment
  6354                                  	
  6355                                  	; MSDOS 3.3 & MSDOS 5.0
  6356                                  	; 06/06/2023
  6357                                  	;jmp	short environpassed
  6358                                  	
  6359                                  	; MSDOS 6.0
  6360                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM	
  6361 0000169B 803E[9E26]00            	cmp	byte [FirstCom],0		; if this is the first command.com,
  6362 000016A0 7403                    	je	short environpassed		; do a merge job (make sure COMSPEC exists)
  6363                                  
  6364                                  	; MSDOS 6.0
  6365                                  
  6366                                  ; We allocate a buffer here just large enough to hold the 'PATH=' and
  6367                                  ; the COMSPEC. After parsing, we will allocate an environment of the right
  6368                                  ; size and free this buffer. We need this buffer because we no longer have an
  6369                                  ; ENVIRONMENT segment but need a place to store the COMSPEC which can be
  6370                                  ; given on the command line before we know the environment size. This routine
  6371                                  ; will not return in case of an allocation error. It will either exit or hang
  6372                                  ; depending on whether or not this is the first COMMAND.COM or not.
  6373                                  
  6374                                  	; 14/01/2023
  6375                                  buildenv:
  6376 000016A2 E8E607                  	call	alloc_env                       ; try to allocate buffer
  6377                                  environpassed:
  6378                                  	; 14/01/2023 - MSDOS 5.0 COMMAND.COM
  6379                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  6380                                  	;mov	[EnvirSeg],ax
  6381                                  	;
  6382 000016A5 8EC0                    	mov	es,ax                           ; and it load into es.
  6383                                  	;assume	es:nothing
  6384                                  
  6385                                  gottheenvir:
  6386                                  
  6387                                  ; Initialize the command drive
  6388                                  
  6389                                  	; 14/01/2023
  6390                                  	; MSDOS 3.3 & MSDOS 6.0
  6391 000016A7 B419                    	mov	ah,19h
  6392                                  	;mov	ah,GET_DEFAULT_DRIVE	; 19h
  6393 000016A9 CD21                    	int	21h
  6394 000016AB FEC0                    	inc	al
  6395 000016AD A2[9402]                	mov	[ComDrv],al
  6396                                  
  6397                                          ;mov	al,byte ptr ds:[FCB]	; al = default drive number for command
  6398 000016B0 A05C00                          mov	al,[FCB] ; [5Ch]
  6399 000016B3 08C0                    	or	al,al
  6400 000016B5 7433                    	jz	short nocomdrv		; no drive specified
  6401                                  
  6402 000016B7 B43A                    	mov	ah,':'
  6403 000016B9 A2[9402]                	mov	[ComDrv],al
  6404 000016BC 0440                    	add	al,40h			; convert number to uppercase character
  6405                                  
  6406 000016BE FD                      	std
  6407                                  
  6408                                  	; MSDOS 6.0
  6409                                  	; 06/06/2023
  6410                                  	; MSDOS 6.22 - COMMAND.COM - RESGROUP:17B7h
  6411 000016BF 803E[5920]00            	cmp	byte [AllocedEnv],0	; if a new environment is being built,
  6412 000016C4 7420                    	je	short notwidenv		;  move the default comspec string in it
  6413                                  	; 14/01/2023
  6414                                  	; MSDOS 5.0 COMMAND.COM
  6415 000016C6 8B3E[7020]              	mov	di,[ComspOffset]
  6416 000016CA 26807D013A                      cmp	byte [es:di+1],':'	; drive specifier already exist?
  6417 000016CF 7415                            je	short notwidenv		; yes, must have been inherited that way
  6418                                  
  6419                                  	; 06/06/2023
  6420                                  	; MSDOS 3.3
  6421                                  	;;cmp	byte [CHUCKENV],0
  6422                                  	;;jne	short NOTWIDENV
  6423                                  	; 21/01/2021
  6424                                  	; MSDOS 5.0 - COMMAND.COM - RESGROUP:16A5h
  6425                                   	;cmp	byte [AllocedEnv],0
  6426                                  	;ja	short notwidenv
  6427                                  
  6428 000016D1 1E                        	push	ds			;  2 bytes to make room for a drivespec.
  6429 000016D2 06                      	push	es			;  the drivespec is in ax and is copied
  6430 000016D3 1F                      	pop	ds			;  on to the front of the string.
  6431                                  
  6432                                  ; 06/06/2023
  6433                                  %if 0
  6434                                  	; 21/01/2023
  6435                                  	; 14/01/2023
  6436                                  	; MSDOS 5.0 COMMAND.COM
  6437                                  	; MSDOS 3.3
  6438                                  	; 23/09/2018
  6439                                  	; 30/04/2018
  6440                                  	;mov	di,159
  6441                                  	;;MOV	DI,OFFSET ENVIRONMENT:ECOMSPEC+ENVIRONSIZ2-1-10H
  6442                                  	;mov	di,(ECOMSPEC-ENVIRONMENT)+ENVIRONSIZ2-1 ; mov di,9Fh
  6443                                  	mov	di,ENVIRONSIZ-1 ; 21/01/2023
  6444                                  	;mov	si,157
  6445                                  	;;MOV	SI,OFFSET ENVIRONMENT:ECOMSPEC+ENVIRONSIZ2-3-10H
  6446                                          ;mov	si,(ECOMSPEC-ENVIRONMENT)+ENVIRONSIZ2-3 ; mov si,9Dh 
  6447                                  	mov	si,ENVIRONSIZ-3 ; 21/01/2023 	
  6448                                  	;MOV	CX,ENVIRONSIZ2-2 ; mov cx,90h
  6449                                  	mov	cx,MAX_COMSPEC-2 ; 144
  6450                                  %endif
  6451                                  	; MSDOS 6.0
  6452                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM - RESGROUP:17CCh
  6453 000016D4 8DB58F00                        lea	si,[di+MAX_COMSPEC-3]	; lea si,[di+143]
  6454 000016D8 8DBD9100                        lea	di,[di+MAX_COMSPEC-1]	; lea di,[di+145]
  6455                                  
  6456 000016DC B99000                          mov	cx,MAX_COMSPEC-2 ; 144
  6457                                  
  6458 000016DF F3A4                    	rep	movsb
  6459 000016E1 1F                      	pop	ds
  6460                                  
  6461                                  	; MSDOS 6.0
  6462                                  	; 06/06/2023
  6463 000016E2 268945FF                	mov	[es:di-1],ax
  6464                                  
  6465                                  	; MSDOS 3.3
  6466                                  	;mov	[es:0Eh],ax
  6467                                  	;;;MOV	WORD PTR ES:[ECOMSPEC-10H],AX
  6468                                  	;;MOV	[es:(ECOMSPEC-ENVIRONMENT)],ax	; mov [es:0Eh],ax
  6469                                  	; 14/01/2023
  6470                                  	; 06/06/2023
  6471                                  	;mov	[es:ECOMSPEC],ax ; mov [es:0Eh],ax
  6472                                  
  6473                                  	; MSDOS 3.3 & MSDOS 6.0
  6474                                  notwidenv:
  6475 000016E6 FC                      	cld
  6476 000016E7 A3[3B20]                	mov	[AUTOBAT],ax ; db 0,":\AUTOEXEC.BAT"
  6477                                  
  6478                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  6479                                  %if 0
  6480                                  	; 14/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6481                                  	; (MSDOS 5.0 COMMAND.COM RESGROUP:16C3h)
  6482                                  	; 06/06/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6483                                  	mov	[KAUTOBAT],ax ; db 0,":\AUTOEXEC.BAT"
  6484                                  %endif
  6485                                  
  6486                                  nocomdrv:
  6487 000016EA E841FA                  	call	SetVect        ; Set the vectors
  6488                                  
  6489                                  ; parsing starts here
  6490                                  
  6491                                  	; 14/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6492                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:16C9h - CODERES:0989h)
  6493                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6494                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:17E8h - CODERES:0998h)
  6495                                  	; MSDOS 6.0
  6496 000016ED 0E                      	push	cs
  6497 000016EE 0E                      	push	cs
  6498 000016EF 1F                      	pop	ds
  6499 000016F0 07                      	pop	es
  6500                                  	;assume ds:ResGroup,es:ResGroup
  6501                                  
  6502 000016F1 BE8000                  	mov	si,80h				; get command line
  6503 000016F4 AC                      	lodsb					; get length of line
  6504 000016F5 89F7                    	mov	di,si				; get line position in di
  6505 000016F7 30E4                    	xor	ah,ah				; ax = length of command line
  6506                                  
  6507                                  ; insure that the command line correctly ends with a cr
  6508                                  
  6509 000016F9 01C7                    	add	di,ax				; go to end of command line
  6510 000016FB C6050D                          mov	byte [di],0Dh			; insert a carriage return
  6511 000016FE 31C9                    	xor	cx,cx				; clear cx
  6512 00001700 890E[6421]                      mov	[num_positionals],cx		; initialize positionals
  6513                                  
  6514                                  ; Scan the command line looking for the parameters
  6515                                  
  6516                                  Parse_command_line:
  6517                                  	;mov	di,offset ResGroup:Parse_Command; Get address of parse_command
  6518 00001704 BF[9E20]                	mov	di,PARSE_COMMAND
  6519 00001707 8B0E[6421]              	mov	cx,[num_positionals]		; Get number of positionals
  6520 0000170B 31D2                    	xor	dx,dx				; clear dx
  6521 0000170D 8936[6621]                      mov	[old_parse_ptr],si		; save position before calling parser
  6522                                  	;call	dword ptr Init_Parse
  6523 00001711 FF1E[9320]              	call	far [Init_Parse]		; call parser
  6524 00001715 890E[6421]                      mov     [num_positionals],cx		; Save number of positionals
  6525                                  	; 29/01/2023
  6526                                  	;;cmp	ax,END_OF_LINE ; 0FFFFh ; -1 	; are we at end of line?
  6527                                          ;cmp	ax,-1
  6528                                  	;jne	short t1
  6529                                  	; 10/06/2023
  6530 00001719 40                      	inc	ax	 ; cmp ax,-1
  6531 0000171A 7503                    	jnz	short t1 ; 0FFFFh -> 0
  6532                                  	; ax = 0
  6533 0000171C E99502                  	jmp     ArgsDone                        ; yes - exit
  6534                                  t1:	
  6535                                  	;;cmp	ax,RESULT_NO_ERROR ; 0		; did an error occur
  6536                                  	;;cmp	ax,0
  6537                                  	;and	ax,ax
  6538                                  	; 10/06/2023
  6539 0000171F 48                      	dec	ax  ; cmp ax,0
  6540 00001720 7468                    	jz	short parse_cont  ; 1 -> 0	; no - continue
  6541                                  
  6542                                  ; Before issuing error message - make sure switch is not /C
  6543                                  
  6544                                  parse_line_error:
  6545                                  	; 14/01/2023
  6546                                  	;push	si				; save line position
  6547                                  	;push	ax				; save error number
  6548                                  	;cmp	ax,3
  6549 00001722 83F803                  	cmp	ax,BadSwt_Ptr ; 3		; Was error invalid switch?
  6550                                          ;jnz	short parse_line_error_disp	; No - just issue message
  6551 00001725 7538                    	jne	short parse_line_error_disp2
  6552 00001727 56                      	push	si ; **				; save line position
  6553 00001728 50                      	push	ax ; *				; save error number
  6554 00001729 89F7                    	mov	di,si				; Get terminating pointer in DI
  6555 0000172B 8B36[6621]                      mov     si,[old_parse_ptr]		; Get starting pointer in SI
  6556                                  
  6557                                  init_chk_delim:
  6558 0000172F 39FE                    	cmp	si,di				; at end of parsed parameter?
  6559 00001731 742A                            je	short parse_line_error_disp	; Yes - just display message
  6560 00001733 AC                      	lodsb					;
  6561 00001734 3C20                    	cmp	al,20h ; ' ' ; 16/04/2023
  6562                                  	;cmp	al,space_chr ; 14/01/2023
  6563                                  	;;cmp	al,[space]			; Skip blank spaces
  6564 00001736 74F7                    	je	short init_chk_delim		;
  6565                                  	;cmp	al,9
  6566 00001738 3C09                    	cmp	al,tab_chr ; 9			; Skip tab characters
  6567 0000173A 74F3                    	je	short init_chk_delim		;
  6568                                  
  6569 0000173C 3A06[4E04]              	cmp	al,[RSwitChar]	; '/'		; Switch?
  6570 00001740 751B                            jne	short parse_line_error_disp	; No - just issue message
  6571 00001742 AC                      	lodsb					; Get the char after the switch
  6572                                  
  6573                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  6574                                  ;ifdef	DBCS
  6575                                  %if 1
  6576 00001743 E837FD                  	call	ITestKanj			; Is it DBCS?
  6577 00001746 7515                    	jnz	short parse_line_error_disp	; Yes - can't be /C or /K
  6578                                  %endif
  6579                                  ;endif
  6580 00001748 E8D505                  	call	iupconv 			; upper case it
  6581                                  
  6582                                  	;cmp	al,[scswitch]	; 'C'		; it is /C?
  6583                                          ;jne	short check_k_too ; MSDOS 6.0	;
  6584                                  	; 16/04/2023
  6585 0000174B 3C43                    	cmp	al,'C' ; scswitch
  6586                                  	;jne	short parse_line_error_disp  ; MSDOS 5.0 COMMAND.COM
  6587                                  	; 06/06/2023
  6588                                  	; MSDOS 6.22 COMMAND.COM
  6589 0000174D 7505                    	jne	short check_k_too
  6590 0000174F 5A                      	pop	dx ; *				; even up stack
  6591 00001750 5A                      	pop	dx ; **				; even up stack
  6592 00001751 E9D100                  	jmp	SetSSwitch			; Yes - go set COMMAND /C
  6593                                  
  6594                                  	; MSDOS 6.0
  6595                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6596                                  check_k_too:
  6597                                  	;cmp	al,[skswitch]	; 'K'		; it is /K?
  6598                                          ;jne	short parse_line_error_disp	;
  6599                                  	; 06/06/2023
  6600 00001754 3C4B                    	cmp	al,'K'
  6601 00001756 7505                    	jne	short parse_line_error_disp
  6602 00001758 5A                      	pop	dx ; *				; even up stack
  6603 00001759 5A                      	pop	dx ; **				; even up stack
  6604 0000175A E9C100                          jmp	SetKSwitch			; Yes - go set COMMAND /K
  6605                                  
  6606                                  parse_line_error_disp:
  6607                                  	; 14/01/2023
  6608 0000175D 58                      	pop	ax ; *				; restore error number
  6609 0000175E 5E                      	pop	si ; **				; restore line position
  6610                                  parse_line_error_disp2:
  6611 0000175F 89C2                    	mov	dx,ax				; get message number
  6612 00001761 E84C05                  	call	RPrintParse
  6613 00001764 E871FC                  	call	crlf
  6614 00001767 EB9B                            jmp     short Parse_command_line        ; continue parsing
  6615                                  
  6616                                  ; 22/07/2024
  6617                                  
  6618                                  ;CHECKDSWITCH:
  6619                                  	;;cmp	al,'d'
  6620                                          ;cmp	al,[letter_d]
  6621                                  	;jnz	short CHECKCSWITCH
  6622                                  
  6623                                  ; 16/04/2023
  6624                                  %if 1
  6625                                  SetMSwitch:
  6626                                          ;cmp	byte [ext_msg],1
  6627 00001769 803E[9920]01            	cmp	byte [ext_msg],SET_EXTENDED_MSG	; has /MSG switch been set?
  6628                                  	; 16/04/2023
  6629                                  	;jnz	short setMswitchok		; no - set it
  6630                                  	;;mov	ax,1
  6631                                  	;mov	ax,MoreArgs_Ptr                 ; set up too many arguments
  6632                                  	;jmp	parse_line_error                ; go issue error message
  6633                                  	; 16/04/2023
  6634 0000176E 747C                    	je	short parse_line_error_j
  6635                                  setMswitchok:
  6636                                          ;mov	byte [ext_msg],1
  6637 00001770 C606[9920]01            	mov	byte [ext_msg],SET_EXTENDED_MSG	; set /MSG switch
  6638                                  	; 06/06/2023
  6639 00001775 EB8D                    	jmp	short Parse_command_line	; keep parsing
  6640                                  %endif
  6641                                  
  6642                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6643                                  
  6644                                  SetDSwitch:
  6645                                  
  6646                                  ; Flag no date/time prompting.
  6647                                  
  6648                                  	; MSDOS 6.0
  6649 00001777 803E[9B20]00            	cmp	byte [dswitch],0	; has /D switch been set?
  6650                                  	; 16/04/2023
  6651                                  	;jz	short setdateok		; no - set it
  6652                                          ;;mov	ax,1
  6653                                  	;mov	ax,MoreArgs_Ptr		; set up too many arguments
  6654                                          ;jmp	parse_line_error	; go issue error message
  6655                                  	; 16/04/2023
  6656 0000177C 756E                    	jnz	short parse_line_error_j
  6657                                  setdateok:
  6658 0000177E FE06[9B20]              	inc	byte  [dswitch]		; indicate /D entered
  6659                                  
  6660                                  	; MSDOS 3.3 & MSDOS 6.0
  6661 00001782 C606[4C20]01                    mov	byte [PRDATTM],1	; User explicitly says no date time
  6662                                  	; MSDOS 3.3
  6663                                  	;jmp	short CHKARG
  6664                                  	; MSDOS 6.0
  6665 00001787 E97AFF                  	jmp     Parse_command_line	; continue parsing
  6666                                  
  6667                                  parse_cont:
  6668                                  	; 15/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6669                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:173Ch - CODERES:09FCh)
  6670                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6671                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:1869h - CODERES:0A19h)
  6672                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6673                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:18AEh
  6674                                  
  6675                                  	; MSDOS 6.0
  6676                                  
  6677                                  ; See if a switch was entered
  6678                                  ;
  6679                                  ; Bugbug: See if Comnd1_Syn can be moved into a reg. before the compare
  6680                                  
  6681 0000178A 813E[5D21][DD20]        	cmp	word [COMND1_SYN],COMMAND_F_SYN ; was /F entered?
  6682 00001790 7460                    	je	short SetFSwitch		; yes go set fail switch
  6683 00001792 813E[5D21][D120]        	cmp	word [COMND1_SYN],COMMAND_P_SYN ; was /P entered?
  6684 00001798 744B                    	je	short SetPSwitch		; yes go set up PERMCOM
  6685 0000179A 813E[5D21][E920]        	cmp	word [COMND1_SYN],COMMAND_D_SYN ; was /D entered?
  6686 000017A0 74D5                    	je	short SetDSwitch		; yes go set date switch
  6687 000017A2 813E[5D21][0E21]        	cmp	word [COMND1_SYN],COMMAND_C_SYN ; was /C entered?
  6688 000017A8 747B                    	je	short SetSSwitch		; yes go set up SINGLECOM
  6689                                  	; 06/06/2023
  6690                                  	; MSDOS 6.0 only!
  6691 000017AA 813E[5D21][3421]        	cmp	word [COMND1_SYN],COMMAND_K_SYN ; was /K entered?
  6692 000017B0 746C                            je	short SetKSwitch		; yes go set up SINGLECOM
  6693                                  	;
  6694 000017B2 813E[5D21][F520]        	cmp	word [COMND1_SYN],COMMAND_E_SYN ; was /E entered?
  6695 000017B8 747C                    	je	short SetESwitch		; yes go set up environment
  6696                                  
  6697                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6698                                  ; PCDOS 7.1 COMMAND.COM
  6699                                  %if 1
  6700 000017BA 813E[5D21][4021]        	cmp	word [COMND1_SYN],COMMAND_Y_SYN ; was /Y entered?
  6701                                  	;je	short SetYSwitch		; yes (step switch)
  6702                                  	; 22/07/2024
  6703 000017C0 7508                    	jne	short parse_cont_@
  6704                                  
  6705                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19C3h
  6706                                  SetYSwitch:
  6707 000017C2 800E[5A04]10            	or      byte [Y_Flag], 10h
  6708 000017C7 E93AFF                  	jmp     Parse_command_line
  6709                                  
  6710                                  parse_cont_@:
  6711                                  %endif
  6712 000017CA 813E[5D21][1A21]        	cmp	word [COMND1_SYN],COMMAND_M_SYN	; was /MSG entered?
  6713                                  	;je	short SetMSwitchjmp		; yes go set up message flag
  6714                                  	; 15/01/2023
  6715 000017D0 7497                    	je	short SetMSwitch 
  6716                                  
  6717                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6718                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:18FDh
  6719                                  %if 1
  6720 000017D2 813E[5D21][4C21]        	cmp	word [COMND1_SYN],COMMAND_H_SYN	; was /H entered?
  6721 000017D8 747A                    	je	short SetHSwitch		; yes (load into UMB switch)
  6722 000017DA 813E[5D21][5821]        	cmp	word [COMND1_SYN],COMMAND_O_SYN	; was /O entered?
  6723 000017E0 747F                    	je	short SetOSwitch		; yes (disable overwrite prompt)
  6724                                  %endif
  6725 000017E2 E99800                  	jmp	ChkOtherArgs		; Must be something else
  6726                                  
  6727                                  	; MSDOS 6.0
  6728                                  ;SetMSwitchjmp:
  6729                                  	;jmp	SetMSwitch
  6730                                  
  6731                                  ; 22/07/2024
  6732                                  %if 1
  6733                                  SetPSwitch:
  6734                                  
  6735                                  ; We have a permanent COMMAND switch /P. Flag this and stash the
  6736                                  ; termination address.
  6737                                  
  6738                                  	; MSDOS 6.0
  6739 000017E5 803E[A202]00            	cmp	byte [PermCom],0	; has /p switch been set?
  6740 000017EA 7415                    	jz	short permcomok		; no - set it
  6741                                  	; 16/04/2023
  6742                                  parse_line_error_j:
  6743                                          ;mov	ax,1
  6744 000017EC B80100                  	mov	ax,MoreArgs_Ptr		; set up too many arguments
  6745 000017EF E930FF                          jmp	parse_line_error	; go issue error
  6746                                  %endif
  6747                                  	
  6748                                  	; MSDOS 6.0
  6749                                  SetFSwitch:
  6750 000017F2 803E[A902]FF            	cmp	byte [fFail],-1		; has fail switch been set?
  6751                                  	; 16/04/2023
  6752                                  	;jne	short failok		; no - set it
  6753                                  	;;mov	ax,1
  6754                                  	;mov	ax,MoreArgs_Ptr         ; set up too many arguments
  6755                                          ;jmp	parse_line_error        ; go issue error 
  6756                                  	; 16/04/2023
  6757 000017F7 74F3                    	je	short parse_line_error_j
  6758                                  
  6759                                  	; MSDOS 3.3 & MSDOS 6.0
  6760                                  failok:
  6761 000017F9 C606[A902]FF            	mov	byte [fFail],-1		; fail all INT 24s.
  6762                                  	; MSDOS 3.3
  6763                                  	;jmp	short CHKARG
  6764                                  	; MSDOS 6.0
  6765 000017FE E903FF                  	jmp	Parse_command_line
  6766                                  
  6767                                  ;CHECKPSWITCH:
  6768                                  	;;cmp	al,'p'			; Permanent COMMAND switch
  6769                                  	;cmp	al,[letter_p]
  6770                                          ;jnz	short CHECKDSWITCH
  6771                                  
  6772                                  ; 22/07/2024
  6773                                  %if 0
  6774                                  SetPSwitch:
  6775                                  
  6776                                  ; We have a permanent COMMAND switch /P. Flag this and stash the
  6777                                  ; termination address.
  6778                                  
  6779                                  	; MSDOS 6.0
  6780                                  	cmp	byte [PermCom],0	; has /p switch been set?
  6781                                  	jz	short permcomok		; no - set it
  6782                                  	; 16/04/2023
  6783                                  parse_line_error_j:
  6784                                          ;mov	ax,1
  6785                                  	mov	ax,MoreArgs_Ptr		; set up too many arguments
  6786                                          jmp	parse_line_error	; go issue error
  6787                                  %endif
  6788                                  
  6789                                  permcomok:
  6790                                  	; MSDOS 3.3 & MSDOS 6.0
  6791 00001801 FE06[A202]              	inc	byte [PermCom]
  6792                                  	;mov	word [OLDTERM],LODCOM
  6793 00001805 C706[4002][E000]        	mov	word [OldTerm],LodCom_Trap
  6794                                  	;mov	[OLDTERM+2],ds
  6795 0000180B 8C1E[4202]              	mov	[OldTerm+2],ds
  6796                                  
  6797                                  ; make sure that we display the date and time. if the flag was not
  6798                                  ; initialized, set it to indicate yes, do prompt.
  6799                                  
  6800                                  	; MSDOS 3.3
  6801                                  	;cmp	byte [PRDATTM],-1
  6802                                  	;jnz	short CHKARG
  6803                                  	;mov	byte [PRDATTM],0
  6804                                  	;jmp	short CHKARG
  6805                                  
  6806                                  	; MSDOS 6.0
  6807 0000180F 803E[4C20]FF            	cmp	byte [PRDATTM],-1
  6808 00001814 7505                    	jne	short Parse_command_line_jmp
  6809 00001816 C606[4C20]00            	mov	byte [PRDATTM],0
  6810                                  Parse_command_line_jmp:
  6811 0000181B E9E6FE                  	jmp     Parse_command_line	; keep parsing
  6812                                  
  6813                                  ;COMRETURNSJ:
  6814                                  ;	; MSDOS 3.3
  6815                                  ;	JMP	ARGSDONE
  6816                                  
  6817                                  	; 15/01/2023
  6818                                  	; MSDOS 6.0 
  6819                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6820                                  SetKSwitch:
  6821 0000181E C606[A302]00            	mov	byte [SemiPermCom],0
  6822 00001823 EB05                    	jmp	short SetSorKSwitch
  6823                                  
  6824                                  ;CHECKCSWITCH:
  6825                                  	;;cmp	al,'c'
  6826                                  	;cmp	al,[letter_c]
  6827                                          ;jnz	short CHECKESWITCH
  6828                                  
  6829                                  SetSSwitch:
  6830                                  ;SETCSWITCH:
  6831                                  
  6832                                  ; Set up pointer to command line, flag no date/time and turn off SingleCom.
  6833                                  
  6834 00001825 C606[A202]00            	mov	byte [PermCom],0	; A SingleCom must not be a PermCom
  6835                                  SetSorKSwitch:	; 06/06/2023
  6836 0000182A 8936[A502]              	mov	[SingleCom],si		; Point to the rest of the command line
  6837 0000182E C606[4C20]01            	mov	byte [PRDATTM],1	; no date or time either, explicit
  6838                                  ;COMRETURNSJ: ; 24/09/2018
  6839 00001833 E97E01                  	jmp     ArgsDone
  6840                                  
  6841                                  ;CHECKESWITCH:
  6842                                  	;cmp	al,'e'
  6843                                  	;jnz	short CHKARG
  6844                                  
  6845                                  ; Look for environment-size setting switch
  6846                                  
  6847                                  ; The environment size is represented in decimal bytes and is
  6848                                  ; converted into paragraphs (rounded up to the next paragraph).
  6849                                  
  6850                                  SetESwitch:
  6851                                  	; MSDOS 6.0
  6852 00001836 803E[9A20]00            	cmp	byte [eswitch],0	; has environment size switch been set?
  6853                                  	; 16/04/2023
  6854                                  	;jz	short eswitchok		; no - set it
  6855                                  	;;mov	ax,1
  6856                                  	;mov	ax,MoreArgs_Ptr		; set up too many arguments
  6857                                          ;jmp	parse_line_error	; go issue error message
  6858                                  	; 16/04/2023
  6859 0000183B 75AF                    	jnz	short parse_line_error_j
  6860                                  eswitchok:
  6861 0000183D FE06[9A20]              	inc	byte [eswitch]		; indicate /E entered 	
  6862                                  
  6863                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  6864                                  	; 15/01/2023 - Retro DOS v4.1 (& v4.1) - MSDOS 5.0 COMMAND.COM
  6865                                  	; MSDOS 6.0
  6866                                  	;mov	di,offset ResGroup:Comnd1_Addr	; get number returned
  6867 00001841 BF[5F21]                        mov	di,COMND1_ADDR
  6868 00001844 8B1D                    	mov     bx,[di]				; into bx
  6869                                  
  6870 00001846 83C30F                  	add	bx,0Fh				; Round up to next paragraph
  6871 00001849 B104                    	mov	cl,4				; convert to pargraphs
  6872 0000184B D3EB                    	shr	bx,cl				; by right 4
  6873                                  
  6874 0000184D 891E[8720]              	mov	[EnvSiz],bx			; EnvSiz is in paragraphs
  6875 00001851 E9B0FE                  	jmp	Parse_command_line		; continue parsing command line
  6876                                  
  6877                                  ; 16/04/2023
  6878                                  %if 0
  6879                                  SetMSwitch:
  6880                                          ;cmp	byte [ext_msg],1
  6881                                  	cmp	byte [ext_msg],SET_EXTENDED_MSG	; has /MSG switch been set?
  6882                                  	jnz	short setMswitchok		; no - set it
  6883                                  	;mov	ax,1
  6884                                  	mov	ax,MoreArgs_Ptr                 ; set up too many arguments
  6885                                  	jmp	parse_line_error                ; go issue error message
  6886                                  setMswitchok:
  6887                                          ;mov	byte [ext_msg],1
  6888                                  	mov	byte [ext_msg],SET_EXTENDED_MSG	; set /MSG switch
  6889                                  	jmp	Parse_command_line              ; keep parsing
  6890                                  %endif
  6891                                  
  6892                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6893                                  %if 1
  6894                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1913h
  6895                                  SetHSwitch:
  6896                                  	;jmp	short load_to_hma_umb	; load COMMAND.COM into HMA/UMB
  6897                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19CBh
  6898                                  load_to_hma_umb:
  6899                                  	;cmp	byte [520h],0
  6900 00001854 803E[0E04]00            	cmp	byte [COMMAND_HIGH],0
  6901 00001859 741B                    	jz	short set_command_high_flag
  6902                                  parse_line_error_j2: ; 22/07/2024
  6903 0000185B B80100                  	mov	ax,1			; too many parameters
  6904 0000185E E9C1FE                  	jmp	parse_line_error
  6905                                  
  6906                                  ;set_command_high_flag:
  6907                                  ;	inc	byte [COMMAND_HIGH]
  6908                                  ;	jmp     Parse_command_line
  6909                                  
  6910                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1916h
  6911                                  SetOSwitch:
  6912                                  	;jmp	short disable_overwrite_msg
  6913                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:19DFh
  6914                                  disable_overwrite_msg:
  6915 00001861 803E[FA01]63            	cmp	byte [cox_location],'c' ; "cox"
  6916                                  	;jz	short change_cox_to_VCB
  6917                                  	;mov	ax, 1 ; MoreArgs_Ptr
  6918                                  	;jmp	parse_line_error
  6919                                  	; 22/07/2024
  6920 00001866 75F3                    	jnz	short parse_line_error_j2
  6921                                  change_cox_to_VCB:
  6922 00001868 C606[FA01]56            	mov     byte [cox_location],56h ; 'V' ; "VCB"
  6923 0000186D C706[FB01]4342          	mov     word [cox_location+1],4243h ; 'CB'
  6924 00001873 E98EFE                  	jmp     Parse_command_line
  6925                                  
  6926                                  set_command_high_flag:
  6927 00001876 FE06[0E04]              	inc	byte [COMMAND_HIGH]
  6928 0000187A E987FE                  	jmp     Parse_command_line
  6929                                  %endif
  6930                                  
  6931                                  ;ArgsDoneJ:
  6932                                  	;jmp	ArgsDone
  6933                                  
  6934                                  	; 15/01/2023 - Retro DOS v4.0 (& V4.1) COMMAND.COM
  6935                                  	; (MSDOS 5.0 COMMAND.COM - RESGROUP:181Dh - CODERES:0ADDh)
  6936                                  
  6937                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  6938                                  	; (MSDOS 6.22 COMMAND.COM - RESGROUP:196Dh - CODERES:0B1Dh)
  6939                                  
  6940                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  6941                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:19FAh
  6942                                  
  6943                                  ChkOtherArgs:
  6944                                  
  6945                                  ; We have a non-switch character here.
  6946                                  
  6947                                  	; MSDOS 6.0
  6948 0000187D 1E                      	push	ds ; ****			;
  6949 0000187E 56                      	push	si ; *** 			; save place in command line
  6950 0000187F C536[5F21]              	lds	si,[COMND1_ADDR]		; get address of filespec
  6951                                  	;assume	ds:nothing			;
  6952                                  
  6953 00001883 89F2                    	mov	dx,si				; put in dx also
  6954 00001885 B8023D                  	mov	ax,3D02h
  6955                                  	;mov	ax,(OPEN shl 8) or 2            ; Read and write
  6956 00001888 CD21                    	int	21h
  6957 0000188A 7260                    	jc	short ChkSrchSpec		; Wasn't a file
  6958 0000188C 89C3                    	mov	bx,ax
  6959 0000188E B80044                  	mov	ax,4400h
  6960                                  	;mov	ax,IOCTL shl 8
  6961 00001891 CD21                    	int	21h
  6962 00001893 F6C280                  	test	dl,80h
  6963 00001896 7506                    	jnz	short IsaDevice
  6964                                  BadSetCon:
  6965 00001898 B43E                    	mov	ah,3Eh
  6966                                  	;mov	ah,CLOSE		; Close initial handle, wasn't a device
  6967 0000189A CD21                    	int	21h
  6968 0000189C EB4E                    	jmp	short ChkSrchSpec
  6969                                  
  6970                                  	; 15/01/2023
  6971                                  IsaDevice:
  6972                                  	; MSDOS 3.3 & MSDOS 6.0
  6973 0000189E 30F6                    	xor	dh,dh
  6974 000018A0 80CA03                  	or	dl,3				; Make sure has CON attributes
  6975                                  	;mov	ax,(IOCTL shl 8) or 1
  6976 000018A3 B80144                  	mov	ax,(IOCTL*256)|1 ; 4401h
  6977 000018A6 CD21                    	int	21h
  6978                                  	;
  6979                                  	; 15/01/2023
  6980 000018A8 72EE                    	jc	short BadSetCon	; MSDOS 6.0 (& 5.0)
  6981                                  	; 25/09/2018
  6982                                  	;pop	dx ; *
  6983                                  	;pop	dx ; **
  6984                                  	;
  6985                                  	;jc	short BADSETCON	; MSDOS 6.0	; Can't set attributes - quit
  6986                                  	
  6987 000018AA 89DA                    	mov	dx,bx				; Save new handle
  6988                                  
  6989                                  	; MSDOS 6.0
  6990 000018AC 26803E[9F26]01          	cmp	byte [es:DevFlag],1
  6991 000018B2 742A                    	jz	short DevErr
  6992                                  
  6993                                  	; MSDOS 3.3
  6994                                          ;pop	bx ; *				; Throw away saved SI
  6995                                          ;pop	bx ; **				; Throw away saved CX
  6996                                  
  6997                                  	; MSDOS 3.3 & MSDOS 6.0
  6998 000018B4 51                      	push	cx ; **
  6999 000018B5 B90300                  	mov	cx,3
  7000 000018B8 31DB                    	xor	bx,bx
  7001                                  
  7002                                  	; 15/01/2023
  7003                                  rcclloop:
  7004 000018BA B43E                    	mov	ah,3Eh
  7005                                  	;mov	ah,CLOSE ; 3Eh
  7006 000018BC CD21                    	int	21h
  7007 000018BE 43                      	inc	bx
  7008 000018BF E2F9                    	loop	rcclloop
  7009                                  
  7010 000018C1 89D3                    	mov	bx,dx				; New device handle
  7011 000018C3 B445                    	mov	ah,45h
  7012                                  	;mov	ah,XDUP ; 45h
  7013 000018C5 CD21                    	int	21h				; Dup to 0
  7014 000018C7 B445                    	mov	ah,45h
  7015                                  	;mov	ah,XDUP
  7016 000018C9 CD21                    	int	21h				; Dup to 1
  7017 000018CB B445                    	mov	ah,45h
  7018                                  	;mov	ah,XDUP
  7019 000018CD CD21                    	int	21h				; Dup to 2
  7020 000018CF B43E                    	mov	ah,3Eh
  7021                                  	;mov	ah,CLOSE
  7022 000018D1 CD21                    	int	21h				; Close initial handle
  7023                                  	
  7024 000018D3 59                      	pop	cx ; **
  7025                                  	
  7026                                  	; MSDOS 6.0
  7027 000018D4 5E                      	pop	si ; ***			; restore position of command line
  7028 000018D5 1F                      	pop	ds ; ****			;
  7029                                  
  7030                                  ; Register the fact that we already have redirected the output
  7031                                  ; and can not do it again
  7032                                  
  7033 000018D6 26FE06[9F26]            	inc	byte [es:DevFlag]		
  7034 000018DB E926FE                  	jmp	Parse_command_line		; continue parsing
  7035                                  
  7036                                  	; MSDOS 3.3
  7037                                  	;jcxz	ARGSDONEJ2
  7038                                  	;jmp	CHKARG
  7039                                  
  7040                                  	; MSDOS 6.0
  7041                                  DevErr:
  7042 000018DE 5E                      	pop	si ; ***
  7043 000018DF 1F                      	pop	ds ; ****
  7044 000018E0 BA0100                  	mov	dx,1
  7045 000018E3 E8CA03                          call	RPrintParse                     ; "Too many parameters"
  7046 000018E6 E8EFFA                          call	crlf
  7047 000018E9 E918FE                  	jmp	Parse_command_line
  7048                                  
  7049                                  ChkSrchSpec:				; Not a device, so must be directory spec
  7050                                  	; MSDOS 6.0
  7051 000018EC 26803E[A026]01                  cmp	byte [es:PathFlag],1		; already set COMSPEC?
  7052 000018F2 74EA                            jz	short DevErr			; yes, error
  7053                                  	
  7054 000018F4 26FE06[A026]                    inc	byte [es:PathFlag]		; mark that we have a path
  7055                                  
  7056                                  ; We have to override the passed environment. Allocate a buffer for use now.
  7057                                  ; This buffer will later be replaced by a proper environment
  7058                                  
  7059                                  	; 15/01/2023 - Retro DOS v4.0 COMMAND.COM
  7060                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1899h
  7061                                  	; 06/06/2023
  7062                                  	;mov	ax,[ss:EnvirSeg]
  7063                                  	
  7064                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7065                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:19E9h
  7066                                  	;
  7067                                  	; MSDOS 6.0
  7068 000018F9 E88F05                  	call	alloc_env                       ; environment buffer
  7069                                  
  7070                                  ; 06/06/2023
  7071                                  %if 0
  7072                                  	; 15/01/2023
  7073                                  	; MSDOS 5.0
  7074                                  	cmp	byte [ss:AllocedEnv],1
  7075                                  	mov	byte [ss:AllocedEnv],0
  7076                                  	jne     short env_alloced
  7077                                  	call	alloc_env
  7078                                  	mov	[ss:EnvirSeg],ax
  7079                                  %endif
  7080                                  
  7081                                  env_alloced:
  7082                                  	; MSDOS 5.0 & MSDOS 6.0
  7083 000018FC 8EC0                    	mov	es,ax
  7084                                  	;assume	es:nothing
  7085 000018FE 56                      	push	si ; **				; remember location of file
  7086 000018FF 31C9                    	xor	cx,cx				; clear cx for counting
  7087                                  	
  7088                                  	; 15/01/2023
  7089                                  countloop:
  7090 00001901 AC                      	lodsb					; get a character
  7091 00001902 41                      	inc	cx				; increment counter
  7092                                          ;;cmp	al,0
  7093                                  	;cmp	al,END_OF_LINE_OUT              ; are we at end of line?
  7094                                  	;jne	short countloop			; no - keep counting
  7095 00001903 08C0                    	or	al,al	
  7096 00001905 75FA                    	jnz	short countloop
  7097                                  	; 06/03/2023
  7098                                  	; al = 0 ; (*) 
  7099                                  
  7100                                  	;;;;mov	al,[Space]
  7101                                  	;;;mov	al,[ss:Space] ; 15/01/2023 - MSDOS 5.0 COMMAND.COM
  7102                                  	;;mov	al,space_chr ; Retro DOS v4.0 (& v4.1) COMMAND.COM
  7103                                  	; 16/04/2023
  7104                                  	;mov	al,20h ; ' ' 
  7105 00001907 4E                      	dec	si				; move back one
  7106                                          ;mov	[si],al				; put a space at end of line
  7107 00001908 C60420                  	mov	byte [si],20h ; ' ' ; space_chr
  7108                                  
  7109                                  ; We now know how long the new pathspec for command.com is. Time to
  7110                                  ; figure out how long the current COMSPEC setting is, and then to move
  7111                                  ; all the environment data up, throwing that COMSPEC setting away, and
  7112                                  ; preparing to append the new COMSPEC. ComspOffset (the offset of
  7113                                  ; where the filespec exists in the environment) is updated as well.
  7114                                  
  7115                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7116                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:19FEh
  7117                                  
  7118                                  	; MSDOS 6.0
  7119 0000190B 51                      	push	cx ; * 				;
  7120 0000190C B90080                          mov	cx,ENVBIG ; 32768		;
  7121 0000190F 368B3E[7020]                    mov	di,[ss:ComspOffset]		; get location of COMSPEC
  7122                                          ;mov	al,0                            ;
  7123                                  	; 06/06/2023
  7124                                  	; al = 0 ; (*)
  7125 00001914 F2AE                    	repne	scasb                           ; find the end of COMSPEC
  7126 00001916 89FE                            mov	si,di                           ;
  7127                                  comp_endenv:					;
  7128 00001918 AE                      	scasb					; end of env?
  7129 00001919 7404                    	je	short got_endenv		; yes
  7130 0000191B F2AE                    	repne	scasb				;
  7131 0000191D EBF9                    	jmp	short comp_endenv		;
  7132                                  got_endenv:					;
  7133 0000191F 89F9                    	mov	cx,di				;
  7134 00001921 29F1                    	sub	cx,si				;
  7135 00001923 368B3E[7020]            	mov	di,[ss:ComspOffset]		;
  7136 00001928 83EF08                  	sub	di,ComspStrLen	; sub di,8	;
  7137 0000192B 1E                      	push	ds ; +				;
  7138 0000192C 06                      	push	es				;
  7139 0000192D 1F                      	pop	ds				;
  7140 0000192E F3A4                    	rep	movsb				;
  7141 00001930 4F                      	dec	di				; copy in new COMSPEC=
  7142 00001931 0E                      	push	cs				;
  7143 00001932 1F                      	pop	ds				;
  7144                                          ;assume ds:RESGROUP			;
  7145                                  	;mov    si,offset RESGROUP:ComspString	;
  7146 00001933 BE[7220]                	mov	si,ComspString			; "COMSPEC=\COMMAND.COM"
  7147                                  	;mov	cx,ComspStrLen	; mov cx,8	;
  7148 00001936 B108                            mov	cl,ComspStrLen	; mov cl,8
  7149 00001938 F3A4                    	rep	movsb				;
  7150 0000193A 893E[7020]              	mov	[ComspOffset],di		;
  7151 0000193E 1F                      	pop	ds ; + 				;
  7152                                          ;assume ds:nothing			;
  7153 0000193F 59                      	pop	cx ; *				;
  7154                                  	;
  7155 00001940 5E                      	pop	si ; **				; get new comspec location back
  7156                                  
  7157                                  	;; MSDOS 3.3 COMMAND.COM
  7158                                  	;;mov	byte [CHUCKENV],0		; If search specified -- no inheritance
  7159                                  	;;mov	ax,PATHSTRING	; "PATH="	; Figure environment pointer
  7160                                  	;;mov	cl,4
  7161                                  	;;shr	ax,cl
  7162                                  	;;mov	dx,ds
  7163                                  	;;add	ax,dx
  7164                                  	;;mov	[ENVIRSEG],ax
  7165                                  	;;mov	es,ax
  7166                                  	;;;mov	al,' '
  7167                                  	;;mov	al,[SPACE_CHR]
  7168                                  	;;mov	[si-1],al
  7169                                  	;;pop	si ; **				; Remember location
  7170                                  	;;pop	cx ; *				; and count
  7171                                  	;;;mov	di,[ECOMLOC]
  7172                                  	;;mov	di,[COMSPOFFSET]
  7173                                  
  7174                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7175                                  	;; 15/01/2023
  7176                                  	;; MSDOS 5.0 COMMAND.COM
  7177                                  	;pop	si ; **
  7178                                  	;;mov	di,14
  7179                                  	;mov	di,ECOMSPEC ; mov di,0Eh
  7180                                  
  7181                                  ComtrLoop:
  7182                                  	; MSDOS 3.3 & MSDOS 6.0
  7183 00001941 AC                      	lodsb
  7184 00001942 49                      	dec	cx
  7185                                  	;;;;cmp	al,' '
  7186                                  	;;;cmp	al,[space_chr]
  7187                                  	;;cmp	al,[ss:Space] ;  MSDOS 5.0 COMMAND.COM
  7188                                  	;cmp	al,space_chr ; Retro DOS v4.0 (& v4.1) COMMAND.COM
  7189                                  	; 16/04/2023
  7190 00001943 3C20                    	cmp	al,20h ; ' ' ; space_chr
  7191 00001945 7416                    	je	short SetComsr
  7192                                  	; MSDOS 3.3
  7193                                  	;cmp	al,9
  7194                                  	;je	short SetComsr
  7195                                  	; MSDOS 3.3 & MSDOS 6.0
  7196 00001947 AA                      	stosb
  7197                                  
  7198                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7199                                  %if 1
  7200                                  ;ifdef	DBCS
  7201 00001948 30E4                    	xor	ah,ah
  7202                                  ;endif
  7203                                  %endif
  7204 0000194A E311                    	jcxz	SetComsr
  7205                                  
  7206                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7207                                  %if 1
  7208                                  ;ifdef DBCS
  7209 0000194C 1E                      	push	ds				; Make sure we have
  7210 0000194D 0E                      	push	cs				;  local DS for
  7211 0000194E 1F                      	pop	ds				;  ItestKanj
  7212 0000194F E82BFB                  	call	ITestKanj
  7213 00001952 1F                      	pop	ds				; restore parser ds
  7214 00001953 74EC                    	jz	short ComtrLoop
  7215 00001955 49                      	dec	cx
  7216 00001956 A4                      	movsb
  7217 00001957 FEC4                    	inc	ah
  7218 00001959 E302                    	jcxz	SetComsr
  7219                                  ;endif
  7220                                  %endif
  7221 0000195B EBE4                    	jmp	short ComtrLoop
  7222                                  
  7223                                  SetComsr:
  7224                                  	; 15/01/2023
  7225                                  	; MSDOS 6.0
  7226 0000195D 51                      	push	cx ; **
  7227 0000195E 0E                      	push	cs				; Get local segment
  7228 0000195F 1F                      	pop	ds				;
  7229                                  	;assume	ds:ResGroup			;
  7230 00001960 1E                      	push	ds ; *
  7231                                  	;mov	si,offset ResGroup:ComSpect
  7232 00001961 BE[2D20]                	mov	si,COMSPECT ; "\COMMAND.COM"
  7233 00001964 B90E00                  	mov	cx,14
  7234 00001967 268A45FF                	mov	al,[es:di-1]
  7235                                  
  7236                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7237                                  %if 1
  7238                                  ;ifdef DBCS
  7239 0000196B 08E4                    	or	ah,ah
  7240 0000196D 7508                    	jnz	short iNotRoot			; Last char was KANJI second byte, might be '\'
  7241                                  ;endif
  7242                                  %endif
  7243 0000196F 3A06[4F04]              	cmp	al,[RDirChar]
  7244 00001973 7502                    	jne	short iNotRoot
  7245 00001975 46                      	inc	si				; Don't make a double /
  7246 00001976 49                      	dec	cx
  7247                                  	
  7248                                  	; MSDOS 3.37
  7249                                  	;push	si
  7250                                  	;push	cx
  7251                                  	;push	ds
  7252                                  	;mov	si,COMSPECT ; "/COMMAND.COM"
  7253                                  	;mov	cx,14
  7254                                  	;mov	al,[es:di-1]
  7255                                  	;call	PATHCHRCMPR
  7256                                  	;jnz	short INOTROOT			
  7257                                  	;inc	si				; Don't make a double /
  7258                                  	;dec	cx
  7259                                  
  7260                                  iNotRoot:
  7261                                  	; MSDOS 3.3 & MSDOS 6.0
  7262 00001977 F3A4                    	rep	movsb
  7263                                  
  7264                                  	;;mov	dx,[ECOMLOC]			; Now lets make sure its good!
  7265                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7266                                  	; MSDOS 6.0 
  7267 00001979 8B16[7020]              	mov	dx,[ComspOffset] ; [COMSPOFFSET]
  7268                                  	; 15/01/2023
  7269                                  	;;mov	dx,14
  7270                                  	;mov	dx,ECOMSPEC ; mov dx,0Eh ; MSDOS 5.0 COMMAND.COM
  7271                                  
  7272 0000197D 06                      	push	es
  7273 0000197E 1F                      	pop	ds
  7274                                  	;;mov	ax,OPEN shl 8
  7275                                  	;mov	ax,OPEN*256 ; 3D00h
  7276 0000197F B8003D                  	mov	ax,3D00h ; 15/01/2023
  7277 00001982 CD21                    	int	21h				; Open COMMAND.COM
  7278 00001984 1F                      	pop	ds ; *
  7279 00001985 720E                    	jc	short SetComsrBad		; No COMMAND.COM here
  7280 00001987 89C3                    	mov	bx,ax				; Handle
  7281 00001989 B43E                    	mov	ah,3Eh ; 15/01/2023
  7282                                  	;mov	ah,CLOSE ; 3Eh
  7283 0000198B CD21                    	int	21h				; Close COMMAND.COM
  7284                                  SetComsrRet:
  7285                                  	; 15/01/2023
  7286 0000198D 59                      	pop	cx ; **
  7287 0000198E 5E                      	pop	si ; ***
  7288                                  
  7289                                  	; MSDOS 6.0
  7290 0000198F 1F                      	pop	ds ; ****			;
  7291                                  	;assume	ds:ResGroup			;
  7292                                  	;
  7293 00001990 0E                      	push	cs				; Make sure local ES is
  7294 00001991 07                      	pop	es				;  restored
  7295 00001992 E96FFD                  	jmp	Parse_command_line		; continue parsing command line
  7296                                  
  7297                                  	; MSDOS 3.3
  7298                                  ;ARGSDONEJ2:
  7299                                  	;jcxz	ARGSDONE
  7300                                  	;jmp	CHKARG
  7301                                  
  7302                                  	; 16/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7303                                  SetComsrBad:
  7304                                  	; MSDOS 3.3 & MSDOS 6.0
  7305                                  	;mov	dx,offset ResGroup:BadComlkMsg	; dx = ptr to msg
  7306 00001995 BA[0022]                	mov	dx,BADCOMLKMES
  7307                                  
  7308                                  ;	Note: we're about to make a near call to TriageError, which
  7309                                  ;	lives in a different segment and group. Some linkers will
  7310                                  ;	generate a warning like "Possible fix-up overflow". We're
  7311                                  ;	ok, though, because we all fit in 64 KB and, at init time,
  7312                                  ;	we're still all together.
  7313                                  
  7314                                  	; 16/01/2023
  7315                                  	;TRIAGEERROR equ TRANSTART+TriageError
  7316                                  	;(MSDOS 5.0 COMMAND.COM, 2320h+2D92h)
  7317                                  
  7318                                  	; 06/06/2023
  7319                                  	TRIAGEERROR equ TRANSTART+TriageError
  7320                                  	;(MSDOS 6.22 COMMAND.COM, 26E0h+333Ch)
  7321                                  
  7322                                  	;;;call	50B2h ; MSDOS 5.0 COMMAND.COM
  7323                                  	;;call	5A1Ch ; MSDOS 6.22 COMMAND.COM
  7324                                  	; 18/07/2024
  7325                                  	;call	5A6Ch ; PCDOS 7.1 COMMAND.COM	
  7326 00001998 E8(8B58)                	call	TRIAGEERROR	; TRIAGEERROR procedure is at offset 354Eh
  7327                                  				; in original MSDOS 3.3 COMMAND.COM
  7328                                  
  7329                                  			; TriageError procedure is at offset 50B2h
  7330                                  			; in original MSDOS 5.0 COMMAND.COM	
  7331 0000199B 83F841                  	cmp	ax,65
  7332 0000199E 7503                    	jne	short doprt
  7333                                  	;mov	dx,offset ResGroup:BadComaccMsg	; dx = ptr to msg
  7334 000019A0 BA[2922]                	mov	dx,BADCOMACCMSG
  7335                                  doprt:
  7336 000019A3 E835FA                  	call	RPrint
  7337                                  	;mov	si,offset ResGroup:ComSpect
  7338 000019A6 BE[2D20]                	mov     si,COMSPECT ; "\COMMAND.COM"
  7339                                  	;;mov	di,[ECOMLOC]
  7340                                  	; 06/06/2023
  7341 000019A9 8B3E[7020]              	mov	di,[ComspOffset] ; MSDOS 6.22 COMMAND.COM
  7342                                  	; 16/01/2023
  7343                                  	;mov	di,ECOMSPEC ; mov di,0Eh ; MSDOS 5.0 COMMAND.COM
  7344 000019AD B90E00                  	mov	cx,14
  7345 000019B0 F3A4                    	rep	movsb				; get my default back
  7346                                  
  7347 000019B2 EBD9                    	jmp	short SetComsrRet
  7348                                  
  7349                                  	; 16/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7350                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1927h (CODERES:0BE7h)
  7351                                  
  7352                                  	; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7353                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1A99h (CODERES:0C49h)
  7354                                  ArgsDone:
  7355                                  	; MSDOS 6.0
  7356 000019B4 8E06[3A04]              	mov	es,[EnvirSeg]			; get environment back
  7357                                  	;assume	es:nothing			;
  7358                                  
  7359                                  	; MSDOS 3.3 & MSDOS 6.0
  7360 000019B8 803E[A202]00                    cmp	byte [PermCom],0
  7361 000019BD 742E                            jz	short ComReturns
  7362                                  
  7363 000019BF 06                      	push	es				; Save environment pointer
  7364 000019C0 B450                    	mov	ah,50h
  7365                                  	;mov	ah,SET_CURRENT_PDB ; 50h
  7366 000019C2 8CDB                    	mov	bx,ds
  7367 000019C4 8EC3                    	mov	es,bx
  7368 000019C6 CD21                    	int	21h				; current process is me
  7369 000019C8 BF0A00                  	mov	di,PDB.EXIT ; mov di,0Ah	; Diddle the addresses in my header
  7370                                  	;;mov	ax,offset RESGROUP:LODCOM
  7371                                  	;mov	ax,LODCOM
  7372                                  	; 16/01/2023
  7373 000019CB B8[E000]                	mov	ax,LodCom_Trap
  7374 000019CE AB                              stosw
  7375 000019CF 8CD8                            mov	ax,ds
  7376 000019D1 AB                              stosw
  7377                                  	;;mov	ax,offset RESGROUP:CONTC
  7378                                  	;mov	ax,CONTC
  7379                                  	; 16/01/2023
  7380 000019D2 B8[AC00]                	mov	ax,Ctrlc_Trap
  7381 000019D5 AB                              stosw
  7382 000019D6 8CD8                            mov	ax,ds
  7383 000019D8 AB                              stosw
  7384                                  	;;mov	ax,offset DATARES:CritErr_Trap  ; MSDOS 6.0
  7385                                  	;mov	ax,CRITERR
  7386                                  	; 16/01/2023
  7387 000019D9 B8[B700]                	mov	ax,CritErr_Trap
  7388 000019DC AB                      	stosw
  7389 000019DD 8CD8                    	mov     ax,ds
  7390 000019DF AB                      	stosw
  7391                                  	;;mov	word ptr ds:16h,ds
  7392                                  	;mov	word ptr ds:[Pdb_Parent_Pid],ds ; Parent is me forever
  7393 000019E0 8C1E1600                	mov	[PDB.PARENT_PID],ds
  7394                                          ;;mov	dx,offset RESGROUP:Int_2e
  7395                                  	;mov	dx,Int_2e
  7396                                          ; 16/01/2023
  7397 000019E4 BA[A100]                	mov	dx,Int2e_Trap
  7398 000019E7 B82E25                  	mov	ax,252Eh
  7399                                  	;;mov	ax,(SET_INTERRUPT_VECTOR SHL 8) OR 2Eh
  7400                                  	;mov	ax,(SET_INTERRUPT_VECTOR*256) | 2Eh ; 252Eh
  7401 000019EA CD21                    	int     21h	; DOS - SET INTERRUPT VECTOR
  7402                                  			; AL = interrupt number
  7403                                  			; DS:DX = new vector to be used for specified interrupt
  7404 000019EC 07                              pop	es				; Remember environment
  7405                                  	
  7406                                  ComReturns:
  7407                                          ;mov	ax,word ptr ds:Pdb_Parent_Pid
  7408 000019ED A11600                  	mov	ax,[PDB.PARENT_PID] ; mov ax,ds:16h
  7409                                  	; 16/01/2023
  7410 000019F0 A3[3E02]                	mov	[Parent],ax			; Save parent
  7411                                          ;mov	word ptr ds:Pdb_Parent_Pid,ds 	; Parent is me
  7412 000019F3 8C1E1600                        mov	[PDB.PARENT_PID],ds ; mov word ptr ds:16h,ds
  7413                                          ;mov	ax,word ptr ds:PDB_Jfn_Table
  7414 000019F7 A11800                          mov	ax,[PDB.JFN_TABLE] ; mov ax,ds:18h
  7415 000019FA A3[9F02]                        mov	[Io_Save],ax		; Get the default stdin and out
  7416 000019FD 8C1E[3E04]                      mov	[Com_Ptr+2],ds		; Set all these to resident
  7417 00001A01 8C1E[4204]                      mov	[Com_Fcb1+2],ds
  7418 00001A05 8C1E[4604]              	mov	[Com_Fcb2+2],ds
  7419                                          ;mov	di,offset ResGroup:ComSpec
  7420 00001A09 BF[4B02]                        mov	di,ComSpec
  7421                                  
  7422                                  	;;mov	si,[ECOMLOC]
  7423                                  	; 06/06/2023 - MSDOS 6.22 COMMAND.COM
  7424 00001A0C 8B36[7020]              	mov	si,[ComspOffset]
  7425                                  	; 16/01/2023 - MSDOS 5.0 COMMAND.COM
  7426                                  	;mov	si,ECOMSPEC ; mov si,0Eh
  7427                                  
  7428 00001A10 803E[5920]00            	cmp	byte [AllocedEnv],0 ; MSDOS 6.0
  7429                                          ;cmp	byte [CHUCKENV],0 ; MSDOS 3.3
  7430                                  	
  7431 00001A15 8CD8                    	mov	ax,ds				; Xchg es,ds
  7432 00001A17 06                      	push	es
  7433 00001A18 1F                      	pop	ds
  7434 00001A19 8EC0                    	mov	es,ax
  7435                                  
  7436                                  	; 06/06/2023
  7437 00001A1B 7517                    	jne	short CopyComsp ; MSDOS 6.0
  7438                                  	; 16/01/2023	
  7439                                  	;je	short CopyComsp ; MSDOS 5.0
  7440                                  	;;je	short COPYCOMSP	; MSDOS 3.3	; All set up for copy
  7441                                  
  7442 00001A1D 0E                              push	cs
  7443 00001A1E 1F                              pop	ds
  7444                                  
  7445                                          ;mov	si,offset ResGroup:ComspString
  7446 00001A1F BE[7220]                	mov	si,ComspString ; "COMSPEC=\COMMAND.COM"
  7447 00001A22 06                      	push	es
  7448 00001A23 57                      	push	di
  7449 00001A24 E89A02                  	call	IfindE
  7450 00001A27 89FE                    	mov	si,di
  7451 00001A29 06                      	push	es
  7452 00001A2A 1F                      	pop	ds
  7453 00001A2B 5F                      	pop	di
  7454 00001A2C 07                      	pop	es
  7455 00001A2D 7305                            jnc	short CopyComsp
  7456                                  
  7457                                  	; 06/06/2023
  7458                                  	; MSDOS 6.0
  7459                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1B04h
  7460                                  ComSpecNofnd:
  7461                                  	;;mov	si,offset ResGroup:ComspString
  7462                                  	;mov	si,ComspString ; "COMSPEC=\COMMAND.COM"
  7463                                  	;add	si,ComspStrLen ; add si,8
  7464 00001A2F BE[7A20]                	mov	si,ComspString+ComspStrLen
  7465                                  	
  7466                                  	;; 21/01/2023
  7467                                  	;; MSDOS 5.0 COMMAND.COM - RESGROUP:19A1h
  7468                                  	;;mov	si,0Eh
  7469                                  	;mov	si,ECOMSPEC
  7470                                  	
  7471 00001A32 0E                      	push	cs
  7472 00001A33 1F                      	pop	ds	
  7473                                  
  7474                                  	; 21/01/2023
  7475                                  ;COMSPECNOFND:
  7476                                  	; MSDOS 3.3
  7477                                          ;;mov	si,[es:ECOMLOC]
  7478                                          ;mov	si,[es:COMSPOFFSET]
  7479                                  	;;add	si,offset RESGROUP:PATHSTRING
  7480                                          ;add	si,PATHSTRING ; "PATH="
  7481                                  	;push	cs
  7482                                  	;pop	ds
  7483                                  
  7484                                  CopyComsp:
  7485                                  	; 21/01/2023
  7486                                  ;COPYCOMSP:
  7487                                  	; MSDOS 3.3 & MSDOS 6.0
  7488                                  	;;mov	es:PutBackComSpec.SubstPtr,di
  7489                                  	;mov	[es:PUTBACKSUBSTPTR],di		; Save ptr to beginning of comspec path
  7490 00001A34 26893E[2A02]            	mov	[es:PutBackComSpec],di
  7491 00001A39 807C013A                	cmp	byte [si+1],':'			; Is there a drive specifier in comspec
  7492 00001A3D 7506                    	jne	short CopyComspLoop		; If not, do not skip over first 2 bytes
  7493                                  	;;add	es:PutBackComSpec.SubstPtr,2
  7494                                  	;add	word [es:PUTBACKSUBSTPTR],2
  7495 00001A3F 268306[2A02]02          	add	word [es:PutBackComSpec],2
  7496                                  CopyComspLoop:
  7497 00001A45 AC                      	lodsb
  7498 00001A46 AA                      	stosb
  7499 00001A47 08C0                    	or	al,al
  7500 00001A49 75FA                    	jnz	short CopyComspLoop
  7501                                  
  7502 00001A4B 26893E[8B02]            	mov	[es:ComSpec_End],di		; Save ptr to end of comspec path
  7503 00001A50 26FF0E[8B02]            	dec	word [es:ComSpec_End]
  7504 00001A55 268A26[9402]            	mov	ah,[es:ComDrv]
  7505 00001A5A 80C440                  	add	ah,'A'-1 ; 40h
  7506 00001A5D 268826[2F02]            	mov	[es:PutBackDrv],ah		; save drive letter
  7507                                  
  7508                                  	; 21/01/2023 - Retrro DOS v4.0 (& v4.1) COMMAND.COM
  7509                                  	
  7510                                  	; MSDOS 6.0
  7511 00001A62 E8E702                  	call	setup_for_messages		; set up parse and extended error messages
  7512                                  
  7513                                  ; The routine below sets up the exact resident size of COMMAND. If this is not
  7514                                  ; the first COMMAND, then the resident code is not duplicated and the resident
  7515                                  ; size is just the data. If we are the first COMMAND, it checks if we are to
  7516                                  ; be loaded into HIMEM. If not, then the resident size includes the code and
  7517                                  ; the data otherwise it is just the data.
  7518                                   
  7519 00001A65 E88603                  	call	Setup_res_end			; put resident size in ResSize
  7520                                  
  7521 00001A68 0E                      	push	cs
  7522 00001A69 1F                      	pop	ds
  7523                                  	;assume	ds:RESGROUP
  7524                                  
  7525                                  ;Public EnvMaximum
  7526                                          ; 14/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7527                                  EnvMaximum:	; MSDOS 5.0 COMMAND.COM - RESGROUP:19DCh
  7528                                          ; 06/06/2023 - Retro DOS v4.2 COMMAND.COM
  7529                                  		; MSDOS 6.22 COMMAND.COM - RESGROUP:1B53h
  7530                                          ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  7531                                  		; PCDOS 7.1 COMMAND.COM - RESGROUP:1B53h
  7532                                  
  7533                                  	; 21/01/2023
  7534                                  	; MSDOS 6.0
  7535                                  	;;mov	si,offset RESGROUP:TranStart
  7536                                  	;;mov	si,2320h	; MSDOS 5.0 COMMAND.COM
  7537                                  	; 06/06/2023
  7538                                  	;;mov	si,26E0h	; MSDOS 6.22 COMMAND.COM
  7539                                  	;mov	si,TRANSTART
  7540                                  	;add	si,100h
  7541                                  	; 23/04/2023
  7542 00001A6A BEE028                  	mov	si,TRANSTART+100h
  7543                                  
  7544                                  	;;mov	cx,offset TRANGROUP:TranDataEnd - 100H
  7545                                  	;;mov	cx,87C2h	; MSDOS 5.0 COMMAND.COM
  7546                                  	; 06/06/2023
  7547                                  	;;mov	cx,9D53h	; MSDOS 6.22 COMMAND.COM
  7548                                  	; 18/07/2024
  7549                                  	;mov	cx,9B47h	; PCDOS 7.1 COMMAND.COM	
  7550 00001A6D B9[A196]                	mov	cx,TRANDATAEND-100h
  7551                                  
  7552 00001A70 FC                      	cld
  7553 00001A71 D1E9                    	shr	cx,1
  7554 00001A73 31D2                    	xor	dx,dx
  7555                                  Ichksum:
  7556 00001A75 AD                      	lodsw
  7557 00001A76 01C2                    	add	dx,ax
  7558 00001A78 83D200                  	adc	dx,0
  7559 00001A7B E2F8                    	loop	Ichksum
  7560                                  
  7561 00001A7D 8916[9702]                      mov	[Sum],dx			; store checksum
  7562                                  
  7563 00001A81 803E[4C20]00                    cmp     byte [PRDATTM],0
  7564 00001A86 750C                            jne	short NoBatchSeg		; don't do autoexec or date time
  7565                                  	
  7566                                  ; Allocate batch segment for d:/autoexec.bat + no arguments
  7567                                  
  7568                                  	;mov	bx,((SIZE BatchSegment) + 15 + 1 + 0fh)/16
  7569                                  	; 21/01/2023
  7570                                  	;mov	bx,4
  7571 00001A88 BB0400                          mov	bx,((BATCHSEGMENT.SIZE)+16+0Fh)/16 ; (33+16+15)/16
  7572 00001A8B B448                    	mov	ah,48h
  7573                                  	;mov	ah,ALLOC                        ;
  7574 00001A8D CD21                            int	21h                             ;
  7575 00001A8F 7203                    	jc	short NoBatchSeg		; didn't allocate - pretend no batch
  7576 00001A91 A3[4902]                        mov	[Batch],ax			; save batch segment
  7577                                  
  7578                                  NoBatchSeg:
  7579                                  	; 21/01/2023
  7580                                  	; MSDOS 6.0 (& MSDOS 5.0)
  7581 00001A94 8B1E[3A04]              	mov	bx,[EnvirSeg]			; get old environment segment
  7582 00001A98 891E[8B20]              	mov	[OldEnv],bx			; save it
  7583 00001A9C C706[8D20]0000          	mov	word [UsedEnv],0		; initialize env size counter
  7584 00001AA2 8EDB                    	mov	ds,bx
  7585                                  	;assume	ds:nothing
  7586                                  	
  7587 00001AA4 31F6                    	xor	si,si
  7588 00001AA6 89F7                    	mov	di,si
  7589                                  
  7590                                  ; This is the maximum allowed size for the environment
  7591                                  
  7592                                  	; 21/01/2023
  7593                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1A1Eh
  7594                                  	;mov	bx,4096 - 1 ; 0FFFh		; max. allowed env. size
  7595                                  	;;mov	[ss:EnvMax],bx
  7596                                  	;shl	bx,1
  7597                                  	;shl	bx,1
  7598                                  	;shl	bx,1
  7599                                  	;shl	bx,1
  7600 00001AA8 BBF0FF                  	mov	bx,(4096-1)<<4 ; mov bx,0FFF0h
  7601 00001AAB 36891E[8920]            	mov	[ss:EnvMax], bx			; convert envmax to bytes
  7602 00001AB0 4B                      	dec	bx				; dec by one to leave room for double 0
  7603 00001AB1 31D2                    	xor	dx,dx				; use dx to indicate that there was
  7604                                  						; no environment size error.
  7605                                  ;public NxtStr
  7606                                  NxtStr:
  7607 00001AB3 E8E101                  	call	GetStrLen			; get the size of the current env string
  7608                                  
  7609                                  ;Bugbug: Can use ss here to address UsedEnv
  7610                                  
  7611 00001AB6 1E                      	push	ds                              ; get addressability to environment
  7612 00001AB7 0E                              push	cs                              ;                       counter
  7613 00001AB8 1F                              pop	ds                              ;
  7614                                  	;assume	ds:ResGroup
  7615 00001AB9 010E[8D20]                      add	[UsedEnv],cx			; add the string length to env size
  7616 00001ABD 1F                      	pop	ds                              ;
  7617                                  	;assume	ds:nothing
  7618                                  	
  7619 00001ABE 83F901                  	cmp	cx,1				; end of environment was encountered.
  7620 00001AC1 7405                    	je	short EnvExit
  7621 00001AC3 29CB                    	sub	bx,cx
  7622                                  	;jae	short OkCpyStr			; can't fit in all of enviroment.
  7623                                  	; 21/01/2023
  7624 00001AC5 73EC                    	jae	short NxtStr
  7625 00001AC7 42                      	inc	dx				; out of env space msg must be displayed
  7626                                  	;jmp	short EnvExit
  7627                                  
  7628                                  ;OkCpyStr:
  7629                                  	;jmp	short NxtStr
  7630                                  
  7631                                  EnvExit:
  7632 00001AC8 0E                      	push	cs
  7633 00001AC9 1F                      	pop	ds
  7634                                  	;assume	ds:ResGroup
  7635 00001ACA 09D2                    	or	dx,dx				; dx will be non-zero if error
  7636 00001ACC 7406                    	jz	short EnvNoErr
  7637                                  	;mov	dx,offset ResGroup:OutEnvMsg	; dx = ptr to msg
  7638 00001ACE BA[8021]                	mov	dx,OUTENVMSG
  7639 00001AD1 E807F9                  	call 	RPrint
  7640                                  EnvNoErr:
  7641 00001AD4 A1[8720]                	mov	ax,[EnvSiz]			; env size previously set
  7642 00001AD7 B104                    	mov	cl,4
  7643 00001AD9 D3E0                    	shl	ax,cl				; get size in bytes
  7644 00001ADB 3B06[8D20]              	cmp	ax,[UsedEnv]			; is it a new env?
  7645 00001ADF 7706                    	ja	short st_envsize		; yes, store the size
  7646 00001AE1 A1[8D20]                	mov	ax,[UsedEnv]
  7647 00001AE4 83C00F                  	add	ax,15				; round up
  7648                                  st_envsize:	
  7649 00001AE7 D3E8                    	shr	ax,cl
  7650 00001AE9 A3[8720]                	mov	[EnvSiz],ax			; store env size needed(paras)
  7651                                  
  7652                                  ;if MSVER
  7653                                  	;cmp	SingleCom,0
  7654                                  	;jnz	nophead 			; don't print header if SingleCom
  7655                                  	;mov	dx,offset ResGroup:CopyrightMsg	; dx = ptr to msg
  7656                                  	;call	RPrint
  7657                                  ;nophead:
  7658                                  ;endif
  7659                                  	; 21/01/2023
  7660                                  
  7661                                  	; MSDOS 3.3 & 6.0
  7662 00001AEC 833E[4902]00            	cmp     word [Batch],0		; did we set up a batch segment?
  7663 00001AF1 7503                    	jnz     short DoDate		; yes - go initialize it
  7664 00001AF3 E99300                  	jmp     NoDttm			; don't do autoexec or date time
  7665                                  
  7666                                  DoDate:
  7667                                  
  7668                                  ; allocate batch segment for d:/autoexec.bat + no arguments
  7669                                  
  7670 00001AF6 A1[4902]                	mov	ax,[Batch]		; get batch segment
  7671 00001AF9 C606[9D02]03            	mov	byte [EchoFlag],3	; set batch echo
  7672 00001AFE C706[AE02]0100          	mov	word [Nest],1		; set nest flag to 1 batch
  7673 00001B04 8EC0                    	mov	es,ax
  7674                                  
  7675                                  ; initialize the segment
  7676                                  
  7677 00001B06 31FF                    	xor	di,di
  7678                                  	;;mov	al,0
  7679                                  	;mov	al,BATCHTYPE ; 0
  7680                                  	; 06/06/2023
  7681 00001B08 31C0                    	xor	ax,ax
  7682 00001B0A AA                      	stosb
  7683                                  	;mov	al,1			; initialize echo for batch exit
  7684                                  	;inc	al
  7685                                  	; 22/07/2024
  7686 00001B0B 40                      	inc	ax
  7687 00001B0C AA                      	stosb
  7688                                  
  7689                                  ; Hosebag! This guy does not use the struct fields to init the BatchSegment
  7690                                  
  7691                                  	;xor	ax,ax			; initialize to zero
  7692                                  	; 06/06/2023
  7693                                  	;dec	al ; ax = 0
  7694                                  	; 22/07/2024
  7695 00001B0D 48                      	dec	ax
  7696                                  
  7697                                  	; 21/01/2023
  7698 00001B0E AA                      	stosb	; MSDOS 6.0 		; clear out BatchEOF
  7699                                  
  7700 00001B0F AB                      	stosw				; batch segment of last job - batlast
  7701 00001B10 AB                      	stosw				; segment for FOR
  7702 00001B11 AA                      	stosb				; FOR flag
  7703 00001B12 AB                      	stosw				; position in file - batseek
  7704 00001B13 AB                      	stosw
  7705                                  
  7706                                  ; clean out the parameters
  7707                                  
  7708                                  	;mov	ax,-1			; initialize to no parameters
  7709                                  	; 06/06/2023
  7710 00001B14 48                      	dec	ax ; ax = -1
  7711                                  
  7712 00001B15 B90A00                  	mov	cx,10
  7713 00001B18 F3AB                    	rep	stosw
  7714                                  
  7715                                  ; decide whether we should grab the default drive
  7716                                  
  7717 00001B1A 803E[3B20]00            	cmp	byte [AUTOBAT],0 ; ":\AUTOEXEC.BAT"
  7718 00001B1F 7509                    	jne	short NoAutSet
  7719 00001B21 B419                    	mov	ah,19h	; 21/01/2023
  7720                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
  7721 00001B23 CD21                    	int	21h
  7722                                  	;;add	al,'A'
  7723                                  	;add	al,[letter_A] ; Ucasea
  7724                                  	;add	al,[ucasea] ; 21/01/2023
  7725                                  	; 21/01/2023
  7726 00001B25 0441                    	add	al,'A'
  7727 00001B27 A2[3B20]                	mov	[AUTOBAT],al
  7728                                  
  7729                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7730                                  %if 0
  7731                                  	; 21/01/2023
  7732                                  	; 06/06/2023
  7733                                  	mov	[KAUTOBAT],al
  7734                                  %endif
  7735                                  
  7736                                  NoAutSet:
  7737                                  
  7738                                  ; copy in the batch file name (including nul)
  7739                                  
  7740                                  	;mov	si,offset ResGroup:AutoBat
  7741 00001B2A BE[3B20]                	mov	si,AUTOBAT
  7742 00001B2D B90800                  	mov	cx,8
  7743 00001B30 F3A5                    	rep	movsw
  7744                                  	; 23/04/2023
  7745 00001B32 A4                      	movsb	; MSDOS 6.0		; move in carriage return to terminate string
  7746                                  
  7747                                  	;mov	dx,offset ResGroup:AutoBat
  7748 00001B33 BA[3B20]                	mov     dx,AUTOBAT ; ":\AUTOEXEC.BAT"
  7749                                  
  7750                                  	;;mov	ax,OPEN shl 8
  7751 00001B36 B8003D                  	mov	ax,3D00h ; 21/01/2023
  7752                                  	;mov	ax,OPEN*256 ; 3D00h	; open for read
  7753 00001B39 CD21                    	int	21h			; see if autoexec.bat exists
  7754 00001B3B 7208                    	jc	short noabat
  7755 00001B3D 89C3                    	mov	bx,ax
  7756 00001B3F B43E                    	mov	ah,3Eh ; 21/01/2023
  7757                                  	;mov	ah,CLOSE  ; 3Eh
  7758 00001B41 CD21                    	int	21h
  7759                                  	;jmp	Drv0			; go process autoexec
  7760                                  	; 22/07/2024
  7761 00001B43 EB51                    	jmp	short Drv0
  7762                                  
  7763                                  noabat:
  7764 00001B45 50                      	push	ax
  7765 00001B46 E85701                  	call	Setup_Seg
  7766 00001B49 A3[5720]                	mov	[triage_add+2],ax
  7767 00001B4C 58                      	pop	ax
  7768 00001B4D FF1E[5520]              	call	far [triage_add]	; get extended error
  7769 00001B51 83F841                  	cmp	ax,65			; network access denied?
  7770                                  	;jne	short OPENERR		; no - go deallocate batch
  7771                                  	; 21/01/2023
  7772                                  	;;je	short AccDenErr
  7773                                  	; 22/07/2024
  7774 00001B54 7506                    	jne	short OpenErr
  7775                                  	; 06/06/2023
  7776                                  	;je	short AccDenErr
  7777                                  
  7778                                  	; 21/01/2023
  7779                                  ;_ACCDENERROR:					; yes - put out message
  7780                                  ;	;mov	dx,offset ResGroup:AccDen	; dx = ptr to msg
  7781                                  ;	mov	dx,ACCDENERR
  7782                                  ;	call	RPRINT
  7783                                  
  7784                                  	; 21/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7785                                  
  7786                                  	; MSDOS 6.0 (& MSDOS 5.0)
  7787                                  
  7788                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7789                                  ; 06/06/2023
  7790                                  ; 21/01/2023
  7791                                  %if 0
  7792                                  
  7793                                  ; If AUTOEXEC.BAT is not found, then check for KAUTOEXE.BAT. Changed
  7794                                  ; by Ellen to check only when in Korea. The country information
  7795                                  ; returned will overlay the old parse data area, but we don't care
  7796                                  ; since we won't need the parse information or country information.
  7797                                  ; We only care about the country code returned in BX.
  7798                                  
  7799                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1AE7h
  7800                                  	; 06/06/2023
  7801                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1C5Eh
  7802                                  
  7803                                  	;mov	dx,offset ResGroup:Internat_Info ; set up internat vars
  7804                                  	mov	dx,INTERNAT_INFO
  7805                                  	mov	ax,3800h
  7806                                  	;mov	ax,INTERNATIONAL<<8
  7807                                  	;;mov	ax,INTERNATIONAL shl 8		; get country dependent info
  7808                                  	int	21h				;
  7809                                  	jc	short NoKabat 			; error - don't bother with it
  7810                                  	cmp	bx,52h
  7811                                  	;cmp	bx,KOREA_COUNTRY_CODE		; are we speaking korean?
  7812                                  	jne	short OpenErr 			; no, don't check for kautoexe
  7813                                  
  7814                                  	;mov	di,BatFile			; 3/3/kk
  7815                                  	mov	di,20h
  7816                                  	;mov	si,offset ResGroup:KautoBat	; another trial to do	3/3/kk
  7817                                  	mov	si,KAUTOBAT
  7818                                  	mov	cx,8				; auto execution for the 3/3/kk
  7819                                  	rep	movsw				; non-english country	3/3/kk
  7820                                  	movsb					; move in carraige return to terminate string
  7821                                  	;mov	dx,offset ResGroup:KautoBat	; 3/3/kk
  7822                                  	mov	dx,KAUTOBAT
  7823                                  	mov	ax,3D00h
  7824                                  	;mov	ax,OPEN<<8
  7825                                  	;;mov	ax,OPEN shl 8			; 3/3/kk
  7826                                  	int	21h				; see if kautoexe.bat exists  3/3/kk
  7827                                  	jc	short NoKabat 			; 3/3/kk
  7828                                  	mov	bx,ax				; 3/3/kk
  7829                                  	mov	ah,3Eh
  7830                                  	;mov	ah,CLOSE			; 3/3/kk
  7831                                  	int	21h				; 3/3/kk
  7832                                  	jmp	short Drv0			; 3/3/kk
  7833                                  
  7834                                  NoKabat:					; 3/3/kk
  7835                                  	call	far [triage_add]		; get extended error
  7836                                  	cmp	ax,65				; network access denied?
  7837                                  	jnz	short OpenErr 			; no - go deallocate batch
  7838                                  
  7839                                  %endif	
  7840                                  	; 06/06/2023 - Retro DOS 4.2 COMMAND.COM
  7841                                  	; 21/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  7842                                  
  7843                                  AccDenErr:					; yes - put out message
  7844                                  	;mov	dx,offset ResGroup:AccDen	; dx = ptr to msg
  7845 00001B56 BA[D006]                	mov	dx,ACCDEN
  7846 00001B59 E87FF8                  	call	RPrint
  7847                                  OpenErr:
  7848                                  ;OPENERR:
  7849 00001B5C 8E06[4902]              	mov	es,[Batch]		; not found--turn off batch job
  7850 00001B60 B449                    	mov	ah,49h
  7851                                  	;mov	ah,DEALLOC ; 49h
  7852 00001B62 CD21                    	int	21h
  7853 00001B64 C706[4902]0000          	mov	word [Batch],0		; after dealloc in case of ^c
  7854 00001B6A C606[9D02]01            	mov	byte [EchoFlag],1
  7855 00001B6F C706[AE02]0000          	mov	word [Nest],0		; indicate no batch in progress
  7856                                  ;DoDttm:
  7857                                  	;mov	ax,offset TranGroup:Datinit
  7858 00001B75 B8[9A32]                	mov	ax,DATINIT
  7859 00001B78 A3[4D20]                	mov	[INITADD],ax
  7860                                  
  7861                                  	; MSDOS 6.0
  7862                                  ;;M004;;mov	ax,TrnSeg	
  7863                                  ;
  7864                                  ; M004; We cant use TrnSeg now because it is not initialized. We now that
  7865                                  ; M004; the transient starts on a para boundary at the label TranStart.
  7866                                  ; M004; We use TranStart to get the start of the transient segment.
  7867                                  
  7868                                  	; 21/01/2023
  7869                                  	;mov	ax,offset RESGROUP:TranStart	; M004
  7870                                  	;;mov	ax,2320h ; MSDOS 5.0 COMMAND.COM
  7871                                  	; 06/06/2023
  7872                                  	;mov	ax,26E0h ; MSDOS 6.22 COMMAND.COM
  7873                                  	;
  7874                                  	;mov	ax,TRANSTART
  7875                                  	;mov	cl,4				; M004
  7876                                  	;shr	ax,cl				; get relative seg ; M004
  7877                                  	; 06/06/2023
  7878 00001B7B B87E02                  	mov	ax,TRANSTART>>4	
  7879                                  
  7880 00001B7E 8CC9                    	mov	cx,cs
  7881 00001B80 01C8                    	add	ax,cx				; ax = transient seg ; M004
  7882                                  
  7883                                  	; 21/01/2023
  7884                                  	; MSDOS 3.3
  7885                                  	; 25/09/2018
  7886                                  	;mov     ax,[TrnSeg]	; COMMAND.COM (MSDOS 3.3) - Offset 1387h
  7887                                  
  7888                                  	; MSDOS 3.3 & MSDOS 6.0
  7889 00001B82 A3[4F20]                	mov	[INITADD+2],ax
  7890                                  	;call	dword ptr InitAdd
  7891 00001B85 FF1E[4D20]              	call	far [INITADD]
  7892                                  
  7893                                  NoDttm:
  7894                                  	; MSDOS 6.0
  7895                                  	; 21/01/2023
  7896                                  ;Copyright:
  7897                                  	;public	Copyright
  7898                                  ;	Bugbug:	remove Copyright label.
  7899                                  
  7900                                  ;if IBMVER
  7901 00001B89 833E[A502]00            	cmp	word [SingleCom],0
  7902 00001B8E 7506                    	jnz	short Drv0			; don't print header if SingleCom
  7903                                  	;mov	dx,offset ResGroup:CopyrightMsg	; dx = ptr to msg
  7904 00001B90 BA[9B21]                	mov	dx,COPYRIGHTMSG
  7905 00001B93 E845F8                  	call	RPrint
  7906                                  ;endif
  7907                                  	; 21/01/2023
  7908                                  	; MSDOS 3.3
  7909                                  	;cmp	word [SingleCom],0	; don't print header if SingleCom
  7910                                  	;jnz	short DRV0
  7911                                  	;mov	dx,HEADERPTR	; dx = ptr to msg
  7912                                  	;call	RPRINT
  7913                                  ;DRV0:
  7914                                  	; MSDOS 3.3
  7915                                  	;mov	byte [INITFLAG],0
  7916                                  	;jmp	ENDINIT
  7917                                  
  7918                                  	; 21/01/2023
  7919                                  	; MSDOS 6.0
  7920                                  Drv0:						; Reset APPEND state
  7921 00001B96 1E                      	push	ds				; save data segment
  7922 00001B97 0E                      	push	cs				; Get local segment into DS
  7923 00001B98 1F                      	pop	ds				;
  7924 00001B99 B807B7                  	mov	ax,0B707h ; 21/01/2023
  7925                                  	;mov	ax,APPENDSETSTATE		; Set the state of Append
  7926 00001B9C 8B1E[BE02]              	mov	bx,[Append_State] 		;  back to the original state
  7927 00001BA0 CD2F                    	int	2Fh				;
  7928 00001BA2 1F                      	pop	ds				; get data segment back
  7929                                  
  7930                                  ;Check FirstCom set previously to see if this is the first instance of
  7931                                  ;command.com. If not, we do not move command.com. Instead, we copy over the
  7932                                  ;jump table from the previous stub to the current stub.
  7933                                  
  7934 00001BA3 803E[9E26]01            	cmp	byte [FirstCom],1		; first command.com?
  7935 00001BA8 7431                    	jz	short move_code			; yes, move it
  7936                                  
  7937 00001BAA 06                      	push	es
  7938 00001BAB 1E                      	push	ds
  7939                                  
  7940 00001BAC 1E                      	push	ds
  7941 00001BAD 07                      	pop	es
  7942                                  	;mov	di,offset DATARES:Int2f_Entry
  7943 00001BAE BF[6600]                	mov	di,Int2f_Entry	
  7944                                  
  7945                                  	;mov	ds,[es:ResJmpTable+2]		; get segment address
  7946                                  	;mov	si,[es:ResJmpTable]		; get offset address
  7947                                  	; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  7948 00001BB1 26C536[9A26]            	lds	si,[es:ResJmpTable]
  7949                                  
  7950                                  	;mov	cx,11
  7951                                  	;;mov 	cx,NUM_RELOC_ENTRIES 		; number of dword ptrs
  7952                                  	;shl	cx,1
  7953                                  	;shl	cx,1				; size of table in bytes
  7954                                  	; 21/01/2023
  7955 00001BB6 B92C00                  	mov	cx,44				; size of table in bytes
  7956                                  
  7957 00001BB9 FC                      	cld
  7958 00001BBA F3A4                    	rep	movsb				; copy the jump table
  7959                                  
  7960                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  7961                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1D6Ch
  7962                                  %if 1
  7963 00001BBC A0[FA01]                	mov     al,[cox_location] ; "cox"
  7964 00001BBF 26A2[FA01]              	mov     [es:cox_location],al ; "cox"
  7965 00001BC3 A1[FB01]                	mov     ax,[cox_location+1]
  7966 00001BC6 A3[FB01]                	mov     [cox_location+1],ax
  7967                                  %endif
  7968                                  
  7969                                  ;Check if the resident code is in HMA. We assume that it is in HMA if its 
  7970                                  ;code segment > 0f000h. If in HMA, we set the ComInHMA flag
  7971                                  
  7972 00001BC9 26817DFE00F0            	cmp	word [es:di-2],0F000h		; is resident code in HMA?
  7973 00001BCF 7206                    	jb	short res_low			; no, dont set flag
  7974                                  
  7975 00001BD1 26C606[9600]01          	mov	byte [es:ComInHMA],1		; indicate code in HMA
  7976                                  res_low:
  7977 00001BD7 1F                      	pop	ds
  7978 00001BD8 07                      	pop	es
  7979 00001BD9 EB03                    	jmp	short finish_init
  7980                                  
  7981                                  ;Now, we can move the resident code to its final location, either to HIMEM
  7982                                  ;or to overlay the messages in the data segment if the user has not used the
  7983                                  ;/msg switch.
  7984                                  
  7985                                  move_code:
  7986 00001BDB E85702                  	call	Move_res_code			; move the code
  7987                                  
  7988                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  7989                                  ; PCDOS 7.1 COMMAND.COM
  7990                                  %if 0
  7991                                  finish_init:
  7992                                  	;jmp	RESGROUP:EndInit 		; finish initializing
  7993                                  	jmp	EndInit
  7994                                  %else
  7995                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:1D8Fh
  7996                                  finish_init:
  7997 00001BDE 803E[A202]01            	cmp	byte [PermCom],1
  7998 00001BE3 7523                    	jne	short finish_init_@
  7999 00001BE5 803E[0E04]01            	cmp	byte [COMMAND_HIGH],1	; COMMAND.COM will be moved to HMA/UMB
  8000 00001BEA 751C                    	jne	short finish_init_@
  8001 00001BEC BB4000                  	mov	bx,40h			; high memory first fit
  8002 00001BEF B80158                  	mov	ax,5801h		; set allocation strategy
  8003 00001BF2 CD21                    	int	21h		; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  8004                                  				; AL = function code: set allocation strategy
  8005 00001BF4 BB0100                  	mov	bx,1			; add UMBs to DOS memory chain
  8006 00001BF7 B80358                  	mov	ax,5803h		; set UMB link state
  8007 00001BFA CD21                    	int	21h		; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
  8008                                  				; AL = function code: (DOS 5beta) set UMB link state
  8009 00001BFC 720A                    	jb	short finish_init_@
  8010 00001BFE 8B1E[B404]              	mov	bx,[ResSize]
  8011 00001C02 B448                    	mov	ah,48h
  8012 00001C04 CD21                    	int	21h		; DOS - 2+ - ALLOCATE MEMORY
  8013                                  				; BX = number of 16-byte paragraphs desired
  8014 00001C06 7303                    	jnb	short patch_segments_hma
  8015                                  finish_init_@:
  8016 00001C08 E90AE7                  	jmp	EndInit
  8017                                  
  8018                                  patch_segments_hma:
  8019                                  	;mov	[ds:0Ch],ax
  8020 00001C0B A30C00                  	mov	[PDB.EXIT+2],ax
  8021                                  	;mov	[ds:10h],ax
  8022 00001C0E A31000                  	mov	[PDB.CTRL_C+2],ax
  8023                                  	;mov	[ds:14h],ax
  8024 00001C11 A31400                  	mov	[PDB.FATAL_ABORT+2],ax
  8025                                  	;mov	[ds:16h],ax
  8026 00001C14 A31600                  	mov	[PDB.PARENT_PID],ax
  8027                                  	;mov	[ds:36h],ax
  8028 00001C17 A33600                  	mov	[PDB.JFN_Pointer+2],ax
  8029 00001C1A A3[3E02]                	mov	[Parent],ax
  8030 00001C1D A3[4202]                	mov	[OldTerm+2],ax
  8031 00001C20 A3[3E04]                	mov	[Com_Ptr+2],ax
  8032 00001C23 A3[4204]                	mov	[Com_Fcb1+2],ax
  8033 00001C26 A3[4604]                	mov	[Com_Fcb2+2],ax
  8034 00001C29 A3[4A04]                	mov	[MySeg],ax
  8035 00001C2C A3[5204]                	mov	[MySeg1],ax
  8036 00001C2F A3[5604]                	mov	[MySeg2],ax
  8037 00001C32 A3[5607]                	mov	[MySeg3],ax
  8038 00001C35 A3[2801]                	mov	[int2fh_segm],ax ; [Carousel_i2f_Hook+3] ; 23/07/2024
  8039                                  	;mov	di,(offset Int2f_Entry+2)
  8040 00001C38 BF[6800]                	mov	di,Int2f_Entry+2
  8041 00001C3B 833DFF                  	cmp	word [di],0FFFFh
  8042 00001C3E 7409                    	jz	short already_hma
  8043 00001C40 B10B                    	mov	cl,11		; NUM_RELOC_ENTRIES
  8044                                  patch_entry_seg:
  8045 00001C42 8905                    	mov	[di],ax
  8046 00001C44 83C704                  	add	di,4
  8047 00001C47 E2F9                    	loop	patch_entry_seg
  8048                                  already_hma:
  8049 00001C49 8EC0                    	mov	es,ax
  8050 00001C4B 31F6                    	xor	si,si
  8051 00001C4D 31FF                    	xor	di,di
  8052 00001C4F B103                    	mov	cl,3			; BX = resident part size in paragraphs
  8053                                  					; after shifting: resident part size in words
  8054 00001C51 D3E3                    	shl	bx,cl			; move resident part of COMMAND.COM to HMA (UMB)
  8055 00001C53 89D9                    	mov	cx,bx			; number of words
  8056 00001C55 F3A5                    	rep movsw
  8057 00001C57 1E                      	push	ds
  8058 00001C58 8ED9                    	mov	ds,cx	; 0
  8059                                  	;mov	[ds:0BAh],ax	; INT 2Eh segment
  8060 00001C5A A3BA00                  	mov	[(2Eh*4)+2],ax
  8061 00001C5D 40                      	inc	ax
  8062                                  	;mov	[ds:0BEh],ax	; INT 2Fh segment
  8063 00001C5E A3BE00                  	mov	[(2Fh*4)+2],ax
  8064 00001C61 1F                      	pop	ds
  8065 00001C62 8CC3                    	mov	bx,es
  8066 00001C64 B450                    	mov	ah,50h
  8067 00001C66 CD21                    	int	21h		; DOS - 2+ internal - SET PSP SEGMENT
  8068                                  				; BX = segment address of new PSP
  8069 00001C68 4B                      	dec	bx
  8070 00001C69 8EC3                    	mov	es,bx			; memory arena header (segment)
  8071 00001C6B 43                      	inc	bx			; PSP (program) address/segment
  8072                                  	;mov	[es:1],bx
  8073                                  	;mov	[es:ARENA.owner],bx
  8074 00001C6C 26891E0100              	mov	[es:arena_owner],bx
  8075                                  	;mov	word [es:8],4F43h	; 'CO' ; [es:arena_name]
  8076 00001C71 26C7060800434F          	mov	word [es:arena_name],4F43h
  8077                                  	;mov	word [es:0Ah],4D4Dh	; 'MM'
  8078 00001C78 26C7060A004D4D          	mov	word [es:arena_name+2],4D4Dh
  8079                                  	;mov	word [es:0Ch],4E41h	; 'AN'
  8080 00001C7F 26C7060C00414E          	mov	word [es:arena_name+4],4E41h
  8081                                  	;mov	word [es:0Eh],44h	; 'D'
  8082 00001C86 26C7060E004400          	mov	word [es:arena_name+6],44h
  8083 00001C8D FE06[0E04]              	inc	byte [COMMAND_HIGH]	; = 2
  8084                                  					; Resident portion of COMMAND.COM is
  8085                                  					; in HMA/UMB flag (=2)
  8086 00001C91 53                      	push	bx
  8087                                  	;mov	ax,offset EndInit
  8088 00001C92 B8[1503]                	mov	ax,EndInit
  8089 00001C95 50                      	push	ax
  8090 00001C96 CB                      	retf	
  8091                                  %endif
  8092                                  
  8093                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8094                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1BA8h (CODERES:0E68h)
  8095                                  
  8096                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  8097                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1E48h
  8098                                  
  8099                                  GetStrLen:
  8100                                  ;	Get length of string pointed to by DS:SI. Length includes NULL.
  8101                                  ;	Length is returned in CX
  8102                                  
  8103                                  	; MSDOS 3.3 & MSDOS 6.0
  8104 00001C97 31C9                    	xor	cx,cx
  8105                                  NxtChar:
  8106 00001C99 AC                      	lodsb
  8107 00001C9A 41                      	inc	cx
  8108 00001C9B 08C0                    	or	al,al
  8109 00001C9D 75FA                    	jnz	short NxtChar
  8110 00001C9F C3                      	retn
  8111                                  
  8112                                  	; 29/01/2023
  8113                                  Setup_Seg:
  8114                                  
  8115                                  ; If the transient has been loaded in TranSeg, then we need to use that
  8116                                  ; segment for calls to routines in the transient area. Otherwise, the current
  8117                                  ; code segment is used
  8118                                  ; Segment returned in AX.
  8119                                  
  8120                                  	; MSDOS 3.3 & MSDOS 6.0
  8121 00001CA0 A1[8F02]                	mov	ax,[TrnSeg]
  8122 00001CA3 803E[9102]01            	cmp	byte [TrnMvFlg],1	; Has transient portion been moved
  8123 00001CA8 7405                    	je	short setup_end
  8124                                  
  8125                                  ;06/06/2023
  8126                                  %if 0
  8127                                  	push	bx
  8128                                  	mov	bx,cs
  8129                                  	;mov	ax,offset ResGroup:TranStart
  8130                                  	;mov	ax,2320h ; MSDOS 5.0 COMMAND.COM
  8131                                  	; 06/06/2023
  8132                                  	;mov	ax,26E0h ; MSDOS 6.22 COMMAND.COM
  8133                                  	;mov	ax,TRANSTART
  8134                                  	;shr	ax,1
  8135                                  	;shr	ax,1
  8136                                  	;shr	ax,1
  8137                                  	;shr	ax,1
  8138                                  	; 29/01/2023
  8139                                  	mov	ax,TRANSTART>>4
  8140                                  	add	ax,bx
  8141                                  	pop	bx
  8142                                  %endif
  8143                                  	; 06/06/2023
  8144 00001CAA 8CC8                    	mov	ax,cs
  8145 00001CAC 057E02                  	add	ax,TRANSTART>>4
  8146                                  
  8147                                  setup_end:
  8148 00001CAF C3                      	retn
  8149                                  
  8150                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8151                                  ;RPRINT:
  8152                                  	; MSDOS 3.3
  8153                                  	;push	ax
  8154                                  	;call	SETUP_SEG
  8155                                  	;mov	[PRINTADD+2], ax
  8156                                  	;;call	dword ptr PRINTADD
  8157                                  	;call	far [PRINTADD]
  8158                                  	;pop	ax
  8159                                  	;retn
  8160                                  
  8161                                  	; 29/01/2023
  8162                                  	; MSDOS 6.0
  8163                                  ;***	RPrintParse - display parse error message
  8164                                  ;
  8165                                  ;	ENTRY	DX = parse error #
  8166                                  ;
  8167                                  ;	EXIT	nothing
  8168                                  ;
  8169                                  ;	USED	flags
  8170                                  ;
  8171                                  ;	EFFECTS
  8172                                  ;	  Message is displayed on stdout.
  8173                                  
  8174                                  RPrintParse:	;proc
  8175                                  	;assume	ds:ResGroup,ss:ResGroup
  8176                                  
  8177 00001CB0 52                      	push	dx				; preserve DX
  8178 00001CB1 87DA                    	xchg	bx,dx				; bx = parse error #
  8179                                  						; dx = saved BX
  8180 00001CB3 4B                      	dec	bx				; bx = parse error index, from 0
  8181 00001CB4 D1E3                    	shl	bx,1				; bx = offset in word table
  8182                                  	;mov	bx,ParsMsgPtrs[bx]		; bx = ptr to error msg
  8183 00001CB6 8B9F[E309]              	mov	bx,[bx+PARSMSGPTRS]
  8184 00001CBA 87DA                    	xchg	bx,dx				; dx = ptr to error msg
  8185                                  						; bx = restored
  8186 00001CBC E81CF7                  	call	RPrint				; print the message
  8187 00001CBF 5A                      	pop	dx				; restore DX
  8188 00001CC0 C3                      	retn
  8189                                  
  8190                                  ;RPrintParse	endp
  8191                                  
  8192                                  	; 29/01/2023
  8193                                  ;PATHCHRCMPR:
  8194                                  	; MSDOS 3.3
  8195                                  	;push	dx
  8196                                  	;mov	dl,[slash_chr]
  8197                                  	;;cmp	byte [RSWITCHAR],'/'
  8198                                          ;cmp	[RSWITCHAR],dl
  8199                                  	;je	short RNOSLASHT
  8200                                  	;;cmp	al,'/'
  8201                                  	;cmp	al,dl
  8202                                  	;je	short RET41 ; zf = 1 
  8203                                  ;RNOSLASHT:
  8204                                          ;;cmp	al,'\'
  8205                                  	;cmp	al,[bslash_chr]
  8206                                  ;RET41:
  8207                                  	;pop	dx
  8208                                  	;retn
  8209                                  
  8210                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8211                                  IfindE:
  8212                                  	; MSDOS 3.3 & MSDOS 6.0
  8213 00001CC1 E80300                  	call	ifind				; find the name
  8214                                  	;jc	short ifind2			; carry means not found
  8215                                  	;jmp	short Iscasb1 			; scan for = sign
  8216                                  	; 29/01/2023
  8217 00001CC4 734E                    	jnc	short Iscasb1
  8218                                  ifind2:
  8219 00001CC6 C3                      	retn
  8220                                  
  8221                                  	; 29/01/2023
  8222                                  
  8223                                  ; on return of find1, es:di points to beginning of name
  8224                                  
  8225                                  ifind:
  8226 00001CC7 FC                      	cld
  8227 00001CC8 E83B00                  	call	Icount0				; cx = length of name
  8228 00001CCB 8E06[3A04]              	mov	es,[EnvirSeg]
  8229 00001CCF 31FF                    	xor	di,di
  8230                                  ifind1:
  8231 00001CD1 51                      	push	cx
  8232 00001CD2 56                      	push	si
  8233 00001CD3 57                      	push	di
  8234                                  ifind11:
  8235 00001CD4 AC                      	lodsb
  8236                                  
  8237                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  8238                                  ; PCDOS 7.1 COMMAND.COM
  8239                                  %if 1
  8240                                  ;ifdef DBCS
  8241 00001CD5 E8A5F7                  	call	ITestKanj
  8242 00001CD8 740F                    	jz	short _NotKanj4
  8243 00001CDA 4E                      	dec	si
  8244 00001CDB AD                      	lodsw
  8245 00001CDC 47                      	inc	di
  8246 00001CDD 47                      	inc	di
  8247 00001CDE 263B45FE                	cmp	ax,[es:di-2]
  8248 00001CE2 7511                    	jne	short ifind12
  8249 00001CE4 49                      	dec	cx
  8250 00001CE5 E2ED                    	loop	ifind11
  8251 00001CE7 EB0C                    	jmp	short ifind12
  8252                                  _NotKanj4:
  8253                                  ;endif
  8254                                  %endif
  8255 00001CE9 E83400                  	call	iupconv
  8256 00001CEC 47                      	inc	di
  8257 00001CED 263A45FF                	cmp	al,[es:di-1]
  8258 00001CF1 7502                    	jnz	short ifind12
  8259 00001CF3 E2DF                    	loop	ifind11
  8260                                  ifind12:
  8261 00001CF5 5F                      	pop	di
  8262 00001CF6 5E                      	pop	si
  8263 00001CF7 59                      	pop	cx
  8264 00001CF8 74CC                    	jz	short ifind2
  8265 00001CFA 51                      	push	cx
  8266 00001CFB E81A00                  	call	Iscasb2 			; scan for a nul
  8267 00001CFE 59                      	pop	cx
  8268                                  	;cmp	byte [es:di],0
  8269                                  	;jnz	short ifind1
  8270                                  	;stc					; indicate not found
  8271 00001CFF 26803D01                	cmp	byte [es:di],1
  8272 00001D03 73CC                    	jnb	short ifind1
  8273                                  	; cf=1					; indicate not found
  8274                                  ;ifind2:
  8275 00001D05 C3                      	retn
  8276                                  
  8277                                  	; 29/01/2023
  8278                                  Icount0:
  8279 00001D06 1E                      	push	ds
  8280 00001D07 07                      	pop	es
  8281 00001D08 89F7                    	mov	di,si
  8282                                  
  8283 00001D0A 57                      	push	di				; count number of chars until "="
  8284 00001D0B E80600                  	call	Iscasb1
  8285                                  	; 25/09/2018
  8286                                  	;jmp	short Icountx
  8287                                  	;push	di				; count number of chars until nul
  8288                                  	;call	Iscasb2
  8289                                  ;Icountx:
  8290 00001D0E 59                      	pop	cx
  8291 00001D0F 29CF                    	sub	di,cx
  8292 00001D11 87F9                    	xchg	di,cx
  8293 00001D13 C3                      	retn
  8294                                  
  8295                                  Iscasb1:
  8296                                  	; 29/01/2023
  8297 00001D14 B03D                    	mov	al,"="
  8298                                  	;mov	al,[equalsign] ; [equal_sign]	; scan for an =
  8299 00001D16 EB02                    	jmp	short Iscasbx
  8300                                  Iscasb2:
  8301 00001D18 30C0                    	xor	al,al				; scan for a nul
  8302                                  Iscasbx:
  8303 00001D1A B90001                  	mov	cx,256 ; 100h
  8304 00001D1D F2AE                    	repnz	scasb
  8305 00001D1F C3                      	retn
  8306                                  
  8307                                  	; 29/01/2023
  8308                                  ;IUPCONV:
  8309                                  	; MSDOS 3.3
  8310                                          ;;cmp	al,"a"
  8311                                  	;cmp	al,[letter_a]
  8312                                          ;jb	short IRET22
  8313                                          ;;cmp	al,"z"
  8314                                          ;cmp	al,[letter_z]
  8315                                  	;ja	short IRET22
  8316                                          ;sub	al,20h			; Lower-case changed to upper-case
  8317                                  ;IRET22:
  8318                                  	;retn
  8319                                  
  8320                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8321                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1C32h
  8322                                  
  8323                                  	; MSDOS 6.0
  8324                                  ; *****************************************************************
  8325                                  ; *
  8326                                  ; * ROUTINE:	 IUPCONV    (ADDED BY EMG 4.00)
  8327                                  ; *
  8328                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
  8329                                  ; *		 the character in AL from the file upper case table
  8330                                  ; *		 in DOS if character if above ascii 128, else
  8331                                  ; *		 subtracts 20H if between "a" and "z".
  8332                                  ; *
  8333                                  ; * INPUT:	 DS	      set to resident
  8334                                  ; *		 AL	      char to be upper cased
  8335                                  ; *		 FUCASE_ADDR  set to the file upper case table
  8336                                  ; *
  8337                                  ; * OUTPUT:	 AL	      upper cased character
  8338                                  ; *
  8339                                  ; *****************************************************************
  8340                                  
  8341                                  iupconv:	;proc	near				
  8342                                  	;assume	ds:ResGroup			;
  8343                                  
  8344 00001D20 3C80                    	cmp	al,80h				; see if char is > ascii 128
  8345 00001D22 7210                    	jb	short other_fucase		; no - upper case math
  8346 00001D24 2C80                    	sub	al,80h				; only upper 128 chars in table
  8347 00001D26 1E                      	push	ds				;
  8348 00001D27 53                      	push	bx				;
  8349                                  	;lds	bx,dword ptr FUCase_Addr+1	; get table address
  8350 00001D28 C51E[B602]              	lds     bx,[FUCase_Addr+1]
  8351 00001D2C 83C302                  	add	bx,2				; skip over first word
  8352                                  	;xlat	ds:byte ptr [bx]		; convert to upper case
  8353 00001D2F D7                      	xlat
  8354 00001D30 5B                      	pop	bx				;
  8355 00001D31 1F                      	pop	ds				;
  8356 00001D32 EB0A                    	jmp	short iupconv_end		; we finished - exit
  8357                                  
  8358                                  other_fucase:					;
  8359                                  	;cmp	al,[lcasea] ; [letter_a]	; if between "a" and "z",
  8360 00001D34 3C61                    	cmp	al,'a'
  8361 00001D36 7206                    	jb	short iupconv_end		;     subtract 20h to get
  8362                                  	;cmp	al,[lcasez] ; [letter_z]	; upper case equivalent.
  8363 00001D38 3C7A                    	cmp	al,'z'
  8364 00001D3A 7702                    	ja	short iupconv_end		;
  8365 00001D3C 2C20                    	sub	al,20h				; Change lower-case to upper
  8366                                  iupconv_end:					;
  8367 00001D3E C3                      	retn
  8368                                  
  8369                                  ;iupConv endp
  8370                                  
  8371                                  	; 29/01/2023
  8372                                  init_contc_specialcase:
  8373                                  	; MSDOS 3.3 & MSDOS 6.0
  8374                                  						; This routine is called if control-C
  8375 00001D3F 83C406                  	add	sp,6				;  is type during the date/time prompt
  8376 00001D42 56                      	push	si				;  at initialization time.  The desired
  8377 00001D43 89D6                    	mov	si,dx				;  response is to make it look like the
  8378 00001D45 C74401000D              	mov	word [si+1],0D00h		;  user typed <CR> by "popping" the
  8379 00001D4A 5E                      	pop	si				;  INT 21h stuff off the stack, putting
  8380 00001D4B CF                      	iret					;  a <CR> in the user's buffer, and
  8381                                  						;  returning directly to the user.
  8382                                  						; In this case the user is TCODE.
  8383                                  
  8384                                  ; ----------------------------------------------------------------------------
  8385                                  
  8386                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8387                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1C62h (CODERES:0F22h)
  8388                                  
  8389                                  	; MSDOS 6.0
  8390                                  ; ****************************************************************
  8391                                  ; *
  8392                                  ; * ROUTINE:	 Setup_for_messages
  8393                                  ; *
  8394                                  ; * FUNCTION:	 Sets up system for PARSE and EXTENDED ERROR
  8395                                  ; *		 messages as follows:
  8396                                  ; *
  8397                                  ; *		 IF /P and /MSG are entered
  8398                                  ; *		    keep PARSE and EXTENDED ERRORS in memory
  8399                                  ; *		 ELSE IF /P is entered
  8400                                  ; *		    use PARSE and EXTENDED ERRORS on disk
  8401                                  ; *		    remove PARSE ERRORS from memory
  8402                                  ; *		 ELSE
  8403                                  ; *		    remove PARSE ERRORS from memory
  8404                                  ; *		 ENDIF
  8405                                  ; *
  8406                                  ; * INPUT:	 PERMCOM	Set up with user input
  8407                                  ; *		 EXT_MSG	Set up with user input
  8408                                  ; *		 System set up to retain PARSE ERRORS
  8409                                  ; *
  8410                                  ; * OUTPUT:	 registers unchanged
  8411                                  ; *
  8412                                  ; ****************************************************************
  8413                                  
  8414                                  setup_for_messages: ;proc near		
  8415                                  
  8416 00001D4C 53                      	push	bx
  8417 00001D4D 1E                      	push	ds				; save data segment
  8418 00001D4E 06                      	push	es				; save environment segment
  8419 00001D4F 50                      	push	ax				;
  8420 00001D50 52                      	push	dx				;
  8421 00001D51 57                      	push	di				;
  8422 00001D52 8CC8                    	mov	ax,cs				; get local segment to ES and DS
  8423 00001D54 8ED8                    	mov	ds,ax				;
  8424 00001D56 8EC0                    	mov	es,ax				;
  8425                                  
  8426 00001D58 803E[A202]00            	cmp	byte [PermCom],0		; was permcom set?
  8427 00001D5D 743C                    	jz	short no_permcom		; No - don't worry about messages
  8428                                  
  8429                                  ;*	We're permanent. Install our message services int 2f handler.
  8430                                  
  8431 00001D5F 06                      	push	es
  8432                                  	;mov	ax,(GET_INTERRUPT_VECTOR shl 8) or 2Fh
  8433 00001D60 B82F35                  	mov	ax,352Fh
  8434 00001D63 CD21                    	int	21h
  8435                                  			; DOS - 2+ - GET INTERRUPT VECTOR
  8436                                  			; AL = interrupt number
  8437                                  			; Return: ES:BX = value of interrupt vector
  8438 00001D65 891E[AE04]              	mov	[Int2fHandler],bx
  8439 00001D69 8C06[B004]              	mov	[Int2fHandler+2],es
  8440 00001D6D 07                      	pop	es
  8441                                  
  8442                                  ;	DS = RESGROUP seg addr
  8443                                  
  8444                                  ; M005; We will not hook int 2fh on any command.com other than the first.
  8445                                  ; M005; Carousel loads as a permanent command.com and when we exit Carousel,
  8446                                  ; M005; it just wipes our arena out. So, int 2fh is still hooked and the
  8447                                  ; M005; first int 2fh call after exit from Carousel (from the DOS terminate
  8448                                  ; M005; call) goes off into space.
  8449                                  
  8450 00001D6E 803E[9E26]00            	cmp	byte [FirstCom],0		; M005
  8451 00001D73 7416                    	je	short no_msg_hook		; M005
  8452                                  ;
  8453                                  ; M005; !!!SLIMIEST CAROUSEL HACK OFF ALL!!!
  8454                                  ; M005; Carousel plays around with the interrupt vector tables. He saves it
  8455                                  ; M005; before loading a new command.com. Then, it takes hold of the current
  8456                                  ; M005; command.com's PSP and then looks at all interrupt vectors whose
  8457                                  ; M005; segment matches the command.com PSP and then updates these segments
  8458                                  ; M005; to the new command.com's PSP in his saved vector table. Whenever we
  8459                                  ; M005; we pop into his menu, he puts this saved table into the vector table.
  8460                                  ; M005; If we now quit, Carousel just wipes out command.com's arena and then
  8461                                  ; M005; issues a terminate. Unfortunately, the int 2fh vector is pointing at
  8462                                  ; M005; the command.com that was wiped out and so the next int 2fh call will
  8463                                  ; M005; bomb. To prevent Carousel from doing this clever(1**$$#) patching, we
  8464                                  ; M005; renormalize our int 2fh pointer so that its cs is not the same as the
  8465                                  ; M005; command.com PSP. Now, he does no such patching and our int 2fh vector
  8466                                  ; M005; remains nice and happy. The renormalized pointer points at a far 
  8467                                  ; M005; jump to the actual int 2fh entry point.
  8468                                  ;
  8469 00001D75 1E                      	push	ds				; M005
  8470                                  	;mov	dx,offset DATARES:Carousel_i2f_Hook ; M005
  8471 00001D76 BA[2501]                	mov     dx,Carousel_i2f_Hook
  8472 00001D79 83EA10                  	sub	dx,10h				; renormalize offset; M005
  8473 00001D7C 8CD8                    	mov	ax,ds				; M005
  8474 00001D7E 40                      	inc	ax				; Relocated cs ; M005
  8475 00001D7F 8ED8                    	mov	ds,ax				; M005
  8476                                  	;mov	ax,(SET_INTERRUPT_VECTOR shl 8) or 2Fh
  8477 00001D81 B82F25                  	mov	ax,252Fh
  8478 00001D84 CD21                    	int	21h
  8479                                  			; DOS - SET INTERRUPT VECTOR
  8480                                  			; AL = interrupt number
  8481                                  			; DS:DX = new vector to be used for specified interrupt
  8482 00001D86 1F                      	pop	ds				; M005
  8483                                  	;mov	word ptr Carousel_i2f_Hook+3,ds	; M005
  8484 00001D87 8C1E[2801]              	mov	[Carousel_i2f_Hook+3],ds  ; mov [int2fh_segm], ds ; 23/07/2024
  8485                                  						; patch in the cs for jump
  8486                                  no_msg_hook:					; M005
  8487 00001D8B 803E[9920]01            	cmp	byte [ext_msg],1 ; SET_EXTENDED_MSG
  8488 00001D90 7516                    	jne	short permcom_end		; no /msg - exit
  8489                                  
  8490                                  permcom_slash_msg:				; Keep messages in memory
  8491                                  	;mov	di,offset ResGroup:ExtMsgEnd 	; get address of resident end
  8492                                  	;mov	di,0DD8h ; PCDOS 7.1 COMMAND.COM (*)
  8493 00001D92 BF[DC0C]                	mov     di,ExtMsgEnd ; = offset PATRICIDE ; 23/07/2024 (*)
  8494 00001D95 893E[B204]              	mov	[ResMsgEnd],di			; save it
  8495 00001D99 EB0D                    	jmp	short permcom_end		; exit
  8496                                  
  8497                                  no_permcom:					
  8498                                  	;cmp	byte [ext_msg],SET_EXTENDED_MSG	; was /msg specified?
  8499 00001D9B 803E[9920]01            	cmp	byte [ext_msg],1
  8500 00001DA0 7506                    	jne	short permcom_end		; no - no error
  8501                                  	;mov	dx,LessArgs_Ptr			; get message number for "Required parameter missing"
  8502 00001DA2 BA0200                  	mov	dx,2
  8503 00001DA5 E808FF                  	call	RPrintParse
  8504                                  
  8505                                  permcom_end:
  8506 00001DA8 5F                      	pop	di				;
  8507 00001DA9 5A                      	pop	dx				;
  8508 00001DAA 58                      	pop	ax				;
  8509 00001DAB 07                      	pop	es				; get environment back
  8510 00001DAC 1F                      	pop	ds				;
  8511 00001DAD 5B                      	pop	bx
  8512                                  
  8513 00001DAE C3                      	retn					;
  8514                                  
  8515                                  ;setup_for_messages	endp
  8516                                  
  8517                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8518                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1CC5h
  8519                                  
  8520                                  	; MSDOS 6.0
  8521                                  
  8522                                  ;***	CheckHelp - print help text and exit if /? is on command line
  8523                                  ;
  8524                                  ;	ENTRY	command-line tail at 81h
  8525                                  ;
  8526                                  ;	EXIT	return if /? not found
  8527                                  ;		terminate if /? found
  8528                                  ;
  8529                                  ;	USED	AX,BX,CX,DX,SI,DI
  8530                                  ;
  8531                                  ;	EFFECTS	Help text displayed if /? found on command line
  8532                                  
  8533                                  CheckHelp:	; proc
  8534                                  	;assume	cs:RESGROUP,ds:RESGROUP,es:RESGROUP,ss:RESGROUP
  8535                                  
  8536 00001DAF BE8100                  	mov	si,81h			; DS:SI = ptr to command-line tail
  8537                                  	;mov	di,offset RESGROUP:Parse_Command
  8538 00001DB2 BF[9E20]                	mov	di,PARSE_COMMAND
  8539                                  					; ES:DI = ptr to primary parse block
  8540 00001DB5 31C9                    	xor	cx,cx			; CX = # positional param's found
  8541 00001DB7 31D2                    	xor	dx,dx			; DX will be ptr to result buffer
  8542                                  chParse:
  8543                                  	;call	dword ptr Init_Parse
  8544 00001DB9 FF1E[9320]              	call	far [Init_Parse]	; call system parser
  8545                                  
  8546                                  	;;cmp	ax,END_OF_LINE
  8547                                  	;cmp	ax,-1 ; 0FFFFh	
  8548                                  	;je	short chRet		; end of command line, no /? found
  8549                                  	;;cmp	ax,RESULT_NO_ERROR
  8550                                  	;;cmp	ax,0
  8551                                  	;;je	short chWhich		; valid syntax element found
  8552                                  	;;jmp	short chParse		; go parse more
  8553                                  	;and	ax,ax ; cmp ax,0
  8554                                  	;jnz	short chParse ; jne
  8555                                  	; 10/06/2023
  8556 00001DBD 40                      	inc	ax	; cmp ax,-1
  8557 00001DBE 741B                    	jz	short chRet   ; 0FFFFh -> 0
  8558 00001DC0 48                      	dec	ax	; cmp ax,0
  8559 00001DC1 75F6                    	jnz	short chParse ; 1 -> 0
  8560                                  	; ax = 0
  8561                                  chWhich:
  8562                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_?_Syn
  8563 00001DC3 813E[5D21][2821]        	cmp     word [COMND1_SYN],COMMAND_?_SYN ; "/?"
  8564 00001DC9 7411                    	je	short chHelp		; /? found - display help & exit
  8565                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_C_Syn
  8566 00001DCB 813E[5D21][0E21]        	cmp     word [COMND1_SYN],COMMAND_C_SYN ; "/C"
  8567                                  	; 06/06/2023
  8568 00001DD1 7408                    	je	short chRet		; /c found - ignore rest of line
  8569                                  	; 29/01/2023
  8570                                  	;jne	short chParse
  8571                                  	; 06/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  8572                                  	; MSDOS 6.0
  8573                                  	;cmp	Comnd1_Syn,offset RESGROUP:Command_K_Syn
  8574 00001DD3 813E[5D21][3421]        	cmp	word [COMND1_SYN],COMMAND_K_SYN ; "/K"
  8575                                  	;je	short chRet		; /k found - ignore rest of line
  8576                                  	;jmp	short chParse		; anything else - ignore, keep looking
  8577                                  	; 06/06/2023
  8578 00001DD9 75DE                    	jne	short chParse
  8579                                  chRet:
  8580 00001DDB C3                      	retn
  8581                                  chHelp:
  8582                                  	;mov	si,offset RESGROUP:HelpMsgs	; SI = ptr to msg ptr list
  8583 00001DDC BE[6426]                	mov	si,HelpMsgs
  8584                                  chHelpNext:
  8585 00001DDF AD                      	lodsw					; AX = ptr to msg
  8586 00001DE0 09C0                    	or	ax,ax
  8587 00001DE2 7407                    	jz	short chHelpDone		; end of list - all done
  8588 00001DE4 89C2                    	mov	dx,ax				; DX = ptr to msg
  8589 00001DE6 E8F2F5                  	call	RPrint				; display msg
  8590 00001DE9 EBF4                    	jmp	short chHelpNext		; go do next msg
  8591                                  
  8592                                  chHelpDone:
  8593 00001DEB CD20                    	int	20h				; terminate program
  8594                                  ;chRet:
  8595 00001DED C3                      	retn
  8596                                  
  8597                                  ;CheckHelp	endp
  8598                                  
  8599                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8600                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D03h
  8601                                  
  8602                                  	; MSDOS 6.0
  8603                                  
  8604                                  ;***** Setup_res_end -- This routine determines the resident size of COMMAND.
  8605                                  ;
  8606                                  ; It determines based on 2 factors:
  8607                                  ;	1. Is this is the first COMMAND?
  8608                                  ;	2. Is COMMAND to be loaded into HIMEM?
  8609                                  ;   The strategy works as follows:
  8610                                  ;
  8611                                  ;	if (First COMMAND)
  8612                                  ;	then if (COMMAND in HIMEM)
  8613                                  ;		ResSize = resident_data;
  8614                                  ;	     else
  8615                                  ;		ResSize = resident_data + resident_code;
  8616                                  ;	else
  8617                                  ;	   ResSize = resident_data;
  8618                                  ;
  8619                                  ; Int 2fh calls have been added to determine whether or not we are the first
  8620                                  ; COMMAND and whether DOS is in HIMEM.
  8621                                  ;
  8622                                  ;	ENTRY: ResMsgEnd = resident size of data in paras
  8623                                  ;
  8624                                  ;	EXIT:  ResSize = resident size in low memory
  8625                                  ;
  8626                                  ;	REGISTERS AFFECTED: ax,cx,dx
  8627                                  ;
  8628                                  
  8629                                  GET_HMA_ADDR	equ	4A02h
  8630                                  
  8631                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8632                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:1FBFh
  8633                                  
  8634                                  Setup_res_end:	;proc near
  8635                                  	
  8636 00001DEE 1E                      	push	ds
  8637 00001DEF 8CC8                    	mov	ax,cs
  8638 00001DF1 8ED8                    	mov	ds,ax				;ds = RESGROUP
  8639                                  	;assume	ds:RESGROUP
  8640                                  
  8641 00001DF3 8B0E[B204]              	mov	cx,[ResMsgEnd]			;set resident size = data
  8642                                  
  8643                                  ;ifndef	ROMDOS
  8644                                  
  8645                                  ;M042 -- Begin changes
  8646                                  ;If messages are to be kept behind, we need to round up the messages to
  8647                                  ;the next para boundary. This is because we have a dummy segment between the
  8648                                  ;data and the resident code segment so that the code segment starts on a
  8649                                  ;para boundary
  8650                                  
  8651                                  	;cmp	cx,offset RESGROUP:ExtMsgEnd	;messages to be resident?
  8652                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  8653                                  	;cmp	cx,0DD8h
  8654 00001DF7 81F9[DC0C]              	cmp	cx,ExtMsgEnd
  8655 00001DFB 7506                    	jne	short calc_res			;no, continue
  8656 00001DFD 83C10F                  	add	cx,15				;round up
  8657 00001E00 83E1F0                  	and	cx,0FFF0h
  8658                                  calc_res:
  8659                                  
  8660                                  ;M042 -- End changes
  8661                                  
  8662                                  	; 18/07/2024
  8663                                  	;xor	ax,ax
  8664                                         	
  8665 00001E03 803E[9E26]01            	cmp	byte [FirstCom],1		;is it first command.com?
  8666                                  	;jne	short not_first			;no, do not keep code
  8667                                  	; 06/06/2023
  8668 00001E08 751A                    	jne	short not_first2
  8669                                  
  8670                                  ;We issue a version check call with al=01 to detect if DOS is in HMA. If so,
  8671                                  ;bit 4 of dh is set
  8672                                  
  8673 00001E0A 53                      	push	bx
  8674 00001E0B 51                      	push	cx
  8675                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) or 06h ;is DOS in HIMEM? ;M013
  8676 00001E0C B80633                  	mov	ax,3306h
  8677 00001E0F CD21                    	int	21h
  8678                                  		; DOS - 5+ Get TRUE Version Number
  8679                                  		; (BL major, BH minor, DL revision, DH flags)
  8680 00001E11 59                      	pop	cx
  8681                                  
  8682                                  ;bugbug: remove version check after testing
  8683                                  
  8684 00001E12 80FB05                  	cmp	bl,5				;bl has true version ; M013
  8685 00001E15 7207                    	jb	short oldver
  8686                                  
  8687 00001E17 31C0                    	xor	ax,ax
  8688 00001E19 80E610                  	and	dh,10h				;is DOS in HMA ; M013
  8689                                  	;pop	bx
  8690                                  	;jnz	short not_first			;DOS in HIMEM, code not
  8691                                  						;	resident
  8692                                  	; 29/01/2023
  8693 00001E1C 7503                    	jnz	short not_first_pop
  8694                                  oldver:
  8695                                  	;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8696                                  	; 06/06/2023
  8697                                  	;;mov	ax,81Ah ; MSDOS 5.0 and MSDOS 6.22 COMMAND.COM
  8698                                  	; 06/06/2023
  8699                                  	; 29/01/2023
  8700                                  	;mov	ax,EndCode-(RCODE_START+100h) ; 23/04/2023
  8701                                  	; 03/05/2023
  8702 00001E1E B8(7209)                	mov	ax,EndCode-RCODE_START	; 06/06/2023
  8703                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  8704                                  	;mov	ax,894h ; EndCode-RCODE_START
  8705                                  
  8706                                  not_first_pop:
  8707                                  	; 29/01/2023
  8708 00001E21 5B                      	pop	bx
  8709                                  
  8710                                  not_first:
  8711                                  
  8712                                  ;Note that ax = 0 (side effect of int 2fh), if the code is not to be retained
  8713                                  
  8714 00001E22 01C1                    	add	cx,ax
  8715                                  
  8716                                  not_first2:	; 06/06/2023
  8717                                  
  8718                                  ;endif	;not ROMDOS
  8719                                  
  8720 00001E24 83C10F                  	add	cx,15				;round up to next para
  8721 00001E27 D1E9                    	shr	cx,1
  8722 00001E29 D1E9                    	shr	cx,1
  8723 00001E2B D1E9                    	shr	cx,1
  8724 00001E2D D1E9                    	shr	cx,1				;ax = para size of res code
  8725 00001E2F 890E[B404]              	mov	[ResSize],cx			;store resident size
  8726                                  
  8727 00001E33 1F                      	pop	ds
  8728                                  	;assume	ds:nothing
  8729 00001E34 C3                      	retn
  8730                                  
  8731                                  ;ifndef	ROMDOS
  8732                                  
  8733                                  ;bugbug: remove this code (for version independent COMMAND) after testing
  8734                                  
  8735                                  	; 29/01/2023
  8736                                  ;oldver:
  8737                                  ;	pop	bx
  8738                                  ;	;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8739                                  ;	;;mov	ax,81Ah ; MSDOS 5.0 COMMAND.COM
  8740                                  ;	; 29/01/2023
  8741                                  ;	mov	ax,EndCode-RCODE_START
  8742                                  ;	jmp	short not_first
  8743                                  
  8744                                  ;endif	;not ROMDOS
  8745                                  
  8746                                  ;setup_res_end	endp
  8747                                  
  8748                                  ;ifndef	ROMDOS
  8749                                  
  8750                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8751                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D52h
  8752                                  
  8753                                  	; MSDOS 6.0
  8754                                  ;*** Move_res_code -- This routine moves the resident code to its final 
  8755                                  ; location. We check if DOS is in HIMEM. If so, we try to load ourselves
  8756                                  ; in HIMEM. If we fail, then we remain low and update ResSize to reflect
  8757                                  ; the correct resident size. When remaining low, we have to check if we 
  8758                                  ; need to overlay the messages part of the data segment which is determined
  8759                                  ; by the /msg switch.
  8760                                  ;
  8761                                  ;	ENTRY: ResMsgEnd = end of resident data
  8762                                  ;
  8763                                  ;	EXIT:  The resident code is either up high or in its final location
  8764                                  ;		down low.
  8765                                  ;
  8766                                  ;	REGISTERS AFFECTED: ax,bx,cx,dx,si,di
  8767                                  
  8768                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8769                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:200Eh
  8770                                  	
  8771                                  Move_res_code:	;proc near
  8772                                  
  8773 00001E35 1E                      	push	ds
  8774 00001E36 06                      	push	es
  8775                                  
  8776 00001E37 8CC8                    	mov	ax,cs
  8777 00001E39 8ED8                    	mov	ds,ax
  8778                                  	;assume	ds:RESGROUP
  8779                                  
  8780                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) or 06h ; M013
  8781 00001E3B B80633                  	mov	ax,3306h
  8782 00001E3E CD21                    	int	21h				;DOS in HIMEM?
  8783                                  		; DOS - 5+ Get TRUE Version Number
  8784                                  		; (BL major, BH minor, DL revision, DH flags)
  8785                                  
  8786 00001E40 80E610                  	and	dh,10h				; M013
  8787 00001E43 7517                    	jnz	short move_high			;yes, move code high
  8788                                  
  8789                                  ;Check if messages have been discarded or not
  8790                                  
  8791                                  load_low:
  8792 00001E45 1E                      	push	ds
  8793 00001E46 07                      	pop	es				;es = RESGROUP
  8794 00001E47 8B3E[B204]              	mov	di,[ResMsgEnd]			;end offset in DATARES
  8795                                  	;;mov	bx,offset RESGROUP:ExtMsgEnd	;end offset of messages
  8796                                  	;mov	bx,ExtMsgEnd
  8797                                  
  8798                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8799                                  %if 0	 ; PCDOS 7.1 COMMAND.COM
  8800                                  
  8801                                  	; 29/01/2023
  8802                                  	cmp	di,ExtMsgEnd
  8803                                  	;cmp	di,bx				;are messages to be kept?
  8804                                  	je	short no_move			;yes, dont move code
  8805                                  ;%else
  8806                                  	; Erdogan Tan - 18/07/2024
  8807                                  	;mov	bx,ExtMsgEnd ; (this bx is not used after here!)
  8808                                  %endif
  8809                                  
  8810                                  ; 18/07/2024
  8811                                  %if 0
  8812                                  	jmp	short setup_move		;es:di points at dest.
  8813                                  %else
  8814                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8815                                  setup_move:
  8816                                  	;mov	si,offset RESGROUP:StartCode
  8817                                  	; 03/05/2023
  8818 00001E4B BE[100D]                	mov	si,RCODE_START  ; Start addr of Resident Code (CODERES segment)
  8819                                  				; 0D40h for MSDOS 5.0 COMMAND.COM
  8820                                  				; 0E10h for PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8821                                  	;mov	cx,offset CODERES:EndCode	;cx = bytes to move
  8822                                  	;mov	cx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8823                                  	; 06/06/2023
  8824                                  	;mov	cx,EndCode-(RCODE_START+100h) ; 23/04/2023
  8825                                  	; 03/05/2023
  8826 00001E4E B9(7209)                	mov	cx,EndCode-RCODE_START	; 06/06/2023
  8827                                  	;mov	cx,894h ; PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8828                                  
  8829 00001E51 FC                      	cld
  8830 00001E52 57                      	push	di				;need di for patching offset
  8831 00001E53 F3A4                    	rep	movsb
  8832 00001E55 5F                      	pop	di
  8833                                  patch_up:
  8834 00001E56 E86F01                  	call	patch_stub
  8835 00001E59 07                      	pop	es
  8836 00001E5A 1F                      	pop	ds
  8837                                  	;assume	ds:nothing
  8838 00001E5B C3                      	retn
  8839                                  %endif
  8840                                  
  8841                                  move_high:
  8842                                  
  8843                                  ;We have to call DOS to get the load address in HIMEM for COMMAND
  8844                                  ;We pass in bx the number of bytes we need
  8845                                  
  8846                                  	;mov	bx,offset CODERES:EndCode
  8847                                  	; 29/01/2023
  8848                                  	;;mov	bx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8849                                  	; 06/06/2023
  8850                                  	;mov	bx,EndCode-(RCODE_START+100h) ; 23/04/2023 ; 06/06/2023
  8851                                  	; 03/05/2023
  8852 00001E5C BB(7209)                	mov	bx,EndCode-RCODE_START ; 06/06/2023
  8853                                  	; 18/07/2024
  8854                                  	;mov	bx,894h	 ; PCDOS 7.1 COMMAND.COM
  8855                                  
  8856                                  ;M030;
  8857                                  ; Set di=0ffffh so that we load low in case no one answers this int 2fh
  8858                                  
  8859 00001E5F BFFFFF                  	mov	di,0FFFFh			;DT - in case no-one handles
  8860                                  						;this ; M030
  8861 00001E62 B8024A                  	mov	ax,GET_HMA_ADDR ; 4A02h
  8862 00001E65 CD2F                    	int	2Fh
  8863                                  
  8864                                  ;If the offset = 0xffff, then no HMA available
  8865                                  
  8866 00001E67 83FFFF                  	cmp	di,0FFFFh			;HMA available?
  8867 00001E6A C606[9600]01            	mov	byte [ComInHMA],1		;assume command.com in HMA
  8868 00001E6F 75DA                    	jne	short setup_move		;no error, es:di = memory
  8869                                  
  8870                                  	;mov	byte [ComInHMA],0		;could not load in HMA
  8871                                  	; 29/01/2023	
  8872 00001E71 FE0E[9600]              	dec	byte [ComInHMA] ; 1 -> 0
  8873                                  
  8874                                  ;Zero means that we do not have enough HIMEM. Remain low and update
  8875                                  ;ResSize to reflect this
  8876                                  
  8877 00001E75 8B0E[B204]              	mov	cx,[ResMsgEnd]			;size of data in bytes
  8878                                  	;;mov	ax,offset CODERES:EndCode	;size of code in bytes
  8879                                  	;;mov	ax,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8880                                  	;mov	ax,EndCode-RCODE_START
  8881                                  	;add	cx,ax
  8882                                  	; 06/06/2023
  8883                                  	; 29/01/2023
  8884                                  	;add	cx,(EndCode-(RCODE_START+100h))+15 ; 23/04/2023 ; 06/06/2023
  8885                                  	;add	cx,15				;round up to next para
  8886                                  	; 03/05/2023
  8887 00001E79 81C1(8109)              	add	cx,(EndCode-RCODE_START)+15 ; 06/06/2023
  8888 00001E7D D1E9                    	shr	cx,1
  8889 00001E7F D1E9                    	shr	cx,1
  8890 00001E81 D1E9                    	shr	cx,1
  8891 00001E83 D1E9                    	shr	cx,1				;ax = para size of res code
  8892 00001E85 890E[B404]              	mov	[ResSize],cx			;store resident size
  8893 00001E89 EBBA                    	jmp	short load_low			;let code remain low
  8894                                  
  8895                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8896                                  %if 0	 ; PCDOS 7.1 COMMAND.COM
  8897                                  no_move:
  8898                                  	; 05/05/2023
  8899                                  	;mov	cl,4
  8900                                  	add	di,0Fh
  8901                                  	and	di,0FFF0h			;round it to a para offset
  8902                                  	jmp	short patch_up
  8903                                  
  8904                                  setup_move:
  8905                                  	;mov	si,offset RESGROUP:StartCode
  8906                                  	; 03/05/2023
  8907                                  	mov	si,RCODE_START  ; Start addr of Resident Code (CODERES segment)
  8908                                  				; 0D40h for MSDOS 5.0 COMMAND.COM
  8909                                  				; 0E10h for PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8910                                  	;mov	cx,offset CODERES:EndCode	;cx = bytes to move
  8911                                  	;mov	cx,81Ah ; MSDOS 5.0 & MSDOS 6.22 COMMAND.COM
  8912                                  	; 06/06/2023
  8913                                  	;mov	cx,EndCode-(RCODE_START+100h) ; 23/04/2023
  8914                                  	; 03/05/2023
  8915                                  	mov	cx,EndCode-RCODE_START	; 06/06/2023
  8916                                  	;mov	cx,894h ; PCDOS 7.1 COMMAND.COM ; 18/07/2024
  8917                                  
  8918                                  	cld
  8919                                  	push	di				;need di for patching offset
  8920                                  	rep	movsb
  8921                                  	pop	di
  8922                                  
  8923                                  patch_up:
  8924                                  	call	patch_stub
  8925                                  	pop	es
  8926                                  	pop	ds
  8927                                  	;assume	ds:nothing
  8928                                  	retn
  8929                                  %endif
  8930                                  
  8931                                  ;Move_res_code endp
  8932                                  
  8933                                  ;else	;ROMDOS
  8934                                  ;
  8935                                  ;;***	Move_res_code - ROMDOS version - locate ROM resident
  8936                                  ;
  8937                                  ;Move_res_code	proc
  8938                                  ;
  8939                                  ;	push	es
  8940                                  ;
  8941                                  ;	invoke	FindROMRes		; ES:DI = ptr to ROM resident code
  8942                                  ;	call	patch_stub
  8943                                  ;
  8944                                  ;	pop	es
  8945                                  ;	ret
  8946                                  ;
  8947                                  ;Move_res_code	endp
  8948                                  ;
  8949                                  ;	assume	ds:NOTHING		; to match ending assume above
  8950                                  ;
  8951                                  ;endif	;ROMDOS
  8952                                  
  8953                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  8954                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1D52h
  8955                                  
  8956                                  	; MSDOS 6.0
  8957                                  ;*** Alloc_env -- This routine allocates the temporary environment for the
  8958                                  ; Init code to initialize the COMSPEC. This is not a complete environment. 
  8959                                  ; Later on, at EndInit time, a proper sized environment is allocated and
  8960                                  ; the contents of this temporary environment are copied to it. This routine
  8961                                  ; will not be called in case a valid environment is passed to command.com
  8962                                  ;
  8963                                  ;       ENTRY:  FirstCom and initial EnvirSeg set
  8964                                  ;
  8965                                  ;       EXIT:   ax = EnvirSeg = segment of newly allocated environment segment
  8966                                  ;
  8967                                  ;       REGISTERS AFFECTED: ax,bx,cx,dx
  8968                                  
  8969                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  8970                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:1F3Fh
  8971                                  
  8972                                  	; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  8973                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:206Eh
  8974                                  
  8975                                  alloc_env:	;proc near
  8976                                  	;assume ds:nothing
  8977                                  	
  8978 00001E8B 1E                              push    ds
  8979 00001E8C 06                      	push	es
  8980 00001E8D 56                      	push	si
  8981 00001E8E 57                      	push	di
  8982                                  
  8983                                  ; 07/06/2023
  8984                                  ; 29/01/2023 - MSDOS 6.0 COMMAND.COM
  8985                                  ;%if 0
  8986                                  %if 1 
  8987 00001E8F 16                              push    ss
  8988 00001E90 1F                              pop     ds
  8989                                  	;assume ds:RESGROUP
  8990                                  
  8991 00001E91 A1[3A04]                        mov     ax,[EnvirSeg]
  8992                                  
  8993 00001E94 803E[5920]00                    cmp	byte [AllocedEnv],0
  8994 00001E99 7403                            je	short alloc_cont
  8995 00001E9B E91F01                          jmp     alloc_done
  8996                                  
  8997                                  alloc_cont:
  8998 00001E9E 29FF                            sub     di,di                           ; default start
  8999                                          ;mov	bx,SIZE Environment             ; default size needed
  9000                                  	; 29/01/2023
  9001 00001EA0 BBA600                  	mov	bx,ENVIRONSIZ	; mov bx,180 ; 07/06/2023
  9002                                  				; mov bx,166 ; 18/07/2024 ; PCDOS 7.1
  9003 00001EA3 803E[9E26]00                    cmp	byte [FirstCom],0		; first COMMAND.COM?
  9004 00001EA8 7462                            je	short alloc_seg			; no
  9005                                  
  9006                                  ;   Check EnvirSeg; if non-zero, then scan it for PATH and COMSPEC;
  9007                                  ;   Record their respective locations and do not add the default vars.
  9008                                  
  9009 00001EAA 09C0                    	or      ax,ax
  9010 00001EAC 745A                    	jz	short alloc_new			; no previous environment
  9011                                  
  9012 00001EAE 8EC0                            mov     es,ax
  9013                                  	;assume es:nothing
  9014                                  
  9015                                  _find_path:
  9016 00001EB0 B000                            mov     al,0
  9017 00001EB2 29FF                            sub     di,di
  9018                                  comp_path:
  9019 00001EB4 AE                              scasb                                   ; end of env?
  9020 00001EB5 7417                    	je	short _find_prompt		; yes
  9021                                  	;je	short find_comspec ; 18/07/2024 ; PCDOS 7.1 COMMAND.COM
  9022 00001EB7 4F                              dec     di
  9023 00001EB8 B90500                          mov     cx,PathStrLen ; mov cx,5 ; "PATH="
  9024                                          ;mov	si,offset RESGROUP:PathString
  9025 00001EBB BE[5A20]                	mov	si,PathString	; "PATH="
  9026 00001EBE F3A6                            repe    cmpsb
  9027 00001EC0 7407                            je	short got_path
  9028 00001EC2 B90001                          mov	cx,256
  9029 00001EC5 F2AE                            repne   scasb                           ; find next NULL
  9030 00001EC7 EBEB                            jmp     short comp_path
  9031                                  
  9032                                  got_path:
  9033 00001EC9 C606[5A20]00                    mov	byte [PathString],0		; don't add it
  9034                                  
  9035                                  _find_prompt:
  9036                                  
  9037                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9038                                  ;%if 0 ;  PCDOS 7.1 COMMAND.COM
  9039                                  ;	sub     di,di
  9040                                  ;comp_prompt:
  9041                                  ;	scasb                                   ; end of env?
  9042                                  ;	je	short find_comspec		; yes
  9043                                  ;	dec     di
  9044                                  ;	mov     cx,PrmptStrLen2	; mov cx,7
  9045                                  ;	;mov	si,offset RESGROUP:PrmptString
  9046                                  ;	mov	si,PrmptString	; "PROMPT=$P$G"
  9047                                  ;	repe	cmpsb
  9048                                  ;	je	short got_prompt
  9049                                  ;	mov	cx,256
  9050                                  ;	repne	scasb                           ; find next NULL
  9051                                  ;	jmp	short comp_prompt
  9052                                  ;
  9053                                  ;got_prompt:
  9054                                  ;	mov	byte [PrmptString],0		; don't add it
  9055                                  ;%endif
  9056                                  
  9057                                  find_comspec:
  9058 00001ECE 29FF                            sub     di,di
  9059                                  comp_comspec:
  9060 00001ED0 AE                              scasb                                   ; end of env?
  9061 00001ED1 7423                            je	short got_envend		; yes
  9062 00001ED3 4F                              dec     di
  9063 00001ED4 B90800                          mov	cx,ComspStrLen	; mov cx,8
  9064                                  	;mov	si,offset RESGROUP:ComspString
  9065 00001ED7 BE[7220]                	mov	si,ComspString	; "COMSPEC=\COMMAND.COM"
  9066 00001EDA F3A6                            repe    cmpsb
  9067 00001EDC 7407                            je	short got_comspec
  9068 00001EDE B90001                          mov     cx,256
  9069 00001EE1 F2AE                            repne   scasb                           ; find next NULL
  9070 00001EE3 EBEB                            jmp	short comp_comspec
  9071                                  
  9072                                  got_comspec:
  9073 00001EE5 893E[7020]                      mov     [ComspOffset],di
  9074                                  
  9075                                  find_envend:
  9076 00001EE9 29FF                            sub     di,di
  9077 00001EEB B90080                          mov     cx,ENVBIG	; 32768		; max env size
  9078                                  comp_envend:
  9079 00001EEE 49                              dec     cx                              ;
  9080 00001EEF AE                              scasb                                   ; end of env?
  9081 00001EF0 7404                            je	short got_envend		; yes
  9082 00001EF2 F2AE                            repne   scasb
  9083 00001EF4 EBF8                            jmp	short comp_envend
  9084                                  
  9085                                  got_envend:
  9086 00001EF6 4F                              dec     di
  9087                                  	; 07/06/2023
  9088 00001EF7 8D9DA600                	lea     bx,[di+ENVIRONSIZ]		; add room for the basics
  9089                                  	; 18/07/2024
  9090                                  	;lea     bx,[di+166] ; PCDOS 7.1 COMMAND.COM - ENVIRONSIZ = 166
  9091                                  
  9092                                  ;   We want to fall through to alloc_new and set up default
  9093                                  ;   path and prompt ONLY IF this is the first process;  in all other
  9094                                  ;   cases, we assume it is a bad idea to try editing the user's environment
  9095                                  
  9096 00001EFB 1E                              push    ds
  9097                                          ;mov	ds,ds:[PDB_Parent_Pid]
  9098 00001EFC 8E1E1600                        mov	ds,[PDB.PARENT_PID]
  9099                                  	;cmp	ds:[PDB_Parent_Pid],0           ; is parent's parent pid field 0?
  9100 00001F00 833E160000              	cmp	word [PDB.PARENT_PID],0
  9101 00001F05 1F                      	pop     ds
  9102 00001F06 7504                            jne	short alloc_seg			; no, we're not the first process
  9103                                                                                  ; so don't muck with the env.
  9104                                  alloc_new:
  9105 00001F08 FE06[5920]              	inc	byte [AllocedEnv]		; note we have virgin env.
  9106                                  
  9107                                  alloc_seg:
  9108                                  
  9109                                  ; Allocate default environment size
  9110                                  
  9111 00001F0C 89D9                            mov     cx,bx                           ; save byte-granular size in CX
  9112 00001F0E 83C30F                          add     bx,15
  9113 00001F11 D1EB                            shr     bx,1
  9114 00001F13 D1EB                            shr     bx,1
  9115 00001F15 D1EB                            shr     bx,1
  9116 00001F17 D1EB                            shr     bx,1                            ; BX = # paras
  9117 00001F19 B448                    	mov	ah,ALLOC ; 48h
  9118 00001F1B CD21                    	int	21h
  9119 00001F1D 7303                            jnc	short init_ok
  9120 00001F1F E9A000                          jmp     init_nomem                      ; insufficient memory, error
  9121                                  
  9122                                  ; If a previous environment existed (ie, DI != 0), then copy it into
  9123                                  ; the new buffer
  9124                                  
  9125                                  init_ok:
  9126 00001F22 8EC0                    	mov	es,ax
  9127                                  	;assume	es:nothing                      ; es = temp env segment
  9128                                  
  9129 00001F24 09FF                    	or      di,di
  9130 00001F26 7412                            jz	short copy_path
  9131                                  
  9132 00001F28 51                              push    cx
  9133 00001F29 1E                              push    ds
  9134 00001F2A 8E1E[3A04]                      mov     ds,[EnvirSeg]
  9135                                          ;assume ds:nothing
  9136 00001F2E 29F6                            sub     si,si
  9137 00001F30 89F9                            mov     cx,di
  9138 00001F32 29FF                            sub     di,di
  9139 00001F34 F3A4                            rep     movsb
  9140 00001F36 1F                              pop     ds
  9141                                          ;assume ds:RESGROUP
  9142 00001F37 59                              pop     cx
  9143 00001F38 29F9                            sub     cx,di
  9144                                  
  9145                                  copy_path:
  9146                                  
  9147                                  ; First clear out (the rest of) the buffer
  9148                                  
  9149 00001F3A 57                              push    di
  9150 00001F3B 29C0                            sub     ax,ax
  9151 00001F3D F3AA                            rep     stosb
  9152 00001F3F 5F                              pop     di
  9153                                  
  9154                                  ; Initialize the path string (PATH=) first
  9155                                  
  9156                                          ;mov	si,offset RESGROUP:PathString   ; DS:SI -> "PATH=\0"
  9157 00001F40 BE[5A20]                	mov	si,PathString
  9158 00001F43 3804                            cmp     byte [si],al			; add it?
  9159 00001F45 7450                            je	short init_prompt		; no
  9160                                  	;mov	cx,PathStrLen+1                 ;
  9161 00001F47 B90600                  	mov	cx,6 ; db "PATH=",0
  9162 00001F4A F3A4                            rep     movsb                           ;
  9163 00001F4C 3806[5920]                      cmp     [AllocedEnv],al			; virgin env?
  9164 00001F50 7445                            je	short init_prompt		; no
  9165                                  
  9166                                  ; Establish a more reasonable default for the PATH
  9167                                  
  9168                                  	;mov	ah,GET_DEFAULT_DRIVE
  9169 00001F52 B419                    	mov	ah,19h
  9170 00001F54 CD21                    	int	21h
  9171 00001F56 0441                            add     al,'A'                          ; convert to letter
  9172 00001F58 A2[6020]                        mov     [DefPathString],al              ;
  9173 00001F5B A2[6720]                        mov     [DefPath2String],al             ; now our default paths are complete
  9174                                  
  9175 00001F5E B200                            mov     dl,0                            ; get dir for default drive
  9176 00001F60 1E                              push    ds                              ;
  9177 00001F61 06                              push    es                              ;
  9178 00001F62 1F                              pop     ds                              ;
  9179 00001F63 C6055C                          mov     byte [di],'\'			;
  9180 00001F66 8D7501                          lea     si,[di+1]                       ; set DS:SI -> available space
  9181                                  	;mov	ah,Current_Dir                  ;
  9182 00001F69 B447                            mov	ah,47h
  9183 00001F6B CD21                    	int     21h                             ;
  9184 00001F6D 1F                              pop     ds                              ;
  9185                                  
  9186                                  	;mov	cx,9 ; db "C:\MSDOS",0
  9187                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  9188                                  	;mov	cx,7 ; db "C:\DOS",0
  9189 00001F6E B90700                  	mov	cx,DefPathStrLen+1 ; 7
  9190                                  	
  9191                                  	;mov	dx,offset RESGROUP:DefPathString
  9192 00001F71 BA[6020]                	mov	dx,DefPathString	; "C:\MSDOS"
  9193                                  			; 18/07/2024	; "C:\DOS" for PCDOS 7.1 COMMAND.COM
  9194 00001F74 89D6                    	mov	si,dx                           ;
  9195                                          ;mov	ah,CHDir                        ;
  9196 00001F76 B43B                            mov	ah,3Bh
  9197 00001F78 CD21                    	int     21h                             ;
  9198 00001F7A 730E                            jnc	short init_setpath		; DefPathString exists!
  9199                                  
  9200                                          ;mov	cx,7 ; db "C:\DOS",0
  9201                                  	; 18/07/2024 - PCDOS 7.1 COMMAND.COM
  9202                                  	;mov	cx,9 ; db "C:\MSDOS",0
  9203 00001F7C B90900                  	mov	cx,DefPath2StrLen+1 ; 9
  9204                                  
  9205                                  	;mov	dx,offset RESGROUP:DefPath2String
  9206 00001F7F BA[6720]                	mov	dx,DefPath2String	; "C:\DOS"
  9207                                  			; 18/07/2024	; "C:\MSDOS" for PCDOS 7.1 COMMAND.COM
  9208 00001F82 89D6                            mov     si,dx                           ;
  9209                                          ;mov	ah,CHDir                        ;
  9210 00001F84 B43B                            mov	ah,3Bh
  9211 00001F86 CD21                            int     21h                             ;
  9212 00001F88 720D                            jc	short init_prompt		; DefPath2String doesn't exist
  9213                                  
  9214                                  init_setpath:
  9215 00001F8A 89FA                            mov     dx,di                           ; success
  9216 00001F8C 1E                              push    ds                              ; so restore prev dir
  9217 00001F8D 06                              push    es                              ;
  9218 00001F8E 1F                              pop     ds                              ; DS:DX -> prev dir
  9219                                          ;mov	ah,CHDir                        ;
  9220 00001F8F B43B                            mov	ah,3Bh			
  9221 00001F91 CD21                            int     21h                             ;
  9222 00001F93 1F                              pop     ds                              ;
  9223                                  
  9224 00001F94 4F                              dec     di                              ; then copy in DefPathString
  9225 00001F95 F3A4                            rep     movsb                           ; DS:SI -> "C:\\DOS\0"
  9226                                  
  9227                                  ; Initialize the default prompt
  9228                                  
  9229                                  init_prompt:
  9230                                  ;init_compec:	; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:217Ah)	
  9231                                  
  9232 00001F97 57                              push    di                              ;
  9233 00001F98 29C0                            sub     ax,ax                           ;
  9234 00001F9A B94000                          mov     cx,64                           ; insure any data read in
  9235 00001F9D F3AA                            rep     stosb                           ; from Current_Dir is zapped
  9236 00001F9F 5F                              pop     di                              ;
  9237                                  
  9238                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9239                                  ;%if 0 	; PCDOS 7.1 COMMAND.COM
  9240                                  ;	cmp	[AllocedEnv],al			; virgin env?
  9241                                  ;	je	short init_comspec		; no
  9242                                  ;	;mov	si,offset RESGROUP:PrmptString  ; DS:SI -> "PROMPT=$P$G\0"
  9243                                  ;	mov	si,PrmptString
  9244                                  ;	cmp     [si],al				; add it?
  9245                                  ;	je      short init_comspec		; no
  9246                                  ;	;mov	cx,PrmptStrLen+1                ;
  9247                                  ;	mov	cl,12  ; db "PROMPT=$P$G",0
  9248                                  ;	rep     movsb                           ;
  9249                                  ;%endif
  9250                                  
  9251                                  ; Initialize the Comspec string
  9252                                  
  9253                                  init_comspec:
  9254                                  	; 18/07/2024 (PCDOS 7.1 COMMAND.COM - RESGROUP:2183h)
  9255                                  
  9256 00001FA0 3906[7020]                      cmp	[ComspOffset],ax		; add it?
  9257 00001FA4 750E                            jne	short init_done			; no
  9258                                          ;lea	ax,[di+8]
  9259 00001FA6 8D4508                  	lea     ax,[di+ComspStrLen]             ;
  9260 00001FA9 A3[7020]                        mov	[ComspOffset],ax		;
  9261                                          ;mov	si,offset RESGROUP:ComspString  ; DS:SI -> "COMSPEC=\\COMMAND.COM\0"
  9262 00001FAC BE[7220]                        mov	si,ComspString
  9263                                  	; 23/07/2024
  9264 00001FAF B91500                  	mov	cx,ComspStrLen2+1               ;
  9265                                          ;mov	cx,21 ; db "COMSPEC=\COMMAND.COM",0
  9266 00001FB2 F3A4                    	rep     movsb                           ;
  9267                                  
  9268                                  init_done:
  9269 00001FB4 8CC0                            mov     ax,es                           ; return env seg in ax
  9270 00001FB6 A3[3A04]                        mov     [EnvirSeg],ax			; save env seg
  9271 00001FB9 FE06[5920]                      inc	byte [AllocedEnv]		; remember that *we* alloced it
  9272                                  %endif
  9273                                  
  9274                                  ; 07/06/2023
  9275                                  ; 29/01/2023 - MSDOS 5.0 COMMAND.COM (RESGROUP:1DC4h)
  9276                                  ;%if 1
  9277                                  %if 0
  9278                                  	;mov	bx,10
  9279                                  	mov	bx,ENVIRONSIZ>>4 ; 160/16
  9280                                  	mov	ah,48h
  9281                                  	int	21h    	; DOS - 2+ - ALLOCATE MEMORY
  9282                                  			; BX = number of 16-byte paragraphs desired
  9283                                  	jc	short init_nomem
  9284                                  
  9285                                  init_ok:
  9286                                  	mov	es,ax
  9287                                  	;assume	es:nothing                      ; es = temp env segment
  9288                                  
  9289                                  	xor	di,di
  9290                                  	mov	ax,di
  9291                                  	;mov	cx,160	
  9292                                          mov     cx,ENVIRONSIZ
  9293                                          rep	stosb
  9294                                  
  9295                                  init_pathstr:
  9296                                  
  9297                                  ; Initialize the path string (PATH=) first
  9298                                  
  9299                                  	push	ss
  9300                                  	pop	ds
  9301                                  
  9302                                          ;mov	si,offset RESGROUP:PathString   ; DS:SI -> "PATH=\0"
  9303                                  	mov	si,PathString
  9304                                  	mov	di,0
  9305                                  init_cp_pathstr:
  9306                                  	lodsb
  9307                                  	stosb
  9308                                  	or	al,al
  9309                                  	jnz	short init_cp_pathstr
  9310                                  
  9311                                  ; Initialize the Comspec string
  9312                                  
  9313                                  init_comspec:
  9314                                          ;mov	si,offset RESGROUP:ComspString  ; DS:SI -> "COMSPEC=\\COMMAND.COM\0"
  9315                                          mov	si,ComspString
  9316                                  	; 05/05/2023
  9317                                  	mov	di,6
  9318                                  init_cp_compstr:
  9319                                  	lodsb
  9320                                  	stosb
  9321                                  	or	al,al
  9322                                  	jnz	short init_cp_compstr
  9323                                  
  9324                                  init_done:
  9325                                          mov     ax,es                           ; return env seg in ax
  9326                                          ;mov	[EnvirSeg],ax			; save env seg
  9327                                          ;inc	byte [AllocedEnv]		; remember that *we* alloced it
  9328                                  %endif	
  9329                                  
  9330                                  	; 29/01/2023
  9331                                  alloc_done:
  9332 00001FBD 5F                      	pop	di
  9333 00001FBE 5E                      	pop	si
  9334 00001FBF 07                      	pop	es
  9335 00001FC0 1F                              pop     ds
  9336                                  	;assume	ds:nothing
  9337 00001FC1 C3                      	retn
  9338                                  
  9339                                  	; 29/01/2023
  9340                                  init_nomem:
  9341                                  
  9342                                  ;We call the error routine from here. This routine never returns. It either
  9343                                  ;terminates COMMAND with error( if it is not the first invocation ) or hangs
  9344                                  ;the system ( if it is the first COMMAND.COM ).
  9345                                  
  9346 00001FC2 E80000                  	call	Alloc_error
  9347                                  
  9348                                  ;Alloc_env	endp
  9349                                  
  9350                                  ;*** Alloc_error: This routine just jumps to the actual label where we 
  9351                                  ; check if this is a permanent or secondary command.com and take the 
  9352                                  ; appropriate action.
  9353                                  ;
  9354                                  ;	ENTRY:	ds = RESGROUP = DATARES
  9355                                  ;
  9356                                  ;	EXIT:	None - does not return
  9357                                  ;
  9358                                  ;	REGISTERS AFFECTED: Does not matter
  9359                                  ;
  9360                                  
  9361                                  ;public Alloc_error
  9362                                  Alloc_error:	;proc	near
  9363                                  
  9364                                  	;jmp	RESGROUP:BadMemErr
  9365                                  	; 29/01/2023
  9366 00001FC5 E950EE                  	jmp	BadMemErr	
  9367                                  	
  9368                                  ;Alloc_error	endp
  9369                                  
  9370                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9371                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1DFFh
  9372                                  
  9373                                  	; MSDOS 6.0
  9374                                  ;*** Patch_stub -- This routine patches in the segment and offset values in
  9375                                  ; the stub table of the various entry points in the resident code segment.
  9376                                  ; Some of them are interrupt entry points and some of them are entries from
  9377                                  ; the transient to the resident code segment.
  9378                                  ;
  9379                                  ;	ENTRY:	ds = RESGROUP
  9380                                  ;		es:di = segment:offset of final location of resident code
  9381                                  ;
  9382                                  ;	EXIT:	All segments and offsets patched into the stub table
  9383                                  ;
  9384                                  ;	REGISTERS AFFECTED: ax, bx, cx, dx, si, di
  9385                                  
  9386                                  patch_stub:	;proc near
  9387                                  	;assume	ds:RESGROUP
  9388                                  	
  9389 00001FC8 06                      	push	es
  9390                                  
  9391 00001FC9 8CC3                    	mov	bx,es			;bx = resident code segment
  9392 00001FCB 89FA                    	mov	dx,di
  9393                                  	;mov	di,offset DATARES:Int2f_Entry
  9394 00001FCD BF[6600]                	mov	di,Int2f_Entry
  9395                                  	;mov	si,offset RESGROUP:Reloc_Table
  9396 00001FD0 BE[8426]                	mov	si,Reloc_Table
  9397 00001FD3 1E                      	push	ds
  9398 00001FD4 07                      	pop	es			;es = RESGROUP = DATARES
  9399                                  
  9400                                  ;bx:dx = segment:offset of resident code segment
  9401                                  ;es:di = entry point table in stub
  9402                                  ;ds:si = offset table in INIT segment -- offsets of code entry points now
  9403                                  
  9404                                  	;mov	cx,NUM_RELOC_ENTRIES	;number of entry points
  9405 00001FD5 B90B00                  	mov	cx,11 ; MSDOS 5.0 COMMAND.COM
  9406                                  patchlp:
  9407 00001FD8 AD                      	lodsw				;get current offset
  9408 00001FD9 01D0                    	add	ax,dx			;offset it by code seg location 
  9409 00001FDB AB                      	stosw				;store offset
  9410 00001FDC 89D8                    	mov	ax,bx			
  9411 00001FDE AB                      	stosw				;store segment 
  9412 00001FDF E2F7                    	loop	patchlp
  9413                                  
  9414 00001FE1 07                      	pop	es
  9415 00001FE2 C3                      	retn
  9416                                  
  9417                                  ;Patch_stub	endp
  9418                                  
  9419                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9420                                  
  9421                                  	; MSDOS 6.0
  9422                                  ;*** Patch_segs -- This routine patches the segment values in the dword 
  9423                                  ; pointers that the stub uses to jump to the actual handler. These values 
  9424                                  ; are temporarily needed to handle these interrupts if they occur before
  9425                                  ; the resident is relocated to its final position and all the addresses of
  9426                                  ; the handlers have been updated.
  9427                                  ;
  9428                                  ;	ENTRY:	es = PSP segment = code segment
  9429                                  ;
  9430                                  ;	EXIT:	Current segment values patched into the jump table in the
  9431                                  ;		stub.
  9432                                  ;
  9433                                  ;	REGISTERS AFFECTED: ax, cx, di
  9434                                  
  9435                                  patch_segs:	;proc near
  9436                                  
  9437                                  	;mov	di,offset RESGROUP:Int2f_Entry
  9438 00001FE3 BF[6600]                	mov	di,Int2f_Entry 
  9439 00001FE6 B90400                  	mov	cx,4			;we have to patch 4 handlers
  9440 00001FE9 83C702                  	add	di,2
  9441 00001FEC 8CC0                    	mov	ax,es
  9442                                  pseglp:
  9443 00001FEE AB                      	stosw				;store the segment value
  9444 00001FEF 83C702                  	add	di,2			;skip the next offset value
  9445 00001FF2 E2FA                    	loop	pseglp
  9446                                  
  9447 00001FF4 C3                      	retn
  9448                                  
  9449                                  ;Patch_segs	endp
  9450                                  
  9451                                  	; 29/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9452                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1E2Ch
  9453                                  
  9454                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9455                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:20D8h
  9456                                  
  9457                                  	; MSDOS 6.0
  9458                                  ;*** get_XMMAddr -- This routine gets the call address for the XMM driver
  9459                                  ; by issuing the appropriate int 2fh. This is stored in a stub variable 
  9460                                  ; and is used by the stub when we have to jump to the resident in HMA
  9461                                  ;
  9462                                  ;	ENTRY:	ds = RESGROUP
  9463                                  ;
  9464                                  ;	EXIT:	XMMCallAddr = XMM driver far call address
  9465                                  ;
  9466                                  ;	REGISTERS AFFECTED:
  9467                                  ;
  9468                                  
  9469                                  get_XMMAddr:	;proc near
  9470                                  	;assume	ds:RESGROUP
  9471                                  
  9472 00001FF5 06                      	push	es
  9473                                  
  9474                                  	;mov	ax,XMM_MULTIPLEX SHL 8 + XMM_INSTALL_CHECK
  9475 00001FF6 B80043                  	mov	ax,4300h
  9476 00001FF9 CD2F                    	int	2Fh
  9477                                  		; - Multiplex - XMS - INSTALLATION CHECK
  9478                                  		; Return: AL = 80h XMS driver installed
  9479                                  		; AL <> 80h no driver
  9480 00001FFB 3C80                    	cmp	al,80h			; Q: installed
  9481 00001FFD 750D                    	jne	short cXMMexit		; N: set error, quit
  9482                                  ;
  9483                                  ; get the XMM control functions entry point, save it, we
  9484                                  ; need to call it later.
  9485                                  ;
  9486                                  	;mov	ax,XMM_MULTIPLEX SHL 8 + XMM_FUNCTION_ADDR
  9487 00001FFF B81043                  	mov	ax,4310h
  9488 00002002 CD2F                    	int	2Fh
  9489                                  		; - Multiplex - XMS - GET DRIVER ADDRESS
  9490                                  		; Return: ES:BX -> driver entry point
  9491                                  
  9492 00002004 891E[9200]              	mov	[XMMCallAddr], bx
  9493 00002008 8C06[9400]              	mov	[XMMCallAddr+2],es
  9494                                  cXMMexit:
  9495 0000200C 07                      	pop	es
  9496 0000200D C3                      	retn				; done
  9497                                  
  9498                                  ;get_XMMAddr	endp
  9499                                  
  9500                                  ;=============================================================================
  9501                                  ; UNINIT.ASM, MSDOS 6.0, 1991
  9502                                  ;=============================================================================
  9503                                  ; 24/09/2018 - Retro DOS v3.0
  9504                                  
  9505                                  ; (30/04/2018 - Retro DOS v2.0, MSDOS 2.11 COMMAND.COM)
  9506                                  
  9507                                  ; TITLE	COMMAND Initialization messages
  9508                                  
  9509                                  ;INIT	SEGMENT PUBLIC PARA
  9510                                  
  9511                                  ; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9512                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9513                                  
  9514                                  	; 25/09/2018
  9515                                  	; (15 bytes filler)
  9516 0000200E 00                      	db 0
  9517                                  	;db "25/9/2018 ETAN"
  9518                                  	; 30/01/2023
  9519                                  	;db "30/1/2023 ETAN"	
  9520                                  	; 19/06/2023
  9521                                  	;db "19/6/2023 ETAN"
  9522                                  	; 31/07/2024
  9523 0000200F 33312F372F32303234-     	db "31/7/2024 ETAN"	
  9523 00002018 204554414E         
  9524 0000201D 00                      	db 0
  9525                                  
  9526                                  ; 30/01/2023
  9527                                  %if 0
  9528                                  	; MSDOS 3.3 COMMAND.COM - offset 145Eh
  9529                                  	;dw 0
  9530                                  COPYRIGHTMSG:	; MSDOS 3.3 COMMAND.COM - offset 1460h
  9531                                  	db 0Dh,0Ah
  9532                                  	db 0Dh,0Ah
  9533                                  	db 'Microsoft(R) MS-DOS(R)  Version 3.30'
  9534                                  	db 0Dh,0Ah
  9535                                  	db '             (C)Copyright Microsoft Corp 1981-1987               '
  9536                                  	db ' ',0Dh,0Ah
  9537                                  	db '                                                   ',
  9538                                  	db 0Dh,0Ah,0
  9539                                  
  9540                                  	times	43 db 20h
  9541                                  
  9542                                  _152Fh:	db 'Specified COMMAND search directory bad',0Dh,0Ah,0
  9543                                  BADCOMLKMES:
  9544                                  	dw _152Fh
  9545                                  
  9546                                  _155Ah:	db 'Specified COMMAND search directory bad access denied',0Dh,0Ah,0
  9547                                  BADCOMACCMSG:
  9548                                  	dw _155Ah
  9549                                  
  9550                                  _1593h:	db 'Access denied',0Dh,0Ah,0
  9551                                  ACCDENERR:
  9552                                  	dw _1593h
  9553                                  
  9554                                  _15A5h:	db 'Out of environment space',0Dh,0Ah,0
  9555                                  OUTENVMSG:
  9556                                  	dw _15A5h
  9557                                  
  9558                                  BADVERMSG:
  9559                                  	db 'Incorrect DOS version',0Dh,0Ah,'$'
  9560                                  
  9561                                  BADENVSIZMSG:
  9562                                  	db 'Invalid environment size specified',0Dh,0Ah,'$'
  9563                                  
  9564                                  HEADERPTR:
  9565                                  	dw COPYRIGHTMSG
  9566                                  %endif
  9567                                  
  9568                                  ; 30/01/2023
  9569                                  ;align 16
  9570                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9571                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1E50h 
  9572                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9573                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:2100h
  9574                                  
  9575                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9576                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:2200h 
  9577                                  ICONDEV:
  9578 0000201E 2F4445562F                      db '/DEV/'
  9579 00002023 434F4E000000000000      	db 'CON',0,0,0,0,0,0	; Room for 8 char device	
  9580                                  BADCSPFL:
  9581 0000202C 00                      	db 0
  9582                                  COMSPECT:
  9583 0000202D 5C434F4D4D414E442E-     	db '\COMMAND.COM',0
  9583 00002036 434F4D00           
  9584 0000203A 00                      	db 0
  9585                                  AUTOBAT:
  9586 0000203B 003A5C4155544F4558-     	db 0,':\AUTOEXEC.BAT',0,0Dh
  9586 00002044 45432E424154000D   
  9587                                  
  9588                                  ; 22/07/2024 - PCDOS 7.1 COMMAND.COM
  9589                                  %if 0
  9590                                  ; 07/06/2023
  9591                                  KAUTOBAT:
  9592                                  	db 0,':\KAUTOEXEC.BAT',0,0Dh
  9593                                  %endif
  9594                                   
  9595                                  PRDATTM:
  9596 0000204C FF                      	db -1 ; 0FFh		; Init not to prompt for date time
  9597                                  INITADD:
  9598 0000204D 00000000                	dd 0
  9599                                  print_add:
  9600 00002051 [0B54]                  	dw Printf_Init
  9601 00002053 0000                    	dw 0
  9602                                  triage_add:
  9603 00002055 [D230]                  	dw Triage_Init
  9604 00002057 0000                    	dw 0
  9605                                  ;CHUCKENV:
  9606                                  AllocedEnv:
  9607 00002059 00                      	db 0
  9608                                  
  9609                                  ; 30/01/2023 - MSDOS 3.3
  9610                                  ;COMSPOFFSET:
  9611                                  ;ECOMLOC:
  9612                                  ;	;dw 0Eh
  9613                                  ;	;dw offset ENVIRONMENT:ECOMSPEC-10h
  9614                                  ;	dw ECOMSPEC-ENVIRONMENT ; 30/04/2018	
  9615                                  ;COMSPSTRING:
  9616                                  ;	db 'COMSPEC='
  9617                                  
  9618                                  ; 18/07/2024
  9619                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:223Ch
  9620                                  
  9621                                  ; 30/01/2023 - MSDOS 5.0 & MSDOS 6.0
  9622                                  PathString:
  9623 0000205A 504154483D00            	db 'PATH=',0
  9624                                  PathStrLen equ ($-PathString)-1
  9625                                  ;;;
  9626                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9627                                  ; MSDOS 6.0
  9628                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9629                                  ; PCDOS 7.1
  9630                                  DefPathString:
  9631                                  	;db 'C:\MSDOS',0
  9632 00002060 433A5C444F5300          	db 'C:\DOS',0	; 18/07/2024
  9633                                  DefPathStrLen equ ($-DefPathString)-1
  9634                                  DefPath2String:
  9635                                  	;db 'C:\DOS',0
  9636 00002067 433A5C4D53444F5300      	db 'C:\MSDOS',0	; 18/07/2024
  9637                                  DefPath2StrLen equ ($-DefPath2String)-1
  9638                                  
  9639                                  ; 18/07/2024 - Retro DOS v5.0 COMMAND.COM
  9640                                  ; PCDOS 7.1 COMMAND.COM
  9641                                  %if 0
  9642                                  PrmptString:
  9643                                  	db 'PROMPT=$P$G',0
  9644                                  PrmptStrLen equ ($-PrmptString)-1
  9645                                  PrmptStrLen2 equ 7	; length of PROMPT=
  9646                                  %endif
  9647                                  
  9648                                  ; 18/07/2024
  9649                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:2252h
  9650                                  
  9651                                  ComspOffset:
  9652 00002070 0000                    	dw 0
  9653                                  ;;;
  9654                                  ComspString:
  9655 00002072 434F4D535045433D5C-     	db 'COMSPEC=\COMMAND.COM',0
  9655 0000207B 434F4D4D414E442E43-
  9655 00002084 4F4D00             
  9656                                  ComspStrLen equ 8		; length of COMSPEC=
  9657                                  ComspStrLen2 equ ($-ComspString)-1
  9658                                  				; length of full COMSPEC
  9659                                  	; 29/01/2023
  9660                                  ;equal_sign:
  9661                                  ;equalsign:
  9662                                  ;	db '='
  9663                                  ;letter_a:
  9664                                  ;lcasea:
  9665                                  ;	db 'a'
  9666                                  ;letter_z:
  9667                                  ;lcasez:
  9668                                  ;	db 'z'
  9669                                  	; 30/01/2023
  9670                                  ;;slash_chr:
  9671                                  ;;	db '/'
  9672                                  ;;bslash_chr:
  9673                                  ;;	db '\'
  9674                                  ;space_chr:
  9675                                  ;;space:
  9676                                  ;	db 20h
  9677                                  ;;letter_p:
  9678                                  ;;	db 'p'
  9679                                  ;;letter_d:
  9680                                  ;;	db 'd'
  9681                                  ;;letter_c:
  9682                                  ;;	db 'c'
  9683                                  	; 16/04/2023
  9684                                  ; MSDOS 5.0 & MSDOS 6.0
  9685                                  ;scswitch:
  9686                                  ;	db 'C'		; Single command
  9687                                  ;;skswitch:
  9688                                  ;	db 'K' ; MSDOS 6.0
  9689                                  ;;letter_A:
  9690                                  ;ucasea: ; 21/01/2023 
  9691                                  ;	db 'A'
  9692                                  
  9693                                  	; 30/01/2023
  9694                                  EnvSiz:
  9695 00002087 0000                    	dw 0		; size user wants to allocate
  9696                                  EnvMax:
  9697 00002089 0000                    	dw 0		; maximum size allowed
  9698                                  OldEnv:
  9699 0000208B 0000                    	dw 0		; envirseg at initialization
  9700                                  UsedEnv:
  9701 0000208D 0000                    	dw 0		; amount of envirseg used
  9702                                  	; MSDOS 5.0 & MSDOS 6.0
  9703                                  PARS_MSG_OFF:
  9704 0000208F 0000                    	dw 0		; SAVED PARSE ERROR MESSAGE OFFSET
  9705                                  PARS_MSG_SEG:
  9706 00002091 0000                    	dw 0		; SAVED PARSE ERROR MESSAGE SEGMENT
  9707                                  
  9708                                  ;Do not separate the following two words. Used to call transient PARSE routine
  9709                                  
  9710                                  Init_Parse:
  9711                                  	;dw 4FFBh	; MSDOS 5.0 COMMAND.COM (TRANGROUP:APPEND_PARSE)
  9712                                  init_p:
  9713 00002093 [0754]                  	dw append_parse ; dw 564Bh ; PCDOS 7.1 COMMAND.COM ; 18/07/2024 
  9714                                  initend:
  9715 00002095 0000                    	dw 0		; segment address of end of init
  9716                                  TrnSize:
  9717 00002097 0000                    	dw 0		; size of transient in paragraphs
  9718                                  
  9719                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  9720                                  %if 0
  9721                                  resetenv:
  9722                                  	;dw 0		; set if we need to setblck env at endinit
  9723                                  	; 23/07/2024
  9724                                  	db 0
  9725                                  %endif
  9726                                  
  9727                                  ext_msg:
  9728 00002099 00                      	db 0		; set if /MSG switch entered
  9729                                  eswitch:
  9730 0000209A 00                      	db 0		; set if /e was entered
  9731                                  dswitch:
  9732 0000209B 00                      	db 0		; set if /d was entered
  9733                                  parsemes_ptr:
  9734 0000209C 0000                    	dw 0		; word to store parse error number
  9735                                  
  9736                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
  9737                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:1ED6h
  9738                                  
  9739                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9740                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:21A5h
  9741                                  
  9742                                  	; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9743                                  	; PCDOS 7.1 COMMAND.COM - RESGROUP:2288h
  9744                                  
  9745                                  	; MSDOS 6.0 (UINIT.ASM, 1991)
  9746                                  ;  The following parse control block is used for COMMAND. This block is
  9747                                  ;  used for parsing during initialization. The syntax for COMMAND is:
  9748                                  ;  COMMAND [/?] [d:][path][/P][/F][/D][/E:xxxxx][/MSG][/C executable]
  9749                                  ;
  9750                                  ;  Anything on the command line after the /C switch will be passed to the
  9751                                  ;  executable command, so if /C is used, it must be specified last. The
  9752                                  ;  /MSG switch can only be specified if the /P switch is specified.
  9753                                  ;
  9754                                  ;  The /? switch causes help text to be displayed. Any other options
  9755                                  ;  on the command line are ignored. Command.com will not load if /?
  9756                                  ;  is specified.
  9757                                  
  9758                                  INTERNAT_INFO:		; used for country info after parsing is completed
  9759                                  PARSE_COMMAND:
  9760 0000209E [A120]                  	dw COMMAND_PARMS
  9761 000020A0 00                      	db 0			; no extra delimiter
  9762                                  COMMAND_PARMS:
  9763 000020A1 0002                    	db 0,2			; 1 positional parm
  9764 000020A3 [BF20]                  	dw COMMAND_FILE
  9765 000020A5 [BF20]                  	dw COMMAND_FILE
  9766                                          ; MSDOS 5.0
  9767                                  	;db 7			; 7 switches
  9768                                  	; MSDOS 6.0
  9769                                  	;db 8 			; 8 switches
  9770                                  	; 07/06/2023
  9771                                  	; MSDOS 6.22
  9772                                  	;db 9			; 9 switches
  9773                                  	; 22/07/2024
  9774                                  	; PCDOS 7.1
  9775 000020A7 0B                      	db 11			; 11 switches
  9776 000020A8 [C820]                  	dw COMMAND_SWITCH1
  9777 000020AA [D420]                  	dw COMMAND_SWITCH2
  9778 000020AC [E020]                  	dw COMMAND_SWITCH3
  9779 000020AE [EC20]                  	dw COMMAND_SWITCH4
  9780 000020B0 [0521]                  	dw COMMAND_SWITCH5
  9781 000020B2 [1121]                  	dw COMMAND_SWITCH6
  9782 000020B4 [1F21]                  	dw COMMAND_SWITCH7
  9783                                  	; 07/06/2023
  9784 000020B6 [2B21]                  	dw COMMAND_SWITCH8 ; MSDOS 6.0
  9785 000020B8 [3721]                  	dw COMMAND_SWITCH9 ; MSDOS 6.22
  9786                                  	; 22/07/2024
  9787 000020BA [4321]                  	dw COMMAND_SWITCH10 ; PCDOS 7.1
  9788 000020BC [4F21]                  	dw COMMAND_SWITCH11 ; PCDOS 7.1
  9789 000020BE 00                      	db 0			; no keywords
  9790                                  
  9791                                  COMMAND_FILE:
  9792 000020BF 0102                    	dw 0201h		; filespec - optional
  9793 000020C1 0100                    	dw 1			; capitalize - file table
  9794 000020C3 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9795 000020C5 [6321]                  	dw NO_VAL 		;
  9796 000020C7 00                      	db 0			; no keywords
  9797                                  
  9798                                  COMMAND_SWITCH1:
  9799 000020C8 0000                    	dw 0			; no match flags
  9800 000020CA 0200                    	dw 2			; capitalize by char table
  9801 000020CC [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9802 000020CE [6321]                  	dw NO_VAL 		;
  9803 000020D0 01                      	db 1			; 1 keyword
  9804                                  COMMAND_P_SYN:
  9805 000020D1 2F5000                  	db '/P',0		; /P switch
  9806                                  
  9807                                  COMMAND_SWITCH2:
  9808 000020D4 0000                    	dw 0			; no match flags
  9809 000020D6 0200                    	dw 2			; capitalize by char table
  9810 000020D8 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9811 000020DA [6321]                  	dw NO_VAL 		;
  9812 000020DC 01                      	db 1			; 1 keyword
  9813                                  COMMAND_F_SYN:
  9814 000020DD 2F4600                  	db '/F',0		; /F switch
  9815                                  
  9816                                  COMMAND_SWITCH3:
  9817 000020E0 0000                    	dw 0			; no match flags
  9818 000020E2 0200                    	dw 2			; capitalize by char table
  9819 000020E4 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9820 000020E6 [6321]                  	dw NO_VAL 		;
  9821 000020E8 01                      	db 1			; 1 keyword
  9822                                  COMMAND_D_SYN:
  9823 000020E9 2F4400                  	db '/D',0		; /D switch
  9824                                  
  9825                                  COMMAND_SWITCH4:
  9826 000020EC 0080                    	dw 8000h		; numeric value - required
  9827 000020EE 0000                    	dw 0			; no function flags
  9828 000020F0 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9829 000020F2 [F820]                  	dw COMMAND_E_VAL	; pointer to value list
  9830 000020F4 01                      	db 1			; 1 keyword
  9831                                  COMMAND_E_SYN:
  9832 000020F5 2F4500                  	db '/E',0		; /E switch
  9833                                  
  9834                                  COMMAND_E_VAL:
  9835 000020F8 01                      	db 1			;
  9836 000020F9 01                      	db 1			; 1 range
  9837 000020FA 01                      	db 1			; returned if result
  9838                                  	;dd ENVSML,ENVBIG	; minimum & maximum value
  9839                                  	; MSDOS 5.0 COMMAND.COM (RESGROUP:1F2Bh)
  9840                                  	; PCDOS 7.1 COMMAND.COM (RESGROUP:22E5h)
  9841 000020FB A0000000                	dd 160	 ; ENVSML	 
  9842 000020FF 00800000                	dd 32768 ; ENVBIG
  9843 00002103 00                      	db 0			; no numeric values
  9844 00002104 00                      	db 0			; no string values
  9845                                  
  9846                                  COMMAND_SWITCH5:
  9847 00002105 0000                    	dw 0			; no match flags
  9848 00002107 0200                    	dw 2			; capitalize by char table
  9849 00002109 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9850 0000210B [6321]                  	dw NO_VAL 		;
  9851 0000210D 01                      	db 1			; 1 keyword
  9852                                  COMMAND_C_SYN:
  9853 0000210E 2F4300                  	db '/C',0		; /C switch
  9854                                  
  9855                                  COMMAND_SWITCH6:
  9856 00002111 0000                    	dw 0			; no match flags
  9857 00002113 0200                    	dw 2			; capitalize by char table
  9858 00002115 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9859 00002117 [6321]                  	dw NO_VAL 		;
  9860 00002119 01                      	db 1			; 1 keyword
  9861                                  COMMAND_M_SYN:
  9862 0000211A 2F4D534700              	db '/MSG',0		; /MSG switch
  9863                                  
  9864                                  COMMAND_SWITCH7:
  9865 0000211F 0000                    	dw 0			; no match flags
  9866 00002121 0200                    	dw 2			; capitalize by char table
  9867 00002123 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9868 00002125 [6321]                  	dw NO_VAL 		;
  9869 00002127 01                      	db 1			; 1 keyword
  9870                                  COMMAND_?_SYN:
  9871 00002128 2F3F00                  	db '/?',0 		; /? switch
  9872                                  
  9873                                  	; 07/06/2023
  9874                                  	; MSDOS 6.0
  9875                                  COMMAND_SWITCH8:
  9876 0000212B 0000                    	dw 0			; no match flags
  9877 0000212D 0200                    	dw 2			; capitalize by char table
  9878 0000212F [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9879 00002131 [6321]                  	dw NO_VAL 		;
  9880 00002133 01                      	db 1			; 1 keyword
  9881                                  COMMAND_K_SYN:
  9882 00002134 2F4B00                  	db '/K',0		; /K switch
  9883                                  
  9884                                  	; 07/06/2023
  9885                                  	; MSDOS 6.22
  9886                                  COMMAND_SWITCH9:
  9887 00002137 0000                    	dw 0			; no match flags
  9888 00002139 0200                    	dw 2			; capitalize by char table
  9889 0000213B [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9890 0000213D [6321]                  	dw NO_VAL 		;
  9891 0000213F 01                      	db 1			; 1 keyword
  9892                                  COMMAND_Y_SYN:
  9893 00002140 2F5900                  	db '/Y',0		; /Y switch
  9894                                  
  9895                                  ; 22/07/2024 - Retro DOS v5.0 COMMAND.COM
  9896                                  %if 1
  9897                                  	; PCDOS 7.1 COMMAND.COM  - RESGROUP:2336h
  9898                                  COMMAND_SWITCH10:
  9899 00002143 0000                    	dw 0			; no match flags
  9900 00002145 0200                    	dw 2			; capitalize by char table
  9901 00002147 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9902 00002149 [6321]                  	dw NO_VAL 		;
  9903 0000214B 01                      	db 1			; 1 keyword
  9904                                  COMMAND_H_SYN:
  9905 0000214C 2F4800                  	db '/H',0		; /H switch
  9906                                  
  9907                                  COMMAND_SWITCH11:
  9908 0000214F 0000                    	dw 0			; no match flags
  9909 00002151 0200                    	dw 2			; capitalize by char table
  9910 00002153 [5B21]                  	dw COMND1_OUTPUT	; result buffer
  9911 00002155 [6321]                  	dw NO_VAL 		;
  9912 00002157 01                      	db 1			; 1 keyword
  9913                                  COMMAND_O_SYN:
  9914 00002158 2F4F00                  	db '/O',0		; /O switch
  9915                                  %endif
  9916                                  
  9917                                  COMND1_OUTPUT:
  9918                                  COMND1_TYPE:
  9919 0000215B 00                      	db 0			; type
  9920                                  COMND1_CODE:
  9921 0000215C 00                      	db 0			; return value
  9922                                  COMND1_SYN:
  9923 0000215D 0000                    	dw 0			; synonym pointer
  9924                                  COMND1_ADDR:
  9925 0000215F 00000000                	dd 0			; numeric value / address
  9926                                  				; of string value
  9927                                  NO_VAL:
  9928 00002163 00                      	db 0			; no values
  9929                                  num_positionals:
  9930 00002164 0000                    	dw 0			; counter for positionals
  9931                                  old_parse_ptr:
  9932 00002166 0000                    	dw 0			; SI position before calling parser
  9933                                  
  9934                                  	; 30/01/2023
  9935                                  ;***	INITIALIZATION MESSAGES
  9936                                  ;	-------------------------
  9937                                  ;	include	comimsg.inc	;M00
  9938                                  ;-----------------------------------------------------------------------------	
  9939                                  
  9940                                  BADVERMSG:
  9941 00002168 17                      	db 23
  9942 00002169 496E636F7272656374-     	db 'Incorrect DOS version',0Dh,0Ah
  9942 00002172 20444F532076657273-
  9942 0000217B 696F6E0D0A         
  9943                                  OUTENVMSG:
  9944 00002180 1A                      	db 26
  9945 00002181 4F7574206F6620656E-     	db 'Out of environment space',0Dh,0Ah
  9945 0000218A 7669726F6E6D656E74-
  9945 00002193 2073706163650D0A   
  9946                                  
  9947                                  ; 07/06/2023
  9948                                  ;COPYRIGHTMSG:
  9949                                  ;	db 94
  9950                                  ;	db 0Dh,0Ah
  9951                                  ;	db 0Dh,0Ah
  9952                                  ;	db 'Microsoft(R) MS-DOS(R) Version 5.00',0Dh,0Ah
  9953                                  ;	db '             (C)Copyright Microsoft Corp 1981-1991.',0Dh,0Ah
  9954                                  
  9955                                  ; 23/07/2024
  9956                                  %if 0
  9957                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
  9958                                  ; MSDOS 6.22 COMMAND.COM - RESGROUP:2286h
  9959                                  COPYRIGHTMSG:
  9960                                  	db 94
  9961                                  	db 0Dh,0Ah
  9962                                  	db 0Dh,0Ah
  9963                                  	db 'Microsoft(R) MS-DOS(R) Version 6.22',0Dh,0Ah
  9964                                  	db '             (C)Copyright Microsoft Corp 1981-1994.',0Dh,0Ah
  9965                                  %else
  9966                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
  9967                                  ; PCDOS 7.1 COMMAND.COM - RESGROUP:2385h
  9968                                  COPYRIGHTMSG:
  9969 0000219B 64                      	db 100
  9970 0000219C 0D0A                    	db 0Dh,0Ah
  9971 0000219E 0D0A                    	db 0Dh,0Ah
  9972 000021A0 504320444F53205665-     	db 'PC DOS Version 7.10',0Dh,0Ah
  9972 000021A9 7273696F6E20372E31-
  9972 000021B2 300D0A             
  9973 000021B5 202020202020202020-     	db '             (C)Copyright International Business Machines Corp '
  9973 000021BE 20202020284329436F-
  9973 000021C7 707972696768742049-
  9973 000021D0 6E7465726E6174696F-
  9973 000021D9 6E616C20427573696E-
  9973 000021E2 657373204D61636869-
  9973 000021EB 6E657320436F727020 
  9974 000021F4 313938312D32303032-     	db '1981-2002.',0Dh,0Ah
  9974 000021FD 2E0D0A             
  9975                                  %endif
  9976                                  
  9977                                  BADCOMLKMES:
  9978 00002200 28                      	db 40
  9979 00002201 537065636966696564-     	db 'Specified COMMAND search directory bad',0Dh,0Ah
  9979 0000220A 20434F4D4D414E4420-
  9979 00002213 736561726368206469-
  9979 0000221C 726563746F72792062-
  9979 00002225 61640D0A           
  9980                                  	; 07/06/2023
  9981                                  BADCOMACCMSG:
  9982 00002229 37                      	db 55
  9983 0000222A 537065636966696564-     	db 'Specified COMMAND search directory bad, access denied',0Dh,0Ah
  9983 00002233 20434F4D4D414E4420-
  9983 0000223C 736561726368206469-
  9983 00002245 726563746F72792062-
  9983 0000224E 61642C206163636573-
  9983 00002257 732064656E6965640D-
  9983 00002260 0A                 
  9984                                  HELPMSG1:
  9985 00002261 38                      	db 56
  9986                                  	;db 'Starts a new copy of the MS-DOS command interpreter.',0Dh,0Ah
  9987                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
  9988 00002262 537461727473206120-     	db 'Starts a new copy of the PC DOS command interpreter.',0Dh,0Ah
  9988 0000226B 6E657720636F707920-
  9988 00002274 6F6620746865205043-
  9988 0000227D 20444F5320636F6D6D-
  9988 00002286 616E6420696E746572-
  9988 0000228F 7072657465722E0D0A 
  9989 00002298 0D0A                    	db 0Dh,0Ah
  9990                                  ;HELPMSG2:
  9991                                  ;	db 70
  9992                                  ;	db 'COMMAND [[drive:]path] [device] [/E:nnnnn] [/P] [/C string] [/MSG]'
  9993                                  ;	db 0Dh,0Ah
  9994                                  ;	db 0Dh,0Ah
  9995                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
  9996                                  HELPMSG2:
  9997 0000229A 38                      	db 56
  9998 0000229B 434F4D4D414E44205B-     	db 'COMMAND [[drive:]path] [device] [/E:nnnnn] [/P [/MSG]]',0Dh,0Ah
  9998 000022A4 5B64726976653A5D70-
  9998 000022AD 6174685D205B646576-
  9998 000022B6 6963655D205B2F453A-
  9998 000022BF 6E6E6E6E6E5D205B2F-
  9998 000022C8 50205B2F4D53475D5D-
  9998 000022D1 0D0A               
  9999                                  HELPMSG3:
 10000                                  	;db 42
 10001                                  	;db '        [/Y [/C command | /K command]]',0Dh,0Ah
 10002                                  	;db 0Dh,0Ah
 10003                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 10004 000022D3 34                      	db 52
 10005 000022D4 20202020202020205B-     	db '        [/H] [/O] [/Y [/C command | /K command]]',0Dh,0Ah
 10005 000022DD 2F485D205B2F4F5D20-
 10005 000022E6 5B2F59205B2F432063-
 10005 000022EF 6F6D6D616E64207C20-
 10005 000022F8 2F4B20636F6D6D616E-
 10005 00002301 645D5D0D0A         
 10006 00002306 0D0A                    	db 0Dh,0Ah
 10007                                  ;HELPMSG3:
 10008                                  HELPMSG4:
 10009 00002308 48                              db 72
 10010 00002309 20205B64726976653A-     	db '  [drive:]path    Specifies the directory containing COMMAND.COM '
 10010 00002312 5D7061746820202020-
 10010 0000231B 537065636966696573-
 10010 00002324 207468652064697265-
 10010 0000232D 63746F727920636F6E-
 10010 00002336 7461696E696E672043-
 10010 0000233F 4F4D4D414E442E434F-
 10010 00002348 4D20               
 10011 0000234A 66696C652E0D0A          	db 'file.',0Dh,0Ah
 10012                                  ;HELPMSG4:
 10013                                  HELPMSG5:
 10014 00002351 4D                      	db 77
 10015 00002352 202064657669636520-     	db '  device          Specifies the device to use for command input and '
 10015 0000235B 202020202020202020-
 10015 00002364 537065636966696573-
 10015 0000236D 207468652064657669-
 10015 00002376 636520746F20757365-
 10015 0000237F 20666F7220636F6D6D-
 10015 00002388 616E6420696E707574-
 10015 00002391 20616E6420         
 10016 00002396 6F75747075742E0D0A      	db 'output.',0Dh,0Ah
 10017                                  ;HELPMSG5:
 10018                                  HELPMSG6:
 10019 0000239F 45                      	db 69
 10020 000023A0 20202F453A6E6E6E6E-     	db '  /E:nnnnn        Sets the initial environment size to nnnnn bytes.'
 10020 000023A9 6E2020202020202020-
 10020 000023B2 536574732074686520-
 10020 000023BB 696E697469616C2065-
 10020 000023C4 6E7669726F6E6D656E-
 10020 000023CD 742073697A6520746F-
 10020 000023D6 206E6E6E6E6E206279-
 10020 000023DF 7465732E           
 10021 000023E3 0D0A                    	db 0Dh,0Ah
 10022                                  ;HELPMSG6:
 10023                                  HELPMSG7:
 10024 000023E5 4D                      	db 77
 10025 000023E6 20202F502020202020-     	db '  /P              Makes the new Command Interpreter permanent '
 10025 000023EF 202020202020202020-
 10025 000023F8 4D616B657320746865-
 10025 00002401 206E657720436F6D6D-
 10025 0000240A 616E6420496E746572-
 10025 00002413 707265746572207065-
 10025 0000241C 726D616E656E7420   
 10026 00002424 2863616E2774206578-     	db '(can',27h,'t exit).',0Dh,0Ah
 10026 0000242D 6974292E0D0A       
 10027                                  ;HELPMSG7:
 10028                                  HELPMSG8:
 10029                                  	;db 80
 10030                                  	;db '  /C string       Carries out the command specified by string, and '
 10031                                  	;db 'then stops.',0Dh,0Ah
 10032                                  	; 07/06/2023
 10033 00002433 46                      	db 70
 10034 00002434 20202F4D5347202020-     	db '  /MSG            Stores all error messages in memory (requires /P).'
 10034 0000243D 202020202020202020-
 10034 00002446 53746F72657320616C-
 10034 0000244F 6C206572726F72206D-
 10034 00002458 657373616765732069-
 10034 00002461 6E206D656D6F727920-
 10034 0000246A 287265717569726573-
 10034 00002473 202F50292E         
 10035 00002478 0D0A                    	db 0Dh,0Ah
 10036                                  
 10037                                  ; 23/07/2024 - Retro DOS v5.0 COMMAND.COM
 10038                                  ; PCDOS 7.1 COMMAND.COM
 10039                                  ;***
 10040                                  HELPMSG9:
 10041 0000247A 4A                      	db 74
 10042 0000247B 20202F482020202020-     	db '  /H              Loads the Command Interpreter into a UMB '
 10042 00002484 202020202020202020-
 10042 0000248D 4C6F61647320746865-
 10042 00002496 20436F6D6D616E6420-
 10042 0000249F 496E74657270726574-
 10042 000024A8 657220696E746F2061-
 10042 000024B1 20554D4220         
 10043 000024B6 696620617661696C61-     	db 'if available.',0Dh,0Ah
 10043 000024BF 626C652E0D0A       
 10044                                  HELPMSG10:
 10045 000024C5 4E                      	db 78
 10046 000024C6 20202F4F2020202020-     	db '  /O              Disables overwrite prompt on COPY,XCOPY,and MOVE '
 10046 000024CF 202020202020202020-
 10046 000024D8 44697361626C657320-
 10046 000024E1 6F7665727772697465-
 10046 000024EA 2070726F6D7074206F-
 10046 000024F3 6E20434F50592C5843-
 10046 000024FC 4F50592C616E64204D-
 10046 00002505 4F564520           
 10047 00002509 636F6D6D616E64732E-     	db 'commands.',0Dh,0Ah
 10047 00002512 0D0A               
 10048                                  ;***
 10049                                  
 10050                                  ;HELPMSG8:
 10051                                  ; 23/07/2024 - PCDOS 7.1 COMMAND.COM
 10052                                  ;HELPMSG9:
 10053                                  HELPMSG11:
 10054                                  	;db 78
 10055                                  	;db '  /MSG            Specifies that all error messages be stored in '
 10056                                  	;db 'memory. You',0Dh,0Ah
 10057                                  ;HELPMSG9:
 10058                                  	;db 56
 10059                                  	;db '                  need to specify /P with this switch.',0Dh,0Ah
 10060 00002514 4A                      	db 74
 10061 00002515 20202F592020202020-     	db '  /Y              Steps through the batch program specified by /C'
 10061 0000251E 202020202020202020-
 10061 00002527 537465707320746872-
 10061 00002530 6F7567682074686520-
 10061 00002539 62617463682070726F-
 10061 00002542 6772616D2073706563-
 10061 0000254B 696669656420627920-
 10061 00002554 2F43               
 10062 00002556 206F72202F4B2E0D0A      	db ' or /K.',0Dh,0Ah
 10063                                  
 10064                                  	; 07/06/2023
 10065                                  ; 23/07/2024
 10066                                  ;HELPMSG10:
 10067                                  HELPMSG12:
 10068 0000255F 3F                      	db 63
 10069 00002560 20202F4320636F6D6D-     	db '  /C command      Executes the specified command and returns.',0Dh,0Ah
 10069 00002569 616E64202020202020-
 10069 00002572 457865637574657320-
 10069 0000257B 746865207370656369-
 10069 00002584 6669656420636F6D6D-
 10069 0000258D 616E6420616E642072-
 10069 00002596 657475726E732E0D0A 
 10070                                  ; 23/07/2024
 10071                                  ;HELPMSG11:
 10072                                  HELPMSG13:
 10073 0000259F 4B                      	db 75
 10074 000025A0 20202F4B20636F6D6D-     	db '  /K command      Executes the specified command and continues running.'
 10074 000025A9 616E64202020202020-
 10074 000025B2 457865637574657320-
 10074 000025BB 746865207370656369-
 10074 000025C4 6669656420636F6D6D-
 10074 000025CD 616E6420616E642063-
 10074 000025D6 6F6E74696E75657320-
 10074 000025DF 72756E6E696E672E   
 10075 000025E7 0D0A                    	db 0Dh,0Ah
 10076 000025E9 0D0A                    	db 0Dh,0Ah
 10077                                  ;HELPMSG12:
 10078                                  ; 23/07/2024
 10079                                  HELPMSG14:
 10080 000025EB 4C                      	db 76
 10081 000025EC 546865202F5020616E-     	db 'The /P and /MSG switches may be used only when COMMAND is started'
 10081 000025F5 64202F4D5347207377-
 10081 000025FE 697463686573206D61-
 10081 00002607 792062652075736564-
 10081 00002610 206F6E6C7920776865-
 10081 00002619 6E20434F4D4D414E44-
 10081 00002622 206973207374617274-
 10081 0000262B 6564               
 10082 0000262D 206279207573696E67-     	db ' by using',0Dh,0Ah
 10082 00002636 0D0A               
 10083                                  ;HELPMSG13:
 10084                                  ; 23/07/2024
 10085                                  HELPMSG15:
 10086 00002638 2B                      	db 43
 10087 00002639 746865205348454C4C-     	db 'the SHELL command in the CONFIG.SYS file.',0Dh,0Ah
 10087 00002642 20636F6D6D616E6420-
 10087 0000264B 696E2074686520434F-
 10087 00002654 4E4649472E53595320-
 10087 0000265D 66696C652E0D0A     
 10088                                  
 10089                                  HelpMsgs:
 10090 00002664 [6122]                          dw HELPMSG1
 10091 00002666 [9A22]                  	dw HELPMSG2
 10092 00002668 [D322]                  	dw HELPMSG3
 10093 0000266A [0823]                  	dw HELPMSG4
 10094 0000266C [5123]                  	dw HELPMSG5
 10095 0000266E [9F23]                  	dw HELPMSG6
 10096 00002670 [E523]                  	dw HELPMSG7
 10097 00002672 [3324]                  	dw HELPMSG8
 10098 00002674 [7A24]                  	dw HELPMSG9
 10099                                  
 10100                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 10101 00002676 [C524]                  	dw HELPMSG10
 10102 00002678 [1425]                  	dw HELPMSG11
 10103 0000267A [5F25]                  	dw HELPMSG12
 10104 0000267C [9F25]                  	dw HELPMSG13
 10105                                  
 10106                                  	; 23/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 10107 0000267E [EB25]                  	dw HELPMSG14
 10108 00002680 [3826]                  	dw HELPMSG15
 10109                                  
 10110                                  	; 23/04/2023
 10111 00002682 0000                    	dw 0
 10112                                  
 10113                                  ;-----------------------------------------------------------------------------
 10114                                  
 10115                                  ;SR;
 10116                                  ; This table of offsets is used by the init code to calculate the new offsets
 10117                                  ;for these labels after the resident code has been relocated
 10118                                  
 10119                                  ;Reloc_Table:
 10120                                  	;dw offset CODERES:MsgInt2fHandler
 10121                                  	;dw offset CODERES:Int_2e
 10122                                  	;dw offset CODERES:ContC
 10123                                  	;dw offset CODERES:DskErr
 10124                                  	;dw offset CODERES:Exec_Ret
 10125                                  	;dw offset CODERES:TRemCheck
 10126                                  	;dw offset CODERES:TrnLodCom1
 10127                                  	;dw offset CODERES:LodCom
 10128                                  	;dw offset CODERES:MsgRetriever
 10129                                  	;dw offset CODERES:THeadFix
 10130                                  	;dw offset CODERES:Lh_OffUnlink	; M003
 10131                                  
 10132                                  	; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10133                                  	; MSDOS 5.0 COMMAND.COM - RESGROUP:22F6h
 10134                                  
 10135                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10136                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:26C1h
 10137                                  
 10138                                  Reloc_Table:	; 23/07/2024 ; PCDOS 7.1 COMMAND.COM CODERES addresses
 10139 00002684 9007                    	dw MsgInt2fHandler - RCODE_START  ; 7B2h (RESGROUP:7B2h+X) *
 10140 00002686 7601                    	dw Int_2e - RCODE_START		  ; 170h (RESGROUP:170h+X) *	
 10141 00002688 3300                    	dw ContC - RCODE_START		  ; 02Eh (RESGROUP:02Eh+X) *
 10142 0000268A 7B04                    	dw DSKERR - RCODE_START		  ; 495h (RESGROUP:495h+X) *
 10143 0000268C 2700                    	dw Exec_Ret - RCODE_START	  ; 022h (RESGROUP:022h+X) *
 10144 0000268E A402                    	dw TRemCheck - RCODE_START	  ; 2A6h (RESGROUP:2A6h+X) *
 10145 00002690 4604                    	dw TrnLodCom1 - RCODE_START	  ; 472h (RESGROUP:472h+X) *
 10146 00002692 AD01                    	dw LodCom - RCODE_START		  ; 1A7h (RESGROUP:1A7h+X) *
 10147 00002694 D307                    	dw MsgRetriever - RCODE_START	  ; 7F5h (RESGROUP:7F5h+X) *
 10148 00002696 C302                    	dw THeadFix - RCODE_START	  ; 2C5h (RESGROUP:2C5h+X) *
 10149 00002698 4C08                    	dw Lh_OffUnlink - RCODE_START	  ; 86Eh (RESGROUP:86Eh+X) *
 10150                                  
 10151                                  	; MSDOS 6.22 COMMAND.COM Reloc_Table CODERES addresses:
 10152                                  	; 738h,177h,035h,445h,029h,2A3h,422h,1AEh,77Bh,2C2h,7F4h
 10153                                  
 10154                                  	; 07/06/2023
 10155                                  	; X = 0D40h for MSDOS 5.0 COMMAND.COM
 10156                                  	; X = 0E50h for MSDOS 6.22 COMMAND.COM
 10157                                  	; 23/07/2024
 10158                                  	; X = 0E10h for PCDOS 7.1 COMMAND.COM
 10159                                  	;; example:
 10160                                  	;;	MsgIn2FHandler is at RESGROUP:15C2h or at CODERES:07B2h
 10161                                  	;;				(in PCDOS 7.1 COMMAND.COM)
 10162                                  
 10163                                  NUM_RELOC_ENTRIES equ ($-Reloc_Table)/2
 10164                                  
 10165                                  ResJmpTable:
 10166 0000269A 00000000                	dd 0			; stores prev stub jump table addr
 10167                                  FirstCom:
 10168 0000269E 00                      	db 0			; flag set if first command.com
 10169                                  DevFlag:
 10170 0000269F 00                      	db 0
 10171                                  PathFlag:
 10172 000026A0 00                      	db 0
 10173                                  
 10174                                  	;; MSDOS 5.0 COMMAND.COM - RESGROUP:2313h
 10175                                  	;;times 13 db 0
 10176                                  
 10177                                  	; 07/06/2023
 10178                                  	; MSDOS 6.22 COMMAND.COM - RESGROUP:26DEh
 10179                                  	;times 2 db 0
 10180                                  
 10181                                  ; 30/01/2023
 10182                                  coderes_end equ $
 10183                                  
 10184                                  ;INIT	ENDS
 10185                                  
 10186                                  ;	END
 10187                                  
 10188                                  ;-----------------------------------------------------------------------------
 10189                                  ; 14/10/2018 (Retro DOS v3.0 COMMAND.COM Signature)
 10190                                  ;-----------------------------------------------------------------------------
 10191                                  
 10192                                  ;db	"Retro DOS v3.0 COMMAND.COM by Erdogan Tan [2018]"
 10193                                  	; 30/01/2023
 10194 000026A1 00                      db	0
 10195                                  ;db	"Retro DOS v4.0 COMMAND.COM by Erdogan Tan [2023]"		
 10196                                  	; 07/06/2023
 10197                                  ;db	"Retro DOS v4.2 COMMAND.COM by Erdogan Tan [2023]"
 10198                                  	; 21/07/2024
 10199 000026A2 526574726F20444F53-     db	"Retro DOS v5.0 COMMAND.COM by Erdogan Tan [2024]"
 10199 000026AB 2076352E3020434F4D-
 10199 000026B4 4D414E442E434F4D20-
 10199 000026BD 6279204572646F6761-
 10199 000026C6 6E2054616E205B3230-
 10199 000026CF 32345D             
 10200 000026D2 00                      db	0
 10201                                  
 10202                                  ;-----------------------------------------------------------------------------
 10203                                  ; 24/09/2018 (Retro DOS v3.0 COMMAND)
 10204                                  ;-----------------------------------------------------------------------------
 10205                                  
 10206                                  ;TAIL    SEGMENT PUBLIC PARA
 10207                                  ;        ORG     0
 10208                                  ;TRANSTART LABEL WORD
 10209                                  ;TAIL    ENDS
 10210                                  
 10211                                  ;ALIGN 16  ; 25/09/2018
 10212                                  
 10213                                  ; 30/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10214                                  
 10215                                  numbertodiv equ ($-StartCode)+100h ; 16/04/2023
 10216                                  numbertomod equ (numbertodiv % 16)
 10217                                  
 10218                                  %if numbertomod>0 & numbertomod<16
 10219 000026D3 00<rep Dh>              	times (16-numbertomod) db 0
 10220                                  %endif
 10221                                  
 10222                                  ; 30/01/2023
 10223                                  ;TRANSTART:
 10224                                  
 10225                                  ; 21/04/2018 (Retro DOS v2.0 COMMAND)
 10226                                  ;	times	128 db 0	
 10227                                  
 10228                                  ;-----------------------------------------------------------------------------
 10229                                  ; SEGMENT - TRANSCODE
 10230                                  ;-----------------------------------------------------------------------------
 10231                                  
 10232                                  ;TRANGROUP: ; 21/04/2018
 10233                                  
 10234                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10235                                  ;-----------------------------------------------------------------------------
 10236                                  
 10237                                  ; MSDOS 3.3 COMMAND.COM Transient Portion Addresses
 10238                                  
 10239                                  ; 21/04/2018 - Retro DOS v2.0
 10240                                  ; transcom.s (COMMAND.COM source file 2 of 2) code/data addresses 
 10241                                  ; (these values must be changed when transcom.s source code is changed
 10242                                  ; and data offsets are changed)
 10243                                  ;
 10244                                  ; 30/04/2018
 10245                                  ; 29/04/2018
 10246                                  
 10247                                  ; 24/09/2018 (original MSDOS 3.3 COMMAND.COM TrnSeg offset addresses)
 10248                                  ;COMMAND      EQU  012CH
 10249                                  ;DATINIT      EQU  2091H
 10250                                  ;HEADCALL     EQU  428FH
 10251                                  ;TRANSPACEEND EQU  4D5CH
 10252                                  ;TRANDATAEND  EQU  3F44H
 10253                                  
 10254                                  ; 29/04/2018 (original MSDOS 3.3 COMMAND.COM TrnSeg offset addresses)
 10255                                  ;TRIAGE_INIT  EQU  1F15H
 10256                                  ;PRINTF_INIT  EQU  34E0H 
 10257                                  
 10258                                  ;GETEXTERRNUM EQU  1EEEH  ; TRIAGEERROR (GET_EXT_ERR_NUMBER) proc addr	
 10259                                  
 10260                                  ;TPA	EQU  4293H
 10261                                  ;TRNLEN	EQU  04D6H
 10262                                  
 10263                                  ; 20/10/2018 - Retro DOS v3.0 COMMAND.COM transient portion addresses
 10264                                  ;COMMAND      EQU  012CH
 10265                                  ;DATINIT      EQU  206FH
 10266                                  ;HEADCALL     EQU  426FH
 10267                                  ; 09/01/2023
 10268                                  ;TRANSPACEEND EQU  4D3CH
 10269                                  ;TRANDATAEND  EQU  3F24H
 10270                                  ;TRIAGE_INIT  EQU  1EF3H
 10271                                  ;PRINTF_INIT  EQU  34BFH 
 10272                                  ;
 10273                                  ;GETEXTERRNUM EQU  1ECCH  ; TRIAGEERROR (GET_EXT_ERR_NUMBER) proc addr
 10274                                  
 10275                                  ;-----------------------------------------------------------------------------
 10276                                  ; ARENA.INC, MSDOS 6.0, 1991
 10277                                  ;-----------------------------------------------------------------------------
 10278                                  ; 13/10/2018 - Retro DOS 3.0
 10279                                  ; 17/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10280                                  
 10281                                  ;BREAK <Memory arena structure>
 10282                                  
 10283                                  ; (-*-) Same with MSDOS 2.11 & MSDOS 6.0
 10284                                  
 10285                                  ; arena item
 10286                                  
 10287                                  struc ARENA
 10288 00000000 ??                        .signature:	resb 1		; 4D for valid item, 5A for last item
 10289 00000001 ????                      .owner:	resw 1		; owner of arena item
 10290 00000003 ????                      .size:	resw 1		; size in paragraphs of item
 10291                                  endstruc
 10292                                  
 10293                                  ;-----------------------------------------------------------------------------
 10294                                  ;START OF TRANSIENT PORTION
 10295                                  ;This code is loaded at the end of memory and may be overwritten by
 10296                                  ;memory-intensive user programs.
 10297                                  ;-----------------------------------------------------------------------------
 10298                                  
 10299                                  ; 16/04/2023
 10300                                  TRANSTART EQU ($-StartCode)+100h ; 18/04/2023
 10301                                  ; 29/09/2018
 10302                                  ; 31/01/2023 
 10303                                  ;TRANSTART:	; Offset 1660h in original MSDOS 3.3 COMMAND.COM
 10304                                  			
 10305                                  		; 09/01/2023
 10306                                  		; Offset 2320h in original MSDOS 5.0 COMMAND.COM
 10307                                  			
 10308                                  		; 07/06/2023
 10309                                  		; Offset 26E0h in original MSDOS 6.22 COMMAND.COM
 10310                                  
 10311                                  ; 25/09/2018
 10312                                  ; (original MSDOS 3.3 COMMAND.COM TRIAGEERROR offset address)
 10313                                  ;
 10314                                  ; 'GET_EXT_ERR_NUMBER' ('TRIAGEERROR') procedure is at offset 354Eh 
 10315                                  ; in MSDOS 3.3 COMMAND.COM (It is at offset 1EEEh in transient porsion).	 	
 10316                                  ;
 10317                                  ;TRIAGEERROR EQU TRANSTART+GETEXTERRNUM-100H
 10318                                  ;
 10319                                  ;
 10320                                  ;COMTRANS:
 10321                                  ;
 10322                                  ; 20/10/2018 - Retro DOS v3.0	
 10323                                  ;INCBIN	"TRANCOM3.BIN"
 10324                                  ;
 10325                                  ;COMLEN	EQU $-COMTRANS ; End of COMMAND load.
 10326                                  ;
 10327                                  ; 29/04/2018
 10328                                  ;BSS_SIZE EQU TRANSPACEEND-TRANDATAEND	
 10329                                  ;
 10330                                  ;TIMES BSS_SIZE db 0
 10331                                  ;
 10332                                  ;COMLEN	EQU $-COMTRANS ; 30/04/2018
 10333                                  
 10334                                  ;COMMANDCOMSIZE equ $ - 100h
 10335                                  
 10336                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10337                                  ; ============================================================================
 10338                                  ; --- ('trancom5.s', 31/01/2023 - modified from 'trancom3.s', 20/10/2018) ----
 10339                                  ; ============================================================================
 10340                                  
 10341                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM (MSDOS 6.22 COMMAND.COM)
 10342                                  
 10343                                  ; ----------------------------------------------------------------------------
 10344                                  ; START OF TRANSIENT PORTION
 10345                                  ; ----------------------------------------------------------------------------
 10346                                  ; SEGMENT - TRANSCODE
 10347                                  ; ----------------------------------------------------------------------------
 10348                                  
 10349                                  ; 18/04/2023
 10350                                  section .TRANGROUP  vstart=0  ; 31/01/2023 - Retro DOS v4.0 (& v4.1) 
 10351                                  
 10352                                  ; 18/04/2023
 10353                                  ;-----------------------------------------------------------------------------
 10354                                  ; TRANSCODE segment offset 0
 10355                                  TRANSIENTSTART:
 10356                                  
 10357                                  	; 31/01/2023
 10358 00000000 00<rep 100h>            	times 256 db 0		; Allow for 100H parameter area
 10359                                  
 10360                                  ;============================================================================
 10361                                  ; TCODE.ASM, MSDOS 6.0, 1991
 10362                                  ;============================================================================
 10363                                  ; 12/10/2018 - Retro DOS v3.0
 10364                                  ; 31/01/2023 - Retro DOS v4.0 (& v4.1)
 10365                                  
 10366                                  ;[ORG 100h]
 10367                                  
 10368                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0100h
 10369                                  
 10370                                  ; ---------------------------------------------------------------------------
 10371                                  		
 10372                                  	; 31/01/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10373                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:0100h)
 10374                                  
 10375                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10376                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:0100h)
 10377                                  SETDRV:
 10378 00000100 B40E                    	mov	ah,0Eh
 10379                                  	;mov	ah,SET_DEFAULT_DRIVE ; 0Eh
 10380 00000102 CD21                    	int	21h	; DOS -	SELECT DISK
 10381                                  			; DL = new default drive number
 10382                                  			;		(0 = A, 1 = B, ..)
 10383                                  			; Return: AL = number of logical drives
 10384                                  
 10385                                  ; ---------------------------------------------------------------------------
 10386                                  
 10387                                  ; TCOMMAND is the recycle point in COMMAND. Nothing is known here.
 10388                                  ; No registers (CS:IP) no flags, nothing.
 10389                                  
 10390                                  TCOMMAND:
 10391                                  ; 21/07/2024 - PCDOS 7.1 COMMAND.COM - TRANGROUP:0104h
 10392                                  ; Retro DOS v5.0 COMMAND.COM
 10393                                  %if 1
 10394 00000104 90                      	nop
 10395 00000105 90                      	nop
 10396                                  %endif
 10397 00000106 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 10398 0000010B B8FFFF                  	mov	ax,-1
 10399 0000010E 8706[A702]              	xchg	ax,[VerVal]
 10400 00000112 83F8FF                  	cmp	ax,-1
 10401 00000115 7404                    	je	short NOSETVER2
 10402 00000117 B42E                    	mov	ah,2Eh
 10403                                  	;mov	ah,SET_VERIFY_ON_WRITE ; 2Eh
 10404 00000119 CD21                    	int	21h	; DOS -	SET VERIFY FLAG
 10405                                  			; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 10406                                  NOSETVER2:
 10407 0000011B 2EFF1E[519C]            	call	far [cs:HEADCALL]   ; Make sure header fixed
 10408 00000120 31ED                    	xor	bp,bp		    ; Flag transient not read
 10409 00000122 833E[A502]FF            	cmp	word [SingleCom],-1
 10410 00000127 7505                    	jne	short COMMAND
 10411                                  _$EXITPREP:
 10412 00000129 0E                      	push	cs
 10413 0000012A 1F                      	pop	ds
 10414 0000012B E9CD23                  	jmp	_$EXIT		; Have finished the single command
 10415                                  
 10416                                  ; ---------------------------------------------------------------------------
 10417                                  ;
 10418                                  ; Main entry point from resident portion.
 10419                                  ;
 10420                                  ;   If BP <> 0, then we have just loaded transient portion otherwise we are
 10421                                  ;   just beginning the processing of another command.
 10422                                  ;
 10423                                  ; ---------------------------------------------------------------------------
 10424                                  
 10425                                  ; We are not always sure of the state of the world at this time. We presume
 10426                                  ; worst case and initialize the relevant registers: segments and stack.
 10427                                  
 10428                                  COMMAND:
 10429 0000012E FC                      	cld
 10430 0000012F 8CC8                    	mov	ax,cs
 10431 00000131 FA                      	cli
 10432 00000132 8ED0                    	mov	ss,ax
 10433                                  	;mov	sp,offset TRANGROUP:STACK
 10434                                  				; 07/06/2023
 10435 00000134 BC[FEA5]                	mov	sp,STACK	; 0AF24h for MSDOS 6.22 COMMAND.COM
 10436                                  				; 09854h for MSDOS 5.0 COMMAND.COM
 10437                                  				; 25/07/2024
 10438                                  				; 0AA2Dh for PCDOS 7.1 COMMAND.COM
 10439 00000137 FB                      	sti
 10440                                  		
 10441 00000138 8EC0                    	mov	es,ax
 10442                                  		
 10443                                  	; MSDOS 6.0
 10444 0000013A 8ED8                    	mov	ds,ax		;AN000; set DS to transient
 10445                                  	;ASSUME	ES:TRANGROUP,DS:TRANGROUP ;AC000;
 10446                                  	;invoke	TSYSLOADMSG	;AN000; preload messages
 10447                                  	; 31/01/2023
 10448 0000013C E8BD53                  	call	TSYSLOADMSG
 10449 0000013F C606[959F]00            	mov	byte [append_exec],0 ;AN041; set internal append state off
 10450                                  
 10451                                  	; MSDOS 3.3 (& MSDOS 6.0)
 10452                                  	;mov	ds,[ss:RESSEG]
 10453                                  	; 31/01/2023
 10454 00000144 8E1E[539C]              	mov	ds,[RESSEG]
 10455 00000148 36C606[2F9A]80          	mov	byte [ss:UCOMBUF],128 ; Init UCOMBUF	
 10456 0000014E 36C606[B29A]80          	mov	byte [ss:COMBUF],128  ; Init COMBUF (Autoexec doing DATE)
 10457                                  
 10458                                  ; If we have just loaded the transient, then we do NOT need to initialize the
 10459                                  ; command buffer. ????  DO WE NEED TO RESTORE THE USERS DIRECTORY ????
 10460                                  ; I guess not: the only circumstances in which we reload the command processor
 10461                                  ; is after a transient program execution. In this case, we let the current
 10462                                  ; directory lie where it may.
 10463                                  
 10464 00000154 09ED                    	or	bp,bp		; See if just read
 10465 00000156 7409                    	jz	short TESTRDIR	; Not read, check user directory
 10466 00000158 36C706[309A]010D        	mov	word [ss:UCOMBUF+1],0D01h ; Reset buffer
 10467 0000015F EB17                    	jmp	short NOSETBUF
 10468                                  TESTRDIR:
 10469 00000161 803E[A102]00            	cmp	byte [RestDir],0
 10470 00000166 7410                    	jz	short NOSETBUF	; User directory OK
 10471 00000168 1E                      	push	ds
 10472                                  
 10473                                  ; We have an unusual situation to handle. The user *may* have changed his
 10474                                  ; directory as a result of an internal command that got aborted. Restoring it
 10475                                  ; twice may not help us: the problem may never go away. We just attempt it
 10476                                  ; once and give up.
 10477                                  
 10478 00000169 C606[A102]00            	mov	byte [RestDir],0 ; Flag users dirs OK
 10479                                  
 10480                                  	; Restore users directory
 10481 0000016E 0E                      	push	cs
 10482 0000016F 1F                      	pop	ds
 10483 00000170 BA[359B]                	mov	dx,USERDIR1
 10484 00000173 B43B                    	mov	ah,3Bh
 10485                                  	;mov	ah,CHDir ; 3Bh
 10486 00000175 CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 10487                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 10488 00000177 1F                      	pop	ds
 10489                                  NOSETBUF:
 10490 00000178 803E[1403]00            	cmp	byte [PipeFiles],0
 10491 0000017D 740A                    	jz	short NOPCLOSE	; Don't bother if they don't exist
 10492 0000017F 803E[1303]00            	cmp	byte [PipeFlag],0
 10493 00000184 7503                    	jnz	short NOPCLOSE	; Don't del if still piping
 10494 00000186 E8952F                  	call	PIPEDEL
 10495                                  NOPCLOSE:
 10496                                  	;mov	byte [0BE9h],0	; MSDOS 3.3
 10497                                  	; 31/01/2023
 10498 00000189 C606[9902]00            	mov	byte [ExtCom],0 ; Flag internal command
 10499 0000018E 8CC8                    	mov	ax,cs		; Get segment we're in
 10500 00000190 8ED8                    	mov	ds,ax
 10501 00000192 50                      	push	ax
 10502                                  			; 07/06/2023 (INTERNATVARS addr = STACK addr)
 10503 00000193 BA[FEA5]                	mov	dx,INTERNATVARS ; 0AF24h for MSDOS 6.22 COMMAND.COM
 10504                                  				; 09854h for MSDOS 5.0 COMMAND.COM
 10505                                  			; 25/07/2024
 10506                                  				; 0AA2Dh for PCDOS 7.1 COMMAND.COM
 10507 00000196 B80038                  	mov	ax,3800h
 10508                                  	;mov	ax,INTERNATIONAL*256 ; 3800h
 10509 00000199 CD21                    	int	21h	; DOS -	2+ - GET COUNTRY-DEPENDENT INFORMATION
 10510                                  			; get current-country info
 10511                                  			; DS:DX	-> buffer for returned info
 10512 0000019B 58                      	pop	ax
 10513 0000019C 2B06[559C]              	sub	ax,[TPA]	; AX=size of TPA in paragraphs
 10514 000001A0 53                      	push	bx
 10515 000001A1 BB1000                  	mov	bx,16
 10516 000001A4 F7E3                    	mul	bx		; DX:AX=size of TPA in bytes
 10517 000001A6 5B                      	pop	bx
 10518 000001A7 09D2                    	or	dx,dx		; See if over 64K
 10519 000001A9 7403                    	jz	short SAVSIZ	; OK if not
 10520 000001AB B8FFFF                  	mov	ax,-1		; If so, limit to 65535 bytes
 10521                                  SAVSIZ:
 10522                                  
 10523                                  ; AX is the number of bytes free in the buffer between the resident and the
 10524                                  ; transient with a maximum of 64K-1. We round this down to a multiple of 512.
 10525                                  
 10526 000001AE 3D0002                  	cmp	ax,512
 10527 000001B1 7603                    	jbe	short GOTSIZE
 10528                                  	;and	ax,~1FFh
 10529 000001B3 2500FE                  	and	ax,0FE00h	; NOT 511 = NOT 1FF
 10530                                  GOTSIZE:
 10531 000001B6 A3[749C]                	mov	[BYTCNT],ax	; Max no. of bytes that can be buffered
 10532 000001B9 8E1E[539C]              	mov	ds,[RESSEG]	; All batch work must use resident seg.
 10533                                  
 10534 000001BD F606[9D02]01            	test	byte [EchoFlag],1 
 10535 000001C2 741E                    	jz	short GETCOM	; Don't do the CRLF
 10536 000001C4 E8362F                  	call	SINGLETEST
 10537 000001C7 7219                    	jb	short GETCOM
 10538 000001C9 F606[1303]FF            	test	byte [PipeFlag],0FFh ; -1
 10539 000001CE 7512                    	jnz	short GETCOM
 10540                                  				; G  Don't print prompt in FOR
 10541 000001D0 F606[AB02]FF            	test	byte [ForFlag],0FFh ; -1
 10542 000001D5 750B                    	jnz	short GETCOM
 10543                                  				; G  Don't print prompt if in batch
 10544 000001D7 F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1
 10545 000001DD 7503                    	jnz	short GETCOM
 10546 000001DF E89527                  	call	CRLF2
 10547                                  
 10548                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10549                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:01E0h
 10550                                  GETCOM:
 10551 000001E2 833E[A502]00            	cmp     word [SingleCom],0
 10552 000001E7 750D                    	jnz     short GETCOM2
 10553 000001E9 F706[4902]FFFF          	test    word [Batch],0FFFFh
 10554 000001EF 7505                    	jnz     short GETCOM2
 10555 000001F1 8026[5A04]EF            	and     byte [Y_Flag],0EFh ; Y/N question overwrite flag ; ~10h
 10556                                  
 10557                                  ;GETCOM:	; MSDOS 5.0 COMMAND.COM
 10558                                  GETCOM2:
 10559 000001F6 C606[B002]00            	mov	byte [Call_Flag],0 ; G Reset call flags
 10560 000001FB C606[B102]00            	mov	byte [Call_Batch_Flag],0
 10561 00000200 B419                    	mov	ah,19h
 10562                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 10563 00000202 CD21                    	int	21h	; DOS -	GET DEFAULT DISK NUMBER
 10564 00000204 36A2[679C]              	mov	[ss:CURDRV],al
 10565 00000208 F606[1303]FF            	test	byte [PipeFlag],0FFh ; -1 ; Pipe has highest presedence
 10566 0000020D 7403                    	jz	short NOPIPE
 10567 0000020F E9DD2F                  	jmp	PIPEPROC	; Continue the pipeline
 10568                                  NOPIPE:
 10569 00000212 F606[9D02]01            	test	byte [EchoFlag],1
 10570 00000217 7417                    	jz	short NOPDRV	; No prompt if echo off
 10571 00000219 E8E12E                  	call	SINGLETEST
 10572 0000021C 7212                    	jb	short NOPDRV
 10573 0000021E F606[AB02]FF            	test	byte [ForFlag],0FFh ; G  Don't print prompt in FOR	
 10574 00000223 750B                    	jnz	short NOPDRV
 10575 00000225 F706[4902]FFFF          	test	word [Batch],0FFFFh ; G  Don't print prompt if in batch
 10576 0000022B 750D                    	jnz	short TESTFORBAT
 10577 0000022D E8BE1E                  	call	PRINT_PROMPT	; Prompt the user
 10578                                  NOPDRV:
 10579 00000230 F606[AB02]FF            	test	byte [ForFlag],0FFh ; FOR has next highest precedence
 10580 00000235 7403                    	jz	short TESTFORBAT
 10581 00000237 E9BD0C                  	jmp	FORPROC		; Continue the FOR
 10582                                  
 10583                                  TESTFORBAT:
 10584 0000023A 36C606[FE9B]00          	mov	byte [ss:RE_INSTR],0 ; Turn redirection back off	
 10585 00000240 C606[C202]00            	mov	byte [Re_OutStr],0  ; [0C09h] for MSDOS 3.3 
 10586 00000245 C606[C102]00            	mov	byte [Re_Out_App],0 ; [0C08h] for MSDOS 3.3
 10587 0000024A C606[AA02]00            	mov	byte [IfFlag],0	; no more ifs...
 10588 0000024F F706[4902]FFFF          	test	word [Batch],0FFFFh ; Batch has lowest precedence
 10589 00000255 7441                    	jz	short ISNOBAT
 10590                                  
 10591                                  	; 31/01/2023
 10592                                  
 10593                                  	; MSDOS 6.0
 10594                                  
 10595                                  ;	Bugbug:	MULT_SHELL_GET no longer used?
 10596                                  
 10597 00000257 06                      	push	es			;AN000; save ES
 10598 00000258 1E                      	push	ds			;AN000; save DS
 10599                                  	;mov	ax,mult_shell_get	;AN000; check to see if SHELL has command
 10600                                  	; 05/02/2023
 10601 00000259 B80219                  	mov	ax,1902h
 10602 0000025C 8E06[4902]              	mov	es,[Batch]		;AN000; get batch segment
 10603                                  	;mov	di,20h
 10604 00000260 BF2000                  	mov	di,BATCHSEGMENT.BatFile	;AN000; get batch file name
 10605 00000263 0E                      	push	cs			;AN000; get local segment to DS
 10606 00000264 1F                      	pop	ds			;AN000;
 10607                                  	;mov	dx,offset trangroup:combuf ;AN000; pass communications buffer
 10608 00000265 BA[B29A]                	mov	dx,COMBUF
 10609 00000268 CD2F                    	int	2Fh			;AN000; call the shell
 10610                                  		; - Multiplex - DOS 4.x only SHELLB.COM - COMMAND.COM INTERFACE
 10611                                  		; ES:DI -> ASCIZ full filename of current batch file, with at least the
 10612                                  		; final filename element uppercased
 10613                                  		; DS:DX -> buffer for results
 10614                                  	;cmp	al,0FFh
 10615 0000026A 3CFF                    	cmp	al,shell_action		;AN000; does shell have a commmand?
 10616 0000026C 1F                      	pop	ds			;AN000; restore DS
 10617 0000026D 07                      	pop	es			;AN000; restore ES
 10618 0000026E 7424                    	jz	short JDOCOM1		;AN000; yes - go process command
 10619                                  
 10620                                  	; MSDOS 3.3 (& MSDOS 6.0)
 10621 00000270 1E                      	push	ds
 10622 00000271 E80E04                  	call	READBAT			; Continue BATCH
 10623 00000274 1F                      	pop	ds
 10624 00000275 C606[B402]00            	mov	byte [NullFlag],0	;G reset no command flag
 10625 0000027A F706[4902]FFFF          	test	word [Batch],0FFFFh
 10626 00000280 7512                    	jnz	short JDOCOM1		;G if batch still in progress continue
 10627 00000282 8B1E[B202]              	mov	bx,[Next_Batch]
 10628                                  	; 31/01/2023
 10629 00000286 09DB                    	or	bx,bx
 10630                                  	;cmp	bx,0			;G see if there is a new batch file
 10631 00000288 740A                    	jz	short JDOCOM1		;G no - go do command
 10632 0000028A 891E[4902]              	mov	[Batch],bx		;G get segment of next batch file
 10633 0000028E C706[B202]0000          	mov	word [Next_Batch],0	;G reset next batch
 10634                                  JDOCOM1:
 10635 00000294 0E                      	push	cs
 10636 00000295 1F                      	pop	ds
 10637                                  	;jmp	short DOCOM1
 10638                                  	; 07/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 10639 00000296 EB5D                    	jmp	short DOCOM0
 10640                                  ISNOBAT:
 10641 00000298 833E[A502]00            	cmp	word [SingleCom],0
 10642 0000029D 741D                    	jz	short REGCOM
 10643                                  	; 07/06/2023 - MSDOS 6.22 COMMAND.COM
 10644 0000029F 8B36[A302]              	mov	si,[SemiPermCom] ;  MSDOS 6.0
 10645                                  	;mov	si,0FFFFh 	 ;  MSDOS 3.3 & MSDOS 5.0
 10646 000002A3 8736[A502]              	xchg	si,[SingleCom]
 10647 000002A7 BF[B49A]                	mov	di,COMBUF+2
 10648 000002AA 31C9                    	xor	cx,cx
 10649                                  SINGLELOOP:
 10650 000002AC AC                      	lodsb
 10651 000002AD AA                      	stosb
 10652 000002AE 41                      	inc	cx
 10653 000002AF 3C0D                    	cmp	al,0Dh
 10654 000002B1 75F9                    	jnz	short SINGLELOOP
 10655 000002B3 49                      	dec	cx
 10656 000002B4 0E                      	push	cs
 10657 000002B5 1F                      	pop	ds
 10658 000002B6 880E[B39A]              	mov	[COMBUF+1],cl
 10659                                  
 10660                                  ; do NOT issue a trailing CRLF...
 10661                                  
 10662                                  	;jmp	short DOCOM1
 10663                                  	; 07/06/2023
 10664                                  	; MSDOS 6.22 COMMAND.COM
 10665 000002BA EB39                    	jmp	short DOCOM0
 10666                                  
 10667                                  	;nop
 10668                                  
 10669                                  	; 31/01/2023 - Retro DOS v4.0 COMMAND.COM
 10670                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:02A6h
 10671                                  
 10672                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10673                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02BBh
 10674                                  
 10675                                  ; We have a normal command.  
 10676                                  ; Printers are a bizarre quantity. Sometimes they are a stream and
 10677                                  ; sometimes they aren't. At this point, we automatically close all spool
 10678                                  ; files and turn on truncation mode.
 10679                                  
 10680                                  REGCOM:
 10681                                  	;mov	ax,(ServerCall shl 8) + 9
 10682                                  	; 31/01/2023
 10683 000002BC B8095D                  	mov	ax,5D09h
 10684                                  	;mov	ax,(SERVERCALL<<8)+9
 10685 000002BF CD21                    	int	21h	; DOS -	3.1+ internal -	FLUSH REDIRECTED PRINTER OUTPUT
 10686                                  	;mov	ax,(ServerCall shl 8) + 8
 10687 000002C1 B8085D                  	mov	ax,5D08h
 10688                                  	;mov	ax,(SERVERCALL<<8)+8
 10689 000002C4 B201                    	mov	dl,1
 10690 000002C6 CD21                    	int	21h	; DOS -	3.1+ internal -	SET REDIRECTED PRINTER MODE
 10691                                  			; DL = 00h redirected output is	combined
 10692                                  			;      01h redirected output placed in separate	jobs
 10693                                  			; start	new print job now
 10694 000002C8 0E                      	push	cs
 10695 000002C9 1F                      	pop	ds	; Need local segment to point to buffer
 10696 000002CA BA[2F9A]                	mov	dx,UCOMBUF
 10697                                  
 10698                                  	; MSDOS 6.0
 10699                                  ;	Try to read interactive command line via DOSKey.
 10700                                  ;	If that fails, use DOS Buffered Keyboard Input.
 10701                                  
 10702                                  	; 31/01/2023
 10703 000002CD B81048                  	mov	ax,4810h	; AX = DOSKey Read Line function
 10704 000002D0 CD2F                    	int	2Fh
 10705 000002D2 09C0                    	or	ax,ax
 10706 000002D4 7404                    	jz	short GOTCOM	; DOSKey gave us a command line
 10707                                  
 10708 000002D6 B40A                    	mov	ah,0Ah
 10709                                  	;mov	ah,Std_Con_String_Input	; AH = DOS Buffered Keyboard Input
 10710 000002D8 CD21                    	int	21h	; DOS -	BUFFERED KEYBOARD INPUT
 10711                                  			; DS:DX	-> buffer
 10712                                  GOTCOM:
 10713 000002DA 8A0E[2F9A]              	mov	cl,[UCOMBUF]
 10714 000002DE 30ED                    	xor	ch,ch
 10715 000002E0 83C103                  	add	cx,3
 10716 000002E3 BE[2F9A]                	mov	si,UCOMBUF
 10717 000002E6 BF[B29A]                	mov	di,COMBUF
 10718 000002E9 F3A4                    	rep	movsb		; Transfer it to the cooked buffer
 10719                                  
 10720                                  	; -------------
 10721                                  
 10722                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10723                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02EDh
 10724                                  
 10725 000002EB E88926                  	call	CRLF2
 10726 000002EE 31C0                    	xor	ax,ax
 10727 000002F0 EB06                    	jmp	short DOCOM2
 10728                                  	; -------------
 10729                                  
 10730                                  DOCOM:
 10731 000002F2 E88226                  	call	CRLF2
 10732                                  
 10733                                  	; -------------
 10734                                  
 10735                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10736                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:02F4h
 10737                                  
 10738                                  
 10739                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 10740                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:02F6h
 10741                                  DOCOM0:
 10742 000002F5 B80100                  	mov	ax,1
 10743                                  DOCOM2:
 10744 000002F8 1E                      	push	ds
 10745 000002F9 8E1E[539C]              	mov     ds,[RESSEG]
 10746 000002FD A3[FD01]                	mov	[cox_Y_option],ax
 10747 00000300 1F                      	pop	ds
 10748 00000301 BE[B29A]                	mov	si,COMBUF
 10749 00000304 8A4C01                  	mov	cl,[si+1]
 10750 00000307 30ED                    	xor	ch,ch
 10751 00000309 83C602                  	add	si,2
 10752 0000030C E82501                  	call	get_cox_y_n_opt
 10753 0000030F 7303                    	jnc	short DOCOM1    ; YES answer
 10754                                  	; 07/06/2023
 10755                                  NULLCOMJ:
 10756 00000311 E90201                  	jmp	NULLCOM         ; NO answer
 10757                                  	; -------------
 10758                                  
 10759                                  	; MSDOS 5.0 & MSDOS 6.0 COMMAND.COM
 10760                                  DOCOM1:
 10761 00000314 E8642A                  	call	PRESCAN		; Cook the input buffer
 10762 00000317 7403                    	jz	short NOPIPEPROC
 10763 00000319 E94E2E                  	jmp	PIPEPROCSTRT	; Fire up the pipe
 10764                                  
 10765                                  	; 07/06/2023
 10766                                  ;NULLCOMJ:
 10767                                  	;jmp	NULLCOM
 10768                                  
 10769                                  NOPIPEPROC:
 10770 0000031C E85331                  	call	PARSELINE
 10771 0000031F 730B                    	jnb	short OKPARSE	; user error? or maybe we goofed?
 10772                                  BADPARSE:
 10773 00000321 0E                      	push	cs
 10774 00000322 1F                      	pop	ds
 10775 00000323 BA[EE8F]                	mov	dx,BADNAM_PTR	; 31/01/2023
 10776 00000326 E8EC50                  	call	std_eprintf
 10777 00000329 E9D8FD                  	jmp	TCOMMAND
 10778                                  
 10779                                  OKPARSE:
 10780                                  	;test	byte [ARGV0_ARG_FLAGS],2
 10781                                  	;test	byte [ARG+ARGV_ELE.argflags],2 ; wildcard
 10782                                  	; 01/02/2023
 10783 0000032C F606[B19F]02            	test	byte [ARG+ARGV_ELE.argflags],2
 10784 00000331 75EE                    	jnz	short BADPARSE	; ambiguous commands not allowed
 10785                                  	;cmp	word [ARG_ARGVCNT],0  ; there WAS a command, wasn't there?
 10786 00000333 833E[6FA2]00            	cmp	word [ARG+ARG_UNIT.argvcnt],0
 10787 00000338 74D7                    	jz	short NULLCOMJ
 10788                                  	;cmp	word [ARGV0_ARGLEN],0 ; probably an unnecessary check...
 10789 0000033A 833E[B49F]00            	cmp	word [ARG+ARGV_ELE.arglen],0
 10790 0000033F 74D0                    	jz	short NULLCOMJ	; guarantees argv[0] at least x<NULL>
 10791                                  
 10792 00000341 BE[B49A]                	mov	si,COMBUF+2
 10793 00000344 BF[1B9D]                	mov	di,IDLEN
 10794                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10795                                  				; Make FCB with blank scan-off
 10796                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10797 00000347 B80129                  	mov	ax,2901h
 10798 0000034A CD21                    	int	21h	; DOS -	PARSE FILENAME
 10799                                  			; DS:SI	-> string to parse
 10800                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10801                                  			; AL = bit mask	to control parsing
 10802                                  	;mov	bx,[ARG_ARGV]
 10803 0000034C 8B1E[AF9F]              	mov	bx,[ARG+ARG_UNIT.argv] ; mov bx,[ARG]
 10804 00000350 807F013A                	cmp	byte [bx+1],':'	; was a drive specified?
 10805 00000354 751B                    	jne	short DRVGD	; no, use default of zero...
 10806 00000356 8A17                    	mov	dl,[bx]		; pick-up drive letter
 10807                                  	;mov	dl,[bx+ARGV_ELE.argpointer] ; mov dl,[bx+0]
 10808                                  	;and	dl,~20h
 10809 00000358 80E2DF                  	and	dl,0DFh		; uppercase the sucker
 10810                                  	;sub	dl,[CAPITAL_A]	; convert it to a drive number, A=0
 10811                                  	; 31/01/2023
 10812 0000035B 80EA41                  	sub	dl,'A'
 10813 0000035E 3CFF                    	cmp	al,-1		; See what PARSE said about our drive letter.
 10814 00000360 740C                    	je	short DRVBADJ	; It was invalid.
 10815                                  	;mov	di,[ARGV0_ARGSTARTEL]
 10816 00000362 8B3E[B29F]              	mov	di,[ARG+ARGV_ELE.argstartel]
 10817 00000366 803D00                  	cmp	byte [di],0	; is there actually a command there?
 10818 00000369 7506                    	jne	short DRVGD	; if not, we have:  "d:", "d:\", "d:/"
 10819 0000036B E992FD                  	jmp	SETDRV		; and set drive to new drive spec
 10820                                  DRVBADJ:
 10821 0000036E E9AF28                  	jmp	DRVBAD
 10822                                  DRVGD:
 10823 00000371 8A05                    	mov	al,[di]
 10824 00000373 A2[739C]                	mov	[SPECDRV],al
 10825 00000376 B020                    	mov	al,' '
 10826 00000378 B90900                  	mov	cx,9
 10827 0000037B 47                      	inc	di
 10828 0000037C F2AE                    	repne	scasb		; Count number of letters in command name
 10829 0000037E B008                    	mov	al,8
 10830 00000380 28C8                    	sub	al,cl
 10831 00000382 A2[1B9D]                	mov	[IDLEN],al	; IDLEN is truly the length
 10832 00000385 BF8100                  	mov	di,81h
 10833 00000388 56                      	push	si
 10834 00000389 BE[B49A]                	mov	si,COMBUF+2	; Skip over all leading delims
 10835 0000038C E8F525                  	call	scanoff
 10836                                  
 10837                                  	; 01/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 10838                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0356h
 10839                                  
 10840                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10841                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0391h
 10842                                  
 10843                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 10844                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0393h
 10845                                  
 10846                                  	; MSDOS 6.0
 10847                                  ;SR;
 10848                                  ; We are going to skip over the first char always. The logic is that the
 10849                                  ;command tail can never start from the first character. The code below is 
 10850                                  ;trying to figure out the command tail and copy it to the command line 
 10851                                  ;buffer in the PSP. However, if the first character happens to be a switch
 10852                                  ;character and the user given command line is a full 128 bytes, we try to
 10853                                  ;copy 128 bytes to the PSP while it can take only 127 chars. This extra
 10854                                  ;char overwrites the code and leads to a crash on future commands.
 10855                                  
 10856 0000038F 46                      	inc	si ;  MSDOS 6.0
 10857                                  
 10858                                  DO_SKIPCOM:
 10859 00000390 AC                      	lodsb			; move command line pointer over
 10860 00000391 E8F825                  	call	DELIM		; pathname -- have to do it ourselves
 10861 00000394 740A                    	jz	short DO_SKIPPED ; 'cause parse_file_descriptor is dumb
 10862 00000396 3C0D                    	cmp	al,0Dh		; can't always depend on argv[0].arglen
 10863 00000398 7406                    	jz	short DO_SKIPPED ; to be the same length as the user-
 10864 0000039A 3A06[579C]              	cmp	al,[SWITCHAR]	; specified command string
 10865 0000039E 75F0                    	jnz	short DO_SKIPCOM 
 10866                                  DO_SKIPPED:
 10867 000003A0 4E                      	dec	si
 10868 000003A1 31C9                    	xor	cx,cx
 10869                                  COMTAIL:
 10870 000003A3 AC                      	lodsb
 10871 000003A4 AA                      	stosb			; Move command tail to 80h
 10872 000003A5 3C0D                    	cmp	al,0Dh
 10873 000003A7 E0FA                    	loopne	COMTAIL
 10874 000003A9 4F                      	dec	di
 10875 000003AA 89FD                    	mov	bp,di
 10876 000003AC F6D1                    	not	cl
 10877 000003AE 880E8000                	mov	[80h],cl
 10878 000003B2 5E                      	pop	si
 10879                                  ;-----
 10880                                  ; Some of these comments are sadly at odds with this brave new code.
 10881                                  ;-----
 10882                                  ; If the command has 0 parameters must check here for
 10883                                  ; any switches that might be present.
 10884                                  ; SI -> first character after the command.
 10885                                  
 10886                                  	;mov	di,arg.argv[0].argsw_word
 10887                                  	;mov	di,[ARGV0_ARGSW_WORD]
 10888 000003B3 8B3E[B69F]              	mov	di,[ARG+ARGV_ELE.argsw_word]
 10889 000003B7 893E[6A9C]              	mov	[COMSW],di	; ah yes, the old addressing mode problem...
 10890                                  	;mov	SI,arg.argv[1 * SIZE argv_ele].argpointer  
 10891                                  				; s = argv[1];
 10892                                  	;mov	si,[ARGV1_ARGPOINTER]
 10893 000003BB 8B36[BA9F]              	mov	si,[ARG+ARGV_ELE.SIZE+ARGV_ELE.argpointer]
 10894 000003BF 09F6                    	or	si,si		;   if (s == NULL)
 10895 000003C1 7502                    	jnz	short DOPARSE	;	s = bp; (buffer end)
 10896 000003C3 89EE                    	mov	si,bp
 10897                                  DOPARSE:
 10898 000003C5 BF5C00                  	mov	di,FCB ; 5Ch
 10899                                  	;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10900                                  	; 01/02/2023
 10901 000003C8 B80129                  	mov	ax,2901h
 10902                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10903 000003CB CD21                    	int	21h	; DOS -	PARSE FILENAME
 10904                                  			; DS:SI	-> string to parse
 10905                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10906                                  			; AL = bit mask	to control parsing
 10907 000003CD A2[689C]                	mov	[PARM1],al	; Save result of parse
 10908                                  	;mov	di,arg.argv[1*SIZE argv_ele].argsw_word
 10909                                  	;mov	di,[ARGV1_ARGSW_WORD]
 10910 000003D0 8B3E[C19F]              	mov	di,[ARG+ARGV_ELE.SIZE+ARGV_ELE.argsw_word]
 10911 000003D4 893E[6C9C]              	mov	[ARG1S],di
 10912                                  	;mov	si,arg.argv[2*SIZE argv_ele].argpointer    
 10913                                  				; s = argv[2];
 10914                                  	;mov	si,[ARGV2_ARGPOINTER]
 10915 000003D8 8B36[C59F]              	mov	si,[ARG+(2*ARGV_ELE.SIZE)+ARGV_ELE.argpointer]
 10916 000003DC 09F6                    	or	si,si		; if (s == NULL)
 10917 000003DE 7502                    	jnz	short DOPARSE2
 10918 000003E0 89EE                    	mov	si,bp		;     s = bp; (buffer end)
 10919                                  DOPARSE2:			
 10920 000003E2 BF6C00                  	mov	di,FCB+10h ; 6Ch
 10921                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 01h
 10922 000003E5 B80129                  	mov	ax,2901h
 10923                                  	;mov	ax,(Parse_File_Descriptor<<8)|01h
 10924 000003E8 CD21                    	int	21h	; DOS -	PARSE FILENAME
 10925                                  			; DS:SI	-> string to parse
 10926                                  			; ES:DI	-> buffer to fill with unopened	FCB
 10927                                  			; AL = bit mask	to control parsing
 10928 000003EA A2[699C]                	mov	[PARM2],al	; Save result
 10929                                  	;mov	di,[ARGV2_ARGSW_WORD]
 10930                                  	;mov	di,arg.argv[2*SIZE argv_ele].argsw_word
 10931 000003ED 8B3E[CC9F]              	mov	di,[ARG+(2*ARGV_ELE.SIZE)+ARGV_ELE.argsw_word]
 10932 000003F1 893E[6E9C]              	mov	[ARG2S],di
 10933                                  	;mov	di,[ARGV0_ARGSW_WORD]
 10934                                  	;mov	di,arg.argv[0].argsw_word
 10935 000003F5 8B3E[B69F]              	mov	di,[ARG+ARGV_ELE.argsw_word]
 10936 000003F9 F7D7                    	not	di		; ARGTS doesn't include the flags
 10937                                  	;and	di,[ARG_ARGSWINFO] ; from COMSW...
 10938                                  	;and	di,arg.argswinfo	
 10939 000003FB 233E[71A2]              	and	di,[ARG+ARG_UNIT.argswinfo]
 10940 000003FF 893E[709C]              	mov	[ARGTS],di
 10941                                  
 10942 00000403 A0[1B9D]                	mov	al,[IDLEN]
 10943 00000406 8A16[739C]              	mov	dl,[SPECDRV]
 10944 0000040A 08D2                    	or	dl,dl		; if a drive was specified...
 10945 0000040C 7505                    	jnz	short EXTERNALJ1 ; it MUST be external, by this time
 10946 0000040E FEC8                    	dec	al		; (I don't know why -- old code did it)
 10947 00000410 E96027                  	jmp	FNDCOM		; otherwise, check internal com table
 10948                                  EXTERNALJ1:
 10949 00000413 E96228                  	jmp	EXTERNAL
 10950                                  NULLCOM:
 10951 00000416 8E1E[539C]              	mov	ds,[RESSEG]
 10952 0000041A F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1 ;G Are we in a batch file?
 10953 00000420 7405                    	jz	short NOSETFLAG	  ;G only set flag if in batch
 10954 00000422 C606[B402]01            	mov	byte [NullFlag],1 ;G set flag to indicate no command
 10955                                  	;mov	byte [NullFlag],nullcommand ; 1
 10956                                  NOSETFLAG:
 10957 00000427 833E[A502]FF            	cmp	word [SingleCom],0FFFFh ; -1
 10958 0000042C 7403                    	je	short EXITJ
 10959 0000042E E9B1FD                  	jmp	GETCOM
 10960                                  EXITJ:
 10961 00000431 E9F5FC                  	jmp	_$EXITPREP
 10962                                  
 10963                                  ; 07/06/2023
 10964                                  ; ---------------------------------------------------------------------------
 10965                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 10966                                  ; -----------------------------------------
 10967                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 10968                                  ; ---------------------------------------------------------------------------
 10969                                  
 10970                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 10971                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0436h
 10972                                  
 10973                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 10974                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0438h
 10975                                  get_cox_y_n_opt:
 10976 00000434 E339                    	jcxz	ccydp4		; empty	input buffer
 10977                                  ccydp0:
 10978 00000436 803C0D                  	cmp	byte [si],0Dh
 10979 00000439 7434                    	je	short ccydp4
 10980 0000043B 803C0A                  	cmp	byte [si],0Ah
 10981 0000043E 742F                    	je	short ccydp4
 10982 00000440 06                      	push	es
 10983 00000441 8E06[539C]              	mov	es,[RESSEG]
 10984 00000445 26A0[5A04]              	mov	al,[es:Y_Flag]
 10985 00000449 A810                    	test	al,10h		; bit 1	= 1 -> Y/N answer is needed
 10986 0000044B 7421                    	jz	short ccydp3 ; cf=0 ; 07/06/2023
 10987 0000044D 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],1 ; (in) Batch file ?
 10988 00000453 7419                    	je	short ccydp3	; yes, don't check for ESCAPE
 10989 00000455 A840                    	test	al,40h		; ESCAPE status
 10990                                  				; (bit 4 is zero if Y/N	is escaped)
 10991 00000457 7417                    	jz	short ccydp5
 10992                                  ccydp1:
 10993 00000459 26F706[4902]FFFF        	test	word [es:Batch],0FFFFh
 10994 00000460 740B                    	jz	short ccydp2
 10995 00000462 268E06[4902]            	mov	es,[es:Batch]
 10996                                  	;mov	byte [es:2],1 ; [es:BATCHSEGMENT.BatchEOF]
 10997 00000467 26C606020001            	mov	byte [es:BATCHSEGMENT.BatchEOF],1
 10998                                  ccydp2:
 10999 0000046D F9                      	stc
 11000                                  ccydp3:		; 07/06/2023 ; cf = 0
 11001 0000046E 07                      	pop	es
 11002                                  ccydp4:		; 07/06/2023 ; cf = 0
 11003 0000046F C3                      	retn
 11004                                  
 11005                                  ;ccydp3:
 11006                                  ;	pop	es
 11007                                  ;ccydp4:
 11008                                  ;	clc
 11009                                  ;	retn
 11010                                  
 11011                                  ccydp5:
 11012 00000470 89F2                    	mov	dx,si
 11013 00000472 BB0200                  	mov	bx,2
 11014 00000475 B440                    	mov	ah,40h
 11015 00000477 CD21                    	int	21h	; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 11016                                  			; BX = file handle, CX = number	of bytes to write
 11017                                  			; DS:DX -> buffer
 11018 00000479 BA[8992]                	mov	dx,cox_Y_quest_ptr ; msg number	pointer	of ' [Y/N]?'
 11019                                  				   ; (is 1082)
 11020 0000047C E8964F                  	call	std_eprintf
 11021 0000047F 1E                      	push	ds
 11022 00000480 B83B04                  	mov	ax,1083	; cox_Y_answer number (overwrite Y/N answer letter)
 11023 00000483 B6FF                    	mov	dh,0FFh		; utility_msg_class
 11024 00000485 E87A50                  	call	TSYSGETMSG
 11025                                  	;mov	cx,'NY' ; MASM word format
 11026                                  	; NASM word format
 11027 00000488 B9594E                  	mov	cx,'YN'        ; 'YN' Yes/No (CL=Y)
 11028 0000048B 7202                    	jc	short ccydp6
 11029 0000048D 8B0C                    	mov	cx,[si]
 11030                                  ccydp6:
 11031 0000048F 1F                      	pop	ds
 11032                                  ccydp7:
 11033 00000490 B408                    	mov	ah,8
 11034 00000492 CD21                    	int	21h	; DOS -	KEYBOARD INPUT,	NO ECHO
 11035                                  			; Return: AL = character
 11036 00000494 84C0                    	test	al,al
 11037 00000496 7510                    	jnz	short ccydp8
 11038 00000498 B408                    	mov	ah,8
 11039 0000049A CD21                    	int	21h	; DOS -	KEYBOARD INPUT,	NO ECHO
 11040                                  			; Return: AL = character
 11041 0000049C 3C3F                    	cmp	al,'?'
 11042 0000049E 75F0                    	jne	short ccydp7
 11043 000004A0 26800E[5A04]40          	or	byte [es:Y_Flag],40h ; bit 4, question flag
 11044 000004A6 EBB1                    	jmp	short ccydp1
 11045                                  ccydp8:
 11046 000004A8 3C1B                    	cmp	al,1Bh		; ESCAPE ?
 11047 000004AA 7509                    	jne	short ccydp9
 11048 000004AC 268026[5A04]EF          	and	byte [es:Y_Flag],0EFh ; (ESCAPE) Clear bit 4 ; ~10h
 11049                                  	;jmp	short ccydp12
 11050                                  	; 07/06/2023
 11051 000004B2 9C                      	pushf
 11052 000004B3 EB18                    	jmp	short ccydp12
 11053                                  ccydp9:
 11054                                  	; 25/07/2024 - PCDOS 7.1 COMMAND.COM
 11055 000004B5 3C41                    	cmp     al,41h ; 'A'
 11056 000004B7 7202                    	jb      short ccydp13
 11057                                  	;
 11058 000004B9 24DF                    	and	al,0DFh		; uppercase
 11059                                  ccydp13:	; 25/07/2024
 11060 000004BB 38E8                    	cmp	al,ch		; NO character (N)
 11061 000004BD 7503                    	jne	short ccydp10
 11062 000004BF F9                      	stc
 11063 000004C0 EB04                    	jmp	short ccydp11	; cf = 1 -> overwrite NO answer
 11064                                  ccydp10:
 11065 000004C2 38C8                    	cmp	al,cl		; YES character	(Y)
 11066 000004C4 75CA                    	jne	short ccydp7
 11067                                  ccydp11:
 11068 000004C6 9C                      	pushf			; cf = 0 -> overwrite YES answer
 11069 000004C7 88C2                    	mov	dl,al
 11070 000004C9 B402                    	mov	ah,2
 11071 000004CB CD21                    	int	21h	; DOS -	DISPLAY	OUTPUT
 11072                                  			; DL = character to send to standard output
 11073                                  	; 07/06/2023
 11074                                  	;popf
 11075                                  ccydp12:
 11076                                  	;pushf
 11077 000004CD E8A724                  	call	CRLF2
 11078 000004D0 9D                      	popf
 11079 000004D1 07                      	pop	es
 11080 000004D2 C3                      	retn
 11081                                  
 11082                                  ;============================================================================
 11083                                  ; MSHALO.ASM, MSDOS 6.0, 1991
 11084                                  ;============================================================================
 11085                                  ; 12/10/2018 - Retro DOS v3.0
 11086                                  
 11087                                  ; 05/02/2023 - Retro DOS v5.0 (& v4.1) COMMAND.COM
 11088                                  
 11089                                  ;	SCCSID = @(#)ibmhalo.asm	1.1 85/04/10
 11090                                  ;   On 2K (800h) boundaries beginning at address C0000h and ending at EF800h
 11091                                  ;   there is a header that describes a block of rom program.  This header
 11092                                  ;   contains information needed to initialize a module and to provide PCDOS
 11093                                  ;   with a set of reserved names for execution.
 11094                                  ;
 11095                                  ;   This header has the following format:
 11096                                  ;
 11097                                  ;   rom_header	STRUC
 11098                                  ;	Signature1  DB	55h
 11099                                  ;	Signature2  DB	AAh
 11100                                  ;	rom_length  DB	?		; number of 512 byte pieces
 11101                                  ;	init_jmp    DB	3 dup (?)
 11102                                  ;	name_list   name_struc <>
 11103                                  ;   rom_header	ENDS
 11104                                  ;
 11105                                  ;   name_struc	STRUC
 11106                                  ;	name_len    DB	?
 11107                                  ;	name_text   DB	? DUP (?)
 11108                                  ;	name_jmp    DB	3 DUP (?)
 11109                                  ;   name_struc	ENDS
 11110                                  ;
 11111                                  ;   The name list is a list of names that are reserved by a particular section
 11112                                  ;   of a module.  This list of names is terminated by a null name (length
 11113                                  ;   is zero).
 11114                                  ;
 11115                                  ;   Consider now, the PCDOS action when a user enters a command:
 11116                                  ;
 11117                                  ;	COMMAND.COM has control.
 11118                                  ;	o   If location FFFFEh has FDh then
 11119                                  ;	o	Start scanning at C0000h, every 800h for a byte 55h followed
 11120                                  ;		    by AAh, stop scan if we get above or = F0000H
 11121                                  ;	o	When we've found one, compare the name entered by the user
 11122                                  ;		    with the one found in the rom.  If we have a match, then
 11123                                  ;		    set up the environment for execution and do a long jump
 11124                                  ;		    to the near jump after the found name.
 11125                                  ;	o	If no more names in the list, then continue scanning the module
 11126                                  ;		    for more 55h followed by AAh.
 11127                                  ;	o   We get to this point only if there is no matching name in the
 11128                                  ;		rom.  We now look on disk for the command.
 11129                                  ;
 11130                                  ;   This gives us the flexibility to execute any rom cartridge without having
 11131                                  ;   to 'hard-code' the name of the cartridge into PCDOS.  Rom modules that
 11132                                  ;   want to be invisible to the DOS should not have any names in their lists
 11133                                  ;   (i.e. they have a single null name).
 11134                                  ;
 11135                                  ;   Consider a new release of BASIC, say, that patches bugs in the ROM version.
 11136                                  ;   Clearly this version will be available on disk.  How does a user actually
 11137                                  ;   invoke this new BASIC??  He cannot call it BASIC on the disk because the
 11138                                  ;   EXEC loader will execute the ROM before it even looks at the disk!	Only
 11139                                  ;   solution:
 11140                                  ;
 11141                                  ;   o	Keep things consistent and force the user to have his software named
 11142                                  ;	differently from the ROM names (BASIC1, BASIC2, etc).
 11143                                  
 11144                                  struc ROM_HEADER
 11145 00000000 ??                          .signature1: resb 1
 11146 00000001 ??                          .signature2: resb 1
 11147 00000002 ??                          .rom_length: resb 1
 11148 00000003 ??????                      .init_jmp:	 resb 3
 11149 00000006 ??                          .name_list:	 resb 1
 11150                                      .size:
 11151                                  endstruc
 11152                                  
 11153                                  struc NAME_STRUC
 11154 00000000 ??                          .name_len:	resb 1
 11155 00000001 ??                          .name_text:	resb 1
 11156 00000002 ??????                      .name_jmp:	resb 3
 11157                                      .size:	
 11158                                  endstruc
 11159                                  
 11160                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 03D1h
 11161                                  
 11162                                  ; =============== S U B	R O U T	I N E =======================================
 11163                                  
 11164                                  ;ASSUME	CS:TRANGROUP,DS:NOTHING,ES:NOTHING,SS:NOTHING
 11165                                  
 11166                                  ; 05/02/2023
 11167                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:03FBh
 11168                                  
 11169                                  ; 07/06/2023
 11170                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:04D5h
 11171                                  
 11172                                  ; 25/07/2024
 11173                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:04DBh
 11174                                  
 11175                                  ; Check for IBM PC Jr rom cartrides. DS:DX is a pointer to name
 11176                                  
 11177                                  ROM_SCAN:
 11178 000004D3 06                      	push	es
 11179 000004D4 56                      	push	si
 11180 000004D5 57                      	push	di
 11181 000004D6 51                      	push	cx
 11182 000004D7 50                      	push	ax
 11183 000004D8 53                      	push	bx
 11184                                  
 11185                                  	; check for PC Jr signature in rom
 11186                                  
 11187 000004D9 B800F0                  	mov	ax,0F000h
 11188 000004DC 8EC0                    	mov	es,ax
 11189 000004DE 26803EFEFFFD            	cmp	byte [es:0FFFEh],0FDh
 11190 000004E4 7408                    	je	short SCAN_IT
 11191                                  NO_ROM:
 11192 000004E6 F8                      	clc
 11193                                  ROM_RET:
 11194 000004E7 5B                      	pop	bx
 11195 000004E8 58                      	pop	ax
 11196 000004E9 59                      	pop	cx
 11197 000004EA 5F                      	pop	di
 11198 000004EB 5E                      	pop	si
 11199 000004EC 07                      	pop	es
 11200 000004ED C3                      	retn
 11201                                  
 11202                                  	; start scanning at C000h
 11203                                  SCAN_IT:
 11204 000004EE B800C0                  	mov	ax,0C000h
 11205                                  SCAN_ONE:
 11206 000004F1 8EC0                    	mov	es,ax
 11207 000004F3 31FF                    	xor	di,di
 11208                                  
 11209                                  	; check for a valid header
 11210                                  SCAN_MODULE:
 11211 000004F5 26813D55AA              	cmp	word [es:di],0AA55h
 11212 000004FA 740A                    	je	short SCAN_LIST
 11213 000004FC 058000                  	add	ax,80h
 11214                                  SCAN_END:
 11215 000004FF 3D00F0                  	cmp	ax,0F000h
 11216 00000502 72ED                    	jb	short SCAN_ONE
 11217 00000504 EBE0                    	jmp	short NO_ROM
 11218                                  
 11219                                  	; trundle down list of names
 11220                                  SCAN_LIST:
 11221                                  	;mov	bl,[es:di+2]	; number of 512-byte jobbers
 11222 00000506 268A5D02                	mov	bl,[es:di+ROM_HEADER.rom_length]
 11223 0000050A 30FF                    	xor	bh,bh		; nothing in the high byte
 11224 0000050C D1E3                    	shl	bx,1
 11225 0000050E D1E3                    	shl	bx,1		; number of paragraphs
 11226 00000510 83C37F                  	add	bx,7Fh
 11227 00000513 83E380                  	and	bx,0FF80h	; round to 2k
 11228                                  	;mov	di,6
 11229                                  	; 05/05/2023
 11230 00000516 BF0600                  	mov	di,ROM_HEADER.name_list
 11231                                  	;nop
 11232                                  SCAN_NAME:
 11233 00000519 268A0D                  	mov	cl,[es:di]	; length of name
 11234 0000051C 47                      	inc	di		; point to name
 11235 0000051D 30ED                    	xor	ch,ch
 11236 0000051F 09C9                    	or	cx,cx		; zero length name
 11237 00000521 7504                    	jnz	short SCAN_TEST	; nope... compare
 11238 00000523 01D8                    	add	ax,bx		; yep, skip to next block
 11239 00000525 EBD8                    	jmp	short SCAN_END
 11240                                  
 11241                                  	; compare a single name
 11242                                  SCAN_TEST:
 11243 00000527 89D6                    	mov	si,dx
 11244 00000529 46                      	inc	si
 11245 0000052A F3A6                    	repe	cmpsb		 ; compare name
 11246 0000052C 7407                    	jz	short SCAN_FOUND ; success!
 11247                                  SCAN_NEXT:
 11248 0000052E 01CF                    	add	di,cx		; failure, next name piece
 11249 00000530 83C703                  	add	di,3
 11250 00000533 EBE4                    	jmp	short SCAN_NAME
 11251                                  
 11252                                  	; found a name. save entry location
 11253                                  SCAN_FOUND:	
 11254 00000535 803C3F                  	cmp	byte [si],'?'
 11255 00000538 7405                    	je	short SCAN_SAVE
 11256 0000053A 803C20                  	cmp	byte [si],' '
 11257 0000053D 75EF                    	jne	short SCAN_NEXT
 11258                                  SCAN_SAVE:
 11259 0000053F 2E8C06[169E]            	mov	[cs:ROM_CS],es
 11260 00000544 2E893E[149E]            	mov	[cs:ROM_IP],di
 11261 00000549 F9                      	stc
 11262 0000054A EB9B                    	jmp	short ROM_RET
 11263                                  
 11264                                  ; ---------------------------------------------------------------------------
 11265                                  
 11266                                  ; execute a rom-placed body of code. allocate largest block
 11267                                  
 11268                                  ROM_EXEC:
 11269 0000054C BBFFFF                  	mov	bx,0FFFFh
 11270                                  	; 05/02/2023
 11271 0000054F B448                    	mov	ah,48h
 11272                                  	;mov	ah,ALLOC ; 48h
 11273 00000551 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 11274                                  			; BX = number of 16-byte paragraphs desired
 11275 00000553 B448                    	mov	ah,48h
 11276                                  	;mov	ah,ALLOC ; 48h
 11277 00000555 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 11278                                  			; BX = number of 16-byte paragraphs desired
 11279 00000557 53                      	push	bx
 11280 00000558 50                      	push	ax
 11281                                  
 11282                                  	; set terminate addresses
 11283                                  
 11284 00000559 B82225                  	mov	ax,2522h
 11285                                  	;;mov	ax,(set_interrupt_vector SHL 8) + int_terminate
 11286                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)+INT_TERMINATE
 11287 0000055C 1E                      	push	ds
 11288 0000055D 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 11289                                  	;mov	dx,offset RESGROUP:EXEC_WAIT
 11290                                  	;mov	dx,131h ; MSDOS 3.3
 11291                                  	; 05/02/2023
 11292                                  	;mov	dx,0D6Bh ; MSDOS 5.0
 11293 00000562 BA[390D]                	mov	dx,Exec_Wait
 11294 00000565 CD21                    	int	21h	; DOS -	SET INTERRUPT VECTOR
 11295                                  			; AL = interrupt number
 11296                                  			; DS:DX	= new vector to	be used	for specified interrupt
 11297 00000567 8CDA                    	mov	dx,ds
 11298 00000569 8EC2                    	mov	es,dx
 11299 0000056B 1F                      	pop	ds
 11300                                  		
 11301                                  	; and create program header and dup all jfn's
 11302                                  
 11303 0000056C 5A                      	pop	dx
 11304 0000056D B455                    	mov	ah,55h
 11305                                  	;mov	ah,DUP_PDB ; 55h
 11306 0000056F CD21                    	int	21h	; DOS -	2+ internal - CREATE PSP
 11307                                  			; DX = segment number at which to set up PSP
 11308                                  			; SI = (DOS 3+)	value to place in memory size field at DX:[0002h]
 11309                                  		
 11310                                  	; set up dma address
 11311                                  
 11312 00000571 8EDA                    	mov	ds,dx
 11313 00000573 BA8000                  	mov	dx,80h
 11314 00000576 B41A                    	mov	ah,1Ah
 11315                                  	;mov	ah,Set_DMA ; 1Ah
 11316 00000578 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 11317                                  			; DS:DX	-> disk	transfer buffer
 11318                                  
 11319                                  	; copy in environment info
 11320                                  
 11321 0000057A 26A1[3A04]              	mov	ax,[es:EnvirSeg]
 11322                                  	;mov	[2Ch],ax
 11323 0000057E A32C00                  	mov	[PDB.ENVIRON],ax
 11324                                  
 11325                                  	; set up correct size of block
 11326                                  
 11327 00000581 5B                      	pop	bx		; BX has size, DS has segment
 11328 00000582 8CDA                    	mov	dx,ds
 11329 00000584 01DA                    	add	dx,bx
 11330                                  	;mov	[2],dx
 11331 00000586 89160200                	mov	[PDB.BLOCK_LEN],dx
 11332                                  
 11333                                  	; change ownership of block
 11334                                  
 11335 0000058A 8CDA                    	mov	dx,ds
 11336 0000058C 4A                      	dec	dx
 11337 0000058D 8EDA                    	mov	ds,dx
 11338 0000058F 42                      	inc	dx	
 11339                                  	;mov	[1],dx
 11340 00000590 89160100                	mov	[ARENA.owner],dx
 11341 00000594 8EDA                    	mov	ds,dx
 11342                                  
 11343                                  	; set up correct stack
 11344                                  
 11345 00000596 81FB0010                	cmp	bx,1000h
 11346 0000059A 7202                    	jb	short GOT_STACK
 11347 0000059C 31DB                    	xor	bx,bx
 11348                                  GOT_STACK:
 11349 0000059E B104                    	mov	cl,4
 11350 000005A0 D3E3                    	shl	bx,cl
 11351 000005A2 8CDA                    	mov	dx,ds
 11352 000005A4 8ED2                    	mov	ss,dx
 11353 000005A6 89DC                    	mov	sp,bx
 11354 000005A8 31C0                    	xor	ax,ax
 11355 000005AA 50                      	push	ax
 11356                                  
 11357                                  	; set up initial registers and go to the guy
 11358                                  
 11359 000005AB F7D0                    	not	ax
 11360 000005AD 2EFF36[169E]            	push	word [cs:ROM_CS]
 11361 000005B2 2EFF36[149E]            	push	word [cs:ROM_IP]
 11362 000005B7 8EC2                    	mov	es,dx
 11363 000005B9 CB                      	retf	; far return
 11364                                  
 11365                                  ; 25/07/2024 - Retro DOS v5.0
 11366                                  ; ---------------------------------------------------------------------------
 11367                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:05C2h
 11368                                  
 11369                                  ; =============== S U B	R O U T	I N E =======================================
 11370                                  
 11371                                  int_21h_indirect:
 11372 000005BA 1E                      	push	ds		; (*)
 11373 000005BB 9C                      	pushf			; (**)
 11374 000005BC 53                      	push	bx
 11375 000005BD 31DB                    	xor	bx, bx
 11376 000005BF 8EDB                    	mov	ds, bx		; 0
 11377 000005C1 5B                      	pop	bx
 11378 000005C2 0E                      	push	cs		; simulate INT 21h
 11379                                  				; stack: ip, cs, flags (**)
 11380 000005C3 E80300                  	call	INT21h_fcall
 11381 000005C6 C20200                  	retn	2		; discard ds (*) on top	of stack
 11382                                  
 11383                                  ; =============== S U B	R O U T	I N E =======================================
 11384                                  
 11385                                  INT21h_fcall:
 11386                                  	;push	word ptr ds:86h
 11387 000005C9 FF368600                	push	word [(4*21h)+2] ; INT 21h segment
 11388                                  	;push	word ptr ds:84h
 11389 000005CD FF368400                	push	word [4*21h]	; INT 21h offset
 11390 000005D1 55                      	push	bp
 11391 000005D2 89E5                    	mov	bp,sp
 11392 000005D4 8E5E0C                  	mov	ds,[bp+12]	; DS (*) in stack
 11393 000005D7 FF760E                  	push	word [bp+14]	; return addr of the caller of INT21h_fcall
 11394 000005DA 8F460C                  	pop	word [bp+12]	; return address from INT 21h
 11395 000005DD 5D                      	pop	bp
 11396 000005DE FA                      	cli
 11397 000005DF CB                      	retf
 11398                                  
 11399                                  ; =============== S U B	R O U T	I N E =======================================
 11400                                  
 11401                                  int_2Fh_indirect:
 11402 000005E0 1E                      	push	ds
 11403 000005E1 53                      	push	bx
 11404 000005E2 31DB                    	xor	bx,bx
 11405 000005E4 8EDB                    	mov	ds,bx
 11406 000005E6 5B                      	pop	bx
 11407 000005E7 9C                      	pushf
 11408 000005E8 FA                      	cli
 11409                                  	;call	dword ptr ds:0BCh
 11410 000005E9 FF1EBC00                	call	far [4*2Fh]	;  INT 2Fh handler
 11411 000005ED 1F                      	pop	ds
 11412 000005EE C3                      	retn
 11413                                  
 11414                                  ; ---------------------------------------------------------------------------
 11415                                  
 11416                                  ;============================================================================
 11417                                  ; TBATCH.ASM, MSDOS 6.0, 1991
 11418                                  ;============================================================================
 11419                                  ; 12/10/2018 - Retro DOS v3.0
 11420                                  
 11421                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 04B9h
 11422                                  
 11423                                  ; =============== S U B	R O U T	I N E =======================================
 11424                                  
 11425                                  ;Break	<PromptBat - Open or wait for batch file>
 11426                                  
 11427                                  ; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11428                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:04E2h
 11429                                  
 11430                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 11431                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:05BCh
 11432                                  
 11433                                  ; Open the batch file. If we cannot find the batch file. If the media is
 11434                                  ; changeable, we prompt for the change. Otherwise, we terminate the batch
 11435                                  ; file. Leave segment registers alone.
 11436                                  
 11437                                  PROMPTBAT:
 11438 000005EF E85308                  	call	BATOPEN
 11439 000005F2 7201                    	jc	short PROMPTBAT1
 11440 000005F4 C3                      	retn
 11441                                  PROMPTBAT1:
 11442                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11443                                  	; MSDOS 6.0 COMMAND.COM
 11444 000005F5 83FA02                  	cmp	dx,ERROR_FILE_NOT_FOUND ;AN022; Ask for diskette if file not found
 11445 000005F8 740A                    	je	short BAT_REMCHECK	;AN022;
 11446 000005FA 83FA03                  	cmp	dx,ERROR_PATH_NOT_FOUND ;AN022; Ask for diskette if path not found
 11447 000005FD 7405                    	je	short BAT_REMCHECK	;AN022; Otherwise, issue message and exit
 11448                                  	;invoke	output_batch_name	;AN022; set up batch name in bwdbuf
 11449 000005FF E83500                  	call	output_batch_name
 11450 00000602 EB13                    	jmp	short BATDIE		;AN022;
 11451                                  
 11452                                  	; 05/02/2023
 11453                                  	; MSDOS 3.3 COMMAND.COM
 11454                                  	;cmp	dx,ACCDENPTR
 11455                                  	;jz	short BATDIE
 11456                                  
 11457                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11458                                  BAT_REMCHECK:				;AN022; Go see if media is removable
 11459 00000604 2EFF1E[5D9C]            	call	far [cs:RCH_ADDR]	; DX has error number
 11460 00000609 7417                    	jz	short ASKFORBAT		; Media is removable
 11461                                  
 11462                                  ; The media is not changeable. Turn everything off.
 11463                                  
 11464 0000060B E84B0B                  	call	FOROFF
 11465 0000060E E8942D                  	call	PipeOff
 11466 00000611 A2[AA02]                	mov	[IfFlag],al	; No If in progress.	
 11467 00000614 BA[E88F]                	mov	dx,BADBAT_PTR
 11468                                  BATDIE:
 11469 00000617 E8F803                  	call	BATCHOFF
 11470 0000061A 0E                      	push	cs
 11471 0000061B 1F                      	pop	ds
 11472                                  	;invoke	std_eprintf	;AC022; display message ;  MSDOS 6.0
 11473                                  	; 05/02/2023
 11474 0000061C E8F64D                  	call	std_eprintf	; MSDOS 6.0
 11475                                  	;call	STD_PRINTF	; MSDOS 3.3
 11476                                  
 11477                                  ; TCOMMAND resets the stack. This is the equivalent of a non-local goto.
 11478                                  
 11479 0000061F E9E2FA                  	jmp	TCOMMAND
 11480                                  
 11481                                  ; Ask the user to reinsert the batch file
 11482                                  
 11483                                  ASKFORBAT:
 11484 00000622 1E                      	push	ds
 11485 00000623 0E                      	push	cs
 11486 00000624 1F                      	pop	ds
 11487                                  
 11488                                  	; MSDOS 6.0
 11489                                  	;mov	dx,offset TRANGROUP:NEEDBAT_ptr  ;AN022;
 11490 00000625 BA[EB8F]                	mov	dx,NEEDBAT_PTR
 11491                                  	;invoke	std_eprintf	 	;Prompt for batch file on stderr
 11492                                  	; 05/02/2023
 11493 00000628 E8EA4D                  	call	std_eprintf
 11494                                  	;mov	dx,offset trangroup:pausemes_ptr
 11495 0000062B BA[9890]                	mov	dx,PAUSEMES_PTR
 11496                                  	;invoke std_eprintf		;AN000; get second part of message
 11497 0000062E E8E44D                  	call	std_eprintf
 11498                                  					;AN000; print it to stderr
 11499                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11500                                  	;call	STD_EPRINTF
 11501 00000631 E82E00                  	call	GETKEYSTROKE
 11502 00000634 1F                      	pop	ds
 11503 00000635 EBB8                    	jmp	short PROMPTBAT
 11504                                  
 11505                                  
 11506                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11507                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:052Ah
 11508                                  
 11509                                  	; MSDOS 6.0
 11510                                  ;****************************************************************
 11511                                  ;*
 11512                                  ;* ROUTINE:	Output_batch_name
 11513                                  ;*
 11514                                  ;* FUNCTION:	Sets up batch name to be printed on extended error
 11515                                  ;*
 11516                                  ;* INPUT:	DX - extended error number
 11517                                  ;*
 11518                                  ;* OUTPUT:	Ready to call print routine
 11519                                  ;*
 11520                                  ;****************************************************************
 11521                                  ;
 11522                                  ;public	output_batch_name		;AN022;
 11523                                  
 11524                                  output_batch_name:	;proc near	;AN022;
 11525                                  
 11526 00000637 1E                      	push	ds			;AN022; save resident segment
 11527 00000638 8E1E[4902]              	mov	ds,[Batch]		;AN022; get batch file segment
 11528                                  	;assume	DS:nothing		;AN022;
 11529                                  	;;mov	SI,BatFile		;AN022; get offset of batch file
 11530                                  	; 05/02/2023
 11531                                  	;mov	si,20h
 11532                                  	; 24/04/2023
 11533 0000063C BE2000                  	mov	si,BATCHSEGMENT.BatFile
 11534                                  	;invoke	dstrlen 		;AN022; get length of string
 11535 0000063F E85B2A                  	call	dstrlen
 11536                                  	;mov	di,offset Trangroup:bwdbuf
 11537                                  					;AN022; target for batch name
 11538 00000642 BF[9A9D]                	mov	di,BWDBUF
 11539 00000645 F3A4                    	rep	movsb			;AN022; move the name
 11540                                  
 11541 00000647 0E                      	push	cs			;AN022; get local segment
 11542 00000648 1F                      	pop	ds			;AN022;
 11543                                  	;assume	DS:trangroup		;AN022;
 11544                                  	; 05/02/2023
 11545 00000649 8916[CB8F]              	mov	[extend_buf_ptr],dx	;AN022; put message number in block
 11546                                  	;mov	byte [msg_disp_class],1
 11547 0000064D C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 11548                                  					;AN022; set up extended error msg class
 11549                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 11550 00000652 BA[CB8F]                	mov	dx,extend_buf_ptr	
 11551                                  					;AN022; get extended message pointer
 11552                                  	;mov	string_ptr_2,offset trangroup:bwdbuf 
 11553 00000655 C706[019E][9A9D]        	mov	word [string_ptr_2],BWDBUF	
 11554                                  					;AN022; point to substitution
 11555                                  	;mov	byte [extend_buf_sub],1
 11556 0000065B C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 11557                                  					;AN022; set up for one subst
 11558 00000660 1F                      	pop	ds			;AN022; restore data segment
 11559 00000661 C3                      	retn				;AN022; return
 11560                                  
 11561                                  ;output_batch_name    endp		;AN022;
 11562                                  
 11563                                  
 11564                                  ; =============== S U B	R O U T	I N E =======================================
 11565                                  
 11566                                  ;Break	<GetKeystroke - get a keystroke and flush queue>
 11567                                  
 11568                                  ; Read the next keystroke. Since there may be several characters in the queue
 11569                                  ; after the one we ask for (function keys/Kanji), we need to flush the queue
 11570                                  ; AFTER waiting.
 11571                                  
 11572                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11573                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0555h
 11574                                  
 11575                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 11576                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:062Fh
 11577                                  
 11578                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 11579                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:066Ah
 11580                                  
 11581                                  GETKEYSTROKE:
 11582                                  	; 05/02/2023
 11583                                  	; MSDOS 3.3
 11584                                  	;;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) OR STD_CON_INPUT_NO_ECHO
 11585                                  	;;mov	ax,0C08h
 11586                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)|STD_CON_INPUT_NO_ECHO
 11587                                  	;int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 11588                                  	;		; AL must be 01h,06h,07h,08h,or 0Ah.
 11589                                  	;;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) + 0
 11590                                  	;;mov	ax,0C00h
 11591                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)+0
 11592                                  	;int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 11593                                  	;		; AL must be 01h,06h,07h,08h,or 0Ah.
 11594                                  	;retn
 11595                                  
 11596                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11597                                  	; MSDOS 6.0
 11598 00000662 52                      	push	dx			;AN000;  3/3/KK
 11599                                  	;mov	ax,(ECS_call SHL 8) OR GetInterimMode
 11600                                  					;AN000;  3/3/KK
 11601 00000663 B80263                  	mov	ax,6302h
 11602 00000666 CD21                    	int	21h			;AN000;  3/3/KK
 11603                                  		; DOS - 3.2+ only - GET KOREAN (HONGEUL) INPUT MODE
 11604                                  	
 11605 00000668 52                      	push	dx			;AN000;  save interim state 3/3/KK
 11606                                  	;mov	ax,(ECS_call SHL 8) OR SetInterimMode
 11607                                  					;AN000;  3/3/KK
 11608 00000669 B80163                  	mov	ax,6301h
 11609 0000066C B201                    	mov	dl,1
 11610                                  	;mov	dl,InterimMode		;AN000;  3/3/KK
 11611 0000066E CD21                    	int	21h			;AN000;  3/3/KK
 11612                                  		; DOS - 3.2+ only - SET KOREAN (HONGEUL) INPUT MODE
 11613                                  		; DL = new mode
 11614                                  		; 00h return only full characters on DOS keyboard input functions
 11615                                  		; 01h return partially-formed characters also
 11616                                  	
 11617                                  	;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) OR STD_CON_INPUT_no_echo
 11618 00000670 B8080C                  	mov	ax,0C08h
 11619 00000673 CD21                    	int	21h			; Get character with KB buffer flush
 11620                                  		; DOS - CLEAR KEYBOARD BUFFER
 11621                                  		; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 11622                                  
 11623                                  	;mov	ax,(STD_CON_INPUT_FLUSH SHL 8) + 0
 11624 00000675 B8000C                  	mov	ax,0C00h
 11625 00000678 CD21                    	int	21h
 11626                                  		; DOS - CLEAR KEYBOARD BUFFER
 11627                                  		; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 11628                                  
 11629                                  	;mov	ax,(ECS_call SHL 8) OR SetInterimMode
 11630                                  					;AN000;  3/3/KK
 11631 0000067A B80163                  	mov	ax,6301h
 11632 0000067D 5A                      	pop	dx			;AN000;  restore interim state 3/3/KK
 11633 0000067E CD21                    	int	21h			;AN000;  3/3/KK
 11634 00000680 5A                      	pop	dx			;AN000;  3/3/KK
 11635                                  	
 11636 00000681 C3                      	retn
 11637                                  
 11638                                  ; =============== S U B	R O U T	I N E =======================================
 11639                                  
 11640                                  ; Break	<ReadBat - read 1 line from batch file>
 11641                                  
 11642                                  ; ReadBat - read a single line from the batch file. 
 11643                                  ; Perform all substitutions as appropriate.
 11644                                  
 11645                                  	; 05/02/2023 - Retro DOS v4.0 COMMAND.COM
 11646                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0575h
 11647                                  
 11648                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 11649                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:068Ah
 11650                                  
 11651                                  READBAT:
 11652                                  	;ASSUME	DS:ResGroup,ES:TranGroup
 11653                                  		
 11654                                  	;mov	byte [Suppress],1
 11655                                  				; initialize line suppress status
 11656 00000682 C606[9E02]01            	mov	byte [Suppress],YES_ECHO
 11657 00000687 F606[9302]FF            	test	byte [Batch_Abort],-1 ; 0FFh
 11658 0000068C 751F                    	jnz	short TRYING_TO_ABORT
 11659 0000068E C606[9202]01            	mov	byte [In_Batch],1 ; set flag to indicate batch job
 11660                                  
 11661                                  	; MSDOS 6.0
 11662                                  
 11663                                  ;M037; Start of changes
 11664                                  ; We check here if we have set the flag indicating that the batchfile is at
 11665                                  ;EOF. In this case, we do not want to continue with the normal processing.
 11666                                  ;We call GetBatByt once more so that the batch segment gets freed up, the
 11667                                  ;batch file gets closed etc. and then return as if everything is done.
 11668                                  
 11669                                  	; 05/02/2023
 11670 00000693 1E                      	push	ds
 11671 00000694 8E1E[4902]              	mov	ds,[Batch]
 11672                                  	;cmp	byte [2],0
 11673 00000698 803E020000              	cmp	byte [BATCHSEGMENT.BatchEOF],0
 11674                                  				; are we at EOF in batchfile
 11675 0000069D 1F                      	pop	ds
 11676 0000069E 740A                    	jz	short CONTBAT	; no, continue normal processing
 11677                                  	;invoke	GetBatByt	; frees up batchseg
 11678 000006A0 E8DC03                  	call	GETBATBYT
 11679 000006A3 26A2[B49A]              	mov	[es:COMBUF+2],al
 11680                                  				; stuff CR into command buffer
 11681                                  				; as a dummy command
 11682                                  	;;invoke CrLf2		; print a CR-LF
 11683                                  	;call	CRLF2
 11684                                  	;;return		; done batch processing
 11685                                  	;retn
 11686                                  	; 24/04/2023
 11687 000006A7 E9CD22                  	jmp	CRLF2
 11688                                  
 11689                                  ;M037; End of changes
 11690                                  		
 11691                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11692                                  CONTBAT:
 11693 000006AA E842FF                  	call	PROMPTBAT
 11694                                  
 11695                                  TRYING_TO_ABORT:
 11696 000006AD BF[B49A]                	mov	di,COMBUF+2
 11697                                  
 11698                                  ; Save position and try to scan for first non delimiter.
 11699                                  
 11700                                  TESTNOP:
 11701 000006B0 8CD8                    	mov	ax,ds
 11702 000006B2 8E1E[4902]              	mov	ds,[Batch]
 11703 000006B6 FF360800                	push	word [BATCHSEGMENT.BatSeek]
 11704 000006BA FF360A00                	push	word [BATCHSEGMENT.BatSeek+2]
 11705                                  				; save current location.
 11706 000006BE 8ED8                    	mov	ds,ax
 11707 000006C0 E85506                  	call	SKIPDELIM	; skip to first non-delim
 11708                                  
 11709                                  ; If the first non-delimiter is not a : (label), we reseek back to the
 11710                                  ; beginning and read the line.
 11711                                  
 11712 000006C3 3C3A                    	cmp	al,':'		; is it a label?
 11713 000006C5 59                      	pop	cx
 11714 000006C6 5A                      	pop	dx		; restore position in bat file
 11715 000006C7 7432                    	jz	short NOPLINE	; yes, resync everything.
 11716 000006C9 F706[4902]FFFF          	test	word [Batch],-1 ; are we done with the batch file?
 11717 000006CF 7439                    	jz	short RDBAT	; no, go read batch file
 11718                                  
 11719                                  	;cmp	al,'@'
 11720 000006D1 3C40                    	cmp	al,No_Echo_Char	; see if user wants to suppress line
 11721 000006D3 7507                    	jne	short SET_BAT_POS ; no - go and set batch file position
 11722                                  	;mov	byte [Suppress],0
 11723 000006D5 C606[9E02]00            	mov	byte [Suppress],NO_ECHO ; yes set flag to indicate
 11724 000006DA EB2E                    	jmp	short RDBAT	; go read batch file
 11725                                  	;nop
 11726                                  SET_BAT_POS:
 11727 000006DC 1E                      	push	ds
 11728 000006DD 8E1E[4902]              	mov	ds,[Batch]
 11729                                  	;mov	[8],dx
 11730 000006E1 89160800                	mov	[BATCHSEGMENT.BatSeek],dx ; reseek back to beginning
 11731                                  	;mov	[10],cx
 11732 000006E5 890E0A00                	mov	[BATCHSEGMENT.BatSeek+2],cx
 11733 000006E9 1F                      	pop	ds
 11734                                  	;;mov	ax,(LSEEK SHL 8) + 0
 11735                                  	; 05/02/2023
 11736 000006EA B80042                  	mov	ax,4200h
 11737                                  	;mov	ax,(LSEEK*256) ; 4200h ; seek back
 11738                                  
 11739                                  ; 25/07/2024
 11740                                  ; PCDOS 7.1 COMMAND.COM
 11741                                  %if 0
 11742                                  	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 11743                                  			; AL = method: offset from beginning of	file
 11744                                  %else
 11745 000006ED E8CAFE                  	call	int_21h_indirect
 11746                                  %endif
 11747                                  	;mov	word [cs:BATBUFPOS],0FFFFh
 11748                                  	; 24/04/2023
 11749                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:05E3h
 11750 000006F0 26C706[27A6]FFFF        	mov	word [es:BATBUFPOS],-1; 0FFFFh
 11751                                  	;mov	word [cs:BATBUFPOS],-1 ; nuke batch buffer position
 11752 000006F7 31C9                    	xor	cx,cx		; Initialize line length to zero
 11753 000006F9 EB0F                    	jmp	short RDBAT
 11754                                  
 11755                                  	;nop
 11756                                  
 11757                                  ; The first non-delimiter is a :. This line is not echoed and is ignored.
 11758                                  ; We eat characters until a CR is seen.
 11759                                  
 11760                                  NOPLINE:
 11761 000006FB E80501                  	call	SKIPTOEOL
 11762 000006FE E87E03                  	call	GETBATBYT	; eat trailing LF
 11763                                  	;test	word [Batch],0FFFFh
 11764 00000701 F706[4902]FFFF          	test	word [Batch],-1 ; are we done with the batch file?
 11765 00000707 75A7                    	jnz	short TESTNOP	; no, go get another line
 11766                                  READBAT_RETN:			; Hit EOF
 11767 00000709 C3                      	retn
 11768                                  
 11769                                  ; ---------------------------------------------------------------------------
 11770                                  
 11771                                  ; Read a line into the buffer pointed to by ES:DI. If any %s are seen in the
 11772                                  ; input, we are to consider two special cases:
 11773                                  ;
 11774                                  ;   %0 to %9	These represent replaceable parameters from the batch segment
 11775                                  ;   %sym%	This is a symbol from the environment
 11776                                  
 11777                                  RDBAT:
 11778 0000070A E87203                  	call	GETBATBYT
 11779 0000070D 41                      	inc	cx		; Inc the line length
 11780                                  
 11781                                  	; 05/02/2023
 11782                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0601h
 11783 0000070E E84E20                  	call	testkanj
 11784 00000711 740C                    	jz	short RDBAT1
 11785                                  	;cmp	cx,127
 11786 00000713 83F97F                  	cmp	cx,COMBUFLEN-1
 11787 00000716 7350                    	jnb	short TOOLONG
 11788 00000718 AA                      	stosb
 11789 00000719 E86303                  	call    GETBATBYT
 11790 0000071C 41                      	inc	cx
 11791 0000071D EB0A                    	jmp	short SAVBATBYT
 11792                                  RDBAT1:
 11793 0000071F 81F98000                	cmp	cx,COMBUFLEN ; 128 ; Is it too long?
 11794 00000723 7343                    	jnb	short TOOLONG	   ; Yes - handle it, handle it
 11795                                  
 11796                                  ; See if we have a parameter character.
 11797                                  
 11798 00000725 3C25                    	cmp	al,'%'		; Check for parameter
 11799 00000727 7449                    	je	short NEEDPARM
 11800                                  
 11801                                  ; no parameter character. Store it as usual and see if we are done.
 11802                                  
 11803                                  SAVBATBYT:
 11804 00000729 AA                      	stosb			; End of line found?
 11805 0000072A 3C0D                    	cmp	al,0Dh
 11806 0000072C 75DC                    	jne	short RDBAT	; no, go for more
 11807                                  
 11808                                  ; We have read in an entire line. 
 11809                                  ; Decide whether we should echo the command line or not.
 11810                                  
 11811                                  FOUND_EOL:
 11812 0000072E 81EF[B59A]              	sub	di,COMBUF+3
 11813 00000732 89F8                    	mov	ax,di		; remember that we've not counted the CR
 11814 00000734 26A2[B39A]              	mov	[es:COMBUF+1],al
 11815                                  				; Set length of line
 11816 00000738 E84403                  	call	GETBATBYT	; Eat linefeed
 11817 0000073B E8F206                  	call	BATCLOSE
 11818 0000073E 803E[9E02]00            	cmp	byte [Suppress],NO_ECHO ; 0
 11819 00000743 7407                    	jz	short RESET
 11820 00000745 F606[9D02]01            	test	byte [EchoFlag],1  ; To echo or not to echo, that is the
 11821 0000074A 7504                    	jnz	short TRY_NEXTFLAG ; question. (Profound, huh?)
 11822                                  RESET:
 11823 0000074C 0E                      	push	cs
 11824 0000074D 1F                      	pop	ds		; Go back to local segment
 11825 0000074E 74B9                    	jz	short READBAT_RETN ; no echoing here...
 11826                                  TRY_NEXTFLAG:
 11827 00000750 803E[B402]01            	cmp	byte [NullFlag],nullcommand ; 1
 11828                                  				;G was there a command last time?
 11829 00000755 7403                    	jz	short NO_CRLF_PRINT
 11830                                  				;G no - don't print crlf
 11831 00000757 E81D22                  	call	CRLF2		;G Print out prompt
 11832                                  NO_CRLF_PRINT:
 11833 0000075A E89119                  	call	PRINT_PROMPT
 11834 0000075D 0E                      	push	cs		;G change data segment
 11835 0000075E 1F                      	pop	ds
 11836 0000075F BA[B49A]                	mov	dx,COMBUF+2	; get command line for echoing
 11837 00000762 E86B22                  	call	CRPRINT
 11838                                  	;call	CRLF2
 11839                                  	;retn
 11840                                  	; 06/02/2023
 11841 00000765 E90F22                  	jmp	CRLF2
 11842                                  
 11843                                  ; The line was too long. Eat remainder of input text up until the CR
 11844                                  
 11845                                  TOOLONG:
 11846 00000768 3C0D                    	cmp	al,0Dh		; Has the end of the line been reached?
 11847 0000076A 7403                    	jz	short LTLCONT	; Yes, continue
 11848 0000076C E89400                  	call	SKIPTOEOL	; Eat remainder of line	
 11849                                  LTLCONT:
 11850 0000076F AA                      	stosb			; Terminate the command
 11851 00000770 EBBC                    	jmp	short FOUND_EOL	; Go process the valid part of the line
 11852                                  
 11853                                  ; We have found a parameter lead-in character. Check for the 0-9 case first
 11854                                  
 11855                                  NEEDPARM:
 11856 00000772 E80A03                  	call	GETBATBYT	; get next character
 11857 00000775 3C25                    	cmp	al,'%'		; Check for two consecutive %
 11858 00000777 74B0                    	je	short SAVBATBYT	; if so, replace with a single %
 11859 00000779 3C0D                    	cmp	al,0Dh		; Check for end-of-line
 11860 0000077B 74AC                    	je	short SAVBATBYT	; yes, treat it normally
 11861                                  
 11862                                  ; We have found %<something>. If the <something> is in the range 0-9, we
 11863                                  ; retrieve the appropriate parameter from the batch segment. Otherwise we
 11864                                  ; see if the <something> has a terminating % and then look up the contents
 11865                                  ; in the environment.
 11866                                  
 11867                                  PAROK:
 11868 0000077D 2C30                    	sub	al,'0'
 11869 0000077F 7239                    	jb	short NEEDENV	; look for parameter in the environment
 11870 00000781 3C09                    	cmp	al,9
 11871 00000783 7735                    	ja	short NEEDENV
 11872                                  
 11873                                  ; We have found %<number>. This is taken from the parameters in the
 11874                                  ; allocated batch area.
 11875                                  
 11876 00000785 98                      	cbw
 11877 00000786 89C3                    	mov	bx,ax		; move index into AX
 11878 00000788 D1E3                    	shl	bx,1		; convert word index into byte ptr
 11879 0000078A 06                      	push	es
 11880 0000078B 8E06[4902]              	mov	es,[Batch]
 11881                                  
 11882                                  ; The structure of the batch area is:
 11883                                  ;
 11884                                  ;   BYTE    type of segment
 11885                                  ;   DWORD   offset for next line
 11886                                  ;   10 WORD pointers to parameters. -1 is empty parameter
 11887                                  ;   ASCIZ   file name (with . and ..)
 11888                                  ;   BYTES   CR-terminated parameters
 11889                                  ;   BYTE    0 flag to indicate end of parameters
 11890                                  ;
 11891                                  ; Get pointer to BX'th argument
 11892                                  
 11893                                  	;;mov	si,[es:bx+0Bh]
 11894                                  	; 05/02/2023
 11895                                  	;mov	si,[es:bx+0Ch] 	; MSDOS 5.0 COMMAND.COM
 11896 0000078F 268B770C                	mov	si,[es:bx+BATCHSEGMENT.BatParm]
 11897 00000793 07                      	pop	es
 11898                                  
 11899                                  ; Is there a parameter here?
 11900                                  
 11901 00000794 83FEFF                  	cmp	si,-1		; Check if parameter exists
 11902 00000797 7503                    	jnz	short YES_THERE_IS ; Yes go get it
 11903 00000799 E96EFF                  	jmp	RDBAT		; Ignore if it doesn't
 11904                                  
 11905                                  ; Copy in the found parameter from batch segment
 11906                                  
 11907                                  YES_THERE_IS:
 11908 0000079C 1E                      	push	ds
 11909 0000079D 8E1E[4902]              	mov	ds,[Batch]
 11910 000007A1 49                      	dec	cx		; Don't count '%' in line length
 11911                                  COPYPARM:
 11912 000007A2 AC                      	lodsb			; From resident segment
 11913 000007A3 3C0D                    	cmp	al,0Dh		; Check for end of parameter
 11914 000007A5 740F                    	je	short ENDPARAM
 11915 000007A7 41                      	inc	cx		; Inc the line length
 11916 000007A8 81F98000                	cmp	cx,COMBUFLEN ; 128 ; Is it too long?
 11917 000007AC 7303                    	jnb	short LINETOOL	; Yes - handle it, handle it
 11918 000007AE AA                      	stosb
 11919 000007AF EBF1                    	jmp	short COPYPARM
 11920                                  
 11921                                  ; We have copied up to the limit. Stop copying and eat remainder of batch
 11922                                  ; line. We need to make sure that the tooLong code isn't fooled into
 11923                                  ; believing that we are at EOL. Clobber AL too.
 11924                                  
 11925                                  LINETOOL:
 11926 000007B1 30C0                    	xor	al,al
 11927 000007B3 1F                      	pop	ds
 11928 000007B4 EBB2                    	jmp	short TOOLONG
 11929                                  
 11930                                  ; We have copied in an entire parameter. Go back for more
 11931                                  
 11932                                  ENDPARAM:
 11933 000007B6 1F                      	pop	ds
 11934 000007B7 E950FF                  	jmp	RDBAT
 11935                                  
 11936                                  ; We have found % followed by something other than 0-9. We presume that there
 11937                                  ; will be a following % character. In between is an environment variable that
 11938                                  ; we will fetch and replace in the batch line with its value.
 11939                                  
 11940                                  NEEDENV:
 11941                                  	; MSDOS 6.0 COMMAND.COM
 11942                                  	; 05/02/2023 
 11943 000007BA 49                      	dec     cx 		;AN070; Don't count "%"
 11944                                  
 11945                                  	; MSDOS 3.3 (& MSDOS 6.0)
 11946 000007BB 1E                      	push	ds
 11947 000007BC 57                      	push	di
 11948                                  				; temp spot for name
 11949 000007BD BF[1C9D]                	mov	di,ID
 11950 000007C0 0430                    	add	al,'0'		; reconvert character
 11951 000007C2 AA                      	stosb			; store it in appropriate place
 11952                                  
 11953                                  ; loop getting characters until the next % is found or until EOL
 11954                                  
 11955                                  GETENV1:
 11956 000007C3 E8B902                  	call	GETBATBYT	; get the byte
 11957 000007C6 AA                      	stosb			; store it
 11958 000007C7 3C0D                    	cmp	al,0Dh		; EOL?
 11959 000007C9 7514                    	jne	short GETENV15	; no, see if it the term char
 11960                                  
 11961                                  ; The user entered a string with a % but no trailing %. We copy the string.
 11962                                  
 11963 000007CB 26C645FF00              	mov	byte [es:di-1],0 ; nul terminate the string
 11964 000007D0 BE[1C9D]                	mov	si,ID 		; point to buffer
 11965 000007D3 5F                      	pop	di		; point to line buffer
 11966 000007D4 0E                      	push	cs
 11967 000007D5 1F                      	pop	ds
 11968 000007D6 E89302                  	call	STRCPY
 11969                                  	; 05/02/2023
 11970 000007D9 72D6                    	jc	short LINETOOL	;  MSDOS 6.0 COMMAND.COM
 11971                                  	; 24/04/2023
 11972                                  	;dec	di  		;  MSDOS 3.3 COMMAND.COM	
 11973 000007DB 1F                      	pop	ds
 11974 000007DC E94AFF                  	jmp	SAVBATBYT
 11975                                  GETENV15:
 11976 000007DF 3C25                    	cmp	al,'%'		; terminating %?
 11977 000007E1 75E0                    	jne	short GETENV1	; no, go suck out more characters
 11978                                  
 11979                                  ; M017 - following DEC is wrong, because we replace the % with a = here.
 11980                                  ; This was the source of bug #1.
 11981                                  ;	dec	cx		;AN070; Don't count "%"
 11982                                  
 11983 000007E3 B03D                    	mov	al,'='		; terminate  with =
 11984 000007E5 268845FF                	mov	[es:di-1],al
 11985                                  
 11986                                  ; ID now either has a =-terminated string which we are to find in the
 11987                                  ; environment or a non =-terminated string which will not be found in the
 11988                                  ; environment.
 11989                                  
 11990                                  GETENV2:
 11991 000007E9 BE[1C9D]                	mov	si,ID
 11992 000007EC 0E                      	push	cs
 11993 000007ED 1F                      	pop	ds		; DS:SI points to name
 11994 000007EE 51                      	push	cx
 11995 000007EF E8C31E                  	call	find_name_in_environment
 11996 000007F2 59                      	pop	cx
 11997 000007F3 06                      	push	es
 11998 000007F4 1F                      	pop	ds
 11999 000007F5 0E                      	push	cs
 12000 000007F6 07                      	pop	es
 12001 000007F7 89FE                    	mov	si,di
 12002 000007F9 5F                      	pop	di		; get back pointer to command line
 12003                                  
 12004                                  ; If the parameter was not found, there is no need to perform any replacement.
 12005                                  ; We merely pretend that we've copied the parameter.
 12006                                  
 12007 000007FA 7203                    	jc	short GETENV6
 12008                                  
 12009                                  ; ES:DI points to command line being built
 12010                                  ; DS:SI points either to nul-terminated environment object AFTER =
 12011                                  
 12012 000007FC E86D02                  	call	STRCPY		; (let RdBat handle overflow)
 12013                                  	; 24/04/2022
 12014                                  	;dec	di 		; MSDOS 3.3 COMMAND.COM
 12015                                  GETENV6:
 12016 000007FF 1F                      	pop	ds
 12017 00000800 E907FF                  	jmp	RDBAT		; go back to batch file
 12018                                  
 12019                                  ; =============== S U B	R O U T	I N E =======================================
 12020                                  
 12021                                  ;   SkipToEOL - read from batch file until end of line
 12022                                  
 12023                                  	; 06/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12024                                  SKIPTOEOL:
 12025 00000803 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
 12026                                  	;jnz	short SKIPTOEOL1  	
 12027                                  	;retn			; no batch file in effect
 12028                                  	
 12029 00000809 7407                    	jz	short SKIPTOEOL2 ; Retro DOS v3.0 COMMAND.COM
 12030                                  SKIPTOEOL1:
 12031 0000080B E87102                  	call	GETBATBYT
 12032 0000080E 3C0D                    	cmp	al,0Dh		; eol character?
 12033 00000810 75F1                    	jnz	short SKIPTOEOL	; no, go eat another
 12034                                  SKIPTOEOL2:
 12035 00000812 C3                      	retn
 12036                                  
 12037                                  ; =============== S U B	R O U T	I N E =======================================
 12038                                  
 12039                                  ;Break	<Allocate and deallocate the transient portion>
 12040                                  
 12041                                  ; Free Transient. Modify ES,AX,flags
 12042                                  
 12043                                  	; 06/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12044                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0708h
 12045                                  
 12046                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 12047                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:081Eh
 12048                                  FREE_TPA:
 12049 00000813 06                      	push	es
 12050 00000814 8E06[539C]              	mov	es,[RESSEG]
 12051 00000818 268E06[5804]            	mov	es,[es:Res_Tpa]
 12052 0000081D B449                    	mov	ah,49h
 12053                                  	;mov	ah,DEALLOC ; 49h
 12054                                  
 12055                                  ; 25/07/2024
 12056                                  ; PCDOS 7.1 COMMAND.COM
 12057                                  %if 0
 12058                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12059                                  			; ES = segment address of area to be freed
 12060                                  %else
 12061 0000081F E898FD                  	call	int_21h_indirect
 12062                                  %endif
 12063                                  
 12064 00000822 07                      	pop	es
 12065 00000823 C3                      	retn
 12066                                  
 12067                                  ; =============== S U B	R O U T	I N E =======================================
 12068                                  
 12069                                  ; Allocate transient. Modify AX,BX,DX,flags
 12070                                  
 12071                                  	; 25/07/2024 - Retro DOS v5.0 COMMAND.COM
 12072                                  	; 06/02/2023
 12073                                  ALLOC_TPA:
 12074 00000824 06                      	push	es
 12075 00000825 8E06[539C]              	mov	es,[RESSEG]
 12076 00000829 BBFFFF                  	mov	bx,0FFFFh 	; Re-allocate the transient	
 12077 0000082C B448                    	mov	ah,48h
 12078                                  	;mov	ah,ALLOC ; 48h
 12079                                  
 12080                                  ; 25/07/2024
 12081                                  ; PCDOS 7.1 COMMAND.COM
 12082                                  %if 0
 12083                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12084                                  			; BX = number of 16-byte paragraphs desired
 12085                                  %else
 12086 0000082E E889FD                  	call	int_21h_indirect
 12087                                  %endif
 12088                                  
 12089 00000831 53                      	push	bx	  	; Save size of block
 12090 00000832 B448                    	mov	ah,48h
 12091                                  	;mov	ah,ALLOC ; 48h
 12092                                  
 12093                                  ; 25/07/2024
 12094                                  ; PCDOS 7.1 COMMAND.COM
 12095                                  %if 0
 12096                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12097                                  			; BX = number of 16-byte paragraphs desired
 12098                                  %else
 12099 00000834 E883FD                  	call	int_21h_indirect
 12100                                  %endif
 12101                                  
 12102                                  ; Attempt to align TPA on 64K boundary
 12103                                  
 12104 00000837 5B                      	pop	bx		; Restore size of block
 12105 00000838 26A3[5804]              	mov	[es:Res_Tpa],ax
 12106                                  				; Save segment to beginning of block
 12107 0000083C A3[639C]                	mov	[TRAN_TPA],ax
 12108                                  
 12109                                  ; Is the segment already aligned on a 64K boundary
 12110                                  
 12111 0000083F 89C2                    	mov	dx,ax		; Save segment
 12112 00000841 25FF0F                  	and	ax,0FFFh	; Test if above boundary
 12113 00000844 7507                    	jnz	short CALC_TPA
 12114 00000846 89D0                    	mov	ax,dx
 12115 00000848 2500F0                  	and	ax,0F000h	; Test if multiple of 64K
 12116 0000084B 7523                    	jnz	short NOROUND
 12117                                  CALC_TPA:
 12118 0000084D 89D0                    	mov	ax,dx
 12119 0000084F 2500F0                  	and	ax,0F000h
 12120 00000852 050010                  	add	ax,1000h	; Round up to next 64K boundary
 12121 00000855 7219                    	jc	short NOROUND	; Memory wrap if carry set
 12122                                  
 12123                                  ; Make sure that new boundary is within allocated range
 12124                                  
 12125 00000857 268B16[5804]            	mov	dx,[es:Res_Tpa]
 12126 0000085C 01DA                    	add	dx,bx		; Compute maximum address
 12127 0000085E 39C2                    	cmp	dx,ax		; Is 64K address out of range?
 12128 00000860 720E                    	jb	short NOROUND
 12129                                  
 12130                                  ; Make sure that we won't overwrite the transient
 12131                                  
 12132 00000862 8CCB                    	mov	bx,cs		; CS is beginning of transient
 12133 00000864 39C3                    	cmp	bx,ax
 12134 00000866 7208                    	jb	short NOROUND
 12135                                  
 12136                                  ; The area from the 64K boundary to the beginning of the transient must
 12137                                  ; be at least 64K.
 12138                                  
 12139 00000868 29C3                    	sub	bx,ax
 12140                                  	;cmp	bx,4096
 12141 0000086A 81FB0010                	cmp	bx,1000h	; Size greater than 64K?	
 12142 0000086E 7304                    	jnb	short ROUNDDONE
 12143                                  NOROUND:
 12144 00000870 26A1[5804]              	mov	ax,[es:Res_Tpa]
 12145                                  ROUNDDONE:
 12146 00000874 26A3[4C04]              	mov	[es:LTpa],ax	; Re-compute everything
 12147 00000878 A3[559C]                	mov	[TPA],ax
 12148 0000087B 89C3                    	mov	bx,ax
 12149 0000087D 8CC8                    	mov	ax,cs
 12150 0000087F 29D8                    	sub	ax,bx
 12151 00000881 53                      	push	bx
 12152 00000882 BB1000                  	mov	bx,16
 12153 00000885 F7E3                    	mul	bx
 12154 00000887 5B                      	pop	bx
 12155 00000888 09D2                    	or	dx,dx
 12156 0000088A 7403                    	jz	short SAVSIZ2
 12157 0000088C B8FFFF                  	mov	ax,-1
 12158                                  SAVSIZ2:
 12159                                  
 12160                                  ; AX is the number of bytes free in the buffer between the resident and the
 12161                                  ; transient with a maximum of 64K-1. We round this down to a multiple of 512.
 12162                                  
 12163 0000088F 3D0002                  	cmp	ax,512
 12164 00000892 7603                    	jbe	short GOTSIZE2
 12165                                  	;and	ax,~1FFh
 12166 00000894 2500FE                  	and	ax,0FE00h	; NOT 511 = NOT 1FFh
 12167                                  GOTSIZE2:
 12168 00000897 A3[749C]                	mov	[BYTCNT],ax
 12169 0000089A 07                      	pop	es
 12170 0000089B C3                      	retn
 12171                                  
 12172                                  ; =============== S U B	R O U T	I N E =======================================
 12173                                  
 12174                                  ;Break	<BatCom - enter a batch file>
 12175                                  
 12176                                  ; The exec search has determined that the user has requested a batch file for
 12177                                  ; execution. We parse the arguments, create the batch segment, and signal
 12178                                  ; batch processing.
 12179                                  
 12180                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12181                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:078Eh
 12182                                  
 12183                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 12184                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0868h
 12185                                  
 12186                                  	; 18/07/2024 - Retro DOS 5.0 COMMAND.COM
 12187                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:08A7h
 12188                                  
 12189                                  BATCOM:	
 12190                                  
 12191                                  ;ASSUME	DS:TRANGROUP, ES:NOTHING
 12192                                  
 12193                                  ; Batch parameters are read with ES set to segment of resident part
 12194                                  
 12195                                  	; MSDOS 6.0
 12196 0000089C 8E06[539C]              	mov	es,[RESSEG]
 12197                                  	;ASSUME	ES:RESGROUP
 12198                                  	;cmp	byte [es:Call_Batch_Flag],1
 12199 000008A0 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12200                                  					;AN043; If in CALL,
 12201 000008A6 7403                    	jz	short skip_ioset	;AN043; redirection was already set up
 12202                                  	;invoke	IOSET			; Set up any redirection
 12203 000008A8 E80327                  	call	IOSET
 12204                                  skip_ioset:				;AN043;
 12205 000008AB E865FF                  	call	FREE_TPA		; G
 12206                                  	;cmp	byte [es:Call_Batch_Flag],1
 12207 000008AE 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12208 000008B4 7403                    	jz	short GETECHO 		; G if we're in a call, don't execute
 12209                                  
 12210                                  	; 12/02/2023
 12211                                  	; MSDOS 3.3
 12212                                  	;call	IOSET
 12213                                  	;mov	es,[RESSEG]
 12214                                  	;call	FREE_TPA
 12215                                  	;;cmp	byte [es:CALL_BATCH_FLAG],1
 12216                                  	;cmp	byte [es:CALL_BATCH_FLAG],call_in_progress
 12217                                  	;jz	short GETECHO		; G if we're in a call, don't execute
 12218                                  
 12219                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12220                                  
 12221                                  ; Since BATCH has lower precedence than PIPE or FOR. If a new BATCH file is
 12222                                  ; being started it MUST be true that no FOR or PIPE is currently in progress.
 12223                                  ; Don't execute if in call
 12224                                  
 12225 000008B6 E8A008                  	call	FOROFF
 12226                                  GETECHO:
 12227 000008B9 E8E92A                  	call	PipeOff
 12228 000008BC 26A0[9D02]              	mov	al,[es:EchoFlag]	; preserve echo state for chaining
 12229 000008C0 2401                    	and	al,1			; Save current echo state
 12230                                  
 12231 000008C2 50                      	push	ax
 12232 000008C3 31C0                    	xor	ax,ax
 12233 000008C5 26F706[4902]FFFF        	test	word [es:Batch],-1 	; Are we in a batch file?
 12234 000008CC 7414                    	jz	short LEAVEBAT	   	; No, nothing to save
 12235 000008CE 26A1[4902]              	mov	ax,[es:Batch] 		; Get current batch segment
 12236                                  	;cmp	byte [es:Call_Batch_Flag],1
 12237 000008D2 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12238 000008D8 7408                    	jz	short LEAVEBAT
 12239                                  
 12240                                  ;  We are in a chained batch file, save batlast from previous batch segment
 12241                                  ;  so that if we're in a CALL, we will return to the correct batch file.
 12242                                  
 12243 000008DA 06                      	push	es
 12244 000008DB 8EC0                    	mov	es,ax		; Get current batch segment
 12245                                  	;mov	ax,[es:02h] ; MSDOS 3.3 COMMAND.COM
 12246                                  				; Get previous batch segment
 12247                                  	; 12/02/2023
 12248                                  	;mov	ax,[es:03h] ; MSDOS 6.0 (&5.0) COMMAND.COM	
 12249 000008DD 26A10300                	mov	ax,[es:BATCHSEGMENT.BatLast]
 12250 000008E1 07                      	pop	es
 12251                                  LEAVEBAT:
 12252 000008E2 50                      	push	ax		; Keep segment until new one created
 12253                                  	;cmp	byte [es:Call_Batch_Flag],1
 12254 000008E3 26803E[B102]01          	cmp	byte [es:Call_Batch_Flag],call_in_progress
 12255 000008E9 7403                    	jz	short STARTBAT
 12256 000008EB E82401                  	call	BATCHOFF
 12257                                  
 12258                                  ; Find length of batch file
 12259                                  
 12260                                  STARTBAT:
 12261 000008EE 26C606[B102]00          	mov	byte [es:Call_Batch_Flag],0 ; Reset call flag
 12262 000008F4 BE[7B9B]                	mov	si,EXECPATH
 12263                                  
 12264                                  	; 12/02/2023
 12265                                  	; MSDOS 6.0
 12266 000008F7 B811B7                  	mov	ax,0B711h
 12267                                  	;mov	ax,AppendTruename
 12268                                  				;AN042; Get the real path where the batch file
 12269 000008FA CD2F                    	int	2Fh		;AN042;    was found with APPEND
 12270 000008FC B44E                    	mov	ah,4Eh
 12271                                  	;mov	ah,Find_First	;AN042; The find_first will return it
 12272 000008FE 89F2                    	mov	dx,si		;AN042; Get the string
 12273 00000900 B91300                  	mov	cx,13h
 12274                                  	;mov	cx,search_attr	;AN042; filetypes to search for
 12275                                  	
 12276                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12277                                  %if 0
 12278                                  	int	21h		;AN042;
 12279                                  %else
 12280 00000903 E8B4FC                  	call	int_21h_indirect
 12281                                  %endif
 12282                                  
 12283                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12284 00000906 E89427                  	call	dstrlen
 12285                                  ;
 12286                                  ; Allocate batch area:
 12287                                  ;   BYTE    type of segment
 12288                                  ;   WORD    segment of last batch file
 12289                                  ;   WORD    segment for FOR command
 12290                                  ;   BYTE    FOR flag state on entry to batch file
 12291                                  ;   DWORD   offset for next line
 12292                                  ;   10 WORD pointers to parameters.  -1 is empty parameter
 12293                                  ;   ASCIZ   file name (with . and ..)
 12294                                  ;   BYTES   CR-terminated parameters
 12295                                  ;   BYTE    0 flag to indicate end of parameters
 12296                                  ;
 12297                                  ; We allocate the maximum size for the command line and use setblock to shrink
 12298                                  ; later when we've squeezed out the extra
 12299                                  ;
 12300 00000909 89CB                    	mov	bx,cx		; length of file name.
 12301                                  	;add	bx,190	; MSDOS 3.3 (BATCHSEGMENT struc size = 32)
 12302                                  	; 12/02/2023
 12303                                  	;add	bx,191	; MSDOS 6.0 (BATCHSEGMENT struc size = 33)
 12304                                  			; PCDOS 7.1 ; 26/07/2024
 12305                                   	; 25/04/2023
 12306 0000090B 81C3BF00                	add	bx,15+BATCHSEGMENT.SIZE+COMBUFLEN+15
 12307                                  					; structure + max len + round up
 12308 0000090F 51                      	push	cx
 12309 00000910 B104                    	mov	cl,4
 12310 00000912 D3EB                    	shr	bx,cl		; convert to paragraphs
 12311 00000914 53                      	push	bx		; Save size of batch segment
 12312 00000915 B448                    	mov	ah,48h
 12313                                  	;mov	ah,ALLOC ; 48h ; Allocate batch segment
 12314                                  
 12315                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12316                                  %if 0
 12317                                  	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 12318                                  				; BX = number of 16-byte paragraphs desired
 12319                                  %else
 12320 00000917 E8A0FC                  	call	int_21h_indirect
 12321                                  %endif
 12322                                  
 12323 0000091A 5B                      	pop	bx		; Get size of batch segment
 12324                                  
 12325                                  ; This should *NEVER* return an error. The transient is MUCH bigger than
 12326                                  ; the batch segment. This may not be true, however, in a multitasking system.
 12327                                  ; G This error will occur with nesting of batch files. We also need to
 12328                                  ; G make sure that we don't overlay the transient.
 12329                                  
 12330 0000091B 7222                    	jc	short MEM_ERROR	;G not enough memory - exit
 12331                                  
 12332 0000091D 50                      	push	ax		;G save batch segment
 12333 0000091E 01D8                    	add	ax,bx		;G get end of batch segment
 12334 00000920 83C020                  	add	ax,20h		;G add some tpa work area
 12335 00000923 8CCB                    	mov	bx,cs		;G get the transient segment
 12336                                  
 12337                                  	; MSDOS 6.0
 12338                                  ; M006; We cant check just for above. If the batchseg goes into a UMB, the
 12339                                  ; M006; batchseg is always above the transient. We need to change this code
 12340                                  ; M006; to only check for an overlap
 12341                                  
 12342                                  	;;mov	dx,offset TRANGROUP:TranSpaceEnd ; M006
 12343                                  	; 12/02/2023
 12344                                  	;;mov	dx,98C5h ; MSDOS 5.0 COMMAND.COM
 12345                                  	; 18/07/2024
 12346                                  	;mov	dx,0AA9Ah ; PCDOS 7.1 COMMAND.COM
 12347                                  	;mov	dx,TRANSPACEEND		
 12348                                  	;add	dx,15		;round up para; M006
 12349 00000925 BA7AA6                  	mov	dx,TRANSPACEEND+15
 12350                                  
 12351 00000928 D3EA                    	shr	dx,cl		;para size of transient; M006
 12352 0000092A 01DA                    	add	dx,bx		;dx = top of transient; M006
 12353                                  
 12354 0000092C 39D8                    	cmp	ax,bx		; M006
 12355 0000092E 7212                    	jb	short ENOUGH_MEM
 12356                                  				; Batchseg below transient
 12357                                  				; enough memory ; M006
 12358 00000930 39D0                    	cmp	ax,dx		; M006
 12359 00000932 770E                    	ja	short ENOUGH_MEM	
 12360                                  				; Batchseg above transient
 12361                                  				; enough memory ; M006
 12362                                  
 12363                                  ; M006; Batchseg overlaps transient -- insufficient memory
 12364                                  
 12365 00000934 58                      	pop	ax		; restore ax; M006
 12366                                  
 12367                                  	; 12/02/2023
 12368                                  	; MSDOS 3.3
 12369                                  ; M006;	cmp	ax,bx		;G do we end before the transient
 12370                                  ; M006;	pop	ax		;G get batch segment back
 12371                                  ; M006;	jb	short ENOUGH_MEM ;G we have enough memory - continue
 12372                                  
 12373                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12374 00000935 06                      	push	es		;G no we're hitting the transient
 12375 00000936 8EC0                    	mov	es,ax
 12376 00000938 B80049                  	mov	ax,4900h
 12377                                  	;mov	ax,DEALLOC*256 ; 4900h ;G deallocate the batch segment
 12378                                  
 12379                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12380                                  %if 0
 12381                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12382                                  			; ES = segment address of area to be freed
 12383                                  %else
 12384 0000093B E87CFC                  	call	int_21h_indirect
 12385                                  %endif
 12386                                  
 12387 0000093E 07                      	pop	es
 12388                                  MEM_ERROR:
 12389 0000093F E9B900                  	jmp	NO_MEMORY	;G Set up for message and exit
 12390                                  
 12391                                  ENOUGH_MEM:
 12392                                  	; 12/02/2023 - Retro DOS v4.0 COMMAND.COM
 12393                                  	; MSDOS 6.0
 12394 00000942 58                      	pop	ax		; restore ax; M006
 12395                                  
 12396                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12397 00000943 26A3[4902]              	mov	[es:Batch],ax
 12398 00000947 E8DAFE                  	call	ALLOC_TPA
 12399                                  
 12400                                  ; Initialize batch segment
 12401                                  
 12402 0000094A 5A                      	pop	dx		; length of name
 12403 0000094B 58                      	pop	ax		;G get saved batch segment back
 12404 0000094C 26FF06[AE02]            	inc	word [es:Nest]	;G increment # batch files in progress
 12405 00000951 06                      	push	es
 12406 00000952 268E06[4902]            	mov	es,[es:Batch]
 12407                                  	;mov	byte [ES:0],0
 12408                                  				; signal batch file type
 12409 00000957 26C606000000            	mov	byte [es:BATCHSEGMENT.BatType],BATCHTYPE ; 0
 12410                                  	;;mov	[es:2],ax	; MSDOS 3.3
 12411                                  				;G save segment of last batch file
 12412                                  	;mov	[es:3],ax	; MSDOS 6.0
 12413 0000095D 26A30300                	mov	[es:BATCHSEGMENT.BatLast],ax
 12414 00000961 1E                      	push	ds
 12415 00000962 8E1E[539C]              	mov	ds,[RESSEG]	;G set to resident data
 12416                                  
 12417 00000966 31C0                    	xor	ax,ax
 12418 00000968 8A1E[AB02]              	mov	bl,[ForFlag]	;G get the current FOR state
 12419                                  	;;mov	[es:6],bl	; MSDOS 3.3
 12420                                  				;G save it in the batch segment
 12421                                  	;mov	[es:7],bl	; MSDOS 6.0 	
 12422 0000096C 26881E0700              	mov	[es:BATCHSEGMENT.BatForFlag],bl
 12423 00000971 F6C3FF                  	test	bl,-1 ; 0FFh	;G are we in a FOR?
 12424 00000974 7406                    	jz	short FOR_NOT_ON ;G no, for segment set to 0	
 12425                                  	;mov	ax,[ForPtr]	;G yes, get current FOR segment	
 12426                                  	;mov	byte [ForFlag],0 ;G reset forflag
 12427                                  	; 26/07/2024
 12428 00000976 A2[AB02]                	mov	[ForFlag],al ; 0
 12429 00000979 A1[AC02]                	mov	ax,[ForPtr]	;G yes, get current FOR segment	
 12430                                  FOR_NOT_ON:
 12431                                  	;;mov	[es:4],ax	; MSDOS 3.3
 12432                                  				;G save FOR segment in batch segment
 12433                                  	;mov	[es:5],ax	; MSDOS 6.0		
 12434 0000097C 26A30500                	mov	[es:BATCHSEGMENT.BatForPtr],ax	
 12435 00000980 31C0                    	xor	ax,ax
 12436 00000982 A3[AC02]                	mov	[ForPtr],ax	;G make sure for segment is not active
 12437 00000985 8A1E[9D02]              	mov	bl,[EchoFlag]
 12438 00000989 1F                      	pop	ds
 12439                                  	;mov	[es:1],bl 
 12440                                  				 ;G save echo state of parent
 12441 0000098A 26881E0100              	mov	[es:BATCHSEGMENT.BatEchoFlag],bl
 12442                                  ;SR;
 12443                                  ; Initialize the new BatchEOF flag we have added to 0
 12444                                  
 12445                                  	; MSDOS 6.0
 12446                                  	;mov	byte [es:2],0
 12447 0000098F 26C606020000            	mov	byte [es:BATCHSEGMENT.BatchEOF],0
 12448                                  
 12449                                  	;mov	[es:08h],ax  ; MSDOS 6.0
 12450 00000995 26A30800                	mov	[es:BATCHSEGMENT.BatSeek],ax ; point to beginning of file
 12451                                  	;mov	[es:0Ah],ax  ; MSDOS 6.0	
 12452 00000999 26A30A00                	mov	[es:BATCHSEGMENT.BatSeek+2],ax
 12453                                  
 12454                                  ; Initialize pointers
 12455                                  
 12456 0000099D 48                      	dec	ax		; put -1 into AX
 12457                                  	;;mov	di,0Bh  ; MSDOS 3.3
 12458                                  				; point to parm area
 12459                                  	;mov	di,0Ch	; MSDOS 6.0
 12460 0000099E BF0C00                  	mov	di,BATCHSEGMENT.BatParm
 12461 000009A1 89FB                    	mov	bx,di
 12462 000009A3 B90A00                  	mov	cx,10
 12463 000009A6 F3AB                    	rep stosw		; Init to no parms
 12464                                  
 12465                                  ; Move in batch file name
 12466                                  
 12467 000009A8 89D1                    	mov	cx,dx
 12468 000009AA F3A4                    	rep	movsb
 12469                                  
 12470                                  ; Now copy the command line into batch segment, parsing the arguments along
 12471                                  ; the way. Segment will look like this:
 12472                                  ;
 12473                                  ;   <arg0>CR<arg1>CR...<arg9>CR<arg10>CR...<ARGn>CR 0
 12474                                  ;
 12475                                  ; or, in the case of fewer arguments:
 12476                                  ;
 12477                                  ;   <arg0>CR<arg1>CR...<arg6>CR CR CR ... CR 0
 12478                                  
 12479 000009AC BE[B49A]                	mov	si,COMBUF+2
 12480                                  	;mov	cx,10		; at most 10 arguments
 12481                                  	; 07/06/2023
 12482 000009AF B10A                    	mov	cl,10
 12483                                  EACHPARM:
 12484 000009B1 E8D01F                  	call	scanoff		; skip to argument
 12485                                  
 12486                                  ; AL is first non-delimiter. DS:SI points to char = AL
 12487                                  
 12488 000009B4 3C0D                    	cmp	al,0Dh		; end of road?
 12489 000009B6 741D                    	jz	short HAVPARM	; yes, no more arguments
 12490                                  
 12491                                  ; If CX = 0 then we have stored the most parm we can. Skip store
 12492                                  
 12493 000009B8 E306                    	jcxz	MOVPARM		; Only first 10 parms get pointers
 12494                                  
 12495                                  ; Go into allocated piece and stick in new argument pointer.
 12496                                  
 12497 000009BA 26893F                  	mov	[es:bx],di	; store batch pointer
 12498 000009BD 83C302                  	add	bx,2		; advance arg counter
 12499                                  
 12500                                  ; Move the parameter into batch segment
 12501                                  
 12502                                  MOVPARM:
 12503 000009C0 AC                      	lodsb			; get byte
 12504 000009C1 E8C81F                  	call	DELIM		; if delimiter
 12505 000009C4 7407                    	jz	short ENDPARM	; then done with parm
 12506 000009C6 AA                      	stosb			; store byte
 12507 000009C7 3C0D                    	cmp	al,0Dh		; if CR then not delimiter
 12508 000009C9 740A                    	jz	short HAVPARM	; but end of parm list, finish
 12509 000009CB EBF3                    	jmp	short MOVPARM
 12510                                  
 12511                                  ; We have copied a parameter up until the first separator.
 12512                                  ; Terminate it with CR.
 12513                                  
 12514                                  ENDPARM:
 12515 000009CD B00D                    	mov	al,0Dh
 12516 000009CF AA                      	stosb
 12517 000009D0 E3DF                    	jcxz	EACHPARM	; if no parameters, don't dec
 12518 000009D2 49                      	dec	cx		; remember that we've seen one.	
 12519 000009D3 EBDC                    	jmp	short EACHPARM
 12520                                  
 12521                                  ; We have parsed the entire line. Terminate the arg list
 12522                                  
 12523                                  HAVPARM:
 12524 000009D5 30C0                    	xor	al,al		; Nul terminate the parms
 12525 000009D7 AA                      	stosb
 12526                                  
 12527                                  ; Now we know EXACTLY how big the BATCH segment is. Round up size (from DI)
 12528                                  ; into paragraphs and setblock to the appropriate size
 12529                                  
 12530 000009D8 8D5D0F                  	lea	bx,[di+15]
 12531 000009DB B104                    	mov	cl,4
 12532 000009DD D3EB                    	shr	bx,cl
 12533 000009DF B44A                    	mov	ah,4Ah
 12534                                  	;mov	ah,SETBLOCK ; 4Ah
 12535                                  
 12536                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12537                                  %if 0
 12538                                  	int	21h	; DOS -	2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 12539                                  			; ES = segment address of block	to change
 12540                                  			; BX = new size	in paragraphs
 12541                                  %else
 12542 000009E1 E8D6FB                  	call	int_21h_indirect
 12543                                  %endif
 12544                                  
 12545 000009E4 07                      	pop	es
 12546 000009E5 06                      	push	es
 12547 000009E6 1F                      	pop	ds		; Simply batch FCB setup
 12548 000009E7 833E[A502]FF            	cmp	word [SingleCom],-1 ; 0FFFFh
 12549 000009EC 7506                    	jne	short NOBATSING
 12550 000009EE C706[A502]F0FF          	mov	word [SingleCom],0FFF0h ; Flag single command BATCH job
 12551                                  
 12552                                  NOBATSING:
 12553                                  
 12554                                  ; Enter the batch file with the current echo state
 12555                                  
 12556 000009F4 58                      	pop	ax		; Get original echo state
 12557 000009F5 A2[9D02]                	mov	[EchoFlag],al	; restore it
 12558 000009F8 E909F7                  	jmp	TCOMMAND
 12559                                  
 12560                                  ; The following is executed if there isn't enough memory for batch segment
 12561                                  
 12562                                  NO_MEMORY:
 12563 000009FB 5A                      	pop	dx		; even up our stack 
 12564 000009FC 58                      	pop	ax
 12565 000009FD 58                      	pop	ax
 12566 000009FE E823FE                  	call	ALLOC_TPA	; reallocate memory
 12567                                  
 12568                                  	; 12/02/2023
 12569                                  	; MSDOS 3.3
 12570                                  	;mov	dx,INSFMEMMESPTR
 12571                                  	;jmp	CERROR
 12572                                  
 12573                                  	; MSDOS 6.0
 12574                                  	;mov	byte [msg_disp_class],1
 12575 00000A01 C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 12576                                  				;AN000; set up extended error msg class
 12577                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 12578 00000A06 BA[CB8F]                	mov	dx,extend_buf_ptr
 12579                                  	;			;AC000; get extended message pointer
 12580                                  	;mov	word [extend_buf_ptr],8
 12581 00000A09 C706[CB8F]0800          	mov	word [extend_buf_ptr],ERROR_NOT_ENOUGH_MEMORY
 12582                                  				;AN000; get message number in control block
 12583 00000A0F E91223                  	jmp	cerror		;g print error message and go...
 12584                                  
 12585                                  ; =============== S U B	R O U T	I N E =======================================
 12586                                  
 12587                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12588                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 12589                                  BATCHOFF:
 12590 00000A12 50                      	push	ax
 12591 00000A13 06                      	push	es
 12592 00000A14 1E                      	push	ds
 12593 00000A15 53                      	push	bx
 12594                                  
 12595 00000A16 2E8E06[539C]            	mov	es,[cs:RESSEG]
 12596                                  	;mov	ds,[cs:RESSEG]
 12597                                  	; 26/07/2024
 12598 00000A1B 06                      	push	es
 12599 00000A1C 1F                      	pop	ds
 12600                                  
 12601 00000A1D A1[4902]                	mov	ax,[Batch]	; Free the batch segment
 12602 00000A20 09C0                    	or	ax,ax
 12603 00000A22 7443                    	jz	short NOTFREE
 12604                                  
 12605 00000A24 06                      	push	es
 12606 00000A25 8EC0                    	mov	es,ax
 12607 00000A27 F606[9D02]01            	test	byte [EchoFlag],1
 12608                                  				;G Is echo on?
 12609 00000A2C 7505                    	jnz	short ECHO_LAST_LINE
 12610                                  				;G Yes - echo last line in file
 12611                                  	;mov	byte [SUPPRESS],0
 12612 00000A2E C606[9E02]00            	mov	byte [Suppress],NO_ECHO
 12613                                  				;G no - don't echo last line in file	
 12614                                  ECHO_LAST_LINE:
 12615                                  	;mov	bl,[es:1]
 12616 00000A33 268A1E0100              	mov	bl,[es:BATCHSEGMENT.BatEchoFlag]
 12617                                  				; G get echo state
 12618 00000A38 881E[9D02]              	mov	[EchoFlag],bl
 12619                                  				; G  and restore it
 12620                                  	;;mov	bx,[es:4]  ; MSDOS 3.3
 12621                                  	;mov	bx,[es:5]  ; MSDOS 6.0
 12622 00000A3C 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr]
 12623                                  				;G Get FOR segment
 12624 00000A41 891E[AC02]              	mov	[ForPtr],bx	;G  and restore it
 12625                                  	;;mov	bl,[es:6]  ; MSDOS 3.3
 12626                                  	;mov	bl,[es:7]  ; MSDOS 6.0	
 12627 00000A45 268A1E0700              	mov	bl,[es:BATCHSEGMENT.BatForFlag]
 12628                                  				;G Get FOR flag
 12629 00000A4A 881E[AB02]              	mov	[ForFlag],bl
 12630                                  				;G  and restore it
 12631                                  	;;mov	bx,[es:2] ; MSDOS 3.3
 12632                                  	;mov	bx,[es:3] ; MSDOS 6.0	
 12633 00000A4E 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast]
 12634                                  				;G  Get old batch segment
 12635 00000A53 B449                    	mov	ah,49h
 12636                                  	;mov	ah,DEALLOC ; 49h
 12637                                  
 12638                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12639                                  %if 0
 12640                                  	int	21h	; DOS -	2+ - FREE MEMORY
 12641                                  			; ES = segment address of area to be freed
 12642                                  %else
 12643 00000A55 E862FB                  	call	int_21h_indirect
 12644                                  %endif
 12645                                  
 12646 00000A58 07                      	pop	es
 12647 00000A59 891E[B202]              	mov	[Next_Batch],bx	;G reset batch segment	
 12648 00000A5D 26FF0E[AE02]            	dec	word [es:Nest]
 12649 00000A62 31C0                    	xor	ax,ax
 12650 00000A64 A3[4902]                	mov	[Batch],ax	; No batch in progress
 12651                                  NOTFREE:
 12652 00000A67 5B                      	pop	bx
 12653 00000A68 1F                      	pop	ds
 12654 00000A69 07                      	pop	es
 12655 00000A6A 58                      	pop	ax
 12656 00000A6B C3                      	retn
 12657                                  
 12658                                  ; =============== S U B	R O U T	I N E =======================================
 12659                                  
 12660                                  	; 12/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12661                                  
 12662                                  ; StrCpy - copy string, checking count in CX against COMBUFLEN
 12663                                  ;	Entry : DS:SI ==> source string
 12664                                  ;		ES:DI ==> destination string
 12665                                  ;		CX = current length of destination string
 12666                                  ;	Exit  : string copied, CX updated, Carry set if length limit exceeded
 12667                                  
 12668                                  	; 12/02/2023	
 12669                                  	; MSDOS 3.3
 12670                                  ;STRCPY:
 12671                                  	;push	ax
 12672                                  ;CCYCLE:
 12673                                  	;lodsb
 12674                                  	;stosb
 12675                                  	;or	al,al
 12676                                  	;jnz	short CCYCLE
 12677                                  	;pop	ax
 12678                                  	;retn
 12679                                  
 12680                                  ;Procedure StrCpy,NEAR
 12681                                  
 12682                                  	; 12/02/2023
 12683                                  	; MSDOS 6.0
 12684                                  STRCPY:
 12685 00000A6C 50                      	push	ax
 12686                                  ccycle:
 12687 00000A6D AC                      	lodsb
 12688 00000A6E 41                      	inc	cx
 12689                                  	;cmp	cx,128
 12690 00000A6F 81F98000                	cmp	cx,COMBUFLEN
 12691                                  	;jb	short ccopy
 12692                                  	;stc			; set carry to signal error
 12693                                  	;jmp	short ccend
 12694                                  	; 12/02/2023
 12695 00000A73 F5                      	cmc
 12696 00000A74 7205                    	jc	short ccend
 12697                                  ccopy:
 12698 00000A76 AA                      	stosb
 12699 00000A77 08C0                    	or	al,al
 12700 00000A79 75F2                    	jnz	short ccycle
 12701                                  ccend:
 12702 00000A7B 49                      	dec	cx		; discount extra byte
 12703 00000A7C 4F                      	dec	di		; back up pointer
 12704 00000A7D 58                      	pop	ax
 12705 00000A7E C3                      	retn			; return carry clear
 12706                                  
 12707                                  ;EndProc StrCpy
 12708                                  
 12709                                  ;============================================================================
 12710                                  ; TBATCH2.ASM, MSDOS 6.0, 1991
 12711                                  ;============================================================================
 12712                                  ; 12/10/2018 - Retro DOS v3.0
 12713                                  
 12714                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0892h
 12715                                  
 12716                                  ; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12717                                  
 12718                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 0977h
 12719                                  
 12720                                  ; =============== S U B	R O U T	I N E =======================================
 12721                                  
 12722                                  ;Break	<GetBatByt - retrieve a byte from the batch file>
 12723                                  
 12724                                  ; Get one byte from the batch file and return it in AL. End-of-file returns
 12725                                  ; <CR> and ends batch mode. DS must be set to resident segment.
 12726                                  ; AH, DX destroyed.
 12727                                  
 12728                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 12729                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 0A95h
 12730                                  
 12731                                  GETBATBYT:
 12732 00000A7F 53                      	push	bx
 12733 00000A80 51                      	push	cx
 12734 00000A81 1E                      	push	ds
 12735 00000A82 F606[9302]FF            	test	byte [Batch_Abort],-1
 12736                                  	;jnz	short BATEOF
 12737                                  	; 14/02/2023
 12738 00000A87 7403                    	jz	short getbatbyt1
 12739 00000A89 E9D200                  	jmp	BATEOF
 12740                                  getbatbyt1:
 12741 00000A8C F706[4902]FFFF          	test	word [Batch],-1
 12742                                  	;jz	short BATEOF
 12743                                  	; 14/02/2023
 12744 00000A92 7503                    	jnz	short getbatbyt2
 12745 00000A94 E9C700                  	jmp	BATEOF
 12746                                  getbatbyt2:
 12747 00000A97 06                      	push	es
 12748 00000A98 8E06[4902]              	mov	es,[Batch]
 12749                                  
 12750                                  	; MSDOS 6.0
 12751                                  ;M020;
 12752                                  ;Check if we have already reached EOF (BatchEOF flag set. Then, we do not
 12753                                  ;try to read from the batchfile again.
 12754                                  
 12755                                  	;cmp	byte [es:2],0
 12756 00000A9C 26803E020000            	cmp	byte [es:BATCHSEGMENT.BatchEOF],0
 12757                                  				;already reached EOF?	;M020
 12758 00000AA2 7403                    	jz	short not_eof	;no, read batch file	;M020
 12759 00000AA4 E99D00                  	jmp	At_EOF		;yes, no more reads	;M020
 12760                                  not_eof:						;M020
 12761                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12762                                  	;add	word [es:8],1	; MSDOS 6.0
 12763 00000AA7 268306080001            	add	word [es:BATCHSEGMENT.BatSeek],1
 12764                                  	;adc	word [es:10],0	; MSDOS 6.0
 12765 00000AAD 2683160A0000            	adc	word [es:BATCHSEGMENT.BatSeek+2],0
 12766 00000AB3 07                      	pop	es
 12767                                  
 12768                                  ; See if we have bytes buffered...
 12769                                  
 12770 00000AB4 8CC8                    	mov	ax,cs
 12771 00000AB6 8ED8                    	mov	ds,ax
 12772 00000AB8 8B1E[27A6]              	mov	bx,[BATBUFPOS]
 12773 00000ABC 83FBFF                  	cmp	bx,-1
 12774 00000ABF 7541                    	jnz	short UNBUF
 12775                                  
 12776                                  ; There are no bytes in the buffer. Let's try to fill it up.
 12777                                  
 12778 00000AC1 BA[29A6]                	mov	dx,BATBUF
 12779 00000AC4 8B0E[D895]              	mov	cx,[BATBUFLEN] ; max to read.
 12780 00000AC8 8B1E[539F]              	mov	bx,[BATHAND]
 12781                                  	; 14/02/2023
 12782 00000ACC B43F                    	mov	ah,3Fh
 12783                                  	;mov	ah,READ ; 3Fh	; Get one more byte from batch file
 12784                                  
 12785                                  ; 26/07/2024 - PCDOS 7.1 COMMAND.COM
 12786                                  %if 0
 12787                                  	int	21h	; DOS -	2+ - READ FROM FILE WITH HANDLE
 12788                                  			; BX = file handle,CX = number	of bytes to read
 12789                                  			; DS:DX	-> buffer
 12790                                  %else
 12791 00000ACE E8E9FA                  	call	int_21h_indirect
 12792                                  %endif
 12793                                  
 12794                                  	; MSDOS 6.0
 12795 00000AD1 7321                    	jnc	short bat_read_ok	;AN022; if no error - continue
 12796                                  	;invoke	get_ext_error_number	;AN022; get the error
 12797 00000AD3 E87315                  	call	get_ext_error_number
 12798 00000AD6 1E                      	push	ds			;AN022; save local segment
 12799 00000AD7 8E1E[539C]              	mov	ds,[RESSEG]		;AN022; get resident segment
 12800                                  	;assume ds:resgroup		;AN022;
 12801 00000ADB 89C2                    	mov	dx,ax			;AN022; put error in DX
 12802                                  	;invoke	output_batch_name	;AN022; set up to print the error
 12803 00000ADD E857FB                  	call	output_batch_name
 12804 00000AE0 1F                      	pop	ds			;AN022;
 12805                                  	;assume	ds:trangroup		;AN022;
 12806                                  	;invoke	std_eprintf		;AN022; print out the error
 12807 00000AE1 E83149                  	call	std_eprintf
 12808                                  	;mov	byte ptr combuf+2,end_of_line_in
 12809 00000AE4 C606[B49A]0D            	mov	byte [COMBUF+2],END_OF_LINE_IN ; 0Dh
 12810                                  	;				;AN022; terminate the batch line for parsing
 12811                                  	;mov	byte ptr combuf+3,end_of_line_out 
 12812 00000AE9 C606[B59A]00            	mov	byte [COMBUF+3],END_OF_LINE_OUT ; 0
 12813                                  	;				;AN022; terminate the batch line for output
 12814                                  ;M020;
 12815                                  ;Old bug! We jump to BatEof from here without ds=RESGROUP. Probably, this
 12816                                  ;error is never hit (and it shouldn't be)
 12817                                  
 12818 00000AEE 8E1E[539C]              	mov	ds,[RESSEG]		; ds = RESGROUP ; M020
 12819 00000AF2 EB6A                    	jmp	short BATEOF		;AN022; terminate the batch file
 12820                                  bat_read_ok:				;AN022;
 12821                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12822 00000AF4 89C1                    	mov	cx,ax
 12823                                  	;jcxz	TURN_OFF ; MSDOS 3.3
 12824                                  	; 14/02/2023
 12825 00000AF6 E320                    	jcxz	BATEOFDS ; MSDOS 6.0
 12826 00000AF8 890E[49A6]              	mov	[BATBUFEND],cx
 12827 00000AFC 31DB                    	xor	bx,bx
 12828 00000AFE 891E[27A6]              	mov	[BATBUFPOS],bx
 12829                                  
 12830                                  	; Buffered bytes!
 12831                                  UNBUF:
 12832 00000B02 8A87[29A6]              	mov	al,[BATBUF+bx]		; get next byte
 12833 00000B06 43                      	inc	bx
 12834 00000B07 3B1E[49A6]              	cmp	bx,[BATBUFEND]		; beyond end of buffer?
 12835 00000B0B 7203                    	jb	short SETBUFPOS
 12836 00000B0D BBFFFF                  	mov	bx,-1
 12837                                  SETBUFPOS:
 12838 00000B10 891E[27A6]              	mov	[BATBUFPOS],bx
 12839 00000B14 3C1A                    	cmp	al,1Ah			; ^Z for termination?
 12840 00000B16 7575                    	jne	short GETBYTEDONE
 12841                                  
 12842                                  ;We get here only when we hit an EOF
 12843                                  	
 12844                                  	; MSDOS 6.0
 12845                                  BATEOFDS:
 12846                                  ;SR;
 12847                                  ; HACK!!! A massive hack being put in here to get batch processing to work
 12848                                  ;properly on EOF. Previously, a CR was returned and batch processing turned
 12849                                  ;off the moment we hit an EOF. Unfortunately, if the last line had no CR-LF,
 12850                                  ;batch processing is turned off before the last line is processed and so 
 12851                                  ;this line would never be executed. 
 12852                                  ;   	To fix this, a new flag BatchEOF has been introduced. This flag is
 12853                                  ;set to 4 if there is no CR-LF before the EOF -- this is determined by looking
 12854                                  ;at the buffer contents. If there is no LF ( we assume that presence of LF
 12855                                  ;indicated a CR-LF combination), then we set BatchEOF to 4 and return a 
 12856                                  ;fake CR to the caller. This decrements BatchEOF. On the next call to this
 12857                                  ;routine, BatchEOF is decremented to 2 and a fake lF is returned. On the 
 12858                                  ;third call, BatchEOF becomes zero and batch processing is turned off,
 12859                                  ;now that the last line has been processed. If the EOF is the first char read into the buffer 
 12860                                  ;during this call, and there was a CR-LF previously, we are going to fake
 12861                                  ;another redundant CR-LF. There is no work-around I can think of.
 12862                                  ; 	I would love to restructure this entire routine and its caller to
 12863                                  ;make the flow really easy to understand but I guess this will have to wait.
 12864                                  ;
 12865 00000B18 06                      	push	es
 12866 00000B19 8E06[539C]              	mov	es,[RESSEG]
 12867                                  ;SR;
 12868                                  ; If we had already set the BatchEOF flag on a previous call (BatchEOF == 2
 12869                                  ;or BatchEOF == 1 now), then do not do the LF check.
 12870                                  ;
 12871 00000B1D 268E06[4902]            	mov	es,[es:Batch]
 12872                                  	;cmp	byte [es:2],0
 12873 00000B22 26803E020000            	cmp	byte [es:BATCHSEGMENT.BatchEOF],0
 12874 00000B28 7516                    	jnz	short crpresent
 12875                                  
 12876                                  	;inc	byte [es:2]
 12877 00000B2A 26FE060200              	inc	byte [es:BATCHSEGMENT.BatchEOF]
 12878                                  					;match the dec following
 12879 00000B2F 8B1E[49A6]              	mov	bx,[BATBUFEND]
 12880 00000B33 80BF[28A6]0A            	cmp	byte [bx+BATBUF-1],0Ah	;was a LF present?
 12881 00000B38 7406                    	je	short crpresent		;yes, no need to fake it
 12882                                  
 12883                                  	;add	byte [es:2],3
 12884 00000B3A 268006020003            	add	byte [es:BATCHSEGMENT.BatchEOF],3
 12885                                  					;BatchEOF == 4 to fake CR-LF
 12886                                  crpresent:
 12887                                  ;;	;pop	es
 12888                                  
 12889                                  	;ASSUME	DS:TranGroup
 12890                                  	; 14/02/2023
 12891 00000B40 8E1E[539C]              	mov	ds,[RESSEG]
 12892                                  	;ASSUME	DS:ResGroup
 12893                                  ;SR;
 12894                                  ; The shift operation is done here to replace the decrement. This is because
 12895                                  ;we can jump to this label directly from above when bogus calls are made to
 12896                                  ;this routine even after batch processing is turned off. The shift ensures
 12897                                  ;maintains the following invariance : 4 -> 2; 2 -> 1 ; 1 -> 0; 0 -> 0. Thus,
 12898                                  ;it is used as a decrement and also as a NOP to just fall through on bogus 
 12899                                  ;calls.
 12900                                  ;	We turn batch processing off if BatchEOF == 1 or BatchEOF == 0.
 12901                                  ;BatchEOF == 1 when we fall through from BatEOFDS and BatchEOF == 0 on a 
 12902                                  ;direct jump to BATEOF. If BatchEOF == 4, we return a fake CR-LF without 
 12903                                  ;turning batch processing off.
 12904                                  
 12905                                  At_EOF:					;new label added ;M020
 12906                                  	;shr	byte [es:2],1
 12907 00000B44 26D02E0200              	shr	byte [es:BATCHSEGMENT.BatchEOF],1
 12908                                  					;decrement the flag
 12909 00000B49 7412                    	jz	short turn_off		;zero,turn batch off
 12910                                  	;cmp	byte [es:2],1
 12911 00000B4B 26803E020001            	cmp	byte [es:BATCHSEGMENT.BatchEOF],1				
 12912 00000B51 7405                    	jz	short ret_lf		;BatchEOF was 2, return LF
 12913                                  ;
 12914                                  ;BatchEOF == 4, indicates return fake CR now and fake LF next.
 12915                                  ;
 12916 00000B53 B00D                    	mov	al,0Dh			;return fake CR.
 12917 00000B55 07                      	pop	es
 12918 00000B56 EB35                    	jmp	short GETBYTEDONE
 12919                                  ret_lf:
 12920 00000B58 B00A                    	mov	al,0Ah			;return fake LF
 12921 00000B5A 07                      	pop	es
 12922 00000B5B EB30                    	jmp	short GETBYTEDONE		
 12923                                  turn_off:
 12924 00000B5D 07                      	pop	es
 12925                                  ;BATEOF:
 12926                                  	; MSDOS 3.3
 12927                                  ;TURN_OFF:
 12928                                  	;mov	ds,[RESSEG]
 12929                                  
 12930                                  	; MSDOS 3.3 (& MSDOS 6.0)
 12931                                  BATEOF:
 12932 00000B5E E8B1FE                  	call	BATCHOFF
 12933 00000B61 E8CC02                  	call	BATCLOSE
 12934                                  
 12935                                  ;;;	mov	BatchEOF,0	;make sure BatchEOF = 0
 12936                                  
 12937                                  ;SR; BugBug
 12938                                  ; There is a good reason why this carriage return is being returned here. 
 12939                                  ;This was part of the old code, thanks to some brain-damaged coding. Because,
 12940                                  ;of the way the caller is structured, a fake CR has to be returned again on
 12941                                  ;EOF to ensure the termination of the caller's loop. If echo is on, this
 12942                                  ;results in an extra linefeed after the batchfile is run if the last line of
 12943                                  ;the batchfile already had a CR-LF. 
 12944                                  ;NB: Do not confuse this with the faked CR. The fake CR-LF was to mark
 12945                                  ;the end-of-line. This CR is to mark the end-of-file.
 12946                                  
 12947 00000B64 B00D                    	mov	al,0Dh			; If end-of-file, then end of line
 12948 00000B66 F606[9302]FF            	test	byte [Batch_Abort],-1
 12949 00000B6B C606[9302]00            	mov	byte [Batch_Abort],0
 12950 00000B70 7407                    	jz	short CONT_GET_BYT
 12951 00000B72 BF[B49A]                	mov	di,COMBUF+2		; reset pointer to beginning of buffer
 12952 00000B75 31C9                    	xor	cx,cx			; zero line length
 12953 00000B77 EB14                    	jmp	short GETBYTEDONE
 12954                                  CONT_GET_BYT:
 12955 00000B79 833E[A502]F0            	cmp	word [SingleCom],0FFF0h ; See if we need to set SINGLECOM
 12956 00000B7E 750D                    	jne	short GETBYTEDONE
 12957 00000B80 833E[AE02]00            	cmp	word [Nest],0		;G See if we have nested batch files
 12958 00000B85 7506                    	jnz	short GETBYTEDONE	;G Yes - don't exit just yet
 12959 00000B87 C706[A502]FFFF          	mov	word [SingleCom],0FFFFh	; -1 ; Cause termination
 12960                                  GETBYTEDONE:
 12961 00000B8D 1F                      	pop	ds
 12962 00000B8E 59                      	pop	cx
 12963 00000B8F 5B                      	pop	bx
 12964 00000B90 C3                      	retn
 12965                                  
 12966                                  ; ---------------------------------------------------------------------------
 12967                                  
 12968                                  ;break	<$If - conditional execution>
 12969                                  
 12970                                  	; 17/04/2023
 12971                                  ;IFERRORP:
 12972                                  ;	pop	ax
 12973                                  ;IFERROR:
 12974                                  ;	; 14/02/2023 - Retro DOS v4.0 COMMAND.COM
 12975                                  ;FORERROR:
 12976                                  ;	mov	dx,SYNTMES_PTR
 12977                                  ;	jmp	cerror
 12978                                  
 12979                                  ; ---------------------------------------------------------------------------
 12980                                  
 12981                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 12982                                  	;
 12983                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 12984                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0B69h
 12985                                  
 12986                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 12987                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0BAEh
 12988                                  _$IF:
 12989                                  	; MSDOS 6.0
 12990                                  ; Turn off any pipes in progress.
 12991 00000B91 1E                      	push	ds			;AN004; save local DS
 12992 00000B92 8E1E[539C]              	mov	ds,[RESSEG]		;AN004; get resident segment
 12993                                  	;assume	ds:resgroup		;AN004;
 12994 00000B96 803E[1403]00            	cmp	byte [PipeFiles],0	;AN004; Only turn off if present.
 12995 00000B9B 7403                    	jz	short IFNoPipe		;AN004; no pipe - continue
 12996                                  	;invoke	PipeDel 		;AN004; turn off piping
 12997 00000B9D E87E25                  	call	PIPEDEL	
 12998                                  IFNoPipe:				;AN004;
 12999 00000BA0 1F                      	pop	ds			;AN004; get local DS back
 13000                                  	;assume	ds:trangroup		;AN004;
 13001                                  
 13002                                  	; MSDOS 3.3 (&MSDOS 6.0)
 13003 00000BA1 C606[669C]00            	mov	byte [IFNOTFLAG],0
 13004 00000BA6 C706[FBA4]0000          	mov	word [IF_NOT_COUNT],0
 13005 00000BAC BE8100                  	mov	si,81h
 13006                                  IFREENT:
 13007 00000BAF E8D21D                  	call	scanoff
 13008 00000BB2 3C0D                    	cmp	al,0Dh
 13009 00000BB4 743C                    	je	short IFERROR
 13010 00000BB6 89F5                    	mov	bp,si
 13011 00000BB8 BF[2794]                	mov	di,IFTAB		; Prepare to search if table	
 13012                                  	;mov	ch,0
 13013                                  	; 17/04/2023
 13014 00000BBB 30ED                    	xor	ch,ch
 13015                                  IFINDCOM:
 13016 00000BBD 89EE                    	mov	si,bp
 13017 00000BBF 8A0D                    	mov	cl,[di]
 13018 00000BC1 47                      	inc	di
 13019 00000BC2 E33E                    	jcxz	IFSTRING
 13020 00000BC4 EB02                    	jmp	short FIRSTCOMP
 13021                                  IFCOMP:
 13022 00000BC6 7510                    	jnz	short IF_DIF
 13023                                  FIRSTCOMP:
 13024 00000BC8 AC                      	lodsb
 13025 00000BC9 268A25                  	mov	ah,[es:di]
 13026 00000BCC 47                      	inc	di
 13027 00000BCD 38E0                    	cmp	al,ah
 13028 00000BCF 7405                    	je	short IFLP
 13029 00000BD1 80CC20                  	or	ah,20h			; Try lower case
 13030 00000BD4 38E0                    	cmp	al,ah
 13031                                  IFLP:
 13032 00000BD6 E2EE                    	loop	IFCOMP
 13033                                  IF_DIF:
 13034 00000BD8 9F                      	lahf
 13035 00000BD9 01CF                    	add	di,cx			; Bump to next position without affecting flags
 13036 00000BDB 8B1D                    	mov	bx,[di]			; Get handler address
 13037 00000BDD 47                      	inc	di
 13038 00000BDE 47                      	inc	di
 13039 00000BDF 9E                      	sahf
 13040 00000BE0 75DB                    	jnz	short IFINDCOM
 13041 00000BE2 AC                      	lodsb
 13042 00000BE3 3C0D                    	cmp	al,0Dh
 13043                                  IFERRJ:
 13044 00000BE5 740B                    	jz	short IFERROR
 13045 00000BE7 E8A21D                  	call	DELIM
 13046 00000BEA 75D1                    	jnz	short IFINDCOM
 13047 00000BEC E8951D                  	call	scanoff
 13048 00000BEF FFE3                    	jmp	bx
 13049                                  
 13050                                  	; 17/04/2023
 13051                                  IFERRORP:
 13052 00000BF1 58                      	pop	ax
 13053                                  IFERROR:
 13054                                  	; 14/02/2023 - Retro DOS v4.0 COMMAND.COM
 13055                                  FORERROR:
 13056 00000BF2 BA[9E90]                	mov	dx,SYNTMES_PTR
 13057 00000BF5 E92C21                  	jmp	cerror
 13058                                  
 13059                                  IFNOT:
 13060 00000BF8 F616[669C]              	not	byte [IFNOTFLAG]
 13061 00000BFC FF06[FBA4]              	inc	word [IF_NOT_COUNT]
 13062 00000C00 EBAD                    	jmp	short IFREENT
 13063                                  
 13064                                  ; We are comparing two strings for equality. First, find the end of the
 13065                                  ; first string.
 13066                                  
 13067                                  IFSTRING:
 13068 00000C02 56                      	push	si			; save away pointer for later compare
 13069 00000C03 31C9                    	xor	cx,cx			; count of chars in first string
 13070                                  FIRST_STRING:
 13071 00000C05 AC                      	lodsb				; get character
 13072 00000C06 3C0D                    	cmp	al,0Dh			; end of line?
 13073 00000C08 74E7                    	jz	short IFERRORP		; yes => error
 13074 00000C0A E87F1D                  	call	DELIM			; is it a delimiter?
 13075 00000C0D 7403                    	jz	short EQUAL_CHECK 	; yes, go find equal sign
 13076 00000C0F 41                      	inc	cx			; remember 1 byte for the length
 13077 00000C10 EBF3                    	jmp	short FIRST_STRING 	; go back for more
 13078                                  EQUAL_CHECK:
 13079 00000C12 3C3D                    	cmp	al,'='			; is char we have an = sign?
 13080 00000C14 7407                    	je	short EQUAL_CHECK2 	; yes, go find second one.
 13081 00000C16 3C0D                    	cmp	al,0Dh			; end of line?
 13082 00000C18 74D7                    	je	short IFERRORP		; yes, syntax error
 13083 00000C1A AC                      	lodsb				; get next char
 13084 00000C1B EBF5                    	jmp	short EQUAL_CHECK
 13085                                  
 13086                                  ; The first = has been found. The next char had better be an = too.
 13087                                  
 13088                                  EQUAL_CHECK2:
 13089 00000C1D AC                      	lodsb				; get potential = char
 13090 00000C1E 3C3D                    	cmp	al,'='			; is it good?	
 13091                                  	;jnz	short IFERRPJ		; no, error
 13092                                  	; 17/04/2023
 13093 00000C20 75CF                    	jne	short IFERRORP
 13094                                  
 13095                                  ; Find beginning of second string.
 13096                                  
 13097 00000C22 E85F1D                  	call	scanoff
 13098 00000C25 3C0D                    	cmp	al,0Dh
 13099                                  	;jz	short IFERRPJ
 13100                                  	; 17/04/2023
 13101 00000C27 74C8                    	je	short IFERRORP
 13102 00000C29 5F                      	pop	di
 13103                                  
 13104                                  ; DS:SI points to second string
 13105                                  ; CX has number of chars in first string
 13106                                  ; ES:DI points to first string
 13107                                  
 13108 00000C2A F3A6                    	repe	cmpsb
 13109 00000C2C 7414                    	jz	short MATCH		; match found!
 13110                                  
 13111                                  ; No match. Let's find out what was wrong. The character that did not match
 13112                                  ; has been advanced over. Let's back up to it.
 13113                                  
 13114 00000C2E 4E                      	dec	si
 13115                                  
 13116                                  ; If it is EOL, then syntax error
 13117                                  
 13118 00000C2F 803C0D                  	cmp	byte [si],0Dh
 13119                                  	;jz	short IFERRJ
 13120                                  	; 17/04/2023
 13121 00000C32 74BE                    	je	short IFERROR
 13122                                  
 13123                                  ; Advance pointer over remainder of unmatched text to next delimiter
 13124                                  
 13125                                  SKIPSTRINGEND:
 13126 00000C34 AC                      	lodsb
 13127                                  NOTMATCH:
 13128 00000C35 3C0D                    	cmp	al,0Dh
 13129                                  IFERRORJ2:
 13130                                  	;jz	short IFERRJ
 13131                                  	; 17/04/2023
 13132 00000C37 74B9                    	jz	short IFERROR
 13133 00000C39 E8501D                  	call	DELIM
 13134 00000C3C 75F6                    	jnz	short SKIPSTRINGEND
 13135                                  
 13136                                  ; Signal that we did NOT have a match
 13137                                  
 13138 00000C3E B0FF                    	mov	al,-1	 ; 0FFh
 13139 00000C40 EB37                    	jmp	short IFRET
 13140                                  
 13141                                  	; 17/04/2023
 13142                                  ;IFERRPJ:
 13143                                  	;jmp	IFERRORP
 13144                                  
 13145                                  ; The compare succeeded. Was the second string longer than the first?
 13146                                  ; We do this by seeing if the next char is a delimiter.
 13147                                  
 13148                                  MATCH:
 13149 00000C42 AC                      	lodsb
 13150 00000C43 E8461D                  	call	DELIM
 13151 00000C46 75ED                    	jnz	short NOTMATCH ; not same.
 13152 00000C48 30C0                    	xor	al,al
 13153 00000C4A EB2D                    	jmp	short IFRET
 13154                                  
 13155                                  ; ---------------------------------------------------------------------------
 13156                                  
 13157                                  IFEXISTS:
 13158                                  
 13159                                  IFEXIST_ATTR	EQU	ATTR_HIDDEN+ATTR_SYSTEM  ; 2+4 = 6
 13160                                  
 13161                                  ;MOREDELIM:
 13162 00000C4C AC                      	lodsb
 13163 00000C4D E83C1D                  	call	DELIM
 13164 00000C50 75FA                    	jnz	short IFEXISTS
 13165                                  	;jnz	short MOREDELIM
 13166                                  
 13167 00000C52 BA[9A9D]                	mov	dx,DIRBUF
 13168 00000C55 B8001A                  	mov	ax,1A00h
 13169                                  	;mov	ax,Set_DMA*256 ; 1A00h
 13170 00000C58 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 13171                                  			; DS:DX	-> disk	transfer buffer
 13172 00000C5A BB0200                  	mov	bx,2	; if(0) [|not](|1) exist[1|2] file(2|3)
 13173 00000C5D 031E[FBA4]              	add	bx,[IF_NOT_COUNT]
 13174                                  	;mov	ax,ARG_ARGV
 13175                                  	;mov	ax,ARG+ARG_UNIT.argv
 13176 00000C61 B8[AF9F]                	mov	ax,ARG
 13177 00000C64 E82429                  	call	argv_calc		; convert arg index to pointer
 13178 00000C67 8B17                    	mov	dx,[bx]
 13179                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 13180                                  	;mov	cx,6
 13181 00000C69 B90600                  	mov	cx,IFEXIST_ATTR ; filetypes to search for
 13182 00000C6C B8004E                  	mov	ax,4E00h
 13183                                  	;mov	ax,Find_First*256 ; 4E00h ; request first match, if any
 13184 00000C6F CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 13185                                  			; CX = search attributes
 13186                                  			; DS:DX	-> ASCIZ filespec
 13187                                  			; (drive,path, and wildcards allowed)
 13188 00000C71 7204                    	jc	short IF_EX_C ; carry is how to determine error
 13189 00000C73 30C0                    	xor	al,al
 13190 00000C75 EB02                    	jmp	short IFRET
 13191                                  
 13192                                  	;nop
 13193                                  IF_EX_C:
 13194 00000C77 B0FF                    	mov	al,-1	; 0FFh	; false 'n' fall through...
 13195                                  IFRET:
 13196 00000C79 F606[669C]FF            	test	byte [IFNOTFLAG],-1 ; 0FFh
 13197 00000C7E 7402                    	jz	short REALTEST
 13198 00000C80 F6D0                    	not	al
 13199                                  REALTEST:
 13200 00000C82 08C0                    	or	al,al
 13201 00000C84 7403                    	jz	short IFTRUE
 13202 00000C86 E97BF4                  	jmp	TCOMMAND
 13203                                  
 13204                                  IFTRUE:
 13205 00000C89 E8F81C                  	call	scanoff
 13206 00000C8C 89F1                    	mov	cx,si
 13207 00000C8E 81E98100                	sub	cx,81h
 13208 00000C92 280E8000                	sub	[80h],cl
 13209 00000C96 8A0E8000                	mov	cl,[80h]
 13210 00000C9A 880E[B39A]              	mov	[COMBUF+1],cl
 13211 00000C9E BF[B49A]                	mov	di,COMBUF+2
 13212 00000CA1 FC                      	cld
 13213 00000CA2 F3A4                    	rep	movsb
 13214 00000CA4 B00D                    	mov	al,0Dh
 13215 00000CA6 AA                      	stosb
 13216                                  
 13217                                  ; Signal that an IF was done. 
 13218                                  ; This prevents the redirections from getting lost.
 13219                                  
 13220 00000CA7 1E                      	push	ds
 13221 00000CA8 8E1E[539C]              	mov	ds,[RESSEG]
 13222 00000CAC C606[AA02]FF            	mov	byte [IfFlag],-1
 13223 00000CB1 1F                      	pop	ds
 13224                                  
 13225                                  ; Go do the command
 13226                                  
 13227                                  	;jmp	DOCOM1 ; MSDOS 5.0 COMMAND.COM
 13228                                  	; 07/06/2023
 13229                                  	; Retro DOS v4.2 COMMAND.COM
 13230 00000CB2 E940F6                  	jmp	DOCOM0 ; MSDOS 6.22 COMMAND.COM
 13231                                  
 13232                                  ; ---------------------------------------------------------------------------
 13233                                  
 13234                                  IFERRORJ3:
 13235 00000CB5 EB80                    	jmp	IFERRORJ2
 13236                                  
 13237                                  IFERLEV:
 13238                                  
 13239                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13240                                  ; PCDOS 7.1 COMMAND.COM
 13241                                  ;%if 1
 13242                                  ;	cmp	byte [si],0F2h  ; CODE PAGE 437
 13243                                  ;	jne	short IFERLEV_@
 13244                                  ;	inc	si
 13245                                  ;IFERLEV_@:	
 13246                                  ;%endif
 13247 00000CB7 B70A                    	mov	bh,10
 13248 00000CB9 30DB                    	xor	bl,bl
 13249                                  GETNUMLP:
 13250 00000CBB AC                      	lodsb
 13251 00000CBC 3C0D                    	cmp	al,0Dh
 13252 00000CBE 74F5                    	je	short IFERRORJ3
 13253 00000CC0 E8C91C                  	call	DELIM
 13254 00000CC3 740C                    	jz	short GOTNUM
 13255 00000CC5 2C30                    	sub	al,'0'
 13256 00000CC7 86C3                    	xchg	al,bl
 13257 00000CC9 F6E7                    	mul	bh
 13258 00000CCB 00D8                    	add	al,bl
 13259 00000CCD 86C3                    	xchg	al,bl
 13260 00000CCF EBEA                    	jmp	short GETNUMLP
 13261                                  GOTNUM:
 13262 00000CD1 1E                      	push	ds
 13263 00000CD2 8E1E[539C]              	mov	ds,[RESSEG]
 13264 00000CD6 8A26[9A02]              	mov	ah,[RetCode]
 13265 00000CDA 1F                      	pop	ds
 13266 00000CDB 30C0                    	xor	al,al
 13267 00000CDD 38DC                    	cmp	ah,bl
 13268 00000CDF 7398                    	jnb	short IFRET
 13269 00000CE1 FEC8                    	dec	al
 13270 00000CE3 EB94                    	jmp	short IFRET
 13271                                  
 13272                                  ; ---------------------------------------------------------------------------
 13273                                  
 13274                                  ; Shift the parameters in the batch structure by 1 and set up the new argument.
 13275                                  ; This is a NOP if no batch in progress.
 13276                                  
 13277                                  _SHIFT:
 13278 00000CE5 8E1E[539C]              	mov	ds,[RESSEG]
 13279 00000CE9 A1[4902]                	mov	ax,[Batch]		; get batch pointer
 13280 00000CEC 09C0                    	or	ax,ax			; in batch mode?
 13281 00000CEE 7501                    	jnz	short SHIFT1		; yes, operate in batch segment	
 13282                                  SHIFT_RETN:				; no, done.
 13283 00000CF0 C3                      	retn
 13284                                  SHIFT1:
 13285 00000CF1 8EC0                    	mov	es,ax
 13286 00000CF3 8ED8                    	mov	ds,ax
 13287                                  
 13288                                  ; Now move the batch args down by 1 word
 13289                                  
 13290                                  	;;mov	di,0Bh ; MSDOS 3.3 COMMAND.COM
 13291                                  	;mov	di,0Ch ; MSDOS 5.0 COMMAND.COM
 13292 00000CF5 BF0C00                  	mov	di,BATCHSEGMENT.BatParm ; point to parm table
 13293 00000CF8 8D7502                  	lea	si,[di+2]		; make source = dest + 2
 13294 00000CFB B90900                  	mov	cx,9			; move 9 parameters
 13295 00000CFE F3A5                    	rep	movsw			; SHIFT down
 13296                                  
 13297                                  ; If the last parameter (the one not moved) is empty (= -1) then we are done.
 13298                                  ; We have copied it into the previous position.
 13299                                  
 13300 00000D00 833DFF                  	cmp	word [di],-1	; if last one was not in use then
 13301 00000D03 74EB                    	je	short SHIFT_RETN ; No new parm
 13302                                  
 13303                                  ; This last pointer is NOT nul. Get it and scan to find the next argument.
 13304                                  ; Assume, first, that there is no next argument.
 13305                                   
 13306 00000D05 8B35                    	mov	si,[di]
 13307 00000D07 C705FFFF                	mov	word [di],-1		; Assume no parm
 13308                                  
 13309                                  ; The parameters are CR separated. Scan for end of this parm.
 13310                                  
 13311                                  SKIPCRLP:
 13312 00000D0B AC                      	lodsb
 13313 00000D0C 3C0D                    	cmp	al,0Dh
 13314 00000D0E 75FB                    	jne	short SKIPCRLP
 13315                                  
 13316                                  ; We are now pointing at next arg. If it is 0 (end of original line) then we
 13317                                  ; are finished. There are no more parms and the pointer has been previously
 13318                                  ; initialized to indicate it.
 13319                                  
 13320 00000D10 803C00                  	cmp	byte [si],0
 13321 00000D13 74DB                    	jz	short SHIFT_RETN 	; End of parms
 13322 00000D15 8935                    	mov	[di],si			; Pointer to next parm as %9
 13323 00000D17 C3                      	retn
 13324                                  
 13325                                  ; =============== S U B	R O U T	I N E =======================================
 13326                                  
 13327                                  ; Skip delim reads bytes from the batch file until a non-delimiter is seen.
 13328                                  ; returns char in AL, carry set -> eof
 13329                                  
 13330                                  SKIPDELIM:
 13331 00000D18 F706[4902]FFFF          	test	word [Batch],-1		; batch file empty. OOPS!
 13332 00000D1E 740A                    	jz	short SKIPERR
 13333 00000D20 E85CFD                  	call	GETBATBYT		; get a char
 13334 00000D23 E8661C                  	call	DELIM			; check for ignoreable chars
 13335 00000D26 74F0                    	jz	short SKIPDELIM		; ignore this char.
 13336 00000D28 F8                      	clc
 13337 00000D29 C3                      	retn
 13338                                  SKIPERR:
 13339 00000D2A F9                      	stc
 13340                                  GOTO_RETN:
 13341 00000D2B C3                      	retn
 13342                                  
 13343                                  ; ---------------------------------------------------------------------------
 13344                                  
 13345                                  ;  CALL is an internal command that transfers control to a .bat, .exe, or
 13346                                  ;  .com file. This routine strips the CALL off the command line, sets
 13347                                  ;  the CALL_FLAG to indicate a call in progress, and returns control to
 13348                                  ;  DOCOM1 in TCODE to reprocess the command line and execute the file
 13349                                  ;  being CALLed.
 13350                                  
 13351                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13352                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0C27h
 13353                                  
 13354                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 13355                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0D01h
 13356                                  
 13357                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13358                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:0D4Ch
 13359                                  _$CALL:
 13360                                  
 13361                                  ;  strip off CALL from command line
 13362                                  
 13363                                  	;ASSUME DS:trangroup,ES:trangroup
 13364                                  
 13365 00000D2C 56                      	push	si
 13366 00000D2D 57                      	push	di
 13367 00000D2E 50                      	push	ax
 13368 00000D2F 51                      	push	cx
 13369 00000D30 BE[B49A]                	mov	si,COMBUF+2
 13370 00000D33 E84E1C                  	call	scanoff			;get to first non-delimeter
 13371                                  	;add	si,4
 13372 00000D36 83C604                  	add	si,length_call		;point to char past CALL
 13373 00000D39 BF[B49A]                	mov	di,COMBUF+2
 13374                                  	;mov	cx,124		
 13375 00000D3C B97C00                  	mov	cx,COMBUFLEN-length_call 
 13376                                  					;get length of buffer
 13377 00000D3F F3A4                    	rep	movsb			;move it
 13378 00000D41 59                      	pop	cx
 13379 00000D42 58                      	pop	ax
 13380 00000D43 5F                      	pop	di
 13381 00000D44 5E                      	pop	si
 13382                                  
 13383                                  ;  set call flag to indicate call in progress
 13384                                  
 13385 00000D45 1E                      	push	ds
 13386 00000D46 8E1E[539C]              	mov	ds,[RESSEG]
 13387 00000D4A C606[B002]01            	mov	byte [Call_Flag],call_in_progress ; 1
 13388 00000D4F C606[B102]01            	mov	byte [Call_Batch_Flag],call_in_progress ; 1
 13389                                  
 13390                                  ; Turn off any pipes in progress.
 13391                                  
 13392 00000D54 803E[1403]00            	cmp	byte [PipeFiles],0 	; Only turn off if present.
 13393 00000D59 7403                    	jz	short _NOPIPE
 13394 00000D5B E8C023                  	call	PIPEDEL
 13395                                  _NOPIPE:
 13396 00000D5E 1F                      	pop	ds
 13397 00000D5F C3                      	retn
 13398                                  
 13399                                  ; ---------------------------------------------------------------------------
 13400                                  
 13401                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13402                                  _GOTO:
 13403 00000D60 8E1E[539C]              	mov	ds,[RESSEG]
 13404 00000D64 F706[4902]FFFF          	test	word [Batch],-1	; If not in batch mode, a nop
 13405 00000D6A 74BF                    	jz	short GOTO_RETN
 13406 00000D6C 31D2                    	xor	dx,dx
 13407 00000D6E 1E                      	push	ds
 13408 00000D6F 8E1E[4902]              	mov	ds,[Batch]
 13409                                  	;mov	[8],dx	; MSDOS 5.0 COMMAND.COM
 13410 00000D73 89160800                	mov	[BATCHSEGMENT.BatSeek],dx ; Back to start
 13411                                  	;mov	[10],dx	; MSDOS 5.0 COMMAND.COM
 13412 00000D77 89160A00                	mov	[BATCHSEGMENT.BatSeek+2],dx ; Back to start
 13413                                  
 13414                                  	; MSDOS 6.0
 13415                                  ;M037
 13416                                  ; Clear EOF indicator because we have reseeked to the beginning of the file.
 13417                                  ;
 13418 00000D7B C606020000              	mov	byte [BATCHSEGMENT.BatchEOF],0
 13419                                  					; clear eof indicator ;M037
 13420                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13421 00000D80 1F                      	pop	ds
 13422                                  GOTOOPEN:
 13423 00000D81 E86BF8                  	call	PROMPTBAT
 13424                                  	;mov	di,5Dh
 13425 00000D84 BF5D00                  	mov	di,FCB+1		; Get the label
 13426 00000D87 B90B00                  	mov	cx,11
 13427 00000D8A B020                    	mov	al,' '
 13428 00000D8C F2AE                    	repne	scasb
 13429 00000D8E 7501                    	jnz	short NOINC
 13430 00000D90 41                      	inc	cx
 13431                                  NOINC:
 13432 00000D91 83E90B                  	sub	cx,11
 13433 00000D94 F7D9                    	neg	cx
 13434                                  	;mov	[cs:GOTOLEN],cx
 13435                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13436 00000D96 26890E[9A9D]            	mov	[es:GOTOLEN],cx	; MSDOS 5.0 (& 6.0)
 13437                                  
 13438                                  ; At beginning of file. Skip to first non-delimiter char
 13439                                  
 13440 00000D9B E87AFF                  	call	SKIPDELIM
 13441 00000D9E 721C                    	jb	short BADGOTO
 13442 00000DA0 3C3A                    	cmp	al,':'
 13443 00000DA2 7426                    	jz	short CHKLABEL
 13444                                  LABLKLP:				; Look for the label
 13445 00000DA4 E8D8FC                  	call	GETBATBYT
 13446 00000DA7 3C0A                    	cmp	al,0Ah
 13447 00000DA9 7509                    	jne	short LABLKTST
 13448                                  
 13449                                  ; At beginning of line. Skip to first non-delimiter char
 13450                                  
 13451 00000DAB E86AFF                  	call	SKIPDELIM
 13452 00000DAE 720C                    	jb	short BADGOTO
 13453 00000DB0 3C3A                    	cmp	al,':'
 13454 00000DB2 7416                    	je	short CHKLABEL
 13455                                  LABLKTST:
 13456 00000DB4 F706[4902]FFFF          	test	word [Batch],0FFFFh ; -1
 13457 00000DBA 75E8                    	jnz	short LABLKLP
 13458                                  BADGOTO:
 13459 00000DBC E87100                  	call	BATCLOSE
 13460                                  
 13461                                  	; MSDOS 6.0
 13462                                  ;SR;
 13463                                  ; At this point we are terminating without freeing up any nested batch 
 13464                                  ;segments i.e if the error occurred within a called batch file. This routine
 13465                                  ;will traverse the linked list of batch segments and free all of them.
 13466                                  ;
 13467 00000DBF E8BD00                  	call	free_batch		; free up nested batch segments
 13468                                  
 13469                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13470 00000DC2 0E                      	push	cs
 13471 00000DC3 1F                      	pop	ds
 13472 00000DC4 BA[9B90]                	mov	dx,BADLAB_PTR
 13473 00000DC7 E95A1F                  	jmp	cerror
 13474                                  
 13475                                  ; Found the :.	Skip to first non-delimiter char
 13476                                  
 13477                                  CHKLABEL:
 13478 00000DCA E84BFF                  	call	SKIPDELIM
 13479 00000DCD 72ED                    	jb	short BADGOTO
 13480 00000DCF BF5D00                  	mov	di,FCB+1 ; 5Dh
 13481                                  	;mov	cx,[cs:GOTOLEN]
 13482                                  	; 14/02/2023
 13483 00000DD2 268B0E[9A9D]            	mov	cx,[es:GOTOLEN]	 ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13484 00000DD7 EB05                    	jmp	short GOTBYTE
 13485                                  
 13486                                  NEXTCHRLP:
 13487 00000DD9 51                      	push	cx
 13488 00000DDA E8A2FC                  	call	GETBATBYT
 13489 00000DDD 59                      	pop	cx
 13490                                  GOTBYTE:
 13491                                  	; 18/03/2023
 13492                                  	; 14/02/2023
 13493                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0CD9h
 13494 00000DDE E87E19                  	call	testkanj
 13495 00000DE1 7413                    	jz	short NOTKANJ1
 13496 00000DE3 263A05                  	cmp	al,[es:di]
 13497 00000DE6 75CC                    	jne	short LABLKTST
 13498 00000DE8 47                      	inc	di
 13499 00000DE9 49                      	dec	cx
 13500 00000DEA E3C8                    	jcxz	LABLKTST
 13501 00000DEC 51                      	push	cx
 13502 00000DED E88FFC                  	call	GETBATBYT
 13503 00000DF0 59                      	pop	cx
 13504 00000DF1 263A05                  	cmp	al,[es:di]
 13505 00000DF4 EB0C                    	jmp	short KNEXTLABCHR
 13506                                  NOTKANJ1:
 13507                                  	; 14/02/2023
 13508                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0CF1h
 13509 00000DF6 0C20                    	or	al,20h
 13510 00000DF8 263A05                  	cmp	al,[es:di]
 13511                                  	;jne	short TRYUPPER
 13512                                  	;jmp	short NEXTLABCHR
 13513                                  	; 25/04/2023
 13514 00000DFB 7407                    	je	short NEXTLABCHR 
 13515                                  TRYUPPER:
 13516 00000DFD 2C20                    	sub	al,20h
 13517 00000DFF 263A05                  	cmp	al,[es:di]
 13518                                  KNEXTLABCHR:
 13519 00000E02 75B0                    	jnz	short LABLKTST
 13520                                  NEXTLABCHR:
 13521 00000E04 47                      	inc	di
 13522 00000E05 E2D2                    	loop	NEXTCHRLP
 13523 00000E07 E875FC                  	call	GETBATBYT
 13524                                  	; 14/02/2023
 13525 00000E0A 26833E[9A9D]08          	cmp	word [es:GOTOLEN],8 ;  MSDOS 5.0 (& 6.0) COMMAND.COM
 13526                                  	;cmp	word [cs:GOTOLEN],8 ; Is the label at least 8 chars long?
 13527 00000E10 7D04                    	jge	short GOTOCONT	; Yes, then the next char doesn't matter
 13528 00000E12 3C20                    	cmp	al,' '
 13529 00000E14 779E                    	ja	short LABLKTST
 13530                                  GOTOCONT:
 13531 00000E16 3C0D                    	cmp	al,0Dh
 13532 00000E18 7407                    	je	short SKIPLFEED
 13533                                  TONEXTBATLIN:
 13534 00000E1A E862FC                  	call	GETBATBYT
 13535 00000E1D 3C0D                    	cmp	al,0Dh
 13536 00000E1F 75F9                    	jne	short TONEXTBATLIN
 13537                                  SKIPLFEED:
 13538 00000E21 E85BFC                  	call	GETBATBYT
 13539                                  
 13540                                  	; MSDOS 6.0
 13541                                  ;SR;
 13542                                  ; The BatchEOF flag is set in GetBatByt to indicate that we are faking a 
 13543                                  ;CR-LF for the last line. On a goto, this flag has to be cleared, because
 13544                                  ;BatchEOF == 1 now, after returning a CR-LF. The next call to GetBatByt
 13545                                  ;to get the EOF has not been made yet because we encountered the Goto. On
 13546                                  ;all other cases, EOF will be hit while trying to read the next line and
 13547                                  ;we are fine. I know, I know, what a massive hack from hell!! God help us!!
 13548                                  ;
 13549 00000E24 06                      	push	es
 13550 00000E25 8E06[4902]              	mov	es,[Batch]
 13551 00000E29 26C606020000            	mov	byte [es:BATCHSEGMENT.BatchEOF],0
 13552                                  					;invalidate fake CR-LF flag
 13553 00000E2F 07                      	pop	es
 13554                                  
 13555                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13556                                  	;call	BATCLOSE
 13557                                  	;retn
 13558                                  	; 14/02/2023
 13559                                  	;jmp	short BATCLOSE
 13560                                  
 13561                                  ; =============== S U B	R O U T	I N E =======================================
 13562                                  
 13563                                  	; 27/07/2024
 13564                                  BATCLOSE:
 13565 00000E30 2E8B1E[539F]            	mov	bx,[cs:BATHAND]
 13566 00000E35 83FB05                  	cmp	bx,5
 13567 00000E38 7205                    	jb	short CLOSERETURN
 13568                                  	; 14/02/2023
 13569 00000E3A B43E                    	mov	ah,3Eh
 13570                                  	;mov	ah,CLOSE ; 3Eh
 13571                                  
 13572                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13573                                  %if 0
 13574                                  	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 13575                                  			; BX = file handle
 13576                                  %else
 13577 00000E3C E87BF7                  	call	int_21h_indirect
 13578                                  %endif
 13579                                  
 13580                                  CLOSERETURN:
 13581 00000E3F C606[9202]00            	mov	byte [In_Batch],0 ; reset flag	
 13582 00000E44 C3                      	retn
 13583                                  
 13584                                  ; =============== S U B	R O U T	I N E =======================================
 13585                                  
 13586                                  ; Open the BATCH file, If open fails, AL is drive of batch file (A=1)
 13587                                  ; Also, fills internal batch buffer. If access denied, then AX = -1
 13588                                  	
 13589                                  	; 27/07/2024
 13590                                  	; 14/02/2023
 13591                                  BATOPEN:
 13592 00000E45 1E                      	push	ds
 13593 00000E46 8E1E[4902]              	mov	ds,[Batch]
 13594                                  	;;mov	dx,1Fh	; MSDOS 3.3 COMMAND.COM
 13595                                  	;mov	dx,20h	; MSDOS 5.0 COMMAND.COM
 13596 00000E4A BA2000                  	mov	dx,BATCHSEGMENT.BatFile
 13597                                  
 13598                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13599                                  %if 0
 13600                                  	mov	ax,3D00h
 13601                                  	;mov	ax,(OPEN<<8) ; 3D00h ; Open the batch file
 13602                                  
 13603                                  	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 13604                                  			; DS:DX	-> ASCIZ filename
 13605                                  			; AL = access mode
 13606                                  			; 0 - read
 13607                                  %else
 13608 00000E4D B8203D                  	mov	ax,3D20h
 13609                                  	;mov	ax,(OPEN<<8)|20h ; 3D20h ; Open the batch file
 13610                                  				 ; 00-100-000b (00-DENYNONE-READONLY)
 13611 00000E50 E867F7                  	call	int_21h_indirect
 13612                                  %endif
 13613                                  
 13614 00000E53 721C                    	jc	short SETERRDL
 13615                                  	;mov	dx,[8]
 13616 00000E55 8B160800                	mov	dx,[BATCHSEGMENT.BatSeek]
 13617                                  	;mov	cx,[10]
 13618 00000E59 8B0E0A00                	mov	cx,[BATCHSEGMENT.BatSeek+2]
 13619 00000E5D 1F                      	pop	ds
 13620                                  	;mov	[cs:BATHAND],ax
 13621 00000E5E 26A3[539F]              	mov	[es:BATHAND],ax ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13622 00000E62 89C3                    	mov	bx,ax
 13623 00000E64 B80042                  	mov	ax,4200h
 13624                                  	;mov	ax,(LSEEK<<8) ; 4200h ; Go to the right spot
 13625 00000E67 CD21                    	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 13626                                  			; AL = method: offset from beginning of	file
 13627                                  
 13628                                  	;mov	word [cs:BATBUFPOS],-1 ; 0FFFFh
 13629                                  					; nuke batch buffer position
 13630 00000E69 26C706[27A6]FFFF        	mov	word [es:BATBUFPOS],-1 ; MSDOS 5.0 (& 6.0) COMMAND.COM
 13631                                  BATOPEN_RETN:
 13632 00000E70 C3                      	retn
 13633                                  
 13634                                  SETERRDL:
 13635 00000E71 89D3                    	mov	bx,dx
 13636                                  	; MSDOS 6.0
 13637                                  	;invoke	get_ext_error_number 	;AN022; get the extended error
 13638                                  	; 14/02/2023
 13639 00000E73 E8D311                  	call	get_ext_error_number
 13640 00000E76 89C2                    	mov	dx,ax		     	;AN022; save extended error in DX
 13641                                  
 13642                                  	; MSDOS 3.3
 13643                                  	;mov	dx,INSERTDSKPTR
 13644                                  	;call	GET_EXT_ERR_NUMBER
 13645                                  
 13646                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13647 00000E78 8A07                    	mov	al,[bx]			; Get drive spec
 13648 00000E7A 2C40                    	sub	al,'@'	; sub al,40h	; A = 1, B = 2 ..
 13649 00000E7C 1F                      	pop	ds
 13650 00000E7D F9                      	stc				; SUB mucked over carry
 13651 00000E7E C3                      	retn
 13652                                  
 13653                                  ; =============== S U B	R O U T	I N E =======================================
 13654                                  
 13655                                  ;Free_batch : This routine traverses the linked batch segments freeing all
 13656                                  ;the batch and FOR segments until all of them are freed. It also restores
 13657                                  ;the old state of the EchoFlag.
 13658                                  ;
 13659                                  ;	ENTRY:	ds = RESGROUP
 13660                                  ;
 13661                                  ;	EXIT: 	All batch & FOR segments freed.
 13662                                  ;		EchoFlag restored to old state before batch process.
 13663                                  ;
 13664                                  ;	REGISTERS AFFECTED: bx, cx
 13665                                  
 13666                                  	; 14/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13667                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0D7Eh
 13668                                  
 13669                                  free_batch: ;proc near
 13670                                  	;assume	ds:RESGROUP,es:nothing
 13671                                  
 13672 00000E7F 06                      	push	es
 13673 00000E80 8B1E[B202]              	mov	bx,[Next_Batch]
 13674 00000E84 09DB                    	or	bx,bx
 13675 00000E86 7433                    	jz	short fb_ret
 13676                                  _ClearBatch:
 13677 00000E88 8EC3                    	mov	es,bx			; get batch segment
 13678                                  	;mov	bx,es:BatForPtr		; get old FOR segment
 13679 00000E8A 268B1E0500              	mov	bx,[es:BATCHSEGMENT.BatForPtr] ; [es:5]
 13680                                  	;cmp	bx,0			; is a FOR in progress
 13681                                  	; 27/07/2024
 13682 00000E8F 21DB                    	and	bx,bx
 13683 00000E91 7409                    	jz	short no_bat_for	; no - don't deallocate
 13684 00000E93 06                      	push	es			;
 13685 00000E94 8EC3                    	mov	es,bx			; yes - free it up...
 13686 00000E96 B449                    	mov	ah,49h
 13687                                  	;mov	ah,DEALLOC		;
 13688                                  
 13689                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13690                                  %if 0
 13691                                  	int	21h			;
 13692                                  %else
 13693 00000E98 E81FF7                  	call	int_21h_indirect
 13694                                  %endif
 13695 00000E9B 07                      	pop	es			; restore to batch segment
 13696                                  no_bat_for:
 13697                                  	;mov	cl,[es:1]
 13698 00000E9C 268A0E0100              	mov	cl,[es:BATCHSEGMENT.BatEchoFlag]
 13699                                  					; get old echo flag
 13700                                  	;mov	bx,[es:3]
 13701 00000EA1 268B1E0300              	mov	bx,[es:BATCHSEGMENT.BatLast]
 13702                                  					; get old batch segment
 13703 00000EA6 B449                    	mov	ah,49h
 13704                                  	;mov	ah,DEALLOC		; free it up...
 13705                                  
 13706                                  ; 27/07/2024 - PCDOS 7.1 COMMAND.COM
 13707                                  %if 0
 13708                                  	int	21h			;
 13709                                  %else
 13710 00000EA8 E80FF7                  	call	int_21h_indirect
 13711                                  %endif
 13712                                  	; 14/02/2023
 13713                                  	;mov	[Batch],bx		; get ready to deallocate next batch
 13714 00000EAB FF0E[AE02]              	dec	word [Nest]		; is there another batch file?
 13715 00000EAF 75D7                    	jnz	short _ClearBatch	; keep going until no batch file
 13716                                  	
 13717 00000EB1 880E[9D02]              	mov	[EchoFlag],cl		;restore echo status
 13718 00000EB5 C706[4902]0000          	mov	word [Batch],0		;no batch process in progress
 13719                                  fb_ret:
 13720 00000EBB 07                      	pop	es
 13721 00000EBC C3                      	ret
 13722                                  
 13723                                  ;free_batch endp
 13724                                  
 13725                                  ;============================================================================
 13726                                  ; TFOR.ASM, MSDOS 6.0, 1991
 13727                                  ;============================================================================
 13728                                  ; 10/10/2018 - Retro DOS v3.0
 13729                                  
 13730                                  ; All batch proccessing has DS set to segment of resident portion
 13731                                  
 13732                                  ;ASSUME DS:RESGROUP,ES:TRANGROUP
 13733                                  
 13734                                  ; MSDOS 3.3 COMMAND.COM, transient portion/segment offset 0BE9h
 13735                                  
 13736                                  ; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13737                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:0DBFh
 13738                                  
 13739                                  ; ---------------------------------------------------------------------------
 13740                                  
 13741                                  	; 15/02/2023
 13742                                  FORTERM:
 13743                                  	; MSDOS 6.0
 13744 00000EBD 0E                      	push	cs			;AN037; Get local segment into
 13745 00000EBE 1F                      	pop	ds			;AN037;  DS, ES
 13746 00000EBF 0E                      	push	cs			;AN037;
 13747 00000EC0 07                      	pop	es			;AN037;
 13748                                  
 13749                                  	; MSDOS 3.3 (& MSDOS 6.0)
 13750 00000EC1 E89502                  	call	FOROFF
 13751                                  	;mov	ds,[cs:RESSEG]
 13752 00000EC4 268E1E[539C]            	mov	ds,[es:RESSEG] ; 15/02/2023 - MSDOS 5.0
 13753 00000EC9 813E[A502]00FF          	cmp	word [SingleCom],0FF00h
 13754 00000ECF 750F                    	jne	short BAT_CRLF
 13755 00000ED1 833E[AE02]00            	cmp	word [Nest],0		;See if we have nested batch files
 13756 00000ED6 7508                    	jne	short BAT_CRLF		;Yes - don't exit just yet
 13757 00000ED8 C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Cause a terminate
 13758 00000EDE EB12                    	jmp	short NOFORP2
 13759                                  BAT_CRLF:
 13760 00000EE0 F606[9D02]01            	test	byte [EchoFlag],1 	; Is echo on?
 13761 00000EE5 740B                    	jz	short NOFORP2		; no - exit
 13762 00000EE7 F706[4902]FFFF          	test	word [Batch],-1 ; 0FFFFh
 13763                                  					; print CRLF if in batch
 13764 00000EED 7403                    	jz	short NOFORP2
 13765 00000EEF E8851A                  	call	CRLF2
 13766                                  NOFORP2:
 13767 00000EF2 E90FF2                  	jmp	TCOMMAND
 13768                                  
 13769                                  ; ---------------------------------------------------------------------------
 13770                                  
 13771                                  ;------
 13772                                  ;   For-loop processing. For loops are of the form:
 13773                                  ;	    for %<loop-variable> in (<list>) do <command>
 13774                                  ; where <command> may contain references of the form %<variable>, which are
 13775                                  ; later substituted with the items in <list>. The for-loop structure is
 13776                                  ; set-up by the procedure '$for'; successive calls to 'forproc' execute
 13777                                  ; <command> once for each item in <list>. All of the information needed for
 13778                                  ; loop processing is stored on a piece of memory gotten from 'alloc'. This
 13779                                  ; structure is actually fairly large, on the order of 700 bytes, and includes
 13780                                  ; a complete copy of the original command-line structure as parsed by
 13781                                  ; 'parseline', loop control variables, and a dma buffer for the
 13782                                  ; 'FindFirst/FindNext' expansion of wildcard filenames in <list>. When loop
 13783                                  ; processing has completed, this chunk of memory is returned to the system.
 13784                                  ;
 13785                                  ;   All of the previously defined variables, in 'datares', used for loop
 13786                                  ; processing may be erased. Only one, (DW) ForPtr, need be allocated.
 13787                                  ;
 13788                                  ;   The error message, 'for_alloc_mes', should be moved into the file
 13789                                  ; containing all of the other error messages.
 13790                                  ;
 13791                                  ;   Referencing the allocated for-loop structure is a little tricky.
 13792                                  ; At the moment, a byte is defined as part of a new segment, 'for_segment'.
 13793                                  ; When 'forproc' actually runs, ES and DS are set to point to the base of the
 13794                                  ; new chunk of memory.	References to this byte, 'f', thus assemble correctly
 13795                                  ; as offsets of ES or DS. 'f' would not be necessary, except that the
 13796                                  ; assembler translates an instruction such as 'mov AX, [for_minarg]' as an
 13797                                  ; immediate move of the offset of 'for_minarg' into AX. In other words, in
 13798                                  ; terms of PDP-11 mnemonics, the assembler ACTUALLY assembles
 13799                                  ;	mov  AX, #for_minarg 	; AX := 02CA (for example)
 13800                                  ; instead of
 13801                                  ;	mov  AX, for_minarg	; AX := [02CA] (contents of 02CA)
 13802                                  ; By using 'f', we pretend that we are actually referencing an allocated
 13803                                  ; structure, and the assembler coughs up the code we want. Notice that it
 13804                                  ; doesn't matter whether we put brackets around the location or not -- the
 13805                                  ; assembler is "smart" enough to know that we want an address instead of the
 13806                                  ; contents of that location.
 13807                                  ;
 13808                                  ;   Finally, there now exists the potential to easily implement nested loops.
 13809                                  ; One method would be to have a link field in each for-structure pointing to
 13810                                  ; its parent.  Variable references that couldn't be resolved in the local
 13811                                  ; frame would cause a search of prior frames. For-structures would still be
 13812                                  ; allocated and released in exactly the same fashion. The only limit on the
 13813                                  ; number of nested loops would be memory size (although at 700 bytes a pop,
 13814                                  ; memory wouldn't last THAT long). Alternately, a small structure could be
 13815                                  ; maintained in the resident data area. This structure would be an array of
 13816                                  ; control-variable names and pointers to for-structure blocks. This would
 13817                                  ; greatly speed up the resolution of non-local variable references. However,
 13818                                  ; since space in the resident is precious, we would have to compromise on a
 13819                                  ; "reasonable" level of nesting -- 10, 16, 32 levels, whatever. For-structure
 13820                                  ; allocation and de-allocation would have to be modified slightly to take this
 13821                                  ; new structure into account.
 13822                                  ;
 13823                                  ;   Oops, just one more thing. Forbuf need not be a part of the for-structure.
 13824                                  ; It could just as well be one structure allocated in 'transpace'. Actually,
 13825                                  ; it may be easier to allocate it as part of 'for_segment'.
 13826                                  ;------
 13827                                  		; include fordata.asm
 13828                                  
 13829                                  ; Data structure definitions included by tfor.asm
 13830                                  
 13831                                  struc FOR_INFO
 13832 00000000 <res 444h>                .FOR_ARGS:	  resb  ARG_UNIT.SIZE	; argv[] structure 
 13833 00000444 ??                        .FOR_COM_START: resb  1		; beginning of <command>
 13834 00000445 ????                      .FOR_EXPAND:	  resw  1		; * or ? item in <list>?
 13835 00000447 ????                      .FOR_MINARG:	  resw  1		; beginning of <list>
 13836 00000449 ????                      .FOR_MAXARG:	  resw  1		; end of <list>
 13837 0000044B <res 80h>                 .FORBUF:	  resw  64		; temporary buffer
 13838 000004CB <res 80h>                 .FORDMA:	  resw  64		; FindFirst/Next buffer
 13839 0000054B ??                        .FOR_VAR:	  resb  1		; loop control variable
 13840                                    .size:
 13841                                  endstruc
 13842                                  					; ARG_UNIT.SIZE = 1348 (544h)
 13843                                  					; ARG_UNIT.SIZE = 1092 ; 27/07/2024
 13844                                  _$FOR_EXIT:
 13845 00000EF5 EBC6                    	jmp	short FORTERM		; exceeding maxarg means all done
 13846                                  
 13847                                  ; ---------------------------------------------------------------------------
 13848                                  
 13849                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 13850                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 13851                                  FORPROC:
 13852 00000EF7 A1[AC02]                	mov	ax,[ForPtr]
 13853 00000EFA 8ED8                    	mov	ds,ax
 13854 00000EFC 8EC0                    	mov	es,ax			; operate in for-info area
 13855                                  	;;mov	dx,5CBh	; MSDOS 5.0 & 6.22
 13856                                  	;mov	dx,4CBh ; PCDOS 7.1 ; 27/07/2024
 13857 00000EFE BACB04                  	mov	dx,FOR_INFO.FORDMA	; 1348+1+2+2+2+128 = 1483 = 5CBh
 13858                                  		; PCDOS 7.1 COMMAND.COM ; 1092+1+2+2+2+128 = 1227 = 4CBh
 13859 00000F01 B8001A                  	mov	ax,1A00h
 13860                                  	;mov	ax,Set_DMA*256 ; 1A00h
 13861 00000F04 CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 13862                                  			; DS:DX	-> disk	transfer buffer
 13863                                  FOR_BEGIN:
 13864                                  	;;cmp	word [545h],0
 13865                                  	;cmp	word [445h] ; 27/07/2024
 13866 00000F06 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13867 00000F0B 7404                    	jz	short FOR_BEGIN1
 13868                                  					; non-zero for_expand equals FALSE
 13869                                  	;;inc	word [547h]
 13870                                  	;inc	word [447h] ; 27/07/2024
 13871 00000F0D FF064704                	inc	word [FOR_INFO.FOR_MINARG]
 13872                                  FOR_BEGIN1:
 13873                                  	;mov	bx,[447h] ; 27/07/2024
 13874 00000F11 8B1E4704                	mov	bx,[FOR_INFO.FOR_MINARG] ; current item in <list> to examine
 13875                                  	;cmp	bx,[449h] ; 27/07/2024
 13876 00000F15 3B1E4904                	cmp	bx,[FOR_INFO.FOR_MAXARG]
 13877 00000F19 7FDA                     	jg	short _$FOR_EXIT	; exceeding maxarg means all done
 13878                                  	;mov	ax,0
 13879 00000F1B B80000                  	mov	ax,FOR_INFO.FOR_ARGS ; 0
 13880 00000F1E E86A26                  	call	argv_calc		; compute argv[x] address
 13881                                  	;mov	cx,[bx+3]
 13882 00000F21 8B4F03                  	mov	cx,[bx+ARGV_ELE.argstartel]
 13883 00000F24 8B17                    	mov	dx,[bx]
 13884                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 13885                                  	;test	byte [bx+2],4		; Is there a path separator in this arg?
 13886 00000F26 F6470204                	test	byte [bx+ARGV_ELE.argflags],4 ; path_sep
 13887 00000F2A 7512                    	jnz	short FORSUB		; Yes, argstartel should be correct
 13888 00000F2C 8B37                    	mov	si,[bx]
 13889                                  	;mov	si,[bx+ARGV_ELE.argpointer]
 13890                                  
 13891                                  	;mov	al,[cs:LPAREN]
 13892                                  	; 15/02/2023
 13893                                  	; MSDOS 6.0 (& 5.0) COMMAND.com
 13894                                  	;mov	al,'('	; mov al,lparen
 13895                                  	;cmp	[si-1],	al		; If the current token is the first
 13896                                  	; 27/07/2024
 13897 00000F2E 807CFF28                	cmp	byte [si-1],'('
 13898 00000F32 750A                    	jne	short FORSUB		;  one in the list and originally had
 13899 00000F34 41                      	inc	cx			;  the opening paren as its first char,
 13900                                  					;  the argstartel ptr needs to be
 13901                                  					;  advanced passed it before the prefix
 13902                                  					;  length is computed.
 13903                                  	;mov	al,':'
 13904                                  	;cmp	[si+1],	al		; If the token begins with "(d:",
 13905                                  	; 27/07/2024
 13906 00000F35 807C013A                	cmp	byte [si+1],':'
 13907 00000F39 7503                    	jne	short FORSUB		;  argstartel has to be moved over the
 13908 00000F3B 83C102                  	add	cx,2			;  rest of the prefix as well.
 13909                                  FORSUB:
 13910 00000F3E 29D1                    	sub	cx,dx			; compute length of pathname prefix
 13911                                  	;;cmp	word [545h],0
 13912                                  	;cmp	word [445h],0 ; 27/07/2024
 13913 00000F40 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13914                                  					; are we still expanding a name?
 13915 00000F45 7416                    	jz	short FOR_FIND_NEXT
 13916                                  					; if so, get next matching filename
 13917                                  	;test	byte [bx+2],2
 13918 00000F47 F6470202                	test	byte [bx+ARGV_ELE.argflags],2 ; wildcard
 13919 00000F4B 7505                    	jnz	short FOR_FIND_FIRST
 13920                                  					; should we expand THIS (new) arg?
 13921                                  	;mov	cx,[bx+5]
 13922                                  					; else, just copy all of it directly
 13923 00000F4D 8B4F05                  	mov	cx,[bx+ARGV_ELE.arglen]
 13924 00000F50 EB1D                    	jmp	short FOR_SMOOSH
 13925                                  
 13926                                  	;nop
 13927                                  	; 15/02/2023
 13928                                  FOR_FIND_FIRST:
 13929 00000F52 51                      	push	cx
 13930 00000F53 31C9                    	xor	cx,cx
 13931 00000F55 B8004E                  	mov	ax,4E00h
 13932                                  	;mov	ax,Find_First*256 ; 4E00h
 13933 00000F58 CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 13934                                  			; CX = search attributes
 13935                                  			; DS:DX	-> ASCIZ filespec
 13936                                  			; (drive,path, and wildcards allowed)
 13937 00000F5A 59                      	pop	cx
 13938 00000F5B EB05                    	jmp	short FOR_RESULT
 13939                                  
 13940                                  	;nop
 13941                                  FOR_FIND_NEXT:
 13942 00000F5D B8004F                  	mov	ax,4F00h
 13943                                  	;mov	ax,Find_Next*256 ;4F00h
 13944 00000F60 CD21                    	int	21h	; DOS -	2+ - FIND NEXT ASCIZ (FINDNEXT)
 13945                                  			; [DTA]	= data block from
 13946                                  			; last AH = 4Eh/4Fh call
 13947                                  FOR_RESULT:
 13948 00000F62 B8FFFF                  	mov	ax,-1 ; 0FFFFh		; assume worst case
 13949 00000F65 7201                    	jc	short FOR_CHECK
 13950                                  	; 15/02/2023
 13951 00000F67 40                      	inc	ax ; ax = 0
 13952                                  	;mov	ax,0			; Find* returns 0 for SUCCESS
 13953                                  FOR_CHECK:				; record success of findfirst/next
 13954                                  	;;mov	[545h],ax
 13955                                  	;mov	[445h],ax ; 27/07/2024
 13956 00000F68 A34504                  	mov	[FOR_INFO.FOR_EXPAND],ax
 13957 00000F6B 09C0                    	or	ax,ax			; anything out there?
 13958 00000F6D 7597                    	jnz	short FOR_BEGIN		; if not, try next arg
 13959                                  FOR_SMOOSH:
 13960                                  	;mov	si,[bx+ARGV_ELE.argpointer] ; mov si,[bx+0]
 13961 00000F6F 8B37                    	mov	si,[bx] 		; copy argv[arg][0,CX] into destbuf
 13962                                  	;;mov	di,54Bh	; MSDOS 5.0 & 6.22 COMMAND.COM
 13963                                  	;mov	di,44Bh ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 13964 00000F71 BF4B04                  	mov	di,FOR_INFO.FORBUF	; some days this will be the entire
 13965 00000F74 F3A4                    	rep	movsb			; arg, some days just the path prefix
 13966                                  					
 13967 00000F76 833E450400              	cmp	word [FOR_INFO.FOR_EXPAND],0
 13968                                  					; if we're not expanding, we can
 13969 00000F7B 7509                    	jnz	short FOR_MAKE_COM 	; skip the following
 13970                                  	; 15/02/2023
 13971                                  	;;mov	si,05E9h ; MSDOS 3.3 & 5.0 & 6.22 COMMAND.COM ; 27/07/2024
 13972                                  	; 27/07/2024
 13973                                  	;mov	si,04E9h ; PCDOS 7.1 COMMAND.COM
 13974 00000F7D BEE904                  	mov	si,FOR_INFO.FORDMA+FIND_BUF.PNAME ; 14/10/2018
 13975                                  FOR_MORE:
 13976                                  	;cmp	byte [si],0		; tack on matching filename
 13977                                  	;jz	short FOR_MAKE_COM
 13978                                  	;movsb
 13979                                  	;jnz	short FOR_MORE
 13980                                  	; 25/04/2023
 13981 00000F80 AC                      	lodsb
 13982 00000F81 AA                      	stosb
 13983 00000F82 08C0                    	or	al,al
 13984 00000F84 75FA                    	jnz	short FOR_MORE
 13985                                  FOR_MAKE_COM:
 13986                                  	; 25/04/2023
 13987                                  	;xor	al,al			; tack a null byte onto the end
 13988                                  	;stosb				; of the substitute string
 13989 00000F86 31C9                    	xor	cx,cx			; character count for command line
 13990 00000F88 F7D1                    	not	cx			; negate it -- take advantage of loopnz
 13991 00000F8A 31DB                    	xor	bx,bx			; argpointer
 13992 00000F8C BF[B49A]                	mov	di,COMBUF+2
 13993                                  	; 15/02/2023
 13994                                  	;;mov	bl,[544h] ; MSDOS 5.0-6.22 ; 27/07/2024
 13995                                  	; 27/07/2024
 13996                                  	;mov	bl,[444h] ; PCDOS 7.1 COMMAND.COM 
 13997 00000F8F 8A1E4404                	mov	bl,[FOR_INFO.FOR_COM_START] ; argindex
 13998                                  	;;mov	dh,[64Bh]
 13999                                  	;mov	dh,[54Bh] ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 14000 00000F93 8A364B05                	mov	dh,[FOR_INFO.FOR_VAR]
 14001                                  					; %<for-var> is replaced by [forbuf]
 14002 00000F97 0E                      	push	cs			; time to form the <command> string
 14003 00000F98 07                      	pop	es
 14004                                  	;assume ES:trangroup
 14005                                  	;mov	ax,FOR_INFO.FOR_ARGS
 14006 00000F99 B80000                  	mov	ax,0			; translate offset to pointer
 14007 00000F9C E8EC25                  	call	argv_calc
 14008                                  	;mov	si,[bx+9]
 14009 00000F9F 8B7709                  	mov	si,[bx+ARGV_ELE.arg_ocomptr]
 14010                                  					; mov ptr passed beginning space
 14011 00000FA2 46                      	inc	si
 14012                                  FOR_MAKE_LOOP:
 14013 00000FA3 8A04                    	mov	al,[si]			; the <command> arg, byte by byte
 14014 00000FA5 46                      	inc	si
 14015 00000FA6 3C25                    	cmp	al,'%'			; looking for %<control-variable>
 14016 00000FA8 7514                    	jne	short FOR_STOSB 	; no % ... add byte to string
 14017 00000FAA 3834                    	cmp	[si],dh			; got the right <variable>?
 14018 00000FAC 7510                    	jnz	short FOR_STOSB		; got a %, but wrong <variable>
 14019 00000FAE 46                      	inc	si			; skip over <for-variable>
 14020                                  
 14021 00000FAF 56                      	push	si
 14022                                  	; 15/02/2023
 14023                                  	;;mov	si,54Bh	; MSDOS 5.0-6.22 ; 27/07/2024
 14024                                  	; 27/07/2024
 14025                                  	;mov	si,44Bh ; PCDOS 7.1 COMMAND.COM
 14026 00000FB0 BE4B04                  	mov	si,FOR_INFO.FORBUF
 14027                                  					; substitute the <item> for <variable>
 14028                                  					; to make a final <command> to execute
 14029                                  SLOOP:					
 14030 00000FB3 AC                      	lodsb				; grab all those <item> bytes, and
 14031 00000FB4 AA                      	stosb				; add 'em to the <command> string,
 14032 00000FB5 08C0                    	or	al,al			; until we run into a null
 14033 00000FB7 E0FA                    	loopne	SLOOP
 14034 00000FB9 4F                      	dec	di			; adjust length and <command> pointer
 14035 00000FBA 41                      	inc	cx			; so we can overwrite the null
 14036 00000FBB 5E                      	pop	si
 14037 00000FBC EBE5                    	jmp	short FOR_MAKE_LOOP
 14038                                  					; got back for more <command> bytes
 14039                                  FOR_STOSB:
 14040 00000FBE AA                      	stosb				; take a byte from the <command> arg
 14041 00000FBF 49                      	dec	cx			; and put it into the <command> to be
 14042                                  					; executed (and note length, too)
 14043 00000FC0 3C0D                    	cmp	al,0Dh
 14044 00000FC2 75DF                    	jne	short FOR_MAKE_LOOP	; If not done, loop.
 14045                                  FOR_MADE_COM:
 14046 00000FC4 F6D1                    	not	cl
 14047                                  	;mov	[cs:COMBUF+1],cl
 14048                                  	;mov	ds,[cs:RESSEG]
 14049                                  	; 15/02/2023 - Retro DOS v4.0 COMMAND.COM
 14050                                  	; MSDOS 5.0 COMMAND.COM
 14051 00000FC6 26880E[B39A]            	mov	[es:COMBUF+1],cl
 14052 00000FCB 268E1E[539C]            	mov	ds,[es:RESSEG]
 14053                                  	;assume DS:resgroup
 14054 00000FD0 F606[9D02]01            	test	byte [EchoFlag],1 	; shall we echo this <command>, dearie?
 14055 00000FD5 742F                    	jz	short NOECHO3
 14056                                  	;cmp	byte [NullFlag],nullcommand
 14057 00000FD7 803E[B402]01            	cmp	byte [NullFlag],1 	;G was there a command last time?
 14058 00000FDC 7403                    	jz	short NO_CRLF_PR  	;G no - don't print crlf
 14059                                  
 14060 00000FDE E89619                  	call	CRLF2		  	;G Print out prompt
 14061                                  NO_CRLF_PR:
 14062 00000FE1 C606[B402]00            	mov	byte [NullFlag],0 	;G reset no command flag
 14063 00000FE6 0E                      	push	cs
 14064 00000FE7 1F                      	pop	ds
 14065 00000FE8 57                      	push	di
 14066 00000FE9 E80211                  	call	PRINT_PROMPT	  	;G Prompt the user
 14067 00000FEC 5F                      	pop	di
 14068                                  
 14069 00000FED 26C645FF00              	mov	byte [es:di-1],0  	; yeah, PRINT it out...	
 14070 00000FF2 C706[019E][B49A]        	mov	word [string_ptr_2],COMBUF+2
 14071                                  	; 17/04/2023
 14072 00000FF8 BA[D391]                	mov	dx,string_buf_ptr
 14073 00000FFB E81F44                  	call	std_printf
 14074 00000FFE 26C645FF0D              	mov	byte [es:di-1],0Dh
 14075 00001003 E9ECF2                  	jmp	DOCOM		  	; run silent, run deep...
 14076                                  NOECHO3:
 14077 00001006 C606[B402]00            	mov	byte [NullFlag],0
 14078 0000100B 0E                      	push	cs
 14079 0000100C 1F                      	pop	ds
 14080                                  	;jmp	DOCOM1
 14081                                  	; 07/06/2023
 14082                                  	; Retro DOS v4.2 COMMAND.COM
 14083 0000100D E9E5F2                  	jmp	DOCOM0 ; MSDOS 6.22 COMMAND.COM
 14084                                  
 14085                                  FORNESTERRJ:				; no multi-loop processing... yet!
 14086 00001010 E84601                  	call	FOROFF
 14087 00001013 E92901                  	jmp	FORNESTERR
 14088                                  
 14089                                  ; ---------------------------------------------------------------------------
 14090                                  
 14091                                  FORERRORJ:
 14092 00001016 E9D9FB                  	jmp	FORERROR
 14093                                  
 14094                                  ; ---------------------------------------------------------------------------
 14095                                  
 14096                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F24h
 14097                                  
 14098                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 14099                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0FFEh
 14100                                  
 14101                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 14102                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1040h
 14103                                  _$FOR:
 14104 00001019 8E06[539C]              	mov	es,[RESSEG]
 14105 0000101D 26803E[AB02]00          	cmp	byte [es:ForFlag],0 ; is another one already running?
 14106 00001023 75EB                    	jnz	short FORNESTERRJ   ; if flag is set.... boom!
 14107                                  
 14108                                  ; Turn off any pipes in progress.
 14109                                  
 14110 00001025 26803E[1403]00          	cmp	byte [es:PipeFiles],0 ; Only turn off if present.
 14111 0000102B 7403                    	jz	short NO_PIPE
 14112 0000102D E8EE20                  	call	PIPEDEL
 14113                                  NO_PIPE:
 14114 00001030 31D2                    	xor	dx,dx			; counter (0 <= DX < argvcnt)
 14115 00001032 E8F400                  	call	NEXTARG			; move to next argv[n]
 14116 00001035 72DF                    	jc	short FORERRORJ		; no more args -- bad forloop
 14117 00001037 3C25                    	cmp	al,'%'			; next arg MUST start with '%'...
 14118 00001039 75DB                    	jne	short FORERRORJ
 14119 0000103B 89C5                    	mov	bp,ax			; save forloop variable
 14120 0000103D AC                      	lodsb
 14121 0000103E 08C0                    	or	al,al			; and MUST end immediately...
 14122 00001040 75D4                    	jnz	short FORERRORJ
 14123 00001042 E8E400                  	call	NEXTARG			; let's make sure the next arg is 'in'
 14124 00001045 72CF                    	jb	short FORERRORJ
 14125                                  	;and	ax,0DFDFh
 14126 00001047 25DFDF                  	and	ax,~2020h		; uppercase the letters
 14127                                  	; 15/02/2023
 14128                                  	;cmp	ax,4E49h  	; MSDOS 5.0
 14129                                  	;cmp	ax,[IN_WORD] 	; MSDOS 3.3
 14130                                  	;cmp	ax,in_word	; MSDOS 5.0
 14131 0000104A 3D494E                  	cmp	ax,'IN'
 14132 0000104D 75C7                    	jnz	short FORERRORJ
 14133 0000104F AC                      	lodsb
 14134                                  
 14135                                  	; 15/02/2023
 14136                                  	; MSDOS 3.3
 14137                                  	;or	al,al			; it, too, must end right away
 14138                                  	;jz	short CHECKLPAREN
 14139                                  	;cmp	al,[LPAREN]
 14140                                  	;jnz	short FORERRORJ
 14141                                  	;;add	word [bx+ARGV_ELE.argpointer],2 ; add word [bx+0],2
 14142                                  	;add	word [bx],2
 14143                                  	;;add	word [bx+9],2
 14144                                  	;add	word [bx+ARGV_ELE.arg_ocomptr],2
 14145                                  	;;sub	word [bx+5],2
 14146                                  	;sub	word [bx+ARGV_ELE.arglen],2
 14147                                  	;mov	ax,[si-1]
 14148                                  	;jmp	short LPCHECK
 14149                                  
 14150                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14151                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F5Bh
 14152                                  
 14153                                  	; MSDOS 6.0
 14154                                  ; Compaq bug fix -- exit from this loop on error
 14155                                  
 14156 00001050 08C0                    	or	al,al
 14157 00001052 75C2                    	jne	short FORERRORJ		; jump on error
 14158                                  
 14159                                  ;	je	short CHECKLPAREN
 14160                                  ;
 14161                                  ; Not null. Perhaps there are no spaces between this and the (:
 14162                                  ;   FOR %i in(foo bar...
 14163                                  ; Check for the Lparen here
 14164                                  ;
 14165                                  ;;	cmp	al,lparen
 14166                                  ;;	jnz	short FORERRORJ
 14167                                  ;
 14168                                  ; The token was in(... We strip off the "in" part to simulate a separator
 14169                                  ; being there in the first place.
 14170                                  ;
 14171                                  ;;	add	word [bx+ARGV_ELE.argpointer],2 ; advance source pointer
 14172                                  ;;	add	word [bx+ARGV_ELE.arg_ocomptr],2
 14173                                  ;;						; advance original string
 14174                                  ;;	sub	word [bx+ARGV_ELE.arglen],2 	; decrement the appropriate length
 14175                                  ;
 14176                                  ; SI now points past the in(.  Simulate a nextarg call that results in the
 14177                                  ; current value.
 14178                                  ;
 14179                                  ;;	mov	ax,[si-1]		; get lparen and next char
 14180                                  ;;	jmp	short LPCHECK
 14181                                  ;
 14182                                  ; end of Compaq bug fix
 14183                                  
 14184                                  ; ---------------------------------------------------------------------------
 14185                                  
 14186                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14187                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:0F5Fh
 14188                                  
 14189                                  	; MSDOS 3.3 (& MSDOS 6.0)
 14190                                  CHECKLPAREN:
 14191 00001054 E8D200                  	call	NEXTARG			; lparen delimits beginning of <list>
 14192 00001057 72BD                    	jc	short FORERRORJ
 14193                                  LPCHECK:
 14194                                  	; 15/02/2023
 14195                                  	; MSDOS 5.0 (% MSDOS 6.0)
 14196                                  	;;cmp	al,[LPAREN]
 14197                                  	;cmp	al,lparen
 14198 00001059 3C28                    	cmp	al,'('
 14199 0000105B 75B9                    	jne	short FORERRORJ
 14200 0000105D 80FC00                  	cmp	ah,0
 14201 00001060 7410                    	je	short FOR_PAREN_TOKEN
 14202                                  	;;cmp	ah,[RPAREN]		; special case:  null list
 14203                                  	;cmp	ah,rparen
 14204 00001062 80FC29                  	cmp	ah,')'
 14205 00001065 7503                    	jne	short FOR_LIST_NOT_EMPTY
 14206 00001067 E953FE                  	jmp	FORTERM
 14207                                  FOR_LIST_NOT_EMPTY:
 14208                                  	;inc	word [bx+ARGV_ELE.argpointer] ; inc word [bx+0]
 14209 0000106A FF07                    	inc	word [bx]		; Advance ptr past "("
 14210                                  	;dec	word [bx+5]		; Adjust the rest of this argv entry
 14211 0000106C FF4F05                  	dec	word [bx+ARGV_ELE.arglen] ; to agree.
 14212 0000106F 46                      	inc	si			; Inc si so check for ")" works
 14213 00001070 EB0D                    	jmp	short FOR_LIST
 14214                                  
 14215                                  	;nop
 14216                                  FOR_PAREN_TOKEN:
 14217 00001072 E8B400                  	call	NEXTARG			; what have we in our <list>?
 14218 00001075 729F                    	jc	short FORERRORJ
 14219                                  	; 15/02/2023
 14220                                  	;;;cmp	ax,[RPAREN+1]
 14221                                  	;;cmp	ax,[NULLRPAREN]		; special case:  null list
 14222                                  	;cmp	ax,nullrparen
 14223 00001077 83F829                  	cmp	ax,29h	; db 29h,0 ; db ')',0
 14224 0000107A 7503                    	jne	short FOR_LIST
 14225 0000107C E93EFE                  	jmp	FORTERM
 14226                                  
 14227                                  ;FORERORJJ:
 14228                                  	;jmp	FORERROR
 14229                                  
 14230                                  FOR_LIST:				; skip over rest of <list>
 14231 0000107F 89D1                    	mov	cx,dx			; first arg of <list>
 14232                                  
 14233                                  SKIP_LIST:
 14234                                  	;add	si,[bx+5]
 14235 00001081 037705                  	add	si,[bx+ARGV_ELE.arglen]
 14236 00001084 83EE03                  	sub	si,3			; si = ptr to last char of token
 14237                                  	; 15/02/2023
 14238                                  	;;mov	al,[RPAREN]
 14239                                  	;mov	al,rparen
 14240 00001087 B029                    	mov	al,')'
 14241 00001089 3804                    	cmp	[si],al			; Is this the last element in <list>
 14242 0000108B 7408                    	je	short FOR_END_LIST 	; Yes, exit loop.
 14243 0000108D E89900                  	call	NEXTARG			; No, get next arg <list>
 14244                                  	;jc	short FORERORJJ		; If no more and no rparen, error.
 14245                                  	;jmp	short SKIP_LIST
 14246                                  	; 15/02/2023
 14247 00001090 73EF                    	jnc	short SKIP_LIST
 14248                                  
 14249                                  	; 15/02/2023
 14250                                  FORERORJJ:
 14251 00001092 E95DFB                  	jmp	FORERROR
 14252                                  
 14253                                  FOR_END_LIST:
 14254 00001095 89D7                    	mov	di,dx			; record position of last arg in <list>
 14255 00001097 C60400                  	mov	byte [si],0		; Zap the rparen
 14256                                  	; 15/02/2023
 14257                                  	;;;cmp	ax,[RPAREN+1]
 14258                                  	;;cmp	ax,[NULLRPAREN] 	; Was this token only a rparen
 14259                                  	;cmp	ax,nullparen
 14260 0000109A 83F829                  	cmp	ax,29h	; db 29h,0 ; db ')',0
 14261 0000109D 7401                    	je	short FOR_DO		; Yes, continue
 14262 0000109F 47                      	inc	di			; No, inc position of last arg
 14263                                  FOR_DO:
 14264 000010A0 E88600                  	call	NEXTARG			; now we had BETTER find a 'do'...
 14265 000010A3 72ED                    	jc	short FORERORJJ
 14266                                  	;and	ax,0DFDFh
 14267 000010A5 25DFDF                  	and	ax,~2020h		; uppercase the letters
 14268                                  	; 15/02/2023
 14269                                  	;;cmp	ax,[DO_WORD]
 14270                                  	;cmp	ax,do_word ; 4F44h
 14271 000010A8 3D444F                  	cmp	ax,'DO'	 ; 4F44h
 14272 000010AB 75E5                    	jne	short FORERORJJ
 14273 000010AD AC                      	lodsb
 14274 000010AE 08C0                    	or	al,al			; and it had BETTER be ONLY a 'do'...
 14275 000010B0 75E0                    	jnz	short FORERORJJ
 14276                                  		
 14277 000010B2 E87400                  	call	NEXTARG			; on to the beginning of <command>
 14278 000010B5 72DB                    	jc	short FORERORJJ		; null <command> not legal
 14279                                  
 14280 000010B7 50                      	push	ax
 14281 000010B8 53                      	push	bx
 14282 000010B9 51                      	push	cx
 14283 000010BA 52                      	push	dx			; preserve registers against disaster
 14284 000010BB 57                      	push	di
 14285 000010BC 56                      	push	si
 14286 000010BD 55                      	push	bp
 14287 000010BE E852F7                  	call	FREE_TPA		; need to make free memory, first
 14288 000010C1 E89500                  	call	FOROFF
 14289                                  	;mov	bx,264 ; 27/07/2024  ; MSDOS 5.0-6.22 & PCDOS 7.1	
 14290 000010C4 BB0801                  	mov	bx,FOR_INFO.size-ARG_UNIT.SIZE
 14291 000010C7 E8E927                  	call	SAVE_ARGS		; extra bytes needed for for-info
 14292 000010CA 9C                      	pushf
 14293 000010CB 26A3[AC02]              	mov	[es:ForPtr],ax
 14294 000010CF E852F7                  	call	ALLOC_TPA		; ALLOC_TPA clobbers registers...
 14295 000010D2 9D                      	popf
 14296 000010D3 5D                      	pop	bp
 14297 000010D4 5E                      	pop	si
 14298 000010D5 5F                      	pop	di
 14299 000010D6 5A                      	pop	dx
 14300 000010D7 59                      	pop	cx
 14301 000010D8 5B                      	pop	bx
 14302 000010D9 58                      	pop	ax
 14303 000010DA 723C                    	jc	short FOR_ALLOC_ERR
 14304                                  
 14305 000010DC 06                      	push	es			; save resgroup seg...
 14306 000010DD 26FF36[AC02]            	push	word [es:ForPtr]
 14307 000010E2 07                      	pop	es
 14308                                  	;assume es:for_segment
 14309 000010E3 49                      	dec	cx			; forproc wants min pointing before
 14310 000010E4 4F                      	dec	di			; first arg, max right at last one
 14311                                  	; 15/02/2023
 14312                                  	;;mov	[547h],cx
 14313                                  	; 27/07/2024
 14314                                  	;mov	[447h],cx ; PCDOS 7.1 COMMAND.COM
 14315 000010E5 26890E4704              	mov	[es:FOR_INFO.FOR_MINARG],cx
 14316                                  	;;mov	[549h],di
 14317                                  	;mov	[449h],di ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14318 000010EA 26893E4904              	mov	[es:FOR_INFO.FOR_MAXARG],di
 14319                                  	;;mov	[544h],dl
 14320                                  	;mov	[444h],dl ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14321 000010EF 2688164404              	mov	[es:FOR_INFO.FOR_COM_START],dl
 14322                                  	;;mov	word [545h],0FFFFh ; -1
 14323                                  	;mov	[445h],0FFFFh ; PCDOS 7.1 COMMAND.COM ; 27/07/2024
 14324 000010F4 26C7064504FFFF          	mov	word [es:FOR_INFO.FOR_EXPAND],-1
 14325                                  					; non-zero means FALSE
 14326 000010FB 89E8                    	mov	ax,bp
 14327                                  	;;mov	[64Bh],ah
 14328                                  	;mov	[54Bh],ah ; 27/07/2024 ; PCDOS 7.1 COMMAND.COM
 14329 000010FD 2688264B05              	mov	[es:FOR_INFO.FOR_VAR],ah
 14330 00001102 07                      	pop	es
 14331                                  	;assume es:resgroup
 14332 00001103 26FE06[AB02]            	inc	byte [es:ForFlag]
 14333 00001108 26833E[A502]FF          	cmp	word [es:SingleCom],-1
 14334 0000110E 7507                    	jne	short FOR_RET
 14335 00001110 26C706[A502]00FF        	mov	word [es:SingleCom],0FF00h
 14336                                  FOR_RET:
 14337 00001117 C3                      	retn
 14338                                  
 14339                                  FOR_ALLOC_ERR:
 14340                                  	; 15/02/2023
 14341                                  	; MSDOS 3.3
 14342                                  	;mov	dx,INSFMEMMESPTR
 14343                                  	;jmp	CERROR
 14344                                  
 14345                                  	; 15/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14346                                  	; MSDOS 6.0
 14347                                  	;mov	byte [msg_disp_class],1
 14348 00001118 C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 14349                                  					;AN000; set up extended error msg class
 14350                                  	;mov	dx,offset TranGroup:Extend_Buf_ptr
 14351 0000111D BA[CB8F]                	mov	dx,extend_buf_ptr
 14352                                  					;AC000; get extended message pointer
 14353                                  	;mov	word [extend_buf_ptr],8
 14354 00001120 C706[CB8F]0800          	mov	word [extend_buf_ptr],ERROR_NOT_ENOUGH_MEMORY
 14355                                  					;AN000; get message number in control block
 14356 00001126 E9FB1B                  	jmp	cerror
 14357                                  
 14358                                  
 14359                                  ; =============== S U B	R O U T	I N E =======================================
 14360                                  
 14361                                  NEXTARG:
 14362 00001129 42                      	inc	dx			; next argv[n]
 14363                                  	;cmp	dx,[ARG_ARGVCNT]
 14364 0000112A 3B16[6FA2]              	cmp	dx,[ARG+ARG_UNIT.argvcnt]
 14365                                  					; make sure we don't run off end
 14366 0000112E 7D0D                    	jge	short NEXTARG_ERR 	;  of argv[]...	
 14367 00001130 89D3                    	mov	bx,dx
 14368                                  	;mov	ax,ARG_ARGV
 14369                                  	;mov	ax,ARG+ARG_UNIT.argv
 14370 00001132 B8[AF9F]                	mov	ax,ARG
 14371 00001135 E85324                  	call	argv_calc		; convert array index to pointer
 14372 00001138 8B37                    	mov	si,[bx]			; load pointer to argstring
 14373                                  	;mov	si,[bx+ARGV_ELE.argpointer] ; mov si,[bx+0]
 14374 0000113A AD                      	lodsw				; and load first two chars
 14375 0000113B F8                      	clc
 14376 0000113C C3                      	retn
 14377                                  NEXTARG_ERR:
 14378 0000113D F9                      	stc
 14379 0000113E C3                      	retn
 14380                                  
 14381                                  ; ---------------------------------------------------------------------------
 14382                                  
 14383                                  FORNESTERR:
 14384 0000113F 1E                      	push	ds
 14385 00001140 8E1E[539C]              	mov	ds,[RESSEG]
 14386                                  	;ASSUME DS:RESGROUP
 14387 00001144 BA[4E91]                	mov	dx,FORNESTMES_PTR
 14388 00001147 813E[A502]00FF          	cmp	word [SingleCom],0FF00h
 14389 0000114D 7506                    	jne	short NOFORP3
 14390 0000114F C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Cause termination
 14391                                  NOFORP3:
 14392 00001155 1F                      	pop	ds
 14393 00001156 E9CB1B                  	jmp	cerror
 14394                                  
 14395                                  ; =============== S U B	R O U T	I N E =======================================
 14396                                  
 14397                                  ; General routine called to free the for segment. We also clear the forflag
 14398                                  ; too. Change no registers.
 14399                                  
 14400                                  FOROFF:
 14401 00001159 50                      	push	ax
 14402 0000115A 06                      	push	es
 14403 0000115B 2E8E06[539C]            	mov	es,[cs:RESSEG]
 14404 00001160 26A1[AC02]              	mov	ax,[es:ForPtr]
 14405 00001164 09C0                    	or	ax,ax
 14406 00001166 7408                    	jz	short FREEDONE
 14407 00001168 06                      	push	es
 14408 00001169 8EC0                    	mov	es,ax
 14409                                  	; 15/02/2023
 14410 0000116B B449                    	mov	ah,49h
 14411                                  	;mov	ah,DEALLOC ; 49h
 14412 0000116D CD21                    	int	21h	; DOS -	2+ - FREE MEMORY
 14413                                  			; ES = segment address of area to be freed
 14414 0000116F 07                      	pop	es
 14415                                  FREEDONE:
 14416 00001170 26C706[AC02]0000        	mov	word [es:ForPtr],0
 14417 00001177 26C606[AB02]00          	mov	byte [es:ForFlag],0
 14418 0000117D 07                      	pop	es
 14419 0000117E 58                      	pop	ax
 14420 0000117F C3                      	retn
 14421                                  
 14422                                  ;============================================================================
 14423                                  ; TCMD1A.ASM, MSDOS 6.0, 1991
 14424                                  ;============================================================================
 14425                                  ; 09/10/2018 - Retro DOS v3.0
 14426                                  
 14427                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 0ECBh
 14428                                  
 14429                                  ; ---------------------------------------------------------------------------
 14430                                  
 14431                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14432                                  
 14433                                  %if 0
 14434                                  
 14435                                  ; The DIR command displays the contents of a directory.
 14436                                  ;
 14437                                  ; ****************************************************************
 14438                                  ; *
 14439                                  ; * ROUTINE:	 CATALOG - display file(s) in directory
 14440                                  ; *
 14441                                  ; * FUNCTION:	 PARSE command line for drive, file, or path name.
 14442                                  ; *		 DIR allows two switches, /P (pause) and /W (wide).
 14443                                  ; *		 If an error occurs issue and error message and
 14444                                  ; *		 transfer control to CERROR.
 14445                                  ; *
 14446                                  ; * INPUT:	 command line at offset 81H
 14447                                  ; *
 14448                                  ; * OUTPUT:	 none
 14449                                  ; *
 14450                                  ; ****************************************************************
 14451                                  
 14452                                  CATALOG:
 14453                                  	; MSDOS 3.3
 14454                                  
 14455                                  	;mov	ax,ARG_ARGV
 14456                                  	;mov	ax,ARG+ARG_UNIT.argv
 14457                                  	mov	ax,ARG
 14458                                  	mov	dx,0FFFFh
 14459                                  	xor	cx,cx
 14460                                  	xor	si,si
 14461                                  DIR1:
 14462                                  	;cmp	cx,[ARG_ARGVCNT]
 14463                                  	cmp	cx,[ARG+ARG_UNIT.argvcnt]
 14464                                  	jnb	short DIR6 ; No more arguments
 14465                                  	mov	bx,cx
 14466                                  	call	ARGV_CALC
 14467                                  	;or	si,[bx+7]
 14468                                  	or	si,[bx+ARGV_ELE.argsw_word]
 14469                                  	test	si,7FFCh  ; test si,~8003
 14470                                  	jnz	short DIR2  ; /A,/B,/V switches (are invalid)
 14471                                  	;test	byte [bx+2],1
 14472                                  	test	byte [bx+ARGV_ELE.argflags],sw_flag  ; 1
 14473                                  	jz	short DIR3
 14474                                  	jmp	short DIR5
 14475                                  DIR2:
 14476                                  	mov	dx,BADPARMPTR
 14477                                  	jmp	CERROR
 14478                                  DIR3:
 14479                                  	or	cx,cx
 14480                                  	jnz	short DIR4	
 14481                                  	;cmp	word [bx+5],3
 14482                                  	cmp	word [bx+ARGV_ELE.arglen],3
 14483                                  	jz	short DIR5
 14484                                  	;add	word [bx+ARGV_ELE.argpointer],3 ; add word [bx+0],3
 14485                                  	add	word [bx],3
 14486                                  	;add	word [bx+9],3
 14487                                  	add	word [bx+ARGV_ELE.arg_ocomptr],3
 14488                                  	;add	word [bx+3],3
 14489                                  	add	word [bx+ARGV_ELE.argstartel],3
 14490                                  	;sub	word [bx+5],3
 14491                                  	sub	word [bx+ARGV_ELE.arglen],3
 14492                                  DIR4:
 14493                                  	cmp	dx,0FFFFh
 14494                                  	jnz	short DIR2
 14495                                  	mov	dx,bx
 14496                                  DIR5:
 14497                                  	inc	cx
 14498                                  	jmp	short DIR1
 14499                                  DIR6:
 14500                                  	mov	[COMSW],si
 14501                                  	push	dx
 14502                                  	xor	al,al
 14503                                  	cmp	dx,0FFFFh
 14504                                  	jz	short DIR7
 14505                                  	mov	bx,dx
 14506                                  	;mov	di,[bx+ARGV_ELE.argpointer]  ;mov di,[bx+0]
 14507                                  	mov	di,[bx]
 14508                                  	cmp	byte [di+1],':'
 14509                                  	jnz	short DIR7
 14510                                  	mov	al,[di]
 14511                                  	or	al,20h		; Lowercase drive name	
 14512                                  	sub	al,'a'-1 ; 60h  ; Convert to drive number (0,1..)
 14513                                  DIR7:
 14514                                  	;mov	[5CH],al
 14515                                  	mov	[FCB],al
 14516                                  	call	OKVOLARG
 14517                                  	mov	al,'?'		; *.* is default file spec.
 14518                                  	;mov	di,5Dh
 14519                                  	mov	di,FCB+1
 14520                                  	mov	cx,11
 14521                                  	rep stosb
 14522                                  
 14523                                  ; Begin by processing any switches that may have been specified.
 14524                                  ; BITS will contain any information about switches that was
 14525                                  ; found when the command line was parsed.
 14526                                  
 14527                                  	mov	ax,[COMSW]	; Get switches from command
 14528                                  	mov	[_BITS],ax	; initialize switches
 14529                                  	mov	word [COMSW],0	; initialize flags
 14530                                  	mov	byte [LINPERPAG],23 ; Set default for lines per page
 14531                                  	;test	al,1
 14532                                  	test	al,SWITCHW	; /W ?
 14533                                  	;mov	al,1
 14534                                  	mov	al,NORMPERLIN
 14535                                  	jz	short DIR8
 14536                                  	;mov	al,5
 14537                                  	mov	al,WIDEPERLIN
 14538                                  DIR8:
 14539                                  	mov	[LINLEN],al	; Set number of entries per line
 14540                                  	mov	[LINCNT],al
 14541                                  	mov	word [FILECNT],0 ; Keep track of how many files found
 14542                                  	mov	dx,DIRBUF
 14543                                  	mov	ah,Set_DMA ; 1Ah
 14544                                  	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 14545                                  			; DS:DX	-> disk	transfer buffer
 14546                                  	;mov	dl,[5Ch]
 14547                                  	mov	dl,[FCB]
 14548                                  	call	SAVUDIR
 14549                                  	pop	bx
 14550                                  	cmp	bx,0FFFFh
 14551                                  	jz	short DIR9
 14552                                  	;mov	dx,[bx+ARGV_ELE.argpointer] ; mov dx,[bx+0]
 14553                                  	mov	dx,[bx]
 14554                                  
 14555                                  ; The user may have specified a device. Search for the path and see if the
 14556                                  ; attributes indicate a device.
 14557                                  
 14558                                  	mov	ah,Find_First ; 4Eh
 14559                                  	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 14560                                  			; CX = search attributes
 14561                                  			; DS:DX	-> ASCIZ filespec
 14562                                  			; (drive,path, and wildcards allowed)
 14563                                  	jc	short DIR10
 14564                                  			; Check device atrribute..
 14565                                  	;test	byte [DIRBUF_ATTRIB2],40h
 14566                                  	;test	byte [DIRBUF_ATTRIB2],ATTR_DEVICE
 14567                                  	; 14/10/2018
 14568                                  	;test	byte [DIRBUF+21],40h
 14569                                  	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DEVICE
 14570                                  	jz	short DIR10	; no, go do normal operation
 14571                                  	mov	word [COMSW],-2 ; 0FFFEh  ; Signal device
 14572                                  DIR9:
 14573                                  	jmp	short DOHEADER
 14574                                  DIR10:
 14575                                  	;mov	dx,[bx+ARGV_ELE.argpointer]
 14576                                  	mov	dx,[bx]
 14577                                  	mov	ah,CHDir ; 3Bh
 14578                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14579                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14580                                  	jnc	short DOHEADER
 14581                                  	;mov	si,[bx+3]
 14582                                  	mov	si,[bx+ARGV_ELE.argstartel]
 14583                                  	cmp	dx,si
 14584                                  	jz	short DIR_NO_DRIVE
 14585                                  	xor	cl,cl
 14586                                  	xchg	cl,[si]
 14587                                  	mov	ah,CHDir ; 3Bh
 14588                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14589                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14590                                  	xchg	cl,[si]
 14591                                  	jnc	short DIR_NO_DRIVE
 14592                                  	mov	al,[si-1]
 14593                                  	call	PATHCHRCMP
 14594                                  	jnz	short DIR11
 14595                                  	mov	al,[si-2]
 14596                                  	call	PATHCHRCMP
 14597                                  	jz	short DIR12
 14598                                  	xchg	cl,[si-1]
 14599                                  	mov	ah,CHDir ; 3Bh
 14600                                  	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 14601                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 14602                                  	xchg	cl,[si-1]
 14603                                  	jnc	short DIR_NO_DRIVE
 14604                                  DIR11:
 14605                                  	mov	ch,':'
 14606                                  	cmp	ch,[si-1]
 14607                                  	jnz	short DIR12
 14608                                  	;mov	cx,[bx+ARGV_ELE.argpointer] ; mov cx,[bx+0]
 14609                                  	mov	cx,[bx]
 14610                                  	xchg	cx,si
 14611                                  	sub	cx,si
 14612                                  	cmp	cx,2
 14613                                  	jz	short DIR_NO_DRIVE
 14614                                  DIR12:
 14615                                  	mov	dx,BADCDPTR
 14616                                  	;test	byte [bx+2],4
 14617                                  	test	byte [bx+ARGV_ELE.argflags],4 ; path_sep
 14618                                  	jnz	short DIRERROR
 14619                                  DIRNF:
 14620                                  	mov	dx,FNOTFOUNDPTR
 14621                                  DIRERROR:
 14622                                  	jmp	CERROR
 14623                                  DIR_NO_DRIVE:
 14624                                  	cmp	word [si],'..'
 14625                                  	jnz	short DOREALPARSE
 14626                                  	cmp	byte [si+2],0
 14627                                  	jnz	short DOREALPARSE
 14628                                  	inc	word [COMSW]
 14629                                  	jmp	short DOHEADER
 14630                                  DOREALPARSE:
 14631                                  	mov	di,FCB ; 5Ch	
 14632                                  	;mov	ax,290Eh
 14633                                  	mov	ax,(Parse_File_Descriptor<<8)|0Eh
 14634                                  	int	21h	; DOS -	PARSE FILENAME
 14635                                  			; DS:SI	-> string to parse
 14636                                  			; ES:DI	-> buffer to fill with unopened	FCB
 14637                                  			; AL = bit mask	to control parsing
 14638                                  	cmp	byte [si],0
 14639                                  	jz	short DOHEADER
 14640                                  	dec	word [COMSW]
 14641                                  DOHEADER:
 14642                                  		
 14643                                  ; Display the header
 14644                                  
 14645                                  	push	bx
 14646                                  	call	BUILD_DIR_STRING
 14647                                  	mov	dx,DIRBUF
 14648                                  	mov	[VOL_DIR],dx
 14649                                  	mov	dx,DIRHEADPTR
 14650                                  	call	PRINTF_CRLF
 14651                                  	pop	bx
 14652                                  	cmp	bx,0FFFFh
 14653                                  	jz	short DOSEARCH
 14654                                  
 14655                                  ; If there were chars left after parse or device, then invalid file name
 14656                                  
 14657                                  	cmp	word [COMSW],0
 14658                                  	jz	short DOSEARCH	; nothing left; good parse
 14659                                  	jl	short DIRNFFIX	; not .. => error file not found
 14660                                  	call	RESTUDIR
 14661                                  	mov	dx,BADCDPTR
 14662                                  	jmp	CERROR		; was .. => error directory not found
 14663                                  DIRNFFIX:
 14664                                  	call	RESTUDIR
 14665                                  	jmp	short DIRNF
 14666                                  
 14667                                  ; We are assured that everything is correct. Let's go and search. Use
 14668                                  ; attributes that will include finding directories. Perform the first search
 14669                                  ; and reset our directory afterward.
 14670                                  
 14671                                  DOSEARCH:
 14672                                  	;mov	byte [55h],0FFh
 14673                                  	mov	byte [FCB-7],0FFh
 14674                                  	;mov	byte [5Bh],10h
 14675                                  	mov	byte [FCB-1],10h
 14676                                  
 14677                                  ; Caution! Since we are using an extended FCB, we will *also* be returning
 14678                                  ; the directory information as an extended FCB. We must bias all fetches into
 14679                                  ; DIRBUF by 8 (Extended FCB part + drive)
 14680                                  
 14681                                  	mov	ah,Dir_Search_First ; 11h
 14682                                  	mov	dx,FCB-7 ; 55h
 14683                                  	int	21h	; DOS -	SEARCH FIRST USING FCB
 14684                                  			; DS:DX	-> FCB
 14685                                  
 14686                                  ; Restore the user's directory. We preserve, though, the return from the
 14687                                  ; previous system call for later checking.
 14688                                  
 14689                                  FOUND_FIRST_FILE:
 14690                                  	push	ax		; save return state
 14691                                  	call	RESTUDIR	; restore user's dir	
 14692                                  	pop	ax		; get return state back
 14693                                  
 14694                                  ; Main scanning loop. Entry has AL = Search first/next error code. Test for
 14695                                  ; no more.
 14696                                  
 14697                                  DIRSTART:
 14698                                  	inc	al		; 0FFh = file not found
 14699                                  	jnz	short DISPLAY	; Either an error or we are finished
 14700                                  	jmp	CHKCNT
 14701                                  DISPLAY:
 14702                                  	inc	word [FILECNT]	; Keep track of how many we find
 14703                                  	mov	si,DIRBUF+8	; SI -> information returned by sys call
 14704                                  	;call	SHONAME
 14705                                  	call	DISPLAYNAME
 14706                                  	;test	byte [_BITS],1
 14707                                  	test	byte [_BITS],SWITCHW ; W switch set?
 14708                                  	jz	short DIRTEST	; If so, no size, date, or time
 14709                                  	jmp	NEXENT
 14710                                  DIRTEST:
 14711                                  	;test	byte [DIRBUF_ATTRIB1],10h
 14712                                  	; 14/10/2018
 14713                                  	;test	byte [DIRBUF_ATTRIB1],ATTR_DIRECTORY
 14714                                  	;test	byte [DIRBUF+19],10h
 14715                                  	test	byte [DIRBUF+8+DIR_ENTRY.DIR_ATTR],ATTR_DIRECTORY
 14716                                  	jz	short FILEENT
 14717                                  	mov	dx,DMESPTR
 14718                                  	call	STD_PRINTF
 14719                                  	jmp	short NOFSIZ
 14720                                  FILEENT:
 14721                                  	;mov	dx,[DIRBUF_FSIZ_L]
 14722                                  	;mov	dx,[DIRBUF+36]
 14723                                  	mov	dx,[DIRBUF+8+DIR_ENTRY.DIR_SIZE_L]
 14724                                  	mov	[FILESIZE_L],dx
 14725                                  	;mov	dx,[DIRBUF_FSIZ_H]
 14726                                  	;mov	dx,[DIRBUF+38]
 14727                                  	mov	dx,[DIRBUF+8+DIR_ENTRY.DIR_SIZE_H]
 14728                                  	mov	[FILESIZE_H],dx
 14729                                  	mov	dx,FSIZEMESPTR
 14730                                  	call	STD_PRINTF	; Print size of file
 14731                                  NOFSIZ:
 14732                                  	;mov	ax,[DIRBUF_FDATE]  ; Get date
 14733                                  	;mov	ax,[DIRBUF+32]
 14734                                  	mov	ax,[DIRBUF+8+DIR_ENTRY.DIR_DATE]
 14735                                  	or	ax,ax
 14736                                  	jz	short NEXENT	; Skip if no date
 14737                                  	mov	di,CHARBUF
 14738                                  	push	ax
 14739                                  	mov	ax,'  '
 14740                                  	stosw
 14741                                  	pop	ax
 14742                                  	mov	bx,ax
 14743                                  	and	ax,1Fh		; Get day
 14744                                  	mov	dl,al
 14745                                  	mov	ax,bx
 14746                                  	mov	cl,5
 14747                                  	shr	ax,cl		; Align month
 14748                                  	and	al,0Fh		; Get month
 14749                                  	mov	dh,al
 14750                                  	mov	cl,bh
 14751                                  	shr	cl,1		; Align year
 14752                                  	xor	ch,ch
 14753                                  	add	cx,80		; Relative 1980
 14754                                  	cmp	cl,100
 14755                                  	jb	short MILLENIUM
 14756                                  	sub	cl,100
 14757                                  MILLENIUM:
 14758                                  	call	DATE_CXDX
 14759                                  	;mov	cx,[DIRBUF_FTIME]
 14760                                  	;mov	cx,[DIRBUF+30]
 14761                                  	mov	cx,[DIRBUF+8+DIR_ENTRY.DIR_TIME]
 14762                                  	jcxz	PRBUF		; Time field present?
 14763                                  	mov	ax,2020h
 14764                                  	stosw
 14765                                  	shr	cx,1
 14766                                  	shr	cx,1
 14767                                  	shr	cx,1
 14768                                  	shr	cl,1
 14769                                  	shr	cl,1		; Hours in CH, minutes in CL
 14770                                  	mov	bl,[TIME_24]
 14771                                  	or	bl,80h		; Tell P_TIME called from DIR
 14772                                  	call	P_TIME		; Don't care about DX, never used with DIR
 14773                                  PRBUF:
 14774                                  	xor	ax,ax
 14775                                  	stosb
 14776                                  	mov	dx,CHARBUF
 14777                                  	mov	[STRING_PTR_2],dx
 14778                                  	mov	dx,STRINGBUF2PTR
 14779                                  	call	STD_PRINTF
 14780                                  NEXENT:
 14781                                  	dec	byte [LINCNT]
 14782                                  	jnz	short SAMLIN
 14783                                  NEXLIN:
 14784                                  	mov	al,[LINLEN]
 14785                                  	mov	[LINCNT],al
 14786                                  	call	CRLF2
 14787                                  	dec	byte [LINPERPAG]
 14788                                  	jnz	short SCROLL
 14789                                  	;test	byte [_BITS],2
 14790                                  	test	byte [_BITS],SWITCHP ; P switch present?
 14791                                  	jz	short SCROLL	; If not, just continue
 14792                                  	mov	byte [LINPERPAG],23
 14793                                  	call	PAUSE
 14794                                  	jmp	short SCROLL
 14795                                  SAMLIN:
 14796                                  	mov	dx,TABPTR	; Output a tab
 14797                                  	call	STD_PRINTF
 14798                                  SCROLL:
 14799                                  	mov	ah,Dir_Search_Next ; 12h
 14800                                  	;mov	dx,55h
 14801                                  	mov	dx,FCB-7	; DX -> Unopened FCB
 14802                                  	int	21h	; DOS -	SEARCH NEXT USING FCB
 14803                                  			; DS:DX	-> FCB
 14804                                  			; Return: AL = status
 14805                                  	jmp	DIRSTART
 14806                                  CHKCNT:
 14807                                  	test	word [FILECNT],0FFFFh ; -1
 14808                                  	jnz	short TRAILER
 14809                                  	jmp	DIRNF
 14810                                  TRAILER:
 14811                                  	mov	al,[LINLEN]
 14812                                  	cmp	al,[LINCNT]
 14813                                  	jz	short MMESSAGE
 14814                                  	call	CRLF2
 14815                                  MMESSAGE:
 14816                                  	mov	dx,DIRMESPTR
 14817                                  	mov	si,[FILECNT]
 14818                                  	mov	[DIR_NUM],si
 14819                                  	call	STD_PRINTF
 14820                                  DTFREE:
 14821                                  	mov	ah,GET_DRIVE_FREESPACE ; 36h
 14822                                  	;mov	dl,[5Ch]
 14823                                  	mov	dl,[FCB]
 14824                                  	int	21h	; DOS -	2+ - GET DISK SPACE
 14825                                  			; DL = drive code (0 = default,	1 = A,2 = B,etc.)
 14826                                  	cmp	ax,-1
 14827                                  	jnz	short DTFREE1
 14828                                  DTRET:
 14829                                  	retn
 14830                                  DTFREE1:
 14831                                  	mul	cx
 14832                                  	mul	bx
 14833                                  	mov	[BYTES_FREE],ax
 14834                                  	mov	[BYTES_FREE+2],dx
 14835                                  	mov	dx,BYTEMESPTR
 14836                                  	jmp	STD_PRINTF
 14837                                  
 14838                                  ; =============== S U B	R O U T	I N E =======================================
 14839                                  
 14840                                  SHONAME:
 14841                                  DISPLAYNAME:
 14842                                  	; MSDOS 3.3
 14843                                  	mov	di,CHARBUF
 14844                                  	mov	cx,8
 14845                                  	rep	movsb
 14846                                  	mov	al,' '
 14847                                  	stosb
 14848                                  	mov	cx,3
 14849                                  	rep	movsb
 14850                                  	xor	ax,ax
 14851                                  	stosb
 14852                                  	push	dx
 14853                                  	mov	dx,CHARBUF
 14854                                  	mov	[STRING_PTR_2],dx
 14855                                  	mov	dx,STRINGBUF2PTR
 14856                                  	call	STD_PRINTF
 14857                                  	pop	dx
 14858                                  	retn
 14859                                  
 14860                                  %endif
 14861                                  
 14862                                  ;============================================================================
 14863                                  ; DIR.ASM, MSDOS 6.0, 1991
 14864                                  ;============================================================================
 14865                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 14866                                  
 14867                                  	; MSDOS 6.0
 14868                                  %if 0
 14869                                  
 14870                                  ;***	DIR.ASM - DIR internal command
 14871                                  
 14872                                  comment	% =================================================================
 14873                                  
 14874                                  This module replaces TCMD1A.ASM.  The old module was titled 
 14875                                  "PART4 COMMAND Transient routines".
 14876                                  
 14877                                  From residual documentation, I surmise that TCMD.ASM originally
 14878                                  contained the internal commands DIR, PAUSE, ERASE, TYPE, VOL, and
 14879                                  VER.  The file seems to have been successively split:
 14880                                  
 14881                                    TCMD -> TCMD1,TCMD2 -> TCMD1A,TCMD1B,TCMD2A,TCMD2B
 14882                                  
 14883                                  TCMD1A.ASM contained only the DIR command.
 14884                                  
 14885                                  Usage:
 14886                                  ------
 14887                                  
 14888                                  DIR <filespec> /w /p /b /s /l /c /o<sortorder> /a<attriblist>
 14889                                  
 14890                                  DIR /?
 14891                                  
 14892                                  
 14893                                  <filespec> may include any or none of:  drive; directory path;
 14894                                             wildcarded filename.  If drive or directory path are
 14895                                  	   omitted, the current defaults are used.  If the
 14896                                  	   file name or extension is omitted, wildcards are
 14897                                  	   assumed.
 14898                                  
 14899                                  /w	Wide listing format.  Files are displayed in compressed
 14900                                  	'name.ext' format.  Subdirectory files are enclosed in
 14901                                  	brackets, '[dirname]'.
 14902                                  
 14903                                  /p	Paged, or prompted listing.  A screenful is displayed
 14904                                  	at a time.  The name of the directory being listed appears
 14905                                  	at the top of each page.
 14906                                  
 14907                                  	Bugbug:  pages nead to be uniform length..?
 14908                                  
 14909                                  /b	Bare listing format.  Turns off /w or /p.  Files are 
 14910                                  	listed in compressed 'name.ext' format, one per line,
 14911                                  	without additional information.  Good for making batch
 14912                                  	files or for piping.  When used with /s, complete
 14913                                  	pathnames are listed.
 14914                                  
 14915                                  /s	Descend subdirectory tree.  Performs command on current
 14916                                  	or specified directory, then for each subdirectory below
 14917                                  	that directory.  Directory header and footer is displayed
 14918                                  	for each directory where matching files are found, unless
 14919                                  	used with /b.  /b suppresses headers and footers.
 14920                                  
 14921                                  	Tree is explored depth first, alphabetically within the
 14922                                  	same level.
 14923                                  
 14924                                  	Bugbug:  hidden directories aren't searched.
 14925                                  
 14926                                  /l	Display file names, extensions and paths in lowercase.	;M010
 14927                                  
 14928                                  /c	Display file compression ratio, if the file is on a MagicDrv
 14929                                  	compressed volume.
 14930                                  
 14931                                  /o	Sort order.  /o alone sorts by default order (dirs-first, name,
 14932                                  	extension).  A sort order may be specified after /o.  Any of
 14933                                  	the following characters may be used: nedsgc (name, extension,
 14934                                  	date/time, size, group-dirs-first, compression ratio).	Placing
 14935                                  	a '-' before any letter causes a downward sort on that field.
 14936                                  	E.g., /oe-d means sort first by extension in alphabetical order,
 14937                                  	then within each extension sort by date and time in reverse
 14938                                  	chronological order.
 14939                                  
 14940                                  /a	Attribute selection.  Without /a, hidden and system files
 14941                                  	are suppressed from the listing.  With /a alone, all files
 14942                                  	are listed.  An attribute list may follow /a, consisting of
 14943                                  	any of the following characters:  hsdar (hidden, system,
 14944                                  	directory, archive, read-only).  A '-' before any letter
 14945                                  	means 'not' that attribute.  E.g., /ar-d means files that
 14946                                  	are marked read-only and are not directory files.  Note
 14947                                  	that hidden or system files may be included in the listing.
 14948                                  	They are suppressed without /a but are treated like any other
 14949                                  	attribute with /a.
 14950                                  
 14951                                  /?	Help listing.  Display DIR useage information.	;M008;Handled externally
 14952                                  
 14953                                  /h has been removed.					;M008
 14954                                  
 14955                                  DIRCMD	An environment variable named DIRCMD is parsed before the
 14956                                  	DIR command line.  Any command line options may be specified
 14957                                  	in DIRCMD, and become defaults.  /? will be ignored in DIRCMD.
 14958                                  	A filespec may be specified in DIRCMD and will be used unless
 14959                                  	a filespec is specified on the command line.  Any switch
 14960                                  	specified in DIRCMD may be overridden on the command line.
 14961                                  	If the original DIR default action is desired for a particular
 14962                                  	switch, the switch letter may be preceded by a '-' on the
 14963                                  	command line.  E.g.,
 14964                                  
 14965                                  	  /-w	use long listing format
 14966                                  	  /-p	don't page the listing
 14967                                  	  /-b	don't use bare format
 14968                                  	  /-s	don't descend subdirectory tree
 14969                                  	  /-o	display files in disk order
 14970                                  	  /-a	suppress hidden and system files
 14971                                  
 14972                                  Notes:
 14973                                  ------
 14974                                  
 14975                                  For sorted listings, file entries are loaded into the TPA buffer, which
 14976                                  is usually about 64K in size.  This allows sorts of up to 3000 files at
 14977                                  a time.  Each entry takes up 21 bytes in the buffer (see EntryStruc below).
 14978                                  The byte after the last entry is 0FFh.  The first byte of each entry is
 14979                                  a flag byte which is made zero when the entry is loaded, and made one
 14980                                  when the entry is used.
 14981                                  
 14982                                  Revision History
 14983                                  ================
 14984                                  M01	md	7/13/90 	Use ROM BIOS data area to obtain screen height
 14985                                  				in the absence of ANSI.SYS
 14986                                  
 14987                                  M007	sa	8/1/90		Allow /p/b combination
 14988                                  
 14989                                  M008	sa	8/1/90		Remove /h parameter.  Eliminate code used
 14990                                  				to internally handle /? message.
 14991                                  
 14992                                  M010	sa	8/5/90		Add support for /l (lowercase) option.
 14993                                  
 14994                                  M011	sa	8/5/90		Patch up bug where MS-DOS does not load the
 14995                                  				first FCB with the drive number when the drive
 14996                                  				letter in the command line is preceded by a
 14997                                  				switch.  Now dir manually loads the drive
 14998                                  				number after parsing.
 14999                                  
 15000                                  M018	md	8/12/90 	Increment the screen height by 1 when obtained
 15001                                  				from the ROM BIOS.
 15002                                  
 15003                                  M023	sa	8/31/90		Prevent DIR from failing if it encounters
 15004                                  				a subdirectory having len(pathname)>MAXPATH.
 15005                                  				Just skip over that subdirectory.
 15006                                  
 15007                                  M028	dbo	9/24/90		When country=US, sort by strict character
 15008                                  				byte value, rather than collating table.
 15009                                  				This to match MS-DOS Shell's sort order.
 15010                                  
 15011                                  ========================================================================= %
 15012                                  
 15013                                  %endif
 15014                                  
 15015                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM (PCDOS 7.1)
 15016                                  ; 05/06/2023 - Retro DOS v4.2 COMMAND.COM (MSDOS 6.22)
 15017                                  ;ifdef DBLSPACE_HOOKS
 15018                                  ;NUM_DIR_SWS	equ	16	; # of dir switch synonyms in Dir_Sw_Ptrs list
 15019                                  ; 28/07/2024 - PCDOS 7.1 COMMAND.COM
 15020                                  NUM_DIR_SWS	equ	18
 15021                                  ;else
 15022                                  ; 16/02/2023 - Retro DOS v4.0 (v4.1) COMMAND.COM (MSDOS 5.0)
 15023                                  ;NUM_DIR_SWS	equ	14	; # of dir switch synonyms in Dir_Sw_Ptrs list
 15024                                  ;endif
 15025                                  
 15026                                  ;OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1
 15027                                  ;
 15028                                  ;		on/off bit record for /l, /b, /s, /p, /w, /c options
 15029                                  ;		(order is hard-coded; see OnOffSw)
 15030                                  ;		Inmem is set when entries are loaded in memory.
 15031                                  
 15032                                  ; 28/07/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 15033                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM (MSDOS 5.0)
 15034                                  mask.wide  equ 1	; dir /W switch
 15035                                  mask.pagd  equ 2	; dir /P switch
 15036                                  mask.subd  equ 4	; dir /S switch
 15037                                  mask.bare  equ 8	; dir /B switch
 15038                                  mask.lcase equ 16	; dir /L switch	
 15039                                  ;mask.inmem equ 32	;
 15040                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15041                                  mask.narrow equ 32	; dir /Z switch
 15042                                  mask.year4 equ 64	; dir /4 switch	
 15043                                  mask.inmem equ 128	; 
 15044                                  
 15045                                  ; 28/07/2024
 15046                                  ; 05/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15047                                  ;ifdef DBLSPACE_HOOKS
 15048                                  ;  OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1,cratio:1
 15049                                  ;else
 15050                                  ;  OptionRec	record	inmem:1,lcase:1,bare:1,subd:1,pagd:1,wide:1
 15051                                  ;endif
 15052                                  ;mask.cratio equ 1
 15053                                  ;mask.wide   equ 2
 15054                                  ;mask.pagd   equ 4
 15055                                  ;mask.subd   equ 8
 15056                                  ;mask.bare   equ 16
 15057                                  ;mask.lcase  equ 32
 15058                                  ;mask.inmem  equ 64
 15059                                  ;
 15060                                  mask.dev    equ 1
 15061                                  mask.baddir equ 2	
 15062                                  
 15063                                  NUM_ATTR_LTRS	equ	6	; length of attribute letter list
 15064                                  
 15065                                  ; 05/06/2023
 15066                                  ;ifdef DBLSPACE_HOOKS
 15067                                  NUM_ORDER_LTRS	equ	6	; length of sort order letter list
 15068                                  CRATIO_ORDER	equ	6	; position of 'C' in ORDER_LTRS
 15069                                  ;else
 15070                                  ;NUM_ORDER_LTRS	equ	5	; length of sort order letter list
 15071                                  ;endif
 15072                                  
 15073                                  ;ResultBuffer	struc		; structure of parse result buffer
 15074                                  ;ValueType	db	?
 15075                                  ;ValueTag	db	?
 15076                                  ;SynPtr		dw	?
 15077                                  ;ValuePtr	dd	?
 15078                                  ;ResultBuffer	ends
 15079                                  
 15080                                  ;ErrorRec	record	baddir:1,dev:1
 15081                                  ;
 15082                                  ;		Error bits are:
 15083                                  ;		  Invalid directory format
 15084                                  ;		  File is device
 15085                                  
 15086                                  ;EntryStruc	struc			; our private directory entry structure
 15087                                  ;used		db	?		; =0 until entry used, then =1
 15088                                  ;filename	db	8 dup (?)	; filename
 15089                                  ;fileext	db	3 dup (?)	; extension
 15090                                  ;fileattr	db	?		; file attributes
 15091                                  ;filetime	dw	?		; file time
 15092                                  ;filedate	dw	?		; file date
 15093                                  ;filesize	dd	?		; file size
 15094                                  ; 05/06/2023
 15095                                  ;;ifdef DBLSPACE_HOOKS
 15096                                  ;compratio	db	?		; compression ratio
 15097                                  ;;endif
 15098                                  ;EntryStruc	ends
 15099                                  
 15100                                  ;shove	macro	val		; hose-bag 8086 doesn't push immediate
 15101                                  ;	mov	ax,val		; invisible, dangerous use of AX!
 15102                                  ;	push	ax
 15103                                  ;	endm
 15104                                  
 15105                                  ;	public	Catalog		; our entry point
 15106                                  ;
 15107                                  ;	break	<DIR (Catalog) principal routines>
 15108                                  ;
 15109                                  ;	assume	cs:TRANGROUP,ds:TRANGROUP,es:nothing,ss:TRANGROUP
 15110                                  ; ---------------------------------------------------------------------------
 15111                                  ;	Bugbug:	Each routine should start with it's own ASSUME.
 15112                                  
 15113                                  ;----------------------------------------------------------------------------
 15114                                  ;----------------------------------------------------------------------------
 15115                                  
 15116                                  ; 16/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 15117                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:108Dh
 15118                                  
 15119                                  ;***	Catalog - DIR command main routine
 15120                                  ;
 15121                                  ;	ENTRY	FCB #1 in PSP has drive# from cmd-line or default
 15122                                  ;		Cmd-line tail text is at 81h, terminated by 0Dh
 15123                                  ;		CS, DS, ES, SS = TRANGROUP seg addr
 15124                                  ;		Tpa = TPA buffer seg addr
 15125                                  ;		BytCnt = # bytes in TPA buffer
 15126                                  ;
 15127                                  ;	EXIT	nothing
 15128                                  ;
 15129                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 15130                                  ;
 15131                                  ;	ERROR EXITS
 15132                                  ;
 15133                                  ;	  Errors are handled by setting up error message pointers
 15134                                  ;	   for Std_EPrintf and jumping to CError. Syntax errors in
 15135                                  ;	   the environment variable, however, are handled by printing
 15136                                  ;	   an error message and continuing.
 15137                                  ;
 15138                                  ;	EFFECTS
 15139                                  ;
 15140                                  ;	  Directory listing is displayed (on standard output).
 15141                                  ;	  APPEND is disabled. HeadFix routine is expected to
 15142                                  ;	   restore APPEND state.
 15143                                  ;	  Working directory may be changed. The user's default
 15144                                  ;	   directory is saved and flagged for restoration by RestUDir
 15145                                  ;	   during COMMAND cycle.
 15146                                  ;	  Lots of variables may be changed in TRANSPACE segment.
 15147                                  ;
 15148                                  ;	NOTES
 15149                                  ;
 15150                                  ;	  ES = TRANGROUP seg addr except when used to address the
 15151                                  ;	   the TPA buffer, where directory entries are loaded from disk.
 15152                                  
 15153                                  	; 16/02/2023
 15154                                  
 15155                                  ; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 15156                                  ; ----------------------------------------
 15157                                  ; MSDOS 6.22 COMMAND.COM - TRANGROUP:1167h
 15158                                  
 15159                                  ; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15160                                  ;----------------------------------------------------------------------------
 15161                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:11B7h
 15162                                  
 15163                                  CATALOG:
 15164                                  
 15165                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15166                                  %if 0
 15167                                  	; 07/06/2023
 15168                                  	; MSDOS 6.22 COMMAND COM feature only !
 15169                                  	call    screen_f_set	; set display parameters for video/text mode
 15170                                  	;			; (different depending on scr width/columns)
 15171                                  	call	SetDefaults
 15172                                  	call	ParseEnvironment
 15173                                  	call	ParseCmdLine
 15174                                  	jnc	short catalog1	; no parse error
 15175                                  	;jmp	catErr		; error msg is set up
 15176                                  	; 07/06/2023
 15177                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMANBD.COM
 15178                                  	jmp	catExtErr2
 15179                                  %else
 15180                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15181                                  	; PCDOS 7.1 COMMAND.COM
 15182 00001180 C606[8C9C]00            	mov	byte [nocommas],0
 15183 00001185 C606[8E9C]00            	mov	byte [bfree_not_kilo],0
 15184                                  				; use kilobyte if number of bytes is very big
 15185 0000118A 50                      	push	ax
 15186 0000118B 51                      	push	cx
 15187 0000118C 57                      	push	di
 15188 0000118D 56                      	push	si
 15189 0000118E 06                      	push	es
 15190 0000118F BE[0093]                	mov	si,no_sep_text	; NO_SEP=1 ; Removes the commas from numbers
 15191 00001192 E82015                  	call	find_name_in_environment
 15192 00001195 720A                    	jb	short catalog0
 15193 00001197 C606[8E9C]FF            	mov	byte [bfree_not_kilo],0FFh 
 15194                                  				; no need to kilobyte (short) display
 15195 0000119C C606[8C9C]FF            	mov	byte [nocommas],0FFh
 15196                                  				; do not use commas for displaying numbers
 15197                                  catalog0:
 15198 000011A1 07                      	pop	es
 15199 000011A2 5E                      	pop	si
 15200 000011A3 5F                      	pop	di
 15201 000011A4 59                      	pop	cx
 15202 000011A5 58                      	pop	ax
 15203 000011A6 E8D000                  	call	SetDefaults
 15204 000011A9 E8F400                  	call	ParseEnvironment
 15205 000011AC E80C01                  	call	ParseCmdLine
 15206 000011AF 7303                    	jnc	short catalog1	; no parse error
 15207                                  	;jmp	catErr
 15208                                  	; 31/07/2024
 15209 000011B1 E9C200                  	jmp	catExtErr2
 15210                                  %endif
 15211                                   
 15212                                  catalog1:
 15213 000011B4 E83501                  	call	SetOptions
 15214 000011B7 E80B01                  	call	SetCollatingTable
 15215                                  
 15216                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15217                                  %if 1
 15218 000011BA C606[8B9C]00            	mov	byte [narrow],0
 15219                                  	;test	byte [_Bits],20h	; /Z switch (narrow)
 15220 000011BF F606[EC9D]20            	test	byte [_Bits],mask.narrow ; 20h
 15221 000011C4 740A                    	jz	short catalog1_1
 15222 000011C6 C606[8B9C]FF            	mov	byte [narrow],0FFh
 15223 000011CB C606[8C9C]FF            	mov	byte [nocommas],0FFh
 15224                                  catalog1_1:
 15225                                  	;test	byte [_Bits],40h	; /4 switch
 15226 000011D0 F606[EC9D]40            	test	byte [_Bits],mask.year4	; 40h
 15227 000011D5 7407                    	jz	short catalog1_2
 15228                                  	;mov	byte [cs:yeardigit4],0FFh ; 4 digits year
 15229                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15230 000011D7 C606[8D9C]FF            	mov	byte [yeardigit4],0FFh
 15231 000011DC EB05                    	jmp	short catalog1_3
 15232                                  catalog1_2:
 15233                                  	;mov	byte [cs:yeardigit4],0	; 2 digits year
 15234 000011DE C606[8D9C]00            	mov	byte [yeardigit4],0
 15235                                  catalog1_3:
 15236                                  %endif
 15237                                  
 15238                                  ;	Drive # to operate on has already been placed in FCB by
 15239                                  ;	COMMAND preprocessing. OkVolArg & PathCrunch depend on that.
 15240                                  
 15241                                  	;;;test	Bits,mask bare
 15242                                  	;;test 	word [_Bits],8
 15243                                  	;test	byte [_Bits],8
 15244                                  	; 07/06/2023
 15245 000011E3 F606[EC9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0 (6.22)
 15246                                  		; 31/07/2024 ; mask.bare = 8 ; PCDOS 7.1
 15247 000011E8 750A                    	jnz	short catalog2	; don't display volume info for /b
 15248                                  	;invoke	OkVolArg	; find & display volume info
 15249 000011EA E8CB0D                  	call	OkVolArg
 15250                                  	;sub	byte [LeftOnpage],2
 15251 000011ED 832E[7F9C]02            	sub	word [LeftOnPage],2
 15252                                  				; record display lines used by volume info
 15253 000011F2 EB14                    	jmp	short catCrunch
 15254                                  
 15255                                  ;	OkVolArg side effects:
 15256                                  ;	APPEND is disabled;
 15257                                  ;	DTA established at DirBuf;
 15258                                  ;	Filename fields in FCB are wildcarded.
 15259                                  
 15260                                  catalog2:
 15261                                  ;	OkVolArg wasn't executed, so we have to do these ourselves.
 15262                                  
 15263                                  	;invoke	DisAppend	; disable APPEND
 15264 000011F4 E88A0D                  	call	DisAppend
 15265                                  
 15266                                  	;mov	dx,offset TRANGROUP:DirBuf
 15267 000011F7 BA[9A9D]                	mov	dx,DIRBUF
 15268 000011FA B41A                    	mov	ah,1Ah
 15269                                  	;mov	ah,Set_DMA
 15270 000011FC CD21                    	int	21h		; set DTA
 15271                                  
 15272                                  	;mov	di,FCB	; 5Ch	; ES:DI = ptr to FCB
 15273                                  	;inc	di		; ES:DI = ptr to filename field of FCB
 15274                                  	; 28/07/2024
 15275 000011FE BF5D00                  	mov	di, FCB+1 ; 5Dh
 15276 00001201 B03F                    	mov	al,'?'		; AL = wildcard character
 15277 00001203 B90B00                  	mov	cx,11
 15278 00001206 F3AA                    	rep	stosb		; wildcard filename field
 15279                                  
 15280                                  catCrunch:
 15281 00001208 E83C01                  	call	CrunchPath	; crunch pathname to get directory and filename
 15282 0000120B 7233                    	jc	short catRecErr	; handle recorded or extended error
 15283                                  
 15284                                  ;	User's directory has been saved, we've changed to specified directory.
 15285                                  ;	ComSw = error bits for later use
 15286                                  ;	FCB contains parsed filename
 15287                                  
 15288                                  	;cmp	byte [COMSW],0
 15289 0000120D 833E[6A9C]00            	cmp	word [COMSW],0
 15290 00001212 752C                    	jne	short catRecErr	; handle recorded error
 15291                                  
 15292 00001214 E88A01                  	call	InstallCtrlC	; install control-C handler
 15293                                  
 15294                                  ; 31/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 15295                                  %if 0
 15296                                  	; 07/06/2023
 15297                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15298                                  	; MSDOS 6.0 (DBLSPACE/DRVSPACE)
 15299                                  
 15300                                   	;test	word [_Bits],1	; mask.cratio
 15301                                  	test	byte [_Bits],mask.cratio ; compression ratio wanted?
 15302                                  	jz      short catalog4
 15303                                  	call    OpenCVF         ; yes, try to open CVF file
 15304                                  	jnc     short catalog4
 15305                                  
 15306                                  	;and	word [_Bits],0FFFEh ; not (mask cratio)
 15307                                  	and	byte [_Bits],~mask.cratio ; 0FEh
 15308                                  %endif
 15309                                  
 15310                                  catalog4:	; 07/06/2023
 15311 00001217 E89F0A                  	call	ZeroTotals	; zero grand totals
 15312 0000121A E8DD04                  	call	ListDir		; list main directory
 15313                                  	;jc	short catExtErr
 15314                                  	; 07/06/2023
 15315                                  	; MSDOS 6.22 COMMAND.COM
 15316 0000121D 7247                    	jc      short catExtErr1
 15317                                  
 15318                                  	;;;test	Bits,mask subd
 15319                                  	;;test	word [_Bits],4
 15320                                  	;test	byte [_Bits],4
 15321                                  	; 07/06/2023
 15322 0000121F F606[EC9D]04            	test	byte [_Bits],mask.subd ; 8 ; MSDOS 6.0 (6.22)
 15323                                  			; 31/07/2024   ; 4 ; PCDOS 7.1
 15324 00001224 7405                    	jz	short catalog3	; subdirectories option not set
 15325 00001226 E89001                  	call	ListSubds	; list subdirectories
 15326                                  	;jc	short catExtErr
 15327                                  	; 07/06/2023
 15328                                  	; MSDOS 6.22 COMMAND.COM
 15329 00001229 723B                    	jc      short catExtErr1
 15330                                  
 15331                                  catalog3:
 15332                                  ;	Check if any files were found.
 15333                                  
 15334                                  	;;;test	Bits,mask bare
 15335                                  	;;test	word [_Bits],8
 15336                                  	;test	byte [_Bits],8
 15337                                  	; 07/06/2023
 15338 0000122B F606[EC9D]08            	test	byte [_Bits],mask.bare ; 16 ; MSDOS 6.0 (6.22)
 15339                                  			; 31/07/2024   ; 8  ; PCDOS 7.1
 15340 00001230 750D                    	jnz	short catRet	; don't bother for bare format
 15341                                  
 15342                                  ; 31/07/2024
 15343                                  ; PCDOS 7.1 COMMAND.COM
 15344                                  %if 0
 15345                                  	mov	ax,[FileCntTotal]
 15346                                  	or	ax,ax
 15347                                  	jz	short catNoFiles ; no files found
 15348                                  %else
 15349 00001232 8B0E[BF9C]              	mov	cx,[FileCntTotal]
 15350 00001236 0B0E[C19C]              	or	cx,[FileCntTotal+2]
 15351 0000123A E317                    	jcxz	catNoFiles	; no files found
 15352                                  %endif
 15353                                  
 15354 0000123C E8BA02                  	call	DisplayTotals	; display trailing grand totals
 15355                                  	;jmp	short catRet	; all done
 15356                                  	; 25/04/2023
 15357                                  	; 07/06/2023
 15358                                  catRet:
 15359                                  	;retn	; MSDOS 5.0 COMMAND.COM
 15360                                  	
 15361                                  ; 31/07/2024
 15362                                  ; PCDOS 7.1 COMMAND.COM
 15363                                  %if 0
 15364                                  	; 07/06/2023
 15365                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15366                                  
 15367                                  	;test	word [_Bits],1	; mask.cratio
 15368                                  	test	byte [_Bits],mask.cratio
 15369                                  	jz      short catRetn
 15370                                  	call    CloseCVF
 15371                                  %endif
 15372                                  
 15373                                  catRetn:
 15374 0000123F C3                      	retn
 15375                                  
 15376                                  catRecErr:
 15377                                  
 15378                                  ;	ComSw may have error bit set. If not, do extended error.
 15379                                  
 15380                                  	;;;test	ComSw,mask dev
 15381                                  	;;test	word [COMSW],1
 15382                                  	;test	byte [COMSW],1
 15383 00001240 F606[6A9C]01            	test	byte [COMSW],mask.dev
 15384 00001245 750C                    	jnz	short catNoFiles 
 15385                                  				; filename is device, respond 'file not found'
 15386                                  	;;test	ComSw,mask baddir
 15387                                  	;;test	word [COMSW],2
 15388                                  	;test	byte [COMSW],2
 15389 00001247 F606[6A9C]02            	test	byte [COMSW],mask.baddir
 15390                                  	;jz	short catExtErr	; no ComSw error bits, must be extended error
 15391                                  	; 07/06/2023
 15392                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM 
 15393 0000124C 7418                    	jz	short catExtErr1
 15394                                  
 15395                                  	;mov	dx,offset TRANGROUP:BadCd_Ptr
 15396                                  				; invalid directory
 15397 0000124E BA[2B91]                	mov	dx,badcd_ptr
 15398                                  	;jmp	short catErr
 15399                                  	; 07/06/2023
 15400                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 15401 00001251 EB23                    	jmp	short catExtErr2	
 15402                                  
 15403                                  catNoFiles:
 15404                                  
 15405                                  ;	Display header and force 'file not found' message.
 15406                                  
 15407 00001253 E8EF07                  	call	DisplayHeader
 15408 00001256 B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2
 15409 00001259 C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 15410 0000125E BA[CB8F]                	mov	dx,extend_buf_ptr
 15411 00001261 A3[CB8F]                	mov	[extend_buf_ptr],ax
 15412                                  	;jmp	short catErr
 15413                                  	; 07/06/2023
 15414                                  	; MSDOS 6.22 COMMAND.COM
 15415 00001264 EB10                    	jmp	short catExtErr2
 15416                                  
 15417                                  catExtErr:	; Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 15418                                  	; 07/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15419                                  catExtErr1:
 15420                                  
 15421                                  ;	DOS has returned an error status. Get the extended error#, and
 15422                                  ;	set up an error message, changing 'No more files' error 
 15423                                  ;	to 'File not found' error.
 15424                                  
 15425 00001266 E8D00D                  	call	Set_Ext_Error_Msg
 15426 00001269 833E[CB8F]12            	cmp	word [extend_buf_ptr],ERROR_NO_MORE_FILES ; 18
 15427                                  	;jne	short catalog4  ; catErr ; MSDOS 5.0 COMMAND.COM
 15428                                  	; 07/06/2023
 15429                                  	; MSDOS 6.22 COMMAND.COM
 15430 0000126E 7506                    	jne	short catExtErr2	
 15431                                  
 15432 00001270 C706[CB8F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2
 15433                                  
 15434                                  ;catalog4:	; Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 15435                                  	; 07/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 15436                                  catExtErr2:
 15437                                  
 15438                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15439                                  %if 0
 15440                                  	;test	word [_Bits],1	; mask.cratio
 15441                                  	test	byte [_Bits],mask.cratio
 15442                                  				; close Compressed Volume File if cratio
 15443                                  	jz      short catErr
 15444                                  	call    CloseCVF
 15445                                  %endif
 15446                                  
 15447                                  ;	Error exit. Error message information has been set up
 15448                                  ;	for Std_EPrintf.
 15449                                  
 15450                                  catErr:
 15451 00001276 E9AB1A                  	jmp	cerror		; go to COMMAND error recycle point
 15452                                  
 15453                                  	; 25/04/2023
 15454                                  ;catRet:
 15455                                  	;retn
 15456                                  
 15457                                  ; ---------------------------------------------------------------------------
 15458                                  
 15459                                  ;***	SetDefaults - set default pathname, options
 15460                                  ;
 15461                                  ;	ENTRY	DS = TRANGROUP seg addr
 15462                                  ;
 15463                                  ;	EXIT	nothing
 15464                                  ;
 15465                                  ;	USED	AX,DI
 15466                                  ;
 15467                                  ;	EFFECTS
 15468                                  ;	  SrcBuf = '*',EOL - default pathname
 15469                                  ;	  PathPos = ptr to pathname
 15470                                  ;	  PathCnt = length of pathname
 15471                                  
 15472                                  	; 16/02/2023
 15473                                  SetDefaults:
 15474 00001279 BF[809E]                	mov	di,SrcBuf		; DI = ptr to pathname buffer
 15475 0000127C 893E[F09D]              	mov	[PathPos],di		; PathPos = ptr to pathname
 15476                                  	;mov	al,STAR
 15477 00001280 B02A                    	mov	al,'*'
 15478 00001282 AA                      	stosb
 15479                                  	;mov	al,END_OF_LINE_IN
 15480 00001283 B00D                    	mov	al,0Dh ; cr
 15481 00001285 AA                      	stosb				; SrcBuf = '*',0Dh
 15482 00001286 C706[EE9D]0100          	mov	word [PathCnt],1	; PathCnt = pathname length
 15483                                  
 15484 0000128C 31C0                    	xor	ax,ax			; AX = 0
 15485 0000128E A3[6A9C]                	mov	[COMSW],ax		; = no error
 15486 00001291 A3[EC9D]                	mov	[_Bits],ax		; = options off
 15487 00001294 A2[1D9E]                	mov	[DestBuf],al		; = no sort
 15488 00001297 C606[F49D]06            	mov	byte [AttrSpecified],ATTR_HIDDEN+ATTR_SYSTEM ; 6
 15489 0000129C A2[F59D]                	mov	[AttrSelect],al		; exclude hidden, system files
 15490                                  peRet:	; 25/04/2023
 15491 0000129F C3                      	retn
 15492                                  
 15493                                  ; ---------------------------------------------------------------------------
 15494                                  
 15495                                  ;***	ParseEnvironment - find and parse our environment variable
 15496                                  ;
 15497                                  ;	Find our environment variable and parse it. If a parse
 15498                                  ;	error occurs, issue an error message. The parse results
 15499                                  ;	up to the error will still have effect. Always leave
 15500                                  ;	the option variables in a useable state.
 15501                                  ;
 15502                                  ;	ENTRY	DS = TRANGROUP seg addr
 15503                                  ;
 15504                                  ;	EXIT	nothing
 15505                                  ;
 15506                                  ;	USED	AX,BX,CX,DX,SI,DI
 15507                                  ;
 15508                                  ;	EFFECTS
 15509                                  ;
 15510                                  ;	  Bits may contain new option settings.
 15511                                  ;	  DestBuf may contain new series of sort codes.
 15512                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 15513                                  ;	  SrcBuf may contain a new default pathname/filespec.
 15514                                  ;	  PathPos, PathCnt updated for new pathname.
 15515                                  ;
 15516                                  ;	  If a parse error occurred, an error message will be issued.
 15517                                  
 15518                                  	; 16/02/2023
 15519                                  ParseEnvironment:
 15520 000012A0 E80D04                  	call	GetEnvValue		; get environment variable value
 15521 000012A3 72FA                    	jc	short peRet		; name not found in environment
 15522                                  
 15523                                  ;	SI = ptr to value of environment variable, in TRANGROUP seg
 15524                                  
 15525 000012A5 E85E05                  	call	Parse_Line		; parse environment value
 15526 000012A8 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 15527                                  	;cmp	ax,END_OF_LINE
 15528 000012AB 74F2                    	je	short peRet		; successful completion
 15529                                  
 15530                                  ;	Some kind of parse error occurred.
 15531                                  ;	We're set up for a Std_EPrintf call.
 15532                                  
 15533 000012AD E86541                  	call	std_eprintf		; display the parse error
 15534                                  	;mov	byte [Msg_Disp_Class],util_msg_class ; -1
 15535                                  					; restore default msg class
 15536 000012B0 C606[C98F]FF            	mov	byte [msg_disp_class],0FFh ; -1
 15537                                  	;mov	dx,offset TRANGROUP:ErrParsEnv_Ptr
 15538 000012B5 BA[8692]                	mov	dx,errparsenv_ptr
 15539                                  	;;invoke Printf_Crlf		; "(Error occurred in environment.."
 15540                                  	;call	Printf_Crlf
 15541                                  	; 25/04/2023
 15542                                  	;retn
 15543 000012B8 E95441                  	jmp	Printf_Crlf
 15544                                  					;M008;Internal handling of /? removed
 15545                                  ;peOk:	and	Bits,not mask help	; disallow /h in environment variable
 15546                                  	; 25/04/2023
 15547                                  ;peRet:
 15548                                  	;retn
 15549                                  
 15550                                  ; ---------------------------------------------------------------------------
 15551                                  
 15552                                  ;***	ParseCmdLine - parse and record command line parameters
 15553                                  ;
 15554                                  ;	ENTRY	PSP offset 81h is beginning of cmd line buffer
 15555                                  ;		DS, ES, CS = TRANGROUP seg addr
 15556                                  ;
 15557                                  ;	EXIT	CY = set if parse error occurred
 15558                                  ;
 15559                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 15560                                  ;		AX = system parser error code
 15561                                  ;		DX = ptr to message block
 15562                                  ;
 15563                                  ;	USED	AX,BX,CX,DX,SI,DI
 15564                                  ;
 15565                                  ;	EFFECTS
 15566                                  ;
 15567                                  ;	  Bits may contain new option settings.
 15568                                  ;	  DestBuf may contain new series of sort codes.
 15569                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 15570                                  ;	  SrcBuf may contain a new default pathname/filespec.
 15571                                  ;	  PathPos, PathCnt updated for new pathname.
 15572                                  ;
 15573                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 15574                                  ;	  Msg_Disp_Class = parse error class
 15575                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 15576                                  ;	  Message block (see DX) is set up for parse error message
 15577                                  
 15578                                  	; 16/02/2023
 15579                                  ParseCmdLine:
 15580 000012BB BE8100                  	mov	si,81h			; SI = ptr to cmd-line tail text
 15581 000012BE E84505                  	call	Parse_Line		; parse cmd line tail
 15582 000012C1 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 15583                                  	;;cmp	ax,END_OF_LINE
 15584                                  	; 25/04/2023
 15585                                  	;je	short pcOk		; parse completed successfully
 15586                                  
 15587                                  ;	A parse error occurred. We're all set up for message output.
 15588                                  
 15589                                  	; 25/04/2023
 15590                                  	; cf = 1 (ax < 0FFFFh)
 15591                                  	;stc		   		; return failure
 15592                                  	;jmp	short pcRet
 15593                                  	; 25/04/2023
 15594                                  	;retn
 15595                                  pcOk:
 15596                                  	; 25/04/2023
 15597                                  	;cf = 0 (ax = 0FFFFh)
 15598                                  	;clc				; return success
 15599                                  pcRet:
 15600 000012C4 C3                      	retn
 15601                                  
 15602                                  ; ---------------------------------------------------------------------------
 15603                                  
 15604                                  ;***	SetCollatingTable - set up character collating table for sorting
 15605                                  ;
 15606                                  ;	If country is other than USA, try to get a collating table
 15607                                  ;	for character sorting. For USA, use straight byte values.
 15608                                  ;	This is so DIR behaves like the MS-DOS Shell, which sorts
 15609                                  ;	by straight byte values in the USA for better performance.
 15610                                  ;
 15611                                  ;	ENTRY	ES = TRANGROUP seg addr
 15612                                  ;
 15613                                  ;	EXIT	nothing
 15614                                  ;
 15615                                  ;	USED	AX,BX,CX,DX,DI
 15616                                  ;
 15617                                  ;	EFFECTS
 15618                                  ;
 15619                                  ;	  If collating table is set -
 15620                                  ;	    CountryPtrId = 6.
 15621                                  ;	    CountryPtr points to collating table.
 15622                                  ;
 15623                                  ;	  Otherwise -
 15624                                  ;	    CountryPtrId = 0.
 15625                                  
 15626                                  SetCollatingTable:
 15627                                  
 15628                                  ;	Begin modification M028
 15629                                  
 15630                                  	;mov	dx,offset TRANGROUP:InternatVars
 15631                                  	;			; DS:DX = ptr to international info buffer
 15632 000012C5 BA[FEA5]                	mov	dx,INTERNATVARS
 15633 000012C8 B80038                  	mov	ax,3800h
 15634                                  	;mov	ax,INTERNATIONAL << 8
 15635                                  	;;mov	ax,INTERNATIONAL shl 8
 15636                                  				; AX = 'Get current country info'
 15637 000012CB CD21                    	int	21h		; call DOS
 15638 000012CD 7217                    	jc	short scNoTable	; error - so don't collate
 15639                                  
 15640                                  ;	BX = country code
 15641                                  
 15642 000012CF 83FB01                  	cmp	bx,1
 15643 000012D2 7412                    	je	short scNoTable	; we're in USA, don't collate
 15644                                  
 15645                                  ;	End modification M028
 15646                                  
 15647                                  ;*	Country code is other than USA. Try to get a collating table.
 15648                                  
 15649 000012D4 B80665                  	mov	ax,6506h
 15650                                  	;mov	ax,(GETEXTCNTRY << 8) + SETCOLLATE
 15651                                  	;;mov	ax,(GETEXTCNTRY shl 8) + SETCOLLATE
 15652                                  				; AH = 'Get Extended Country Info'
 15653                                  				; AL = 'Get Pointer to Collating Table'
 15654 000012D7 BBFFFF                  	mov	bx,-1		; BX = code page of interest = CON
 15655 000012DA B90500                  	mov	cx,5		; CX = length of info buffer
 15656 000012DD 89DA                    	mov	dx,bx		; DX = country ID = default
 15657                                  	;mov	di,offset TRANGROUP:CountryPtrInfo
 15658 000012DF BF[1EA6]                	mov	di,CountryPtrInfo
 15659                                  				; ES:DI = ptr to info buffer
 15660 000012E2 CD21                    	int	21h		; call DOS
 15661 000012E4 7305                    	jnc	short scRet	; success
 15662                                  
 15663                                  ;*	Set CountryPtrId = 0 to signal no collating table.
 15664                                  
 15665                                  scNoTable:			;M028
 15666 000012E6 C606[1EA6]00            	mov	byte [CountryPtrId],0
 15667                                  scRet:
 15668 000012EB C3                      	retn
 15669                                  
 15670                                  ; ---------------------------------------------------------------------------
 15671                                  
 15672                                  ;***	SetOptions - check and set options
 15673                                  ;
 15674                                  ;	ENTRY	nothing
 15675                                  ;
 15676                                  ;	EXIT	nothing
 15677                                  ;
 15678                                  ;	USED	AX,BX,CX,DX
 15679                                  ;
 15680                                  ;	EFFECTS
 15681                                  ;
 15682                                  ;	  Bits may contain modified option settings.
 15683                                  ;	  Display_Ioctl table, including LinPerPag variable, is filled in.
 15684                                  ;	  LeftOnPage is initialized to # lines till end of page is handled.
 15685                                  ;	  PerLine is set according to /w presence.
 15686                                  
 15687                                  	; 16/02/2023
 15688                                  
 15689                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 15690                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:12BEh
 15691                                  
 15692                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 15693                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1335h
 15694                                  
 15695                                  SetOptions:
 15696                                  
 15697                                  ;	If bare listing requested, cancel wide listings.
 15698                                  
 15699                                  	;;;test	Bits,mask bare
 15700                                  	;;test	word [_Bits],8
 15701                                  	;test	byte [_Bits],8
 15702                                  	; 07/06/2023
 15703 000012EC F606[EC9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 15704                                  		; 31/07/2024 ; mask.bare = 8 ; PCDOS 7.1
 15705 000012F1 7405                    	jz	short setopts1
 15706                                  	;;;and	Bits,not mask wide	;M007;Allow /p with /b
 15707                                  	;;and	word [_Bits],0FFFEh
 15708                                  	;;and	byte [_Bits],0FEh
 15709                                  	; 31/07/2024
 15710                                  	;and	word [_Bits],0FFFEh ; PCDOS 7.1 COMMAND.COM
 15711                                  	; 07/06/2023
 15712 000012F3 8026[EC9D]FE            	and	byte [_Bits],~mask.wide ; 0FDh ; MSDOS 6.0
 15713                                  			; 31/07/2024	; 0FEh ; PCDOS 7.1 	
 15714                                  
 15715                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 15716                                  %if 0
 15717                                  ;setopts1:	; MSDOS 5.0 COMMAND.COM
 15718                                  	; 07/06/2023
 15719                                   	; MSDOS 6.22 COMMAND.COM
 15720                                  setopts0:
 15721                                  	;test	word [_Bits],12h  ; (mask bare) or (mask wide)
 15722                                  	test	byte [_Bits],(mask.bare|mask.wide)
 15723                                  	jz      short setopts1
 15724                                  	;and 	word [_Bits],0FFFEh ; not mask cratio
 15725                                  	and	byte [_Bits],~mask.cratio
 15726                                  %endif
 15727                                  
 15728                                  setopts1:
 15729                                  ;	Set # lines per display page.
 15730                                  
 15731                                  ;M01  Obtain screen height from ROM BIOS data area
 15732                                  ;
 15733                                  ;M01	mov	LinPerPag,LINESPERPAGE	; default value
 15734                                  
 15735 000012F8 1E                      	push	ds
 15736                                  	;mov	ax,ROMBIOS_DATA 	; Get ROM Data segment
 15737 000012F9 B84000                  	mov	ax,40h
 15738 000012FC 8ED8                    	mov	ds,ax			;
 15739                                  	;Assume	DS:ROMBIOS_DATA
 15740                                  
 15741                                  	;mov	al,[CRT_Rows] ; [84h]	; Get max rows
 15742 000012FE A08400                  	mov	al,[84h]
 15743 00001301 1F                      	pop	ds			;
 15744                                  	;Assume	DS:Trangroup
 15745                                  
 15746 00001302 08C0                    	or	al,al			; If zero specified
 15747 00001304 7502                    	jnz	short setopts2		;
 15748                                  
 15749                                  	;mov	al,LINESPERPAGE 	; assume 24 rows
 15750 00001306 B019                    	mov	al,25	; MSDOS 5.0 COMMAND.COM (TRANGROUP:11D1h)
 15751                                  setopts2:
 15752 00001308 30E4                    	xor	ah,ah
 15753                                  setopts3:
 15754 0000130A FEC0                    	inc	al			; height + 1 ;M018
 15755                                  
 15756 0000130C A3[769F]                	mov	[LinPerPag],ax		; set the rows now
 15757                                  
 15758                                  ; Now the console driver can change the rows if it knows better (M01 end)
 15759                                  
 15760                                  	;mov	ax,(IOCTL shl 8)+GENERIC_IOCTL_HANDLE
 15761                                  					; IOCTL for handles
 15762 0000130F B80C44                  	mov	ax,440Ch
 15763                                  	;mov	bx,STDOUT		; handle #
 15764 00001312 BB0100                  	mov	bx,1
 15765                                  	;mov	ch,IOC_SC		; screen
 15766 00001315 B503                    	mov	ch,3
 15767                                  	;mov	cl,get_generic		; get display info
 15768 00001317 B17F                    	mov	cl,7Fh
 15769 00001319 BA[669F]                	mov	dx,Display_Ioctl	; info block
 15770 0000131C CD21                    	int	21h			; call DOS
 15771                                  
 15772 0000131E A1[769F]                	mov	ax,[LinPerPag]		; AX = # lines per page
 15773 00001321 A3[7F9C]                	mov	[LeftOnPage],ax		; initialize # lines left on page
 15774                                  
 15775                                  ;	Set # entries per line.
 15776                                  
 15777                                  	;mov	byte [PerLine],NORMPERLIN
 15778                                  					; # entries per line without /w
 15779 00001324 C606[7C9C]01            	mov	byte [PerLine],1
 15780                                  	;;;test	Bits,mask wide
 15781                                  	;;test	word [_Bits],1
 15782                                  	;test	byte [_Bits],1
 15783                                  	; 07/06/2023
 15784 00001329 F606[EC9D]01            	test	byte [_Bits],mask.wide ; 2 ; MSDOS 6.0
 15785                                  			; 31/07/2024   ; 1 ; PCDOS 7.1
 15786 0000132E 7405                    	jz	short setopts4
 15787                                  	;mov	byte [PerLine],WIDEPERLIN
 15788                                  					; # entries per line with /w
 15789 00001330 C606[7C9C]05            	mov	byte [PerLine],5
 15790                                  setopts4:
 15791                                  				;M011;start;The following code checks if a drive
 15792                                  				;letter has been parsed into SrcBuf, and if
 15793                                  				;so, the correct drive number is loaded into
 15794                                  				;the first FCB, at offset 5C.
 15795                                  
 15796                                  	;cmp	TRANGROUP:[SrcBuf+1],COLON_CHAR	; is this a drive letter?
 15797 00001335 803E[819E]3A            	cmp	byte [SrcBuf+1],':'
 15798 0000133A 750A                    	jne	short soRet
 15799                                  	;mov	al,TRANGROUP:[SrcBuf]		; load drive letter into al
 15800 0000133C A0[809E]                	mov	al,[SrcBuf]
 15801                                  	;and	al,not 20h			; capitalize ASCII drive letter (LowerCase-32)-->UpperCase
 15802 0000133F 24DF                    	and	al,0DFh ; ~20h ; not 20h
 15803 00001341 2C40                    	sub	al,'@'	; 40h			; convert to 1-based number (1=A)
 15804 00001343 A25C00                  	mov	[FCB],al  ; [5Ch]		; store in first FCB
 15805                                  						;M011;end
 15806                                  soRet:
 15807 00001346 C3                      	retn
 15808                                  
 15809                                  ; ---------------------------------------------------------------------------
 15810                                  
 15811                                  ;***	CrunchPath - analyze supplied or default pathname
 15812                                  ;
 15813                                  ;	ENTRY	PathPos = ptr to pathname buffer
 15814                                  ;		PathCnt = length of pathname, not incl trailing delimiter
 15815                                  ;		Pathname in buffer must end in delimiter (like CR) and
 15816                                  ;		 must have space for another char after the delimiter.
 15817                                  ;
 15818                                  ;	EXIT	CY = clear if no error
 15819                                  ;		We are changed to directory found in pathname
 15820                                  ;		Previous directory ready to be restored via RestUDir
 15821                                  ;		FCB filename fields contain filename (possibly w/ wildcards)
 15822                                  ;
 15823                                  ;		If error occurred,
 15824                                  ;		CY = set
 15825                                  ;		ComSw = error bits (see ErrorRec)
 15826                                  ;		If ComSw not set,
 15827                                  ;		Ready for DOS Get Extended Error call
 15828                                  
 15829                                  	; 16/02/2023
 15830                                  CrunchPath:
 15831 00001347 E87802                  	call	FileIsDevice
 15832 0000134A 7507                    	jne	short crpath1	; not a device, skip ahead
 15833                                  	;;;or	ComSw,mask dev	; signal file is device
 15834                                  	;;or	word [COMSW],1
 15835                                  	;or	byte [COMSW],1
 15836 0000134C 800E[6A9C]01            	or	byte [COMSW],mask.dev
 15837 00001351 EB2F                    	jmp	short cpErr	; return error
 15838                                  crpath1:
 15839 00001353 FF36[F09D]              	push	word [PathPos]	; save ptr to pathname
 15840 00001357 C606[F89D]FF            	mov	byte [DirFlag],-1
 15841                                  				; tell PathCrunch not to parse file into FCB
 15842 0000135C E8C116                  	call	PathCrunch	; change to directory in pathname
 15843 0000135F C606[F89D]00            	mov	byte [DirFlag],0
 15844                                  				; reset our little flag
 15845 00001364 5E                      	pop	si		; SI = ptr to pathname
 15846 00001365 7208                    	jc	short cpNoDir	; didn't find directory path
 15847 00001367 741A                    	jz	short cpRet	; found directory path w/ no filename
 15848                                  				;  - leave wildcard default in FCB and return
 15849                                  
 15850                                  ;*	We found a directory, and there was a filename attached.
 15851                                  ;	DestTail = ptr to ASCIIZ filename
 15852                                  
 15853 00001369 8B36[1A9E]              	mov	si,[DestTail]	; SI = ptr to filename
 15854 0000136D EB28                    	jmp	short cpFile	; go parse the file into FCB
 15855                                  
 15856                                  ;*	PathCrunch failed to find a directory in the pathname.
 15857                                  ;
 15858                                  ;	Msg_Numb = error code
 15859                                  ;	DestIsDir = nonzero if path delimiter char's occur in pathname
 15860                                  ;	SI = ptr to pathname (now an ASCIIZ string)
 15861                                  
 15862                                  cpNoDir:
 15863 0000136F A1[939F]                	mov	ax,[Msg_Numb]	  ; AX = error code from PathCrunch
 15864 00001372 09C0                    	or	ax,ax
 15865 00001374 750C                    	jnz	short cpErr	  ; error occurred - return it
 15866 00001376 803E[189E]00            	cmp	byte [DestIsDir],0
 15867 0000137B 7407                    	je	short cpMaybe	  ; no path delimiters seen, maybe it's a file
 15868                                  crpath3:
 15869                                  	;;;or	ComSw,mask baddir ; signal invalid directory name
 15870                                  	;;or	word [COMSW],2
 15871                                  	;or	byte [COMSW],2
 15872 0000137D 800E[6A9C]02            	or	byte [COMSW],mask.baddir
 15873                                  	;jmp	short cpErr	  ; return error
 15874                                  	; 16/02/2023
 15875                                  cpErr:
 15876 00001382 F9                      	stc			  ; return error
 15877                                  cpRet:
 15878 00001383 C3                      	retn
 15879                                  
 15880                                  cpMaybe:
 15881                                  ;	SI = ptr to pathname
 15882                                  
 15883                                  	;cmp	byte [si+1],COLON_CHAR
 15884 00001384 807C013A                	cmp	byte [si+1],':'
 15885 00001388 7501                    	jne	short crpath2	  ; no drive specifier, skip ahead
 15886 0000138A AD                      	lodsw			  ; SI = ptr past drive specifier "d:"
 15887                                  crpath2:
 15888 0000138B 813C2E2E                	cmp	word [si],".."	; 2E2Eh
 15889 0000138F 7506                    	jne	short cpFile	  ; if not "..", treat as a file
 15890 00001391 807C0200                	cmp	byte [si+2],0
 15891                                  	;jne	short cpFile	  ; or if there's more after "..", treat as file
 15892                                  	;;;;or	ComSw,mask baddir ; signal invalid directory
 15893                                  	;;;or	word [COMSW],2
 15894                                  	;;or	byte [COMSW],2
 15895                                  	;or	byte [COMSW],mask.baddir
 15896                                  	;jmp	short cpErr	  ; return error
 15897                                  	; 16/02/2023
 15898 00001395 74E6                    	je	short crpath3
 15899                                  
 15900                                  ;	The preceding code was taken from the old DIR routine.
 15901                                  ;	It's garbage, I'm afraid. It's meant to check for ".."
 15902                                  ;	occurring when we're at the root directory. Too bad it
 15903                                  ;	doesn't handle problems with "..\..", etc.
 15904                                  
 15905                                  ;	We're ready to parse a filename into the FCB.
 15906                                  ;	SI = ptr to ASCIIZ filename
 15907                                  
 15908                                  cpFile:	
 15909 00001397 BF5C00                  	mov	di,FCB	; 5Ch	; DI = ptr to FCB
 15910 0000139A B80E29                  	mov	ax,290Eh
 15911                                  	;mov	ax,(Parse_File_Descriptor<<8)|0Eh
 15912                                  	;;mov	ax,(Parse_File_Descriptor shl 8) or 0Eh
 15913                                  				; wildcards already in FCB used as defaults
 15914 0000139D CD21                    	int	21h
 15915 0000139F F8                      	clc			; return success
 15916                                  	;jmp	short cpRet
 15917                                  	; 16/02/2023
 15918 000013A0 C3                      	retn
 15919                                  
 15920                                  ;cpErr:
 15921                                  ;	stc			; return error
 15922                                  ;cpRet:
 15923                                  ;	retn
 15924                                  
 15925                                  ; ---------------------------------------------------------------------------
 15926                                  
 15927                                  ;***	InstallCtrlC - install our private control-C handler
 15928                                  ;
 15929                                  ;	Put our control-c handler in front of command.com's default
 15930                                  ;	handler, to make sure the user's default directory gets restored.
 15931                                  ;	This shouldn't be necessary, but, for now, there are situations
 15932                                  ;	where the TDATA segment is left in a modified state when a
 15933                                  ;	control-c occurs.  This means that the transient will be
 15934                                  ;	reloaded, and the user's directory cannot be restored.
 15935                                  ;
 15936                                  ;	Bugbug:  fix the wider problem?  Involves message services.  Ugly.
 15937                                  ;
 15938                                  ;	ENTRY	nothing
 15939                                  ;
 15940                                  ;	EXIT	nothing
 15941                                  ;
 15942                                  ;	USED	AX,BX,DX
 15943                                  ;
 15944                                  ;	EFFECTS
 15945                                  ;
 15946                                  ;	  CtrlCHandler address placed in int 23 vector.
 15947                                  ;
 15948                                  ;	NOTE
 15949                                  ;
 15950                                  ;	  Command.com's basic control-c handler will be restored
 15951                                  ;	  to the int 23 vector by the HeadFix routine, after DIR finishes.
 15952                                  
 15953                                  	; 16/02/2023
 15954                                  InstallCtrlC:
 15955 000013A1 06                      	push	es			; preserve ES
 15956 000013A2 B82335                  	mov	ax,3523h
 15957                                  	;mov	ax,(GET_INTERRUPT_VECTOR<<8)+23h
 15958                                  	;;mov	ax,(GET_INTERRUPT_VECTOR shl 8) + 23h
 15959 000013A5 CD21                    	int	21h
 15960 000013A7 891E[23A6]              	mov	[OldCtrlCHandler],bx	; save old int 23 vector
 15961 000013AB 8C06[25A6]              	mov	[OldCtrlCHandler+2],es	 
 15962 000013AF 07                      	pop	es			; restore ES
 15963                                  
 15964 000013B0 BA[C41C]                	mov	dx,CtrlCHandler 	; DS:DX = ptr to CtrlCHandler
 15965 000013B3 B82325                  	mov	ax,2523h
 15966                                  	;mov	ax,(SET_INTERRUPT_VECTOR<<8)+23h
 15967                                  	;;mov	ax,(SET_INTERRUPT_VECTOR shl 8) + 23h
 15968 000013B6 CD21                    	int	21h
 15969 000013B8 C3                      	retn
 15970                                  
 15971                                  ; ---------------------------------------------------------------------------
 15972                                  
 15973                                  ;***	ListSubds - search and list files in subdirectories
 15974                                  ;
 15975                                  ;	ENTRY	Current directory (on selected drive) is top of subdir tree
 15976                                  ;		FCB is still set up for file searches
 15977                                  ;		Bits, AttrSpecified, AttrSelect, DestBuf all still set up
 15978                                  ;
 15979                                  ;	EXIT	CY = clear if no error
 15980                                  ;		FileCnt = # files found & displayed
 15981                                  ;		FileSiz = total size of files found
 15982                                  ;
 15983                                  ;		If error,
 15984                                  ;		CY = set
 15985                                  ;		Ready for DOS Get Extended Error call
 15986                                  ;
 15987                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 15988                                  ;
 15989                                  ;	EFFECTS
 15990                                  ;
 15991                                  ;	  FileCntTotal, FileSizTotal are updated.
 15992                                  ;	  Subdirectories may be listed on standard output device.
 15993                                  ;
 15994                                  ;	NOTES
 15995                                  ;
 15996                                  ;	  ListSubds seeds the recursive entry point lsNode with a ptr
 15997                                  ;	   to a buffer where we'll stack up subdirectory filenames.
 15998                                  ;	   Each name is stored ASCIIZ.
 15999                                  
 16000                                  	; 16/02/2023
 16001                                  ListSubds:
 16002                                  	;invoke	SetRest1		; make sure user's dir gets restored
 16003 000013B9 E8561D                  	call	SetRest1
 16004                                  
 16005 000013BC BB[DA9E]                	mov	bx,ScanBuf   		; BX = ptr to child name buffer
 16006                                  lsNode:
 16007 000013BF C60700                  	mov	byte [bx],0		; start with null child name
 16008                                  lsLoop:
 16009 000013C2 E88702                  	call	FindNextChild		; search for next subdirectory
 16010 000013C5 7235                    	jc	short lsErr		; search failed - examine error
 16011                                  
 16012 000013C7 89DA                    	mov	dx,bx			; DX = ptr to child's name
 16013 000013C9 E8ED04                  	call	ChangeDir		; enter child directory
 16014                                  
 16015                                  					; M023;start
 16016 000013CC 7306                    	jnc	short lstsd1		; check for error
 16017                                  	;cmp	ax,3
 16018 000013CE 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND	; error due to len(pathname)>MAXPATH?
 16019 000013D1 74EF                    	je	short lsLoop		; yes, skip over this subdirectory
 16020                                  	;jmp	short lsRet		; no, other error: DIR must fail
 16021                                  	; 16/02/2023			; M023;end
 16022 000013D3 C3                      	retn
 16023                                  lstsd1:	
 16024 000013D4 53                      	push	bx
 16025 000013D5 E82203                  	call	ListDir			; list the directory
 16026 000013D8 5B                      	pop	bx
 16027                                  
 16028                                  ;	Note we're ignoring errors returned here.
 16029                                  
 16030 000013D9 89DF                    	mov	di,bx			; DI = ptr to child's name
 16031 000013DB B90D00                  	mov	cx,13			; CX = max name length w/ null
 16032 000013DE 30C0                    	xor	al,al			; AL = zero byte to look for
 16033 000013E0 F2AE                    	repne	scasb			; DI = ptr to next name pos'n in buf
 16034 000013E2 53                      	push	bx			; save ptr to child's name
 16035 000013E3 89FB                    	mov	bx,di			; BX = ptr to next name pos'n in buf
 16036 000013E5 E8D7FF                  	call	lsNode			; recurse from new node
 16037 000013E8 5B                      	pop	bx			; BX = ptr to child's name
 16038 000013E9 9C                      	pushf				; save error condition
 16039                                  	
 16040                                  	;;shove	0
 16041                                  	;mov	ax,0
 16042 000013EA 29C0                    	sub	ax,ax ; 0
 16043 000013EC 50                      	push	ax
 16044                                  	;shove	".."
 16045 000013ED B82E2E                  	mov	ax,'..'  ; 2E2Eh
 16046 000013F0 50                      	push	ax
 16047 000013F1 89E2                    	mov	dx,sp			; DX = ptr to "..",0 on stack
 16048 000013F3 E8C304                  	call	ChangeDir		; return to parent directory
 16049 000013F6 58                      	pop	ax			; restore stack
 16050 000013F7 58                      	pop	ax
 16051                                  
 16052 000013F8 9D                      	popf				; restore error condition from child
 16053                                  	;jc	short lsRet		; return error
 16054                                  	;jmp	short lsLoop		; look for more children
 16055                                  	; 16/02/2023
 16056 000013F9 73C7                    	jnc	short lsLoop
 16057 000013FB C3                      	retn
 16058                                  lsErr:
 16059 000013FC E84A0C                  	call	get_ext_error_number	; AX = extended error code
 16060                                  	;cmp	ax,2
 16061 000013FF 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND
 16062 00001402 7406                    	je	short lsRet		; file not found, we're ok
 16063                                  	;cmp	ax,18
 16064 00001404 83F812                  	cmp	ax,ERROR_NO_MORE_FILES
 16065 00001407 7401                    	je	short lsRet		; no more files, we're ok
 16066 00001409 F9                      	stc				; return other errors
 16067                                  lsRet:	
 16068 0000140A C3                      	retn
 16069                                  
 16070                                  ; ---------------------------------------------------------------------------
 16071                                  
 16072                                  	;break	<DIR support routines>
 16073                                  
 16074                                  ;***	SUPPORT ROUTINES
 16075                                  
 16076                                  ; ----------------------
 16077                                  
 16078                                  ;***	CheckChild - check potential subdirectory name for FindNextChild
 16079                                  ;
 16080                                  ;	ENTRY	DirBuf contains DOS Find-buffer with potential child
 16081                                  ;		BX = ptr to last child's name
 16082                                  ;		BP = ptr to temp child's name
 16083                                  ;
 16084                                  ;	EXIT	nothing
 16085                                  ;
 16086                                  ;	USED	AX,CX,SI,DI
 16087                                  ;
 16088                                  ;	EFFECTS
 16089                                  ;
 16090                                  ;	  Filename pointed to by BP may be changed.
 16091                                  ;
 16092                                  ;	NOTES
 16093                                  ;
 16094                                  ;	  Potential filename replaces temp filename if:
 16095                                  ;	   it's a subdirectory file;
 16096                                  ;	   it doesn't start with a '.';
 16097                                  ;	   it's alphanumerically greater than last child's name;
 16098                                  ;	   and it's alphanumerically less than temp name.
 16099                                  
 16100                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16101                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16102                                  CheckChild:
 16103                                  	;test	DirBuf.find_buf_attr,ATTR_DIRECTORY
 16104 0000140B F606[AF9D]10            	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DIRECTORY ; 10h
 16105 00001410 741D                    	jz	short ccRet	; not a subdirectory file- return
 16106                                  
 16107                                  	; 16/02/2023
 16108 00001412 BE[B89D]                	mov	si,DIRBUF+FIND_BUF.PNAME
 16109 00001415 803C2E                  	cmp	byte [si],'.'
 16110                                  	;;cmp	DirBuf.find_buf_pname,'.'
 16111                                  	;cmp	byte [DIRBUF+FIND_BUF.PNAME],'.'
 16112 00001418 7415                    	je	short ccRet	; starts with a dot- return
 16113                                  
 16114                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16115                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16116 0000141A 89DF                    	mov	di,bx
 16117 0000141C E8B104                  	call	CmpAscz		; compare candidate to last child's name
 16118 0000141F 760E                    	jna	short ccRet	; it's not above it- return
 16119                                  
 16120                                  	; 07/06/2023
 16121                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16122                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16123                                  	; si = DIRBUF+FIND_BUF.PNAME
 16124 00001421 89EF                    	mov	di,bp
 16125 00001423 E8AA04                  	call	CmpAscz		; compare candidate to temp name
 16126 00001426 7307                    	jnb	short ccRet	; it's not below it- return
 16127                                  
 16128                                  ;	New kid is alright. Copy to temp.
 16129                                  
 16130                                  	; 07/06/2023
 16131                                  	;;mov	si,offset TRANGROUP:DirBuf+find_buf_pname
 16132                                  	;mov	si,DIRBUF+FIND_BUF.PNAME
 16133                                  	; si = DIRBUF+FIND_BUF.PNAME
 16134 00001428 89EF                    	mov	di,bp
 16135 0000142A B90D00                  	mov	cx,13
 16136 0000142D F3A4                    	rep	movsb
 16137                                  ccRet:
 16138 0000142F C3                      	retn
 16139                                  
 16140                                  ; ---------------------------------------------------------------------------
 16141                                  
 16142                                  ;***	CmpEntry - compare one directory entry to another in sort order
 16143                                  ;
 16144                                  ;	Compare one directory entry against another according to
 16145                                  ;	the sort codes in DestBuf. One or more comparisons
 16146                                  ;	may be made of file name, extension, time/date, and
 16147                                  ;	size.  Comparisons may be made for upward or downward
 16148                                  ;	sort order.
 16149                                  ;
 16150                                  ;	ENTRY	ES:BX = ptr to entry to compare
 16151                                  ;		ES:BP = ptr to entry to be compared against
 16152                                  ;		DestBuf contains sort codes (see DestBuf)
 16153                                  ;		DS = TRANGROUP seg addr
 16154                                  ;
 16155                                  ;	EXIT	BX = unchanged
 16156                                  ;		BP = unchanged
 16157                                  ;		Condition flags set for same, above, or below
 16158                                  ;		 comparing BX entry against BP entry.
 16159                                  ;		 'Same, above, below' translate to 'same, after, before'.
 16160                                  ;
 16161                                  ;	USED:	AX,CX,DX,SI,DI
 16162                                  
 16163                                  	; 16/02/2023
 16164                                  CmpEntry:
 16165 00001430 BE[1D9E]                	mov	si,DestBuf	; (DS:SI) = ptr to sort codes
 16166                                  ceLoop:
 16167 00001433 31C0                    	xor	ax,ax		; AX = 0
 16168 00001435 8A04                    	mov	al,[si]		; AL = sort code
 16169 00001437 08C0                    	or	al,al
 16170 00001439 741C                    	jz	short ceDone	; sort code is zero, we're done
 16171 0000143B 46                      	inc	si		; DS:SI = ptr to next sort code
 16172 0000143C 56                      	push	si		; save ptr to next sort code
 16173 0000143D FEC8                    	dec	al
 16174 0000143F D0E0                    	shl	al,1
 16175                                  	;sal	al,1		; AX = index into cmp call table
 16176                                  				; CY set for downward sort order
 16177 00001441 89C6                    	mov	si,ax		; SI = index into cmp call table
 16178 00001443 2E8B84[5814]            	mov	ax,[cs:si+FieldCmps]
 16179                                  				; AX = addr of compare routine
 16180 00001448 7204                    	jc	short ceDn	; downwards sort - go swap entries
 16181 0000144A FFD0                    	call	ax 		; do upwards sort
 16182 0000144C EB06                    	jmp	short ceNs
 16183                                  ceDn:
 16184 0000144E 87DD                    	xchg	bx,bp		; swap entry ptrs for downward sort order
 16185 00001450 FFD0                    	call	ax		; do sort
 16186 00001452 87DD                    	xchg	bx,bp		; swap ptrs back
 16187                                  ceNs:
 16188 00001454 5E                      	pop	si		; SI = ptr to next sort code
 16189 00001455 74DC                    	je	short ceLoop	; compare showed no difference, keep trying
 16190                                  ceDone:
 16191                                  
 16192                                  ;	Get here either from unequal compare or sort code = 0.
 16193                                  ;	In the latter case, condition codes indicate equality,
 16194                                  ;	which is correct.
 16195                                  
 16196 00001457 C3                      	retn
 16197                                  
 16198                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16199                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:1339h)
 16200                                  
 16201                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 16202                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:144Eh)
 16203                                  
 16204                                  FieldCmps:		; call table of entry comparisons
 16205 00001458 [6214]                  	dw	CmpName
 16206 0000145A [6D14]                  	dw	CmpExt
 16207 0000145C [BE14]                  	dw	CmpTime
 16208 0000145E [DA14]                  	dw	CmpSize
 16209 00001460 [DF14]                  	dw	CmpType
 16210                                  
 16211                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16212                                  %if 0
 16213                                  	; 05/06/2023 - Retro DOS 4.2 COMMAND.COM
 16214                                  	dw	CmpCratio
 16215                                  %endif
 16216                                  
 16217                                  ; ---------------------------------------------------------------------------
 16218                                  
 16219                                  ;***	CmpName - compare file name of two entries
 16220                                  ;***	CmpExt - compare extension of two entries
 16221                                  ;
 16222                                  ;	ENTRY	ES:BX = ptr to one entry
 16223                                  ;		ES:BP = ptr to another entry
 16224                                  ;
 16225                                  ;	EXIT	BX = unchanged
 16226                                  ;		BP = unchanged
 16227                                  ;		Condition flags set for same, above, or below
 16228                                  ;		comparing BX entry to BP entry.
 16229                                  ;
 16230                                  ;	USED:	AX,CX,DX,SI,DI
 16231                                  
 16232                                  	; 16/02/2023
 16233                                  CmpName:
 16234 00001462 89DE                    	mov	si,bx		; ES:SI = ptr to BX entry
 16235 00001464 89EF                    	mov	di,bp		; ES:DI = ptr to BP entry
 16236                                  	;;add	si,filename	; ES:SI = ptr to BX name
 16237                                  	;add	si,1
 16238                                  	; 25/04/2023
 16239 00001466 46                      	inc	si
 16240                                  	;;add	di,filename	; ES:DI = ptr to BP name
 16241                                  	;add	di,1
 16242                                  	; 25/04/2023
 16243 00001467 47                      	inc	di
 16244                                  	;mov	cx,size filename
 16245                                  				; CX = length of name
 16246 00001468 B90800                  	mov	cx,8
 16247 0000146B EB0C                    	jmp	short CmpStr
 16248                                  
 16249                                  CmpExt:
 16250                                  	; 07/06/2023
 16251                                  	;mov	si,bx		; ES:SI = ptr to BX entry
 16252                                  	;mov	di,bp		; ES:DI = ptr to BP entry
 16253                                  	;;add	si,fileext	; ES:SI = ptr to BX extension
 16254                                  	;add	si,9
 16255                                  	;;add	di,fileext	; ES:DI = ptr to BP extension
 16256                                  	;add	di,9
 16257                                  	;
 16258 0000146D BE0900                  	mov	si,9
 16259 00001470 89F7                    	mov	di,si ; mov di,9
 16260 00001472 01DE                    	add	si,bx
 16261 00001474 01EF                    	add	di,bp
 16262                                  	;
 16263                                  	;mov	cx,size fileext	; CX = length of extension field
 16264 00001476 B90300                  	mov	cx,3
 16265                                  
 16266                                  ;	Bugbug:	use symbol for subfunction code.
 16267                                  
 16268                                  CmpStr:	
 16269 00001479 803E[1EA6]06            	cmp	byte [CountryPtrId],6
 16270 0000147E 753A                    	jne	short cnNoCollTable
 16271                                  				; no collating table available
 16272                                  
 16273                                  ;*	Compare strings using collating table.
 16274                                  ;
 16275                                  ;	ES:SI = ptr to 1st string
 16276                                  ;	ES:DI = ptr to 2nd string
 16277                                  ;	CX = length
 16278                                  
 16279 00001480 55                      	push	bp		; preserve BP
 16280 00001481 53                      	push	bx		; preserve BX
 16281 00001482 1E                      	push	ds		; preserve DS
 16282 00001483 C51E[1FA6]              	lds	bx,[CountryPtr]	; DS:BX = ptr to collating table
 16283                                  	;assume	ds:NOTHING
 16284 00001487 8B2F                    	mov	bp,[bx]		; BP = size of collating table
 16285 00001489 43                      	inc	bx
 16286 0000148A 43                      	inc	bx		; DS:BX = ptr to collating values
 16287                                  				; DS:[BX]-2 = size of table
 16288 0000148B 31C0                    	xor	ax,ax		; AX = 0 for starters
 16289                                  
 16290                                  ;	Bugbug:	Investigate removing collating table length checks.
 16291                                  
 16292                                  cnNextChar:
 16293 0000148D 268A05                  	mov	al,[es:di]	; AL = AX = char from 2nd string
 16294 00001490 47                      	inc	di		; ES:DI = ptr to next char 2nd string
 16295                                  
 16296                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16297                                  %if 0
 16298                                  	cmp	ax,bp		; compare to collating table length
 16299                                  	jae	short cn1 	; char not in table
 16300                                  	xlat				
 16301                                  cn1:				; AL = AX = collating value
 16302                                  	mov	dx,ax		; DX = collating value from 2nd string
 16303                                  	;lods	byte ptr es:[si]
 16304                                  	es	lodsb		; AL = AX = char from 1st string
 16305                                  				; ES:SI = ptr to next char 1st string
 16306                                  	cmp	ax,bp		; compare to collating table length
 16307                                  	jae	short cn2	; char not in table
 16308                                  	xlat				
 16309                                  cn2:				; AL = AX = collating value
 16310                                  	cmp	ax,dx		; compare collating values
 16311                                  	loope	cnNextChar	; until unequal or no more left
 16312                                  
 16313                                  	pop	ds		; restore DS
 16314                                  	;assume	ds:TRANGROUP
 16315                                  	pop	bx		; restore BX
 16316                                  	pop	bp		; restore BP
 16317                                  	retn
 16318                                  
 16319                                  ;*	If no collating table is available, simply compare raw ASCII values.
 16320                                  ;	Don't we wish we could just do this all the time? Sigh.
 16321                                  
 16322                                  %else
 16323                                  	; 31/07/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 16324 00001491 84F6                    	test	dh,dh
 16325 00001493 7408                    	jz	short cn1
 16326 00001495 30F6                    	xor	dh,dh
 16327 00001497 88C2                    	mov	dl,al
 16328                                  	;lods	byte ptr es:[si]
 16329 00001499 26AC                    	es	lodsb
 16330 0000149B EB15                    	jmp	short cn4
 16331                                  cn1:
 16332 0000149D E8BF12                  	call	testkanj
 16333 000014A0 7402                    	jz	short cn2
 16334 000014A2 B601                    	mov	dh,1
 16335                                  cn2:
 16336 000014A4 39E8                    	cmp	ax,bp
 16337 000014A6 7301                    	jnb	short cn3
 16338 000014A8 D7                      	xlat
 16339                                  cn3:
 16340 000014A9 88C2                    	mov	dl,al
 16341                                  	;lods	byte ptr es:[si]
 16342 000014AB 26AC                    	es	lodsb
 16343 000014AD 39E8                    	cmp	ax,bp
 16344 000014AF 7301                    	jnb	short cn4
 16345 000014B1 D7                      	xlat
 16346                                  cn4:
 16347 000014B2 38D0                    	cmp	al,dl
 16348 000014B4 E1D7                    	loope	cnNextChar
 16349 000014B6 1F                      	pop	ds
 16350 000014B7 5B                      	pop	bx
 16351 000014B8 5D                      	pop	bp
 16352 000014B9 C3                      	retn	
 16353                                  %endif
 16354                                  
 16355                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16356                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:138Dh)
 16357                                  cnNoCollTable:
 16358                                  	;repe	cmps byte ptr es:[si], byte ptr es:[di] ; 31/07/2024
 16359                                  				;db 0F3h,26h,0A6h,0C3h
 16360 000014BA F3                      	repe	; 0F3h
 16361 000014BB 26                      	es	; 26h
 16362 000014BC A6                      	cmpsb	; 0A6h
 16363 000014BD C3                      	retn	; 0C3h
 16364                                  
 16365                                  ; ---------------------------------------------------------------------------
 16366                                  
 16367                                  ;***	CmpTime - compare entries by date/time
 16368                                  ;
 16369                                  ;	ENTRY	ES:BX = ptr to one entry
 16370                                  ;		ES:BP = ptr to another entry
 16371                                  ;
 16372                                  ;	EXIT	BX = unchanged
 16373                                  ;		BP = unchanged
 16374                                  ;		Condition flags set for same, above, or below
 16375                                  ;		 comparing BX entry to BP entry.
 16376                                  ;
 16377                                  ;	USED:	CX,SI,DI
 16378                                  ;
 16379                                  ;	NOTE	Filetime and filedate fields in our private entry
 16380                                  ;		structure must be adjacent and in that order.
 16381                                  
 16382                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16383                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16384                                  CmpTime:
 16385 000014BE 89DE                    	mov	si,bx
 16386 000014C0 89EF                    	mov	di,bp
 16387                                  	;add	si,filedate + size filedate - 1
 16388 000014C2 83C610                  	add	si,16 ; 15+2-1
 16389                                  	;add	di,filedate + size filedate - 1
 16390 000014C5 83C710                  	add	di,16 ; 15+2-1
 16391                                  	; 07/06/2023
 16392 000014C8 BE1000                  	mov	si,16
 16393                                  CmpST2:		; 07/06/2023
 16394 000014CB 89F7                    	mov	di,si	; mov di,16
 16395 000014CD 01DE                    	add	si,bx
 16396 000014CF 01EF                    	add	di,bp
 16397                                  
 16398                                  	;mov	cx,size filetime + size filedate
 16399 000014D1 B90400                  	mov	cx,4 ; 2+2
 16400 000014D4 FD                      	std
 16401                                  	;repe	cmps byte ptr es:[si],[di]
 16402                                  				;db 0F3h,26h,0A6h, 0FCh,0C3h
 16403 000014D5 F3                      	repe	; 0F3h
 16404 000014D6 26                      	es	; 26h
 16405 000014D7 A6                      	cmpsb	; 0A6h
 16406                                  	
 16407 000014D8 FC                      	cld	; 0FCh
 16408 000014D9 C3                      	retn	; 0C3h
 16409                                  
 16410                                  ; ---------------------------------------------------------------------------
 16411                                  
 16412                                  ;***	CmpSize - compare entries by size
 16413                                  ;
 16414                                  ;	ENTRY	ES:BX = ptr to one entry
 16415                                  ;		ES:BP = ptr to another entry
 16416                                  ;
 16417                                  ;	EXIT	BX = unchanged
 16418                                  ;		BP = unchanged
 16419                                  ;		Condition flags set for same, above, or below
 16420                                  ;		 comparing BX entry to BP entry.
 16421                                  ;
 16422                                  ;	USED:	CX,SI,DI
 16423                                  
 16424                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16425                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16426                                  CmpSize:
 16427                                  	;mov	si,bx
 16428                                  	;mov	di,bp
 16429                                  	;;add	si,filesize + size filesize - 1
 16430                                  	;add	si,20  ; 17+4-1
 16431                                  	;;add	di,filesize + size filesize - 1
 16432                                  	;add	di,20  ; 17+4-1
 16433                                  	; 07/06/2023
 16434 000014DA BE1400                  	mov	si,20
 16435                                  	;;;
 16436 000014DD EBEC                    	jmp	short CmpST2 ; 07/06/2023
 16437                                  	;;;
 16438                                  ;CmpST2:
 16439                                  ;	mov	di,si	; mov di,20
 16440                                  ;	add	si,bx
 16441                                  ;	add	di,bp
 16442                                  ;
 16443                                  ;	;mov	cx,size filesize
 16444                                  ;	mov	cx,4
 16445                                  ;	std
 16446                                  ;	;repe	cmps byte ptr es:[si],[di]
 16447                                  ;				;db 0F3h,26h,0A6h
 16448                                  ;	repe	; 0F3h
 16449                                  ;	es	; 26h
 16450                                  ;	cmpsb	; 0A6h
 16451                                  ;
 16452                                  ;	cld
 16453                                  ;	retn
 16454                                  
 16455                                  ; ---------------------------------------------------------------------------
 16456                                  
 16457                                  ;***	CmpType - compare entries by file type (subdirectory or not)
 16458                                  ;
 16459                                  ;	ENTRY	ES:BX = ptr to one entry
 16460                                  ;		ES:BP = ptr to another entry
 16461                                  ;
 16462                                  ;	EXIT	BX = unchanged
 16463                                  ;		BP = unchanged
 16464                                  ;		Condition flags set for same, above, or below
 16465                                  ;		 comparing BX entry to BP entry.
 16466                                  ;
 16467                                  ;	USED:	AX
 16468                                  
 16469                                  	; 16/02/2023 - Retro DOS v4.0 COMMAND.COM
 16470                                  CmpType:
 16471                                  	;mov	al,es:[bx].fileattr
 16472 000014DF 268A470C                	mov	al,[es:bx+12]
 16473                                  	;mov	ah,es:[bp].fileattr
 16474 000014E3 268A660C                	mov	ah,[es:bp+12]
 16475                                  	;and	ax,(ATTR_DIRECTORY shl 8) + ATTR_DIRECTORY
 16476                                  	;and	ax,1010h
 16477 000014E7 251010                  	and	ax,(ATTR_DIRECTORY<<8)+ATTR_DIRECTORY
 16478 000014EA 38C4                    	cmp	ah,al
 16479 000014EC C3                      	retn
 16480                                  
 16481                                  ; ---------------------------------------------------------------------------
 16482                                  
 16483                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 16484                                  %if 0
 16485                                  
 16486                                  ;***	CmpCratio - compare entries by compression ratio
 16487                                  ;
 16488                                  ;	ENTRY	ES:BX = ptr to one entry
 16489                                  ;		ES:BP = ptr to another entry
 16490                                  ;
 16491                                  ;	EXIT	BX = unchanged
 16492                                  ;		BP = unchanged
 16493                                  ;		Condition flags set for same, above, or below
 16494                                  ;		 comparing BX entry to BP entry.
 16495                                  ;
 16496                                  ;	USED:	AX
 16497                                  
 16498                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 16499                                  CmpCratio:
 16500                                  	;mov	al,es:[bx].compratio
 16501                                  	mov	al,[es:bx+21]	
 16502                                  	;cmp	al,es:[bp].compratio
 16503                                  	cmp     al,[es:bp+21]
 16504                                  	retn
 16505                                  
 16506                                  %endif
 16507                                  
 16508                                  ; ---------------------------------------------------------------------------
 16509                                  
 16510                                  ;***	DefaultAttr - set default attribute conditions
 16511                                  ;
 16512                                  ;	ENTRY	nothing
 16513                                  ;
 16514                                  ;	EXIT	CY clear
 16515                                  ;
 16516                                  ;	USED
 16517                                  ;
 16518                                  ;	EFFECTS
 16519                                  ;
 16520                                  ;	  AttrSpecified, AttrSelect are updated with new attribute conditions.
 16521                                  
 16522                                  	; 16/02/2023
 16523                                  DefaultAttr:
 16524                                  	;mov	byte [AttrSpecified],6
 16525 000014ED C606[F49D]06            	mov	byte [AttrSpecified],ATTR_HIDDEN+ATTR_SYSTEM
 16526                                  					; specify H and S
 16527 000014F2 C606[F59D]00            	mov	byte [AttrSelect],0	; H and S must be off
 16528 000014F7 F8                      	clc				; return success
 16529                                  dtRet:	; 18/02/2023
 16530 000014F8 C3                      	retn
 16531                                  
 16532                                  ; ---------------------------------------------------------------------------
 16533                                  
 16534                                  ;***	DisplayTotals - display grand total stats
 16535                                  ;
 16536                                  ;	If we searched subdirectories, display the total # files found
 16537                                  ;	 and total size of files found.
 16538                                  ;	Display disk space remaining.
 16539                                  ;
 16540                                  ;	ENTRY	FileCntTotal, FileSizTotal contain correct values
 16541                                  ;		Bits contains setting of /s
 16542                                  ;		FCB contains drive #
 16543                                  ;
 16544                                  ;	EXIT	nothing
 16545                                  ;
 16546                                  ;	USES	AX,DX
 16547                                  ;		FileSiz
 16548                                  
 16549                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16550                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:13D1h
 16551                                  
 16552                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16553                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:14F1h
 16554                                  
 16555                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 16556                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1565h
 16557                                  
 16558                                  DisplayTotals:
 16559                                  	;;;test	Bits,mask subd
 16560                                  	;;test	word [_Bits],4
 16561                                  	;test	byte [_Bits],4
 16562                                  	; 07/06/2023
 16563 000014F9 F606[EC9D]04            	test	byte [_Bits],mask.subd	; 8 ; MSDOS 6.0
 16564                                  			; 31/07/2024	; 4 ; PCDOS 7.1
 16565 000014FE 7423                    	jz	short dtFree		; no subdirectories- do bytes free
 16566                                  
 16567 00001500 E87414                  	call	CRLF2			; start on new line
 16568 00001503 E87304                  	call	UseLine
 16569                                  
 16570 00001506 BA[8392]                	mov	dx,total_ptr
 16571 00001509 E8113F                  	call	std_printf		; "Total:",cr,lf
 16572 0000150C E86A04                  	call	UseLine
 16573                                  
 16574                                  ; 31/07/2024
 16575                                  ; PCDOS 7.1 COMMAND.COM
 16576                                  	;;;
 16577                                  %if 0
 16578                                  	; 07/06/2023
 16579                                  	; MSDOS 6.22 COMMAND.COM
 16580                                  	;test	word [_Bits],1		; mask.cratio
 16581                                  	test	byte [_Bits],mask.cratio
 16582                                  	jz      short dtCntSize
 16583                                  	mov     ax,[ccluUsedTotal]
 16584                                  	mov     [ccluUsedDir],ax
 16585                                  	mov     si,csecUsedTotal
 16586                                  	mov     di,csecUsedDir
 16587                                  	movsw
 16588                                  	movsw
 16589                                  dtCntSize:    
 16590                                  %endif
 16591                                  	;;;
 16592 0000150F A1[BF9C]                	mov	ax,[FileCntTotal]	; AX = # files found mod 64K
 16593 00001512 BE[C39C]                	mov	si,FileSizTotal
 16594 00001515 BF[839C]                	mov	di,FileSiz
 16595 00001518 A5                      	movsw				; move total size to size variable
 16596 00001519 A5                      	movsw
 16597                                  
 16598                                  ; 31/07/2024
 16599                                  ; PCDOS 7.1 COMMAND.COM
 16600                                  %if 1
 16601 0000151A A5                      	movsw
 16602 0000151B A5                      	movsw
 16603 0000151C 8B16[C19C]              	mov	dx,[FileCntTotal+2]
 16604                                  %endif
 16605 00001520 E8D106                  	call	DisplayCntSiz		; display file count & size
 16606                                  dtFree:
 16607                                  
 16608                                  ; 31/07/2024
 16609                                  ; PCDOS 7.1 COMMAND.COM
 16610                                  %if 0
 16611                                  	mov	ah,36h
 16612                                  	;mov	ah,GET_DRIVE_FREESPACE	; AH = DOS Get Free Space function
 16613                                  	mov	dl,[FCB] ; [5Ch]	; DL = drive#
 16614                                  	int	21h			; call DOS
 16615                                  	cmp	ax,-1			; check 'invalid drive' return code
 16616                                  	jz	short dtRet		; can't get drive space - return
 16617                                  	mul	cx
 16618                                  	mul	bx
 16619                                  	mov	[Bytes_Free],ax
 16620                                  	mov	[Bytes_Free+2],dx
 16621                                  	mov	dx,bytmes_ptr
 16622                                  %else
 16623                                  	; 31/07/2024 - Retro DOS v5.0
 16624                                  	; PCDOS 7.1 COMMAND.COM
 16625 00001523 E86707                  	call	GetDriveLtr
 16626 00001526 A2[BB9C]                	mov	byte [efs_drive],al ; "C:\"
 16627 00001529 BA[BB9C]                	mov	dx,efs_drive ; "C:\"
 16628 0000152C BF[8F9C]                	mov	di,efs_buffer
 16629 0000152F B92C00                  	mov	cx,44
 16630 00001532 26890D                  	mov	[es:di],cx
 16631 00001535 26C745020000            	mov	word [es:di+2],0
 16632 0000153B B80373                  	mov	ax,7303h	; GET EXTENDED FREE SPACE ON DRIVE (Windows95, FAT32)
 16633                                  				; DS:DX	-> ASCIZ string	for drive ("C:\" or "\\SERVER\Share")
 16634                                  				; ES:DI	-> buffer for extended free space structure
 16635                                  				; CX = length of buffer	for extended free space
 16636 0000153E CD21                    	int	21h		; DOS -
 16637                                  				;
 16638                                  				; Return:
 16639                                  				; CF clear if successful
 16640                                  				; ES:DI	buffer filled
 16641                                  				; CF set on error
 16642                                  				; AX = error code
 16643                                  				;
 16644                                  				; Format of extended free space	structure:
 16645                                  				;
 16646                                  				; Offset  Size	  Description
 16647                                  				; 00h	 WORD	 (ret) size of returned	structure
 16648                                  				; 02h	 WORD	 (call)	structure version (0000h)
 16649                                  				;		 (ret) actual structure	version	(0000h)
 16650                                  				; 04h	 DWORD	 number	of sectors per cluster
 16651                                  				;		 (with adjustment for compression)
 16652                                  				; 08h	 DWORD	 number	of bytes per sector
 16653                                  				; 0Ch	 DWORD	 number	of available clusters
 16654                                  				; 10h	 DWORD	 total number of clusters on the drive
 16655                                  				; 14h	 DWORD	 number	of physical sectors available on the drive,
 16656                                  				;		 without adjustment for	compression
 16657                                  				; 18h	 DWORD	 total number of physical sectors on the drive,
 16658                                  				;		 without adjustment for	compression
 16659                                  				; 1Ch	 DWORD	 number	of available allocation	units,
 16660                                  				;		 without adjustment for	compression
 16661                                  				; 20h	 DWORD	 total allocation units,
 16662                                  				;		 without adjustment for	compression
 16663                                  				; 24h  8 BYTEs	 reserved
 16664 00001540 89C1                    	mov	cx,ax		; error	code (cf=1) or (cf=0) efs structure size (44)
 16665 00001542 268B5D08                	mov	bx,[es:di+8]	; bytes	per sector
 16666 00001546 268B4514                	mov	ax,[es:di+14h]	; number of sectors available
 16667 0000154A 268B5516                	mov	dx,[es:di+16h]
 16668 0000154E 7204                    	jc	short get_efs_err
 16669 00001550 08C9                    	or	cl,cl
 16670 00001552 750F                    	jnz	short dtFree_1	; cl = 44 (IBMDOS 7.1 Kernel, INT 21h, AX=7303h	return value)
 16671                                  get_efs_err:
 16672 00001554 B436                    	mov	ah,36h
 16673                                  	;mov	ah,GET_DRIVE_FREESPACE	; AH = DOS Get Free Space function
 16674 00001556 8A165C00                	mov	dl,[FCB] 		; DL = drive#
 16675                                  	;mov	dl,[5Ch]
 16676 0000155A CD21                    	int	21h		; DOS -	2+ - GET DISK SPACE
 16677                                  				; DL = drive code (0 = default,	1 = A, 2 = B, etc.)
 16678 0000155C 83F8FF                  	cmp	ax,0FFFFh	; ax = sectors per cluster
 16679 0000155F 7497                    	je	short dtRet	; ! invalid drive ! return
 16680 00001561 F7E1                    	mul	cx		; * bytes per sectors
 16681                                  				; dx:ax	= bytes	per cluster
 16682                                  				; bx = free clusters
 16683                                  dtFree_1:
 16684 00001563 89D1                    	mov	cx,dx		; hw of	free sectors
 16685 00001565 F7E3                    	mul	bx		; lw of	free sectors * bytes per sector
 16686 00001567 91                      	xchg	ax,cx
 16687 00001568 87D3                    	xchg	dx,bx
 16688 0000156A F7E2                    	mul	dx
 16689 0000156C 01D8                    	add	ax,bx
 16690 0000156E 83D200                  	adc	dx,0		; dx:ax:cx = free bytes
 16691 00001571 09D2                    	or	dx,dx
 16692 00001573 7416                    	jz	short dtFree_2
 16693 00001575 88E9                    	mov	cl,ch		; prints free space as kilobytes
 16694 00001577 88C5                    	mov	ch,al		; save al
 16695 00001579 88E0                    	mov	al,ah		; / 256
 16696 0000157B 88D4                    	mov	ah,dl
 16697 0000157D D0CE                    	ror	dh,1		; / 2 (= free bytes / 512)
 16698 0000157F D1D8                    	rcr	ax,1
 16699 00001581 D1D9                    	rcr	cx,1
 16700 00001583 D0CE                    	ror	dh,1		; / 2 (= free bytes / 1024)
 16701 00001585 D1D8                    	rcr	ax,1
 16702 00001587 D1D9                    	rcr	cx,1
 16703 00001589 B2FF                    	mov	dl,0FFh	; dx > 0
 16704                                  dtFree_2:
 16705 0000158B 890E[089E]              	mov	[Bytes_Free],cx
 16706 0000158F A3[0A9E]                	mov	[Bytes_Free+2],ax
 16707 00001592 09D2                    	or	dx,dx		; is dx	> 0 ?
 16708 00001594 740F                    	jz	short dtFree_3	; no
 16709 00001596 BA[C992]                	mov	dx,kbytesf_ptr	; MSG_1106 (".. K bytes free" msg)
 16710                                  				; 30 digits, long binary do decimal
 16711 00001599 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0
 16712 0000159E 741C                    	jz	short dtFree_5
 16713 000015A0 BA[C992]                	mov	dx,kbytesf_ptr	; MSG_1106
 16714                                  				; ".. K	bytes free" msg, 28 digits
 16715 000015A3 EB17                    	jmp	short dtFree_5
 16716                                  dtFree_3:
 16717 000015A5 BA[3890]                	mov	dx,bytmes1_ptr	; MSG_1020 (".. bytes free" msg)
 16718                                  				; 30 digits, long binary do decimal
 16719 000015A8 803E[8B9C]00            	cmp	byte [narrow],0	; narrow display area ?
 16720 000015AD 7503                    	jnz	short dtFree_4	; yes
 16721 000015AF BA[4690]                	mov	dx,bytmes2_ptr	; MSG_1020, 33 digits
 16722                                  dtFree_4:
 16723 000015B2 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0 ; not kilobyte option
 16724 000015B7 7403                    	jz	short dtFree_5	; use kilo bytes (if number of free bytes is big)
 16725 000015B9 BA[5490]                	mov	dx,bytmes_n_ptr	; narrow (28 digits), MSG_1020
 16726                                  dtFree_5:
 16727                                  %endif
 16728 000015BC E85E3E                  	call	std_printf	; "nnn bytes free",cr,lf
 16729                                  	;call	UseLine
 16730                                  ;dtRet:
 16731                                  	;retn
 16732                                  	; 18/02/2023
 16733 000015BF E9B703                  	jmp	UseLine
 16734                                  
 16735                                  ; ---------------------------------------------------------------------------
 16736                                  
 16737                                  ;***	FileIsDevice - see if file looks like a device
 16738                                  ;
 16739                                  ;	ENTRY	PathPos = ptr to pathname
 16740                                  ;		PathCnt = length of pathname w/o terminating char
 16741                                  ;		DirBuf is DOS DTA
 16742                                  ;
 16743                                  ;	EXIT	ZR = set if file looks like a device
 16744                                  ;
 16745                                  ;	USED	AX,BX,CX,DX,DI
 16746                                  ;
 16747                                  ;	EFFECTS
 16748                                  ;
 16749                                  ;	  DTA buffer holds results of Find First function
 16750                                  ;
 16751                                  ;	NOTES
 16752                                  ;
 16753                                  ;	  We try to flag devices in two ways. First, we try
 16754                                  ;	  the DOS Find First function. It returns attribute bit 6
 16755                                  ;	  set on a successful find if it identifies a device name.
 16756                                  ;	  Unfortunately, it returns 'path not found' for a device
 16757                                  ;	  name terminated with colon, such as "CON:". So, we look
 16758                                  ;	  for any colon in the pathname after the 2nd character,
 16759                                  ;	  and flag the pathname as a device if we find one.
 16760                                  
 16761                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16762                                  FileIsDevice:
 16763 000015C2 8B16[F09D]              	mov	dx,[PathPos]	 ; DX = ptr to pathname
 16764                                  
 16765 000015C6 89D7                    	mov	di,dx
 16766 000015C8 033E[EE9D]              	add	di,[PathCnt]	 ; DI = ptr to byte after pathname
 16767 000015CC 30DB                    	xor	bl,bl		 ; BL = NUL to terminate pathname with
 16768 000015CE 861D                    	xchg	bl,[di] 	 ; BL = saved pathname terminating char
 16769                                  
 16770 000015D0 31C9                    	xor	cx,cx		 ; CX = attribute mask (normal search)
 16771 000015D2 B44E                    	mov	ah,4Eh
 16772                                  	;mov	ah,Find_First	 ; AH = DOS Find First function code
 16773 000015D4 CD21                    	int	21h	 	 ; call DOS
 16774 000015D6 861D                    	xchg	bl,[di]		 ; restore pathname terminating char
 16775 000015D8 720A                    	jc	short piCol	 ; didn't find a dir entry, check for colon
 16776                                  
 16777                                  ;	Found a dir entry, see if Find First thinks it's a device.
 16778                                  
 16779                                  	;test	byte [DIRBUF+21],40h
 16780 000015DA F606[AF9D]40            	test	byte [DIRBUF+FIND_BUF.ATTR],ATTR_DEVICE
 16781 000015DF 7403                    	jz	short piCol	 ; device attribute not set, look for colon
 16782 000015E1 31C9                    	xor	cx,cx		 ; it's a device, return ZR flag
 16783                                  	;jmp	short piRet
 16784                                  	; 25/04/2023
 16785                                  piRet:
 16786 000015E3 C3                      	retn
 16787                                  
 16788                                  ;	Device attribute not returned by Find First function. But
 16789                                  ;	let's check for a colon anywhere in the pathname after the
 16790                                  ;	second byte.
 16791                                  ;
 16792                                  ;	DI = ptr to byte after pathname
 16793                                  
 16794                                  piCol:
 16795 000015E4 4F                      	dec	di		 ; DI = ptr to last char in pathname
 16796 000015E5 B03A                    	mov	al,':'
 16797                                  	;mov	al,COLON_CHAR	 ; AL = colon char to search for
 16798 000015E7 8B0E[EE9D]              	mov	cx,[PathCnt]	 ; CX = # chars to scan
 16799 000015EB 49                      	dec	cx
 16800 000015EC 49                      	dec	cx		 ; ignore 1st two chars of pathname
 16801 000015ED 09C9                    	or	cx,cx
 16802 000015EF 78F2                    	js	short piRet	 ; if < 2 chars in pathname, just return
 16803 000015F1 09FF                    	or	di,di		 ; clear ZR in case CX = 0
 16804 000015F3 FD                      	std			 ; scan downward
 16805 000015F4 F2AE                    	repne	scasb
 16806 000015F6 FC                      	cld			 ; restore default upward direction
 16807                                  
 16808                                  ;	After scanning, the ZR flag is set to indicate presence of a colon.
 16809                                  ;piRet:
 16810 000015F7 C3                      	retn
 16811                                  
 16812                                  ;FileIsDevice endp
 16813                                  
 16814                                  ; ---------------------------------------------------------------------------
 16815                                  
 16816                                  ;***	FindFirst - find first directory entry to display
 16817                                  ;***	FindNext - find next directory entry to display
 16818                                  ;
 16819                                  ;	ENTRY	Bits<inmem> = set if entries are loaded in TPA
 16820                                  ;		AttrSpecified, AttrSelect are set
 16821                                  ;
 16822                                  ;	EXIT	CY = clear if successful
 16823                                  ;		BX = offset in TPA buffer of directory entry found
 16824                                  ;
 16825                                  ;		If unsuccessful,
 16826                                  ;		CY = set
 16827                                  ;		AX = DOS error code
 16828                                  ;		DOS Get Extended Error call will get error code
 16829                                  ;
 16830                                  ;		NOTE: if entries were loaded into TPA, AX contains
 16831                                  ;		ERROR_NO_MORE_FILES when no more entries are available,
 16832                                  ;		but DOS Get Extended Error call WON'T return the correct
 16833                                  ;		error. That's ok, because we'll see the value in AX
 16834                                  ;		and recognize it as a non-error condition.
 16835                                  ;
 16836                                  ;	USED	AX,CX,DX,SI,DI
 16837                                  ;
 16838                                  ;	EFFECTS
 16839                                  ;
 16840                                  ;	  Entries in memory may be marked as output.
 16841                                  ;	  If not sorted, entry is loaded at TPA.
 16842                                  ;
 16843                                  ;	NOTES
 16844                                  ;
 16845                                  ;	  If we don't find a qualifying file, we return after the final
 16846                                  ;	   DOS Find File call. A DOS Get Extended Error call will then
 16847                                  ;	   indicate an appropriate condition.
 16848                                  
 16849                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16850                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:144Fh
 16851                                  
 16852                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 16853                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1585h
 16854                                  
 16855                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 16856                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1667h
 16857                                  	
 16858                                  FindFirst:
 16859                                  	;mov	ax,offset TRANGROUP:GetFirst
 16860 000015F8 B8[CF16]                	mov	ax,GetFirst
 16861 000015FB EB03                    	jmp	short ffFindEntry
 16862                                  
 16863                                  	; 18/02/2023
 16864                                  FindNext:
 16865                                  	;mov	ax,offset TRANGROUP:GetNext
 16866 000015FD B8[DD16]                	mov	ax,GetNext
 16867                                  
 16868                                  ;	AX = address of correct disk get routine to use.
 16869                                  
 16870                                  ffFindEntry:
 16871 00001600 06                      	push	es			; save TRANGROUP seg addr
 16872                                  	;;;test	Bits,mask inmem
 16873                                  	;;test	word [_Bits],20h
 16874                                  	;test	byte [_Bits],20h
 16875                                  	; 07/06/2023
 16876 00001601 F606[EC9D]80            	test	byte [_Bits],mask.inmem ; 40h ; MSDOS 6.0
 16877                                  			; 31/07/2024	; 80h ; PCDOS 7.1	
 16878 00001606 7405                    	jz	short ffDisk		; entries not in memory, search disk
 16879                                  
 16880                                  ;	Entries are loaded in memory to sort out. Find the first one.
 16881                                  ;	There will always be one, or LoadEntries would've failed.
 16882                                  
 16883 00001608 E81A00                  	call	FindInMem		; find first entry in TPA
 16884 0000160B EB16                    	jmp	short ffRet		; return what TPA search returns
 16885                                  
 16886                                  ;	Get entry from disk.
 16887                                  
 16888                                  ffDisk:
 16889 0000160D FFD0                    	call	ax			; get entry from disk
 16890 0000160F 720E                    	jc	short ffGetErr		; get & return error
 16891 00001611 8E06[559C]              	mov	es,[TPA]		; ES = seg addr of TPA
 16892 00001615 31FF                    	xor	di,di			; ES:DI = ptr to TPA
 16893 00001617 89FB                    	mov	bx,di			; BX = offset of entry in TPA
 16894 00001619 E85C01                  	call	LoadEntry		; load entry to TPA
 16895 0000161C F8                      	clc				; return success
 16896 0000161D EB04                    	jmp	short ffRet
 16897                                  
 16898                                  ffGetErr:
 16899 0000161F E8270A                  	call	 get_ext_error_number	; AX = DOS error code
 16900 00001622 F9                      	stc
 16901                                  ffRet:
 16902 00001623 07                      	pop	es			; ES = TRANGROUP seg addr again
 16903 00001624 C3                      	retn
 16904                                  
 16905                                  ; ---------------------------------------------------------------------------
 16906                                  
 16907                                  ;***	FindInMem - find next directory entry in TPA buffer
 16908                                  ;
 16909                                  ;	ENTRY	TPA is loaded (see LoadEntries)
 16910                                  ;
 16911                                  ;	EXIT	BX = offset in TPA of entry found
 16912                                  ;
 16913                                  ;		If no more files,
 16914                                  ;		CY = set
 16915                                  ;		AX = DOS 'no more files' error code
 16916                                  ;
 16917                                  ;	USED	AX,BX,CX,DX,SI,DI,BP,ES
 16918                                  ;
 16919                                  ;	EFFECTS
 16920                                  ;
 16921                                  ;	  Entry found is flagged as 'used' (see EntryStruc).
 16922                                  
 16923                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16924                                  FindInMem:
 16925 00001625 8E06[559C]              	mov	es,[TPA]		; ES = TPA seg addr
 16926 00001629 31DB                    	xor	bx,bx			; ES:BX = ptr to 1st entry in TPA
 16927 0000162B FC                      	cld				; make sure default string direction is up
 16928                                  	
 16929 0000162C E86D00                  	call	FindOneInMem		; locate an entry
 16930 0000162F 720E                    	jc	short fiNoMore		; none left, set up 'no more files' error
 16931                                  
 16932                                  ;	BX = ptr to entry in TPA
 16933                                  
 16934                                  fiBest:
 16935 00001631 89DD                    	mov	bp,bx			; BP = ptr to best entry so far
 16936                                  fiNext:
 16937 00001633 E87300                  	call	FindNextInMem		; locate next entry
 16938 00001636 720C                    	jc	short fiFound		; no more, best entry so far wins
 16939                                  
 16940                                  ;	BX = ptr to next entry
 16941                                  
 16942 00001638 E8F5FD                  	call	CmpEntry		; compare it to best found so far (BP)
 16943 0000163B 73F6                    	jnb	short fiNext		; it's not better, go look at next one
 16944 0000163D EBF2                    	jmp	short fiBest		; it's better, go mark it as best so far
 16945                                  
 16946                                  fiNoMore:
 16947                                  
 16948                                  ;	No more entries available in TPA. Set up 'no more files' error.
 16949                                  
 16950                                  	;mov	ax,18
 16951 0000163F B81200                  	mov	ax,ERROR_NO_MORE_FILES	; AX = 'no more files' error code
 16952 00001642 F9                      	stc				; return error
 16953                                  	;jmp	short fiRet
 16954                                  	; 18/02/2023
 16955 00001643 C3                      	retn
 16956                                  
 16957                                  fiFound:
 16958 00001644 89EB                    	mov	bx,bp			; BX = ptr to best entry found
 16959 00001646 26C60701                	mov	byte [es:bx],1		; mark entry 'used'
 16960 0000164A F8                      	clc				; return success
 16961                                  fiRet:
 16962 0000164B C3                      	retn
 16963                                  
 16964                                  ; ---------------------------------------------------------------------------
 16965                                  
 16966                                  ;***	FindNextChild - find next subdirectory in current directory
 16967                                  ;
 16968                                  ;	ENTRY	BX = ptr to last child found, ASCIIZ filename
 16969                                  ;		DirBuf is established DTA
 16970                                  ;
 16971                                  ;	EXIT	BX = ptr (same addr) to next child found, ASCIIZ filename
 16972                                  ;
 16973                                  ;		If failure,
 16974                                  ;		CY = set
 16975                                  ;		DOS Get Extended Error call will get error
 16976                                  ;
 16977                                  ;	USED	AX,CX,DX,SI,DI,BP
 16978                                  ;
 16979                                  ;	EFFECTS
 16980                                  ;
 16981                                  ;	  DirBuf is used for find first/next calls.
 16982                                  ;
 16983                                  ;	NOTES
 16984                                  ;
 16985                                  ;	  We keep on checking files until DOS returns an error. If
 16986                                  ;	  the error is 'no more files' and the temp filename is not
 16987                                  ;	  the initial high tag, copy the temp to the child's name spot
 16988                                  ;	  and return success. Otherwise, send the error back to caller.
 16989                                  ;
 16990                                  ;	  This routine depends on DS,ES,CS, & SS all being equal.
 16991                                  
 16992                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 16993                                  FindNextChild:
 16994 0000164C 83EC0C                  	sub	sp,12			; make temp filename buf on stack
 16995                                  	;shove	00FFh			; temp filename = high tag
 16996 0000164F B8FF00                  	mov	ax,0FFh
 16997 00001652 50                      	push	ax
 16998 00001653 89E5                    	mov	bp,sp			; BP = ptr to temp filename buf
 16999                                  	;shove	"*"	
 17000 00001655 B02A                    	mov	al,'*'  ; ax = 002Ah
 17001 00001657 50                      	push	ax
 17002                                  	;;shove	".*" 
 17003                                  	;mov	ax,"*."
 17004                                  	;mov	ax,2E2Ah
 17005 00001658 B42E                    	mov	ah,'.'
 17006 0000165A 50                      	push	ax
 17007 0000165B E82F06                  	call	GetDriveLtr		; AX = "d:"
 17008 0000165E 50                      	push	ax
 17009 0000165F 89E2                    	mov	dx,sp			; DX = ptr to "d:*.*",0 on stack
 17010                                  
 17011                                  ;	See that the stack is restored properly at the end of this proc.
 17012                                  
 17013                                  	;mov	cx,10h
 17014 00001661 B91000                  	mov	cx,ATTR_DIRECTORY	; CX = attributes for file search
 17015 00001664 B44E                    	mov	ah,4Eh
 17016                                  	;mov	ah,Find_First
 17017 00001666 CD21                    	int	21h			; DOS- Find First matching file
 17018 00001668 722C                    	jc	short fcRet		; return error
 17019                                  
 17020 0000166A E89EFD                  	call	CheckChild		; check child against last, temp
 17021                                  fcNext:	
 17022                                  	;mov	cx,10h
 17023 0000166D B91000                  	mov	cx,ATTR_DIRECTORY	; CX = attributes for file search
 17024 00001670 B44F                    	mov	ah,4Fh
 17025                                  	;mov	ah,Find_Next
 17026 00001672 CD21                    	int	21h			; DOS- Find Next matching file
 17027 00001674 7205                    	jc	short fcErr		; examine error
 17028                                  
 17029 00001676 E892FD                  	call	CheckChild		; check child against last, temp
 17030 00001679 EBF2                    	jmp	short fcNext		; go find another child
 17031                                  
 17032                                  fcErr:
 17033 0000167B E8CB09                  	call	get_ext_error_number	; AX = extended error code
 17034                                  	;cmp	ax,18
 17035 0000167E 83F812                  	cmp	ax,ERROR_NO_MORE_FILES	; no more files?
 17036 00001681 7512                    	jne	short fcNope		; some other error- return it
 17037                                  
 17038                                  ;	We ran out of files. See if we qualified at least one.
 17039                                  
 17040 00001683 807E00FF                	cmp	byte [bp],0FFh
 17041 00001687 740C                    	je	short fcNope		; temp filename is unused- no child
 17042                                  
 17043                                  ;	Move temp filename to child name position.
 17044                                  
 17045 00001689 89EE                    	mov	si,bp			; SI = ptr to temp filename
 17046 0000168B 89DF                    	mov	di,bx			; DI = ptr to child name pos'n
 17047                                  fcMove:
 17048 0000168D AC                      	lodsb				; AL = next byte of filename
 17049 0000168E AA                      	stosb				; store byte
 17050 0000168F 08C0                    	or	al,al
 17051 00001691 7403                    	jz	short fcRet		; byte was zero, return success (CY clear)
 17052 00001693 EBF8                    	jmp	short fcMove		; go move another byte
 17053                                  fcNope:
 17054 00001695 F9                      	stc				; return error
 17055                                  fcRet:
 17056 00001696 9F                      	lahf
 17057 00001697 83C414                  	add	sp,20			; restore stack
 17058 0000169A 9E                      	sahf
 17059 0000169B C3                      	retn
 17060                                  
 17061                                  ; ---------------------------------------------------------------------------
 17062                                  
 17063                                  ;***	FindOneInMem - find the first available entry in TPA
 17064                                  ;***	FindNextInMem - find the next available entry in TPA
 17065                                  ;
 17066                                  ;	ENTRY	ES = TPA seg addr
 17067                                  ;		BX = ptr to entry in TPA
 17068                                  ;
 17069                                  ;	EXIT	BX = ptr to entry found
 17070                                  ;		CY = set if no more entries available in TPA
 17071                                  ;
 17072                                  ;	USED	AL
 17073                                  
 17074                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17075                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17076                                  FindOneInMem:
 17077 0000169C 268A07                  	mov	al,[es:bx]		; examine 'used' byte of starting entry
 17078 0000169F 3C01                    	cmp	al,1
 17079 000016A1 7406                    	je	short FindNextInMem	; entry has already been used
 17080 000016A3 3CFF                    	cmp	al,0FFh
 17081 000016A5 7407                    	je	short foNoMore		; 0FFh, we're at the end of the list
 17082                                  
 17083                                  ;	BX = ptr to entry that hasn't been output yet.
 17084                                  
 17085 000016A7 F8                      	clc				; return success
 17086 000016A8 C3                      	retn
 17087                                  
 17088                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17089                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:163Ah
 17090                                  FindNextInMem:
 17091                                  	; 07/06/2023
 17092                                  	;add	bx,21 ; MSDOS 5.0
 17093                                  	; 07/06/2023
 17094 000016A9 83C316                  	add	bx,22 ; MSDOS 6.0  ; size EntryStruc (22 = 21 + compratio)
 17095                                  	;add	bx,size EntryStruc	; BX = ptr to next entry
 17096 000016AC EBEE                    	jmp	short FindOneInMem	; go look at it
 17097                                  foNoMore:
 17098 000016AE F9                      	stc				; ran out of entries, return failure
 17099 000016AF C3                      	retn
 17100                                  
 17101                                  ; ---------------------------------------------------------------------------
 17102                                  
 17103                                  ;***	GetEnvValue - get value of our environment variable
 17104                                  ;
 17105                                  ;	ENTRY	DS, ES = TRANGROUP seg addr
 17106                                  ;
 17107                                  ;	EXIT	CY = set if environment variable not in environment
 17108                                  ;
 17109                                  ;		Otherwise:
 17110                                  ;		SI = ptr to environment variable asciiz value in TRANGROUP
 17111                                  ;
 17112                                  ;	USED	AX,BX,CX,DX,DI
 17113                                  ;		(We assume the (almost) worst, since we don't know about
 17114                                  ;		Find_Name_In_Environment.)
 17115                                  ;
 17116                                  ;	EFFECTS
 17117                                  ;
 17118                                  ;	  ScanBuf is loaded with value text
 17119                                  
 17120                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17121                                  GetEnvValue:
 17122 000016B0 06                      	push	es				; save ES
 17123                                  	;mov	si,offset TRANGROUP:DirEnvVar	; DS:SI = ptr to variable name
 17124 000016B1 BE[F992]                	mov	si,DirEnvVar	; "DIRCMD="
 17125                                  	;invoke	Find_Name_In_Environment
 17126 000016B4 E8FE0F                  	call	find_name_in_environment
 17127 000016B7 7214                    	jc	short geRet			; name not found in environment
 17128                                  
 17129                                  ;	ES:DI = ptr to value of environment variable
 17130                                  ;	We're assuming DS, CS, and SS are unchanged.
 17131                                  
 17132 000016B9 1E                      	push	ds
 17133 000016BA 06                      	push	es
 17134 000016BB 1F                      	pop	ds
 17135 000016BC 07                      	pop	es
 17136                                  
 17137                                  	;assume	ds:nothing
 17138                                  
 17139                                  ;	DS = seg addr of environment variable value (in environment segment)
 17140                                  ;	ES = TRANGROUP seg addr
 17141                                  
 17142 000016BD 89FE                    	mov	si,di				; DS:SI = ptr to value string
 17143                                  	;mov	di,offset TRANGROUP:ScanBuf	; ES:DI = ptr to dest buffer
 17144 000016BF BF[DA9E]                	mov	di,ScanBuf
 17145                                  geLoop:
 17146                                  ;@@:	
 17147 000016C2 AC                      	lodsb
 17148 000016C3 08C0                    	or	al,al
 17149 000016C5 AA                      	stosb
 17150                                  	;loopnz	@B		; move the string, including trailing null
 17151 000016C6 E0FA                    	loopnz	geLoop
 17152                                  
 17153 000016C8 06                      	push	es
 17154 000016C9 1F                      	pop	ds		; DS = TRANGROUP seg addr again
 17155                                  	;assume	ds:TRANGROUP
 17156                                  
 17157                                  	;mov	si,offset TRANGROUP:ScanBuf	; SI = ptr to var value
 17158 000016CA BE[DA9E]                	mov	si,ScanBuf
 17159                                  geRet:
 17160 000016CD 07                      	pop	es				; restore ES
 17161 000016CE C3                      	retn
 17162                                  
 17163                                  ; ---------------------------------------------------------------------------
 17164                                  
 17165                                  ;***	GetFirst - get first directory entry from disk
 17166                                  ;
 17167                                  ;	ENTRY	DOS DTA established at DirBuf
 17168                                  ;		FCB contains drive # and filename
 17169                                  ;		Current directory (on selected drive) is the one to search
 17170                                  ;		AttrSpecified & AttrSelect masks set
 17171                                  ;
 17172                                  ;	EXIT	CY = clear if success
 17173                                  ;		DirBuf contains extended FCB for file found
 17174                                  ;
 17175                                  ;		If unsuccessful,
 17176                                  ;		CY = set
 17177                                  ;		Ready for DOS Get Extended Error call
 17178                                  ;
 17179                                  ;	USED	AX,DX
 17180                                  ;
 17181                                  ;	EFFECTS
 17182                                  ;
 17183                                  ;	  FCB-7 = 0FFh to mark extended FCB
 17184                                  ;	  FCB-1 = attribute mask to find all files
 17185                                  ;	  These fields should remain unmodified for GetNext calls.
 17186                                  ;
 17187                                  ;***	GetNext - get next directory entry from disk
 17188                                  ;
 17189                                  ;	ENTRY	As for GetFirst, plus
 17190                                  ;		FCB-7 set up as extended FCB w/ find-all attribute byte
 17191                                  ;
 17192                                  ;	EXIT	As for GetFirst
 17193                                  ;
 17194                                  ;	USED	AX,DX
 17195                                  
 17196                                  	; 18/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17197                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:144Fh
 17198                                  
 17199                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17200                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1660h
 17201                                  GetFirst:
 17202                                  	;mov	byte [55h],0FFh	; -1
 17203 000016CF C6065500FF              	mov	byte [FCB-7],0FFh	; signal extended FCB
 17204                                  	;mov	byte [5Bh],16h
 17205 000016D4 C6065B0016              	mov	byte [FCB-1],ATTR_ALL ; 16h
 17206                                  					; find any file
 17207                                  	; 07/06/2023
 17208                                  	;mov	dx,FCB-7 ; 55h		; DX = ptr to extended FCB
 17209 000016D9 B411                    	mov	ah,11h
 17210                                  	;mov	ah,Dir_Search_First	; AH = DOS Find First function code
 17211                                  	; 07/06/2023
 17212                                  	;int	21h			; call DOS
 17213                                  	;shl	al,1			; CY = set if error
 17214                                  	;jc	short gfRet		; return error
 17215                                  	;jmp	short gfFound		; go look at attr's
 17216                                  	; 07/06/2023
 17217 000016DB EB02                    	jmp	short GetFrstNxt
 17218                                  GetNext:
 17219                                  	; 07/06/2023
 17220                                  	;;mov	dx,55h
 17221                                  	;mov	dx,FCB-7		; DX = ptr to extended FCB
 17222 000016DD B412                    	mov	ah,12h
 17223                                  	;mov	ah,Dir_Search_Next	; AH = DOS Find Next function code
 17224                                  GetFrstNxt:
 17225                                  	; 07/06/2023
 17226 000016DF BA5500                  	mov	dx,FCB-7 ; mov dx,55h
 17227                                  	;
 17228 000016E2 CD21                    	int	21h			; call DOS
 17229 000016E4 D0E0                    	shl	al,1			; CY = set if error
 17230 000016E6 7211                    	jc	short gfRet		; return error
 17231                                  
 17232                                  ;*	Found an entry. Check attributes.
 17233                                  gfFound:
 17234                                  	;;mov	al,[DirBuf+8].dir_attr	; AL = file attributes
 17235                                  	;mov	al,[DIRBUF+19]
 17236 000016E8 A0[AD9D]                	mov	al,[DIRBUF+8+DIR_ENTRY.DIR_ATTR]
 17237 000016EB 8A26[F49D]              	mov	ah,[AttrSpecified]	; AH = mask of pertinent attr's
 17238 000016EF 20E0                    	and	al,ah			; AL = pertinent attr's of file
 17239 000016F1 2226[F59D]              	and	ah,[AttrSelect]		; AH = attr settings to match
 17240 000016F5 38E0                    	cmp	al,ah
 17241 000016F7 75E4                    	jne	short GetNext		; attr's don't match, look for another
 17242                                  gfRet:
 17243 000016F9 C3                      	retn
 17244                                  
 17245                                  ; ---------------------------------------------------------------------------
 17246                                  
 17247                                  ;***	ListDir - search for and list files in the current directory
 17248                                  ;
 17249                                  ;	List header, files, and trailer for current directory on selected
 17250                                  ;	drive. Header & trailer are listed if at least one file is found.
 17251                                  ;	If no qualifying files are found, no display output occurs.
 17252                                  ;
 17253                                  ;	ENTRY	Current directory (on selected drive) is the one to be listed
 17254                                  ;		FCB contains selected drive # and filename spec
 17255                                  ;		Option bits, attribute masks, and sort codes set up
 17256                                  ;
 17257                                  ;	EXIT	CY = clear if no error
 17258                                  ;		FileCnt = # files found & displayed
 17259                                  ;
 17260                                  ;		If error,
 17261                                  ;		CY = set
 17262                                  ;		Ready for DOS Get Extended Error call
 17263                                  ;
 17264                                  ;	USED	AX,BX,CX,DX,SI,DI,BP
 17265                                  ;		FileSiz
 17266                                  ;
 17267                                  ;	EFFECTS
 17268                                  ;
 17269                                  ;	  FileCntTotal, FileSizTotal are updated.
 17270                                  ;	  Files found are listed. A directory header and trailer are
 17271                                  ;	   displayed only if files are found.
 17272                                  
 17273                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17274                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:155Eh
 17275                                  
 17276                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17277                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1694h
 17278                                  
 17279                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17280                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1776h
 17281                                  ListDir:
 17282 000016FA 31C0                    	xor	ax,ax ; 0
 17283 000016FC A3[819C]                	mov	[FileCnt],ax		; zero file count
 17284 000016FF A3[839C]                	mov	[FileSiz],ax		; zero file size accumulator
 17285 00001702 A3[859C]                	mov	[FileSiz+2],ax
 17286                                  
 17287                                  ; 31/07/2024
 17288                                  ; PCDOS 7.1 COMMAND.COM
 17289                                  %if 1
 17290 00001705 A3[879C]                	mov	[FileSiz+4],ax
 17291 00001708 A3[899C]                	mov	[FileSiz+6],ax	
 17292                                  %else
 17293                                  	; 08/06/2023
 17294                                  	; MSDOS 6.0
 17295                                  ;ifdef DBLSPACE_HOOKS
 17296                                  	mov	[ccluUsedDir],ax 	; zero count clusters used
 17297                                  	mov	[csecUsedDir],ax	; zero count compressed sectors used
 17298                                  	mov	[csecUsedDir+2],ax
 17299                                  ;endif
 17300                                  %endif	
 17301                                  	;cmp	byte [DestBuf],0	; check for sort code
 17302                                  	; 31/07/2024
 17303 0000170B 3806[1D9E]              	cmp	[DestBuf],al ; 0
 17304 0000170F 740A                    	je	short ld1		; no sort
 17305 00001711 E83000                  	call	LoadEntries		; load entries for sorted listing
 17306 00001714 7305                    	jnc	short ld1		; no error - continue
 17307 00001716 E83009                  	call	get_ext_error_number	; AX = DOS error code
 17308                                  	; 19/02/2023
 17309                                  	;stc
 17310 00001719 EB12                    	jmp	short ldErr		; return error
 17311                                  ld1:
 17312 0000171B E8DAFE                  	call	FindFirst		; find first file
 17313 0000171E 720D                    	jc	short ldErr		; not found, return error
 17314                                  
 17315                                  ;	BX = offset in TPA buffer of entry found
 17316                                  
 17317 00001720 E82203                  	call	DisplayHeader		; if at least one file, display header
 17318                                  ldNext:
 17319 00001723 E8FA02                  	call	DisplayFile		; display the file entry
 17320                                  ;ldNext:
 17321 00001726 E8D4FE                  	call	FindNext		; find another file
 17322 00001729 7202                    	jc	short ldErr		; not found
 17323                                  	;call	DisplayFile		; display entry
 17324                                  	;jmp	short ldNext		; go find another one
 17325                                  	; 19/02/2023
 17326 0000172B EBF6                    	jmp	short ldNext
 17327                                  ldErr:
 17328                                  	;cmp	ax,2
 17329 0000172D 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND
 17330 00001730 7407                    	je	short ldDone		; file not found, we're done
 17331                                  	;cmp	ax,18
 17332 00001732 83F812                  	cmp	ax,ERROR_NO_MORE_FILES
 17333 00001735 7402                    	je	short ldDone		; no more files, we're done
 17334 00001737 F9                      	stc
 17335                                  	;jmp	short ldRet
 17336                                  	; 19/02/2023
 17337 00001738 C3                      	retn
 17338                                  ldDone:
 17339 00001739 833E[819C]00            	cmp	word [FileCnt],0
 17340                                  	;je	short ld2		; no files found, just return
 17341                                  	; 25/04/2023
 17342 0000173E 7403                    	jz	short ldRet
 17343 00001740 E8A104                  	call	DisplayTrailer		; display trailing info
 17344                                  	; 08/06/2023
 17345                                  	; cf=0
 17346                                  ;ld2:	
 17347                                  	;clc				; return success
 17348                                  ldRet:
 17349 00001743 C3                      	retn
 17350                                  
 17351                                  ; ---------------------------------------------------------------------------
 17352                                  
 17353                                  ;***	LoadEntries - attempt to load entries from current directory
 17354                                  ;
 17355                                  ;	Load all qualifying directory entries from the current directory
 17356                                  ;	into the TPA. If an error is returned by FindFirst/FindNext calls
 17357                                  ;	other than 'no more files', return to caller with carry flag set.
 17358                                  ;	If we run out of buffer space, display a message that we haven't
 17359                                  ;	enough memory to sort this directory, but return without error.
 17360                                  ;	Other routines know whether or not entries have been loaded by
 17361                                  ;	the 'inmem' flag bit, which we set here.
 17362                                  ;
 17363                                  ;	The TPA is usually 64K - 512 bytes long. At 20 bytes per entry,
 17364                                  ;	this allows sorting over 3000 entries in a directory.
 17365                                  ;
 17366                                  ;	ENTRY	Tpa = buffer seg addr
 17367                                  ;		BytCnt = buffer length, in bytes
 17368                                  ;		Current directory (on selected drive) is the one to load
 17369                                  ;		FCB contains drive # and filespec
 17370                                  ;		Bits, AttrSpecified, AttrSelect, & DestBuf (sort codes) are set
 17371                                  ;
 17372                                  ;	EXIT	CY = set if error
 17373                                  ;		If error, DOS Get Extended Error will get error info
 17374                                  ;
 17375                                  ;	USED	AX,CX,DX,SI,DI
 17376                                  ;
 17377                                  ;	EFFECTS
 17378                                  ;
 17379                                  ;	  Inmem bit of Bits = set if load succeeded.
 17380                                  ;	  Tpa buffer contains directory entries.
 17381                                  ;	  Byte after last entry = 0FFh.
 17382                                  
 17383                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17384                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17385                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17386                                  LoadEntries:
 17387 00001744 06                      	push	es			; save TRANGROUP seg addr
 17388 00001745 8E06[559C]              	mov	es,[TPA]		; ES = TPA seg addr
 17389 00001749 31FF                    	xor	di,di			; ES:DI = destination ptr
 17390                                  	;;;and	Bits,not mask inmem	; signal entries not loaded
 17391                                  	; MSDOS 5.0
 17392                                  	;;;and	word [_Bits],0FFDFh
 17393                                  	;;and	byte [_Bits],0DFh	; not 20h
 17394                                  	; 31/07/2024
 17395                                  	;and	word [_Bits],0FF7Fh ; PCDOS 7.1 COMMAND.COM
 17396                                  	; 08/06/2023
 17397                                  	;and	byte [_Bits],0BFh	; ~20h ; MSDOS 6.0
 17398 0000174B 8026[EC9D]7F            	and	byte [_Bits],~mask.inmem ; 0BFh ; MSDOS 6.0
 17399                                  			; 31/07/2024	; 07Fh ; PCDOS 7.1
 17400                                  
 17401 00001750 E87CFF                  	call	GetFirst		; look for first file
 17402 00001753 7221                    	jc	short leRet		; return any error
 17403 00001755 E82000                  	call	LoadEntry		; load entry into TPA
 17404                                  leNext:
 17405 00001758 E882FF                  	call	GetNext			; get another file
 17406 0000175B 720F                    	jc	short leLoaded		; assume any error is no more files
 17407 0000175D A1[749C]                	mov	ax,[BYTCNT]		; AX = size of TPA
 17408 00001760 29F8                    	sub	ax,di			; AX = bytes left in TPA
 17409                                  	; 08/06/2023
 17410                                  	;;cmp	ax,size EntryStruc+2	; insist on entry size + 2 bytes
 17411                                  	;cmp	ax,23 ; 21+2 ; MSDOS 5.0
 17412 00001762 83F818                  	cmp	ax,24 ; 22+2 ; MSDOS 6.0
 17413 00001765 720E                    	jb	short leOk		; not enough memory left, give up
 17414 00001767 E80E00                  	call	LoadEntry		; load entry into TPA
 17415 0000176A EBEC                    	jmp	short leNext		; go get another file
 17416                                  
 17417                                  leLoaded:
 17418 0000176C 26C605FF                	mov	byte [es:di],0FFh	; mark end of entry list
 17419                                  	;;;or	Bits,mask inmem		; signal entries loaded in memory
 17420                                  	; MSDOS 5.0
 17421                                  	;;or	word [_Bits],20h
 17422                                  	;or	byte [_Bits],20h
 17423                                  	; 08/06/2023
 17424                                  	;or	byte [_Bits],40h	; MSDOS 6.0
 17425 00001770 800E[EC9D]80            	or	byte [_Bits],mask.inmem ; 40h ; MSDOS 6.0 
 17426                                  			; 31/07/2024	; 80h ; PCDOS 7.1	
 17427                                  	; 25/04/2023
 17428                                  	; cf = 0
 17429                                  leOk:
 17430 00001775 F8                      	clc				; return no error
 17431                                  leRet:
 17432 00001776 07                      	pop	es			; ES = TRANGROUP seg addr again
 17433 00001777 C3                      	retn
 17434                                  
 17435                                  ; ---------------------------------------------------------------------------
 17436                                  
 17437                                  ;***	LoadEntry - load directory entry from DirBuf ext'd FCB
 17438                                  ;
 17439                                  ;	ENTRY	ES:DI = ptr to load point in TPA
 17440                                  ;		DirBuf contains extended FCB of entry to load
 17441                                  ;
 17442                                  ;	EXIT	ES:DI = ptr to next byte available in TPA
 17443                                  ;
 17444                                  ;	USED	AX,CX,SI
 17445                                  ;
 17446                                  ;	NOTES
 17447                                  ;
 17448                                  ;	  I could've used symbolic offsets and sizes of fields from
 17449                                  ;	   the dir_entry struc to do this, but this is time-critical,
 17450                                  ;	   so I hard-wired the structure of the DOS 4.x returned FCB,
 17451                                  ;	   as well as our private directory entry structure.
 17452                                  ;
 17453                                  ;	  We force a zero size for subdirectory files. A zero size is
 17454                                  ;	   ordinarily returned for subdirectories, but with Novell
 17455                                  ;	   Netware 286 or 386 loaded, we can't depend on it. Bug #1594.
 17456                                  
 17457                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17458                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:15DDh
 17459                                  	
 17460                                  	; 07/06/2023 - Retro DOS v4.2 COMMAND.COM
 17461                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:171Ch
 17462                                  
 17463                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 17464                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:17FDh
 17465                                  LoadEntry:
 17466                                  	;mov	si,offset TRANGROUP:Dirbuf+8	; DS:SI = ptr to filename
 17467 00001778 BE[A29D]                	mov	si,DIRBUF+8
 17468 0000177B 30C0                    	xor	al,al				; AL = 0
 17469 0000177D AA                      	stosb					; 'used' byte = false
 17470 0000177E B90B00                  	mov	cx,11
 17471 00001781 F3A4                    	rep	movsb				; transfer filename & extension
 17472 00001783 AC                      	lodsb					; AL = attrib byte
 17473 00001784 AA                      	stosb					; store attrib byte
 17474                                  	;add	si,10 ; 22-11-1
 17475                                  	;add	si,dir_time-dir_attr-1		; skip to time field
 17476 00001785 83C60A                  	add	si,(DIR_ENTRY.DIR_TIME-DIR_ENTRY.DIR_ATTR)-1
 17477 00001788 A5                      	movsw					; transfer time
 17478 00001789 A5                      	movsw					; transfer date
 17479                                  
 17480                                  ; 08/06/2023
 17481                                  ; MSDOS 5.0
 17482                                  %if 0
 17483                                  	inc	si				; skip alloc unit
 17484                                  	inc	si
 17485                                  	;and	al,10h
 17486                                  	and	al,ATTR_DIRECTORY
 17487                                  	jnz	short leSetDirSize		; force zero size for subdir
 17488                                  	movsw
 17489                                  	movsw					; transfer size
 17490                                  	retn
 17491                                  leSetDirSize:
 17492                                  	xor	ax,ax ; 0
 17493                                  	stosw
 17494                                  	stosw					; store zero size
 17495                                  	retn
 17496                                  %endif
 17497                                  
 17498                                  ; 08/06/2023
 17499                                  ; MSDOS 6.0
 17500                                  ;%if 1
 17501                                  ;ifdef DBLSPACE_HOOKS
 17502 0000178A 88C1                    	mov	cl,al				; attrib to cl
 17503 0000178C AD                      	lodsw					; allocation unit (cluster
 17504                                  	;and	cl,10h
 17505 0000178D 80E110                  	and	cl,ATTR_DIRECTORY
 17506 00001790 7506                    	jnz	short leSetDirSize		; force zero size for subdir
 17507 00001792 A5                      	movsw
 17508 00001793 A5                      	movsw					; transfer size
 17509                                  
 17510                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17511                                  %if 0
 17512                                  	;;test	word [_Bits],1
 17513                                  	;test	word [_Bits],mask.cratio	; compression ratio report?
 17514                                  	test	byte [_Bits],mask.cratio
 17515                                  	jnz	short leCalcRatio		; yup
 17516                                  %endif
 17517                                  
 17518 00001794 31C0                    	xor	ax,ax
 17519 00001796 AA                      	stosb					; dummy compression ratio
 17520 00001797 C3                      	retn
 17521                                  
 17522                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17523                                  %if 0
 17524                                  leCalcRatio:
 17525                                  	call	CalcCompRatio			; takes cluster in AX
 17526                                  	or	ax,ax				;   returns ratio in AX
 17527                                  	jz	short leNoRatio			; 0 means couldn't calculate
 17528                                  	dec	ah				; pack 1.0 - 16.0 comp ratio
 17529                                  	mov	cl,4				;   into 2 nibbles.  Store
 17530                                  	shl	ah,cl				;   1-16 as 0-15 in hi nibble,
 17531                                  	or	al,ah				;   tenths (0-9) in low nibble
 17532                                  	stosb
 17533                                  	retn
 17534                                  %endif
 17535                                  
 17536                                  leSetDirSize:
 17537 00001798 31C0                    	xor	ax,ax ; 0
 17538 0000179A AB                      	stosw
 17539 0000179B AB                      	stosw					; store zero size
 17540                                  leNoRatio:
 17541 0000179C FEC8                    	dec	al				; al = FFh = special invalid
 17542 0000179E AA                      	stosb					; compression ratio
 17543 0000179F C3                      	retn
 17544                                  ;endif
 17545                                  ;%endif
 17546                                  
 17547                                  ; ---------------------------------------------------------------------------
 17548                                  
 17549                                  ;***	NoOrder - turn sorting off
 17550                                  ;
 17551                                  ;	ENTRY	nothing
 17552                                  ;
 17553                                  ;	EXIT	CY clear
 17554                                  ;
 17555                                  ;	USED	AX
 17556                                  ;
 17557                                  ;	EFFECTS
 17558                                  ;
 17559                                  ;	  DestBuf is updated with sort code bytes. See DestBuf description.
 17560                                  
 17561                                  	; 19/02/2023
 17562                                  NoOrder:
 17563 000017A0 C606[1D9E]00            	mov	byte [DestBuf],0
 17564                                  				; no sort
 17565 000017A5 F8                      	clc			; no error
 17566 000017A6 C3                      	retn
 17567                                  
 17568                                  ; ---------------------------------------------------------------------------
 17569                                  
 17570                                  ;***	OnOffSw - record occurence of on/off option switch
 17571                                  ;
 17572                                  ;	ENTRY	DI = index into word list of switches
 17573                                  ;
 17574                                  ;	EXIT	CY clear
 17575                                  ;
 17576                                  ;	USED	AX,CX
 17577                                  ;
 17578                                  ;	EFFECTS
 17579                                  ;
 17580                                  ;	  Bits modified to indicate option state.
 17581                                  
 17582                                  	; 19/02/2023
 17583                                  OnOffSw:
 17584 000017A7 89F9                    	mov	cx,di		; CX = index into word list of options
 17585 000017A9 D1E9                    	shr	cx,1
 17586 000017AB D1E9                    	shr	cx,1		; CX = bit position of option
 17587 000017AD B80100                  	mov	ax,1		
 17588 000017B0 D3E0                    	shl	ax,cl		; AX = bit mask of option
 17589 000017B2 F7C70200                	test	di,2		; check if it is a negated option
 17590 000017B6 7405                    	jz	short oo1	; it's negated
 17591                                  	;or	Bits,ax		; turn option on
 17592 000017B8 0906[EC9D]              	or	[_Bits],ax
 17593                                  	;jmp	short ooRet
 17594                                  	; 19/02/2023
 17595                                  	;cf=0
 17596 000017BC C3                      	retn
 17597                                  oo1:	
 17598 000017BD F7D0                    	not	ax		; AX = complemented bit mask of option
 17599                                  	;and	Bits,ax		; turn option off
 17600 000017BF 2106[EC9D]              	and	[_Bits],ax
 17601                                  ooRet:
 17602                                  	; 19/02/2023
 17603                                  	;cf=0
 17604                                  	;clc			; always return success
 17605 000017C3 C3                      	retn
 17606                                  
 17607                                  ; ---------------------------------------------------------------------------
 17608                                  
 17609                                  ;***	ParseAttr - parse and record /A option
 17610                                  ;
 17611                                  ;	ENTRY	BX = ptr to system parser result buffer for /A occurence
 17612                                  ;
 17613                                  ;	EXIT	CY = set if error occurs parsing attribute conditions
 17614                                  ;
 17615                                  ;		For parse error, we set up for Std_EPrintf call:
 17616                                  ;		AX = parse error code, like system parser
 17617                                  ;		DX = ptr to message block
 17618                                  ;
 17619                                  ;	USED	AX,CX,DX,DI
 17620                                  ;
 17621                                  ;	EFFECTS
 17622                                  ;
 17623                                  ;	  AttrSpecified, AttrSelect are updated with new attribute conditions.
 17624                                  ;	  If parse error occurs, attribute conditions parsed so far hold.
 17625                                  ;
 17626                                  ;	  For parse error, we set up for Std_EPrintf call:
 17627                                  ;	  Msg_Disp_Class = parse error message class
 17628                                  ;	  Message block (see DX) is set up for parse error message
 17629                                  
 17630                                  	; 19/02/2023
 17631                                  ParseAttr:
 17632 000017C4 56                      	push	si			; save SI
 17633 000017C5 C606[F49D]00            	mov	byte [AttrSpecified],0	; cancel all attribute conditions
 17634                                  
 17635                                  ;	Each /A invocation starts by assuming all files are to be listed.
 17636                                  
 17637                                  	;;mov	si,word ptr [bx].ValuePtr
 17638                                  					; SI = ptr to string after /A
 17639                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17640 000017CA 8B7704                  	mov	si,[bx+4]
 17641                                  paLoop:	
 17642 000017CD BA0100                  	mov	dx,1			; DX = 1 (for un-negated attribute)
 17643 000017D0 AC                      	lodsb				; AL = next char in string
 17644 000017D1 08C0                    	or	al,al
 17645                                  	;jz	short paOk		; it's terminating null, we're done
 17646                                  	; 19/02/2023
 17647 000017D3 742F                    	jz	short paRet ; cf=0
 17648 000017D5 3C2D                    	cmp	al,'-'
 17649 000017D7 7502                    	jne	short pa1		; not '-', go look for letter
 17650 000017D9 4A                      	dec	dx			; DX = 0 (for negated attribute)
 17651 000017DA AC                      	lodsb				; AL = next char
 17652                                  pa1:	
 17653                                  	;mov	di,offset TRANGROUP:AttrLtrs 
 17654                                  					; DI = ptr to attrib letter list
 17655 000017DB BF[CC95]                	mov	di,AttrLtrs ; "RHSvDA"
 17656                                  	;mov	cx,6
 17657 000017DE B90600                  	mov	cx,NUM_ATTR_LTRS ; 6	; CX = length of attrib letter list
 17658 000017E1 F2AE                    	repne	scasb			; look for our letter in the list
 17659 000017E3 751B                    	jne	short paErr		; not found, return error
 17660                                  
 17661 000017E5 F7D1                    	not	cx
 17662                                  	;add	cx,6
 17663 000017E7 83C106                  	add	cx,NUM_ATTR_LTRS	; CX = attrib bit #, 0-5
 17664                                  
 17665                                  ;	Note that we rely on AttrLtrs to be in the attribute bit order,
 17666                                  ;	starting from bit 0.
 17667                                  
 17668                                  ;	Record this attribute bit in AttrSpecified.
 17669                                  
 17670 000017EA B001                    	mov	al,1
 17671 000017EC D2E0                    	shl	al,cl			; AL = mask for our bit
 17672 000017EE 0806[F49D]              	or	[AttrSpecified],al	; set it in the 'specified' mask
 17673                                  
 17674                                  ;	Record the selected state for this attribute in AttrSelect.
 17675                                  ;	DX = 0 or 1, the selected state for this attribute.
 17676                                  
 17677 000017F2 F6D0                    	not	al			; AL = mask for all other bits
 17678 000017F4 2006[F59D]              	and	[AttrSelect],al		; clear our bit
 17679 000017F8 D2E2                    	shl	dl,cl			; DL = our bit state in position
 17680 000017FA 0816[F59D]              	or	[AttrSelect],dl		; set selected attr state
 17681 000017FE EBCD                    	jmp	short paLoop		; go look at next char
 17682                                  
 17683                                  ;	The attribute letter string is invalid.
 17684                                  
 17685                                  paErr:	
 17686 00001800 E89B04                  	call	SetupParamError		; set message up for Std_EPrintf
 17687 00001803 F9                      	stc		   		; return error
 17688                                  	; 19/02/2023
 17689                                  	;jmp	short paRet
 17690                                  ;paOk:
 17691                                  	;clc				; return success		
 17692                                  paRet:	
 17693 00001804 5E                      	pop	si			; restore SI
 17694 00001805 C3                      	retn
 17695                                  
 17696                                  ; ---------------------------------------------------------------------------
 17697                                  
 17698                                  ;***	ParseLine - parse a line of text
 17699                                  ;
 17700                                  ;	Parse text until an EOL (CR or NUL) is found, or until a parse
 17701                                  ;	error occurs.
 17702                                  ;
 17703                                  ;	ENTRY	DS:SI = ptr to text
 17704                                  ;		CS, DS, ES = TRANGROUP seg addr
 17705                                  ;
 17706                                  ;	EXIT	AX = last return code from system parser
 17707                                  ;		CX = # positional parameters (pathnames) found - 0 or 1
 17708                                  ;
 17709                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 17710                                  ;		DX = ptr to message block
 17711                                  ;
 17712                                  ;	USED	BX,CX,DX,SI,DI
 17713                                  ;
 17714                                  ;	EFFECTS
 17715                                  ;
 17716                                  ;	  Bits may contain new option settings.
 17717                                  ;	  DestBuf may contain new series of sort codes.
 17718                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 17719                                  ;	  SrcBuf may contain a new default pathname/filespec.
 17720                                  ;	  PathPos, PathCnt updated for new pathname.
 17721                                  ;
 17722                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 17723                                  ;	  Msg_Disp_Class = parse error class
 17724                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 17725                                  ;	  Message block (see DX) is set up for parse error message
 17726                                  
 17727                                  	; 19/02/2023
 17728                                  Parse_Line:
 17729                                  	; 04/05/2023
 17730 00001806 BF[9996]                	mov	di,PARSE_DIR		; ES:DI = ptr to parse block
 17731 00001809 31C9                    	xor	cx,cx			; CX = # positionals found
 17732                                  plPars:
 17733 0000180B E84B0D                  	call	Parse_With_Msg		; call parser
 17734 0000180E 83F8FF                  	cmp	ax,-1
 17735                                  	;cmp	ax,END_OF_LINE ; 0FFFFh ; -1
 17736 00001811 7411                    	je	short plRet		; EOL encountered, return
 17737 00001813 83F800                  	cmp	ax,RESULT_NO_ERROR ; 0
 17738 00001816 750C                    	jne	short plRet		; parse error occurred, return
 17739                                  
 17740                                  ;	Parse call succeeded. We have a filespec or a switch.
 17741                                  ;	DX = ptr to result buffer
 17742                                  
 17743 00001818 89D3                    	mov	bx,dx			; BX = ptr to parse result buffer
 17744 0000181A 803F05                  	cmp	byte [bx],RESULT_FILESPEC ; 5
 17745 0000181D 7406                    	je	short plFil		; we have a filespec
 17746                                  
 17747 0000181F E85900                  	call	ParseSwitch		; else we have a switch
 17748                                  	;jc	short plRet		; error parsing switch, return
 17749                                  	;jmp	short plPars		; parse more
 17750                                  	; 19/02/2023
 17751 00001822 73E7                    	jnc	short plPars
 17752                                  plRet:
 17753 00001824 C3                      	retn	
 17754                                  plFil:	
 17755 00001825 E8BA00                  	call	CopyPathname		; copy pathname into our buffer
 17756 00001828 EBE1                    	jmp	short plPars		; parse more
 17757                                  ;plRet:
 17758                                  ;	retn
 17759                                  
 17760                                  ; ---------------------------------------------------------------------------
 17761                                  
 17762                                  ;***	ParseOrder - parse and record /O option
 17763                                  ;
 17764                                  ;	ENTRY	BX = ptr to system parser result buffer for /O occurence
 17765                                  ;
 17766                                  ;	EXIT	CY = set if error occurs parsing order
 17767                                  ;
 17768                                  ;		For parse error, we set up for Std_EPrintf call:
 17769                                  ;		AX = parse error code, like system parser
 17770                                  ;		DX = ptr to message block
 17771                                  ;
 17772                                  ;	USED	AX,CX,DX,DI
 17773                                  ;
 17774                                  ;	EFFECTS
 17775                                  ;
 17776                                  ;	  DestBuf is updated with sort code bytes. See DestBuf description.
 17777                                  ;
 17778                                  ;	  For parse error, we set up for Std_EPrintf call:
 17779                                  ;	  Msg_Disp_Class = parse error message class
 17780                                  ;	  Message block (see DX) is set up for parse error message
 17781                                  
 17782                                  	; 19/02/2023 - Retro DOS v4.0 COMMAND.COM
 17783                                  	;
 17784                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17785                                  	; MSDOS 6.22 COMMAND.COM
 17786                                  ParseOrder:
 17787 0000182A 56                      	push	si			; save SI
 17788 0000182B 53                      	push	bx			; save ptr to result buffer
 17789                                  
 17790                                  	;;mov	si,word ptr [bx].ValuePtr
 17791                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17792 0000182C 8B7704                  	mov	si,[bx+4]		; SI = ptr to order letters
 17793                                  	;mov	bx,offset TRANGROUP:DestBuf
 17794                                  	; 08/06/2023
 17795 0000182F BB[1D9E]                	mov	bx,DestBuf		; BX = ptr to sort code buffer
 17796 00001832 8A04                    	mov	al,[si]			; AL = 1st char of order string
 17797 00001834 08C0                    	or	al,al
 17798 00001836 750E                    	jnz	short poLtr		; not NUL, go parse letters
 17799                                  
 17800                                  ;	We have /O alone. Set standard sort order.
 17801                                  ;	Note hardwired dependency on character order in OrderLtrs.
 17802                                  
 17803 00001838 C60705                  	mov	byte [bx],5		; sort 1st by group (subdirs 1st)
 17804 0000183B 43                      	inc	bx
 17805 0000183C C60701                  	mov	byte [bx],1		; then by name
 17806 0000183F 43                      	inc	bx
 17807 00001840 C60702                  	mov	byte [bx],2		; then by extension
 17808 00001843 43                      	inc	bx
 17809 00001844 EB2F                    	jmp	short poOk		; return success
 17810                                  
 17811                                  ;	We have /O<something>. Parse sort order letters.
 17812                                  
 17813                                  poLtr:	
 17814 00001846 30D2                    	xor	dl,dl			; DL = 0 (upward sort)
 17815 00001848 AC                      	lodsb				; AL = next sort order letter
 17816 00001849 08C0                    	or	al,al
 17817 0000184B 7428                    	jz	short poOk		; NUL found, return success
 17818                                  
 17819 0000184D 3C2D                    	cmp	al,'-'
 17820 0000184F 7503                    	jne	short po1		; not '-', go look for letter
 17821 00001851 B280                    	mov	dl,80h			; DL = downward sort mask
 17822 00001853 AC                      	lodsb				; AL = next char
 17823                                  po1:
 17824                                  	;mov	di,offset TRANGROUP:OrderLtrs
 17825                                  	; 08/06/2023
 17826 00001854 BF[D295]                	mov	di,OrderLtrs ;"NEDSGC"	; DI = ptr to list of letters
 17827                                  	; (NUM_ORDER_LTRS = 6 for MSDOS 6.22 COMMAND.COM)
 17828                                  	; ((N,E,D,S,G for MSDOS 5.0 and N,E,D,S,G,C for MSDOS 6.22)) 
 17829                                  	;mov	cx,6 ; 08/06/2023
 17830 00001857 B90600                  	mov	cx,NUM_ORDER_LTRS ; 5	; CX = length of list
 17831 0000185A F2AE                    	repne	scasb			; look for our letter in the list
 17832 0000185C 7510                    	jne	short poErr		; not found, return error
 17833                                  
 17834 0000185E F7D9                    	neg	cx
 17835                                  	;add	cx,6 ; 08/06/2023
 17836 00001860 83C106                  	add	cx,NUM_ORDER_LTRS ; 5	; CL = sort order code, 1-6
 17837                                  
 17838 00001863 08D1                    	or	cl,dl			; CL = sort code with up/dn bit
 17839 00001865 880F                    	mov	[bx],cl			; store sort order code in buffer
 17840 00001867 43                      	inc	bx			; BX = ptr to next spot in buffer
 17841                                  	;cmp	bx,offset TRANGROUP:EndDestBuf
 17842 00001868 81FB[749E]              	cmp	bx,EndDestBuf
 17843                                  	;jae	short poErr		; too many letters
 17844                                  	;
 17845                                  	;jmp	short poLtr		; go look at next char
 17846                                  	; 19/02/2023
 17847 0000186C 72D8                    	jb	short poLtr
 17848                                  
 17849                                  ;	The sort order string is invalid.  
 17850                                  
 17851                                  poErr:
 17852 0000186E 5B                      	pop	bx			; BX = ptr to result buffer
 17853 0000186F E82C04                  	call	SetupParamError		; set message up for Std_EPrintf
 17854 00001872 F9                      	stc				; return failure
 17855 00001873 EB04                    	jmp	short poRet
 17856                                  poOk:	
 17857 00001875 C60700                  	mov	byte [bx],0		; mark end of sort code list
 17858 00001878 5B                      	pop	bx			; BX = ptr to result buffer
 17859                                  	; 19/02/2023
 17860                                  	;cf=0
 17861                                  	;clc				; return success
 17862                                  poRet:
 17863 00001879 5E                      	pop	si			; restore SI
 17864 0000187A C3                      	retn
 17865                                  
 17866                                  ; ---------------------------------------------------------------------------
 17867                                  ; MSDOS 6.0
 17868                                  	; 08/06/2023
 17869                                  
 17870                                  ; 31/07/2024 - Retro DOS 5.0 - PCDOS 7.1 COMMAND.COM
 17871                                  %if 0
 17872                                  
 17873                                  ;ifdef DBLSPACE_HOOKS
 17874                                  
 17875                                  ;***	ParseRatio - parse and record /C[H] option
 17876                                  ;
 17877                                  ;	ENTRY	BX = ptr to system parser result buffer for /C occurence
 17878                                  ;		DI = index into word list of switches
 17879                                  ;
 17880                                  ;	EXIT	CY = set if error occurs parsing order
 17881                                  ;
 17882                                  ;		For parse error, we set up for Std_EPrintf call:
 17883                                  ;		AX = parse error code, like system parser
 17884                                  ;		DX = ptr to message block
 17885                                  ;
 17886                                  ;	USED	AX,CX,DX,DI
 17887                                  ;
 17888                                  ;	EFFECTS
 17889                                  ;
 17890                                  ;	  Bits modified to indicate option state.
 17891                                  ;	  fUseHostSize is set to zero for /C, non-zero for /CH.
 17892                                  ;
 17893                                  ;	  For parse error, we set up for Std_EPrintf call:
 17894                                  ;	  Msg_Disp_Class = parse error message class
 17895                                  ;	  Message block (see DX) is set up for parse error message
 17896                                  
 17897                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17898                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:184Ch
 17899                                  
 17900                                  ParseRatio:	;proc
 17901                                  	call	OnOffSw			; turn on option bit
 17902                                  	push	si			; save SI
 17903                                  	;;mov	si,word ptr [bx].ValuePtr
 17904                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 17905                                  	mov	si,[bx+4]		; SI = ptr to possible H option
 17906                                  	mov	al,[si] 		; AL = null or 'H'
 17907                                  	or	al,al
 17908                                  	jz	short prDone		; if null, no H option to check
 17909                                  	cmp	al,'H' 			; only H is allowed, make sure that's
 17910                                  	je	short prDone		;   what it is
 17911                                  	call	SetupParamError		; set message up for Std_EPrintf
 17912                                  	stc				; return failure
 17913                                  	jmp	short prRet
 17914                                  prDone:
 17915                                  	mov	[fUseHostSize],al	; set Host cluster size flag
 17916                                  	; 08/06/2023
 17917                                  	;clc
 17918                                  	;;cf = 0
 17919                                  prRet:	
 17920                                  	pop	si
 17921                                  	retn
 17922                                  
 17923                                  ;ParseRatio	;endp
 17924                                  ;endif
 17925                                  
 17926                                  %endif
 17927                                  
 17928                                  ; ---------------------------------------------------------------------------
 17929                                  
 17930                                  ;***	ParseSwitch - parse a switch
 17931                                  ;
 17932                                  ;	ENTRY	BX = ptr to parse result buffer after system parser processed
 17933                                  ;		     a switch
 17934                                  ;
 17935                                  ;	EXIT	CY = set if parse error occurred
 17936                                  ;
 17937                                  ;		If parse error occurred, we're set up for Std_EPrintf call:
 17938                                  ;		AX = parse error code, like system parser
 17939                                  ;		DX = ptr to message block
 17940                                  ;
 17941                                  ;	USED	AX,BX,DX
 17942                                  ;
 17943                                  ;	EFFECTS
 17944                                  ;
 17945                                  ;	  Bits may contain new option settings.
 17946                                  ;	  DestBuf may contain new series of sort codes.
 17947                                  ;	  AttrSpecified, AttrSelect may contain new attribute conditions.
 17948                                  ;
 17949                                  ;	  If parse error occurred, we're set up for Std_EPrintf call:
 17950                                  ;	  Msg_Disp_Class = parse error class
 17951                                  ;	  Byte after last parameter in text is zeroed to make ASCIIZ string
 17952                                  ;	  Message block (see DX) is set up for parse error message
 17953                                  
 17954                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17955                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:16E2h
 17956                                  
 17957                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17958                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1869h
 17959                                  ParseSwitch:
 17960 0000187B 51                      	push	cx			; save CX
 17961 0000187C 57                      	push	di			; save DI
 17962                                  
 17963                                  	;;mov	ax,[bx].SynPtr		; AX = synonym ptr
 17964                                  	;mov	ax,[bx+ResultBuffer.SynPtr]
 17965 0000187D 8B4702                  	mov	ax,[bx+2]
 17966                                  	;mov	di,offset TRANGROUP:Dir_Sw_Ptrs
 17967 00001880 BF[F096]                	mov	di,Dir_Sw_Ptrs		; ES:DI = ptr to list of synonym ptrs
 17968                                  	; 08/06/2023
 17969                                  	; (NUM_DIR_SWS = 16 for MSDOS 6.0)
 17970                                  	;mov	cx,16
 17971                                  	; 31/07/2024
 17972                                  	;mov	cx,18 ; PCDOS 7.1 COMMAND.COM
 17973 00001883 B91200                  	mov	cx,NUM_DIR_SWS ; 14	; CX = # of dir switches in list
 17974 00001886 FC                      	cld				; scan direction = upward
 17975 00001887 F2AF                    	repne	scasw			; locate synonym ptr in list
 17976                                  	;sub	di,offset TRANGROUP:Dir_Sw_Ptrs + 2
 17977 00001889 81EF[F296]              	sub	di,Dir_Sw_Ptrs+2
 17978                                  
 17979                                  ;	DI = index into word list of synonym ptrs
 17980                                  
 17981 0000188D 2EFF95[9518]            	call	word [cs:di+SwHandler]	; use same index into call table
 17982                                  
 17983 00001892 5F                      	pop	di			; restore DI
 17984 00001893 59                      	pop	cx			; restore CX
 17985                                  
 17986 00001894 C3                      	retn
 17987                                  
 17988                                  ; ---------------------------------------------------------------------------
 17989                                  
 17990                                  ;	Order in this table must correspond to order in Dir_Sw_Ptrs list.
 17991                                  ;	Simple on/off switches must occur first in both lists, and must be
 17992                                  ;	  in order of option bits in Bits, starting with bit 0.
 17993                                  
 17994                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 17995                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:16FCh
 17996                                  
 17997                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 17998                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1883h
 17999                                  SwHandler:
 18000                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 18001                                  
 18002                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18003                                  %if 0
 18004                                  		; ifdef DBLSPACE_HOOKS
 18005                                  	dw	OnOffSw 	; /-C
 18006                                  	dw	ParseRatio	; /C[H]
 18007                                  	;	; endif	
 18008                                  %endif
 18009                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18010                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1922h
 18011                                  
 18012 00001895 [A717]                  	dw	OnOffSw		; /-W
 18013 00001897 [A717]                  	dw	OnOffSw		; /W
 18014 00001899 [A717]                  	dw	OnOffSw		; /-P
 18015 0000189B [A717]                  	dw	OnOffSw		; /P
 18016 0000189D [A717]                  	dw	OnOffSw		; /-S
 18017 0000189F [A717]                  	dw	OnOffSw		; /S
 18018 000018A1 [A717]                  	dw	OnOffSw		; /-B
 18019 000018A3 [A717]                  	dw	OnOffSw		; /B
 18020 000018A5 [A717]                  	dw	OnOffSw		; /-L	;M010
 18021 000018A7 [A717]                  	dw	OnOffSw		; /L	;M010
 18022                                  
 18023                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18024                                  %if 1
 18025 000018A9 [A717]                    	dw	OnOffSw		; /-Z
 18026 000018AB [A717]                  	dw	OnOffSw		; /Z
 18027 000018AD [A717]                  	dw	OnOffSw		; /-4
 18028 000018AF [A717]                  	dw	OnOffSw		; /4
 18029                                  %endif
 18030 000018B1 [A017]                  	dw	NoOrder		; /-O
 18031 000018B3 [2A18]                  	dw	ParseOrder	; /O
 18032 000018B5 [ED14]                  	dw	DefaultAttr	; /-A
 18033 000018B7 [C417]                  	dw	ParseAttr	; /A
 18034                                  
 18035                                  ; ---------------------------------------------------------------------------
 18036                                  
 18037                                  	;break	<DIR utility routines>
 18038                                  
 18039                                  ;***	UTILITY ROUTINES
 18040                                  ; ---------------------- 
 18041                                  
 18042                                  ; ---------------------------------------------------------------------------
 18043                                  
 18044                                  ;***	ChangeDir - change directory on target drive
 18045                                  ;
 18046                                  ;	ENTRY	FCB contains drive #
 18047                                  ;		DS:DX = ptr to ASCIIZ string w/o drive specifier
 18048                                  ;
 18049                                  ;	EXIT	Changed current directory on drive
 18050                                  ;
 18051                                  ;		If error,
 18052                                  ;		CY = set
 18053                                  ;		DOS Get Extended Error call will get error
 18054                                  ;
 18055                                  ;	USED	AX,DX,SI,DI
 18056                                  ;
 18057                                  ;	EFFECTS
 18058                                  ;
 18059                                  ;	  DirBuf is used to build "d:string".
 18060                                  
 18061                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18062                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1718h
 18063                                  
 18064                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18065                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:18A3h
 18066                                  
 18067                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18068                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1946h
 18069                                  ChangeDir:
 18070                                  	;mov	di,offset TRANGROUP:DirBuf
 18071 000018B9 BF[9A9D]                	mov	di,DIRBUF
 18072 000018BC E8CE03                  	call	GetDriveLtr	; AX = "d:"
 18073 000018BF AB                      	stosw			; put drive specifier in buffer
 18074 000018C0 89D6                    	mov	si,dx		; SI = ptr to argument string
 18075                                  cdLoop:
 18076 000018C2 AC                      	lodsb
 18077 000018C3 AA                      	stosb			; move byte to buffer
 18078 000018C4 08C0                    	or	al,al
 18079 000018C6 75FA                    	jne	short cdLoop	; continue until null transferred
 18080                                  
 18081                                  	;mov	dx,offset TRANGROUP:DirBuf
 18082 000018C8 BA[9A9D]                	mov	dx,DIRBUF	; DX = ptr to "d:string"
 18083                                  	;mov	ah,CHDir
 18084 000018CB B43B                    	mov	ah,3Bh
 18085 000018CD CD21                    	int	21h		; change directory
 18086 000018CF C3                      	retn			; return what CHDIR returns
 18087                                  
 18088                                  ; ---------------------------------------------------------------------------
 18089                                  
 18090                                  ;***	CmpAscz - compare two ASCIIZ strings alphanumerically
 18091                                  ;
 18092                                  ;	ENTRY	DS:SI = ptr to one ASCIIZ string
 18093                                  ;		ES:DI = ptr to another ASCIIZ string
 18094                                  ;
 18095                                  ;	EXIT	flags set after REPE CMPSB
 18096                                  ;
 18097                                  ;	USED	AL,CX,SI,DI
 18098                                  ;
 18099                                  ;	NOTES
 18100                                  ;
 18101                                  ;	Maximum run of comparison is length of DS:SI string.
 18102                                  ;	This ensures that two identical strings followed by
 18103                                  ;	random characters will compare correctly.
 18104                                  
 18105                                  	; 19/02/2023
 18106                                  CmpAscz:
 18107                                  	; 07/06/2023
 18108 000018D0 56                      	push	si ; *
 18109                                  	;
 18110 000018D1 57                      	push	di
 18111                                  
 18112 000018D2 89F7                    	mov	di,si
 18113 000018D4 30C0                    	xor	al,al
 18114 000018D6 B9FFFF                  	mov	cx,0FFFFh
 18115 000018D9 F2AE                    	repne	scasb
 18116 000018DB F7D1                    	not	cx
 18117                                  
 18118 000018DD 5F                      	pop	di
 18119 000018DE F3A6                    	repe	cmpsb
 18120                                  
 18121                                  	; 07/06/2023
 18122 000018E0 5E                      	pop	si ; *
 18123                                  	;
 18124 000018E1 C3                      	retn
 18125                                  
 18126                                  ; ---------------------------------------------------------------------------
 18127                                  
 18128                                  ;***	CopyPathname - copy pathname to our buffer
 18129                                  ;
 18130                                  ;	ENTRY	BX = ptr to parse result buffer after system parser processed
 18131                                  ;		     a filespec
 18132                                  ;
 18133                                  ;	EXIT	nothing
 18134                                  ;
 18135                                  ;	USED	AX
 18136                                  ;
 18137                                  ;	EFFECTS
 18138                                  ;
 18139                                  ;	  SrcBuf may contain a new pathname/filespec.
 18140                                  ;	  PathPos, PathCnt updated for new pathname.
 18141                                  
 18142                                  	; 19/02/2023
 18143                                  CopyPathname:
 18144 000018E2 56                      	push	si
 18145                                  	;;lds	si,dword ptr [bx].ValuePtr  ; load far ptr from result buffer
 18146                                  	;lds	si,[bx+ResultBuffer.ValuePtr]
 18147 000018E3 C57704                  	lds	si,[bx+4]
 18148                                  	;invoke	Move_To_SrcBuf		    ; copy pathname to SrcBuf
 18149 000018E6 E8ED17                  	call	Move_To_SrcBuf
 18150 000018E9 5E                      	pop	si
 18151 000018EA C3                      	retn
 18152                                  
 18153                                  ; ---------------------------------------------------------------------------
 18154                                  
 18155                                  ;***	CountFile - update counters with current file
 18156                                  ;
 18157                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18158                                  ;
 18159                                  ;	EXIT	nothing
 18160                                  ;
 18161                                  ;	USED	AX,DX
 18162                                  ;
 18163                                  ;	EFFECTS
 18164                                  ;
 18165                                  ;	  FileCnt, FileCntTotal, FileSiz, FileSizTotal are updated.
 18166                                  
 18167                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18168                                  	; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 18169                                  CountFile:
 18170 000018EB 06                      	push	es			; save TRANGROUP seg addr
 18171 000018EC 8E06[559C]              	mov	es,[TPA]		; ES = TPA seg addr
 18172                                  
 18173 000018F0 FF06[819C]              	inc	word [FileCnt]		; # files this directory
 18174 000018F4 FF06[BF9C]              	inc	word [FileCntTotal]	; # files total
 18175 000018F8 7504                    	jnz	short cntf1
 18176 000018FA FF06[C19C]              	inc	word [FileCntTotal+2]
 18177                                  cntf1:
 18178                                  	;mov	ax,word ptr es:[bx].filesize
 18179                                  					; AX = low word of file size
 18180                                  	;mov	dx,word ptr es:[bx].filesize+2
 18181                                  					; DX = high word of file size
 18182 000018FE 268B4711                	mov	ax,[es:bx+17] ; [es:bx+EntryStruc.filesize]
 18183 00001902 268B5713                	mov	dx,[es:bx+19] ; [es:bx+EntryStruc.filesize+2]
 18184 00001906 0106[839C]              	add	[FileSiz],ax
 18185 0000190A 1116[859C]              	adc	[FileSiz+2],dx		; size of this directory
 18186                                  
 18187                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18188                                  %if 1
 18189 0000190E 8316[879C]00            	adc	word [FileSiz+4],0
 18190                                  %endif
 18191 00001913 0106[C39C]              	add	[FileSizTotal],ax
 18192 00001917 1116[C59C]              	adc	[FileSizTotal+2],dx	; total size of files listed
 18193                                  
 18194                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM
 18195                                  %if 1
 18196 0000191B 8316[C79C]00            	adc	word [FileSizTotal+4],0
 18197                                  %endif
 18198 00001920 07                      	pop	es			; ES = TRANGROUP seg addr again
 18199                                  dbRet:	; 19/02/2023
 18200 00001921 C3                      	retn
 18201                                  
 18202                                  ; ---------------------------------------------------------------------------
 18203                                  
 18204                                  ;***	DisplayBare - display filename in bare format
 18205                                  ;
 18206                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18207                                  ;
 18208                                  ;	EXIT	DX = # char's displayed, including dot
 18209                                  ;
 18210                                  ;	USED	AX,CX,SI,DI
 18211                                  ;
 18212                                  ;	EFFECTS
 18213                                  ;
 18214                                  ;	  Filename is displayed in name.ext format, followed by cr/lf.
 18215                                  ;	  If /s is on, complete pathname is displayed.
 18216                                  ;
 18217                                  ;	NOTE
 18218                                  ;
 18219                                  ;	  Directory pseudofiles . and .. and suppressed in bare listing.
 18220                                  
 18221                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18222                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1775h
 18223                                  
 18224                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18225                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1900h
 18226                                  
 18227                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18228                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:19ADh
 18229                                  
 18230                                  DisplayBare:
 18231                                  ;	Suppress . and .. files from bare listing.
 18232                                  
 18233 00001922 8CD9                    	mov	cx,ds			; CX = saved TRANGROUP seg addr
 18234 00001924 8E1E[559C]              	mov	ds,[TPA]		; DS:BX = ptr to file entry
 18235                                  	;assume	ds:NOTHING
 18236                                  	;cmp	ds:[bx].filename,'.'	; check 1st char of filename
 18237 00001928 807F012E                	cmp	byte [bx+1],'.' ; [bx+EntrStruc.filename]
 18238 0000192C 8ED9                    	mov	ds,cx			; DS = TRANGROUP seg addr again
 18239                                  	;assume	ds:TRANGROUP
 18240 0000192E 74F1                    	je	short dbRet		; it's . or .. - don't display
 18241                                  
 18242                                  	;;;test	Bits,mask subd
 18243                                  	;;test	word [_Bits],4
 18244                                  	;test	byte [_Bits],4
 18245                                  	; 08/06/2023
 18246 00001930 F606[EC9D]04            	test	byte [_Bits],mask.subd	; 8 ; MSDOS 6.0
 18247                                  			; 01/08/2024    ; 4 ; PCDOS 7.1	
 18248 00001935 743C                    	jz	short dbNameExt		; not /s - display filename only
 18249                                  
 18250                                  	;invoke	Build_Dir_String
 18251 00001937 E8C108                  	call	build_dir_string
 18252                                  	;mov	di,offset TRANGROUP:BwdBuf
 18253 0000193A BF[9A9D]                	mov	di,BWDBUF		; ES:DI = ptr to dir string
 18254                                     
 18255                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18256                                  	;;test	word [_Bits],10h
 18257                                  	;test	byte [_Bits],10h
 18258                                  	; 08/06/2023
 18259 0000193D F606[EC9D]10            	test	byte [_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18260                                  			; 01/08/2024	; 10h ; PCDOS 7.1
 18261                                  	;jz	@F			;M010;lowercase not needed
 18262 00001942 7405                    	jz	short dbare1
 18263 00001944 89FE                    	mov	si,di			;M010;DS:SI --> ASCIIZ string in BwdBuf	
 18264 00001946 E89603                  	call	LowercaseString		;M010;path string is in BwdBuf
 18265                                  dbare1:
 18266                                  ;@@:	
 18267                                  	;xor	al,al			; AL = 0
 18268                                  	; 19/02/2023
 18269 00001949 31C0                    	xor	ax,ax
 18270 0000194B B9FFFF                  	mov	cx,0FFFFh
 18271 0000194E FC                      	cld
 18272 0000194F F2AE                    	repne	scasb			; ES:DI = ptr to byte after null
 18273 00001951 4F                      	dec	di			; ES:DI = ptr to null byte
 18274                                  
 18275                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18276                                  %if 1 ; *!
 18277                                  ;ifdef DBCS
 18278 00001952 56                      	push	si ; *!
 18279 00001953 57                      	push	di
 18280                                  	;mov	si,offset TRANGROUP:BwdBuf
 18281 00001954 BE[9A9D]                	mov	si,BWDBUF
 18282 00001957 4F                      	dec	di
 18283 00001958 E8C711                  	call	CheckDBCSTailByte
 18284 0000195B 5F                      	pop	di
 18285                                  	; 01/08/2024
 18286                                  	;pop	si ; *!
 18287 0000195C 7407                    	jz	short dbTailByte	; if last char is double byte
 18288                                  ;endif
 18289                                  %endif
 18290 0000195E 26807DFF5C              	cmp	byte [es:di-1],'\'
 18291                                  	;je	@F
 18292 00001963 7403                    	je	short dbare2		; already terminated w/ '\'
 18293                                  
 18294                                  dbTailByte:	; 01/08/2024
 18295                                  	;mov	ax,'\'			; AX = '\',0
 18296 00001965 B05C                    	mov	al,'\'
 18297 00001967 AB                      	stosw				; add to dir string
 18298                                  ;@@:
 18299                                  dbare2:
 18300                                  	;;mov	String_Ptr_2,offset TRANGROUP:BwdBuf
 18301                                  	;mov	word [string_ptr_2],BWDBUF ; *!
 18302                                  	; 01/08/2024
 18303 00001968 8936[019E]              	mov	[string_ptr_2],si ; BWDBUF ; *!
 18304 0000196C 5E                      	pop	si ; *!
 18305                                  	;mov	dx,offset TRANGROUP:String_Buf_Ptr
 18306 0000196D BA[D391]                	mov	dx,string_buf_ptr
 18307                                  	;invoke	Std_Printf		; display device & directory path
 18308 00001970 E8AA3A                  	call	std_printf
 18309                                  dbNameExt:
 18310 00001973 E82D00                  	call	DisplayDotForm		; display name.ext
 18311                                  	;invoke	CrLf2			; display cr/lf
 18312 00001976 E8FE0F                  	call	CRLF2
 18313                                  	; 19/02/2023
 18314                                  	;call	UseLine			;M007;Allow /p with /b
 18315                                  ;dbRet:
 18316                                  	;retn
 18317                                  
 18318                                  	; 19/02/2023
 18319                                  	;jmp	short UseLine
 18320                                  
 18321                                  ; ---------------------------------------------------------------------------
 18322                                  
 18323                                  ;***	UseLine - use a display line, start a new page if none left
 18324                                  ;
 18325                                  ;	ENTRY	nothing
 18326                                  ;
 18327                                  ;	EXIT	nothing
 18328                                  ;
 18329                                  ;	USED	flags
 18330                                  
 18331                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18332                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A04h
 18333                                  
 18334                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18335                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D58h
 18336                                  UseLine:
 18337 00001979 FF0E[7F9C]              	dec	word [LeftOnPage]
 18338 0000197D 833E[7F9C]02            	cmp	word [LeftOnPage],2
 18339 00001982 771E                    	ja	short ulRet
 18340                                  	; 19/02/2023
 18341                                  	;call	EndPage
 18342                                  ;ulRet:
 18343                                  	;retn
 18344                                  
 18345                                  	; 19/02/2023
 18346                                  	;jmp	short EndPage
 18347                                  
 18348                                  ; ---------------------------------------------------------------------------
 18349                                  
 18350                                  ;***	EndPage - end the current display page
 18351                                  ;
 18352                                  ;	ENTRY	LeftOnPage = # lines left on display page
 18353                                  ;		Current directory (on selected drive) is the one being listed
 18354                                  ;		Bits contains /p setting
 18355                                  ;
 18356                                  ;	EXIT	LeftOnPage = # lines left for next page
 18357                                  ;
 18358                                  ;	USED	AX,DX
 18359                                  ;
 18360                                  ;	EFFECTS
 18361                                  ;
 18362                                  ;	  Pause is invoked to display a message and wait for a keystroke.
 18363                                  ;	  BwdBuf (same as DirBuf) used to build directory string.
 18364                                  
 18365                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18366                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19B8h
 18367                                  
 18368                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18369                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1BADh
 18370                                  
 18371                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18372                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D0Ch
 18373                                  EndPage:
 18374                                  	;;;test	Bits,mask pagd
 18375                                  	;;test	word [_Bits],2
 18376                                  	;test	byte [_Bits],2
 18377                                  	; 08/06/2023
 18378 00001984 F606[EC9D]02            	test	byte [_Bits],mask.pagd ; 4 ; MSDOS 6.0
 18379                                  			; 01/08/2024   ; 2 ; PCDOS 7.1	
 18380 00001989 7410                    	jz	short epNew		; paged display isn't enabled
 18381                                  
 18382 0000198B 53                      	push	bx			; save BX
 18383 0000198C 51                      	push	cx			; save CX
 18384                                  
 18385                                  	;invoke	Pause			; "Press any key to continue..."
 18386 0000198D E86E03                  	call	PAUSE
 18387                                  
 18388                                  	;invoke	Build_Dir_String
 18389 00001990 E86808                  	call	build_dir_string
 18390                                  	;mov	dx,offset TRANGROUP:DirCont_Ptr
 18391 00001993 BA[8F92]                	mov	dx,dircont_ptr
 18392                                  	;invoke	Printf_Crlf		; "(continuing <dir>)", cr/lf
 18393 00001996 E8763A                  	call	Printf_Crlf
 18394                                  
 18395 00001999 59                      	pop	cx			; restore CX
 18396 0000199A 5B                      	pop	bx			; restore BX
 18397                                  epNew:	
 18398 0000199B A1[769F]                	mov	ax,[LinPerPag]		; AX = # lines per page
 18399 0000199E 48                      	dec	ax			; AX = # lines till next EndPage
 18400 0000199F A3[7F9C]                	mov	[LeftOnPage],ax		; LeftOnPage = countdown variable
 18401                                  ulRet:	
 18402                                  	; 19/02/2023
 18403 000019A2 C3                      	retn
 18404                                  
 18405                                  ; ---------------------------------------------------------------------------
 18406                                  
 18407                                  ;***	DisplayDotForm - display filename in compressed dot format
 18408                                  ;
 18409                                  ;	Display name.ext, with no cr/lf's. Dot is displayed only
 18410                                  ;	if the filename has a nonblank extension.
 18411                                  ;
 18412                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18413                                  ;
 18414                                  ;	EXIT	DX = # char's displayed, including dot
 18415                                  ;
 18416                                  ;	USED	AX,CX,SI,DI
 18417                                  ;
 18418                                  ;	EFFECTS
 18419                                  ;
 18420                                  ;	  Filename is displayed in name.ext format.
 18421                                  ;
 18422                                  ;	NOTE
 18423                                  ;
 18424                                  ;	  We allow for bogus filenames that have blanks embedded
 18425                                  ;	  in the name or extension.
 18426                                  
 18427                                  ;	Bugbug:	might be a good performance gain if we buffered
 18428                                  ;	up the output and used DOS function 9.
 18429                                  
 18430                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18431                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:17C8h
 18432                                  
 18433                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18434                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1953h
 18435                                  
 18436                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18437                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1A0Dh
 18438                                  DisplayDotForm:
 18439 000019A3 1E                      	push	ds			; save TRANGROUP seg addr
 18440 000019A4 06                      	push	es			; save ES
 18441 000019A5 2EA1[559C]              	mov	ax,[cs:TPA]		; AX = TPA seg addr
 18442 000019A9 8ED8                    	mov	ds,ax			; DS:BX = ptr to entry
 18443                                  	;assume	ds:nothing
 18444 000019AB 8EC0                    	mov	es,ax			; ES:BX = ptr to entry
 18445                                  
 18446                                  	; 08/06/2023
 18447                                  	;mov	di,bx			; ES:DI = ptr to entry
 18448                                  	;;;add	di,filename + size filename - 1
 18449                                  	;add	di,8 ; 1+8-1		; ES:DI = ptr to last char in name field
 18450                                  	;;mov	cx,size filename	; CX = length of name field
 18451                                  	;mov	cx,8
 18452                                  	; 08/06/2023
 18453 000019AD B90800                  	mov	cx,8
 18454 000019B0 89CF                    	mov	di,cx
 18455 000019B2 01DF                    	add	di,bx	
 18456                                  
 18457 000019B4 B020                    	mov	al,' '
 18458 000019B6 FD                      	std				; scan down
 18459 000019B7 F3AE                    	repe	scasb			; scan for nonblank
 18460                                  
 18461                                  ;	Assume file name has at least one character.
 18462                                  
 18463 000019B9 41                      	inc	cx			; CX = # chars in name
 18464 000019BA 89CA                    	mov	dx,cx			; DX = # chars to be displayed
 18465                                  
 18466 000019BC 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18467                                  	;;add	si,filename		; DS:SI = ptr to name
 18468                                  	;add	si,1 
 18469                                  	;		; add si,EntryStruc.filename
 18470                                  	; 25/04/2023
 18471 000019BE 46                      	inc	si
 18472                                  NextNameChar:
 18473 000019BF FC                      	cld
 18474 000019C0 AC                      	lodsb				; AL = next char
 18475                                  
 18476                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18477                                  %if 1
 18478                                  ;ifdef DBCS
 18479                                  	;invoke	testkanj
 18480                                  	;jz	@f			; if this is not lead byte
 18481 000019C1 E89B0D                  	call	testkanj
 18482 000019C4 7409                    	jz	short ddf3
 18483                                  	;invoke	Print_Char		; display lead byte
 18484 000019C6 E8E307                  	call    PRINT_CHAR
 18485 000019C9 49                      	dec	cx
 18486 000019CA 7413                    	jz	short ExtChar		; if this is end
 18487 000019CC AC                      	lodsb				; get tail byte
 18488                                  	;jmp	short NameChar10	; display tail byte
 18489 000019CD EB0B                    	jmp	short ddf1
 18490                                  ;@@:
 18491                                  ddf3:
 18492                                  ;endif
 18493                                  %endif
 18494                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18495                                  	;;test	word [ss:_Bits],10h
 18496                                  	;test	byte [ss:_Bits],10h
 18497                                  	; 08/06/2023
 18498 000019CF 36F606[EC9D]10          	test	byte [ss:_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18499                                  			; 01/08/2024	   ; 10h ; PCDOS 7.1
 18500                                  	;jz	short @F		;M010;lowercase not required
 18501 000019D5 7403                    	jz	short ddf1
 18502 000019D7 E8FA02                  	call	LowerCase		;M010;filename char is in AL
 18503                                  
 18504                                  ;NameChar10:
 18505                                  ddf1:
 18506                                  ;@@:	
 18507                                  	;invoke	Print_Char		; display it
 18508 000019DA E8CF07                  	call	PRINT_CHAR
 18509 000019DD E2E0                    	loop	NextNameChar
 18510                                  
 18511                                  ExtChar:	; 01/08/2024
 18512                                  
 18513                                  ;	Now do extension.
 18514                                  
 18515 000019DF 89DF                    	mov	di,bx			; ES:DI = ptr to entry
 18516                                  	;add	di,fileext + size fileext - 1
 18517 000019E1 83C70B                  	add	di,11 ; 9+3-1		; ES:DI = ptr to last char in ext field
 18518                                  	;mov	cx,size fileext		; CX = length of ext field
 18519 000019E4 B90300                  	mov	cx,3
 18520 000019E7 B020                    	mov	al,' '
 18521 000019E9 FD                      	std				; scan down
 18522 000019EA F3AE                    	repe	scasb			; scan for nonblank
 18523 000019EC 742E                    	je	short ddDone		; no nonblank chars in ext
 18524                                  
 18525 000019EE 41                      	inc	cx			; CX = # chars in ext
 18526 000019EF 01CA                    	add	dx,cx			; DX = total # chars to be displayed
 18527 000019F1 42                      	inc	dx			;      including dot
 18528                                  
 18529 000019F2 B02E                    	mov	al,'.'
 18530 000019F4 E8B507                  	call	PRINT_CHAR
 18531 000019F7 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18532                                  	;add	si,fileext		; DS:SI = ptr to ext
 18533 000019F9 83C609                  	add	si,9
 18534                                  
 18535                                  NextExtChar:
 18536 000019FC FC                      	cld
 18537 000019FD AC                      	lodsb				; AL = next char
 18538                                  
 18539                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18540                                  %if 1
 18541                                  ;ifdef DBCS
 18542                                  	;invoke	testkanj
 18543                                  	;jz	@f			; if this is not lead byte
 18544 000019FE E85E0D                  	call	testkanj
 18545 00001A01 7409                    	jz	short ddf4
 18546                                  	;invoke	Print_Char		; display lead byte
 18547 00001A03 E8A607                  	call    PRINT_CHAR
 18548 00001A06 49                      	dec	cx
 18549 00001A07 7413                    	jz	short ddDone		; if this is end
 18550 00001A09 AC                      	lodsb				; get tail byte
 18551                                  	;jmp	short ExtChar10		; display tail byte
 18552 00001A0A EB0B                    	jmp	short ddf2
 18553                                  ;@@:
 18554                                  ddf4:
 18555                                  ;endif
 18556                                  %endif
 18557                                  	;;;test	CS:Bits,mask lcase	;M010;check for lowercase option
 18558                                  	;;test	word [cs:_Bits],10h
 18559                                  	;test	byte [cs:_Bits],10h
 18560                                  	; 08/06/2023
 18561 00001A0C 2EF606[EC9D]10          	test	byte [cs:_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18562                                  			; 01/08/2024	   ; 10h ; PCDOS 7.1
 18563                                  	;jz	short @F		;M010;lowercase not required
 18564 00001A12 7403                    	jz	short ddf2
 18565 00001A14 E8BD02                  	call	LowerCase		;M010;fileext char is in AL
 18566                                  ;@@:	
 18567                                  ddf2:
 18568                                  	;invoke	Print_Char		; display it
 18569 00001A17 E89207                  	call	PRINT_CHAR
 18570 00001A1A E2E0                    	loop	NextExtChar
 18571                                  ddDone:
 18572 00001A1C 07                      	pop	es			; restore ES
 18573 00001A1D 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 18574                                  	;assume	ds:TRANGROUP
 18575 00001A1E FC                      	cld				; leave direction flag = up
 18576 00001A1F C3                      	retn
 18577                                  
 18578                                  ; ---------------------------------------------------------------------------
 18579                                  
 18580                                  ;***	DisplayFile - display file entry, update counters
 18581                                  ;
 18582                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18583                                  ;		Bits contains /w, /p settings
 18584                                  ;
 18585                                  ;	EXIT	nothing
 18586                                  ;
 18587                                  ;	USED	AX,CX,DX,SI,DI,BP
 18588                                  ;
 18589                                  ;	EFFECTS
 18590                                  ;
 18591                                  ;	  Entry is displayed.  
 18592                                  ;	  If not /b,
 18593                                  ;	    Cursor is left at end of entry on screen.
 18594                                  ;	    FileCnt, FileCntTotal, FileSiz, FileSizTotal are updated.
 18595                                  ;	  If /b,
 18596                                  ;	    Cursor is left at beginning of next line.
 18597                                  ;	    Cnt's and Siz's aren't updated.
 18598                                  
 18599                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18600                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:182Eh
 18601                                  	
 18602                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18603                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:19B9h
 18604                                  
 18605                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18606                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1A8Fh
 18607                                  
 18608                                  DisplayFile:
 18609                                  	;;;test	Bits,mask bare
 18610                                  	;;test	word [_Bits],8
 18611                                  	;test	byte [_Bits],8
 18612                                  	; 08/06/2023
 18613 00001A20 F606[EC9D]08            	test	byte [_Bits],mask.bare ; 16 ; MSDOS 6.0
 18614                                  			; 01/08/2024	; 8 ; PCDOS 7.1
 18615 00001A25 7405                    	jz	short dfNorm		; not /b - do normal display
 18616                                  
 18617 00001A27 E8F8FE                  	call	DisplayBare		; display file in bare format
 18618 00001A2A EB18                    	jmp	short dfRet
 18619                                  dfNorm:	
 18620 00001A2C E87800                  	call	DisplayNext		; pos'n cursor for next entry
 18621                                  	;;;test	Bits,mask wide
 18622                                  	;;test	word [_Bits],1
 18623                                  	;test	byte [_Bits],1
 18624                                  	; 08/06/2023
 18625 00001A2F F606[EC9D]01            	test	byte [_Bits],mask.wide ; 2 ; MSDOS 6.0
 18626                                  			; 01/08/2024   ; 1 ; PCDOS 7.1
 18627 00001A34 7405                    	jz	short dfFull		; full format
 18628 00001A36 E82802                  	call	DisplayWide		; wide format
 18629 00001A39 EB06                    	jmp	short dfCnt
 18630                                  dfFull:	
 18631 00001A3B E83400                  	call	DisplayName		; display filename & extension
 18632 00001A3E E88D00                  	call	DisplayTheRest		; display size, date, time
 18633                                  
 18634                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18635                                  %if 0	
 18636                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 18637                                  	; MSDOS 6.0
 18638                                  ;ifdef DBLSPACE_HOOKS
 18639                                  	;;test	Bits,mask cratio
 18640                                  	;test	word [_Bits],1
 18641                                  	test	byte [_Bits],mask.cratio
 18642                                  					; display compression ratio
 18643                                  	jz	short dfCnt
 18644                                  	call	DisplayCompRatio
 18645                                  ;endif
 18646                                  %endif
 18647                                  
 18648                                  dfCnt:
 18649 00001A41 E8A7FE                  	call	CountFile		; update file counters
 18650                                  dfRet:
 18651                                  dhRet:	; 19/02/2023
 18652 00001A44 C3                      	retn
 18653                                  
 18654                                  ; ---------------------------------------------------------------------------
 18655                                  
 18656                                  ;***	DisplayHeader - display directory header of working directory
 18657                                  ;
 18658                                  ;	ENTRY	Current directory (on selected drive) is the one to display
 18659                                  ;		LeftOnPage = # lines left on display page
 18660                                  ;
 18661                                  ;	EXIT	nothing
 18662                                  ;
 18663                                  ;	ERROR EXIT
 18664                                  ;
 18665                                  ;	  Build_Dir_String will exit through CError with "Invalid drive
 18666                                  ;	   specification" if there's a problem obtaining the current
 18667                                  ;	   directory pathname.
 18668                                  ;
 18669                                  ;	USED	AX,DX,SI,DI
 18670                                  ;
 18671                                  ;	EFFECTS
 18672                                  ;
 18673                                  ;	  BwdBuf (which is really the same buffer as DirBuf, which
 18674                                  ;	   we are using for the DTA) contains the directory string.
 18675                                  ;	  LeftOnPage is adjusted.
 18676                                  
 18677                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18678                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18679                                  
 18680                                  DisplayHeader:
 18681                                  	;;;test	Bits,mask bare
 18682                                  	;;test	word [_Bits],8
 18683                                  	;test	byte [_Bits],8
 18684                                  	; 08/06/2023
 18685 00001A45 F606[EC9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 18686                                  			; 01/08/2024	; 8 ; PCDOS 7.1
 18687 00001A4A 75F8                    	jnz	short dhRet		; /b - don't display header
 18688                                  
 18689                                  	;;;test	Bits,mask subd
 18690                                  	;;test	word [_Bits],4
 18691                                  	;test	byte [_Bits],4
 18692                                  	; 08/06/2023
 18693 00001A4C F606[EC9D]04            	test	byte [_Bits],mask.subd ; 8 ; MSDOS 6.0
 18694                                  			; 01/08/2024   ; 4 ; PCDOS 7.1
 18695 00001A51 7408                    	jz	short dhNorm		; not /s
 18696                                  
 18697                                  ;	For subdirectory listings, put a blank line before the header.
 18698                                  
 18699                                  	;invoke	Crlf2			; start with a blank line
 18700 00001A53 E8210F                  	call	CRLF2
 18701 00001A56 E820FF                  	call	UseLine
 18702 00001A59 EB05                    	jmp	short dhCom
 18703                                  dhNorm:
 18704 00001A5B B020                    	mov	al,' ' ; 20h
 18705                                  	;mov	al,BLANK		; if not /s, precede by a blank
 18706 00001A5D E84C07                  	call	PRINT_CHAR		; print a leading blank
 18707                                  dhCom:
 18708 00001A60 E89807                  	call	build_dir_string
 18709 00001A63 BA[3791]                	mov	dx,dirhead_ptr
 18710 00001A66 E8B439                  	call	std_printf		; print header & cr/lf
 18711 00001A69 E80DFF                  	call	UseLine
 18712 00001A6C E8080F                  	call	CRLF2			; another cr/lf
 18713                                  	;call	UseLine
 18714                                  ;dhRet:
 18715                                  	;retn
 18716                                  
 18717                                  	; 19/02/2023
 18718 00001A6F E907FF                  	jmp	UseLine
 18719                                  
 18720                                  ; ---------------------------------------------------------------------------
 18721                                  
 18722                                  ;***	DisplayName - display file name & extension
 18723                                  ;
 18724                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18725                                  ;
 18726                                  ;	EXIT	nothing
 18727                                  ;
 18728                                  ;	USED	AX,CX,DX,SI,DI
 18729                                  ;
 18730                                  ;	EFFECTS
 18731                                  ;
 18732                                  ;	  Filename & extension are displayed in spread format.
 18733                                  ;	  Cursor is left at end of extension.
 18734                                  
 18735                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18736                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18737                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18738                                  
 18739                                  DisplayName:
 18740 00001A72 1E                      	push	ds			; save TRANGROUP seg addr
 18741 00001A73 8E1E[559C]              	mov	ds,[TPA]		; DS:BX = ptr to entry
 18742                                  	;assume	ds:nothing
 18743 00001A77 89DE                    	mov	si,bx			; DS:SI = ptr to entry
 18744                                  	;;add	si,filename		; DS:SI = ptr to filename
 18745                                  	;add	si,1  ; EntryStruc.filename
 18746                                  	; 08/06/2023
 18747 00001A79 46                      	inc	si
 18748 00001A7A BF[CB9C]                	mov	di,CHARBUF		; ES:DI = ptr to CharBuf
 18749                                  
 18750 00001A7D B90800                  	mov	cx,8
 18751 00001A80 FC                      	cld
 18752 00001A81 F3A4                    	rep	movsb			; move filename to CharBuf
 18753 00001A83 B020                    	mov	al,' '
 18754 00001A85 AA                      	stosb				; add a blank
 18755                                  	;mov	cx,3
 18756                                  	; 08/06/2023
 18757 00001A86 B103                    	mov	cl,3
 18758 00001A88 F3A4                    	rep	movsb			; add extension
 18759 00001A8A 30C0                    	xor	al,al
 18760 00001A8C AA                      	stosb				; add a NULL
 18761                                  
 18762 00001A8D 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 18763                                  	;assume	ds:TRANGROUP
 18764                                  
 18765                                  	;;;test	Bits,mask lcase		;M010;check for lowercase option
 18766                                  	;;test	word [_Bits],10h
 18767                                  	;test	byte [_Bits],10h
 18768                                  	; 08/06/2023
 18769 00001A8E F606[EC9D]10            	test	byte [_Bits],mask.lcase ; 20h ; MSDOS 6.0
 18770                                  			; 01/08/2024	; 10h ; PCDOS 7.1
 18771 00001A93 7406                    	jz	short dn1		;M010;lowercase not required
 18772 00001A95 BE[CB9C]                	mov	si,CHARBUF		;M010;DS:SI --> ASCIIZ string
 18773 00001A98 E84402                  	call	LowercaseString		;M010;filename.ext string is in CharBuf
 18774                                  dn1:	
 18775 00001A9B C706[019E][CB9C]        	mov	word [string_ptr_2],CHARBUF
 18776 00001AA1 BA[D391]                	mov	dx,string_buf_ptr
 18777                                  	;call	std_printf		; print filename & extension
 18778                                  	;retn
 18779                                  	; 19/02/2023
 18780 00001AA4 E97639                  	jmp	std_printf
 18781                                  
 18782                                  ; ---------------------------------------------------------------------------
 18783                                  
 18784                                  ;***	DisplayNext - move display cursor to next entry position
 18785                                  ;
 18786                                  ;	ENTRY	LeftOnLine = # entries can still be printed on this line
 18787                                  ;		LeftOnPage = # lines can still be printed for this page
 18788                                  ;		FileCnt = # files in this dir displayed before this one
 18789                                  ;		Bits contains /w setting
 18790                                  ;
 18791                                  ;	EXIT	nothing
 18792                                  ;
 18793                                  ;	USED	AX,DX
 18794                                  ;
 18795                                  ;	EFFECTS
 18796                                  ;
 18797                                  ;	  LeftOnLine will be updated to reflect the entry about to be
 18798                                  ;	   displayed.
 18799                                  ;	  LeftOnPage may be updated.
 18800                                  
 18801                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18802                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18803                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18804                                  	
 18805                                  DisplayNext:
 18806 00001AA7 833E[819C]00            	cmp	word [FileCnt],0
 18807 00001AAC 7415                    	je	short dn1st		; 1st file in directory
 18808 00001AAE 803E[7B9C]00            	cmp	byte [LeftOnLine],0
 18809 00001AB3 7E08                    	jng	short dnEol	; jle	; no more room on this line
 18810                                  
 18811                                  ;	We are in wide mode (LeftOnLine is always 0 otherwise) and
 18812                                  ;	we still have room for more on this line.
 18813                                  ;	Tab to next position.
 18814                                  
 18815 00001AB5 BA[E291]                	mov	dx,tab_ptr
 18816 00001AB8 E86239                  	call	std_printf
 18817 00001ABB EB0C                    	jmp	short dnDone
 18818                                  dnEol:	
 18819                                  ;	Start this entry on a new line.
 18820                                  
 18821 00001ABD E8B70E                  	call	CRLF2		; start on new line
 18822 00001AC0 E8B6FE                  	call	UseLine
 18823                                  dn1st:
 18824 00001AC3 A0[7C9C]                	mov	al,[PerLine]
 18825 00001AC6 A2[7B9C]                	mov	[LeftOnLine],al	; reset # entries left on line
 18826                                  
 18827                                  dnDone:
 18828 00001AC9 FE0E[7B9C]              	dec	byte [LeftOnLine]
 18829                                  				; reflect the entry about to be displayed
 18830 00001ACD C3                      	retn
 18831                                  
 18832                                  ; ---------------------------------------------------------------------------
 18833                                  
 18834                                  ;***	DisplayTheRest - display file size/dir, date, time
 18835                                  ;
 18836                                  ;	ENTRY	BX = offset of entry in TPA buffer
 18837                                  ;		Display cursor is at end of file extension
 18838                                  ;
 18839                                  ;	EXIT	nothing
 18840                                  ;
 18841                                  ;	USED	AX,CX,DX,SI,DI,BP
 18842                                  ;
 18843                                  ;	EFFECTS
 18844                                  ;
 18845                                  ;	  File size, date, & time are displayed.
 18846                                  
 18847                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 18848                                  
 18849                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 18850                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1A7Ch
 18851                                  
 18852                                  	; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 18853                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1B47h
 18854                                  
 18855                                  DisplayTheRest:
 18856 00001ACE 06                      	push	es			; save TRANGROUP seg addr
 18857 00001ACF 8E06[559C]              	mov	es,[TPA]		; ES = TPA seg addr
 18858 00001AD3 89DD                    	mov	bp,bx			; BP = offset of entry in TPA
 18859                                  	;;test	es:[bp].fileattr,ATTR_DIRECTORY
 18860                                  	;test	byte [es:bp+EntryStruc.fileattr],10h
 18861 00001AD5 26F6460C10              	test	byte [es:bp+12],ATTR_DIRECTORY
 18862 00001ADA 7425                    	jz	short drNonDir		; not a directory file
 18863                                  
 18864                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18865                                  %if 1
 18866 00001ADC 803E[8C9C]00            	cmp	byte [nocommas],0	; no commas ?
 18867 00001AE1 750C                    	jnz	short dr_2		; yes
 18868 00001AE3 C706[019E][F493]        	mov	word [string_ptr_2],twospacechars ; db "  ",0
 18869 00001AE9 BA[D391]                	mov	dx,string_buf_ptr
 18870 00001AEC E82E39                  	call	std_printf
 18871                                  dr_2:
 18872                                  %endif
 18873                                  
 18874                                  ;	For a directory file, display <DIR> instead of size.
 18875                                  
 18876                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18877                                  %if 0
 18878                                  	mov	dx,dmes_ptr
 18879                                  	call	std_printf
 18880                                  	; 08/06/2023
 18881                                  	;jmp	short drCom
 18882                                  
 18883                                  	; 08/06/2023
 18884                                  	; MSDOS 6.22 COMMAND.COM (disassembled source code)
 18885                                  	test    byte [screen_f_1],40h	; 80 columns ?
 18886                                  	jz      short dr_0      	; no
 18887                                  	mov     dx,space_4_ptr		; 4 space chars
 18888                                  	call    std_printf
 18889                                  dr_0:
 18890                                  	jmp	short drCom		; skip to common fields
 18891                                  %else
 18892                                  	; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18893 00001AEF BA[E591]                	mov	dx,dmes_ptr		; MSG_1068
 18894 00001AF2 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0 ; size will be displayed as kilobyte ?
 18895 00001AF7 7403                    	jz	short dr_3		; yes
 18896 00001AF9 BA[E891]                	mov	dx,space_4_ptr		; 4 space chars
 18897                                  dr_3:
 18898 00001AFC E81E39                  	call	std_printf
 18899 00001AFF EB2A                    	jmp	short drCom	
 18900                                  %endif
 18901                                  
 18902                                  drNonDir:
 18903                                  ;	For a non-directory file, display file size.
 18904                                  
 18905                                  	;;mov	dx,word ptr es:[bp].filesize
 18906                                  	;mov	dx,[es:bp+EntryStruc.filesize]
 18907 00001B01 268B5611                	mov	dx,[es:bp+17]
 18908 00001B05 8916[FD9D]              	mov	[File_Size_Low],dx
 18909                                  	;;mov	dx,word ptr es:[bp].filesize+2
 18910                                  	;mov	dx,[es:bp+EntryStruc.filesize+2]
 18911 00001B09 268B5613                	mov	dx,[es:bp+19]
 18912 00001B0D 8916[FF9D]              	mov	[File_Size_High],dx
 18913 00001B11 BA[A991]                	mov	dx,disp_file_size_ptr
 18914                                  
 18915                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18916                                  %if 1
 18917 00001B14 803E[8B9C]00            	cmp	byte [narrow],0
 18918 00001B19 7503                    	jnz	short dr_4		; narrow display
 18919 00001B1B BA[B791]                	mov	dx,disp_file_size_w_ptr	; big file (wide)
 18920                                  dr_4:
 18921 00001B1E 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0
 18922 00001B23 7403                    	jz	short dr_5		; big file
 18923 00001B25 BA[C591]                	mov	dx,disp_file_size_n_ptr ; not big file
 18924                                  dr_5:	
 18925                                  %endif
 18926                                  
 18927 00001B28 E8F238                  	call	std_printf
 18928                                  drCom:
 18929                                  ;	For all files, display date & time.
 18930                                  
 18931                                  	;;mov	ax,es:[bp].filedate	; AX = date word
 18932                                  	;mov	ax,[es:bp+EntryStruc.filedate]
 18933 00001B2B 268B460F                	mov	ax,[es:bp+15]
 18934                                  
 18935                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18936                                  %if 0
 18937                                  	or	ax,ax			; test for null date (DOS 1.x)
 18938                                  	jz	short drDone		; no date, skip date/time display
 18939                                  %else
 18940 00001B2F 09C0                    	or	ax,ax
 18941 00001B31 7503                    	jnz	short dr_6
 18942 00001B33 E9AA00                  	jmp	drDone
 18943                                  dr_6:
 18944                                  %endif
 18945                                  
 18946 00001B36 89C3                    	mov	bx,ax			; BX = date word
 18947 00001B38 83E01F                  	and	ax,1Fh			; AX = day of month
 18948 00001B3B 88C2                    	mov	dl,al			; DL = day of month
 18949 00001B3D 89D8                    	mov	ax,bx			; AX = date word
 18950 00001B3F B105                    	mov	cl,5
 18951 00001B41 D3E8                    	shr	ax,cl			; shift day out
 18952 00001B43 240F                    	and	al,0Fh			; AL = month
 18953 00001B45 88C6                    	mov	dh,al			; DH = month
 18954 00001B47 88F9                    	mov	cl,bh
 18955 00001B49 D0E9                    	shr	cl,1			; CL = year - 1980
 18956 00001B4B 30ED                    	xor	ch,ch			; CX = year - 1980
 18957                                  
 18958                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18959                                  %if 0
 18960                                  	; MSDOS 5.0-6.22
 18961                                  	add	cx,80			; CX = 2-digit year
 18962                                  	cmp	cl,100
 18963                                  	jb	short dr_1		; not year 2000 yet, skip ahead
 18964                                  	sub	cl,100			; adjust for 21st century
 18965                                  %else
 18966                                  	; PCDOS 7.1
 18967 00001B4D 81C1BC07                	add	cx,1980			; CX = 4-digit year
 18968 00001B51 803E[8D9C]00            	cmp	byte [yeardigit4],0	; 4 digits year display ?
 18969 00001B56 7509                    	jnz	short dr_1		; yes
 18970 00001B58 81E9D007                	sub	cx,2000			; after	year 2000 (21st century)
 18971 00001B5C 7903                    	jns	short dr_1
 18972 00001B5E 83C164                  	add	cx,100			; before year 2000 (20th century)
 18973                                  %endif
 18974                                  
 18975                                  dr_1:	
 18976 00001B61 86F2                    	xchg	dh,dl			; DX = month/day
 18977 00001B63 890E[2692]              	mov	[DirDat_Yr],cx		; move year to msg block
 18978 00001B67 8916[2892]              	mov	[DirDat_Mo_Day],dx	; move month/day to msg block
 18979                                  	;;mov	cx,es:[bp].filetime	; CX = file time
 18980                                  	;mov	cx,[es:bp+EntryStruc.filetime]
 18981 00001B6B 268B4E0D                	mov	cx,[es:bp+13]
 18982 00001B6F E310                    	jcxz	drPrint			; no time field - go print
 18983 00001B71 D1E9                    	shr	cx,1
 18984 00001B73 D1E9                    	shr	cx,1
 18985 00001B75 D1E9                    	shr	cx,1			; CH = hours
 18986 00001B77 D0E9                    	shr	cl,1
 18987 00001B79 D0E9                    	shr	cl,1			; CL = minutes
 18988 00001B7B 86E9                    	xchg	ch,cl			; CX = hr/min
 18989 00001B7D 890E[3192]              	mov	[DirTim_Hr_Min],cx	; move time to msg block
 18990                                  drPrint:
 18991                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 18992                                  %if 1
 18993 00001B81 C706[2192]3504          	mov	word [dirdattim_ptr],1077 ; MSG_1077 (normal)
 18994 00001B87 C606[2B92]A4            	mov	byte [DirDat_form],0A4h   ; Right_Align+DATE_MDY_2
 18995 00001B8C C706[2C92]0A08          	mov	word [DirDat_width],80Ah  ; 10 (max), 8 (min)
 18996 00001B92 803E[8B9C]00            	cmp	byte [narrow],0
 18997 00001B97 750C                    	jnz	short dr_narrow
 18998 00001B99 C706[2192]3304          	mov	word [dirdattim_ptr],1075 ; MSG_1075 (narrow)
 18999 00001B9F 8106[2C92]0202          	add	word [DirDat_width],202h  ; 12 (max), 10 (min)
 19000                                  dr_narrow:
 19001 00001BA5 803E[8D9C]00            	cmp	byte [yeardigit4],0
 19002 00001BAA 740B                    	jz	short dr_7		 ; 2 digits year display
 19003                                  		; 4 digits year display
 19004 00001BAC C606[2B92]B4            	mov	byte [DirDat_form],0B4h  ; Right_Align+DATE_MDY_4
 19005 00001BB1 8106[2C92]0202          	add	word [DirDat_width],202h ; 12 (max), 10 (min)
 19006                                  dr_7:	
 19007                                  %endif
 19008 00001BB7 BA[2192]                	mov	dx,dirdattim_ptr
 19009 00001BBA E86038                  	call	std_printf		; print date & time
 19010                                  
 19011                                  ; 01/08/2024 - PCDOS 7.1 COMMAND.COM
 19012                                  %if 1
 19013                                  	; restore message data format fields (to the default values)
 19014 00001BBD C706[2192]3504          	mov	word [dirdattim_ptr],1077 ; MSG_1077
 19015 00001BC3 C606[2B92]A4            	mov	byte [DirDat_form],0A4h   ; Right_Align+DATE_MDY_2
 19016 00001BC8 C706[2C92]0A08          	mov	word [DirDat_width],80Ah  ; 10 (max), 8 (min)
 19017 00001BCE C706[2692]0000          	mov	word [DirDat_Yr],0
 19018 00001BD4 C706[2892]0000          	mov	word [DirDat_Mo_Day],0
 19019 00001BDA C706[3192]0000          	mov	word [DirTim_Hr_Min],0
 19020                                  %endif
 19021                                  
 19022                                  drDone:
 19023 00001BE0 07                      	pop	es			; ES = TRANGROUP seg addr again	
 19024 00001BE1 89EB                    	mov	bx,bp			; BX = offset of entry in TPA again
 19025                                  dtrRet:		; 03/08/2024
 19026                                  	; 19/02/2023
 19027 00001BE3 C3                      	retn
 19028                                  
 19029                                  ; ---------------------------------------------------------------------------
 19030                                  ; MSDOS 6.0
 19031                                  
 19032                                  ; 01/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 19033                                  %if 0
 19034                                  ;ifdef DBLSPACE_HOOKS
 19035                                  
 19036                                  ;***	DisplayCompRatio - display compression ratio
 19037                                  ;
 19038                                  ;	ENTRY	BX = offset of entry in TPA buffer
 19039                                  ;
 19040                                  ;	EXIT	nothing
 19041                                  ;
 19042                                  ;	USED	AX,CX,DX
 19043                                  ;
 19044                                  ;	EFFECTS
 19045                                  ;
 19046                                  ;	  File compression ratio is displayed.
 19047                                  
 19048                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19049                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1B09h
 19050                                  
 19051                                  DisplayCompRatio: ;proc
 19052                                  	push	es			; save TRANGROUP seg addr
 19053                                  	mov	es,[TPA]		; ES = TPA seg addr
 19054                                  	;;mov	al,es:[bx].compratio
 19055                                  	;mov	al,[es:bx+EntryStruc.compratio]
 19056                                  	mov	al,[es:bx+15h]
 19057                                  	cmp	al,0FFh			; invalid/no compression ratio?
 19058                                  	je	short dcrRet
 19059                                  
 19060                                  	mov	ah,al			; unpack compression ratio
 19061                                  	mov	cl,4
 19062                                  	shr	ah,cl			; isolate whole number portion
 19063                                  	inc	ah			; 0-15 = 1-16
 19064                                  	and	al,0Fh 			; isolate tenths
 19065                                  
 19066                                  	mov	[Dir_CRatio_1],ah
 19067                                  	mov	[Dir_CRatio_2],al
 19068                                  	;mov	dx,offset TRANGROUP:DirCompRatio_Ptr
 19069                                  	;invoke	Std_Printf
 19070                                  	mov	dx,DirCompRatio_Ptr
 19071                                  	call	std_printf	
 19072                                  dcrRet:
 19073                                  	pop	es
 19074                                  dtrRet:		; 08/06/2023
 19075                                  	retn
 19076                                  
 19077                                  ;DisplayCompRatio ;endp
 19078                                  
 19079                                  ;endif
 19080                                  %endif
 19081                                  
 19082                                  ; ---------------------------------------------------------------------------
 19083                                  
 19084                                  ;***	DisplayTrailer - display trailing lines for directory listing
 19085                                  ;
 19086                                  ;	ENTRY	LeftOnPage = # lines left on display page
 19087                                  ;		FileCnt = # files listed
 19088                                  ;		FileSiz = total size of files listed
 19089                                  ;
 19090                                  ;	EXIT	nothing
 19091                                  ;
 19092                                  ;	USED
 19093                                  ;
 19094                                  ;	EFFECTS
 19095                                  ;
 19096                                  ;	  Trailing info lines are displayed
 19097                                  
 19098                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19099                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19100                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 19101                                  
 19102                                  DisplayTrailer:
 19103                                  	;;;test	Bits,mask bare
 19104                                  	;;test	word [_Bits],8
 19105                                  	;test	byte [_Bits],8
 19106                                  	; 08/06/2023
 19107 00001BE4 F606[EC9D]08            	test	byte [_Bits],mask.bare ; 10h ; MSDOS 6.0
 19108                                  			    ; 02/08/2024 ; 8 ; PCDOS 7.1 	
 19109 00001BE9 75F8                    	jnz	short dtrRet		; /b - don't display trailer
 19110                                  
 19111 00001BEB E8890D                  	call	CRLF2			; start on new line
 19112 00001BEE E888FD                  	call	UseLine
 19113 00001BF1 A1[819C]                	mov	ax,[FileCnt]		; AX = # files found
 19114                                  
 19115                                  ;	DisplayTotals uses this entry point.
 19116                                  ;
 19117                                  DisplayCntSiz:
 19118                                  ;	AX = # files
 19119                                  ;	FileSiz = dword total size of files
 19120                                  
 19121                                  ; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 19122                                  ; PCDOS 7.1 COMMAND.COM
 19123                                  %if 0 
 19124                                  	mov	[Dir_Num],ax		; load # files
 19125                                  	mov	dx,dirmes_ptr		; DX = ptr to message block
 19126                                  	call	std_printf		; "nnn File(s)"
 19127                                  
 19128                                  	mov	dx,bytes_ptr
 19129                                  	call	std_printf		; "nnn bytes",cr,lf
 19130                                  	; 19/02/2023
 19131                                  	;call	UseLine
 19132                                  ;dtrRet:
 19133                                  	;retn
 19134                                  
 19135                                  	; 19/02/2023
 19136                                  	jmp	UseLine
 19137                                  %else
 19138                                  	; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 19139 00001BF4 A3[069E]                	mov	[Dir_Num],ax		; number of files
 19140 00001BF7 8916[089E]              	mov	[Dir_Num+2],dx
 19141 00001BFB BA[0E90]                	mov	dx,dirmes_ptr		; MSG_1019, 9 bytes, word	
 19142 00001BFE 803E[8B9C]00            	cmp	byte [narrow],0		; narrow display ?
 19143 00001C03 7503                    	jnz	short dcs_1		; yes
 19144 00001C05 BA[1C90]                	mov	dx,dirmes_w_ptr		; MSG_1019, 10 bytes
 19145                                  dcs_1:
 19146 00001C08 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0	; is kilobyte display usable?
 19147 00001C0D 7403                    	jz	short dcs_2		; yes (big files)
 19148 00001C0F BA[2A90]                	mov	dx,dirmes2_ptr		; MSG_1019, 9 bytes, dword
 19149                                  dcs_2:
 19150 00001C12 E80838                  	call	std_printf		; "nnn File(s)"
 19151 00001C15 8B0E[879C]              	mov	cx,[FileSiz+4]		; 5th and 6th byte of the file size
 19152                                  					; (6th byte=0)
 19153 00001C19 E329                    	jcxz	dcs_3			; file size is (in) 4 bytes
 19154 00001C1B 8B16[869C]              	mov	dx,[FileSiz+3]		; convert to kilobytes
 19155 00001C1F A1[849C]                	mov	ax,[FileSiz+1]
 19156 00001C22 D0CD                    	ror	ch,1			; ch = 5th byte of file size
 19157 00001C24 D1DA                    	rcr	dx,1
 19158 00001C26 D1D8                    	rcr	ax,1
 19159 00001C28 D0CD                    	ror	ch,1
 19160 00001C2A D1DA                    	rcr	dx,1
 19161 00001C2C D1D8                    	rcr	ax,1			; dx:ax = (ch:dx:ax) / 1024
 19162 00001C2E 8916[859C]              	mov	[FileSiz+2],dx
 19163 00001C32 A3[839C]                	mov	[FileSiz],ax
 19164 00001C35 BA[6792]                	mov	dx,kbytes_ptr		; MSG_1107 normal, 14 bytes
 19165 00001C38 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0 ; is kilobyte display usable?
 19166 00001C3D 741C                    	jz	short dcs_5		; yes (big files)
 19167                                  		; no (not big files)
 19168 00001C3F BA[7592]                	mov	dx,kybytes_n_ptr	; MSG_1107 narrow, 10 bytes
 19169 00001C42 EB17                    	jmp	short dcs_5
 19170                                  dcs_3:
 19171 00001C44 BA[3D92]                	mov	dx,bytes_ptr		; MSG_1079 normal, 12 bytes
 19172 00001C47 803E[8B9C]00            	cmp	byte [narrow],0		; narrow display option
 19173 00001C4C 7503                    	jnz	short dcs_4
 19174 00001C4E BA[4B92]                	mov	dx,bytes_w_tr		; MSG_1079 wide, 14 bytes
 19175                                  dcs_4:
 19176 00001C51 803E[8E9C]00            	cmp	byte [bfree_not_kilo],0
 19177 00001C56 7403                    	jz	short dcs_5
 19178 00001C58 BA[5992]                	mov	dx,bytes_n_ptr		; MSG_1079 narrow, 10 bytes
 19179                                  dcs_5:
 19180 00001C5B E8BF37                  	call	std_printf		; "nnn bytes",cr,lf
 19181                                  	;call	UseLine
 19182                                  ;dtrRet:
 19183                                  	;retn
 19184                                  	; 02/08/2024
 19185 00001C5E E918FD                  	jmp	UseLine
 19186                                  %endif
 19187                                  
 19188                                  ; ---------------------------------------------------------------------------
 19189                                  
 19190                                  ;***	DisplayWide - display filename in wide format
 19191                                  ;
 19192                                  ;	ENTRY	BX = offset of entry in TPA buffer
 19193                                  ;
 19194                                  ;	EXIT	nothing
 19195                                  ;
 19196                                  ;	USED	AX,CX,DX,SI,DI
 19197                                  ;
 19198                                  ;	EFFECTS
 19199                                  ;
 19200                                  ;	  Name.ext is displayed. Cursor left at end of field (padded
 19201                                  ;	  with blanks). Subdirectory files are displayed as [name.ext].
 19202                                  
 19203                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19204                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:198Ah
 19205                                  
 19206                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19207                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1CDEh
 19208                                  
 19209                                  DisplayWide:
 19210 00001C61 1E                      	push	ds			; save TRANGROUP seg addr
 19211 00001C62 8E1E[559C]              	mov	ds,[TPA]		; DS:BX = ptr to entry
 19212                                  	;assume	ds:nothing
 19213                                  
 19214                                  	;;test	ds:[bx].fileattr,ATTR_DIRECTORY
 19215                                  	;test	byte [bx+EntryStruc.fileattr],10h
 19216 00001C66 F6470C10                	test	byte [bx+12],ATTR_DIRECTORY
 19217 00001C6A 9C                      	pushf	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19218 00001C6B 7405                    	jz	short dw1		; not a subdirectory file
 19219 00001C6D B05B                    	mov	al,'['
 19220 00001C6F E83A05                  	call	PRINT_CHAR		; prefix subdirectory
 19221                                  dw1:	
 19222 00001C72 E82EFD                  	call	DisplayDotForm		; display name.ext
 19223                                  
 19224                                  ;	DX = # chars displayed in name.ext
 19225                                  
 19226                                  	;;test	ds:[bx].fileattr,ATTR_DIRECTORY
 19227                                  	;test	byte [bx+EntryStruc.fileattr],10h
 19228                                  	; 03/08/2024
 19229                                  	;test	byte [bx+12],ATTR_DIRECTORY
 19230 00001C75 9D                      	popf	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19231 00001C76 7405                    	jz	short dw2		; not a subdirectory file
 19232 00001C78 B05D                    	mov	al,']'
 19233 00001C7A E82F05                  	call	PRINT_CHAR		; postfix subdirectory
 19234                                  dw2:
 19235                                  ;	Pad field with blanks.
 19236                                  
 19237                                  	;mov	cx,size filename + size fileext + 1
 19238 00001C7D B90C00                  	mov	cx,12 ; 8+3+1
 19239                                  					; CX = field size
 19240 00001C80 29D1                    	sub	cx,dx			; CX = # pad char's
 19241 00001C82 E307                    	jcxz	dwDone
 19242 00001C84 B020                    	mov	al,' '
 19243                                  dw3:	
 19244 00001C86 E82305                  	call	PRINT_CHAR
 19245 00001C89 E2FB                    	loop	dw3
 19246                                  dwDone:	
 19247 00001C8B 1F                      	pop	ds			; DS = TRANGROUP seg addr again
 19248                                  	;assume	ds:TRANGROUP
 19249 00001C8C C3                      	retn
 19250                                  
 19251                                  ; ---------------------------------------------------------------------------
 19252                                  
 19253                                  ;***	GetDriveLtr - get target drive letter
 19254                                  ;
 19255                                  ;	ENTRY	FCB contains drive #
 19256                                  ;
 19257                                  ;	EXIT	AX = "d:"
 19258                                  ;
 19259                                  ;	USED	nothing
 19260                                  
 19261                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19262                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19D8h
 19263                                  GetDriveLtr:
 19264 00001C8D A05C00                  	mov	al,[FCB] ; 5Ch	; AL = target drive #
 19265 00001C90 08C0                    	or	al,al
 19266 00001C92 7505                    	jnz	short gdl1	; not current drive default, skip ahead
 19267 00001C94 A0[679C]                	mov	al,[CURDRV]	; AL = current drive #
 19268 00001C97 FEC0                    	inc	al		; AL = 1-based drive #
 19269                                  gdl1:	
 19270 00001C99 0440                    	add	al,'A'-1 ; 40h	; AL = target drive letter
 19271 00001C9B B43A                    	mov	ah,':'		; AX = "d:"
 19272 00001C9D C3                      	retn
 19273                                  
 19274                                  ; ---------------------------------------------------------------------------
 19275                                  
 19276                                  ;***	SetupParamError - set up for Std_EPrintf parameter parse error message
 19277                                  ;
 19278                                  ;	Do for our /O and /A string parsers what Parse_With_Msg does
 19279                                  ;	for system parser calls. Set up a message substitution block,
 19280                                  ;	etc. for invalid value strings. I copied the procedure from
 19281                                  ;	Setup_Parse_Error_Msg.
 19282                                  ;
 19283                                  ;	ENTRY	BX = ptr to system parser result buffer (contains ptr to str)
 19284                                  ;		
 19285                                  ;
 19286                                  ;	EXIT	AX = system parser error return code for bad param format
 19287                                  ;		DX = ptr to message description block for Std_EPrintf
 19288                                  ;
 19289                                  ;	USED	SI
 19290                                  ;
 19291                                  ;	EFFECTS
 19292                                  ;
 19293                                  ;	  Msg_Disp_Class = parse error message class
 19294                                  ;	  Message block (see DX) is set up for parse error message
 19295                                  
 19296                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19297                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:19E9h
 19298                                  SetupParamError:
 19299 00001C9E B80900                  	mov	ax,9			; parse error #
 19300 00001CA1 C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class
 19301                                  	;mov	byte [msg_disp_class],2
 19302 00001CA6 A3[CB8F]                	mov	[extend_buf_ptr],ax
 19303                                  	;mov	si,[bx+ResultBuffer.ValuePtr]
 19304 00001CA9 8B7704                  	mov	si,[bx+4]
 19305 00001CAC 8936[019E]              	mov	[string_ptr_2],si
 19306 00001CB0 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 19307                                  	;mov	byte [extend_buf_sub],1
 19308 00001CB5 BA[CB8F]                	mov	dx,extend_buf_ptr
 19309 00001CB8 C3                      	retn
 19310                                  
 19311                                  ; ---------------------------------------------------------------------------
 19312                                  
 19313                                  ;***	ZeroTotals - zero grand total file count, size
 19314                                  ;
 19315                                  ;	ENTRY	nothing
 19316                                  ;
 19317                                  ;	EXIT	nothing
 19318                                  ;
 19319                                  ;	USED	AX
 19320                                  ;
 19321                                  ;	EFFECTS
 19322                                  ;
 19323                                  ;	  FileCntTotal & FileSizTotal are zeroed.
 19324                                  ;
 19325                                  ;	NOTES
 19326                                  ;
 19327                                  ;	  FileCntTotal throuth csecUsedTotal must be together!
 19328                                  
 19329                                  ; 05/06/2023
 19330                                  ;ifdef DBLSPACE_HOOKS
 19331                                  ;csecSIZE EQU size csecUsed + size csecUsedDir + size csecUsedTotal
 19332                                  ;ccluSIZE EQU size ccluUsed + size ccluUsedDir + size ccluUsedTotal
 19333                                  ;endif
 19334                                  
 19335                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19336                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A13h
 19337                                  
 19338                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19339                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C08h
 19340                                  
 19341                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19342                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D67h
 19343                                  ZeroTotals:
 19344 00001CB9 BF[BF9C]                	mov	di,FileCntTotal
 19345                                  
 19346                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19347                                  	;;mov	cx,size FileCntTotal+size FileSizTotal
 19348                                  	;mov	cx,8
 19349                                  	;ifdef DBLSPACE_HOOKS
 19350                                  	;mov	cx,size FileCntTotal+size FileSizTotal+csecSIZE+ccluSIZE
 19351                                  	;endif
 19352                                  	;mov	cx,26
 19353                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19354 00001CBC B90C00                  	mov	cx,12
 19355                                  
 19356 00001CBF 30C0                    	xor	al,al
 19357 00001CC1 F3AA                    	rep	stosb
 19358 00001CC3 C3                      	retn	
 19359                                  
 19360                                  ; ---------------------------------------------------------------------------
 19361                                  
 19362                                  ;***	CtrlCHandler - our own control-c handler
 19363                                  ;
 19364                                  ;	Make sure user's default directory gets restored. See notes
 19365                                  ;	at InstallCtrlCHandler.
 19366                                  ;
 19367                                  ;	ENTRY	control-c
 19368                                  ;
 19369                                  ;	EXIT	to OldCtrlCHandler
 19370                                  ;
 19371                                  ;	USED	DS,flags
 19372                                  ;
 19373                                  ;	EFFECTS
 19374                                  ;
 19375                                  ;	  Restore user's default directory.
 19376                                  ;
 19377                                  ;	NOTES
 19378                                  ;
 19379                                  ;	  This handler is only installed after calling PathCrunch,
 19380                                  ;	  which sets UserDir1, so the restoration will work.
 19381                                  ;
 19382                                  ;	  The original control-c vector will be restored, whether
 19383                                  ;	  or not this one is invoked, in the HeadFix routine.
 19384                                  
 19385                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19386                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A1Eh
 19387                                  
 19388                                  	; 05/06/2023 - Retro DOS v4.2 COMMAND.COM
 19389                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C13h ; *
 19390                                  
 19391                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19392                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1D72h
 19393                                  
 19394                                  CtrlCHandler:	;proc far
 19395                                  
 19396                                  ;SR;
 19397                                  ; Save all registers used: ds, dx, ax. I know ax is being used by the 
 19398                                  ;CtrlC handler, am not sure about ds & dx. Save them to be safe
 19399                                  ;
 19400 00001CC4 1E                      	push	ds
 19401 00001CC5 0E                      	push	cs
 19402 00001CC6 1F                      	pop	ds			; DS = TRANGROUP seg addr
 19403 00001CC7 50                      	push	ax
 19404                                  
 19405                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19406                                  %if 0
 19407                                  	push	bx ; *
 19408                                  	push	dx
 19409                                  	call	CloseCVF ; * 		; close CVF file if open
 19410                                  	call	RestUDir		; restore user's default directory
 19411                                  	pop	dx
 19412                                  	pop	bx ; *
 19413                                  %else
 19414 00001CC8 52                      	push	dx
 19415 00001CC9 E8620B                  	call	RestUDir		; restore user's default directory
 19416 00001CCC 5A                      	pop	dx
 19417                                  %endif
 19418 00001CCD 58                      	pop	ax
 19419 00001CCE 1F                      	pop	ds
 19420 00001CCF 2EFF2E[23A6]            	jmp	far [cs:OldCtrlCHandler]
 19421                                  					; go to previous int 23 handler
 19422                                  
 19423                                  ; ---------------------------------------------------------------------------
 19424                                  
 19425                                  ;M010;start
 19426                                  ;***	LowerCase - convert ASCII character in AL to lowercase
 19427                                  ;
 19428                                  ;	ENTRY	AL = character to be displayed
 19429                                  ;
 19430                                  ;	EXIT	AL is lowercase
 19431                                  ;
 19432                                  ;	USED	nothing
 19433                                  
 19434                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19435                                  LowerCase:
 19436 00001CD4 3C41                    	cmp	al,'A'		; ensure AL is in range 'A'-'Z'
 19437 00001CD6 7206                    	jb	short lcRet
 19438 00001CD8 3C5A                    	cmp	al,'Z'
 19439 00001CDA 7702                    	ja	short lcRet
 19440                                  
 19441 00001CDC 0C20                    	or	al,20h		; convert to ASCII lowercase (UpperCase+32)-->LowerCase
 19442                                  lcRet:
 19443 00001CDE C3                      	retn
 19444                                  
 19445                                  ; ---------------------------------------------------------------------------
 19446                                  
 19447                                  ;***	LowercaseString - convert ASCIIZ string at DS:SI to lowercase
 19448                                  ;
 19449                                  ;	ENTRY	DS:SI points to start of ASCIIZ string
 19450                                  ;		ES = DS
 19451                                  ;
 19452                                  ;	EXIT	nothing
 19453                                  ;	
 19454                                  ;	USED	AL,SI
 19455                                  
 19456                                  	; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 19457                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 19458                                  LowercaseString:
 19459 00001CDF 57                      	push	di			; save di
 19460 00001CE0 89F7                    	mov	di,si			; ES:DI --> ASCIIZ string
 19461 00001CE2 FC                      	cld
 19462                                  NextChar: 
 19463 00001CE3 AC                      	lodsb				; get character from string into al
 19464 00001CE4 08C0                    	or	al,al			; are we at end of string?
 19465 00001CE6 7414                    	jz	short EndOfString
 19466                                  
 19467                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19468                                  %if 1
 19469                                  ;ifdef DBCS
 19470                                  	;invoke	testkanj
 19471                                  	;jz	@f			; if this is not lead byte
 19472 00001CE8 E8740A                  	call	testkanj
 19473 00001CEB 7409                    	jz	short NextChar_@
 19474 00001CED AA                      	stosb				; store lead byte
 19475 00001CEE AC                      	lodsb				; get tail byte
 19476 00001CEF 08C0                    	or	al,al
 19477 00001CF1 7409                    	jz	short EndOfString	; if end
 19478 00001CF3 AA                      	stosb				; store tail byte
 19479 00001CF4 EBED                    	jmp	short NextChar
 19480                                  ;@@:
 19481                                  NextChar_@:
 19482                                  ;endif
 19483                                  %endif
 19484 00001CF6 E8DBFF                  	call	LowerCase		; convert character to lowercase
 19485 00001CF9 AA                      	stosb				; store character back into buffer
 19486 00001CFA EBE7                    	jmp	short NextChar		; repeat until end of string
 19487                                  
 19488                                  EndOfString:
 19489 00001CFC 5F                      	pop	di			; restore di
 19490 00001CFD C3                      	retn
 19491                                  
 19492                                  ;M010;end
 19493                                  
 19494                                  ; 08/06/2023
 19495                                  ; ---------------------------------------------------------------------------
 19496                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 19497                                  ; -----------------------------------------
 19498                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 19499                                  ; ---------------------------------------------------------------------------
 19500                                  
 19501                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19502                                  %if 0
 19503                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19504                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1C44h
 19505                                  screen_f_set:
 19506                                  	; set dir display parameters depending on screen width (# of columns)
 19507                                  	push	ds
 19508                                  	mov	ax,40h
 19509                                  	mov	ds,ax
 19510                                  	cmp	word [4Ah],40	; Check ROMBIOS DATA colums per row
 19511                                  				; value (80 or 40)
 19512                                  	pop	ds
 19513                                  	jnz	short columns_80 ; 80 columns per line (video mode 3)
 19514                                  	and	byte [screen_f_1],0BFh ; ~40h
 19515                                  	mov	word [screen_f_2],0A0Ah ; 10 bytes (file size field)
 19516                                  	and	byte [screen_f_3],0BFh
 19517                                  	and	byte [screen_f_4],0BFh
 19518                                  	mov	word [screen_f_5],0A0Ah ; 10 bytes (file size field)
 19519                                  	and	byte [screen_f_6],0BFh
 19520                                  	mov	word [screen_f_7],1C1Ch ; 28 bytes (free bytes field)
 19521                                  	;jmp	short screen_f_set_retn
 19522                                  	retn
 19523                                  columns_80:
 19524                                  	or	byte [screen_f_1],40h
 19525                                  	mov	word [screen_f_2],0E0Eh ; 14 bytes (file size field)
 19526                                  	or	byte [screen_f_3],40h
 19527                                  	or	byte [screen_f_4],40h
 19528                                  	mov	word [screen_f_5],0E0Eh ; 14 bytes (file size field)
 19529                                  	or	byte [screen_f_6],40h
 19530                                  	mov	word [screen_f_7],2020h ; 32 bytes (free bytes field)
 19531                                  screen_f_set_retn:
 19532                                  	retn
 19533                                  %endif
 19534                                  
 19535                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 19536                                  %if 0
 19537                                  
 19538                                  ;============================================================================
 19539                                  ; CRATIO.ASM, MSDOS 6.0, 1992
 19540                                  ;============================================================================
 19541                                  ; 08/06/2023 - Retro DOS v4.2
 19542                                  
 19543                                  ; The code to calculate compression ratios requires access to the drive's
 19544                                  ; (DOS) FAT and MagicDrv FAT regions.  Two buffers are used (one for each
 19545                                  ; FAT type).  pbufDOSFAT and pbufMDFAT contain the offset to the buffers,
 19546                                  ; segFATBuf contains the segment (both buffers are in the same segment).
 19547                                  ; The buffers are of variable size: cFATEntries contains the size of the
 19548                                  ; buffers in terms of the number of FAT entries they can contain.
 19549                                  
 19550                                  ; ---------------------------------------------------------------------------
 19551                                  
 19552                                  ;***	OpenCVF - open Compressed Volume File for compression ratio report
 19553                                  ;
 19554                                  ;	ENTRY
 19555                                  ;		FCB setup with drive for DIR
 19556                                  ;
 19557                                  ;	EXIT	If successful, CY clear, CVF file open, fhCVF has file handle,
 19558                                  ;		szCVF has \0 terminated CVF file name, MDBPB loaded.
 19559                                  ;
 19560                                  ;		If unsuccessful, CY set
 19561                                  ;
 19562                                  ;	USED	AX, BX, CX, DX, SI, DI
 19563                                  
 19564                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 19565                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1CA1h
 19566                                  OpenCVF:
 19567                                  	mov	ax,-1
 19568                                  	mov	[fhCVF],ax		;indicate CVF not open
 19569                                  	mov	[entInBuf],ax		;  and no FAT entries in buffers
 19570                                  
 19571                                  	mov	dl,[FCB] ; mov dl,5Ch	;target drive of DIR cmd
 19572                                  	or	dl,dl			;default drive?
 19573                                  	jz	short ocvf_default
 19574                                  	dec	dl			;no, from 1=A to 0=A
 19575                                  	jmp	short ocvf_swap_info
 19576                                  
 19577                                  ocvf_default:
 19578                                  	mov	dl,[CURDRV]		;0=A, 1=B, ...
 19579                                  
 19580                                  ocvf_swap_info:
 19581                                  	mov	ax,4A11h ; multMagicDrv	;magicdrv Int 2Fh multiplex ID
 19582                                  	mov	bx,1	 ; MD_DRIVE_MAP	;get drive swap info
 19583                                  	int	2fh
 19584                                  
 19585                                  	or	ax,ax			;0 if okay
 19586                                  	jnz	short ocvf_error
 19587                                  
 19588                                  	test	bl,80h 			;80h set if compressed volume
 19589                                  	jz	short ocvf_error
 19590                                  
 19591                                  	and	bl,7Fh 			;bl = host drive, bh = seq #
 19592                                  
 19593                                  	; The CVF may have been mounted from a swapped host drive, in which
 19594                                  	; case the host drive returned in BL is the original host (now
 19595                                  	; swapped with a CVF).	Make a second drive swap info call on the
 19596                                  	; returned host to see if it must be accessed by a different drive
 19597                                  	; letter.
 19598                                  
 19599                                  	push	bx
 19600                                  	push	dx			;save dl, orig drive letter
 19601                                  
 19602                                  	mov	ax,4A11h ; mov ax,multMagicDrv
 19603                                  	mov	dl,bl
 19604                                  	mov	bx,1	 ; mov bx,MD_DRIVE_MAP
 19605                                  	int	2fh
 19606                                  
 19607                                  	pop	dx
 19608                                  	pop	cx			;bx from 1st drive swap info call
 19609                                  
 19610                                  	or	ax,ax			;0 if okay
 19611                                  	jnz	short ocvf_error
 19612                                  
 19613                                  	and	bl,7Fh
 19614                                  	xchg	bx,cx			;bx = 1st, cx = 2nd swap results
 19615                                  
 19616                                  	cmp	dl,cl			;2nd swap info call return orig drive?
 19617                                  	je	short ocvf_got_host	;yes, 1st swap info call returned host
 19618                                  
 19619                                  	mov	bl,cl			;no, use swapped host, orig seq #
 19620                                  ocvf_got_host:
 19621                                  	; Build the filename of the Compressed Volume File
 19622                                  
 19623                                  	;mov	di,offset TRANGROUP:szCVF
 19624                                  					;CVF name buffer
 19625                                  	mov	di,szCVF
 19626                                  
 19627                                  	mov	al,bl
 19628                                  	add	al,'A'
 19629                                  	mov	ah,':'
 19630                                  	cld
 19631                                  	stosw				; drive:
 19632                                  
 19633                                  	;mov	si,offset TRANGROUP:sCVFRoot
 19634                                  					; \name.
 19635                                  	mov	si,sCVFRoot	; "\DBLSPACE"
 19636                                  	;mov	cx,cbCVFRoot
 19637                                  	mov	cx,10
 19638                                  	rep	movsb
 19639                                  
 19640                                  	add	di,3			; point past extension
 19641                                  	xor	al,al
 19642                                  	std
 19643                                  	stosb				; null terminate
 19644                                  
 19645                                  	mov	al,bh			; seq #
 19646                                  	mov	bl,10
 19647                                  	;mov	cx,3			; 3 digit ext/seq #
 19648                                  	mov	cl,3
 19649                                  ;@@:
 19650                                  ocvf_1:	xor	ah,ah			; convert seq # to ascii
 19651                                  	div	bl			;   and store as CVF extension
 19652                                  	add	ah,'0'
 19653                                  	xchg	ah,al
 19654                                  	stosb
 19655                                  	mov	al,ah
 19656                                  	;loop	@b
 19657                                  	loop	ocvf_1
 19658                                  
 19659                                  	cld
 19660                                  
 19661                                  	; Now open the Compressed Volume File
 19662                                  
 19663                                  	; 08/06/2023
 19664                                  	; MSDOS 6.22 COMMAND.COM code only !
 19665                                  	;;;
 19666                                  	mov	di,szCVF ; *
 19667                                  	mov	word [di+4],5652h ; 'RV' (DRVSPACE)
 19668                                  	mov	ax,3D00h
 19669                                  	;mov	dx,szCVF
 19670                                  	mov	dx,di ; *
 19671                                  	int	21h     ; DOS - 2+ - OPEN DISK FILE WITH HANDLE
 19672                                  			; DS:DX -> ASCIZ filename
 19673                                  			; AL = access mode
 19674                                  			; 0 - read
 19675                                  	jnb     short ocvf_2
 19676                                  	mov	word [di+4],4C42h ; 'BL' (DBLSPACE)
 19677                                  	;;;
 19678                                  
 19679                                  	;mov	ax,(OPEN shl 8) or 00h 	;compatibility mode/read access
 19680                                  	mov	ax,3D00h
 19681                                  	;;mov	dx,offset TRANGROUP:szCVF
 19682                                  	;mov	dx,szCVF
 19683                                  	mov	dx,di ; *
 19684                                  	int	21h
 19685                                  	;jc	short ocvf_error
 19686                                  	; 18/06/2023
 19687                                  	jnc	short ocvf_2
 19688                                  ocvf_error:	; 18/06/2023
 19689                                  	stc				;indicate failure
 19690                                  	retn
 19691                                  ocvf_2:
 19692                                  	mov	[fhCVF],ax		; success, save CVF file handle
 19693                                  
 19694                                  	; Read the extended MagicDrv BPB
 19695                                  
 19696                                  	mov	bx,ax
 19697                                  	;mov	ah,READ
 19698                                  	mov	ah,3Fh
 19699                                  	;mov	cx,size MD_BPB
 19700                                  	mov	cx,64
 19701                                  	;mov	dx,offset TRANGROUP:MDBPB
 19702                                  	mov	dx,MDBPB
 19703                                  	int	21h
 19704                                  	jc	short ocvf_error1
 19705                                  
 19706                                  	cmp	ax,cx			; get it all?
 19707                                  	je	short ocvf_pick_cluster_size
 19708                                  					; yes...
 19709                                  ocvf_error1:
 19710                                  	call	CloseCVF
 19711                                  	; 18/06/2023
 19712                                  ;ocvf_error:
 19713                                  	stc				;indicate failure
 19714                                  	;jmp	short ocvf_ret
 19715                                  	retn
 19716                                  
 19717                                  	; Determine the cluster size to use for ratio calculation
 19718                                  
 19719                                  ocvf_pick_cluster_size:
 19720                                  	cmp	byte [fUseHostSize],0 	; user want Host drive cluster size?
 19721                                  	je	short ovcf_use_CVF_size	; no, use CVF cluster size
 19722                                  
 19723                                  	;mov	ah,Get_Drive_Data	; get the host drive cluster size
 19724                                  	mov	ah,1Ch
 19725                                  	mov	dl,[szCVF]
 19726                                  	;sub	dl,40h	
 19727                                  	sub	dl,'A'-1		; 1 = A, 2 = B, ...
 19728                                  	push	ds
 19729                                  	int	21h
 19730                                  	pop	ds
 19731                                  
 19732                                  	cmp	al,0FFh			; host drive cluster size in AL if okay,
 19733                                  	jne	short ovcf_set_size	;   failed = 0FFh
 19734                                  
 19735                                  ovcf_use_CVF_size:
 19736                                  	;mov	al,[MDBPB.dos_bpb.csecPerClu]
 19737                                  	mov	al,[MDBPB+0Dh]		; using CVF cluster size
 19738                                  
 19739                                  ovcf_set_size:
 19740                                  	mov	[csecPerCluster],al
 19741                                  
 19742                                  	; Lastly, setup the FAT buffers
 19743                                  ocvf_set_buf:
 19744                                  	mov	ax,[BYTCNT]		; if >= 32k TPA space available,
 19745                                  	mov	[savBytCnt],ax		;   setup larger FAT buffers
 19746                                  	cmp	ax,32*1024  ; 8000h
 19747                                  	jae	short ocvf_big_buf
 19748                                  
 19749                                  	; small TPA, use small resident buffers
 19750                                  
 19751                                  	;mov	word ptr [cFATEntries],cRES_FAT_ENTRIES
 19752                                  	mov	word [cFATEntries],32 ; cRES_FAT_ENTRIES
 19753                                  	mov	[segFATBuf],ds
 19754                                  	;mov	word ptr [pbufDOSFAT],offset TRANGROUP:bufDOSFAT
 19755                                  	;mov	word ptr [pbufMDFAT],offset TRANGROUP:bufMDFAT
 19756                                  	mov	word [pbufDOSFAT],bufDOSFAT
 19757                                  	mov	word [pbufMDFAT],bufMDFAT
 19758                                  	;jmp	short ocvf_success
 19759                                  	; 08/06/2023
 19760                                  	; cf = 1
 19761                                  	clc
 19762                                  	retn
 19763                                  
 19764                                  ocvf_big_buf:
 19765                                  	;mov	bx,cBIG_FAT_ENTRIES
 19766                                  	mov	bx,256
 19767                                  	mov	[cFATEntries],bx
 19768                                  
 19769                                  	shl	bx,1			; 6 bytes per entry (2 for DOS FAT, 4 MD FAT)
 19770                                  	mov	cx,bx			; entries * 2
 19771                                  	shl	bx,1
 19772                                  	add	bx,cx			; bx = # entries * 6
 19773                                  
 19774                                  	sub	ax,bx			; reduce TPA size by size of FAT buffers
 19775                                  	and	ax,0FE00h		; init code rounds BytCnt down to multiple of
 19776                                  	mov	[BYTCNT],ax		;   512 bytes -- a no-op with some buf sizes.
 19777                                  
 19778                                  	mov	bx,[TPA]		; buffers in the TPA
 19779                                  	mov	[segFATBuf],bx
 19780                                  	mov	[pbufDOSFAT],ax		; DOS FAT buffer offset
 19781                                  	add	ax,cx			;   + DOS FAT buffer size
 19782                                  	mov	[pbufMDFAT],ax 		;   = MD FAT buffer offset
 19783                                  	; 08/06/2023
 19784                                  	; cf = 0
 19785                                  ;ocvf_success:
 19786                                  	;clc				;indicate success
 19787                                  ocvf_ret:
 19788                                  	retn
 19789                                  
 19790                                  ; ---------------------------------------------------------------------------
 19791                                  
 19792                                  ;***	CloseCVF - close Compressed Volume File
 19793                                  ;
 19794                                  ;	ENTRY	fhCVF has file handle
 19795                                  ;
 19796                                  ;	EXIT
 19797                                  ;
 19798                                  ;	USED	AX, BX, CX, DX
 19799                                  
 19800                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19801                                  CloseCVF:
 19802                                  	mov	bx,[fhCVF]		; -1 unless file is open
 19803                                  	cmp	bx,-1 ; 0FFFFh
 19804                                  	je	short ccvf_ret
 19805                                  
 19806                                  	;mov	ah,CLOSE
 19807                                  	mov	ah,3Eh
 19808                                  	int	21h
 19809                                  
 19810                                  	mov	word [fhCVF],-1 ; 0FFFFh ; don't try to close again
 19811                                  
 19812                                  	mov	ax,[savBytCnt]		; 'deallocate' DOS & MD FAT buffers
 19813                                  	mov	[BYTCNT],ax		;   by restoring old TPA byte count
 19814                                  ccvf_ret:
 19815                                  	retn
 19816                                  
 19817                                  ; ---------------------------------------------------------------------------
 19818                                  
 19819                                  ;***	CalcCompRatio - calculate file compression ratio
 19820                                  ;
 19821                                  ;	ENTRY	AX = starting cluster of file to get compression ratio of
 19822                                  ;
 19823                                  ;	EXIT	AX = compression ratio.  Example: a ratio of 2.7 to 1.0
 19824                                  ;		     will return AH = 02h & AL = 07h
 19825                                  ;		ccluUsed set to # DOS clusters used by file
 19826                                  ;		csecUsed set to # compressed sectors used by file
 19827                                  ;		ccluUsedDir, ccluUsedTotal, csecUsedDir, csecUsedTotal updated
 19828                                  ;	USED	none
 19829                                  
 19830                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19831                                  CalcCompRatio:
 19832                                  	push	bx
 19833                                  	push	cx
 19834                                  	push	dx
 19835                                  	push	es
 19836                                  	mov	es,[segFATBuf]		; es is pointer to FAT buffers
 19837                                  	;assume	es:nothing
 19838                                  
 19839                                  	xor	bx,bx			; zero count of sectors & clusters used
 19840                                  	mov	[ccluUsed],bx
 19841                                  	mov	[csecUsed],bx
 19842                                  	mov	[csecUsed+2],bx
 19843                                  ccr_next:
 19844                                  	cmp	ax,2			; sanity check the DOS FAT value
 19845                                  	jb	short ccr_screwy
 19846                                  
 19847                                  	cmp	ax,0FFF0h		; end of file?
 19848                                  	jae	short ccr_eof
 19849                                  
 19850                                  	call	CheckFATBuffers 	; make sure buffers contain target
 19851                                  	jc	short ccr_screwy	;   FAT entries
 19852                                  
 19853                                  	call	GetMDFATEntry		; returns corresponding entry in BX:CX
 19854                                  	jc	short ccr_screwy
 19855                                  
 19856                                  	shl	bx,1			; used bit to CY
 19857                                  	jnc	short ccr_screwy	; better be used!
 19858                                  
 19859                                  	mov	ch,bh			; save uncompressed count
 19860                                  
 19861                                  	shl	bx,1			; get count into position
 19862                                  	and	bx,0F00h		; bh = count of compressed sectors used
 19863                                  	xchg	bh,bl			; bx = count
 19864                                  	inc	bx			; 0 - 15 means 1 - 16 used
 19865                                  
 19866                                  	add	[csecUsed],bx
 19867                                  	adc	word [csecUsed+2],0
 19868                                  
 19869                                  	mov	dx,ax			; save cluster # in dx
 19870                                  
 19871                                  	mov	al,ch			; uncompressed count to al
 19872                                  	mov	cl,3
 19873                                  	shr	al,cl			; get uncompressed count into position
 19874                                  	and	ax,000Fh		; ax = uncompressed count (0 - 15)
 19875                                  	dec	bx			; bx = compressed count (0 - 15)
 19876                                  	cmp	ax,bx			; if the compressed cnt > uncompressed
 19877                                  	;jae	@f			;   fudge a little and use the larger
 19878                                  	jae	short ccr_1 ; jnb
 19879                                  	mov	ax,bx
 19880                                  ;@@:	
 19881                                  ccr_1:
 19882                                  	mov	cl,[csecPerCluster]	; round up to the number of clusters
 19883                                  	xor	ch,ch			;   required for uncompressed
 19884                                  	add	ax,cx			;   sectors
 19885                                  	div	cl
 19886                                  	xor	ah,ah
 19887                                  	add	[ccluUsed],ax
 19888                                  
 19889                                  	mov	ax,dx			; restore cluster #
 19890                                  	call	GetDOSFATEntry		; retuns next DOS FAT entry in AX
 19891                                  	;jc	short ccr_screwy
 19892                                  	;jmp	short ccr_next
 19893                                  	; 08/06/2023
 19894                                  	jnc	short ccr_next
 19895                                  ccr_screwy:
 19896                                  	xor	ax,ax			; something screwy happened, set
 19897                                  					;   ratio to 0.0 and exit
 19898                                  ccr_ret:
 19899                                  	pop	es
 19900                                  	pop	dx
 19901                                  	pop	cx
 19902                                  	pop	bx
 19903                                  	retn
 19904                                  
 19905                                  	; Reached the end-of-file, now calculate the ratio as the
 19906                                  	; number of DOS sectors used / number of compressed sectors used.
 19907                                  
 19908                                  ccr_eof:
 19909                                  	mov	ax,[ccluUsed]
 19910                                  	add	[ccluUsedDir],ax	; update cluster used totals
 19911                                  	add	[ccluUsedTotal],ax
 19912                                  
 19913                                  	mov	cx,[csecUsed+2]
 19914                                  	mov	bx,[csecUsed]		; cx:bx = # compressed sectors used
 19915                                  
 19916                                  	add	[csecUsedDir],bx	; update sector used totals
 19917                                  	adc	[csecUsedDir+2],cx
 19918                                  	add	[csecUsedTotal],bx
 19919                                  	adc	[csecUsedTotal+2],cx
 19920                                  
 19921                                  	call	ComputeRatio		; ax=clusters used, cx:bx=sectors used
 19922                                  
 19923                                  	jmp	short ccr_ret
 19924                                  
 19925                                  	; 08/06/2023
 19926                                  ;ccr_screwy:
 19927                                  ;	xor	ax,ax			; something screwy happened, set
 19928                                  ;					;   ratio to 0.0 and exit
 19929                                  ;ccr_ret:
 19930                                  ;	pop	es
 19931                                  ;	pop	dx
 19932                                  ;	pop	cx
 19933                                  ;	pop	bx
 19934                                  ;	retn
 19935                                  
 19936                                  ; ---------------------------------------------------------------------------
 19937                                  
 19938                                  ;***	ComputeRatio - calculate ratio of compressed sectors used to
 19939                                  ;		       (would be) DOS sectors used
 19940                                  ;
 19941                                  ;	Entry
 19942                                  ;		AX = DOS clusters used, cx:bx = compressed sectors used
 19943                                  ;	Exit
 19944                                  ;		ah = whole portion, al = tenths
 19945                                  ;
 19946                                  ;	Used	BX, CX, DX
 19947                                  
 19948                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 19949                                  ComputeRatio:
 19950                                  	push	si
 19951                                  	push	di
 19952                                  
 19953                                  	mov	si,bx
 19954                                  	mov	di,cx			; save cx:bx in di:si
 19955                                  
 19956                                  	mov	bl,[csecPerCluster]
 19957                                  	xor	bh,bh
 19958                                  	mul	bx			; dx:ax = # DOS sectors used
 19959                                  	mov	bx,si			; restore bx
 19960                                  
 19961                                  	call	Div32			; dx:ax = quotient, cx:bx = remainder
 19962                                  
 19963                                  	push	ax			; save quotient
 19964                                  
 19965                                  	mov	ax,bx			; if no remainder, tenths will be 0
 19966                                  	or	ax,cx			;   which is in AX so skip following
 19967                                  	jz	short cr_got_tenths	;   (happens frequently)
 19968                                  
 19969                                  	; Multiply the reminder by 10, add half the divisor so result is
 19970                                  	; rounded up, and divide again to get tenths digit
 19971                                  
 19972                                  	mov	ax,cx
 19973                                  	xor	dx,dx
 19974                                  	mov	cx,bx
 19975                                  	mov	bx,10
 19976                                  	mul	bx
 19977                                  	xchg	ax,cx
 19978                                  	mul	bx
 19979                                  	add	dx,cx			; dx:ax = remainder * 10
 19980                                  
 19981                                  	mov	cx,di
 19982                                  	mov	bx,si
 19983                                  	shr	cx,1
 19984                                  	rcr	bx,1			; cx:bx = 1/2 divisor
 19985                                  	add	ax,bx
 19986                                  	adc	dx,cx			; dx:ax = remainder * 10 + 1/2 divisor
 19987                                  
 19988                                  	mov	cx,di
 19989                                  	mov	bx,si
 19990                                  
 19991                                  	call	Div32
 19992                                  
 19993                                  cr_got_tenths:
 19994                                  	pop	bx			; original quotient
 19995                                  	mov	ah,bl
 19996                                  
 19997                                  	cmp	al,10			; if the tenths rounded up to the
 19998                                  	jb	short cr_exit 		;   next whole number, adjust the
 19999                                  					;   whole number part and 0 the
 20000                                  	inc	ah			;   tenths  (i.e. round 1.97 to 2.0)
 20001                                  	xor	al,al
 20002                                  cr_exit:
 20003                                  	pop	di
 20004                                  	pop	si
 20005                                  
 20006                                  	retn
 20007                                  
 20008                                  ; --------------------------------------------------------------------------- 
 20009                                  
 20010                                  ;***	Div32 - 32 bit divide for computing ratios
 20011                                  ;
 20012                                  ;	Entry	DX:AX = dividend, CX:BX = divisor
 20013                                  ;
 20014                                  ;	Exit	DX:AX = quotient, CX:BX = reminder
 20015                                  
 20016                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20017                                  Div32:
 20018                                  	jcxz	d32_16bit		; differently if 16bit divisor
 20019                                  
 20020                                  	push	si
 20021                                  	push	di
 20022                                  
 20023                                  	; Brute force divide by subtraction. This is okay because worse case
 20024                                  	; the dividend will only be 16 times greater, and typically about 2
 20025                                  	; times
 20026                                  
 20027                                  	xor	si,si
 20028                                  	mov	di,si			; di:si is quotient
 20029                                  ;@@:
 20030                                  div32_1:
 20031                                  	sub	ax,bx			; subtract divisor
 20032                                  	sbb	dx,cx
 20033                                  	jc	short d32_too_far
 20034                                  
 20035                                  	add	si, 1			; accumulate quotient
 20036                                  	adc	di, 0
 20037                                  	;jmp	short @b
 20038                                  	jmp	short div32_1
 20039                                  
 20040                                  d32_too_far:
 20041                                  	add	ax,bx			; fix the last subtraction
 20042                                  	adc	dx,cx
 20043                                  
 20044                                  	mov	cx,di
 20045                                  	mov	bx,si			; dx:ax = remainder, cx:bx = quoient
 20046                                  
 20047                                  	xchg	ax,bx
 20048                                  	xchg	dx,cx			; dx:ax = quoient, cx:bx = remainder
 20049                                  
 20050                                  	pop	di
 20051                                  	pop	si
 20052                                  
 20053                                  	retn
 20054                                  
 20055                                  d32_16bit:
 20056                                  	div	bx			; divide dx:ax by bx
 20057                                  
 20058                                  	mov	bx,dx			; remainder to cx:bx
 20059                                  	xor	dx,dx			; quotient to dx:ax
 20060                                  	mov	cx,dx
 20061                                  	retn
 20062                                  
 20063                                  ; --------------------------------------------------------------------------- 
 20064                                  
 20065                                  ;***	GetDOSFATEntry - returns next cluster in file's FAT chain
 20066                                  ;
 20067                                  ;	Entry	AX = current cluster number
 20068                                  ;		ES = segment of FAT buffer
 20069                                  ;		Entry should be in FAT buffer
 20070                                  ;
 20071                                  ;	Exit	AX = next cluster number
 20072                                  ;		CY set if error
 20073                                  ;
 20074                                  ;	Uses	BX
 20075                                  
 20076                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20077                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1EF2h
 20078                                  GetDOSFATEntry:
 20079                                  	sub	ax,[entInBuf]		; calc entry # in buffer
 20080                                  	jc	short gdf_ret 		; CY already set for error
 20081                                  
 20082                                  	mov	bx,ax
 20083                                  
 20084                                  	;cmp	MDBPB.f12BitFAT, 0	; 12 or 16 bit FAT?
 20085                                  	cmp	byte [MDBPB+3Dh],0
 20086                                  	jnz	short gdf_12		; go do 12
 20087                                  
 20088                                  	shl	bx,1			; offset = entry * 2
 20089                                  	add	bx,[pbufDOSFAT]
 20090                                  	mov	ax,[es:bx]
 20091                                  	; 08/06/2023
 20092                                  	; cf = 0
 20093                                  ;gdf_success:
 20094                                  	;clc				; success
 20095                                  gdf_ret:
 20096                                  	retn
 20097                                  
 20098                                  gdf_12:
 20099                                  	shr	bx,1
 20100                                  	add	bx,ax			; offset to entry = entry * 1.5
 20101                                  	add	bx,[pbufDOSFAT]
 20102                                  
 20103                                  ;	ES:BX points to the word containing the desired 12 bit FAT entry.
 20104                                  ;	For odd entries, the upper 12 bits are valid, for even entries
 20105                                  ;	the low 12 bits are valid.  odd: OOOx  even: xEEE
 20106                                  
 20107                                  	test	al,1			; is current entry odd?
 20108                                  
 20109                                  	mov	ax,[es:bx]		; word with FAT entry
 20110                                  	jnz	short gdf_odd
 20111                                  
 20112                                  	and	ax,0FFFh		; keep low 12 bits for even
 20113                                  	jmp	short gdf_testEOF
 20114                                  
 20115                                  gdf_odd:
 20116                                  	mov	bx,cx			; (save cx in bx)
 20117                                  	mov	cl,4
 20118                                  	shr	ax,cl			; upper 12 bits for odd
 20119                                  	mov	cx,bx			; (restore cx)
 20120                                  
 20121                                  gdf_testEOF:
 20122                                  	cmp	ax,0FF0h		; valid entry?
 20123                                  	;jb	short gdf_success
 20124                                  	cmc	; cf = 1 <--> cf = 0
 20125                                  	jnc	short gdf_ret	
 20126                                  
 20127                                  	or	ah,0F0h			; caller expects 16 bit special values
 20128                                  	;jmp	short gdf_success
 20129                                  	; cf = 0
 20130                                  	retn
 20131                                  
 20132                                  ; --------------------------------------------------------------------------- 
 20133                                  
 20134                                  ;***	GetMDFATEntry - returns requested MD FAT entry
 20135                                  ;
 20136                                  ;	Entry	AX = current DOS cluster number
 20137                                  ;		ES = segment of FAT buffer
 20138                                  ;		Entry should be in FAT buffer
 20139                                  ;
 20140                                  ;	Exit	BX:CX = corresponding MD FAT entry
 20141                                  ;		CY set if error
 20142                                  ;
 20143                                  ;	Uses	None
 20144                                  
 20145                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20146                                  GetMDFATEntry:
 20147                                  	mov	bx,ax
 20148                                  	sub	bx,[entInBuf]		; calc entry # in buffer
 20149                                  	jc	short gmf_ret 		; CY already set for error return
 20150                                  
 20151                                  	shl	bx,1
 20152                                  	shl	bx,1			; * 4 bytes per MDFAT entry
 20153                                  
 20154                                  	add	bx,[pbufMDFAT]
 20155                                  	mov	cx,[es:bx]
 20156                                  	mov	bx,[es:bx+2]
 20157                                  
 20158                                  	clc
 20159                                  gmf_ret:
 20160                                  	retn
 20161                                  
 20162                                  ; --------------------------------------------------------------------------- 
 20163                                  
 20164                                  ;***	CheckFATBuffers - check that target FAT entry is in FAT buffers.  If
 20165                                  ;			  not, fill the buffers starting with the requested
 20166                                  ;			  entry.
 20167                                  ;
 20168                                  ;	ENTRY	AX = FAT entry #
 20169                                  ;		ES = segment of FAT buffers
 20170                                  ;
 20171                                  ;	EXIT	FAT buffers contain target entry, or CY set if error
 20172                                  ;		entInBuf updated
 20173                                  ;
 20174                                  ;	USED	BX
 20175                                  
 20176                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20177                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1F4Bh
 20178                                  
 20179                                  CheckFATBuffers:
 20180                                  	mov	bx,ax
 20181                                  	sub	bx,[entInBuf]
 20182                                  	jb	short cfb_load_fat
 20183                                  
 20184                                  	sub	bx,[cFATEntries]
 20185                                  	jae	short cfb_load_fat ; jnb
 20186                                  
 20187                                  	clc
 20188                                  	retn
 20189                                  
 20190                                  	; Desired entry isn't in the FAT buffers, reload the buffers to
 20191                                  	; include it
 20192                                  
 20193                                  cfb_load_fat:
 20194                                  	push	ax
 20195                                  	push	cx
 20196                                  	push	dx
 20197                                  
 20198                                  	; Start with the DOS FAT buffer
 20199                                  
 20200                                  	xor	cx,cx			; zero high offset to FAT file position
 20201                                  
 20202                                  	;cmp	MDBPB.f12BitFAT, 0	; 12 or 16 bit FAT?
 20203                                  	cmp	byte [MDBPB+3Dh],0
 20204                                  	jnz	short cfb_12		; go do 12
 20205                                  
 20206                                  	mov	[entInBuf],ax		; this entry is first
 20207                                  
 20208                                  	shl	ax,1			; 2 bytes per cluster #
 20209                                  	rcl	cx,1			; cx:ax = offset to FAT entry
 20210                                  
 20211                                  	jmp	short cfb_common
 20212                                  
 20213                                  cfb_12:
 20214                                  	;and	al,not 1 ; 0FEh		; start with even # entry
 20215                                  	and	al,~1
 20216                                  	mov	[entInBuf],ax
 20217                                  
 20218                                  	mov	bx,ax
 20219                                  	shr	bx,1
 20220                                  	add	ax,bx			; ax = offset to FAT entry
 20221                                  					;      (entry # * 1.5)
 20222                                  cfb_common:
 20223                                  	mov	bx,ax			; cx:bx = offset to FAT entry
 20224                                  
 20225                                  	;mov	ax,[MDBPB.csecMDReserved] ; # magicDrv reserved sectors
 20226                                  	mov	ax,[MDBPB+27h]
 20227                                  	;add	ax,[MDBPB.dos_bpb.csecReserved]
 20228                                  	add	ax,[MDBPB+0Eh]
 20229                                  
 20230                                  	;mul	word [MDBPB.dos_bpb.cbPerSec]
 20231                                  	mul	word [MDBPB+0Bh]	; DX:AX = DOS FAT file origin
 20232                                  	add	ax,bx
 20233                                  	adc	dx,cx			; DX:AX = file offset to read from
 20234                                  
 20235                                  	mov	cx,[cFATEntries]	; size to read
 20236                                  	shl	cx,1
 20237                                  	mov	bx,[pbufDOSFAT]		; es:bx = location to read
 20238                                  
 20239                                  	call	ReadCVFile
 20240                                  	jc	short cfb_error
 20241                                  
 20242                                  	; Now read the corresponding MagicDrv FAT entries
 20243                                  
 20244                                  	;mov	ax,[MDBPB.secMDFATStart]
 20245                                  	mov	ax,[MDBPB+24h]
 20246                                  	inc	ax
 20247                                  	;mul	word [MDBPB.dos_bpb.cbPerSec]
 20248                                  	mul	word [MDBPB+0Bh]	; DX:AX = MDFAT file offset
 20249                                  
 20250                                  	mov	bx,[entInBuf]
 20251                                  	xor	cx,cx			; CX:BX = 32 bit cluster #
 20252                                  	;add	bx,[MDBPB.cluFirstData]
 20253                                  	add	bx,[MDBPB+2Dh]
 20254                                  	adc	cx,cx			; CX:BX = MDFAT entry #
 20255                                  
 20256                                  	shl	bx,1
 20257                                  	rcl	cx,1
 20258                                  	shl	bx,1
 20259                                  	rcl	cx,1			; * 4 bytes per MDFAT entry
 20260                                  
 20261                                  	add	ax,bx
 20262                                  	adc	dx,cx			; DX:AX = file offset of MDFAT entry
 20263                                  
 20264                                  	mov	cx,[cFATEntries]
 20265                                  	shl	cx,1
 20266                                  	shl	cx,1			; size to read
 20267                                  	mov	bx,[pbufMDFAT]		; es:bx = location to read into
 20268                                  
 20269                                  	call	ReadCVFile
 20270                                  	;jnc	short cfb_ret ; cf = 0 ; 08/06/2023
 20271                                  	; 08/06/2023
 20272                                  	; cf = 1
 20273                                  cfb_error:
 20274                                  	;stc
 20275                                  cfb_ret:
 20276                                  	pop	dx
 20277                                  	pop	cx
 20278                                  	pop	ax
 20279                                  	retn
 20280                                  
 20281                                  ; --------------------------------------------------------------------------- 
 20282                                  
 20283                                  ;***	ReadCVFile - read from the Compressed Volume File
 20284                                  ;
 20285                                  ;	Entry	DX:AX file offset, ES:BX buffer location, CX length in bytes
 20286                                  ;
 20287                                  ;	Exit	CY set if error, else data read
 20288                                  ;
 20289                                  ;	Uses	AX, BX, CX, DX
 20290                                  
 20291                                  	; 08/06/2023 - Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 20292                                  ReadCVFile:
 20293                                  	push	bx			; save buffer loc
 20294                                  	push	cx			; save read length
 20295                                  
 20296                                  	mov	cx,dx
 20297                                  	mov	dx,ax			; cx:dx = file offset of fat entry
 20298                                  	;mov	ax,(LSEEK shl 8) or 0
 20299                                  	mov	ax,4200h
 20300                                  	mov	bx,[fhCVF]
 20301                                  	int	21h
 20302                                  	jc	short rcf_ret 		; CY set for error return
 20303                                  
 20304                                  	;mov	ah,READ
 20305                                  	mov	ah,3Fh
 20306                                  	pop	cx			; read length
 20307                                  	pop	dx			; buffer loc offset
 20308                                  	push	ds
 20309                                  	push	es
 20310                                  	pop	ds			; buffer loc segment
 20311                                  	int	21h
 20312                                  	pop	ds
 20313                                  	jc	short rcf_ret 		; CY set for error return
 20314                                  
 20315                                  	cmp	ax,cx			; read it all?
 20316                                  	;je	short rcf_ret 		; yes, CY clear
 20317                                  	; 08/06/2023	
 20318                                  	; ax < cx
 20319                                  	;stc				; end-of-file?
 20320                                  rcf_ret:
 20321                                  	retn
 20322                                  
 20323                                  %endif
 20324                                  
 20325                                  ;============================================================================
 20326                                  ; TCMD1B.ASM, MSDOS 6.0, 1991
 20327                                  ;============================================================================
 20328                                  ; 09/10/2018 - Retro DOS v3.0
 20329                                  
 20330                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1195h
 20331                                  
 20332                                  ; 19/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20333                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 1A4Ah
 20334                                  
 20335                                  ; =============== S U B	R O U T	I N E =======================================
 20336                                  
 20337                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20338                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:1FF4h
 20339                                  
 20340                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20341                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1DCCh
 20342                                  PAUSE:
 20343 00001CFE BA[9890]                	mov	dx,PAUSEMES_PTR ; 19/02/2023
 20344 00001D01 E81937                  	call	std_printf
 20345 00001D04 E85BE9                  	call	GETKEYSTROKE
 20346                                  	;call	CRLF2
 20347                                  	;retn
 20348                                  	; 19/02/2023
 20349 00001D07 E96D0C                  	jmp	CRLF2
 20350                                  
 20351                                  ; ---------------------------------------------------------------------------
 20352                                  
 20353                                  ;****************************************************************
 20354                                  ;*
 20355                                  ;* ROUTINE:	DEL/ERASE - erase file(s)
 20356                                  ;*
 20357                                  ;* FUNCTION:	PARSE command line for file or path name and /P
 20358                                  ;*		and invoke PATHCRUNCH. If an error occurs, set
 20359                                  ;*		up an error message and transfer control to CERROR.
 20360                                  ;*		Otherwise, transfer control to NOTEST2 if /P not
 20361                                  ;*		entered or SLASHP_ERASE if /P entered.
 20362                                  ;*
 20363                                  ;* INPUT:	command line at offset 81H
 20364                                  ;*
 20365                                  ;* OUTPUT:	if no error:
 20366                                  ;*		FCB at 5ch set up with filename(s) entered
 20367                                  ;*		Current directory set to entered directory
 20368                                  ;*
 20369                                  ;****************************************************************
 20370                                  
 20371                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20372                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1A57h
 20373                                  
 20374                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20375                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2001h
 20376                                  
 20377                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20378                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:1DD9h
 20379                                  ERASE:
 20380                                  	; MSDOS 6.0
 20381                                  
 20382                                  	;assume	ds:trangroup,es:trangroup
 20383                                  
 20384 00001D0A BE8100                  	mov	si,81h		;AC000; get command line
 20385 00001D0D C706[6A9C]0000          	mov	word [COMSW],0 	;AN000; clear switch indicator
 20386 00001D13 BF[8E96]                	mov	di,PARSE_ERASE
 20387                                  				;AN000; Get address of PARSE_ERASE
 20388 00001D16 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20389                                  erase_scan:
 20390 00001D18 31D2                    	xor	dx,dx		;AN000;
 20391 00001D1A E83C08                  	call	Parse_With_Msg	;AC018; call parser
 20392                                  	
 20393                                  	;cmp	ax,-1  ; 0FFFFh
 20394                                  	;;cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 20395                                  	;je	short good_line	;AN000; yes - done parsing
 20396                                  	;;cmp	ax,0
 20397                                  	;;cmp	ax,RESULT_NO_ERROR ; 0
 20398                                  	;and	ax,ax		;AC000; did we have an error?
 20399                                  	;jnz	short errj2	;AC000; yes exit
 20400                                  	; 10/06/2023
 20401 00001D1D 40                      	inc	ax  ; cmp ax,-1
 20402 00001D1E 743C                    	jz	short good_line ; 0FFFFh -> 0
 20403 00001D20 48                      	dec	ax  ; cmp ax,0	
 20404 00001D21 7566                    	jnz	short errj2  ; 1 -> 0
 20405                                  	; ax = 0
 20406                                  
 20407 00001D23 813E[4DA6][0196]        	cmp	word [PARSE1_SYN],SLASH_P_SYN ; "/P"
 20408                                  				;AN000; was /P entered?
 20409 00001D29 741C                    	je	short set_erase_prompt
 20410                                  				;AN000; yes - go set prompt
 20411                                  ;
 20412                                  ; Must be filespec since no other matches occurred. move filename to srcbuf
 20413                                  ;
 20414 00001D2B 56                      	push	si		;AC000; save position in line
 20415 00001D2C C536[4FA6]              	lds	si,[PARSE1_ADDR]
 20416                                  				;AC000; get address of filespec
 20417                                  	;cmp	byte [si+1],colon_char
 20418 00001D30 807C013A                	cmp	byte [si+1],':'	;AC000; drive specified?
 20419 00001D34 750B                    	jne	short erase_drive_ok
 20420                                  				;AC000; no - continue
 20421                                  	;cmp	byte [si+2],END_OF_LINE_OUT	
 20422 00001D36 807C0200                	cmp	byte [si+2],0	;AC000; was only drive entered?
 20423 00001D3A 7505                    	jne	short erase_drive_ok
 20424                                  				;AC000; no - continue
 20425 00001D3C B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2 
 20426                                  				;AN022; get message number in control block
 20427 00001D3F EB3D                    	jmp	short extend_setup
 20428                                  				;AC000; exit
 20429                                  erase_drive_ok:
 20430 00001D41 E89213                  	call	Move_To_SrcBuf	;AC000; move to srcbuf
 20431 00001D44 5E                      	pop	si		;AC000; get position back
 20432 00001D45 EBD1                    	jmp	short erase_scan
 20433                                  				;AN000; continue parsing
 20434                                  set_erase_prompt:
 20435 00001D47 833E[6A9C]00            	cmp	word [COMSW],0 	;AN018; was /P already entered?
 20436 00001D4C 7408                    	jz	short ok_to_set_erase_prompt
 20437                                  				;AN018; no go set switch
 20438                                  	;mov	ax,1
 20439 00001D4E B80100                  	mov	ax,MoreArgs_Ptr 
 20440                                  				;AN018; set up too many arguments
 20441 00001D51 E81408                  	call	setup_parse_error_msg
 20442                                  				;AN018; set up an error message
 20443 00001D54 EB33                    	jmp	short errj2	;AN018; exit
 20444                                  
 20445                                  ok_to_set_erase_prompt: 	;AN018;
 20446 00001D56 FF06[6A9C]              	inc	word [COMSW]	;AN000; indicate /p specified
 20447 00001D5A EBBC                    	jmp	short erase_scan
 20448                                  				;AN000; continue parsing
 20449                                  good_line:			;G  We know line is good
 20450 00001D5C E8C10C                  	call	PathCrunch
 20451 00001D5F 730D                    	jnc	short checkdr
 20452 00001D61 A1[939F]                	mov	ax,[Msg_Numb]	;AN022; get message number
 20453                                  	;cmp	ax,0		;AN022; was message flag set?
 20454 00001D64 09C0                    	or	ax,ax
 20455 00001D66 7516                    	jnz	short extend_setup
 20456                                  				;AN022; yes - print out message
 20457                                  	;cmp	byte [DestIsDir],0
 20458 00001D68 3806[189E]              	cmp	[DestIsDir],al 	; No CHDIRs worked
 20459 00001D6C 750D                    	jnz	short badpath_err
 20460                                  				;AC022; see if they should have
 20461                                  checkdr:
 20462 00001D6E 833E[6A9C]00            	cmp	word [COMSW],0 	;AN000; was /p specified
 20463 00001D73 7403                    	jz	short notest2j	;AN000; no - go to notest2
 20464 00001D75 E9FE1B                  	jmp	slashp_erase	;AN000; yes - go to slashp_erase
 20465                                  notest2j:
 20466 00001D78 E9961B                  	jmp	notest2
 20467                                  
 20468                                  badpath_err:			;AN022; "Path not found" message
 20469 00001D7B B80300                  	mov	ax,ERROR_PATH_NOT_FOUND ; 3
 20470                                  				;AN022; set up error number
 20471                                  extend_setup:			;AN022;
 20472                                  	;mov	byte [msg_disp_class],1
 20473 00001D7E C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 20474                                  				;AN022; set up extended error msg class
 20475 00001D83 BA[CB8F]                	mov	dx,extend_buf_ptr
 20476                                  				;AC022; get extended message pointer
 20477 00001D86 A3[CB8F]                	mov	[extend_buf_ptr],ax
 20478                                  				;AN022; get message number in control block
 20479                                  errj2:				;AC022; exit jump
 20480 00001D89 E9980F                  	jmp	cerror		;AN022;
 20481                                  
 20482                                  ; ---------------------------------------------------------------------------
 20483                                  
 20484                                  ; ****************************************************************
 20485                                  ; *
 20486                                  ; * ROUTINE:	 CRENAME - rename file(s)
 20487                                  ; *
 20488                                  ; * FUNCTION:	 PARSE command line for one full filespec and one
 20489                                  ; *		 filename. Invoke PATHCRUNCH on the full filespec.
 20490                                  ; *		 Make sure the second filespec only contains a
 20491                                  ; *		 filename. If both openands are valid, attempt
 20492                                  ; *		 to rename the file.
 20493                                  ; *
 20494                                  ; * INPUT:	 command line at offset 81H
 20495                                  ; *
 20496                                  ; * OUTPUT:	 none
 20497                                  ; *
 20498                                  ; ****************************************************************
 20499                                  
 20500                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20501                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20502                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20503                                  CRENAME:
 20504                                  	; MSDOS 6.0
 20505                                  	;assume	ds:trangroup,es:trangroup
 20506                                  
 20507 00001D8C BE8100                  	mov	si,81h		;AC000; Point to command line
 20508 00001D8F BF[1097]                	mov	di,PARSE_RENAME
 20509                                  				;AN000; Get address of PARSE_RENAME
 20510 00001D92 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20511 00001D94 31D2                    	xor	dx,dx		;AN000;
 20512 00001D96 E8C007                  	call	Parse_With_Msg	;AC018; call parser
 20513                                  	;cmp	ax,RESULT_NO_ERROR ; 0
 20514 00001D99 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 20515                                  ;	jz	short crename_no_parse_error
 20516                                  				;AC000; no - continue
 20517 00001D9B 752C                    	jnz	short crename_parse_error
 20518                                  				;AC000; Yes, fail. (need long jump)
 20519                                  ;
 20520                                  ;  Get first file name returned from parse into our buffer
 20521                                  ;
 20522                                  crename_no_parse_error:
 20523 00001D9D 56                      	push	si		;AN000; save position in line
 20524 00001D9E C536[4FA6]              	lds	si,[PARSE1_ADDR]
 20525                                  				;AN000; get address of filespec
 20526 00001DA2 E83113                  	call    Move_To_SrcBuf	;AN000; move to srcbuf
 20527 00001DA5 5E                      	pop	si		;AN000; restore position in line
 20528                                  
 20529 00001DA6 31D2                    	xor	dx,dx		;AN000; clear dx
 20530 00001DA8 E8AE07                  	call	Parse_With_Msg	;AC018; call parser
 20531                                  	;cmp	ax,RESULT_NO_ERROR
 20532 00001DAB 21C0                    	and	ax,ax ; 0 ?	;AN000; did we have an error?
 20533 00001DAD 751A                    	jnz	short crename_parse_error
 20534                                  				;AN000; Yes, fail.
 20535                                  ;
 20536                                  ;  Check the second file name for drive letter colon
 20537                                  ;
 20538 00001DAF 56                      	push	si		;AN000; save position in line
 20539 00001DB0 C536[4FA6]              	lds	si,[PARSE1_ADDR]
 20540                                  				;AC000; get address of path
 20541                                  	;mov	al,':'		;AC000;
 20542                                  	;cmp	[si+1],al	;AC000; Does the 2nd parm have a drive spec?
 20543 00001DB4 807C013A                	cmp	byte [si+1],':'
 20544 00001DB8 7511                    	jnz	short ren_no_drive
 20545                                  				;AN000; Yes, error
 20546                                  	;mov	byte [msg_disp_class],2
 20547 00001DBA C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class
 20548                                  				;AN000; set up parse error msg class
 20549 00001DBF BA[CB8F]                	mov	dx,extend_buf_ptr
 20550                                  				;AC000; get extended message pointer
 20551                                  	;mov	word [extend_buf_ptr],0Ah
 20552 00001DC2 C706[CB8F]0A00          	mov	word [extend_buf_ptr],BadParm_Ptr
 20553                                  				;AN000; get "Invalid parameter" message number
 20554 00001DC8 5E                      	pop	si		;AN000;
 20555                                  crename_parse_error:		;AC022;
 20556 00001DC9 EB64                    	jmp	short errj	;AC000;
 20557                                  
 20558                                  ;  Get second file name returned from parse into the fCB. Save
 20559                                  ;  character after file name so we can later check to make sure it
 20560                                  ;  isn't a path character.
 20561                                  
 20562                                  ren_no_drive:
 20563 00001DCB BF6C00                  	mov	di,FCB+10h ; 6Ch
 20564                                  				;AC000; set up to parse second file name
 20565                                  	;mov	ax,(Parse_File_Descriptor SHL 8) OR 01H ;AC000;
 20566 00001DCE B80129                  	mov	ax,2901h
 20567 00001DD1 CD21                    	int	21h		;AC000; do the function
 20568 00001DD3 AC                      	lodsb			;AC000; Load char after filename
 20569 00001DD4 A2[109E]                	mov	[One_Char_Val],al
 20570                                  				;AN000; save char after filename
 20571 00001DD7 5E                      	pop	si		;AN000; get line position back
 20572                                  ;
 20573                                  ; We have source and target. See if any args beyond.
 20574                                  ;
 20575 00001DD8 BF[1097]                	mov	di,PARSE_RENAME
 20576                                  				;AC000; get address of parse_rename
 20577 00001DDB E86507                  	call	parse_check_eol ;AC000; are we at end of line?
 20578 00001DDE 75E9                    	jnz	short crename_parse_error
 20579                                  				;AN000; no, fail.
 20580 00001DE0 E83D0C                  	call	PathCrunch
 20581 00001DE3 BA[DC8F]                	mov	dx,BADCPMES_PTR
 20582 00001DE6 74A1                    	jz	short errj2	; If 1st parm a dir, print error msg
 20583 00001DE8 730F                    	jnc	short notest3
 20584 00001DEA A1[939F]                	mov	ax,[Msg_Numb]	;AN022; get message number
 20585                                  	;cmp	ax,0		;AN022; was message flag set?
 20586 00001DED 21C0                    	and	ax,ax ; 0 ?
 20587 00001DEF 758D                    	jnz	short extend_setup
 20588                                  				;AN022; yes - print out message
 20589                                  	;cmp	byte [DestIsDir],0
 20590 00001DF1 3806[189E]              	cmp	[DestIsDir],al	; No CHDIRs worked
 20591 00001DF5 7402                    	jz	short notest3 	; see if they should have
 20592 00001DF7 EB82                    	Jmp	badpath_err	;AC022; set up error
 20593                                  notest3:
 20594 00001DF9 A0[109E]                	mov	al,[One_Char_Val]
 20595                                  				;AN000; move char into AX
 20596 00001DFC BA[FD8F]                	mov	dx,INORNOT_PTR 
 20597                                  				; Load invalid fname error ptr
 20598 00001DFF E8100C                  	call	pathchrcmp	; Is the char in al a path sep?
 20599 00001E02 742B                    	jz	short errj	; Yes, error - 2nd arg must be
 20600                                  				;  filename only.
 20601                                  	;mov	ah,FCB_Rename
 20602 00001E04 B417                    	mov	ah,17h
 20603 00001E06 BA5C00                  	mov	dx,FCB ; 5Ch
 20604 00001E09 CD21                    	int	21h
 20605 00001E0B 3CFF                    	cmp	al,0FFh		; Did an error occur??
 20606 00001E0D 7506                    	jne	short renameok
 20607                                  
 20608 00001E0F E83702                  	call	get_ext_error_number
 20609                                  				;AN022; get extended error
 20610 00001E12 50                      	push	ax		;AC022; Save results
 20611 00001E13 B0FF                    	mov	al,0FFh		; Restore original error state
 20612                                  renameok:
 20613 00001E15 50                      	push	ax
 20614 00001E16 E8150A                  	call	RestUDir
 20615 00001E19 58                      	pop	ax
 20616 00001E1A FEC0                    	inc	al
 20617                                  	;;retnz
 20618                                  	;jz	short rn1
 20619                                  	;retn	
 20620 00001E1C 7514                    	jnz	short ret56
 20621                                  rn1:
 20622 00001E1E 58                      	pop	ax		;AC022; get the error number back
 20623 00001E1F 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ; 2 
 20624                                  				;AN022; error file not found?
 20625 00001E22 7408                    	je	short use_renerr
 20626                                  				;AN022; yes - use generic error message
 20627 00001E24 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5 
 20628                                  				;AN022; error file not found?
 20629 00001E27 7403                    	je	short use_renerr
 20630                                  				;AN022; yes - use generic error message
 20631 00001E29 E952FF                  	jmp	extend_setup	;AN022; need long jump - use extended error
 20632                                  
 20633                                  use_renerr:
 20634 00001E2C BA[D98F]                	mov	dx,RENERR_PTR	;AC022;
 20635                                  errj:
 20636 00001E2F E9F20E                  	jmp	cerror
 20637                                  ret56:
 20638                                  ;typefil_ret:	; 20/02/2023 ; 17/04/2023
 20639 00001E32 C3                      	retn
 20640                                  
 20641                                  ; ---------------------------------------------------------------------------
 20642                                  
 20643                                  ;****************************************************************
 20644                                  ;*
 20645                                  ;* ROUTINE:	TYPEFIL - Display the contents of a file to the
 20646                                  ;*		standard output device
 20647                                  ;*
 20648                                  ;* SYNTAX:	TYPE filespec
 20649                                  ;*
 20650                                  ;* FUNCTION:	If a valid filespec is found, read the file until
 20651                                  ;*		1Ah and display the contents to STDOUT.
 20652                                  ;*
 20653                                  ;* INPUT:	command line at offset 81H
 20654                                  ;*
 20655                                  ;* OUTPUT:	none
 20656                                  ;*
 20657                                  ;****************************************************************
 20658                                  
 20659                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20660                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20661                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20662                                  TYPEFIL:
 20663                                  	; MSDOS 6.0	
 20664                                  	;assume	ds:trangroup,es:trangroup
 20665                                  
 20666 00001E33 BE8100                  	mov	si,81h
 20667 00001E36 BF[7C96]                	mov	di,PARSE_MRDIR
 20668                                  				;AN000; Get address of PARSE_MRDIR
 20669 00001E39 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20670 00001E3B 31D2                    	xor	dx,dx		;AN000;
 20671 00001E3D E81907                  	call	Parse_With_Msg	;AC018; call parser
 20672                                  	;cmp	ax,RESULT_NO_ERROR
 20673 00001E40 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 20674 00001E42 751E                    	jnz	short typefil_parse_error
 20675                                  				;AN000; yes - issue error message
 20676                                  
 20677 00001E44 56                      	push	si		;AC000; save position in line
 20678 00001E45 C536[4FA6]              	lds	si,[PARSE1_ADDR]
 20679                                  				;AC000; get address of filespec
 20680 00001E49 E88A12                  	call	Move_To_SrcBuf	;AC000; move to srcbuf
 20681 00001E4C 5E                      	pop	si		;AC000; get position back
 20682 00001E4D BF[7C96]                	mov	di,PARSE_MRDIR
 20683                                  				;AC000; get address of parse_mrdir
 20684 00001E50 E8F006                  	call	parse_check_eol ;AC000; are we at end of line?
 20685                                  	;jz	short gottarg 	;AC000; yes - continue
 20686                                  	; 20/02/2023
 20687                                  ;typefil_parse_error:		;AN000; no - set up error message and exit
 20688                                  	;jmp	cerror
 20689 00001E53 750D                    	jnz	short typefil_parse_error
 20690                                  gottarg:
 20691 00001E55 E8C510                  	call	SETPATH
 20692 00001E58 F606[1C9E]02            	test	byte [DestInfo],00000010b ; 2
 20693                                  				; Does the filespec contain wildcards
 20694 00001E5D 7406                    	jz	short nowilds 	; No, continue processing
 20695 00001E5F BA[FD8F]                	mov	dx,INORNOT_PTR	; Yes, report error
 20696                                  	; 20/02/2023
 20697                                  typefil_parse_error:
 20698 00001E62 E9BF0E                  	jmp	cerror
 20699                                  nowilds:
 20700                                  	;mov	ax,ExtOpen SHL 8 ;AC000; open the file
 20701 00001E65 B8006C                  	mov	ax,6C00h
 20702                                  	;mov	bx,read_open_mode ; 0
 20703                                  				;AN000; get open mode for TYPE
 20704 00001E68 31C9                    	xor	cx,cx		;AN000; no special files
 20705 00001E6A 89CB                    	mov	bx,cx ; 20/02/2023
 20706 00001E6C BA0101                  	mov	dx,101h
 20707                                  	;mov	dx,read_open_flag ; 101h
 20708                                  				;AN000; set up open flags
 20709 00001E6F BE[809E]                	mov	si,SrcBuf	;AN030; get file name
 20710                                  	;int	21h
 20711                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20712 00001E72 E845E7                  	call	int_21h_indirect
 20713 00001E75 7313                    	jnc	short typecont	; If open worked, continue. Otherwise load
 20714                                  
 20715                                  typerr: 			;AN022;
 20716 00001E77 0E                      	push	cs		;AN022; make sure we have local segment
 20717 00001E78 1F                      	pop	ds		;AN022;
 20718 00001E79 E8BD01                  	call	Set_Ext_Error_Msg ;AN022;
 20719 00001E7C C706[019E][809E]        	mov	word [string_ptr_2],SrcBuf 
 20720                                  				;AC022; get address of failed string
 20721                                  	;mov	byte [extend_buf_sub],1
 20722 00001E82 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 20723                                  				;AC022; put number of subst in control block
 20724 00001E87 E99A0E                  	jmp	cerror		;AC022; exit
 20725                                  
 20726                                  typecont:
 20727 00001E8A 89C3                    	mov	bx,ax		;AC000; get Handle
 20728                                  ;M043
 20729                                  ; We should do the LSEEK for filesize only if this handle belongs to a file
 20730                                  ;and not if it belongs to a device. If device, set TypeFilSiz+2 to -1 to
 20731                                  ;indicate it is a device.
 20732                                  ;
 20733                                  	;mov	ax,(IOCTL shl 8) or 0
 20734 00001E8C B80044                  	mov	ax,4400h
 20735                                  	;int	21h
 20736                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20737 00001E8F E828E7                  	call	int_21h_indirect
 20738                                  
 20739 00001E92 F6C280                  	test	dl,80h		;is it a device?
 20740 00001E95 7408                    	jz	short not_device
 20741                                  				;no, a file
 20742                                  
 20743                                  	;mov	word [TypeFilSiz+2],-1 ; 0FFFFh
 20744                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20745 00001E97 C706[FF9D]FFFF          	mov	word [File_Size_High],-1 ; 0FFFFh
 20746                                  				;indicate it is a device
 20747 00001E9D EB19                    	jmp	short dotype
 20748                                  not_device:
 20749                                  ;SR;
 20750                                  ; Find the filesize by seeking to the end and then reset file pointer to
 20751                                  ;start of file
 20752                                  
 20753                                  	;mov	ax,(LSEEK shl 8) or 2
 20754 00001E9F B80242                  	mov	ax,4202h
 20755 00001EA2 31D2                    	xor	dx,dx
 20756 00001EA4 89D1                    	mov	cx,dx		;seek  to end of file
 20757                                  	;int	21h
 20758                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20759 00001EA6 E811E7                  	call	int_21h_indirect
 20760                                  
 20761                                  	;mov	[TypeFilSiz],ax
 20762                                  	;mov	[TypeFilSiz+2],dx ;store filesize
 20763                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20764 00001EA9 A3[FD9D]                	mov	[File_Size_Low],ax
 20765 00001EAC 8916[FF9D]              	mov	[File_Size_High],dx
 20766                                  
 20767                                  	;mov	ax,(LSEEK shl 8) or 0
 20768 00001EB0 B80042                  	mov	ax,4200h
 20769 00001EB3 31D2                    	xor	dx,dx
 20770                                  	;int	21h	        ;reset file pointer to start
 20771                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20772 00001EB5 E802E7                  	call	int_21h_indirect
 20773                                  dotype:				;M043
 20774 00001EB8 C606[FDA4]00            	mov	byte [zflag],0 	; Reset ^Z flag
 20775 00001EBD 8E1E[559C]              	mov	ds,[TPA]
 20776 00001EC1 31D2                    	xor	dx,dx
 20777                                  	;ASSUME	DS:NOTHING
 20778                                  typelp:
 20779 00001EC3 2E803E[FDA4]00          	cmp	byte [cs:zflag],0
 20780                                  				;AC050; Is the ^Z flag set?
 20781                                  	;retnz			; Yes, return
 20782                                  	; 17/04/2023
 20783 00001EC9 7401                    	jz	short tf1
 20784 00001ECB C3                      	retn
 20785                                  tf1:
 20786 00001ECC 2E8B0E[749C]            	mov	cx,[cs:BYTCNT]	;AC056; No, continue
 20787                                  
 20788                                  ;Update the filesize left to read
 20789                                  
 20790                                  	;cmp	word [cs:TypeFilSiz+2],-1
 20791                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20792 00001ED1 2E833E[FF9D]FF          	cmp	word [cs:File_Size_High],-1 ; 0FFFFh
 20793                                  				;is it a device? M043
 20794 00001ED7 7431                    	je	short typ_read	;yes, just read from it; M043
 20795                                  
 20796                                  	;cmp	word [cs:TypeFilSiz+2],0
 20797                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20798 00001ED9 2E833E[FF9D]00          	cmp	word [cs:File_Size_High],0
 20799                                  				;more than 64K left?
 20800 00001EDF 740D                    	jz	short lt64k	;no, do word subtraction
 20801                                  	;sub	[cs:TypeFilSiz],cx
 20802                                  	;sbb	word [cs:TypeFilSiz+2],0
 20803                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20804 00001EE1 2E290E[FD9D]            	sub	[cs:File_Size_Low],cx
 20805 00001EE6 2E831E[FF9D]00          	sbb	word [cs:File_Size_High],0
 20806                                  				;update filesize
 20807 00001EEC EB1C                          	jmp	short typ_read	;do the read
 20808                                  lt64k:
 20809                                  	;cmp	cx,[cs:TypeFilSiz]
 20810                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20811 00001EEE 2E3B0E[FD9D]            	cmp	cx,[cs:File_Size_Low]
 20812                                  				;readsize <= buffer?
 20813 00001EF3 7610                    	jbe	short gtbuf	; yes, just update readsize
 20814                                  
 20815                                  ;Buffer size is larger than bytes to read
 20816                                  
 20817                                  	;mov	cx,[cs:TypeFilSiz]
 20818                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20819 00001EF5 2E8B0E[FD9D]            	mov	cx,[cs:File_Size_Low]
 20820 00001EFA E364                    	jcxz	typelp_ret
 20821                                  	;mov	word [cs:TypeFilSiz],0
 20822                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20823 00001EFC 2EC706[FD9D]0000        	mov	word [cs:File_Size_Low],0
 20824 00001F03 EB05                    	jmp	short typ_read
 20825                                  gtbuf:
 20826                                  	;sub	[cs:TypeFilSiz],cx
 20827                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20828 00001F05 2E290E[FD9D]            	sub	 [cs:File_Size_Low],cx
 20829                                  				;update filesize remaining
 20830                                  typ_read:
 20831                                  	;mov	ah,read
 20832 00001F0A B43F                    	mov	ah,3Fh
 20833                                  	;int	21h
 20834                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20835 00001F0C E8ABE6                  	call	int_21h_indirect
 20836 00001F0F 7303                    	jnc	short tf2	;M043
 20837 00001F11 E963FF                  	jmp	typerr		;M043
 20838                                  tf2:				;M043
 20839                                  ;M043;	jc	typerr		;AN022; Exit if error
 20840                                  
 20841 00001F14 89C1                    	mov	cx,ax
 20842 00001F16 E348                    	jcxz	typelp_ret	;AC000; exit if nothing read
 20843 00001F18 1E                      	push	ds
 20844 00001F19 07                      	pop	es		; Check to see if a ^Z was read.
 20845                                  	;assume es:nothing
 20846 00001F1A 31FF                    	xor	di,di
 20847 00001F1C 50                      	push	ax
 20848 00001F1D B01A                    	mov	al,1Ah
 20849 00001F1F F2AE                    	repnz	scasb
 20850 00001F21 58                      	pop	ax
 20851 00001F22 91                      	xchg	ax,cx
 20852                                  	;cmp	ax,0
 20853 00001F23 21C0                    	and	ax,ax
 20854 00001F25 7506                    	jnz	short foundz	; Yes, handle it
 20855 00001F27 807DFF1A                	cmp	byte [di-1],1Ah	; No, double check
 20856 00001F2B 750A                    	jnz	short typecont2	; No ^Z, continue
 20857                                  foundz:
 20858 00001F2D 29C1                    	sub	cx,ax		; Otherwise change cx so that only those
 20859 00001F2F 49                      	dec	cx		;  bytes up to but NOT including the ^Z
 20860 00001F30 0E                      	push	cs		;  will be typed.
 20861 00001F31 07                      	pop	es
 20862                                  	;assume es:trangroup
 20863 00001F32 26F616[FDA4]            	not	byte [es:zflag]	; Turn on ^Z flag so that the routine
 20864                                  typecont2:			;  will quit after this write.
 20865 00001F37 53                      	push	bx
 20866 00001F38 BB0100                  	mov	bx,1
 20867                                  	;mov	ah,Write
 20868 00001F3B B440                    	mov	ah,40h
 20869                                  	;int	21h
 20870                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20871 00001F3D E87AE6                  	call	int_21h_indirect
 20872 00001F40 5B                      	pop	bx
 20873 00001F41 720C                    	jc	short Error_outputj
 20874 00001F43 39C8                    	cmp	ax,cx
 20875 00001F45 7503                    	jnz	short tf3	;M043
 20876 00001F47 E979FF                  	jmp	typelp		;M043
 20877                                  tf3:				;M043
 20878                                  ;M043;	jz	short typelp
 20879 00001F4A 49                      	dec	cx
 20880 00001F4B 39C8                    	cmp	ax,cx
 20881                                  	;;retz			; One less byte OK (^Z)
 20882                                  	;jnz	short Error_outputj
 20883                                  ;tf4:
 20884                                  	;retn
 20885 00001F4D 7411                    	jz	short typelp_ret ; 20/02/2023
 20886                                  
 20887                                  Error_outputj:
 20888 00001F4F BB0100                  	mov	bx,1
 20889                                  	;mov	ax,IOCTL SHL 8
 20890 00001F52 B80044                  	mov	ax,4400h
 20891                                  	;int	21h
 20892                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20893 00001F55 E862E6                  	call	int_21h_indirect
 20894 00001F58 F6C280                  	test	dl,80h
 20895                                  	;test	dl,devid_ISDEV
 20896                                  	;;retnz			; If device, no error message
 20897                                  	;jnz	short tf4
 20898 00001F5B 7503                    	jnz	short typelp_ret
 20899 00001F5D E9980A                  	jmp	error_output
 20900                                  typelp_ret:
 20901 00001F60 C3                      	retn
 20902                                  
 20903                                  ; ---------------------------------------------------------------------------
 20904                                  
 20905                                  ; VOLUME command displays the volume ID on the specified drive
 20906                                  
 20907                                  	; 20/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20908                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20909                                  	; 10/06/2023
 20910                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20911                                  VOLUME:
 20912                                  	; MSDOS 6.0
 20913 00001F61 BE8100                  	mov	si,81h
 20914 00001F64 BF[6A96]                	mov	di,PARSE_VOL
 20915                                  				;AN000; Get address of PARSE_VOL
 20916 00001F67 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 20917 00001F69 31D2                    	xor	dx,dx		;AN000;
 20918 00001F6B E8EB05                  	call	Parse_With_Msg	;AC018; call parser
 20919                                  
 20920                                  	;cmp	ax,-1 ; 0FFFFh
 20921                                  	;;cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 20922                                  	;je	short OkVolArg	;AC000; Yes, display default volume ID
 20923                                  	;;cmp	ax,RESULT_NO_ERROR
 20924                                  	;;cmp	ax,0		;AC000; did we have an error?
 20925                                  	;or	ax,ax ; 0?
 20926                                  	;jnz	short badvolarg	;AC000; Yes, fail.
 20927                                  	; 10/06/2023
 20928 00001F6E 40                      	inc	ax  ; cmp ax,-1
 20929 00001F6F 7447                    	jz	short OkVolArg ; 0FFFFh -> 0
 20930 00001F71 48                      	dec	ax  ; cmp ax,0
 20931 00001F72 750A                    	jnz	short badvolarg ; 1 -> 0
 20932                                  	; ax = 0
 20933                                  
 20934                                  ; We have parsed off the drive. See if there are any more chars left
 20935                                  
 20936 00001F74 BF[6A96]                	mov	di,PARSE_VOL
 20937                                  				;AC000; get address of parse_vol
 20938 00001F77 31D2                    	xor	dx,dx		;AC000;
 20939 00001F79 E8C705                  	call	parse_check_eol ;AC000; call parser
 20940 00001F7C 743A                    	jz	short OkVolArg	;AC000; yes, end of road
 20941                                  
 20942                                  ; The line was not interpretable. Report an error.
 20943                                  
 20944                                  badvolarg:
 20945 00001F7E E9A30D                  	jmp	cerror
 20946                                  
 20947                                  ; ---------------------------------------------------------------------------
 20948                                  
 20949                                  ;***	DisAppend - disable APPEND
 20950                                  ;
 20951                                  ;	ENTRY	nothing
 20952                                  ;
 20953                                  ;	EXIT	nothing
 20954                                  ;
 20955                                  ;	USED	AX,BX
 20956                                  ;
 20957                                  ;	EFFECTS
 20958                                  ;
 20959                                  ;	  APPEND is disabled. If it was active, it will be re-enabled
 20960                                  ;	  after the command finishes, by the HeadFix routine.
 20961                                  ;
 20962                                  ;	NOTE
 20963                                  ;
 20964                                  ;	  This routine must not be called more than once during a single
 20965                                  ;	  command cycle. The second call would permanently disable APPEND.
 20966                                  
 20967                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 20968                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1CDFh
 20969                                  	
 20970                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 20971                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2289h
 20972                                  
 20973                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 20974                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2069h
 20975                                  
 20976                                  	; MSDOS 6.0
 20977                                  DisAppend:
 20978 00001F81 1E                      	push	ds			; save DS
 20979 00001F82 06                      	push	es			; save ES
 20980 00001F83 57                      	push	di
 20981                                  
 20982                                  	;mov	ax,APPENDINSTALL	; AX = Append Installed Check code
 20983 00001F84 B800B7                  	mov	ax,0B700h
 20984                                  	;int	2Fh			; talk to APPEND via multiplex
 20985                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20986 00001F87 E856E6                  	call	int_2Fh_indirect
 20987 00001F8A 08C0                    	or	al,al
 20988 00001F8C 7426                    	jz	short daRet		; APPEND not installed, return
 20989                                  
 20990                                  	;mov	ax,APPENDDOS		; AX = Get Append Version code
 20991 00001F8E B802B7                  	mov	ax,0B702h
 20992                                  	;int	2Fh			; talk to APPEND via multiplex
 20993                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 20994 00001F91 E84CE6                  	call	int_2Fh_indirect
 20995 00001F94 83F8FF                  	cmp	ax,0FFFFh
 20996 00001F97 751B                    	jne	short daRet		; it's not a local version, return
 20997                                  
 20998                                  	;mov	ax,APPENDGETSTATE	; AX = Get Function State code
 20999 00001F99 B806B7                  	mov	ax,0B706h
 21000                                  	;int	2Fh			; talk to APPEND via multiplex
 21001                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21002 00001F9C E841E6                  	call	int_2Fh_indirect
 21003                                  
 21004 00001F9F 8E1E[539C]              	mov	ds,[RESSEG]		; DS = resident seg addr
 21005                                  
 21006 00001FA3 891E[BE02]              	mov	[Append_State],bx	; Append_State = saved APPEND state
 21007 00001FA7 C606[C002]FF            	mov	byte [Append_Flag],-1	; Append_Flag = true, restore state
 21008                                  
 21009 00001FAC 31DB                    	xor	bx,bx			; BX = APPEND state = off
 21010                                  	;mov	ax,APPENDSETSTATE	; AX = Set Append State code
 21011 00001FAE B807B7                  	mov	ax,0B707h
 21012                                  	;int	2Fh			; talk to APPEND via multiplex
 21013                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21014 00001FB1 E82CE6                  	call	int_2Fh_indirect
 21015                                  daRet:	
 21016 00001FB4 5F                      	pop	di
 21017 00001FB5 07                      	pop	es			; restore ES
 21018 00001FB6 1F                      	pop	ds			; restore DS
 21019                                  
 21020 00001FB7 C3                      	retn
 21021                                  
 21022                                  ; ---------------------------------------------------------------------------
 21023                                  
 21024                                  ; Find the Volume ID on the disk.
 21025                                  
 21026                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21027                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21028                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21029                                  	
 21030                                  	; MSDOS 6.0
 21031                                  OkVolArg:
 21032 00001FB8 E8C6FF                  	call	DisAppend		; disable APPEND
 21033 00001FBB E8B909                  	call	CRLF2
 21034                                  	;mov	al,blank			
 21035 00001FBE B020                    	mov	al,' ' ; 20h		;AN051; Print out a blank
 21036 00001FC0 E8E901                  	call	PRINT_CHAR		;AN051;  before volume message
 21037 00001FC3 1E                      	push	ds
 21038 00001FC4 07                      	pop	es
 21039                                  
 21040                                  ; Volume IDs are only findable via extended FCBs or find_first with attributes
 21041                                  ; of volume_id ONLY.
 21042                                  
 21043 00001FC5 BF5500                  	mov	di,FCB-7 ; 55h		; Point to extended FCB beginning
 21044 00001FC8 B0FF                    	mov	al,-1 ; 0FFh		; Tag to indicate Extention
 21045 00001FCA AA                      	stosb
 21046 00001FCB 31C0                    	xor	ax,ax			; Zero padding to volume label
 21047 00001FCD AB                      	stosw
 21048 00001FCE AB                      	stosw
 21049 00001FCF AA                      	stosb
 21050 00001FD0 B008                    	mov	al,ATTR_VOLUME_ID ; 8	; Look for volume label
 21051 00001FD2 AA                      	stosb
 21052 00001FD3 47                      	inc	di			; Skip drive byte; it is already set
 21053 00001FD4 B90B00                  	mov	cx,11			; fill in remainder of file
 21054 00001FD7 B03F                    	mov	al,'?'
 21055 00001FD9 F3AA                    	rep	stosb
 21056                                  
 21057                                  ; Set up transfer address (destination of search first information)
 21058                                  
 21059 00001FDB BA[9A9D]                	mov	dx,DIRBUF
 21060                                  	;mov	ah,Set_DMA
 21061 00001FDE B41A                    	mov	ah,1Ah
 21062                                  	;int	21h
 21063                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21064 00001FE0 E8D7E5                  	call	int_21h_indirect
 21065                                  
 21066                                  ; Do the search
 21067                                  
 21068 00001FE3 BA5500                  	mov	dx,FCB-7 ; 55h
 21069                                  	;mov	ah,Dir_Search_First
 21070 00001FE6 B411                    	mov	ah,11h
 21071                                  	;int	21h
 21072                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21073 00001FE8 E8CFE5                  	call	int_21h_indirect
 21074                                  
 21075                                  
 21076                                  ;********************************
 21077                                  ; Print volume ID info
 21078                                  
 21079 00001FEB 50                      	push	ax			;AC000; AX return from SEARCH_FIRST for VOL ID
 21080 00001FEC A05C00                  	mov	al,[FCB]  ; [5Ch]	;AC000; get drive letter
 21081 00001FEF 0440                    	add	al,'@'  ; add al,40h
 21082 00001FF1 3C40                    	cmp	al,'@'
 21083 00001FF3 7505                    	jne	short drvok
 21084 00001FF5 A0[679C]                	mov	al,[CURDRV]
 21085                                  	;add	al,capital_A
 21086 00001FF8 0441                    	add	al,'A'
 21087                                  drvok:
 21088 00001FFA A2[129E]                	mov	[vol_drv],al		;AC000; get drive letter into argument
 21089 00001FFD 58                      	pop	ax			;AC000; get return code back
 21090 00001FFE 08C0                    	or	al,al			;AC000; volume label found?
 21091 00002000 7405                    	jz	short Get_vol_name	;AC000; volume label exists - go get it
 21092 00002002 BA[EB90]                	mov	dx,VolMes_Ptr_2		;AC000; set up no volume message
 21093 00002005 EB13                    	jmp	short print_serial	;AC000; go print it
 21094                                  
 21095                                  Get_vol_name:
 21096 00002007 BF[CB9C]                	mov	di,CHARBUF
 21097 0000200A 89FA                    	mov	dx,di
 21098 0000200C BE[A29D]                	mov	si,DIRBUF+8		;AN000;  3/3/KK
 21099 0000200F B90B00                  	mov	cx,11			;AN000;  3/3/KK
 21100 00002012 F3A4                    	rep	movsb			;AN000;  3/3/KK
 21101                                  
 21102 00002014 30C0                    	xor	al,al			;AC000; store a zero to terminate the string
 21103 00002016 AA                      	stosb
 21104 00002017 BA[F990]                	mov	dx,VolMes_Ptr		;AC000; set up message
 21105                                  
 21106                                  print_serial:
 21107                                  
 21108                                  ; Attempt to get the volume serial number from the disk. If an error
 21109                                  ; occurs, do not print volume serial number.
 21110                                  
 21111 0000201A 52                      	push	dx			;AN000; save message offset
 21112                                  	;mov	ax,(GetSetMediaID SHL 8)
 21113 0000201B B80069                  	mov	ax,6900h		;AC036; Get the volume serial info
 21114 0000201E 8A1E5C00                	mov	bl,[FCB] ; [5Ch]	;AN000; get drive number from FCB
 21115 00002022 BA[789F]                	mov	dx,vol_ioctl_buf	;AN000; target buffer
 21116                                  	;int	21h			;AN000; do the call
 21117                                  	; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21118 00002025 E892E5                  	call	int_21h_indirect
 21119                                  			; DOS - 4.0 internal - GET/SET DISK SERIAL NUMBER
 21120                                  			; AL = 00h get serial number / 01h set serial number
 21121                                  			; BL = drive (0=default, 1=A, 2=B, etc)
 21122                                  			; DS:DX -> disk info
 21123 00002028 5A                      	pop	dx			;AN000; get message offset back
 21124 00002029 720B                    	jc	short printvol_end	;AN000; if error, just go print label
 21125 0000202B E8EF33                  	call	std_printf		;AC000; go print volume message
 21126                                  	;mov	al,blank				
 21127 0000202E B020                    	mov	al,' ' ; 20h		;AN051; Print out a blank
 21128 00002030 E87901                  	call	PRINT_CHAR		;AN051;  before volume message
 21129 00002033 BA[1291]                	mov	dx,VolSerMes_Ptr 	;AN000; get serial number message
 21130                                  printvol_end:
 21131 00002036 E9E433                  	jmp	std_printf		;AC000; go print and exit
 21132                                  
 21133                                  ; ---------------------------------------------------------------------------
 21134                                  
 21135                                  ;****************************************************************
 21136                                  ;*
 21137                                  ;* ROUTINE:	Set_ext_error_msg
 21138                                  ;*
 21139                                  ;* FUNCTION:	Sets up extended error message for printing
 21140                                  ;*
 21141                                  ;* INPUT:	return from INT 21
 21142                                  ;*
 21143                                  ;* OUTPUT:	extended error message set up in extended error
 21144                                  ;*		buffer.
 21145                                  ;*
 21146                                  ;****************************************************************
 21147                                  	
 21148                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21149                                  
 21150                                  	; MSDOS 6.0
 21151                                  Set_Ext_Error_Msg:			;AN000;
 21152 00002039 E80D00                  	call	get_ext_error_number	;AC022; get the extended error
 21153 0000203C C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 21154                                  	;mov	byte [msg_disp_class],1	;AN000; set up extended error msg class
 21155 00002041 BA[CB8F]                	mov	dx,extend_buf_ptr 	;AC000; get extended message pointer
 21156 00002044 A3[CB8F]                	mov	[extend_buf_ptr],ax	;AN000; get message number in control block
 21157 00002047 F9                      	stc				;AN000; make sure carry is set
 21158 00002048 C3                      	retn				;AN000; return
 21159                                  
 21160                                  ; ---------------------------------------------------------------------------
 21161                                  
 21162                                  ;****************************************************************
 21163                                  ;*
 21164                                  ;* ROUTINE:	Get_ext_error_number
 21165                                  ;*
 21166                                  ;* FUNCTION:	Does get extended error function call
 21167                                  ;*
 21168                                  ;* INPUT:	return from INT 21
 21169                                  ;*
 21170                                  ;* OUTPUT:	AX - extended error number
 21171                                  ;*
 21172                                  ;****************************************************************
 21173                                  
 21174                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21175                                  
 21176                                  	; MSDOS 6.0
 21177                                  get_ext_error_number:			;AN022;
 21178                                  
 21179                                  	;SaveReg <BX,CX,DX,SI,DI,BP,ES,DS>
 21180                                  					;AN022; save registers
 21181 00002049 53                      	push	bx
 21182 0000204A 51                      	push	cx
 21183 0000204B 52                      	push	dx
 21184 0000204C 56                      	push	si
 21185 0000204D 57                      	push	di
 21186 0000204E 55                      	push	bp
 21187 0000204F 06                      	push	es
 21188 00002050 1E                      	push	ds
 21189                                  	;mov	ah,GetExtendedError	;AN022; get extended error
 21190 00002051 B459                    	mov	ah,59h
 21191 00002053 31DB                    	xor	bx,bx			;AN022; clear BX
 21192 00002055 CD21                    	int	21h			;AN022;
 21193                                  			; DOS - 3+ - GET EXTENDED ERROR CODE
 21194                                  			; BX = version code (0000h for DOS 3.x)
 21195                                  
 21196                                  	;RestoreReg  <DS,ES,BP,DI,SI,DX,CX,BX>
 21197                                  					;AN022; restore registers
 21198 00002057 1F                      	pop	ds
 21199 00002058 07                      	pop	es
 21200 00002059 5D                      	pop	bp
 21201 0000205A 5F                      	pop	di
 21202 0000205B 5E                      	pop	si
 21203 0000205C 5A                      	pop	dx
 21204 0000205D 59                      	pop	cx
 21205 0000205E 5B                      	pop	bx
 21206                                  
 21207 0000205F C3                      	retn				;AN022; return
 21208                                  
 21209                                  ;============================================================================
 21210                                  ; TCMD2A.ASM, MSDOS 6.0, 1991
 21211                                  ;============================================================================
 21212                                  ; 08/10/2018 - Retro DOS v3.0
 21213                                  
 21214                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1379h
 21215                                  
 21216                                  ; 21/02/2023 - Retro DOS v4.0 (& v4.1)
 21217                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 1DB7h
 21218                                  
 21219                                  ; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21220                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 2361h
 21221                                  
 21222                                  ; ---------------------------------------------------------------------------
 21223                                  
 21224                                  ; MSDOS 6.0
 21225                                  ;***	Version - display DOS version
 21226                                  ;
 21227                                  ;	SYNTAX	ver [/debug]
 21228                                  ;
 21229                                  ;		/debug - display additional DOS configuration info
 21230                                  ;
 21231                                  ;	ENTRY	command-line tail is in PSP
 21232                                  ;
 21233                                  ;	EXIT	if successful, nothing
 21234                                  ;		if parse fails,
 21235                                  ;		  parse error message is set up (for Std_EPrintf)
 21236                                  ;		    AX = system parser error code
 21237                                  ;		    DX = ptr to message block
 21238                                  ;		  we jump to CError
 21239                                  ;
 21240                                  ;	EFFECTS
 21241                                  ;	  If parse fails, a parse error message is displayed.
 21242                                  ;	  Otherwise, version message is displayed.
 21243                                  ;	  If /debug is specified, additional DOS info is displayed.
 21244                                  
 21245                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21246                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21247                                  	; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21248                                  VERSION:
 21249                                  	;assume	ds:TRANGROUP,es:TRANGROUP
 21250                                  
 21251                                  ;	Parse command line for /debug switch.
 21252                                  
 21253 00002060 BE8100                  	mov	si,81h			; DS:SI = ptr to command tail
 21254 00002063 BF[2D97]                	mov	di,PARSE_VER		; ES:DI = ptr to parse block
 21255 00002066 31C9                    	xor	cx,cx			; CX = # positional param's found
 21256 00002068 E8EE04                  	call	Parse_With_Msg
 21257                                  
 21258 0000206B B301                    	mov	bl,1			; BL = flag = /debug present
 21259                                  	;cmp	ax,RESULT_NO_ERROR
 21260                                  	;cmp	ax,0
 21261                                  	;je	short verPrintVer	; something parsed - must be /debug
 21262 0000206D 09C0                    	or	ax,ax
 21263 0000206F 740A                    	jz	short verPrintVer 
 21264 00002071 FECB                    	dec	bl			; BL = flag = no /debug present
 21265                                  	;cmp	ax,END_OF_LINE ; -1
 21266 00002073 83F8FF                  	cmp	ax,-1 ; 0FFFFh
 21267                                  
 21268                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21269                                  %if 0
 21270                                  	je	short verPrintVer	; reached end of line - ok
 21271                                  %else
 21272 00002076 7414                    	je	short not_truever_sw
 21273                                  %endif
 21274                                  
 21275                                  ;	The parse failed. Error message has been set up.
 21276                                  
 21277 00002078 E9A90C                  	jmp	cerror
 21278                                  
 21279                                  verPrintVer:
 21280                                  
 21281                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 21282                                  %if 1
 21283                                  check_t_switch:
 21284 0000207B 813E[4DA6][4D97]        	cmp	word [PARSE1_SYN],SLASH_T_SYN ; "/T" ; /t switch
 21285 00002081 7509                    	jne	short not_truever_sw
 21286 00002083 BA[7097]                	mov	dx,RD5CMD_VER_MSG
 21287 00002086 B409                    	mov	ah,STD_CON_STRING_OUTPUT ; 9 ; print the message
 21288 00002088 CD21                    	int	21h
 21289 0000208A EB47                    	jmp	short verDone
 21290                                  not_truever_sw:
 21291                                  %endif
 21292 0000208C 53                      	push	bx			; save /debug flag
 21293 0000208D E8E708                  	call	CRLF2
 21294 00002090 E84300                  	call	PRINT_VERSION
 21295 00002093 E8E108                  	call	CRLF2
 21296 00002096 5B                      	pop	bx   			; BL = /debug flag
 21297 00002097 08DB                    	or	bl,bl
 21298 00002099 7438                    	jz	short verDone		; /debug is false - we're done
 21299                                  
 21300                                  ;*	For /debug, display DOS internal revision and DOS location
 21301                                  ;	(low memory, HMA, or ROM).
 21302                                  
 21303                                  ;	Bugbug:	use symbols for bitmasks below.
 21304                                  
 21305                                  	;mov	ax,(Set_CTRL_C_Trapping shl 8) + 6 ; M013
 21306 0000209B B80633                  	mov	ax,3306h
 21307 0000209E CD21                    	int	21h
 21308                                  		; DOS - 5+ Get TRUE Version Number
 21309                                  		; (BL major, BH minor, DL revision, DH flags)
 21310 000020A0 88D0                    	mov	al,dl			;revision number in dl; M013
 21311 000020A2 88F7                    	mov	bh,dh			;flags in dh now; M013
 21312                                  ;M032	and	al,7			; AL = DOS internal revision
 21313 000020A4 3C19                    	cmp	al,'Z'-'A' ; 25	 ;M032	; revision in A-to-Z range?
 21314                                  	;jbe	short @f	 ;M032	; A-to-Z revision ok
 21315 000020A6 7602                    	jbe	short ver1
 21316                                  	;mov	al,0E9h
 21317 000020A8 B0E9                    	mov	al,'*'-'A' ; -23 ;M032	; beyond Z, just say revision *
 21318                                  ;@@:
 21319                                  ver1:
 21320                                  
 21321                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21322                                  %if 0
 21323                                  	add	al,'A' ; 41h		; AL = DOS internal rev letter
 21324                                  %else
 21325                                  	; PCDOS 7.1 COMMAND.COM
 21326 000020AA 0430                    	add	al,'0'  ; 30h
 21327                                  %endif
 21328                                  
 21329 000020AC A2[109E]                	mov	[One_Char_Val],al
 21330 000020AF BA[9D92]                	mov	dx,dosrev_ptr		; MSG_1090
 21331 000020B2 E86833                  	call	std_printf		; print DOS internal revision
 21332                                  
 21333                                  ; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21334                                  %if 1
 21335 000020B5 08D2                    	or	dl,dl
 21336 000020B7 741A                    	jz	short verDone		; Revision 0
 21337                                  %endif
 21338                                  
 21339 000020B9 B104                    	mov	cl,4
 21340 000020BB D2EF                    	shr	bh,cl			; CY = DOS in ROM
 21341 000020BD 7209                    	jc	short verRom
 21342 000020BF D0EF                    	shr	bh,1			; CY = DOS in HMA
 21343 000020C1 720A                    	jc	short verHma
 21344                                  
 21345                                  ;	DOS isn't in ROM or HMA, so it must be in lower memory.
 21346                                  
 21347                                  	;mov	dx,offset TRANGROUP:DosLow_Ptr
 21348 000020C3 BA[B192]                	mov	dx,DosLow_Ptr		; MSG_1093
 21349 000020C6 EB08                    	jmp	short verPrintLoc
 21350                                  verRom: 
 21351                                  	;mov	dx,offset TRANGROUP:DosRom_Ptr
 21352 000020C8 BA[AB92]                	mov	dx,DosRom_Ptr		; MSG_1091
 21353 000020CB EB03                    	jmp	short verPrintLoc
 21354                                  verHma: 
 21355                                  	;mov	dx,offset TRANGROUP:DosHma_Ptr
 21356 000020CD BA[AE92]                	mov	dx,DosHma_Ptr		; MSG_1092
 21357                                  verPrintLoc:
 21358 000020D0 E84A33                  	call	std_printf
 21359                                  verDone:
 21360 000020D3 E9A108                  	jmp	CRLF2
 21361                                  
 21362                                  ; 21/02/2023
 21363                                  ;	; MSDOS 3.3
 21364                                  ;VERSION:
 21365                                  ;	call	CRLF2
 21366                                  ;	call	PRINT_VERSION
 21367                                  ;	jmp	CRLF2
 21368                                  
 21369                                  ; =============== S U B	R O U T	I N E =======================================
 21370                                  
 21371                                  	; 21/02/2023 - Retro DOS v4.0
 21372                                  PRINT_VERSION:
 21373                                  	;mov	ah,GET_VERSION ; 30h
 21374 000020D6 B430                    	mov	ah,30h
 21375 000020D8 CD21                    	int	21h	; DOS -	GET DOS	VERSION
 21376                                  			; Return: AL = major version number (00h for DOS 1.x)
 21377 000020DA 50                      	push	ax
 21378 000020DB 30E4                    	xor	ah,ah
 21379 000020DD A3[0C9E]                	mov	[Major_Ver_Num],ax
 21380 000020E0 58                      	pop	ax
 21381 000020E1 86E0                    	xchg	ah,al
 21382 000020E3 30E4                    	xor	ah,ah
 21383 000020E5 A3[0E9E]                	mov	[Minor_Ver_Num],ax
 21384 000020E8 BA[E890]                	mov	dx,VerMes_Ptr	; MSG_1040
 21385 000020EB E92F33                  	jmp	std_printf
 21386                                  
 21387                                  ; =============== S U B	R O U T	I N E =======================================
 21388                                  
 21389                                  	; 21/02/2023 - Retro DOS v4.0
 21390                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21391                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21392                                  
 21393                                  PRINT_PROMPT:
 21394                                  
 21395                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 21396                                  %if 0
 21397                                  	push	ds
 21398                                  	push	cs
 21399                                  	pop	ds		; Make sure DS is in TRANGROUP
 21400                                  	push	es
 21401                                  	call	find_prompt	; Look for prompt string
 21402                                  	jc	short PP0	; Can't find one
 21403                                  	cmp	byte [es:di],0
 21404                                  	jnz	short PP1
 21405                                  PP0:				; Use default prompt
 21406                                  	call	PRINT_DRIVE
 21407                                  	mov	al,'>'
 21408                                  	;mov	al,SYM
 21409                                  	call	PRINT_CHAR
 21410                                  	jmp	short PP5
 21411                                  ;PP1:
 21412                                  ;	mov	al,[es:di]	; Get a char
 21413                                  ;	inc	di
 21414                                  ;	or	al,al
 21415                                  ;	jz	short PP5	; Nul terminated
 21416                                  ;	; 21/02/2023
 21417                                  ;	cmp	al,'$' ; 24h
 21418                                  ;	;cmp	al,[DOLLAR]	; Meta character
 21419                                  ;	jz	short PP2	; Nope
 21420                                  ;	call	PRINT_CHAR
 21421                                  ;	jmp	short PP1
 21422                                  PP2:
 21423                                  	mov	al,[es:di]
 21424                                  	inc	di
 21425                                  	;mov	bx,CLSSTRING+2	; "[2J"
 21426                                  	mov	bx,PROMPT_TABLE-3
 21427                                  	or	al,al
 21428                                  	jz	short PP5
 21429                                  PP3:
 21430                                  	add	bx,3
 21431                                  	; 21/02/2023
 21432                                  	call	UPCONV		; MSDOS 5.0 (& 6.0)
 21433                                  	;call	UPCONV_MAPCALL  ; MSDOS 3.3
 21434                                  	cmp	al,[bx]
 21435                                  	jz	short PP4
 21436                                  	cmp	byte [bx],0
 21437                                  	jnz	short PP3
 21438                                  	;jmp	short PP1
 21439                                  	; 21/02/2023
 21440                                  PP1:
 21441                                  	mov	al,[es:di]	; Get a char
 21442                                  	inc	di
 21443                                  	or	al,al
 21444                                  	jz	short PP5	; Nul terminated
 21445                                  	; 21/02/2023
 21446                                  	cmp	al,'$' ; 24h
 21447                                  	;cmp	al,[DOLLAR]	; Meta character
 21448                                  	jz	short PP2	; Nope
 21449                                  	call	PRINT_CHAR
 21450                                  	jmp	short PP1
 21451                                  PP4:
 21452                                  	push	es
 21453                                  	push	di
 21454                                  	push	cs
 21455                                  	pop	es
 21456                                  	call	word [bx+1]
 21457                                  	pop	di
 21458                                  	pop	es
 21459                                  	jmp	short PP1
 21460                                  PP5:
 21461                                  	pop	es		; Restore segments
 21462                                  	pop	ds
 21463                                  	retn
 21464                                  %else
 21465                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21466                                  	; PCDOS 7.1 COMMAND.COM
 21467 000020EE 1E                      	push	ds
 21468 000020EF 0E                      	push	cs
 21469 000020F0 1F                      	pop	ds		; Make sure DS is in TRANGROUP
 21470 000020F1 06                      	push	es
 21471 000020F2 9C                      	pushf
 21472                                  PP0:
 21473 000020F3 B8104A                  	mov	ax,4A10h	; SMARTDRV INSTALLATION CHECK (*)
 21474 000020F6 BB0000                  	mov	bx,0		; (*)
 21475 000020F9 CD2F                    	int	2Fh
 21476 000020FB 3DBEBA                  	cmp	ax,0BABEh	; 0BABEh if installed
 21477 000020FE 7504                    	jnz	short PP1
 21478                                  	;cmp	cx,0		; number of dirty cache elements
 21479 00002100 21C9                    	and	cx,cx ; 03/08/2024
 21480 00002102 7516                    	jnz	short PP3
 21481                                  PP1:
 21482 00002104 9D                      	popf
 21483 00002105 E8AA05                  	call	find_prompt	; Look for prompt string
 21484 00002108 7206                    	jc	short PP2	; Can't find one
 21485 0000210A 26803D00                	cmp	byte [es:di],0
 21486 0000210E 752E                    	jnz	short PP4
 21487                                  PP2:				; Use default prompt
 21488 00002110 1E                      	push	ds
 21489 00002111 07                      	pop	es
 21490 00002112 E8AE00                  	call	build_dir_for_prompt
 21491 00002115 E88A00                  	call	PRINT_G
 21492 00002118 EB40                    	jmp	short PP8
 21493                                  PP3:
 21494 0000211A B8104A                  	mov	ax,4A10h	; SMARTDRV - FLUSH BUFFERS (**)
 21495 0000211D BB0100                  	mov	bx,1		; (**)
 21496 00002120 CD2F                    	int	2Fh
 21497 00002122 EBCF                    	jmp	short PP0
 21498                                  PP5:
 21499 00002124 268A05                  	mov	al,[es:di]
 21500 00002127 47                      	inc	di
 21501                                  	;mov	bx,CLSSTRING+2	; "[2J"
 21502 00002128 BB[F993]                	mov	bx,PROMPT_TABLE-3
 21503 0000212B 08C0                    	or	al,al
 21504 0000212D 742B                    	jz	short PP8
 21505                                  PP6:
 21506 0000212F 83C303                  	add	bx,3
 21507 00002132 E85406                  	call	UPCONV
 21508 00002135 3A07                    	cmp	al,[bx]
 21509 00002137 7416                    	je	short PP7
 21510 00002139 803F00                  	cmp	byte [bx],0
 21511 0000213C 75F1                    	jnz	short PP6
 21512                                  	;jmp	short PP4
 21513                                  PP4:
 21514 0000213E 268A05                  	mov	al,[es:di]	; Get a char
 21515 00002141 47                      	inc	di
 21516 00002142 08C0                    	or	al,al
 21517 00002144 74DE                    	jz	short PP5	; Nul terminated
 21518 00002146 3C24                    	cmp	al,'$' ; 24h	; Meta character
 21519 00002148 74DA                    	je	short PP5	; Nope
 21520 0000214A E85F00                  	call	PRINT_CHAR
 21521 0000214D EBEF                    	jmp	short PP4
 21522                                  PP7:
 21523 0000214F 06                      	push	es
 21524 00002150 57                      	push	di
 21525 00002151 0E                      	push	cs
 21526 00002152 07                      	pop	es
 21527 00002153 FF5701                  	call	word [bx+1]
 21528 00002156 5F                      	pop	di
 21529 00002157 07                      	pop	es
 21530 00002158 EBE4                    	jmp	short PP4
 21531                                  PP8:
 21532 0000215A 07                      	pop	es		; Restore segments
 21533 0000215B 1F                      	pop	ds
 21534 0000215C C3                      	retn
 21535                                  
 21536                                  %endif
 21537                                  
 21538                                  ; ---------------------------------------------------------------------------
 21539                                  
 21540                                  PRINT_BACK:
 21541                                  	; 21/02/2023
 21542 0000215D BA[EB91]                	mov	dx,dback_ptr
 21543 00002160 E9BA32                  	jmp	std_printf
 21544                                  
 21545                                  ; ---------------------------------------------------------------------------
 21546                                  
 21547                                  PRINT_EQ:
 21548 00002163 B03D                    	mov	al,'='
 21549 00002165 EB45                    	jmp	short PRINT_CHAR
 21550                                  
 21551                                  ; ---------------------------------------------------------------------------
 21552                                  
 21553                                  ; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 21554                                  ; PCDOS 7.1 COMMAND.COM - TRANGROUP:223Eh
 21555                                  %if 1
 21556                                  PRINT_R:	 ; Print [RetCode] as PROMPT
 21557 00002167 1E                      	push	ds
 21558 00002168 8E1E[539C]              	mov	ds,[RESSEG]
 21559 0000216C A0[9A02]                	mov	al,[RetCode]
 21560 0000216F 1F                      	pop	ds
 21561 00002170 30E4                    	xor	ah,ah
 21562 00002172 B20A                    	mov	dl,10
 21563 00002174 BE[9A21]                	mov	si,RetCode_str ; "000"
 21564 00002177 F6F2                    	div	dl
 21565 00002179 80C430                  	add	ah,30h	; '0'
 21566 0000217C 886402                  	mov	[si+2],ah
 21567 0000217F 30E4                    	xor	ah,ah
 21568 00002181 F6F2                    	div	dl
 21569 00002183 053030                  	add	ax,3030h
 21570 00002186 8904                    	mov	[si],ax
 21571 00002188 3C30                    	cmp	al,30h	; '0'
 21572 0000218A 7507                    	jnz	short Print_R_@
 21573 0000218C 46                      	inc	si
 21574 0000218D 80FC30                  	cmp	ah,30h	; '0'
 21575 00002190 7501                    	jnz	short Print_R_@
 21576 00002192 46                      	inc	si
 21577                                  Print_R_@:
 21578 00002193 8936[019E]              	mov	[string_ptr_2],si
 21579 00002197 F8                      	clc
 21580 00002198 EB46                    	jmp	short Print_R_@@
 21581                                  
 21582                                  ; ---------------------------------------------------------------------------
 21583                                  RetCode_str:
 21584 0000219A 30303000                	db	'000',0
 21585                                  ; ---------------------------------------------------------------------------
 21586                                  ;; 'PROMPT $R' test for PCDOS 7.1 COMMAND.COM - Erdogan Tan - August 6, 2024
 21587                                  ;
 21588                                  ;	[org 100h]
 21589                                  ;	
 21590                                  ;	;mov	ah,09h
 21591                                  ;	;mov	dx,program_name
 21592                                  ;	;int	21h
 21593                                  ;	call	print_msg
 21594                                  ;
 21595                                  ;	mov	al,255  ; Return Code
 21596                                  ;	mov	ah,4Ch
 21597                                  ;	int	21h
 21598                                  ;hang:
 21599                                  ;	;sti
 21600                                  ;	jmp	short hang
 21601                                  ;
 21602                                  ;print_msg:
 21603                                  ;	mov	ah,0Eh
 21604                                  ;	mov	bx,7
 21605                                  ;	mov	si,program_name
 21606                                  ;nextchr:
 21607                                  ;	lodsb
 21608                                  ;	or	al,al
 21609                                  ;	jz	short pmsg_end
 21610                                  ;	int	10h
 21611                                  ;	jmp	short nextchr
 21612                                  ;pmsg_end:
 21613                                  ;	retn
 21614                                  ;
 21615                                  ;program_name:
 21616                                  ;	db 0Dh,0Ah
 21617                                  ;	db "IBM PCDOS 7.1 COMMAND.COM (Prompt "
 21618                                  ;	db 24h,"R) Return Code Test Program"
 21619                                  ;	db 0Dh,0Ah
 21620                                  ;	db "(Erdogan Tan - 06/08/2024)"
 21621                                  ;	;db 0Dh,0Ah,"$"
 21622                                  ;	db 0Dh,0Ah,0 
 21623                                  
 21624                                  %endif
 21625                                  
 21626                                  ; ---------------------------------------------------------------------------
 21627                                  
 21628                                  PRINT_ESC:
 21629 0000219E B01B                    	mov	al,1Bh
 21630 000021A0 EB0A                    	jmp	short PRINT_CHAR
 21631                                  
 21632                                  ; ---------------------------------------------------------------------------
 21633                                  
 21634                                  	; 21/02/2023
 21635                                  PRINT_G:
 21636                                  	;mov	al,[RABRACKET]
 21637 000021A2 B03E                    	mov	al,'>' ; 3Eh
 21638 000021A4 EB06                    	jmp	short PRINT_CHAR
 21639                                  
 21640                                  ; ---------------------------------------------------------------------------
 21641                                  
 21642                                  	; 21/02/2023
 21643                                  PRINT_L:
 21644                                  	;mov	al,[LABRACKET]
 21645 000021A6 B03C                    	mov	al,'<' ; 3Ch
 21646 000021A8 EB02                    	jmp	short PRINT_CHAR
 21647                                  
 21648                                  ; ---------------------------------------------------------------------------
 21649                                  
 21650                                  	; 21/02/2023
 21651                                  Print_B:
 21652                                  	;mov	al,[VBAR]
 21653 000021AA B07C                    	mov	al,'|' ; 7Ch
 21654                                  
 21655                                  ; =============== S U B	R O U T	I N E =======================================
 21656                                  
 21657                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21658                                  PRINT_CHAR:
 21659                                  	; MSDOS 6.0
 21660                                  
 21661                                  ;	Bugbug:	Why bother with ds,es here?
 21662                                  		
 21663 000021AC 06                      	push	es
 21664 000021AD 1E                      	push	ds
 21665 000021AE 07                      	pop	es
 21666 000021AF 57                      	push	di
 21667 000021B0 52                      	push	dx
 21668 000021B1 88C2                    	mov	dl,al		;AC000; Get char into al
 21669                                  	;mov	ah,STD_CON_OUTPUT
 21670                                  				;AC000; print the char to stdout
 21671 000021B3 B402                    	mov	ah,2
 21672 000021B5 CD21                    	int	21h		;AC000;
 21673 000021B7 5A                      	pop	dx
 21674 000021B8 5F                      	pop	di
 21675 000021B9 07                      	pop	es
 21676 000021BA C3                      	retn
 21677                                  
 21678                                  ; ---------------------------------------------------------------------------
 21679                                  
 21680                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21681                                  PRINT_DRIVE:
 21682                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 21683 000021BB B419                    	mov	ah,19h
 21684 000021BD CD21                    	int	21h	; DOS -	GET DEFAULT DISK NUMBER
 21685 000021BF 0441                    	add	al,'A'
 21686                                  	;add	al,[CAPITAL_A]
 21687                                  	;call	PRINT_CHAR
 21688                                  	;retn
 21689                                  	; 21/02/2023
 21690 000021C1 EBE9                    	jmp	short PRINT_CHAR
 21691                                  
 21692                                  ; ---------------------------------------------------------------------------
 21693                                  
 21694                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21695                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1EB6h
 21696                                  
 21697                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21698                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2460h
 21699                                  
 21700                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21701                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:229Ch
 21702                                  
 21703                                  build_dir_for_prompt:
 21704 000021C3 30D2                    	xor	dl,dl
 21705 000021C5 BE[9A9D]                	mov	si,BWDBUF
 21706 000021C8 89F7                    	mov	di,si
 21707 000021CA A0[679C]                	mov	al,[CURDRV]
 21708 000021CD 0441                    	add	al,'A'
 21709 000021CF B43A                    	mov	ah,':'
 21710 000021D1 AB                      	stosw
 21711 000021D2 A0[589C]                	mov	al,[DIRCHAR]
 21712 000021D5 AA                      	stosb
 21713 000021D6 87F7                    	xchg	si,di
 21714 000021D8 893E[019E]              	mov	[string_ptr_2],di
 21715                                  	;mov	ah,CURRENT_DIR ; 47h
 21716 000021DC B447                    	mov	ah,47h
 21717 000021DE CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 21718                                  			; DL = drive (0=default,1=A,etc.)
 21719                                  			; DS:SI	points to 64-byte buffer area
 21720                                  	;mov	dx,STRINGBUF2PTR ; MSDOS 3.3
 21721                                  Print_R_@@:	; 06/08/2024
 21722 000021E0 BA[D391]                	mov	dx,string_buf_ptr
 21723 000021E3 7303                    	jnc	short doprint
 21724                                  	;mov	dx,BADCURDRVPTR	; MSDOS 3.3
 21725 000021E5 BA[9590]                	mov	dx,BADCURDRV
 21726                                  doprint:
 21727                                  	;call	std_printf
 21728                                  	;retn
 21729 000021E8 E93232                  	jmp	std_printf
 21730                                  
 21731                                  ; =============== S U B	R O U T	I N E =======================================
 21732                                  
 21733                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21734                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1EDFh
 21735                                  
 21736                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21737                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:22C5h
 21738                                  
 21739                                  build_dir_for_chdir:
 21740 000021EB E80D00                  	call	build_dir_string
 21741 000021EE BA[9A9D]                	mov	dx,DIRBUF
 21742 000021F1 8916[019E]              	mov	[string_ptr_2],dx
 21743                                  	;mov	dx,offset trangroup:string_buf_ptr ; MSDOS 6.0
 21744                                  	;mov	dx,STRINGBUF2PTR ; MSDOS 3.3
 21745 000021F5 BA[D391]                	mov	dx,string_buf_ptr
 21746                                  	;call	std_printf
 21747                                  	;retn
 21748                                  	; 21/02/2023
 21749                                  	;jmp	short doprint
 21750 000021F8 E92232                  	jmp	std_printf
 21751                                  
 21752                                  ; =============== S U B	R O U T	I N E =======================================
 21753                                  
 21754                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21755                                  build_dir_string:
 21756 000021FB 8A165C00                	mov	dl,[FCB] ; mov dl,[5Ch]
 21757 000021FF 88D0                    	mov	al,dl
 21758 00002201 0440                    	add	al,'@'	; 40h
 21759 00002203 3C40                    	cmp	al,'@'
 21760 00002205 7506                    	jne	short gotdrive
 21761 00002207 0206[679C]              	add	al,[CURDRV]
 21762 0000220B FEC0                    	inc	al
 21763                                  gotdrive:
 21764 0000220D 50                      	push	ax
 21765 0000220E BE[9D9D]                	mov	si,BWDBUF+3
 21766                                  	;mov	ah,CURRENT_DIR ; 47h
 21767 00002211 B447                    	mov	ah,47h
 21768 00002213 CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 21769                                  			; DL = drive (0=default,1=A,etc.)
 21770                                  			; DS:SI	points to 64-byte buffer area
 21771 00002215 7305                    	jnc	short dpbisok
 21772 00002217 0E                      	push	cs
 21773 00002218 1F                      	pop	ds
 21774 00002219 E9040A                  	jmp	DRVBAD
 21775                                  dpbisok:
 21776 0000221C BF[9A9D]                	mov	di,BWDBUF
 21777 0000221F 89FA                    	mov	dx,di
 21778 00002221 58                      	pop	ax
 21779 00002222 B43A                    	mov	ah,':'
 21780 00002224 AB                      	stosw
 21781 00002225 A0[589C]                	mov	al,[DIRCHAR]
 21782 00002228 AA                      	stosb
 21783 00002229 C3                      	retn
 21784                                  
 21785                                  ; ---------------------------------------------------------------------------
 21786                                  
 21787                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21788                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:1F1Fh
 21789                                  
 21790                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21791                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:24C9h
 21792                                  
 21793                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 21794                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2305h
 21795                                  PATH:
 21796                                  	; MSDOS 6.0
 21797 0000222A 30C0                    	xor	al,al			;AN049; Set up holding buffer
 21798 0000222C BF[8199]                	mov	di,SRCXNAME		;AN049;  for PATH while parsing
 21799 0000222F AA                      	stosb				;AN049; Initialize PATH to null
 21800 00002230 4F                      	dec	di			;AN049; point to the start of buffer
 21801 00002231 E8600D                  	call	PGETARG 		; Pre scan for arguments
 21802 00002234 7460                    	jz	short disppath		; Print the current path
 21803                                  	;cmp	al,semicolon		;AC049; NUL path argument?
 21804 00002236 3C3B                    	cmp	al,';' ; 3Bh
 21805 00002238 7503                    	jne	short pathslp 		;AC049;
 21806 0000223A 46                      	inc	si			;AN049; point past semicolon
 21807 0000223B EB1B                    	jmp	short scan_white	;AC049; Yes - make sure nothing else on line
 21808                                  pathslp:					; Get the user specified path
 21809 0000223D AC                      	lodsb				; Get a character
 21810 0000223E 3C0D                    	cmp	al,0Dh
 21811                                  	;cmp	al,END_OF_LINE_IN	;AC049; Is it end of line?
 21812 00002240 7434                    	je	short path_eol		;AC049; yes - end of command
 21813 00002242 E81A05                  	call	testkanj		;See if DBCS
 21814 00002245 7405                    	jz	short notkanj2		;No - continue
 21815 00002247 AA                      	stosb				;AC049; Yes - store the first byte
 21816 00002248 AC                      	lodsb				;skip second byte of DBCS
 21817                                  path_hold:				;AN049;
 21818 00002249 AA                      	stosb				;AC049; Store a byte in the PATH buffer
 21819 0000224A EBF1                    	jmp	short pathslp		;continue parsing
 21820                                  notkanj2:
 21821 0000224C E83A05                  	call	UPCONV			;upper case the character
 21822                                  
 21823 0000224F 3C3B                    	cmp	al,';' ; 3Bh
 21824                                  	;cmp	al,semicolon		;AC049; ';' not a delimiter on PATH
 21825 00002251 74F6                    	je	short path_hold		;AC049; go store it
 21826 00002253 E83607                  	call	DELIM			;delimiter?
 21827 00002256 75F1                    	jnz	short path_hold		;AC049; no - go store character
 21828                                  scan_white:				;AN049; make sure were at EOL
 21829 00002258 AC                      	lodsb				;AN049; get a character
 21830 00002259 3C0D                    	cmp	al,0Dh
 21831                                  	;cmp	al,END_OF_LINE_IN	;AN049; end of line?
 21832 0000225B 7419                    	je	short path_eol		;AN049; yes - go set path
 21833 0000225D 3C20                    	cmp	al,' ' ; 20h
 21834                                  	;cmp	al,blank		;AN049; whitespace?
 21835 0000225F 74F7                    	je	short scan_white	;AN049; yes - continue scanning
 21836                                  	;cmp	al,9
 21837 00002261 3C09                    	cmp	al,tab_chr ; 9		;AN049; whitespace?
 21838 00002263 74F3                    	je	short scan_white	;AN049; yes - continue scanning
 21839                                  
 21840 00002265 BA[CB8F]                	mov	dx,extend_buf_ptr 	;AN049; no - set up error message
 21841                                  	;mov	word [extend_buf_ptr],1	;AN049; get "Too many parameters" message number
 21842 00002268 C706[CB8F]0100          	mov	word [extend_buf_ptr],MoreArgs_Ptr
 21843                                  	;mov	byte [msg_disp_class],2		
 21844                                  					;AN049; set up parse error msg class
 21845 0000226E C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class
 21846 00002273 E9AE0A                  	jmp	cerror			;AN049;
 21847                                  path_eol:				;AN049; Parsing was clean
 21848 00002276 30C0                    	xor	al,al			;AN049; null terminate the PATH
 21849 00002278 AA                      	stosb				;AN049;    buffer
 21850 00002279 E83104                  	call	find_path		;AN049; Find PATH in environment
 21851 0000227C E80504                  	call	delete_path		;AC049; Delete any offending name
 21852 0000227F E8BB04                  	call	scan_double_null	;AC049; Scan to end of environment
 21853 00002282 E88B04                  	call	move_name		;AC049; move in PATH=
 21854 00002285 BE[8199]                	mov	si,SRCXNAME		;AN049; Set up source as PATH buffer
 21855                                  store_path:				;AN049; Store the PATH in the environment
 21856 00002288 AC                      	lodsb				;AN049; Get a character
 21857                                  	;cmp	al,END_OF_LINE_OUT ; 0	;AN049; null character?
 21858 00002289 20C0                    	and	al,al ; al=0 ?
 21859 0000228B 7405                    	jz	short got_paths		;AN049; yes - exit
 21860 0000228D E81B05                  	call	store_char		;AN049; no - store character
 21861 00002290 EBF6                    	jmp	short store_path	;AN049; continue
 21862                                  got_paths:				;AN049; we're finished
 21863 00002292 31C0                    	xor	ax,ax			;	null terminate the PATH in
 21864 00002294 AB                      	stosw				;    	the environment
 21865 00002295 C3                      	retn
 21866                                  disppath:
 21867 00002296 E81404                  	call	find_path		;AN049;
 21868 00002299 E80300                  	call	print_path
 21869                                  	;call	CRLF2
 21870                                  	;retn
 21871                                  	; 21/02/2023
 21872 0000229C E9D806                  	jmp	CRLF2
 21873                                  
 21874                                  ; =============== S U B	R O U T	I N E =======================================
 21875                                  
 21876                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21877                                  print_path:
 21878 0000229F 26803D00                	cmp	byte [es:di],0
 21879 000022A3 750A                    	jnz	short path1
 21880                                  path0:
 21881 000022A5 BA[4591]                	mov	dx,NULLPATH_PTR
 21882 000022A8 0E                      	push	cs
 21883 000022A9 07                      	pop	es
 21884 000022AA 0E                      	push	cs
 21885 000022AB 1F                      	pop	ds
 21886 000022AC E96E31                  	jmp	std_printf
 21887                                  path1:
 21888 000022AF 06                      	push	es
 21889 000022B0 1F                      	pop	ds
 21890 000022B1 83EF05                  	sub	di,5
 21891 000022B4 89FE                    	mov	si,di
 21892 000022B6 E89E04                  	call	SCASB2		; Look for null
 21893                                  	;cmp	cx,0FFh ; 255
 21894                                  	; 21/02/2023
 21895                                  	;ch = 0
 21896 000022B9 80F9FF                  	cmp	cl,255
 21897 000022BC 74E7                    	je	short path0
 21898 000022BE 0E                      	push	cs
 21899 000022BF 07                      	pop	es
 21900 000022C0 BF[F5A3]                	mov	di,Arg_Buf
 21901                                  	;mov	dx,100h ; 256
 21902                                  	;sub	dx,cx
 21903                                  	;xchg	dx,cx
 21904                                  	; 21/02/2023
 21905 000022C3 F6D9                    	neg	cl ; 256-cl
 21906 000022C5 F3A4                    	rep	movsb
 21907 000022C7 BA[8D91]                	mov	dx,arg_buf_ptr
 21908 000022CA 0E                      	push	cs
 21909 000022CB 1F                      	pop	ds
 21910 000022CC E94E31                  	jmp	std_printf
 21911                                  
 21912                                  ; ---------------------------------------------------------------------------
 21913                                  
 21914                                  ; ****************************************************************
 21915                                  ; *
 21916                                  ; * ROUTINE:	 CLS
 21917                                  ; *
 21918                                  ; * FUNCTION:	 Clear the screen using INT 10h. If ANSI.SYS is
 21919                                  ; *		 installed, send a control string to clear the
 21920                                  ; *		 screen.
 21921                                  ; *
 21922                                  ; * INPUT:	 command line at offset 81H
 21923                                  ; *
 21924                                  ; * OUTPUT:	 none
 21925                                  ; *
 21926                                  ; ****************************************************************
 21927                                  
 21928                                  	; MSDOS 6.0
 21929                                  
 21930                                  ANSI_installed	equ 0FFh
 21931                                  
 21932                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 21933                                  	; 08/06/2023 - Retro DOS v4.2 COMMAND.COM
 21934                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 21935                                  CLS:
 21936                                  	;;mov	ah,Mult_ANSI		;AN000; see if ANSI.SYS installed
 21937                                  	;mov	ah,1Ah
 21938                                  	;mov	al,0			;AN000;
 21939 000022CF B8001A                  	mov	ax,1A00h
 21940 000022D2 CD2F                    	int	2Fh			;AN000;
 21941                                  		; - Multiplex - DOS 4+ ANSI.SYS internal - INSTALLATION CHECK
 21942                                  		; Return: AL = FFh if installed
 21943 000022D4 3CFF                    	cmp	al,ANSI_installed	;AN000;
 21944 000022D6 7429                    	je	short ansicls 		;AN000; installed - go do ANSI CLS
 21945                                  
 21946                                  check_lines:
 21947                                  	;mov	ax,(IOCTL SHL 8) + generic_ioctl_handle ; 440Ch
 21948 000022D8 B80C44                  	mov	ax,440Ch		;AN000; get lines per page on display
 21949                                  	;mov	bx,stdout		;AN000; lines for stdout
 21950 000022DB BB0100                  	mov	bx,1   ; handle
 21951                                  	;;mov	ch,ioc_sc		;AN000; type is display
 21952                                  	;mov	ch,3   ; CON device	
 21953                                  	;;mov	cl,get_generic		;AN000; get information
 21954                                  	;mov	cl,7Fh ; minor function, get display info
 21955                                  	; 25/04/2023
 21956 000022DE B97F03                  	mov	cx,037Fh
 21957 000022E1 BA[669F]                	mov	dx,Display_Ioctl	;AN000;
 21958 000022E4 CD21                    	int	21h			;AN000;
 21959 000022E6 720A                    	jc	short no_variable	;AN000; function had error, use default
 21960                                  		; 21/02/2023
 21961                                  		; ds:dx = parameter block
 21962                                  		; --- https://stanislavs.org/helppc/int_21-44-c.html ---
 21963                                  		; offset 00h  byte  level (0 for DOS 4.0)
 21964                                  		;   	 01h  byte  reserved
 21965                                  		;   	 02h  word  length of following data
 21966                                  		;   	 04h  word  control flags
 21967                                  		;	       bit 0 set for blink, clear for intensity
 21968                                  		;	       bits 1 to 15 reserved
 21969                                  		;   	 06h  byte  mode type (1=text, 2=graphics)
 21970                                  		;   	 07h  byte  reserved
 21971                                  		;   	 08h  word  colors; 0=monochrome, n=bits per pixel
 21972                                  		;   	 0Ah  word  pixel columns
 21973                                  		;   	 0Ch  word  pixel rows
 21974                                  		;   	 0Eh  word  character columns
 21975                                  		;   	 10h  word  character rows
 21976                                  	
 21977                                  	;mov	ax,[LinPerPag] ; [Display_Ioctl+10h]
 21978                                  	;				;AN000; get number of rows returned
 21979                                  	;mov	dh,al			;AN000; set number of rows
 21980                                  	;mov	ax,[display_width] ; [Display_Ioctl+0Eh]
 21981                                  	;				;AN000; get number of columns returned
 21982                                  	;mov	dl,al			;AN000; set number of columns
 21983                                  	; 21/02/2023
 21984 000022E8 8A16[749F]              	mov	dl,[display_width]
 21985 000022EC 8A36[769F]              	mov	dh,[LinPerPag]
 21986 000022F0 EB3B                    	jmp	short regcls		;AN000; go do cls
 21987                                  
 21988                                  no_variable:
 21989                                  	;;mov	bx,stdout		;AC000; set handle as stdout
 21990                                  	;mov	bx,1
 21991                                  	; bx = 1
 21992                                  	;mov	ax,IOCTL SHL 8		;AC000; do ioctl - get device info
 21993 000022F2 B80044                  	mov	ax,4400h
 21994 000022F5 CD21                    	int	21h			;AC000;
 21995 000022F7 F6C280                  	test	dl,80h
 21996                                  	;test	dl,devid_ISDEV		;AC000; is handle a device
 21997 000022FA 7405                    	jz	short ansicls 		;AC000; If a file put out ANSI
 21998 000022FC F6C210                  	test	dl,10h
 21999                                  	;test	dl,devid_SPECIAL	;AC000;
 22000 000022FF 7505                    	jnz	short cls_normal	;AC000; If not special CON, do ANSI
 22001                                  
 22002                                  ansicls:
 22003 00002301 E85200                  	call	ansi_cls		;AN000; clear the screen
 22004 00002304 EB2C                    	jmp	short cls_ret		;AN000; exit
 22005                                  
 22006                                  ; Get video mode
 22007                                  
 22008                                  cls_normal:				;AC000;
 22009                                  	;mov	ah,get_video_state	;AC000; set up to get video state
 22010 00002306 B40F                    	mov	ah,0Fh
 22011                                  	;int	video_io_int		;AC000; do int 10h - BIOS video IO
 22012 00002308 CD10                    	int	10h
 22013 0000230A 3C03                    	cmp	al,3
 22014                                  	;cmp	al,video_alpha		;AC000; see if in text mode
 22015 0000230C 760A                    	jbe	short DoAlpha
 22016 0000230E 3C07                    	cmp	al,7
 22017                                  	;cmp	al,video_bw		;AC000; see if black & white card
 22018 00002310 7406                    	je	short DoAlpha
 22019                                  
 22020                                  ; We are in graphics mode. Bogus IBM ROM does not scroll correctly. We will
 22021                                  ; be just as bogus and set the mode that we just got. This will blank the
 22022                                  ; screen too.
 22023                                  
 22024                                  	;mov	ah,set_video_mode	;AC000; set video mode call
 22025 00002312 B400                    	mov	ah,0
 22026                                  	;int	video_io_int		;AC000; do int 10h - BIOS video IO
 22027 00002314 CD10                    	int	10h
 22028 00002316 EB1A                    	jmp	short cls_ret		;AC000; exit
 22029                                  
 22030                                  DoAlpha:
 22031                                  
 22032                                  ; Get video mode and number of columns to scroll
 22033                                  
 22034                                  ;M01 - INT 10 Function 0F doesn't reliably return the number of rows on some
 22035                                  ;M01   adaptors. We circumvent this by reaching directly into the BIOS data
 22036                                  ;M01   area
 22037                                  ;M01   Commented out code here is the original
 22038                                  ;M01	mov	ah,get_video_state	;AC000; set up to get current video state
 22039                                  ;M01	int	video_io_int		;AC000; do int 10h - BIOS video IO
 22040                                  ;M01	mov	dl,ah
 22041                                  ;M01	mov	dh,linesperpage 	;AC000; have 25 rows on the screen
 22042                                  
 22043                                  ;M01   Following code lifted from a fix Compaq applied to ANSI
 22044                                  
 22045 00002318 1E                      	push	ds
 22046                                  	;mov	ax,ROMBIOS_DATA 	; GET ROM Data segment	M01
 22047 00002319 B84000                  	mov	ax,40h
 22048 0000231C 8ED8                    	mov	ds,ax			;  *			M01
 22049                                  
 22050                                  	;mov	dx,[CRT_Cols]		; Get Columns - assume < 256 M01
 22051 0000231E 8A164A00                	mov	dl,[4Ah]
 22052                                  	;mov	dh,[CRT_Rows]		; GET MAX NUM OF ROWS	M01
 22053 00002322 8A368400                	mov	dh,[84h]
 22054 00002326 1F                      	pop	ds			;			M01
 22055                                  
 22056 00002327 08F6                    	or	dh,dh			; Q:ZERO		M01
 22057 00002329 7502                    	jnz	short regcls		;  *JMP IF NO		M01
 22058                                  
 22059                                  	;mov	dh,LINESPERPAGE 	; SET TO 24 ROWS	M01
 22060                                  	; 25/04/2023
 22061 0000232B B619                    	mov	dh,25
 22062                                  regcls:
 22063 0000232D FEC6                    	inc	dh			; height+1		M018
 22064 0000232F E80100                  	call	reg_cls 		; go clear the screen
 22065                                  cls_ret:
 22066 00002332 C3                      	retn				; exit
 22067                                  
 22068                                  ; ---------------------------------------------------------------------------
 22069                                  
 22070                                  ; MSDOS 6.0
 22071                                  
 22072                                  ; ****************************************************************
 22073                                  ; *
 22074                                  ; * ROUTINE:	 REG_CLS
 22075                                  ; *
 22076                                  ; * FUNCTION:	 Clear the screen using INT 10H.
 22077                                  ; *
 22078                                  ; * INPUT:	 DL = NUMBER OF COLUMNS
 22079                                  ; *		 DH = NUMBER OF ROWS
 22080                                  ; *
 22081                                  ; * OUTPUT:	 none
 22082                                  ; *
 22083                                  ; ****************************************************************
 22084                                  
 22085                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22086                                  reg_cls:
 22087                                  ; Set overscan to black.
 22088                                  
 22089 00002333 FECE                    	dec	dh			; decrement rows and columns
 22090 00002335 FECA                    	dec	dl			;  to zero base
 22091 00002337 52                      	push	dx			; save rows,columns
 22092                                  	;mov	ah,set_color_palette	; set up to set the color to blank
 22093 00002338 B40B                    	mov	ah,0Bh
 22094 0000233A 31DB                    	xor	bx,bx
 22095                                  	;int	video_io_int		; do int 10h - BIOS video IO
 22096 0000233C CD10                    	int	10h
 22097 0000233E 5A                      	pop	dx			;  restore rows,colums
 22098                                  
 22099 0000233F 31C0                    	xor	ax,ax			; zero out ax
 22100 00002341 89C1                    	mov	cx,ax			;  and cx
 22101                                  
 22102                                  ; Scroll active page
 22103                                  
 22104                                  	;mov	ah,scroll_video_page	; set up to scroll page up
 22105 00002343 B406                    	mov	ah,6
 22106                                  	;mov	bh,video_attribute	; attribute for blank line
 22107 00002345 B707                    	mov	bh,7
 22108 00002347 30DB                    	xor	bl,bl			; set BL to 0
 22109                                  	;int	video_io_int		; do int 10h - BIOS video IO
 22110 00002349 CD10                    	int	10h
 22111                                  
 22112                                  ; Seek to cursor to 0,0
 22113                                  
 22114                                  ;M022 following two lines added
 22115                                  	;mov	ah,get_video_state	; get current video page in BH
 22116 0000234B B40F                    	mov	ah,0Fh
 22117                                  	;int	video_io_int
 22118 0000234D CD10                    	int	10h
 22119                                  	;mov	ah,set_cursor_position	; set up to set cursor position
 22120 0000234F B402                    	mov	ah,2
 22121 00002351 31D2                    	xor	dx,dx			; row and column 0
 22122                                  ;M022	mov	bh,0
 22123                                  	;int	video_io_int		; do into 10h - BIOS video IO
 22124 00002353 CD10                    	int	10h
 22125                                  
 22126 00002355 C3                      	retn
 22127                                  
 22128                                  ; ---------------------------------------------------------------------------
 22129                                  
 22130                                  ; MSDOS 6.0
 22131                                  
 22132                                  ; ****************************************************************
 22133                                  ; *
 22134                                  ; * ROUTINE:	 ANSI_CLS
 22135                                  ; *
 22136                                  ; * FUNCTION:	 Clear the screen using by writing a control code
 22137                                  ; *		 to STDOUT.
 22138                                  ; *
 22139                                  ; * INPUT:	 none
 22140                                  ; *
 22141                                  ; * OUTPUT:	 none
 22142                                  ; *
 22143                                  ; ****************************************************************
 22144                                  
 22145                                  	; 21/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22146                                  ansi_cls:			;AC000;
 22147 00002356 BE[F793]                	mov	si,CLSSTRING
 22148                                  			; db 4,1Bh,'[2J'
 22149 00002359 AC                      	lodsb
 22150 0000235A 88C1                    	mov	cl,al	; al = 4
 22151 0000235C 30ED                    	xor	ch,ch
 22152                                  	;mov	ah,Raw_CON_IO
 22153 0000235E B406                    	mov	ah,6
 22154                                  clrloop:
 22155 00002360 AC                      	lodsb
 22156 00002361 88C2                    	mov	dl,al
 22157 00002363 CD21                    	int	21h
 22158                                  		; DOS - DIRECT CONSOLE I/O CHARACTER OUTPUT
 22159 00002365 E2F9                    	loop	clrloop
 22160 00002367 C3                      	retn
 22161                                  
 22162                                  ;============================================================================
 22163                                  ; TCMD2B.ASM, MSDOS 6.0, 1991
 22164                                  ;============================================================================
 22165                                  ; 08/10/2018 - Retro DOS v3.0
 22166                                  
 22167                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 156Dh
 22168                                  
 22169                                  ; 21/02/2023 - Retro DOS v4.0 (& v4.1)
 22170                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 206Bh
 22171                                  
 22172                                  ; ---------------------------------------------------------------------------
 22173                                  
 22174                                  ; ****************************************************************
 22175                                  ; *
 22176                                  ; * ROUTINE:	 CTTY - Change console
 22177                                  ; *
 22178                                  ; * SYNTAX:	 CTTY device
 22179                                  ; *
 22180                                  ; * FUNCTION:	 If a valid console device is specified, CTTY will
 22181                                  ; *		 duplicate the device handle to STDIN, STDOUT and
 22182                                  ; *		 STDERR. This routine returns to LODCOM1.
 22183                                  ; *
 22184                                  ; * INPUT:	 command line at offset 81H
 22185                                  ; *
 22186                                  ; * OUTPUT:	 none
 22187                                  ; *
 22188                                  ; ****************************************************************
 22189                                  
 22190                                  	; 21/02/2023 - Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 22191                                  	; 08/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 22192                                  	; 10/06/2023
 22193                                  	; 03/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 22194                                  CTTY:
 22195                                  	; MSDOS 6.0
 22196 00002368 1E                      	push	ds			;AN000; Get local ES
 22197 00002369 07                      	pop	es			;AN000;
 22198 0000236A BE8100                  	mov	si,81h			;AC000; Get command argument for CTTY
 22199 0000236D BF[1B97]                	mov	di,PARSE_CTTY
 22200                                  					;AC000; Get address of PARSE_CTTY
 22201 00002370 31C9                    	xor	cx,cx			;AC000; clear cx,dx
 22202 00002372 31D2                    	xor	dx,dx			;AC000;
 22203 00002374 E8D525                  	call	cmd_parse		;AC000; call parser
 22204                                  
 22205                                  	;cmp	ax,-1 ; 0FFFFh
 22206                                  	;;cmp	ax,END_OF_LINE		;AN000; are we at end of line?
 22207                                  	;je	short ctty_error	;AN000; yes - error
 22208                                  	;;cmp	ax,RESULT_NO_ERROR ; 0	;AN000; did an error occur
 22209                                  	;and	ax,ax ; ax > 0 ?
 22210                                  	;jnz	short ctty_error	;AN000; YES -ERROR
 22211                                  	; 10/06/2023
 22212 00002377 40                      	inc	ax  ; cmp ax,-1
 22213 00002378 7434                    	jz	short ctty_error  ; 0FFFFh -> 0
 22214 0000237A 48                      	dec	ax  ; cmp ax,0
 22215 0000237B 7531                    	jnz	short ctty_error  ; 1 -> 0
 22216                                  	; ax = 0
 22217                                  
 22218 0000237D 56                      	push	si			;AN000; save position in line
 22219 0000237E C536[4FA6]              	lds	si,[PARSE1_ADDR]	;AN000; get address of filespec
 22220 00002382 BF[809E]                	mov	di,SrcBuf		;AN000; get address of srcbuf
 22221                                  ctty_move_filename:			;AN000; put filespec in srcbuf
 22222 00002385 AC                      	lodsb				;AN000; get a char from buffer
 22223 00002386 AA                      	stosb				;AN000; store in srcbuf
 22224                                  	;cmp	al,END_OF_LINE_OUT ; 0	;AN000; it char a terminator?
 22225 00002387 08C0                    	or	al,al ; al = 0 ?
 22226 00002389 75FA                    	jnz	short ctty_move_filename ; 26/04/2023
 22227                                  					;AN000; no - keep moving
 22228 0000238B 5E                      	pop	si			;AN000; get line position back
 22229 0000238C BF[1B97]                	mov	di,PARSE_CTTY		;AC000; Get address of PARSE_CTTY
 22230 0000238F E8B101                  	call	parse_check_eol 	;AN000; are we at end of line?
 22231                                  	;jz	short nocolon 		;AN000; yes - continue
 22232                                  	; 21/02/2023
 22233 00002392 751A                    	jnz	short ctty_error
 22234                                  ;ctty_error:
 22235                                  	;jmp	short isbaddev		;AC000; yes - exit
 22236                                  
 22237                                  	; 21/02/2023
 22238                                  	; MSDOS 3.3
 22239                                  	;call	SETPATH
 22240                                  	;dec	si
 22241                                  	;dec	si
 22242                                  	;cmp	byte [si],':'
 22243                                  	;jnz	short NOCOLON
 22244                                  	;mov	byte [si],0
 22245                                  nocolon:
 22246                                  	; 21/02/2023
 22247                                  	; MSDOS 6.0
 22248 00002394 BA[809E]                	mov	dx,SrcBuf
 22249                                  ;NOCOLON:
 22250                                  	; MSDOS 3.3 & MSDOS 6.0
 22251                                  	;;mov	ax,(OPEN SHL 8) OR 2 ; Read and write
 22252                                  	;mov	ax,(OPEN<<8)|2 ; 3D02h
 22253 00002397 B8023D                  	mov	ax,3D02h ; 21/02/2023
 22254 0000239A CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 22255                                  			; DS:DX	-> ASCIZ filename
 22256                                  			; AL = access mode
 22257                                  			; 2 - read & write
 22258 0000239C 7210                    	jc	short isbaddev
 22259 0000239E 89C3                    	mov	bx,ax
 22260                                  	;mov	ax,IOCTL*256 ; 4400h
 22261 000023A0 B80044                  	mov	ax,4400h
 22262 000023A3 CD21                    	int	21h	; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 22263                                  			; BX = file or device handle
 22264 000023A5 F6C280                  	test	dl,80h
 22265 000023A8 750C                    	jnz	short devisok
 22266                                  closedev:
 22267                                  	;mov	ah,CLOSE ; 3Eh ; Close initial handle
 22268 000023AA B43E                    	mov	ah,3Eh
 22269 000023AC CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22270                                  			; BX = file handle
 22271                                  ctty_error:
 22272                                  isbaddev:
 22273 000023AE BA[4B91]                	mov	dx,BADDEV_PTR
 22274 000023B1 E86930                  	call	std_printf
 22275 000023B4 EB40                    	jmp	short resret
 22276                                  
 22277                                  	;nop
 22278                                  devisok:
 22279                                  	; 21/02/2023
 22280                                  	; MSDOS 6.0
 22281 000023B6 52                      	push	dx		;AN007; save device info
 22282                                  	; 08/06/2023
 22283 000023B7 A1[EE91]                	mov	ax,[acrlf_ptr]	;AN021; get message number for 0d, 0a
 22284                                  	;mov	dh,util_msg_class
 22285 000023BA B6FF                    	mov	dh,-1 ; 0FFh	;AN021; this is a utility message
 22286 000023BC 53                      	push	bx		;AN021; save handle
 22287 000023BD E84231                  	call	TSYSGETMSG	;AN021; get the address of the message
 22288 000023C0 89F2                    	mov	dx,si		;AN021; get address into dx
 22289                                  	;mov	ax,(Write shl 8)
 22290 000023C2 B80040                  	mov	ax,4000h	;AN007; write to device
 22291 000023C5 B90200                  	mov	cx,2		;AN007; write two bytes
 22292 000023C8 CD21                    	int	21h		;AN007;
 22293 000023CA 5B                      	pop	bx		;AN021; get back handle
 22294 000023CB 5A                      	pop	dx		;AN007; get back device info
 22295 000023CC 72DC                    	jc	short closedev	;AN007; if error, quit
 22296                                  
 22297                                  	; MSDOS 3.3 & MSDOS 6.0
 22298 000023CE 30F6                    	xor	dh,dh
 22299 000023D0 80CA03                  	or	dl,3
 22300                                  	;;mov	ax,(IOCTL SHL 8) OR 1
 22301                                  	;mov	ax,(IOCTL<<8)|1 ; 4401h
 22302 000023D3 B80144                  	mov	ax,4401h
 22303 000023D6 CD21                    	int	21h	; DOS -	2+ - IOCTL - SET DEVICE	INFORMATION
 22304                                  			; BX = device handle,DH = 0
 22305                                  			; DL = device information to set 
 22306                                  			;	(bits 0-7 from	function 0)
 22307 000023D8 53                      	push	bx
 22308 000023D9 B90300                  	mov	cx,3
 22309 000023DC 31DB                    	xor	bx,bx
 22310                                  iclloop:			; Close basic handles
 22311                                  	;mov	ah,CLOSE ; 3Eh
 22312 000023DE B43E                    	mov	ah,3Eh
 22313 000023E0 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22314                                  			; BX = file handle
 22315 000023E2 43                      	inc	bx
 22316 000023E3 E2F9                    	loop	iclloop
 22317 000023E5 5B                      	pop	bx		; Get handle
 22318                                  	;mov	ah,XDUP ; 45h
 22319 000023E6 B445                    	mov	ah,45h
 22320 000023E8 CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22321                                  			; BX = file handle to duplicate
 22322                                  	;mov	ah,XDUP ; 45h
 22323 000023EA B445                    	mov	ah,45h
 22324 000023EC CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22325                                  			; BX = file handle to duplicate
 22326                                  	;mov	ah,XDUP ; 45h
 22327 000023EE B445                    	mov	ah,45h
 22328 000023F0 CD21                    	int	21h	; DOS -	2+ - CREATE DUPLICATE HANDLE (DUP)
 22329                                  			; BX = file handle to duplicate
 22330                                  	;mov	ah,CLOSE ; 3Eh
 22331 000023F2 B43E                    	mov	ah,3Eh
 22332 000023F4 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 22333                                  			; BX = file handle
 22334                                  resret:
 22335 000023F6 8E1E[539C]              	mov	ds,[RESSEG]
 22336 000023FA 1E                      	push	ds
 22337                                  	;mov	ax,[18h]
 22338 000023FB A11800                  	mov	ax,[PDB.JFN_TABLE] ; Get new 0 and 1
 22339 000023FE A3[9F02]                	mov	[Io_Save],ax
 22340                                  	;;;mov	ax,31Eh ; MSDOS 3.3
 22341                                  	;;mov	ax,LODCOM1
 22342                                  	;;mov	ax,offset DATARES:TrnLodCom1_Trap  ; MSDOS 6.0
 22343                                  	;mov	ax,175h ; MSDOS 6.0
 22344 00002401 B8[D600]                	mov	ax,TrnLodCom1_Trap
 22345 00002404 50                      	push	ax
 22346                                  
 22347 00002405 CB                      	retf		; Far return
 22348                                  
 22349                                  ; ---------------------------------------------------------------------------
 22350                                  
 22351                                  ;****************************************************************
 22352                                  ;*
 22353                                  ;* ROUTINE:	CHCP - Change code page internal command
 22354                                  ;*		(added DOS 3.30 07/21/86)
 22355                                  ;*
 22356                                  ;* SYNTAX:	CHCP [xxx]
 22357                                  ;*		where xxx is a valid code page
 22358                                  ;*
 22359                                  ;* FUNCTION:	If xxx is specified, CHCP will use INT 21H function
 22360                                  ;*		6402H to set the code page to xxxx. If no parameters
 22361                                  ;*		are specified, CHCP will use INT 21H function 6401H
 22362                                  ;*		to get global code page and display it to the user.
 22363                                  ;*
 22364                                  ;* INPUT:	command line at offset 81H
 22365                                  ;*
 22366                                  ;* OUTPUT:	none
 22367                                  ;*
 22368                                  ;****************************************************************
 22369                                  
 22370                                  NLSFUNC_installed equ  0FFh
 22371                                  set_global_cp	  equ  2
 22372                                  get_global_cp	  equ  1
 22373                                  
 22374                                  	; 21/02/2023 - Retro DOS v4.0
 22375                                  	; 09/06/2023 - Retro DOS v4.2 COMMAND.COM
 22376                                  	; 10/06/2023
 22377                                  	; 03/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM
 22378                                  CHCP:
 22379                                  	; MSDOS 6.0
 22380 00002406 1E                      	push	ds		;AN000; Get local ES
 22381 00002407 07                      	pop	es		;AN000;
 22382 00002408 BE8100                  	mov	si,81h		;AC000; Get command argument for CHCP
 22383 0000240B BF[2796]                	mov	di,PARSE_CHCP
 22384                                  				;AN000; Get address of PARSE_CHCP
 22385 0000240E 31C9                    	xor	cx,cx		;AC000; clear cx,dx
 22386 00002410 31D2                    	xor	dx,dx		;AC000;
 22387 00002412 E84401                  	call    Parse_With_Msg	;AC018; call parser
 22388                                  
 22389                                  	;cmp	ax,-1
 22390                                  	;;cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 22391                                  	;;jne	short setcp	;AC000; no go get number & set code page
 22392                                  	;je	short getcp	;AC000; yes - no parm - get code page
 22393                                  ;setcp:
 22394                                  	;;cmp	ax,0
 22395                                  	;;cmp	ax,RESULT_NO_ERROR
 22396                                  	;			;AN000; did we have an error?
 22397                                  	;;jne	short cp_error	;AC018; yes - go issue message
 22398                                  	;and	ax,ax ; ax > 0 ?
 22399                                  	;jnz	short cp_error	
 22400                                  	; 10/06/2023
 22401 00002415 40                      	inc	ax  ; cmp ax,-1	
 22402 00002416 745C                    	jz	short getcp ; 0FFFFh -> 0
 22403 00002418 48                      	dec	ax  ; cmp ax,0
 22404 00002419 7556                    	jnz	short cp_error ; 1 -> 0
 22405                                  	; ax = 0
 22406                                  
 22407                                  	;;push	cx		;AN000; save positional count
 22408                                  	;mov	bx,PARSE1_ADDR	;AN000; get number returned
 22409                                  	;;mov	cx,[bx]		;AN000;  into cx
 22410                                  	;;mov	[system_cpage],cx
 22411                                  	;			;AN000; save user input number
 22412                                  	;;pop	cx		;AC000; restore positional count
 22413                                  	;; 21/02/2023
 22414                                  	;mov	di,[bx]
 22415                                  	;mov	[system_cpage],di
 22416                                  	; 09/06/2023	
 22417 0000241B 8B1E[4FA6]              	mov	bx,[PARSE1_ADDR]
 22418 0000241F 891E[FB9D]              	mov	[system_cpage],bx
 22419                                  	;
 22420 00002423 BF[2796]                	mov	di,PARSE_CHCP	;AN000; Get address of PARSE_CHCP
 22421 00002426 E81A01                  	call	parse_check_eol ;AN000; are we at end of line?
 22422 00002429 7546                    	jnz	short cp_error	;AC000; no - exit
 22423                                  okset:
 22424                                  	;;mov	ah,NLSFUNC	;AN000; see if NLSFUNC installed
 22425                                  	;mov	ah,14h
 22426                                  	;mov	al,0		;AN000;
 22427 0000242B B80014                  	mov	ax,1400h
 22428 0000242E CD2F                    	int	2Fh		;AN000;
 22429                                  	;cmp	al,0FFh
 22430 00002430 3CFF                    	cmp	al,NLSFUNC_installed
 22431                                  				;AN000;
 22432 00002432 7405                    	je	short got_NLS 	;AN000; Yes - continue
 22433 00002434 BA[8F90]                	mov	dx,NLSFUNC_PTR
 22434                                  				;AN000; no - set up error message
 22435 00002437 EB38                    	jmp	short cp_error	;AN000; error exit
 22436                                  
 22437                                  	; 21/02/2023
 22438                                  got_NLS:
 22439                                  	; MSDOS 6.0
 22440 00002439 8B1E[FB9D]              	mov	bx,[system_cpage]
 22441                                  				;AN000; get user input code page
 22442                                  ;SET_CP_TBL_NUM:
 22443                                  	;mov	[SYSTEM_CPAGE],bx ; MSDOS 3.3
 22444                                  	;
 22445                                  	; MSDOS 3.3 & MSDOS 6.0
 22446                                  	;;mov	ah,GETSETCDPG 	;get/set global code page function
 22447                                  	;mov	ah,66h
 22448                                  	;;mov	al,set_global_cp 
 22449                                  	;mov	al,2		;minor - set
 22450                                  	; 26/04/2023
 22451 0000243D B80266                  	mov	ax,6602h
 22452 00002440 CD21                    	int	21h
 22453                                  		; DOS - 3.3+ - SET GLOBAL CODE PAGE TABLE
 22454                                  		; BX = active code page
 22455                                  		; DX = system code page (active page at boot time)
 22456                                  
 22457 00002442 733F                    	jnc	short chcp_return
 22458                                  				;no error - exit
 22459                                  
 22460 00002444 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ; 2
 22461 00002447 7515                    	jnz	short chcp_other_error
 22462                                  
 22463                                  	;mov	ah,GETEXTENDEDERROR ; 59h
 22464 00002449 B459                    	mov	ah,59h
 22465 0000244B 31DB                    	xor	bx,bx
 22466 0000244D CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 22467                                  			; BX = version code (0000h for DOS 3.x)
 22468                                  
 22469 0000244F 83F80D                  	cmp	ax,ERROR_INVALID_DATA ; 0Dh ; invalid code page
 22470 00002452 7505                    	jne	short no_countrysys ; 26/04/2023
 22471                                  	;mov	dx,FNOTFOUNDPTR ; MSDOS 3.3
 22472 00002454 BA[9290]                	mov	dx,INV_CODE_PAGE
 22473                                  	;jmp	cerror
 22474 00002457 EB18                    	jmp	short cp_error
 22475                                  
 22476                                  	; 21/02/2023
 22477                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 22478                                  no_countrysys:
 22479                                  ;M045;	mov	byte [msg_disp_class],ext_msg_class	   
 22480                                  ;					;AN000; set up extended error msg class
 22481                                  ;M045;	mov	dx,extend_buf_ptr	;AC000; get extended message pointer
 22482                                  ;M045;	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND
 22483                                  					;AN000; get message number in control block
 22484 00002459 BA[BA92]                	mov	dx,NoCntry_Ptr
 22485 0000245C EB13                    	jmp	short cp_error
 22486                                  
 22487                                  chcp_other_error:		; end of p716
 22488                                  	;mov	ah,GETEXTENDEDERROR ; 59h ;error - see what it is
 22489 0000245E B459                    	mov	ah,59h
 22490 00002460 31DB                    	xor	bx,bx
 22491 00002462 CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 22492                                  			; BX = version code (0000h for DOS 3.x)
 22493 00002464 83F841                  	cmp	ax,65		;was it access denied?
 22494 00002467 7505                    	jne	short none_set	;no - assume all failed
 22495 00002469 BA[7390]                	mov	dx,cp_not_all_ptr
 22496                                  				;set up message
 22497                                  	;jmp	cerror		;AC000; error exit
 22498 0000246C EB03                    	jmp     short cp_error
 22499                                  none_set:
 22500 0000246E BA[6590]                	mov	dx,cp_not_set_ptr
 22501                                  				;set up message
 22502                                  cp_error:
 22503 00002471 E9B008                  	jmp	cerror		;exit
 22504                                  getcp:
 22505                                  	;;mov	ah,GETSETCDPG ; 66h
 22506                                  	;mov	ah,66h		;get/set global code page function	
 22507                                  	;;mov	al,get_global_cp ; 1
 22508                                  	;mov	al,1		;minor - get
 22509                                  	; 26/04/2023
 22510 00002474 B80166                  	mov	ax,6601h
 22511 00002477 CD21                    	int	21h	; DOS -	3.3+ - GET GLOBAL CODE PAGE TABLE
 22512 00002479 891E[FB9D]              	mov	[system_cpage],bx
 22513                                  				;get active cp for output
 22514 0000247D BA[8190]                	mov	dx,cp_active_ptr
 22515 00002480 E89A2F                  	call	std_printf	;print it out
 22516                                  chcp_return:
 22517 00002483 C3                      	retn
 22518                                  
 22519                                  ; ---------------------------------------------------------------------------
 22520                                  
 22521                                  ; ****************************************************************
 22522                                  ; *
 22523                                  ; * ROUTINE:	 TRUENAME
 22524                                  ; *
 22525                                  ; * FUNCTION:	 Entry point for the internal TRUENAME command.
 22526                                  ; *		 Parses the command line. If a path is found, set
 22527                                  ; *		 SRCXNAME to path. If only a drive letter is found,
 22528                                  ; *		 set SRCXNAME to the drive letter. If no path
 22529                                  ; *		 is found, set the path of SRCXNAME to dot (.) for
 22530                                  ; *		 current directory. Use the NAME TRANSLATE system
 22531                                  ; *		 call to get the real name and  then display the 
 22532                                  ; *		 real name. If an error occurs issue an error
 22533                                  ; *		 message and transfer control to  CERROR.
 22534                                  ; *
 22535                                  ; * INPUT:	 command line at offset 81H
 22536                                  ; *
 22537                                  ; * OUTPUT:	 none
 22538                                  ; *
 22539                                  ; ****************************************************************
 22540                                  
 22541                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22542                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2197h
 22543                                  
 22544                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22545                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2741h
 22546                                  
 22547                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 22548                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:257Dh
 22549                                  
 22550                                  TRUENAME:				;AN000; TRUENAME entry point
 22551 00002484 1E                      	push	ds			;AN000; Get local ES
 22552 00002485 07                      	pop	es			;AN000;
 22553 00002486 BE8100                  	mov	si,81h			;AN000; Get command line
 22554 00002489 BF[8596]                	mov	di,PARSE_CHDIR		;AN000; Get address of PARSE_CHDIR
 22555 0000248C 31C9                    	xor	cx,cx			;AN000; clear cx,dx
 22556 0000248E 31D2                    	xor	dx,dx			;AN000;
 22557 00002490 E8C600                  	call	Parse_With_Msg		;AC018; call parser
 22558                                  
 22559 00002493 BF[8199]                	mov	di,SRCXNAME		;AN000; get address of srcxname
 22560                                  	;cmp	ax,0FFFFh
 22561                                  	;;cmp	ax,END_OF_LINE		;AN000; are we at end of line?
 22562                                  	;je	short tn_eol		;AN000; yes - go process
 22563                                  	;; 22/02/2023
 22564                                  	;;cmp	ax,0
 22565                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 22566                                  	;;jne	short tn_parse_error	;AN000; yes - go issue message
 22567                                  	;and	ax,ax ; ax = 0 ?
 22568                                  	;jnz	short tn_parse_error ; no, parse error	
 22569                                  	; 10/06/2023
 22570 00002496 40                      	inc	ax  ; 0FFFFh -> 0 ; cmp ax,0FFFFh
 22571 00002497 7433                    	jz	short tn_eol ; ah = 0 ; *
 22572 00002499 48                      	dec	ax  ; 1 -> 0 ; cmp ax, 0
 22573 0000249A 752D                    	jnz	short tn_parse_error
 22574                                  	
 22575                                  	;cmp	byte [PARSE1_TYPE],6
 22576 0000249C 803E[4BA6]06            	cmp	byte [PARSE1_TYPE],result_drive
 22577                                  					;AN000; was a drive entered?
 22578                                  	;je	short tn_drive		;AN000; yes - go process
 22579                                  	;jmp	short tn_filespec	;AN000; nothing else - must be filespec
 22580                                  	; 23/02/2023
 22581 000024A1 7512                    	jne	short tn_filespec
 22582                                  
 22583                                  ;tn_eol: 
 22584                                  ;	;mov	ah,0			;AN000; no parameters on line
 22585                                  ;	mov	ah,END_OF_LINE_OUT	;AN000; set buffer to .
 22586                                  ;	;mov	al,dot_chr		;AN000;   for current dir
 22587                                  ;	mov	al,'.'
 22588                                  ;	stosw				;AN000; store in srcxname
 22589                                  ;	jmp	short tn_doit		;AN000; go do command
 22590                                  
 22591                                  tn_drive:				;AN000; a drive was entered
 22592 000024A3 56                      	push	si			;AN000; save position in line
 22593 000024A4 BE[4FA6]                	mov	si,PARSE1_ADDR		;AN000; get address of drive
 22594 000024A7 AC                      	lodsb				;AN000; get the drive number
 22595 000024A8 0440                    	add	al,"A"-1 ; 40h		;AN000; convert it to char
 22596 000024AA AA                      	stosb				;AN000; store it in srcxname
 22597                                  	;mov	ax,dot_colon		;AN000; get colon and . and
 22598 000024AB B83A2E                  	mov	ax,':.' ; 2E3Ah ; ah=".", al=":"
 22599 000024AE AB                      	stosw				;AN000;  store in srcxname
 22600                                  	;mov	al,0
 22601 000024AF B000                    	mov	al,END_OF_LINE_OUT	;AN000; put a terminator char
 22602 000024B1 AA                      	stosb				;AN000;
 22603 000024B2 5E                      	pop	si			;AN000; get line position back
 22604 000024B3 EB0C                    	jmp	short tn_check_eol	;AN000; check to make sure eol
 22605                                  
 22606                                  tn_filespec:				;AN000; a filespec was entered
 22607 000024B5 56                      	push	si			;AN000; save position in line
 22608 000024B6 C536[4FA6]              	lds	si,[PARSE1_ADDR]	;AN000; get address of filespec
 22609                                  
 22610                                  tn_move_filename:			;AN000; put filespec in srcxname
 22611 000024BA AC                      	lodsb				;AN000; get a char from buffer
 22612 000024BB AA                      	stosb				;AN000; store in srcxname
 22613                                  	;;cmp	al,0
 22614                                  	;cmp	al,END_OF_LINE_OUT	;AN000; it char a terminator?
 22615 000024BC 08C0                    	or	al,al ; al = 0 ?
 22616 000024BE 75FA                    	jnz	short tn_move_filename	;AN000; no - keep moving
 22617 000024C0 5E                      	pop	si			;AN000; get line position back
 22618                                  
 22619                                  tn_check_eol:				;AN000; make sure no extra parms
 22620 000024C1 BF[8596]                	mov	di,PARSE_CHDIR		;AN000; get address of parse_chdir
 22621 000024C4 E87C00                  	call	parse_check_eol 	;AN000; are we at end of line?
 22622 000024C7 7406                    	jz	short tn_doit 		;AN000; Yes - do the command
 22623                                  tn_parse_error: 			;AN000; A parse error occurred
 22624 000024C9 E95808                  	jmp	cerror			;AN000; Go to error routine
 22625                                  
 22626                                  tn_eol: 
 22627                                  	;23/02/2023
 22628                                  	;;mov	ah,0			;AN000; no parameters on line
 22629                                  	;mov	ah,END_OF_LINE_OUT	;AN000; set buffer to .
 22630                                  	;;mov	al,dot_chr		;AN000;   for current dir
 22631                                  	;mov	al,'.'
 22632                                  	; 10/06/2023
 22633                                  	;mov	ax,002Eh
 22634                                  	; ah = 0 ; *
 22635 000024CC B02E                    	mov	al,'.'  ;dot_chr ; 2Eh
 22636                                  	;	
 22637 000024CE AB                      	stosw				;AN000; store in srcxname
 22638                                  	; 23/02/2023
 22639                                  	;jmp	short tn_doit		;AN000; go do command
 22640                                  
 22641                                  tn_doit:				;AN000;
 22642 000024CF BE[8199]                	mov	si,SRCXNAME		;AN000; set up srcxname as source
 22643 000024D2 BF[B29A]                	mov	di,COMBUF		;AN000; set up combuf as target (need big target)
 22644 000024D5 B460                    	mov	ah,xNameTrans		;AN000; do name translate call
 22645                                  	;mov	ah,60h
 22646 000024D7 CD21                    	int	21h			;AN000;
 22647 000024D9 7311                    	jnc	short tn_print_xname	;AN000; If no error - print result
 22648                                  
 22649 000024DB E85BFB                  	call	Set_Ext_Error_Msg	;AN000; get extended message
 22650 000024DE C706[019E][8199]        	mov	word [string_ptr_2],SRCXNAME
 22651                                  					;AN000; get address of failed string
 22652                                  	;mov	byte [extend_buf_sub],1
 22653 000024E4 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 22654                                  					;AN000; put number of subst in control block
 22655 000024E9 E93808                  	jmp	cerror			;AN000; Go to error routine
 22656                                  
 22657                                  tn_print_xname: 			;AN000;
 22658 000024EC C706[019E][B29A]        	mov	word [string_ptr_2],COMBUF
 22659                                  					;AN000; Set up address of combuf
 22660 000024F2 BA[D391]                	mov	dx,string_buf_ptr	;AN000; Set up address of print control block
 22661 000024F5 E87F04                  	call	CRLF2			;AN000; print a crlf
 22662                                  	;call	Printf_Crlf		;AN000; print it out
 22663                                  	;retn				;AN000;
 22664                                  	; 23/02/2023
 22665 000024F8 E9142F                  	jmp	Printf_Crlf
 22666                                  
 22667                                  ; ---------------------------------------------------------------------------
 22668                                  
 22669                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22670                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2219h
 22671                                  
 22672                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22673                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:27C3h
 22674                                  
 22675                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22676                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2600h
 22677                                  _$EXIT:
 22678                                  	; MSDOS 6.0
 22679 000024FB 1E                      	push	ds			;AN000; save data segment
 22680 000024FC 8E1E[539C]              	mov	ds,[RESSEG]		;AN000; get resident data segment
 22681                                  	;assume	ds:resgroup		;AN000;
 22682                                  
 22683 00002500 803E[A202]00            	cmp	byte [PermCom],0	;AN045; is this a permanent COMMAND?
 22684 00002505 740A                    	jz	short free_com		;AN045; no - free everything
 22685                                  
 22686                                  ;	We're a permanent command.
 22687                                  ;	Unless this is a singlecom (int 2Eh), don't deallocate transient.
 22688                                  
 22689 00002507 833E[A502]FF            	cmp	word [SingleCom],-1	;M034
 22690 0000250C 7403                    	je	short no_reset		;M034 ; exit singlecom
 22691 0000250E E9F3DB                  	jmp	TCOMMAND		;permanent command, recycle
 22692                                  
 22693                                  free_com:
 22694                                  
 22695                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 22696                                  %if 0
 22697                                  	;mov	ax,(multdos shl 8 or message_2f)
 22698                                  	mov	ax,122Eh		;AN060; reset parse message pointers
 22699                                  	;mov	dl,SET_CRITICAL_MSG	;AN000; set up critical error message address
 22700                                  	mov	dl,5
 22701                                  	mov	di,[Crit_Msg_Off] 	;AN000; old offset of critical messages
 22702                                  	mov	es,[Crit_Msg_Seg] 	;AN000; old segment of critical messages
 22703                                  	int	2Fh			;AN000; go set it
 22704                                  %endif
 22705                                  
 22706                                  no_reset:				;AN045;
 22707 00002511 1F                      	pop	ds			;AN000; restore local data segment
 22708                                  	;assume	ds:trangroup		;AN000;
 22709                                  ;M040
 22710                                  ; Restore user directory if the restore flag is set. RestUDir1 checks for
 22711                                  ;this, restores user dir if flag is set and resets the flag.
 22712                                  
 22713                                  	;invoke	RestUDir1		;restore user dir if needed ;M040
 22714 00002512 E80C03                  	call	RestUDir1
 22715 00002515 8E06[539C]              	mov	es,[RESSEG]
 22716                                  	;assume	es:resgroup
 22717                                  
 22718 00002519 26A1[3E02]              	mov	ax,[es:Parent]
 22719                                  	;mov	[es:16h],ax
 22720                                  	;mov	[es:PDB_Parent_PID],ax
 22721 0000251D 26A31600                	mov	[es:PDB.PARENT_PID],ax
 22722 00002521 26A1[4002]              	mov	ax,[es:OldTerm]
 22723                                  	;mov	[es:0Ah],ax
 22724                                  	;mov	[es:PDB_Exit],ax
 22725 00002525 26A30A00                	mov	[es:PDB.EXIT],ax
 22726 00002529 26A1[4202]              	mov	ax,[es:OldTerm+2]
 22727                                  	;mov	[es:0Ch],ax
 22728                                  	;mov	[es:PDB_Exit+2],ax
 22729 0000252D 26A30C00                	mov	[es:PDB.EXIT+2],ax
 22730                                  
 22731 00002531 06                      	push	es
 22732 00002532 8E06[639C]              	mov	es,[TRAN_TPA]
 22733                                  	;mov	ah,DEALLOC
 22734 00002536 B449                    	mov	ah,49h
 22735 00002538 CD21                    	int	21h			; Now running in "free" space
 22736 0000253A 07                      	pop	es
 22737                                  
 22738                                  	;mov	ah,Exit
 22739 0000253B B44C                    	mov	ah,4Ch
 22740                                  	;mov	al,byte ptr RetCode
 22741 0000253D 26A0[9A02]              	mov	al,[es:RetCode]
 22742 00002541 CD21                    	int	21h
 22743                                  
 22744                                  ; ---------------------------------------------------------------------------
 22745                                  
 22746                                  ; MSDOS 6.0
 22747                                  ; ****************************************************************
 22748                                  ; *
 22749                                  ; * ROUTINE:	 PARSE_CHECK_EOL
 22750                                  ; *
 22751                                  ; * FUNCTION:	 Calls parser to see if end of line occurred.
 22752                                  ; *		 If not end of line, set up to print parse
 22753                                  ; *		 error message. ASSUMES NO MORE PARAMETERS ARE
 22754                                  ; *		 EXPECTED!
 22755                                  ; *
 22756                                  ; * INPUT:	 DS:SI	  last output from parser
 22757                                  ; *		 ES:DI	  points to parse block
 22758                                  ; *		 CX	  last output from parser
 22759                                  ; *
 22760                                  ; * OUTPUT:	 AX	  parser return code
 22761                                  ; *
 22762                                  ; *		 if end of line found
 22763                                  ; *		     zero flag set
 22764                                  ; *		 else
 22765                                  ; *		     MSG_DISPLAY_CLASS set to parse error
 22766                                  ; *
 22767                                  ; ****************************************************************
 22768                                  
 22769                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22770                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2270h
 22771                                  
 22772                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22773                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2648h
 22774                                  parse_check_eol:
 22775 00002543 31D2                    	xor	dx,dx			;AN000;
 22776 00002545 8936[F99D]              	mov	[parse_last],si 	;AN018; save start of parameter
 22777 00002549 E80024                  	call	cmd_parse		;AN000; call parser
 22778 0000254C 3CFF                    	cmp	al,-1 ; 0FFh
 22779                                  	;cmp	al,END_OF_LINE	; 0FFh	;AN000; Are we at end of line?
 22780 0000254E 7408                    	je	short parse_good_eol	;AN000; yes - no problem
 22781                                  	;cmp	ax,0
 22782                                  	;cmp	ax,RESULT_NO_ERROR	;AN018; was any error found?
 22783 00002550 21C0                    	and	ax,ax ; ax = 0 ?
 22784 00002552 7501                    	jnz	short ok_to_setup_pmsg	;AN018; yes - continue
 22785 00002554 40                      	inc	ax			;AN018; set AX to 1 and turn off zero flag
 22786                                  ok_to_setup_pmsg:
 22787 00002555 E81000                  	call	setup_parse_error_msg	;AN018; go set up error message
 22788                                  parse_good_eol:
 22789                                  parse_msg_good:	; 23/02/2023
 22790 00002558 C3                      	retn				;AN000;
 22791                                  
 22792                                  ; ---------------------------------------------------------------------------
 22793                                  
 22794                                  ; MSDOS 6.0
 22795                                  ; ****************************************************************
 22796                                  ; *
 22797                                  ; * ROUTINE:	 PARSE_WITH_MSG
 22798                                  ; *
 22799                                  ; * FUNCTION:	 Calls parser. If an error occurred, the error
 22800                                  ; *		 message is set up.
 22801                                  ; *
 22802                                  ; * INPUT:	 DS:SI	  last output from parser
 22803                                  ; *		 ES:DI	  points to parse block
 22804                                  ; *		 CX	  last output from parser
 22805                                  ; *
 22806                                  ; * OUTPUT:	 AX	  parser return code
 22807                                  ; *
 22808                                  ; *		 if no error
 22809                                  ; *		     outputs from parser
 22810                                  ; *		 else
 22811                                  ; *		     MSG_DISPLAY_CLASS set to parse error
 22812                                  ; *		     error message set up for STD_PRINTF
 22813                                  ; *
 22814                                  ; ****************************************************************
 22815                                  
 22816                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22817                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22818                                  Parse_With_Msg:
 22819 00002559 8936[F99D]              	mov	[parse_last],si 	;AN018; save start of parameter
 22820 0000255D E8EC23                  	call	cmd_parse		;AN018; call parser
 22821 00002560 3CFF                    	cmp	al,-1 ; 0FFh
 22822                                  	;cmp	al,END_OF_LINE	; 0FFh	;AN018; Are we at end of line?
 22823 00002562 74F4                    	je	short parse_msg_good	;AN018; yes - no problem
 22824                                  	;cmp	ax,0
 22825                                  	;cmp	ax,RESULT_NO_ERROR	;AN018; did an error occur
 22826 00002564 09C0                    	or	ax,ax ; ax = 0 ?
 22827 00002566 74F0                    	jz	short parse_msg_good	;AN018; yes - no problem
 22828                                  	; 23/02/2023
 22829                                  	;call	setup_parse_error_msg	;AN018; go set up error message
 22830                                  ;parse_msg_good:
 22831                                  	;retn				;AN018;
 22832                                  	; 23/02/2023
 22833                                  	;jmp	short setup_parse_error_msg	
 22834                                  
 22835                                  ; ---------------------------------------------------------------------------
 22836                                  
 22837                                  ; MSDOS 6.0
 22838                                  ; ****************************************************************
 22839                                  ; *
 22840                                  ; * ROUTINE:	 SETUP_PARSE_ERROR_MSG
 22841                                  ; *
 22842                                  ; * FUNCTION:	 Calls parser.	If an error occurred, the error
 22843                                  ; *		 message is set up.
 22844                                  ; *
 22845                                  ; * INPUT:	 AX	     Parse error number
 22846                                  ; *		 SI	     Set to past last parameter
 22847                                  ; *		 Parse_last  Set to start of last parameter
 22848                                  ; *
 22849                                  ; * OUTPUT:	 MSG_DISPLAY_CLASS set to parse error
 22850                                  ; *		 error message set up for STD_PRINTF
 22851                                  ; *
 22852                                  ; ****************************************************************
 22853                                  
 22854                                  	; 23/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 22855                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22856                                  setup_parse_error_msg:
 22857 00002568 C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class
 22858                                  	;mov	byte [msg_disp_class],2	;AC018; Set up parse message class
 22859 0000256D BA[CB8F]                	mov	dx,extend_buf_ptr	;AC018; get extended message pointer
 22860 00002570 C60400                  	mov	byte [si],END_OF_LINE_OUT ; 0
 22861                                  					;AC018; terminate the parameter string
 22862 00002573 A3[CB8F]                	mov	[extend_buf_ptr],ax	;AC018; get message number in control block
 22863 00002576 83F802                  	cmp	ax,2
 22864                                  	;cmp	ax,LessArgs_Ptr 	;AC018; if required parameter missing
 22865 00002579 740D                    	je	short setup_parse_msg_ret
 22866                                  					;AN018;    no subst
 22867 0000257B 8B36[F99D]              	mov	si,[parse_last] 	;AC018; get start of parameter
 22868 0000257F 8936[019E]              	mov	[string_ptr_2],si 	;AC018; get address of failed string
 22869 00002583 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 22870                                  					;AC018; put number of subst in control block
 22871                                  	;mov	byte [extend_buf_sub],1
 22872                                  setup_parse_msg_ret:
 22873 00002588 46                      	inc	si			;AN018; make sure zero flag not set
 22874 00002589 C3                      	retn				;AC018;
 22875                                  
 22876                                  ;============================================================================
 22877                                  ; TENV.ASM, MSDOS 6.0, 1991
 22878                                  ;============================================================================
 22879                                  ; 08/10/2018 - Retro DOS v3.0
 22880                                  
 22881                                  ; TITLE	Part6 COMMAND Transient routines.
 22882                                  
 22883                                  ;	Environment utilities and misc. routines
 22884                                  
 22885                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1690h
 22886                                  
 22887                                  ; 23/02/2023 - Retro DOS v4.0 (& v4.1)
 22888                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 22BDh
 22889                                  
 22890                                  ; ---------------------------------------------------------------------------
 22891                                  
 22892                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 22893                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 22894                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 22895                                  ADD_PROMPT:
 22896 0000258A E8FC00                  	call	delete_prompt	; Delete any existing prompt
 22897 0000258D E8AD01                  	call	scan_double_null
 22898                                  
 22899                                  ADD_PROMPT2:
 22900 00002590 56                      	push	si
 22901 00002591 E89B01                  	call	GETARG
 22902 00002594 5E                      	pop	si
 22903 00002595 7501                    	jnz	short ADD_PROMPT3
 22904                                  ADD_PROMPT_RETN:
 22905 00002597 C3                      	retn
 22906                                  ADD_PROMPT3:			; Pre scan for arguments
 22907 00002598 E87501                  	call	move_name	; Move in name
 22908 0000259B E89101                  	call	GETARG
 22909 0000259E 56                      	push	si
 22910 0000259F EB53                    	jmp	short ADD_NAME
 22911                                  
 22912                                  ;break	The SET command
 22913                                  
 22914                                  ; Input: DS:SI points to a CR terminated string
 22915                                  ; Output: carry flag is set if no room
 22916                                  ;	  otherwise name is added to environment
 22917                                  
 22918                                  DISP_ENVJ:
 22919 000025A1 E9BC00                  	jmp	DISP_ENV
 22920                                  
 22921                                  ADD_NAME_TO_ENVIRONMENT:
 22922 000025A4 E88801                  	call	GETARG
 22923 000025A7 74F8                    	jz	short DISP_ENVJ
 22924                                  
 22925                                  ; check if line contains exactly one equals sign
 22926                                  
 22927 000025A9 31DB                    	xor	bx,bx		; = count is 0
 22928 000025AB 56                      	push	si		; Save pointer to beginning of line
 22929                                  EQLP:
 22930 000025AC AC                      	lodsb			; Get a char
 22931 000025AD 3C0D                    	cmp	al,13 ; 0Dh	; IF CR we're all done
 22932 000025AF 740F                    	je	short QUEQ	
 22933 000025B1 3C3D                    	cmp	al,'='		; Look for = sign	
 22934 000025B3 75F7                    	jne	short EQLP	; not there, get next char
 22935 000025B5 FEC3                    	inc	bl		; Otherwise increment EQ count
 22936 000025B7 803C0D                  	cmp	byte [si],13	; Look for CR following = sign
 22937 000025BA 75F0                    	jne	short EQLP
 22938 000025BC FEC7                    	inc	bh		; Set BH=1 means no parameters
 22939 000025BE EBEC                    	jmp	short EQLP	; And look for more
 22940                                  QUEQ:
 22941 000025C0 5E                      	pop	si		; Restore beginning of line
 22942 000025C1 FECB                    	dec	bl		; Zero flag means only one EQ
 22943 000025C3 7406                    	jz	short ONEQ	; Good line
 22944 000025C5 BA[9E90]                	mov	dx,SYNTMES_PTR
 22945 000025C8 E95907                  	jmp	cerror
 22946                                  ONEQ:
 22947 000025CB 53                      	push	bx
 22948 000025CC E8BD00                  	call	delete_name_in_environment
 22949 000025CF 5B                      	pop	bx
 22950 000025D0 FECF                    	dec	bh
 22951 000025D2 74C3                    	jz	short ADD_PROMPT_RETN
 22952 000025D4 E86601                  	call	scan_double_null
 22953 000025D7 89FB                    	mov	bx,di		; Save ptr to beginning of env var name
 22954 000025D9 E83401                  	call	move_name
 22955 000025DC 56                      	push	si
 22956 000025DD 87DF                    	xchg	bx,di		; Switch ptrs to beginning and end of
 22957                                  				;  env var name
 22958                                  		
 22959                                  ; We want to special-case COMSPEC. This is to reduce the amount of code
 22960                                  ; necessary in the resident for re-reading the transient. Let's look for
 22961                                  ; COMSPEC=
 22962                                  
 22963 000025DF C606[D795]00            	mov	byte [comspec_flag],0 ; MSDOS 6.0 ; clear flag ; M024
 22964 000025E4 BE[F192]                	mov	si,COMSPECSTR ; "COMSPEC="
 22965 000025E7 B90400                  	mov	cx,4
 22966 000025EA F3A7                    	repe	cmpsw
 22967 000025EC 7504                    	jnz	short NOT_COMSPEC
 22968                                  				; Zero set => exact match
 22969 000025EE FE06[D795]              	inc	byte [comspec_flag] ; MSDOS 6.0 ; comspec is changing ; M024
 22970                                  	;mov	byte [COMSPEC_FLAG],1
 22971                                  NOT_COMSPEC:
 22972 000025F2 89DF                    	mov	di,bx		; Load ptr to end of env var name
 22973                                  ADD_NAME:
 22974 000025F4 5E                      	pop	si		; Add the value of the new env var
 22975 000025F5 56                      	push	si		;  to the environment.
 22976                                  ADD_NAME1:
 22977 000025F6 AC                      	lodsb
 22978 000025F7 3C0D                    	cmp	al,13 ; 0Dh
 22979 000025F9 7405                    	je	short ADD_NAME_RET
 22980 000025FB E8AD01                  	call	store_char
 22981 000025FE EBF6                    	jmp	short ADD_NAME1
 22982                                  ADD_NAME_RET:
 22983 00002600 5E                      	pop	si
 22984 00002601 803E[D795]00            	cmp	byte [comspec_flag],0
 22985                                  				; If the new env var is comspec,	
 22986                                  ADD_NAME_JZ_RET:
 22987 00002606 748F                    	jz	short ADD_PROMPT_RETN 
 22988                                  				;  copy the value into the
 22989                                  				;  comspec var in the resident
 22990                                  
 22991                                  ; We have changed the COMSPEC variable. We need to update the resident
 22992                                  ; pieces necessary to reread in the info. First, skip all delimiters
 22993                                  
 22994 00002608 E87903                  	call	scanoff
 22995 0000260B 8E06[539C]              	mov	es,[RESSEG]	;  comspec var in the resident
 22996                                  
 22997                                  ; Make sure that the printer knows where the beginning of the string is
 22998                                  
 22999 0000260F BF[4B02]                	mov	di,ComSpec
 23000 00002612 89FB                    	mov	bx,di
 23001                                  
 23002                                  ; Generate drive letter for display
 23003                                  
 23004 00002614 31C0                    	xor	ax,ax		;g assume no drive first
 23005 00002616 26A2[9402]              	mov	[es:ComDrv],al
 23006                                  	; 23/02/2023
 23007                                  	; MSDOS 6.0 (& 5.0)
 23008 0000261A 50                      	push	ax		;AN000; 3/3/KK
 23009 0000261B 8A04                    	mov	al,[si]		;AN000; 3/3/KK
 23010 0000261D E83F01                  	call	testkanj	;AN000; 3/3/KK	
 23011 00002620 58                      	pop	ax		;AN000; 3/3/KK
 23012 00002621 7518                    	jnz	short _GOTDRIVE
 23013                                  	;
 23014 00002623 807C013A                	cmp	byte [si+1],':'	; drive specified?
 23015 00002627 7512                    	jne	short _GOTDRIVE
 23016 00002629 8A04                    	mov	al,[si]		; get his specified drive
 23017                                  	; 23/02/2023
 23018 0000262B E85B01                  	call	UPCONV
 23019                                  	;call	UPCONV_MAPCALL	; convert to uppercase
 23020 0000262E 2C41                    	sub	al,'A'		; convert to 0-based
 23021 00002630 83C702                  	add	di,2
 23022 00002633 FEC0                    	inc	al		; convert to 1-based number
 23023 00002635 26A2[9402]              	mov	[es:ComDrv],al
 23024                                  
 23025                                  ; Stick the drive letter in the prompt message. Nothing special needs to be
 23026                                  ; done here..
 23027                                  	;add	al,40h
 23028 00002639 0440                    	add	al,'A'-1
 23029                                  _GOTDRIVE:
 23030                                  	; 23/02/2023
 23031                                  	;;mov	[es:0BD9h],di	; MSDOS 3.3 COMMAND.COM offset 1734h
 23032                                  	;mov	[es:PUTBACKSUBSTPTR],di
 23033                                  	;mov	[es:0233h],di	; MSDOS 5.0 COMMAND.COM offset 236Eh
 23034 0000263B 26893E[2A02]            	mov	[es:PutBackComSpec],di
 23035                                  				;g point to beginning of name after drive
 23036                                  	;;mov	[es:0A21h],al	; MSDOS 3.3 COMMAND.COM offset 1739h
 23037                                  	;mov	[es:PUTBACKDRV],al
 23038                                  	;mov	[es:0238h],al	; MSDOS 5.0 COMMAND.COM offset 2373h
 23039 00002640 26A2[2F02]              	mov	[es:PutBackDrv],al
 23040                                  
 23041                                  ; Copy chars until delim      	
 23042                                  
 23043 00002644 89DF                    	mov	di,bx
 23044                                  COPY_COMSPEC:
 23045 00002646 AC                      	lodsb
 23046 00002647 E84203                  	call	DELIM
 23047 0000264A 7407                    	jz	short COPYDONE
 23048 0000264C 3C0D                    	cmp	al,13 ; 0Dh
 23049 0000264E 7403                    	je	short COPYDONE
 23050 00002650 AA                      	stosb
 23051 00002651 EBF3                    	jmp	short COPY_COMSPEC
 23052                                  COPYDONE:
 23053 00002653 30C0                    	xor	al,al		; Null terminate the string and quit
 23054 00002655 AA                      	stosb
 23055                                  	;mov	byte [comspec_flag],0
 23056 00002656 A2[D795]                	mov	[comspec_flag],al ; 0 ; 23/02/2023
 23057 00002659 4F                      	dec	di
 23058 0000265A 26893E[8B02]            	mov	[es:ComSpec_End],di
 23059 0000265F C3                      	retn
 23060                                  
 23061                                  DISP_ENV:
 23062 00002660 8E1E[539C]              	mov	ds,[RESSEG]
 23063 00002664 8E1E[3A04]              	mov	ds,[EnvirSeg]
 23064                                  	; assume ds:nothing
 23065 00002668 31F6                    	xor	si,si
 23066                                  PENVLP:
 23067 0000266A 803C00                  	cmp	byte [si],0
 23068 0000266D 7497                    	jz	short ADD_NAME_JZ_RET
 23069 0000266F BF[F5A3]                	mov	di,Arg_Buf
 23070                                  PENVLP2:
 23071 00002672 AC                      	lodsb
 23072 00002673 AA                      	stosb
 23073 00002674 08C0                    	or	al,al
 23074 00002676 75FA                    	jnz	short PENVLP2
 23075 00002678 BA[8D91]                	mov	dx,arg_buf_ptr
 23076 0000267B 1E                      	push	ds
 23077 0000267C 06                      	push	es
 23078 0000267D 1F                      	pop	ds
 23079                                  	; assume ds:nothing
 23080 0000267E E88E2D                  	call	Printf_Crlf
 23081 00002681 1F                      	pop	ds
 23082 00002682 EBE6                    	jmp	short PENVLP
 23083                                  
 23084                                  ; =============== S U B	R O U T	I N E =======================================
 23085                                  
 23086                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23087                                  delete_path:
 23088 00002684 BE[E592]                	mov	si,PATH_TEXT ; "PATH="
 23089 00002687 EB03                    	jmp	short delete_name_in_environment
 23090                                  
 23091                                  ; =============== S U B	R O U T	I N E =======================================
 23092                                  
 23093                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23094                                  delete_prompt:
 23095 00002689 BE[EA92]                	mov	si,PROMPT_TEXT ; "PROMPT="
 23096                                  
 23097                                  ; ---------------------------------------------------------------------------
 23098                                  
 23099                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23100                                  delete_name_in_environment:
 23101                                  
 23102                                  ; Input: DS:SI points to a "=" terminated string
 23103                                  ; Output: carry flag is set if name not found
 23104                                  ;	  otherwise name is deleted
 23105                                  
 23106 0000268C 56                      	push	si
 23107 0000268D 1E                      	push	ds
 23108 0000268E E82C00                  	call	FIND		; ES:DI points to name
 23109 00002691 7217                    	jc	short del1
 23110 00002693 89FE                    	mov	si,di		; Save it
 23111 00002695 E8BF00                  	call	SCASB2		; Scan for the nul
 23112 00002698 87F7                    	xchg	si,di
 23113                                  ;SR;
 23114                                  ; If we have only one env string, then the double null is lost when the last
 23115                                  ;string is deleted and we have an invalid empty environment with only a
 23116                                  ;single null. To avoid this, we will look for the double null case and then
 23117                                  ;move an extra null char.
 23118                                  ; Bugbug: The only possible problem is that the last pathstring
 23119                                  ;will be followed by a triple null. Is this really a problem?
 23120                                  
 23121                                  	; MSDOS 6.0
 23122 0000269A 26803C00                	cmp	byte [es:si],0	;null char?
 23123 0000269E 7501                    	jnz	short not_dnull	;no, we are at a double null
 23124 000026A0 4E                      	dec	si		;point at the double null
 23125                                  not_dnull:
 23126                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23127 000026A1 E86901                  	call	GETENVSIZ
 23128 000026A4 29F1                    	sub	cx,si
 23129 000026A6 06                      	push	es
 23130 000026A7 1F                      	pop	ds		; ES:DI points to name
 23131                                  				; DS:SI points to next name
 23132 000026A8 F3A4                    	rep	movsb
 23133                                  del1:
 23134 000026AA 1F                      	pop	ds
 23135 000026AB 5E                      	pop	si
 23136                                  find_retn:
 23137 000026AC C3                      	retn
 23138                                  
 23139                                  ; =============== S U B	R O U T	I N E =======================================
 23140                                  
 23141                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23142                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:23E2h
 23143                                  find_path:
 23144 000026AD BE[E592]                	mov	si,PATH_TEXT ; "PATH="
 23145 000026B0 EB03                    	jmp	short find_name_in_environment
 23146                                  
 23147                                  ; =============== S U B	R O U T	I N E =======================================
 23148                                  
 23149                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23150                                  find_prompt:
 23151 000026B2 BE[EA92]                	mov	si,PROMPT_TEXT ; "PROMPT="
 23152                                  
 23153                                  ; ---------------------------------------------------------------------------
 23154                                  
 23155                                  find_name_in_environment:
 23156                                  
 23157                                  ; Input: DS:SI points to a "=" terminated string
 23158                                  ; Output: ES:DI points to the arguments in the environment
 23159                                  ;	  zero is set if name not found
 23160                                  ;	  carry flag is set if name not valid format
 23161                                  
 23162 000026B5 E80500                  	call	FIND		; Find the name
 23163 000026B8 72F2                    	jc	short find_retn	; Carry means not found	
 23164 000026BA E99600                  	jmp	SCASB1		; Scan for = sign
 23165                                  
 23166                                  ; ---------------------------------------------------------------------------
 23167                                  	;nop
 23168                                  
 23169                                  ; =============== S U B	R O U T	I N E =======================================
 23170                                  
 23171                                  ; On return of FIND1, ES:DI points to beginning of name
 23172                                  
 23173                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23174                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23175                                  FIND:
 23176 000026BD FC                      	cld
 23177 000026BE E84100                  	call	COUNT0		; CX = Length of name
 23178 000026C1 8E06[539C]              	mov	es,[RESSEG]
 23179                                  	;assume es:RESGROUP
 23180 000026C5 268E06[3A04]            	mov	es,[es:EnvirSeg]
 23181                                  	;assume es:NOTHING
 23182 000026CA 31FF                    	xor	di,di
 23183                                  find1:	
 23184 000026CC 51                      	push	cx
 23185 000026CD 56                      	push	si
 23186 000026CE 57                      	push	di
 23187                                  find11:
 23188 000026CF AC                      	lodsb
 23189                                  	; 23/02/2023 
 23190                                  	; MSDOS 6.0 (& 5.0)
 23191 000026D0 E88C00                  	call	testkanj	
 23192 000026D3 740F                    	jz	short notkanj3
 23193 000026D5 4E                      	dec	si
 23194 000026D6 AD                      	lodsw
 23195 000026D7 47                      	inc	di
 23196 000026D8 47                      	inc	di
 23197 000026D9 263B45FE                	cmp	ax,[es:di-2]
 23198 000026DD 7511                    	jne	short find12
 23199 000026DF 49                      	dec	cx
 23200 000026E0 E2ED                    	loop	find11
 23201 000026E2 EB0C                    	jmp	short find12
 23202                                  notkanj3:
 23203 000026E4 E8A200                  	call	UPCONV		; MSDOS 5.0 (& 6.0)
 23204                                  	;call	UPCONV_MAPCALL	; MSDOS 3.3
 23205 000026E7 47                      	inc	di
 23206 000026E8 263A45FF                	cmp	al,[es:di-1]
 23207 000026EC 7502                    	jne	short find12
 23208 000026EE E2DF                    	loop	find11
 23209                                  find12:
 23210 000026F0 5F                      	pop	di
 23211 000026F1 5E                      	pop	si
 23212 000026F2 59                      	pop	cx
 23213 000026F3 74B7                    	jz	short find_retn
 23214 000026F5 51                      	push	cx
 23215 000026F6 E85E00                  	call	SCASB2		; Scan for a nul
 23216 000026F9 59                      	pop	cx
 23217 000026FA 26803D00                	cmp	byte [es:di],0
 23218 000026FE 75CC                    	jnz	short find1
 23219 00002700 F9                      	stc			; Indicate not found
 23220 00002701 C3                      	retn
 23221                                  
 23222                                  ; =============== S U B	R O U T	I N E =======================================
 23223                                  
 23224                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23225                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2437h
 23226                                  COUNT0:
 23227 00002702 1E                      	push	ds
 23228 00002703 07                      	pop	es
 23229                                  	;assume es:nothing
 23230 00002704 89F7                    	mov	di,si
 23231                                  ;COUNT1:
 23232 00002706 57                      	push	di		; Count number of chars until "="
 23233 00002707 E84900                  	call	SCASB1
 23234                                  	; 23/02/2023
 23235                                  ;	jmp	short COUNTX
 23236                                  ;COUNT2:
 23237                                  ;	push	di		; Count number of chars until nul
 23238                                  ;	call	SCASB2
 23239                                  ;COUNTX:
 23240 0000270A 59                      	pop	cx
 23241 0000270B 29CF                    	sub	di,cx
 23242 0000270D 87F9                    	xchg	di,cx
 23243                                  move_name_retn:
 23244 0000270F C3                      	retn
 23245                                  
 23246                                  ; =============== S U B	R O U T	I N E =======================================
 23247                                  
 23248                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23249                                  move_name:
 23250 00002710 803C0D                  	cmp	byte [si],13 ; 0Dh
 23251 00002713 74FA                    	je	short move_name_retn
 23252 00002715 AC                      	lodsb
 23253                                  	; 23/02/2023 
 23254                                  	; MSDOS 6.0 (& 5.0)
 23255 00002716 E84600                  	call	testkanj		
 23256 00002719 7409                    	jz	short notkanj1
 23257 0000271B E88D00                  	call	store_char
 23258 0000271E AC                      	lodsb
 23259 0000271F E88900                  	call	store_char
 23260 00002722 EBEC                    	jmp	short move_name
 23261                                  notkanj1: 
 23262 00002724 E86200                  	call	UPCONV
 23263                                  	;call	UPCONV_MAPCALL ; MSDOS 3.3
 23264 00002727 E88100                  	call	store_char
 23265 0000272A 3C3D                    	cmp	al,'='
 23266 0000272C 75E2                    	jne	short move_name
 23267                                  getarg_retn:
 23268 0000272E C3                      	retn
 23269                                  
 23270                                  ; =============== S U B	R O U T	I N E =======================================
 23271                                  
 23272                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23273                                  GETARG:
 23274 0000272F BE8000                  	mov	si,80h
 23275 00002732 AC                      	lodsb
 23276 00002733 08C0                    	or	al,al
 23277 00002735 74F7                    	jz	short getarg_retn
 23278 00002737 E84A02                  	call	scanoff
 23279 0000273A 3C0D                    	cmp	al,13 ; 0Dh
 23280                                  sdn_retn:
 23281 0000273C C3                      	retn
 23282                                  
 23283                                  ; =============== S U B	R O U T	I N E =======================================
 23284                                  
 23285                                  ; Point ES:DI to the final NULL string. Note that in an empty environment,
 23286                                  ; there is NO double NULL, merely a string that is empty.
 23287                                  
 23288                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23289                                  scan_double_null:
 23290 0000273D 8E06[539C]              	mov	es,[RESSEG]
 23291 00002741 268E06[3A04]            	mov	es,[es:EnvirSeg]
 23292 00002746 31FF                    	xor	di,di
 23293                                  
 23294                                  ; Top cycle-point. If the string here is empty, then we are done
 23295                                  
 23296                                  sdn1:
 23297 00002748 26803D00                	cmp	byte [es:di],0	; nul string?
 23298 0000274C 74EE                    	jz	short sdn_retn	; yep, all done
 23299 0000274E E80600                  	call	SCASB2
 23300 00002751 EBF5                    	jmp	short sdn1
 23301                                  
 23302                                  ; =============== S U B	R O U T	I N E =======================================
 23303                                  
 23304                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23305                                  SCASB1:
 23306 00002753 B03D                    	mov	al,'='		; Scan for an =
 23307 00002755 EB02                    	jmp	short SCASBX
 23308                                  
 23309                                  ; =============== S U B	R O U T	I N E =======================================
 23310                                  
 23311                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23312                                  SCASB2:
 23313 00002757 30C0                    	xor	al,al		; Scan for a nul
 23314                                  
 23315                                  ; ---------------------------------------------------------------------------
 23316                                  
 23317                                  	; 23/02/2023
 23318                                  SCASBX:
 23319 00002759 B90001                  	mov	cx,256
 23320 0000275C F2AE                    	repne	scasb
 23321 0000275E C3                      	retn
 23322                                  
 23323                                  ; =============== S U B	R O U T	I N E =======================================
 23324                                  
 23325                                  ; MSDOS 6.0
 23326                                  
 23327                                  ;Bugbug: This is Kanji stuff - put it in conditionals
 23328                                  
 23329                                  	; 23/02/2023 - Retro DOS v4.0 COMMAND.COM
 23330                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:249Ah
 23331                                  
 23332                                  	; 26/07/2024 - Retro DOS v5.0 COMMAND.COM
 23333                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2872h
 23334                                  testkanj:
 23335 0000275F 1E                      	push	ds			;AN000;  3/3/KK
 23336 00002760 56                      	push	si			;AN000;  3/3/KK
 23337 00002761 50                      	push	ax			;AN000;  3/3/KK
 23338 00002762 2E8E1E[539C]            	mov	ds,[cs:RESSEG]		;AN000;  Get resident segment
 23339 00002767 C536[BA02]              	lds	si,[Dbcs_Vector_Addr]	;AN000;  get DBCS vector
 23340                                  ktlop:					;AN000;  3/3/KK
 23341 0000276B 833C00                  	cmp	word [si],0		;AN000;  end of Table 3/3/KK
 23342 0000276E 740E                    	je	short notlead 		;AN000;  3/3/KK
 23343 00002770 58                      	pop	ax			;AN000;  3/3/KK
 23344 00002771 50                      	push	ax			;AN000;  3/3/KK
 23345 00002772 3A04                    	cmp	al,[si]			;AN000;  3/3/KK
 23346 00002774 7208                    	jb	short notlead 		;AN000;  3/3/KK
 23347 00002776 46                      	inc	si			;AN000;  3/3/KK
 23348 00002777 3A04                    	cmp	al,[si]			;AN000;  3/3/KK
 23349 00002779 7607                    	jbe	short islead		;AN000;  3/3/KK
 23350 0000277B 46                      	inc	si			;AN000;  3/3/KK
 23351 0000277C EBED                    	jmp	short ktlop		;AN000;  try another range ; 3/3/KK
 23352                                  notlead:				;AN000;  3/3/KK
 23353 0000277E 31C0                    	xor	ax,ax			;AN000;  set zero 3/3/KK
 23354 00002780 EB03                    	jmp	short ktret		;AN000;  3/3/KK
 23355                                  islead: 				;AN000;  3/3/KK
 23356 00002782 31C0                    	xor	ax,ax			;AN000;  reset zero 3/3/KK
 23357 00002784 40                      	inc	ax			;AN000;  3/3/KK
 23358                                  ktret:					;AN000;  3/3/KK
 23359 00002785 58                      	pop	ax			;AN000;  3/3/KK
 23360 00002786 5E                      	pop	si			;AN000;  3/3/KK
 23361 00002787 1F                      	pop	ds			;AN000;  3/3/KK
 23362 00002788 C3                      	retn				;AN000;  3/3/KK
 23363                                  
 23364                                  ; =============== S U B	R O U T	I N E =======================================
 23365                                  
 23366                                  ; MSDOS 6.0
 23367                                  
 23368                                  ; ****************************************************************
 23369                                  ; *
 23370                                  ; * ROUTINE:	 UPCONV     (ADDED BY EMG 4.00)
 23371                                  ; *
 23372                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
 23373                                  ; *		 the character in AL from the file upper case table
 23374                                  ; *		 in DOS if character if above  ascii 128, else
 23375                                  ; *		 subtracts 20H if between "a" and "z".
 23376                                  ; *
 23377                                  ; * INPUT:	 AL	      char to be upper cased
 23378                                  ; *		 FUCASE_ADDR  set to the file upper case table
 23379                                  ; *
 23380                                  ; * OUTPUT:	 AL	      upper cased character
 23381                                  ; *
 23382                                  ; ****************************************************************
 23383                                  
 23384                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 23385                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:24C4h
 23386                                  
 23387                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23388                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2A6Eh
 23389                                  
 23390                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23391                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:289Ch
 23392                                  UPCONV:
 23393 00002789 3C80                    	cmp	al,80h			;AN000;  see if char is > ascii 128
 23394 0000278B 7213                    	jb	short oth_fucase	;AN000;  no - upper case math
 23395 0000278D 2C80                    	sub	al,80h			;AN000;  only upper 128 chars in table
 23396 0000278F 1E                      	push	ds			;AN000;
 23397 00002790 53                      	push	bx			;AN000;
 23398 00002791 8E1E[539C]              	mov	ds,[RESSEG]		;AN000;  get resident data segment
 23399                                  	;lds	bx,dword ptr FUCase_Addr+1
 23400 00002795 C51E[B602]              	lds	bx,[FUCase_Addr+1]	;AN000;  get table address
 23401 00002799 83C302                  	add	bx,2			;AN000;  skip over first word
 23402                                  	;xlat	ds:byte ptr [bx]	;AN000;  convert to upper case
 23403 0000279C D7                      	xlat
 23404 0000279D 5B                      	pop	bx			;AN000;
 23405 0000279E 1F                      	pop	ds			;AN000;
 23406                                  	;jmp	short upconv_end	;AN000;  we finished - exit
 23407                                  	; 10/06/2023
 23408                                  upconv_end:
 23409                                  	; 24/02/2023
 23410 0000279F C3                      	retn
 23411                                  oth_fucase:				;AN000;
 23412 000027A0 3C61                    	cmp	al,'a' ; small_a	;AC000; if between "a" and "z",
 23413 000027A2 72FB                    	jb	short upconv_end	;AC000;    subtract 20h to get
 23414 000027A4 3C7A                    	cmp	al,'z' ; small_z	;AC000;    upper case equivalent.
 23415 000027A6 77F7                    	ja	short upconv_end	;AC000;
 23416 000027A8 2C20                    	sub	al,20h			;AC000; Change lower-case to upper
 23417                                  ;upconv_end:	; 10/06/2023		;AN000;
 23418 000027AA C3                      	retn
 23419                                  
 23420                                  ; ---------------------------------------------------------------------------
 23421                                  
 23422                                  ; MSDOS 3.3
 23423                                  
 23424                                  	; 24/02/2023
 23425                                  ;UPCONV_MAPCALL:
 23426                                  	;			; If between "a" and "z"
 23427                                  	;cmp	al,[small_a]
 23428                                  	;jb	short UPCONV_END
 23429                                  	;cmp	al,[small_z]
 23430                                  	;ja	short UPCONV_END
 23431                                  	;sub	al,20h		; Change lower-case to upper
 23432                                  ;UPCONV_END:
 23433                                  	;call	far [cs:MAP_CALL] ; (far) call to char mapping routine 
 23434                                  	;			  ; 	  for (current) country
 23435                                  	;retn
 23436                                  
 23437                                  ; =============== S U B	R O U T	I N E =======================================
 23438                                  
 23439                                  ; STORE A CHAR IN environment, GROWING IT IF NECESSARY
 23440                                  
 23441                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 23442                                  store_char:
 23443 000027AB 51                      	push	cx
 23444 000027AC 53                      	push	bx
 23445                                  
 23446                                  	; 24/02/2023
 23447                                  	;;16/10/2018
 23448                                  	; MSDOS 6.0
 23449 000027AD 06                      	push	es		;AN056;*
 23450 000027AE 1E                      	push	ds		;AN056; Save local DS
 23451 000027AF 8E1E[539C]              	mov	ds,[RESSEG]	;AN056; Get resident segment
 23452 000027B3 8E06[3A04]              	mov	es,[EnvirSeg]	;AN056; Get environment segment
 23453 000027B7 1F                      	pop	ds		;AN056; Get local segment back
 23454                                  
 23455                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23456 000027B8 E85200                  	call	GETENVSIZ
 23457 000027BB 89CB                    	mov	bx,cx		; Save room for double nul
 23458 000027BD 83EB02                  	sub	bx,2
 23459 000027C0 39DF                    	cmp	di,bx
 23460 000027C2 723F                    	jb	short store1
 23461 000027C4 50                      	push	ax
 23462 000027C5 51                      	push	cx
 23463 000027C6 53                      	push	bx		; Save Size of environment
 23464 000027C7 E849E0                  	call	FREE_TPA
 23465 000027CA 5B                      	pop	bx
 23466 000027CB 83C302                  	add	bx,2		; Recover true environment size
 23467                                  
 23468 000027CE 81FB0080                	cmp	bx,8000h	; Don't let environment grow > 32K
 23469 000027D2 7203                    	jb	short envsiz_ok
 23470                                  bad_env_size:			;AN056;
 23471 000027D4 F9                      	stc
 23472 000027D5 EB16                    	jmp	short envnoset
 23473                                  	;nop
 23474                                  envsiz_ok:
 23475 000027D7 B104                    	mov	cl,4
 23476 000027D9 D3EB                    	shr	bx,cl		; Convert back to paragraphs
 23477 000027DB 43                      	inc	bx
 23478                                  	; 24/02/2023
 23479                                  	; MSDOS 6.0
 23480 000027DC 8CC1                    	mov	cx,es		;AN056; Get environment segment
 23481 000027DE 01D9                    	add	cx,bx		;AN056; Add in size of environment
 23482 000027E0 83C120                  	add	cx,20h		;AN056; Add in some TPA
 23483 000027E3 8CC8                    	mov	ax,cs		;AN056; Get the transient segment
 23484 000027E5 39C1                    	cmp	cx,ax		;AN056; Are we hitting the transient?
 23485 000027E7 73EB                    	jnb	short bad_env_size
 23486                                  				;AN056; Yes - don't do it!!!
 23487                                  	; MSDOS 3.3 (& MSDOS 6.0)
 23488 000027E9 B44A                    	mov	ah,4Ah
 23489                                  	;mov	ah,SETBLOCK ; 4Ah
 23490 000027EB CD21                    	int	21h	; DOS -	2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)
 23491                                  			; ES = segment address of block	to change
 23492                                  			; BX = new size	in paragraphs
 23493                                  envnoset:
 23494 000027ED 9C                      	pushf
 23495 000027EE 06                      	push	es
 23496 000027EF 8E06[539C]              	mov	es,[RESSEG]
 23497 000027F3 E82EE0                  	call	ALLOC_TPA
 23498 000027F6 07                      	pop	es
 23499 000027F7 9D                      	popf
 23500 000027F8 59                      	pop	cx
 23501 000027F9 58                      	pop	ax
 23502                                  	; 10/06/2023
 23503 000027FA 7307                    	jnc	short store1
 23504                                  	; 24/02/2023
 23505 000027FC 07                      	pop	es ; MSDOS 6.0	;AN056;*	
 23506                                  	;jnc	short store1
 23507 000027FD BA[E28F]                	mov	dx,ENVERR_PTR
 23508 00002800 E92105                  	jmp	cerror
 23509                                  store1:	
 23510 00002803 AA                      	stosb
 23511 00002804 26C7050000              	mov	word [es:di],0	; NULL IS AT END
 23512                                  	; 24/02/2023
 23513 00002809 07                      	pop	es ; MSDOS 6.0	;AN056;*
 23514 0000280A 5B                      	pop	bx
 23515 0000280B 59                      	pop	cx
 23516 0000280C C3                      	retn
 23517                                  
 23518                                  ; =============== S U B	R O U T	I N E =======================================
 23519                                  
 23520                                  	; 24/02/2023
 23521                                  GETENVSIZ:
 23522                                  
 23523                                  ;Get size of environment in bytes, rounded up to paragraph boundry
 23524                                  ;ES has environment segment
 23525                                  ;Size returned in CX, all other registers preserved
 23526                                  
 23527 0000280D 06                      	push	es
 23528 0000280E 50                      	push	ax
 23529 0000280F 8CC0                    	mov	ax,es
 23530 00002811 48                      	dec	ax		;Point at arena
 23531 00002812 8EC0                    	mov	es,ax
 23532                                  	;mov	ax,[es:3]
 23533 00002814 26A10300                	mov	ax,[es:ARENA.size]
 23534 00002818 B104                    	mov	cl,4
 23535 0000281A D3E0                    	shl	ax,cl		;Convert to bytes
 23536 0000281C 89C1                    	mov	cx,ax
 23537 0000281E 58                      	pop	ax
 23538 0000281F 07                      	pop	es
 23539                                  getenvsiz_retn:
 23540 00002820 C3                      	retn
 23541                                  
 23542                                  ; =============== S U B	R O U T	I N E =======================================
 23543                                  
 23544                                  	; 24/02/2023
 23545                                  RestUDir1:
 23546 00002821 1E                      	push	ds
 23547 00002822 8E1E[539C]              	mov	ds,[RESSEG]
 23548 00002826 803E[A102]00            	cmp	byte [RestDir],0
 23549 0000282B 1F                      	pop	ds
 23550 0000282C 74F2                    	jz	short getenvsiz_retn
 23551                                  
 23552                                  ; =============== S U B	R O U T	I N E =======================================
 23553                                  
 23554                                  	; 24/02/2023
 23555                                  RestUDir:
 23556 0000282E BA[359B]                	mov	dx,USERDIR1
 23557 00002831 B43B                    	mov	ah,3Bh
 23558                                  	;mov	ah,CHDir ; 3Bh
 23559 00002833 CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 23560                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 23561 00002835 30C0                    	xor	al,al
 23562                                  	;call	SETREST
 23563                                  	;retn
 23564                                  	; 24/02/2023
 23565 00002837 E9DA08                  	jmp	SETREST
 23566                                  
 23567                                  ;============================================================================
 23568                                  ; TENV2.ASM, MSDOS 6.0, 1991
 23569                                  ;============================================================================
 23570                                  ; 07/10/2018 - Retro DOS v3.0
 23571                                  
 23572                                  ; TITLE	Part6 COMMAND Transient routines.
 23573                                  
 23574                                  ;	Environment utilities and misc. routines
 23575                                  
 23576                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 18C2h
 23577                                  
 23578                                  ; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23579                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2577h
 23580                                  
 23581                                  ; ---------------------------------------------------------------------------
 23582                                  
 23583                                  ; ****************************************************************
 23584                                  ; *
 23585                                  ; * ROUTINE:	 $CHDIR
 23586                                  ; *
 23587                                  ; * FUNCTION:	 Entry point for CHDIR command. Parse the command
 23588                                  ; *		 line. If path is found, CHDIR to path. If a drive
 23589                                  ; *		 letter is found, get and display the current dir
 23590                                  ; *		 of the specified drive. If nothing is found, get
 23591                                  ; *		 and display the current dir of the default drive.
 23592                                  ; *
 23593                                  ; * INPUT:	 command line at offset 81H
 23594                                  ; *
 23595                                  ; * OUTPUT:	 none
 23596                                  ; *
 23597                                  ; ****************************************************************
 23598                                  
 23599                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23600                                  
 23601                                  	; 10/06/2023 - Retro DOS v4.2 COMMAND.COM
 23602                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2B21h
 23603                                  
 23604                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 23605                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:294Fh
 23606                                  
 23607                                  _$CHDIR:
 23608                                  	; MSDOS 6.0
 23609 0000283A BE8100                  	mov	si,81h
 23610 0000283D BF[8596]                	mov	di,PARSE_CHDIR
 23611                                  				;AN000; Get address of PARSE_CHDIR
 23612 00002840 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 23613 00002842 31D2                    	xor	dx,dx		;AN000;
 23614 00002844 E812FD                  	call	Parse_With_Msg	;AC018; call parser
 23615                                  	
 23616                                  	;cmp	ax,-1
 23617                                  	;;cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 23618                                  	;je	short bwdj	; No args
 23619                                  	;;cmp	ax,0
 23620                                  	;;cmp	ax,RESULT_NO_ERROR
 23621                                  	;			;AC000; did we have an error?
 23622                                  	;or	ax,ax ; ax = 0 ?
 23623                                  	;jnz	short ChDirErr	;AC018; yes - exit
 23624                                  	
 23625                                  	; 10/06/2023
 23626 00002847 40                      	inc	ax	; cmp ax,-1
 23627 00002848 7414                    	jz	short bwdj ; 0FFFFh -> 0
 23628 0000284A 48                      	dec	ax	; cmp ax,0
 23629 0000284B 756F                    	jnz	short ChDirErr ; 1 -> 0
 23630                                  	; ax = 0
 23631                                  
 23632                                  	;cmp	byte [PARSE1_TYPE],6
 23633 0000284D 803E[4BA6]06            	cmp	byte [PARSE1_TYPE],result_drive
 23634                                  				;AC000; was a drive entered?
 23635 00002852 7511                    	jne	short REALCD	; no
 23636                                  
 23637                                  ; D: was found. See if there is anything more.
 23638                                  
 23639 00002854 BF[8596]                	mov	di,PARSE_CHDIR
 23640                                  				;AC000; get address of parse_chdir
 23641 00002857 31D2                    	xor	dx,dx		;AC000;
 23642 00002859 E8E7FC                  	call	parse_check_eol ;AC000; call parser
 23643 0000285C 755E                    	jnz	short ChDirErr	;AC000;
 23644                                  bwdj:
 23645 0000285E E88AF9                  	call	build_dir_for_chdir
 23646                                  				; Drive only specified
 23647 00002861 E81301                  	call	CRLF2
 23648                                  chdir_retn:
 23649 00002864 C3                      	retn
 23650                                  
 23651                                  	; 24/02/2023
 23652                                  	; MSDOS 3.3
 23653                                  	;mov	ax,[COMSW]
 23654                                  	;or	ax,[ALLSWITCH]
 23655                                  	;mov	dx,BADPARMPTR
 23656                                  	;jnz	short CHDIR_ERR
 23657                                  	;mov	si,81h
 23658                                  	;call	SCANOFF
 23659                                  	;cmp	al,0Dh		; are we at end of line?
 23660                                  	;je	short BWDJ	; No args
 23661                                  	;inc	si
 23662                                  	;lodsb
 23663                                  	;cmp	al,':'
 23664                                  	;jne	short REALCD
 23665                                  	;push	si
 23666                                  	;call	SCANOFF
 23667                                  	;pop	si
 23668                                  	;cmp	al,0Dh		; was a drive entered?
 23669                                  	;jne	short REALCD	; no
 23670                                  ;BWDJ:
 23671                                  	;call	BUILD_DIR_FOR_CHDIR ; Drive only specified
 23672                                  	;call	CRLF2
 23673                                  ;CHDIR_RETN:
 23674                                  	;retn
 23675                                  
 23676                                  	; 24/02/2023
 23677                                  	; MSDOS 6.0
 23678                                  REALCD:
 23679 00002865 56                      	push	si		;AN000; save position in line
 23680 00002866 C536[4FA6]              	lds	si,[PARSE1_ADDR]
 23681                                  				;AN000; get address of filespec
 23682 0000286A E86908                  	call	Move_To_SrcBuf	;AN000; move to srcbuf
 23683 0000286D 5E                      	pop	si		;AN000; restore position in line
 23684 0000286E BF[8596]                	mov	di,PARSE_CHDIR	;AC000; get address of parse_chdir
 23685 00002871 31D2                    	xor	dx,dx		;AC000;
 23686 00002873 E8CDFC                  	call	parse_check_eol ;AC000; call parser
 23687 00002876 7544                    	jnz	short ChDirErr	;AC000;
 23688                                  	
 23689 00002878 E8A206                  	call	SETPATH
 23690 0000287B F606[1C9E]02            	test	byte [DestInfo],2
 23691 00002880 7519                    	jnz	short BadChDir
 23692                                  
 23693                                  	; 26/04/2023
 23694 00002882 B43B                    	mov	ah,3Bh
 23695                                  	;mov	ah,CHDir
 23696                                  	;int	21h
 23697                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23698 00002884 E833DD                  	call    int_21h_indirect
 23699 00002887 73DB                    	jnc	short chdir_retn
 23700                                  	
 23701 00002889 E8BDF7                  	call	get_ext_error_number
 23702                                  				;AN022; get the extended error
 23703 0000288C 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23704                                  				;AN022; see if path not found
 23705 0000288F 740A                    	je	short BadChDir	;AN022; yes - issue old message
 23706                                  ;SR;
 23707                                  ; We want to issue "Invalid Directory" message even if the path is valid
 23708                                  ;but is not a directory. The extended error returns "Access denied" which
 23709                                  ;is kind of confusing. Issue the old message if access denied error is 
 23710                                  ;returned
 23711                                  
 23712 00002891 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23713 00002894 7405                    	je	short BadChDir
 23714                                  	
 23715 00002896 E8A200                  	call	set_ext_error_subst ;AN022;
 23716 00002899 EB21                    	jmp	short ChDirErr	;AN022;
 23717                                  
 23718                                  BadChDir:
 23719 0000289B BA[2B91]                	mov	dx,badcd_ptr
 23720                                  ;ChDirErr:
 23721                                  ;	call	std_eprintf
 23722                                  ;mkdir_retn:
 23723                                  	;retn
 23724                                  	; 24/02/2023
 23725 0000289E EB1C                    	jmp	short ChDirErr	;AN022;
 23726                                  
 23727                                  	; 24/02/2023
 23728                                  	; MSDOS 3.3
 23729                                  ;REALCD:
 23730                                  	;call	SETPATH
 23731                                  	;test	byte [DESTINFO],2
 23732                                  	;jnz	short BADCHDIR
 23733                                  	;mov	ah,CHDir ; 3Bh
 23734                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 23735                                  	;		; DS:DX	-> ASCIZ directory name	(may include drive)
 23736                                  	;jnc	short CHDIR_RETN
 23737                                  ;BADCHDIR:
 23738                                  	;mov	dx,BADCDPTR
 23739                                  ;CHDIR_ERR:
 23740                                  	;call	STD_EPRINTF
 23741                                  ;MKDIR_RETN:
 23742                                  	;retn
 23743                                  
 23744                                  ; =============== S U B	R O U T	I N E =======================================
 23745                                  
 23746                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23747                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:25E2h
 23748                                  
 23749                                  	; 11/06/2023 - Retro DOS v4.2
 23750                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2B8Ch
 23751                                  
 23752                                  	; 04/08/2024 - Retro DOS v5.0
 23753                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:29BBh
 23754                                  
 23755                                  _$MKDIR:
 23756                                  	; MSDOS 6.0
 23757 000028A0 E86700                  	call	SETRMMK
 23758 000028A3 7217                    	jc	short MkDirErr
 23759                                  
 23760 000028A5 B439                    	mov	ah,39h
 23761                                  	;mov	ah,MKDIR
 23762                                  	;int	21h
 23763                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23764 000028A7 E810DD                  	call    int_21h_indirect
 23765 000028AA 7313                    	jnc	short mkdir_retn
 23766                                  
 23767 000028AC E89AF7                  	call	get_ext_error_number	
 23768                                  				;AN022; get the extended error
 23769 000028AF 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23770                                  				;AN022; see if path not found
 23771 000028B2 742C                    	je	short MD_other_err
 23772                                  				;AN022; yes - issue old message
 23773 000028B4 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23774                                  				;AN022; access denied?
 23775 000028B7 7407                    	je	short badmderr	;AN022; yes - see if file exists
 23776                                  	
 23777 000028B9 E87F00                  	call	set_ext_error_subst
 23778                                  				;AN022;
 23779                                  	;jmp	short MkDirerr	;AC022; yes - go print it
 23780                                  	; 24/02/2023
 23781                                  ChDirErr:
 23782                                  MkDirErr:
 23783                                  RmDirErr:
 23784 000028BC E8562B                  	call	std_eprintf
 23785                                  mkdir_retn:
 23786                                  rmdir_retn:
 23787 000028BF C3                      	retn
 23788                                  	
 23789                                  badmderr:
 23790 000028C0 BA[8199]                	mov	dx,SRCXNAME	;AN006; Set Disk transfer address
 23791 000028C3 B41A                    	mov	ah,1Ah
 23792                                  	;mov	ah,Set_DMA	;AN006;
 23793                                  	;int	21h		;AN006;
 23794                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23795 000028C5 E8F2DC                  	call    int_21h_indirect
 23796                                  	
 23797 000028C8 B44E                    	mov	ah,4Eh
 23798                                  	;mov	ah,Find_First	;AN006; see if file/dir exists
 23799                                  	;mov	cx,10h
 23800 000028CA B91000                  	mov	cx,ATTR_DIRECTORY
 23801                                  				;AN006;   search for directory
 23802                                  	;int	21h		;AN006;
 23803                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23804 000028CD E8EADC                  	call    int_21h_indirect
 23805 000028D0 720E                    	jc	short MD_other_err
 23806                                  				;AN006; doesn't exist - must be something else
 23807                                  	;;mov	dl,SRCXNAME.find_buf_attr
 23808                                  				;AN006; we found a file/dir
 23809                                  	;mov	dl,[SRCXNAME+21] 
 23810 000028D2 8A16[9699]              	mov	dl,[SRCXNAME+FIND_BUF.ATTR]
 23811 000028D6 F6C210                  	test	dl,ATTR_DIRECTORY
 23812                                  				;AN006; was it a directory?
 23813 000028D9 7405                    	jz	short MD_other_err
 23814                                  				;AN006; no - must have been a file
 23815 000028DB BA[3A92]                	mov	dx,MD_EXISTS_PTR
 23816                                  				;AN006; set up already exists error
 23817 000028DE EBDC                    	jmp	short MkDirErr	;AN006; make sure we didn't have network error
 23818                                  MD_other_err:			;AN006;
 23819 000028E0 BA[2E91]                	mov	dx,badmkd_ptr
 23820                                  ;MkDirErr:
 23821                                  	;call	std_eprintf
 23822                                  	;retn
 23823                                  	; 24/02/2023
 23824 000028E3 EBD7                    	jmp	short MkDirErr
 23825                                  
 23826                                  	; 24/02/2023
 23827                                  	; MSDOS 3.3
 23828                                  	;call	SETRMMK
 23829                                  	;jb	short MKDIRERR
 23830                                  	;mov	ah,MKDIR ; 39h
 23831                                  	;int	21h	; DOS -	2+ - CREATE A SUBDIRECTORY (MKDIR)
 23832                                  	;		; DS:DX	-> ASCIZ pathname (may include drive)
 23833                                  	;jnc	short MKDIR_RETN
 23834                                  	;mov	dx,BADMKDPTR
 23835                                  	;call	GET_EXT_ERR_NUMBER
 23836                                  ;MKDIRERR:
 23837                                  	;call	STD_EPRINTF
 23838                                  	;retn
 23839                                  
 23840                                  ; =============== S U B	R O U T	I N E =======================================
 23841                                  
 23842                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23843                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2656h
 23844                                  	
 23845                                  	; 11/06/2023 - Retro DOS v4.2
 23846                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2C00h
 23847                                  	
 23848                                  	; 04/08/2024 - Retro DOS v5.0
 23849                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2A32h
 23850                                  
 23851                                  _$RMDIR:
 23852 000028E5 E82200                  	call	SETRMMK
 23853 000028E8 72D2                    	jb	short RmDirErr
 23854 000028EA 7519                    	jnz	short badrderr
 23855                                  
 23856 000028EC B43A                    	mov	ah,3Ah
 23857                                  	;mov	ah,RMDIR ; 3Ah
 23858                                  	;int	21h	; DOS -	2+ - REMOVE A DIRECTORY	ENTRY (RMDIR)
 23859                                  			; DS:DX	-> ASCIZ pathname (may include drive)
 23860                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 23861 000028EE E8C9DC                  	call    int_21h_indirect
 23862 000028F1 73CC                    	jnc	short rmdir_retn ; 24/02/2023
 23863                                  
 23864                                  	; 24/02/2023
 23865                                  	; MSDOS 6.0
 23866 000028F3 E853F7                  	call	get_ext_error_number
 23867                                  				;AN022; get the extended error
 23868 000028F6 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ; 3
 23869                                  				;AN022; see if path not found
 23870 000028F9 740A                    	je	short badrderr	;AN022; yes - issue old message
 23871 000028FB 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 23872                                  				;AN022; access denied?
 23873 000028FE 7405                    	je	short badrderr	;AN022; yes - issue old message
 23874                                  
 23875 00002900 E83800                  	call	set_ext_error_subst
 23876                                  				;AN022;
 23877 00002903 EBB7                    	jmp	short RmDirErr	;AC022; yes - go print it
 23878                                  
 23879                                  	; MSDOS 6.0
 23880                                  badrderr:
 23881                                  	; 24/02/2023
 23882 00002905 BA[3191]                	mov	dx,badrmd_ptr
 23883 00002908 EBB2                    	jmp	short RmDirErr
 23884                                  ;RmDirErr:
 23885                                  	;call	std_eprintf
 23886                                  ;;rmdir_retn
 23887                                  	;retn
 23888                                  
 23889                                  	; 24/02/2023
 23890                                  	; MSDOS 3.3
 23891                                  	;mov	dx,BADRMDPTR
 23892                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 23893                                  ;RMDIRERR:
 23894                                  	;call	STD_EPRINTF
 23895                                  ;RMDIR_RETN:
 23896                                  	;retn
 23897                                  
 23898                                  ; =============== S U B	R O U T	I N E =======================================
 23899                                  
 23900                                  ; 	<Common MkDir/RmDir set up code>
 23901                                  ;****************************************************************
 23902                                  ;*
 23903                                  ;* ROUTINE:	SETRMMK
 23904                                  ;*
 23905                                  ;* FUNCTION:	Parse routine for the internal MKDIR and RMDIR
 23906                                  ;*		commands. Parses the command line for a required
 23907                                  ;*		filespec.
 23908                                  ;*
 23909                                  ;* INPUT:	command line at offset 81H
 23910                                  ;*
 23911                                  ;* OUTPUT:	carry clear
 23912                                  ;*		    DS:DX points to ASCIIZ argument
 23913                                  ;*		carry set
 23914                                  ;*		    DS:DX has error message pointer
 23915                                  ;*
 23916                                  ;****************************************************************
 23917                                  
 23918                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 23919                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2624h
 23920                                  	
 23921                                  	; 11/06/2023 - Retro DOS v4.2
 23922                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2BCEh
 23923                                  
 23924                                  	; 04/08/2024 - Retro DOS v5.0
 23925                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2A00h
 23926                                  
 23927                                  SETRMMK:
 23928                                  	; MSDOS 6.0
 23929 0000290A BE8100                  	mov	si,81h
 23930 0000290D BF[7C96]                	mov	di,PARSE_MRDIR 	;AN000; Get address of PARSE_MRDIR
 23931 00002910 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 23932 00002912 31D2                    	xor	dx,dx		;AN000;
 23933                                  	;invoke	Parse_With_Msg	;AC000; call parser
 23934 00002914 E842FC                  	call	Parse_With_Msg
 23935                                  	;cmp	ax,0
 23936                                  	;cmp	ax,RESULT_NO_ERROR
 23937 00002917 09C0                    	or	ax,ax ; 0 ?	;AC000; did we have an error?
 23938 00002919 7519                    	jnz	short noargerr	;AC000; yes - exit
 23939                                  
 23940 0000291B BF[8199]                	mov	di,SRCXNAME
 23941                                  				;AN000; get address of srcxname
 23942 0000291E 57                      	push	di		;AN000; save address
 23943 0000291F 56                      	push	si		;AN000; save position in line
 23944 00002920 C536[4FA6]              	lds	si,[PARSE1_ADDR]
 23945                                  				;AN000; get address of path
 23946                                  mrdir_move_filename:		;AN000; put filespec in srcxname
 23947 00002924 AC                      	lodsb			;get a char from buffer
 23948 00002925 AA                      	stosb			;AN000; store in srcxname
 23949                                  	;cmp	al,0
 23950                                  	;cmp	al,END_OF_LINE_OUT
 23951 00002926 20C0                    	and	al,al ; 0 ?	;AC000; it char a terminator?
 23952 00002928 75FA                    	jnz	short mrdir_move_filename
 23953                                  				;AC000; no - keep moving
 23954 0000292A 5E                      	pop	si		;AN000; get line position back
 23955                                  
 23956                                  ; we have scanned an argument.	See if any args beyond.
 23957                                  
 23958 0000292B BF[7C96]                	mov	di,PARSE_MRDIR
 23959 0000292E E812FC                  	call	parse_check_eol ;AC000; are we at end of line?
 23960 00002931 5A                      	pop	dx		;AC000; get address of SRCXNAME
 23961                                  	;retz			;yes - return no error
 23962 00002932 7406                    	jz	short setrmmk_retn
 23963                                  noargerr:
 23964 00002934 BA[CB8F]                	mov	dx,extend_buf_ptr
 23965                                  				;AC000; get extended message pointer
 23966 00002937 31C0                    	xor	ax,ax
 23967 00002939 F9                      	stc
 23968                                  setrmmk_retn:
 23969 0000293A C3                      	retn
 23970                                  
 23971                                  	; 24/02/2023
 23972                                  	; MSDOS 3.3
 23973                                  ;SETRMMK:
 23974                                  	;mov	si,81h
 23975                                  	;call	SCANOFF
 23976                                  	;cmp	al,0Dh
 23977                                  	;je	short NOARGERR
 23978                                  	;mov	dx,si
 23979                                  ;SETRMMK1:
 23980                                  	;lodsb
 23981                                  	;call	DELIM
 23982                                  	;jz	short SETRMMK3
 23983                                  	;cmp	al,0Dh
 23984                                  	;jne	short SETRMMK1
 23985                                  	;mov	byte [si-1],0
 23986                                  ;SETRMMK2:
 23987                                  	;retn
 23988                                  ;SETRMMK3:
 23989                                  	;mov	byte [si-1],0
 23990                                  	;push	si
 23991                                  	;call	SCANOFF
 23992                                  	;pop	si
 23993                                  	;cmp	al,0Dh
 23994                                  	;je	short SETRMMK2
 23995                                  ;NOARGERR:
 23996                                  	;mov	dx,BADARGSPTR
 23997                                  	;xor	ax,ax
 23998                                  	;stc
 23999                                  ;SETRMMK_RETN:
 24000                                  	;retn
 24001                                  
 24002                                  ; =============== S U B	R O U T	I N E =======================================
 24003                                  
 24004                                  ; MSDOS 6.0
 24005                                  
 24006                                  ;****************************************************************
 24007                                  ;*
 24008                                  ;* ROUTINE:	Set_ext_error_subst
 24009                                  ;*
 24010                                  ;* FUNCTION:	Sets up substitution for extended error
 24011                                  ;*
 24012                                  ;* INPUT:	AX - extended error number
 24013                                  ;*		DX - offset of string
 24014                                  ;*
 24015                                  ;* OUTPUT:	Extend_Buf_Ptr set up for STD_EPRINTF
 24016                                  ;*
 24017                                  ;****************************************************************
 24018                                  
 24019                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24020                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:267Ch
 24021                                  set_ext_error_subst:
 24022                                  	;mov	byte [msg_disp_class],1
 24023 0000293B C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 24024                                  					;AN022; set up extended error msg class
 24025 00002940 8916[019E]              	mov	[string_ptr_2],dx 	;AN022; get address of failed string
 24026                                  	;mov	byte [extend_buf_sub],1
 24027 00002944 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst
 24028                                  	;AN022; put number of subst in control block
 24029 00002949 BA[CB8F]                	mov	dx,extend_buf_ptr 	;AN022; get extended message pointer
 24030 0000294C A3[CB8F]                	mov	[extend_buf_ptr],ax	;AN022; get message number in control block
 24031                                  savudir_err_retn: ; 24/02/2023
 24032 0000294F C3                      	retn				;AN022; return
 24033                                  
 24034                                  ; =============== S U B	R O U T	I N E =======================================
 24035                                  
 24036                                  ; <SavUDir - preserve the users current directory on a particular drive>
 24037                                  
 24038                                  ; SavUDir - move the user's current directory on a drive into UserDir1
 24039                                  ; SavUDir1 - move the user's current directory on a drive into a specified
 24040                                  ;   buffer
 24041                                  ;
 24042                                  ;   Inputs:	DL has 1-based drive number
 24043                                  ;		ES:DI has destination buffer (SavUDir1 only)
 24044                                  ;   Outputs:	Carry Clear
 24045                                  ;		    DS = TranGroup
 24046                                  ;		Carry Set
 24047                                  ;		    AX has error code
 24048                                  ;   Registers Modified: AX, SI
 24049                                  
 24050                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24051                                  SAVUDIR:
 24052 00002950 BF[359B]                	mov	di,USERDIR1
 24053                                  ; --------------
 24054                                  SAVUDIR1:
 24055 00002953 88D0                    	mov	al,dl
 24056 00002955 0440                    	add	al,'@' ; 40h
 24057 00002957 3C40                    	cmp	al,'@' ; 40h
 24058 00002959 7506                    	jne	short GOTUDRV
 24059 0000295B 0206[679C]              	add	al,[CURDRV]
 24060 0000295F FEC0                    	inc	al		; A = 1
 24061                                  GOTUDRV:
 24062 00002961 AA                      	stosb
 24063 00002962 8A26[589C]              	mov	ah,[DIRCHAR]
 24064 00002966 B03A                    	mov	al,':' ; 3Ah
 24065 00002968 AB                      	stosw
 24066 00002969 06                      	push	es
 24067 0000296A 1F                      	pop	ds
 24068 0000296B 89FE                    	mov	si,di
 24069 0000296D B447                    	mov	ah,47h ; 24/02/2023
 24070                                  	;mov	ah,CURRENT_DIR	; 47h
 24071                                  	;int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 24072                                  			; DL = drive (0=default,1=A,etc.)
 24073                                  			; DS:SI	points to 64-byte buffer area
 24074                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24075 0000296F E848DC                  	call	int_21h_indirect
 24076 00002972 72DB                    	jc	short savudir_err_retn ; 24/02/2023
 24077 00002974 0E                      	push	cs
 24078 00002975 1F                      	pop	ds
 24079 00002976 C3                      	retn
 24080                                  
 24081                                  ; =============== S U B	R O U T	I N E =======================================
 24082                                  
 24083                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24084                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:26B7h
 24085                                  CRLF2:
 24086 00002977 52                      	push	dx
 24087 00002978 BA[EE91]                	mov	dx,acrlf_ptr
 24088 0000297B 1E                      	push	ds
 24089 0000297C 0E                      	push	cs
 24090 0000297D 1F                      	pop	ds
 24091 0000297E E89C2A                  	call	std_printf
 24092 00002981 1F                      	pop	ds
 24093 00002982 5A                      	pop	dx
 24094 00002983 C3                      	retn
 24095                                  
 24096                                  ; =============== S U B	R O U T	I N E =======================================
 24097                                  
 24098                                  ; These routines (SCANOFF, DELIM) are called in batch processing when DS
 24099                                  ; may NOT be TRANGROUP
 24100                                  
 24101                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24102                                  scanoff:
 24103 00002984 AC                      	lodsb
 24104 00002985 E80400                  	call	DELIM
 24105 00002988 74FA                    	jz	short scanoff
 24106 0000298A 4E                      	dec	si		; Point to first non-delimiter
 24107                                  scanoff_retn:
 24108 0000298B C3                      	retn
 24109                                  
 24110                                  ; =============== S U B	R O U T	I N E =======================================
 24111                                  
 24112                                  ; Input:    AL is character to classify
 24113                                  ; Output:   Z set if delimiter
 24114                                  ;	    NZ set otherwise
 24115                                  ; Registers modified: none
 24116                                  
 24117                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24118                                  DELIM:
 24119 0000298C 3C20                    	cmp	al,' '	 ;20h
 24120 0000298E 74FB                    	je	short scanoff_retn
 24121 00002990 3C3D                    	cmp	al,'='  ; 3Dh
 24122 00002992 74F7                    	je	short scanoff_retn
 24123 00002994 3C2C                    	cmp	al,','	; 2Ch
 24124 00002996 74F3                    	je	short scanoff_retn
 24125 00002998 3C3B                    	cmp	al,';'	 ;3Bh
 24126 0000299A 74EF                    	je	short scanoff_retn
 24127 0000299C 3C09                    	cmp	al,9		; Check for TAB character
 24128 0000299E 74EB                    	je	short scanoff_retn
 24129 000029A0 3C0A                    	cmp	al,0Ah		; Check for line feed character - BAS
 24130 000029A2 C3                      	retn
 24131                                  
 24132                                  
 24133                                  ; =============== S U B	R O U T	I N E =======================================
 24134                                  
 24135                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24136                                  FCB_TO_ASCZ:			
 24137                                  	; Convert DS:SI to ASCIZ ES:DI
 24138 000029A3 B90800                  	mov	cx,8
 24139                                  MAINNAME:
 24140 000029A6 AC                      	lodsb
 24141 000029A7 3C20                    	cmp	al,' ' ; 20h
 24142 000029A9 7401                    	jz	short SKIPSPC
 24143 000029AB AA                      	stosb
 24144                                  SKIPSPC:
 24145 000029AC E2F8                    	loop	MAINNAME
 24146 000029AE AC                      	lodsb
 24147 000029AF 3C20                    	cmp	al,' '
 24148 000029B1 740F                    	je	short GOTNAME
 24149 000029B3 88C4                    	mov	ah,al
 24150                                  	; 24/02/2023
 24151 000029B5 B02E                    	mov	al,'.' ; 2Eh  ; MSDOS 5.0 (& 6.0)
 24152                                  	;mov	al,[DOT_CHR]  ; MSDOS 3.3
 24153                                  	;stosb
 24154                                  	;xchg	al,ah
 24155                                  	;stosb
 24156                                  	; 24/02/2023
 24157 000029B7 AB                      	stosw
 24158 000029B8 B102                    	mov	cl,2
 24159                                  EXTNAME:
 24160 000029BA AC                      	lodsb
 24161 000029BB 3C20                    	cmp	al,' '
 24162 000029BD 7403                    	je	short GOTNAME
 24163 000029BF AA                      	stosb
 24164 000029C0 E2F8                    	loop	EXTNAME
 24165                                  GOTNAME:
 24166 000029C2 30C0                    	xor	al,al
 24167 000029C4 AA                      	stosb
 24168                                  STRCOMP_RETN:
 24169 000029C5 C3                      	retn
 24170                                  
 24171                                  ; =============== S U B	R O U T	I N E =======================================
 24172                                  
 24173                                  ; Compare ASCIZ DS:SI with ES:DI.
 24174                                  ; SI,DI destroyed.
 24175                                  
 24176                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24177                                  STRCOMP:	
 24178 000029C6 A6                      	cmpsb
 24179 000029C7 75FC                    	jnz	short STRCOMP_RETN ; Strings not equal
 24180 000029C9 807CFF00                	cmp	byte [si-1],0	; Hit NUL terminator?
 24181                                  	;jz	short STRCOMP_RETN ; Yes, strings equal
 24182                                  	;jmp	short STRCOMP	; Equal so far, keep going
 24183                                  	; 24/02/2023
 24184 000029CD 75F7                    	jnz	short STRCOMP
 24185 000029CF C3                      	retn
 24186                                  
 24187                                  ; =============== S U B	R O U T	I N E =======================================
 24188                                  
 24189                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 24190                                  CRPRINT:
 24191 000029D0 50                      	push	ax
 24192                                  	;mov	al,13	; 0Dh
 24193 000029D1 B00D                    	mov	al,0Dh
 24194 000029D3 51                      	push	cx
 24195 000029D4 57                      	push	di
 24196 000029D5 89D7                    	mov	di,dx
 24197 000029D7 B9FFFF                  	mov	cx,65535 ; 0FFFFh
 24198 000029DA 06                      	push	es
 24199 000029DB 1E                      	push	ds
 24200 000029DC 07                      	pop	es
 24201 000029DD F2AE                    	repne	scasb		; LOOK FOR TERMINATOR
 24202 000029DF C645FF00                	mov	byte [di-1],0	; nul terminate the string
 24203 000029E3 07                      	pop	es
 24204 000029E4 8916[019E]              	mov	[string_ptr_2],dx
 24205                                  	;mov	dx,STRINGBUF2PTR  ; MSDOS 3.3 (Retro DOS v3.0 COMMAND.COM)
 24206 000029E8 BA[D391]                	mov	dx,string_buf_ptr ; MSDOS 5.0 (& 6.0)
 24207 000029EB E82F2A                  	call	std_printf
 24208                                  	;mov	byte [di-1],13
 24209 000029EE C645FF0D                	mov	byte [di-1],0Dh	; now put the CR back
 24210 000029F2 7204                    	jb	short error_output
 24211 000029F4 5F                      	pop	di
 24212 000029F5 59                      	pop	cx
 24213 000029F6 58                      	pop	ax
 24214 000029F7 C3                      	retn
 24215                                  
 24216                                  ; ---------------------------------------------------------------------------
 24217                                  
 24218                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24219                                  error_output:
 24220 000029F8 0E                      	push	cs
 24221 000029F9 1F                      	pop	ds
 24222 000029FA 8E06[539C]              	mov	es,[RESSEG]
 24223 000029FE BA[DF8F]                	mov	dx,NOSPACE_PTR
 24224 00002A01 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 24225 00002A07 7406                    	jz	short go_to_error
 24226 00002A09 E89909                  	call	PipeOff
 24227 00002A0C BA[5191]                	mov	dx,PIPEEMES_PTR
 24228                                  go_to_error:
 24229 00002A0F E91203                  	jmp	cerror
 24230                                  
 24231                                  ; =============== S U B	R O U T	I N E =======================================
 24232                                  
 24233                                  ;---- Mod for path invocation ----
 24234                                  
 24235                                  	; 24/02/2023 - Retro DOS v4.0 (& v4.1)
 24236                                  pathchrcmp:
 24237                                  	; 18/03/2023	
 24238                                  	;push	ax
 24239                                  	;mov	ah,'/' ; 2Fh
 24240                                  	;cmp	[SWITCHAR],ah
 24241 00002A12 803E[579C]2F            	cmp	byte [SWITCHAR],'/' ; 2Fh
 24242 00002A17 7404                    	je	short noslasht
 24243 00002A19 3C2F                    	cmp	al,'/'
 24244 00002A1B 7402                    	je	short pccont
 24245                                  noslasht:
 24246 00002A1D 3C5C                    	cmp	al,'\' ; 5Ch
 24247                                  pccont:	
 24248                                  	;pop	ax
 24249 00002A1F C3                      	retn
 24250                                  
 24251                                  ; =============== S U B	R O U T	I N E =======================================
 24252                                  
 24253                                  ; PATHCRUNCH -
 24254                                  ;
 24255                                  ; ENTRY FCB (in PSP) contains drive # to crunch on
 24256                                  ;       PathPos = ptr to string with pathname in it
 24257                                  ;       PathCnt = length of string
 24258                                  ;
 24259                                  ; EXIT  PathPos = ptr after pathname (w/ NULL) in string
 24260                                  ;       PathCnt = length left in string
 24261                                  ;       DestIsDir = nonzero if pathname delimiter char's found in pathname
 24262                                  ;       DestInfo<bit1> = set if wildcard char's found in pathname
 24263                                  ;       If path crunched successfully,
 24264                                  ;         CY = clear
 24265                                  ;         Current directory is changed to directory in pathname
 24266                                  ;         UserDir1 contains previous directory for use by RestUDir
 24267                                  ;         RestDir = nonzero to flag later restoration of user's dir
 24268                                  ;         DestTail = ptr to beginning of filename
 24269                                  ;         If filename found in pathname,
 24270                                  ;           ZR = clear
 24271                                  ;           FCB filename fields contain filename
 24272                                  ;         If filename not found (pure directory path),
 24273                                  ;           ZR = set
 24274                                  ;           FCB filename fields are wildcarded with ?'s
 24275                                  ;       If pathcrunch failed (no ChDir's worked),
 24276                                  ;         CY = set
 24277                                  ;         Msg_Numb = extended error code
 24278                                  ;
 24279                                  ; NOTE  DIR asks PathCrunch to forego parsing the filename into the
 24280                                  ;       FCB by setting DirFlag. In this case, the FCB is returned
 24281                                  ;       with the filename wildcarded.
 24282                                  
 24283                                  	; 25/02/2023 - Retro DOS v4.0 (& v4.1)
 24284                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2767h
 24285                                  
 24286                                  	; 11/06/2023 - Retro DOS v4.2
 24287                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2D11h
 24288                                  
 24289                                  	; 04/08/2024 - Retro DOS v5.0
 24290                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2B45h
 24291                                  PathCrunch:
 24292                                  	; MSDOS 6.0
 24293 00002A20 C706[939F]0000          	mov     word [Msg_Numb],0
 24294                                  				;AN022; Set up message flag
 24295                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24296                                  	;mov	dl,[5Ch]
 24297 00002A26 8A165C00                	mov	dl,[FCB]	; DL = drive # (1 = A)
 24298 00002A2A E823FF                  	call	SAVUDIR		; save current directory in UserDir1
 24299                                  	; MSDOS 6.0
 24300 00002A2D 7233                     	jc	short pcrunch_cderrj
 24301                                  				;AN022; if error on current dir - report
 24302 00002A2F E8EB04                  	call	SETPATH		; scan past switches, whitespace
 24303                                  
 24304                                  ;       DX = ptr to pathname, NULL-terminated
 24305                                  ;       PathPos = ptr to byte after NULL at end of pathname
 24306                                  
 24307                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24308 00002A32 F606[1C9E]02            	test	byte [DestInfo],2 ; test if wildcards (? or *) seen
 24309 00002A37 752C                    	jnz	short trypeel	; wildcard seen, peel filename
 24310                                  
 24311                                  	;mov	ah,CHDir ; 3Bh
 24312 00002A39 B43B                    	mov	ah,3Bh
 24313 00002A3B CD21                    	int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24314                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24315                                  	; MSDOS 6.0
 24316 00002A3D 7313                    	jnc	short chdir_worked	;AN022; no error - continue
 24317                                  	
 24318 00002A3F E807F6                  	call	get_ext_error_number    ;AN022; get the extended error
 24319 00002A42 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found
 24320 00002A45 741E                    	je	short trypeel		;AC022;    keep trying
 24321 00002A47 83F805                  	cmp	ax,ERROR_ACCESS_DENIED  ;AN022; if access denied
 24322 00002A4A 7419                    	je	short trypeel		;AC022;    keep trying
 24323 00002A4C A3[939F]                	mov	[Msg_Numb],ax           ;AN022; set up message flag
 24324 00002A4F E99D00                  	jmp	peelfail                ;AN022; exit with other error
 24325                                  
 24326                                  	; MSDOS 3.3
 24327                                  	;jc	short trypeel
 24328                                  chdir_worked:
 24329                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24330 00002A52 E8BD06                  	call	SetRest1	; set 'Restore Directory' flag true
 24331 00002A55 B03F                    	mov	al,'?'		; if pure dir, wildcard filename in FCB
 24332 00002A57 BF5D00                  	mov	di,5Dh  ; FCB+1
 24333 00002A5A B90B00                  	mov	cx,11
 24334 00002A5D F3AA                    	rep	stosb
 24335 00002A5F 30C0                    	xor	al,al		; return carry clear, zero set
 24336 00002A61 C3                      	retn
 24337                                  
 24338                                  pcrunch_cderrj: 		;AN022; need this for long jmp
 24339 00002A62 E98200                  	jmp	pcrunch_cderr	;AN022;
 24340                                  
 24341                                  trypeel:
 24342 00002A65 8B36[F09D]              	mov	si,[PathPos]
 24343 00002A69 4E                      	dec	si		; SI = ptr to NULL at end of pathname
 24344 00002A6A 8A44FF                  	mov	al,[si-1]	; AL = last char of pathname
 24345                                  	; 25/02/2023
 24346                                  	; MSDOS 5.0 (& 6.0)
 24347 00002A6D 803E[AE9F]00            	cmp	byte [KPARSE],0
 24348 00002A72 7505                    	jnz	short delstrt	; Last char is 2nd KANJI byte, might be '\'
 24349                                  	
 24350 00002A74 E89BFF                  	call	pathchrcmp
 24351 00002A77 7476                    	jz	short peelfail	; Trailing '/'
 24352                                  delstrt:
 24353 00002A79 89F1                    	mov	cx,si		; CX = ptr to NULL at end of pathname
 24354 00002A7B 89D6                    	mov	si,dx		; SI = ptr to start of pathname
 24355 00002A7D 52                      	push	dx		; save ptr to pathname
 24356                                  delloop:
 24357 00002A7E 39CE                    	cmp	si,cx
 24358                                  	;jz	short BADRET
 24359                                  	; 25/02/2023
 24360 00002A80 7413                    	je	short gotdele	; no char's left, we have what we have
 24361 00002A82 AC                      	lodsb			; AL = next char of pathname
 24362 00002A83 E8D9FC                  	call	testkanj
 24363 00002A86 7403                    	jz	short notkanj8	; not Kanji, move along
 24364 00002A88 46                      	inc	si
 24365 00002A89 EBF3                    	jmp	short delloop	
 24366                                  
 24367                                  	; 25/02/2023
 24368                                  	; MSDOS 3.3
 24369                                  	;mov	al,[si]
 24370                                  	;call	PATHCHRCMP
 24371                                  	;jz	short TRYCD
 24372                                  	;dec	si
 24373                                  	;jmp	short delloop
 24374                                  
 24375                                  notkanj8:
 24376 00002A8B E884FF                  	call	pathchrcmp
 24377 00002A8E 75EE                    	jnz	short delloop	; not a path delimiter, keep looking
 24378 00002A90 89F2                    	mov	dx,si
 24379 00002A92 4A                      	dec	dx		; DX = ptr to last delimiter found	
 24380 00002A93 EBE9                    	jmp	short delloop	; go look for more
 24381                                  
 24382                                  	; 25/02/2023
 24383                                  	; MSDOS 5.0 (& 6.0)
 24384                                  gotdele:
 24385 00002A95 89D6                    	mov	si,dx		; SI = ptr to pathname or last delim
 24386 00002A97 5A                      	pop	dx		; DX = ptr to pathname
 24387 00002A98 39D6                    	cmp	si,dx
 24388 00002A9A 7455                    	je	short badret	; didn't find path delim
 24389 00002A9C 89F1                    	mov	cx,si		; CX = ptr to last path delimiter
 24390 00002A9E 89D6                    	mov	si,dx		; SI = ptr to pathname
 24391                                  delloop2:			; Set value of KPARSE
 24392 00002AA0 39CE                    	cmp	si,cx
 24393 00002AA2 7412                    	je	short trycd	; roll up till SI meets CX
 24394 00002AA4 C606[AE9F]00            	mov	byte [KPARSE],0
 24395 00002AA9 AC                      	lodsb
 24396 00002AAA E8B2FC                  	call	testkanj
 24397 00002AAD 74F1                    	jz	short delloop2
 24398 00002AAF 46                      	inc	si
 24399 00002AB0 FE06[AE9F]              	inc	byte [KPARSE]
 24400 00002AB4 EBEA                    	jmp	short delloop2
 24401                                  
 24402                                  trycd:
 24403 00002AB6 50                      	push	ax
 24404                                  	; 25/02/2023
 24405 00002AB7 B02E                    	mov	al,'.'
 24406                                  	;mov	al,[DOT_CHR]	; AL = '.'
 24407                                  	; MSDOS 6.0
 24408 00002AB9 384401                  	cmp	[si+1],al	; check for '.' after path delim
 24409                                  				;M019; allow continuation if '. ' or 
 24410                                  				;M019; '..' is not found.
 24411 00002ABC 7509                    	jne	short trycd1	;M019; '.' not found
 24412 00002ABE 384402                  	cmp	[si+2],al	;M019; check for '..'
 24413 00002AC1 7404                    	je	short trycd1	;M019; found '..'
 24414 00002AC3 807C0200                	cmp	byte [si+2],0	;M019; check for '. ' (null terminated)
 24415                                  trycd1:	
 24416 00002AC7 58                      	pop     ax
 24417 00002AC8 7425                    	jz	short peelfail	; if . or .., pure cd should have worked
 24418                                  
 24419                                  	; 25/02/2023
 24420                                  	; MSDOS 3.3
 24421                                  	;cmp	[si+1],	al	; check for '.' after path delim
 24422                                  	;pop	ax
 24423                                  	;jz	short PEELFAIL	; if . or .., pure cd should have worked
 24424                                  
 24425                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24426 00002ACA 8A44FF                  	mov	al,[si-1]
 24427 00002ACD 3C3A                    	cmp	al,':' 		; Special case d:\file
 24428 00002ACF 7420                    	je	short badret
 24429                                  	; 25/02/2023
 24430                                  	; MSDOS 6.0
 24431 00002AD1 803E[AE9F]00            	cmp	byte [KPARSE],0
 24432 00002AD6 7505                    	jnz	short notdoublesl
 24433 00002AD8 E837FF                  	call	pathchrcmp
 24434                                  	;jnz	short notdoublesl
 24435                                  				; Last char is 2nd KANJI byte, might be '\'
 24436                                  	; 25/02/2023
 24437 00002ADB 7412                    	jz	short peelfail 
 24438                                  ;peelfail:
 24439                                  	;stc
 24440                                  	;retn
 24441                                  
 24442                                  notdoublesl:
 24443 00002ADD C60400                  	mov	byte [si],0
 24444                                  	;mov	ah,CHDir ; 3Bh
 24445 00002AE0 B43B                    	mov	ah,3Bh
 24446                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24447                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24448                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24449 00002AE2 E8D5DA                  	call	int_21h_indirect
 24450 00002AE5 7321                    	jnc	short cdsucc
 24451                                  
 24452                                  	; 25/02/2023
 24453                                  	; MSDOS 6.0
 24454                                  pcrunch_cderr:
 24455 00002AE7 E85FF5                  	call	get_ext_error_number
 24456                                  				;AN022; get the extended error
 24457 00002AEA A3[939F]                	mov	[Msg_Numb],ax	;AN022; set up message flag
 24458 00002AED 09F6                    	or	si,si		;AN022; set up zero flag to not zero
 24459                                  peelfail: ; 25/02/2023
 24460 00002AEF F9                      	stc			;AN022; set up carry flag
 24461                                  pcrunch_retn:
 24462 00002AF0 C3                      	retn
 24463                                  
 24464                                  badret:
 24465                                  	; MSDOS 3.3 & MSDOS 6.0
 24466 00002AF1 8A04                    	mov	al,[si]
 24467 00002AF3 E81CFF                  	call	pathchrcmp	; Special case 'DIRCHAR'file
 24468 00002AF6 F9                      	stc
 24469 00002AF7 75F7                    	jnz	short pcrunch_retn
 24470 00002AF9 30DB                    	xor	bl,bl
 24471 00002AFB 865C01                  	xchg	bl,[si+1]
 24472                                  	;mov	ah,CHDir ; 3Bh
 24473 00002AFE B43B                    	mov	ah,3Bh
 24474                                  	;int	21h	; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 24475                                  			; DS:DX	-> ASCIZ directory name	(may include drive)
 24476                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 24477 00002B00 E8B7DA                  	call	int_21h_indirect
 24478                                  	;jc	short pcrunch_retn ; MSDOS 3.3
 24479                                  	; 25/02/2023
 24480 00002B03 72E2                    	jc	short pcrunch_cderr
 24481                                  				;AN022; go to error exit 
 24482 00002B05 885C01                  	mov	[si+1],bl
 24483                                  cdsucc:
 24484 00002B08 E80706                  	call	SetRest1
 24485 00002B0B 46                      	inc	si		; Reset zero
 24486 00002B0C 8936[1A9E]              	mov	[DestTail],si
 24487                                  	; 25/02/2023
 24488                                  	; MSDOS 6.0
 24489 00002B10 9C                      	pushf			;AN015; save flags
 24490 00002B11 803E[F89D]FF            	cmp	byte [DirFlag],-1
 24491                                  				;AN015; don't do parse if in DIR
 24492 00002B16 7408                    	je	short pcrunch_end
 24493                                  				;AN015;
 24494                                  	; MSDOS 3.3 & MSDOS 6.0
 24495 00002B18 BF5C00                  	mov	di,FCB  ; 5Ch
 24496                                  	;mov	ax,(Parse_File_Descriptor<<8)|2 ; 2902h
 24497 00002B1B B80229                  	mov	ax,2902h	
 24498 00002B1E CD21                    	int	21h		; Parse with default drive
 24499                                  			; DOS -	PARSE FILENAME
 24500                                  			; DS:SI	-> string to parse
 24501                                  			; ES:DI	-> buffer to fill with unopened	FCB
 24502                                  			; AL = bit mask	to control parsing
 24503                                  	; MSDOS 3.3
 24504                                  	;retn
 24505                                  
 24506                                  pcrunch_end:
 24507 00002B20 9D                      	popf			;AN015; get flags back
 24508 00002B21 C3                      	retn
 24509                                  
 24510                                  ; =============== S U B	R O U T	I N E =======================================
 24511                                  
 24512                                  ; 01/08/2024 - Retro DOS v5.0 COMMAND.COM
 24513                                  ; PCDOS 7.1 COMMAND.COM
 24514                                  %if 1
 24515                                  ;ifdef DBCS
 24516                                  ;
 24517                                  ;	Check if the character position is at Tail Byte of DBCS
 24518                                  ;
 24519                                  ;	input:	ds:si = start address of the string
 24520                                  ;		ds:di = character position to check
 24521                                  ;	output:	ZF = 1 if at Tail Byte
 24522                                  ;
 24523                                  ;CheckDBCSTailByte proc near
 24524                                  CheckDBCSTailByte:
 24525 00002B22 50                      	push	ax
 24526 00002B23 51                      	push	cx
 24527 00002B24 57                      	push	di
 24528 00002B25 89F9                    	mov	cx,di			; save character position
 24529                                  cdtb_check:
 24530 00002B27 39F7                    	cmp	di,si
 24531 00002B29 7409                    	jz	short cdtb_next		; if at the top
 24532 00002B2B 4F                      	dec	di			; go back
 24533 00002B2C 8A05                    	mov	al,[di]			; get character
 24534                                  	;invoke	testkanj
 24535 00002B2E E82EFC                  	call	testkanj
 24536 00002B31 75F4                    	jnz	short cdtb_check	; if DBCS lead byte do next
 24537 00002B33 47                      	inc	di			; adjust
 24538                                  cdtb_next:
 24539 00002B34 29F9                    	sub	cx,di			; if the length is odd then
 24540 00002B36 80F101                  	xor	cl,1			; the character position is
 24541 00002B39 F6C101                  	test	cl,1			; at the tail byte
 24542 00002B3C 5F                      	pop	di
 24543 00002B3D 59                      	pop	cx
 24544 00002B3E 58                      	pop	ax
 24545 00002B3F C3                      	retn
 24546                                  ;CheckDBCSTailByte endp
 24547                                  ;endif
 24548                                  %endif
 24549                                  
 24550                                  ;============================================================================
 24551                                  ; TMISC1.ASM, MSDOS 6.0, 1991
 24552                                  ;============================================================================
 24553                                  ; 05/10/2018 - Retro DOS v3.0
 24554                                  
 24555                                  ;TITLE	Part7 COMMAND Transient Routines
 24556                                  
 24557                                  ;	More misc routines
 24558                                  
 24559                                  ;---------------------------
 24560                                  ; We can get rid of this switch processing code if we can take
 24561                                  ; care of the remaining two calls to switch, later in the file.
 24562                                  ; However, I have not checked whether or not any other files use
 24563                                  ; switch -- after all, it IS public!
 24564                                  ;---------------------------
 24565                                  
 24566                                  ; 14/06/2023
 24567                                  SWCOUNT	EQU 8	; MSDOS 6.22		; Length of switch_list
 24568                                  ; 28/03/2023
 24569                                  ;SWCOUNT  EQU  6  ; MSDOS 6.0 (& MSDOS 5.0)
 24570                                  ;;SWCOUNT EQU  5  ; MSDOS 3.3	
 24571                                  
 24572                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1AC2h
 24573                                  
 24574                                  ; 25/02/2023 - Retro DOS v4.0 (& v4.1)
 24575                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2869h
 24576                                  
 24577                                  ; ---------------------------------------------------------------------------
 24578                                  
 24579                                  	; 25/02/2023
 24580                                  RETSW:
 24581 00002B40 93                      	xchg	ax,bx		; Put switches in AX
 24582 00002B41 C3                      	retn
 24583                                  
 24584                                  ; =============== S U B	R O U T	I N E =======================================
 24585                                  
 24586                                  	; 25/02/2023 - Retro DOS v4.0 COMMAND.COM
 24587                                  	; 11/06/2023 - Retro DOS 4.2 COMMAND.COM
 24588                                  	; 04/08/2024 - Retro DOS 5.0 COMMAND.COM
 24589                                  SWITCH:
 24590 00002B42 31DB                    	xor	bx,bx		; Initialize - no switches set
 24591                                  SWLOOP:
 24592 00002B44 E83DFE                  	call	scanoff		; Skip any delimiters
 24593 00002B47 3A06[579C]              	cmp	al,[SWITCHAR]	; Is it a switch specifier?
 24594 00002B4B 75F3                    	jnz	short RETSW	; No -- we're finished
 24595 00002B4D 81CB0080                	or	bx,8000h
 24596                                  	;or	bx,FSWITCH	; Indicate there is a switch specified
 24597 00002B51 46                      	inc	si		; Skip over the switch character
 24598 00002B52 E82FFE                  	call	scanoff
 24599 00002B55 3C0D                    	cmp	al,0Dh
 24600 00002B57 74E7                    	je	short RETSW	; Oops
 24601 00002B59 46                      	inc	si
 24602                                  
 24603                                  	; Convert lower case input to upper case
 24604                                  
 24605 00002B5A E82CFC                  	call	UPCONV
 24606                                  	;call	UPCONV_MAPCALL	; MSDOS 3.3
 24607                                  
 24608 00002B5D BF[C495]                	mov	di,switch_list	; "-Y?VBAPW" (for PCDOS 7.1) ; 04/08/2024
 24609                                  				; "-Y?VBAPW" (for MSDOS 6.22) ; 11/06/2023
 24610                                  				; "?VBAPW" (for MSDOS 6.0)
 24611                                  				; ("VBAPW" (for MSDOS 3.3))
 24612                                  	; 11/06/2023
 24613                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2E33h
 24614 00002B60 B90800                  	mov	cx,8  ; MSDOS 6.22
 24615                                  	;mov	cx,6  ; MSDOS 6.0 (& MSDOS 5.0)
 24616                                  	;;mov	cx,5  ; MSDOS 3.3
 24617                                  	;;mov	cx,SWCOUNT ; 5 (for MSDOS 3.3), (6 (for MSDOS 6.0))
 24618                                  
 24619                                  	;nop
 24620                                  
 24621 00002B63 F2AE                    	repne	scasb		; Look for matching switch
 24622 00002B65 7507                    	jnz	short BADSW
 24623 00002B67 B80100                  	mov	ax,1
 24624 00002B6A D3E0                    	shl	ax,cl		; Set a bit for the switch
 24625 00002B6C 09C3                    	or	bx,ax
 24626                                  BADSW: 				; Retro DOS v3.0 COMMAND.COM modificiation
 24627 00002B6E EBD4                    	jmp	short SWLOOP
 24628                                  ;BADSW:
 24629                                  	;jmp	short SWLOOP
 24630                                  ;DRVBAD:
 24631                                  ;	mov	dx,baddrv_ptr
 24632                                  ;	jmp	cerror
 24633                                  EXTERNALJ:
 24634 00002B70 E90501                  	jmp	EXTERNAL
 24635                                  FNDCOM:				; search the internal command table
 24636 00002B73 08C0                    	or	al,al		; Get real length of first arg
 24637 00002B75 74F9                    	jz	short EXTERNALJ	; If 0, it must begin with "\" so has
 24638                                  				;  to be external.
 24639                                  ; barryf code starts here
 24640                                  
 24641 00002B77 E89203                  	call	test_append	; see if APPEND installed
 24642 00002B7A 7429                    	jz	short CONTCOM	; not loaded
 24643                                  
 24644                                  APPEND_INTERNAL:
 24645 00002B7C 8A0E[1B9D]              	mov	cl,[IDLEN]
 24646 00002B80 B500                    	mov	ch,0
 24647 00002B82 890E[F09D]              	mov	[PathPos],cx
 24648                                  	
 24649                                  	; 25/02/2023
 24650                                  	; MSDOS 6.0
 24651 00002B86 FE06[959F]              	inc 	byte [append_exec]
 24652                                  				;AN041; set APPEND to ON
 24653 00002B8A E82104                  	call	IOSET		; re-direct the o'l io
 24654                                  
 24655 00002B8D BE[1B9D]                	mov	si,IDLEN	; address command name, DS already set
 24656 00002B90 BAFFFF                  	mov	dx,-1 ; 0FFFFh	; set invoke function
 24657                                  		
 24658                                  	; MSDOS 6.0
 24659 00002B93 BF[0754]                	mov	di,append_parse
 24660                                  				;AN010; Get the entry point for PARSE for APPEND
 24661                                  	; MSDOS 3.3 (& MSDOS 6.0)
 24662 00002B96 B801AE                  	mov	ax,0AE01h
 24663 00002B99 CD2F                    	int	2Fh	; - Multiplex -	DOS 3.3+ internal
 24664                                  			; - INSTALLABLE	COMMAND	- EXECUTE
 24665                                  			; DX = FFFFh, DS:SI -> buffer
 24666                                  			; Return: buffer at DS:SI filled with a	length byte
 24667                                  			; followed by the uppercase internal command
 24668                                  			; to execute (if length not 0)
 24669                                  	; 25/02/2023
 24670                                  	; INT 2Fh
 24671                                  	; 	AX = AE01h
 24672                                  	; entry:
 24673                                  	; 	DX = magic value FFFFh
 24674                                  	; 	CH = 00h
 24675                                  	; 	CL = length of command name
 24676                                  	; 	DS:BX -> command line buffer  -- (offset COMBUF)
 24677                                  	; 	DS:SI -> command name buffer  -- (offset IDLEN)
 24678                                  	; return:
 24679                                  	;	DS:SI buffer updated
 24680                                  	;	if length byte is nonzero, the following bytes contain
 24681                                  	;	the uppercase internal command to execute and the command line
 24682                                  	; 	buffer contains the command's parameters
 24683                                  	;	(the first DS:[SI] bytes are ignored)
 24684                                  	;
 24685                                  	; Format of COMMAND.COM command line buffer:
 24686                                  	;	Offset  Size    Description
 24687                                  	;	00h     BYTE    max length of command line, as in INT 21/AH=0Ah
 24688                                  	;	01h     BYTE    count of bytes to follow, excluding terminating 0Dh
 24689                                  	;	N BYTEs command line text, terminated by 0Dh
 24690                                  	;
 24691                                  	; Format of command name buffer:
 24692                                  	;	Offset  Size    Description
 24693                                  	;	00h     BYTE    length of command name
 24694                                  	;	01h    N BYTEs  uppercased command name (blank-padded to 11 chars)
 24695                                  
 24696 00002B9B 803E[1B9D]00            	cmp	byte [IDLEN],0 ; execute requested
 24697 00002BA0 7503                    	jne	short CONTCOM
 24698 00002BA2 E9A300                  	jmp	CMD_DONE
 24699                                  
 24700                                  	;nop
 24701                                  CONTCOM:			; continue with internal scan
 24702 00002BA5 BF[4394]                	mov	di,COMTAB
 24703 00002BA8 31C9                    	xor	cx,cx
 24704                                  FINDCOM:
 24705 00002BAA BE[1C9D]                	mov	si,ID		; pointer to command argument
 24706 00002BAD 8A0D                    	mov	cl,[di]		; load length of internal command
 24707 00002BAF 47                      	inc	di		; advance past length
 24708 00002BB0 E3BE                    	jcxz	EXTERNALJ 	; if it's zero, we're out of internals
 24709 00002BB2 3A0E[1B9D]              	cmp	cl,[IDLEN]	; that of the command argument
 24710 00002BB6 7506                    	jne	short ABCD	; lengths not equal ==> strings not eq
 24711 00002BB8 890E[F09D]              	mov	[PathPos],cx	; store length of command
 24712 00002BBC F3A6                    	repe	cmpsb
 24713                                  ABCD:
 24714 00002BBE 9F                      	lahf			; save the good ol' flags
 24715 00002BBF 01CF                    	add	di,cx		; skip over remaining internal, if any
 24716 00002BC1 8A05                    	mov	al,[di]		; load drive-check indicator byte (DCIB)
 24717 00002BC3 A2[659C]                	mov	[CHKDRV],al	; save command flag byte in chkdrv
 24718 00002BC6 47                      	inc	di		; increment DI (OK, OK, I'll stop)
 24719 00002BC7 8B1D                    	mov	bx,[di]		; load internal command address
 24720 00002BC9 47                      	inc	di		; skip over the puppy
 24721 00002BCA 47                      	inc	di
 24722                                  
 24723                                  	; MSDOS 6.0
 24724 00002BCB 8B15                    	mov	dx,[di]		; load ptr to help msg #s
 24725 00002BCD 47                      	inc	di
 24726 00002BCE 47                      	inc	di
 24727 00002BCF 9E                      	sahf			; remember those flags?
 24728 00002BD0 75D8                    	jnz	short FINDCOM	; well, if all the cmps worked...
 24729                                  
 24730                                  ; All messages get redirected.
 24731                                  
 24732 00002BD2 803E[959F]00            	cmp     byte [append_exec],0
 24733                                  				;AN041; APPEND just executed?
 24734 00002BD7 7503                    	jnz 	short DONT_SET_IO
 24735                                  				;AN041; Yes - this junk is already set
 24736 00002BD9 E8D203                  	call	IOSET		; re-direct the ol' i/o
 24737                                  
 24738                                  DONT_SET_IO:			;AN041;
 24739                                  
 24740                                  ; Check for /?. Certain commands, flagged fLimitHelp,
 24741                                  ; respond to /? only if it is the only command-line argument.
 24742                                  
 24743 00002BDC A1[6A9C]                	mov	ax,[COMSW]	; AX = switches after command
 24744 00002BDF 0B06[709C]              	or	ax,[AllSwitch]	; AX = all switches
 24745                                  	;and	ax,SwitchQues
 24746 00002BE3 83E020                  	and	ax,20h
 24747 00002BE6 7426                    	jz	short DRIVE_CHECK
 24748                                  				; /? not in command line
 24749 00002BE8 F606[659C]04            	test	byte [CHKDRV],4	
 24750                                  	;test	byte [CHKDRV],fLimitHelp
 24751 00002BED 7407                    	jz	short DO_HELP	; /? allowed in combination
 24752                                  
 24753                                  ; Make sure /? is the only argument on the command line.
 24754                                  
 24755 00002BEF 833E[6FA2]02            	cmp	word [ARG+ARG_UNIT.argvcnt],2
 24756 00002BF4 7518                    	jne	short DRIVE_CHECK
 24757                                  				; /? not only arg - ignore
 24758                                  
 24759                                  ; Note: this is all the check we need, even against things like /??.
 24760                                  ; Our argv parser breaks /?? into two args, /? and ?.
 24761                                  
 24762                                  DO_HELP:
 24763                                  ; DX = ptr to word list of msg #s, terminated by zero word
 24764                                  
 24765 00002BF6 89D6                    	mov	si,dx		; SI = ptr to list of msg #s
 24766                                      	;mov	ax,no_subst	; AL = no subst's code
 24767 00002BF8 B80000                  	mov	ax,0
 24768 00002BFB 50                      	push	ax		; build subst block on stack
 24769                                  
 24770                                  NEXT_HELP_MSG:
 24771 00002BFC AD                      	lodsw			; AX = help msg # or zero
 24772 00002BFD 09C0                    	or	ax,ax
 24773 00002BFF 7409                    	jz	short HELP_DONE
 24774 00002C01 50                      	push	ax		; SS:SP = ptr to subst block
 24775                                  				; (msg # and no_subst byte)
 24776                                  ;; We assume DS = SS.
 24777                                  	
 24778 00002C02 89E2                    	mov     dx,sp		; DS:DX = ptr to subst block
 24779 00002C04 E81628                  	call	std_printf	; display help message
 24780 00002C07 58                      	pop	ax		; remove msg # from stack
 24781 00002C08 EBF2                    	jmp	short NEXT_HELP_MSG
 24782                                  
 24783                                  HELP_DONE:
 24784 00002C0A 58                      	pop	ax		; clean up stack
 24785 00002C0B E9F6D4                  	jmp	TCOMMAND
 24786                                  
 24787                                  	; 25/02/2023
 24788                                  	; MSDOS 3.3
 24789                                  	;sahf			; remember those flags?
 24790                                  	;jnz	short FINDCOM	; well, if all the cmps worked...
 24791                                  	;call	IOSET		; re-direct the ol' i/o
 24792                                  
 24793                                  DRIVE_CHECK:
 24794 00002C0E F606[659C]01            	test	byte [CHKDRV],1
 24795                                  	;test	byte [CHKDRV],FCHECKDRIVE
 24796                                  				; did we wanna check those drives?
 24797 00002C13 7411                    	jz	short NOCHECK
 24798 00002C15 A0[689C]                	mov	al,[PARM1]	; parse_file_descriptor results tell
 24799 00002C18 0A06[699C]              	or	al,[PARM2]	; us whether those drives were OK
 24800 00002C1C 3CFF                    	cmp	al,-1
 24801 00002C1E 7506                    	jne	short NOCHECK
 24802                                  	;jmp	DRVBAD
 24803                                  	; 25/02/2023
 24804                                  DRVBAD:
 24805 00002C20 BA[6290]                	mov	dx,baddrv_ptr
 24806 00002C23 E9FE00                  	jmp	cerror
 24807                                  
 24808                                  ; The user may have omitted the space between the command and its arguments.
 24809                                  ; We need to copy the remainder of the user's command line into the buffer.
 24810                                  ; Note that thisdoes not screw up the arg structure; it points into COMBUF not
 24811                                  ; into the command line at 80.
 24812                                  
 24813                                  NOCHECK:
 24814 00002C26 E8C602                  	call	cmd_copy
 24815                                  SWITCHECK:
 24816                                  	;test	byte [CHKDRV],2
 24817 00002C29 F606[659C]02            	test	byte [CHKDRV],fSwitchAllowed 
 24818                                  				; Does the command take switches
 24819 00002C2E 7516                    	jnz	short REALWORK	; Yes, process the command
 24820 00002C30 E82F00                  	call	noswit		; No, check to see if any switches
 24821 00002C33 7511                    	jnz	short REALWORK	; None, process the command
 24822                                  
 24823                                  	; MSDOS 6.0
 24824                                  	;mov	byte [msg_disp_class],2
 24825 00002C35 C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class
 24826                                  				;AN000; set up parse error msg class
 24827 00002C3A BA[CB8F]                	mov	dx,extend_buf_ptr	
 24828                                  				;AC000; get extended message pointer
 24829                                  	;mov	word [extend_buf_ptr],3
 24830 00002C3D C706[CB8F]0300          	mov	word [extend_buf_ptr],BadSwt_Ptr
 24831                                  				;AN000; get "Invalid switch" message number
 24832 00002C43 E9DE00                  	jmp	cerror		; Print error and chill out...
 24833                                  
 24834                                  	; 25/02/2023
 24835                                  	; MSDOS 3.3
 24836                                  	;mov	dx,BADPARMPTR
 24837                                  	;jmp	CERROR
 24838                                  
 24839                                  REALWORK:
 24840 00002C46 FFD3                    	call	bx		; do some real work, at last
 24841                                  
 24842                                  ; See if we're in a batch CALL command. If we are, reprocess the command line,
 24843                                  ; otherwise, go get another command.
 24844                                  
 24845                                  CMD_DONE:
 24846 00002C48 0E                      	push	cs		; g  restore data segment
 24847 00002C49 1F                      	pop	ds		; g
 24848 00002C4A 1E                      	push	ds
 24849 00002C4B 8E1E[539C]              	mov	ds,[RESSEG]	; g  save data segment
 24850                                  	;cmp	byte [Call_Flag],1
 24851                                  				; G  Is a call in progress?
 24852 00002C4F 803E[B002]01            	cmp	byte [Call_Flag],call_in_progress
 24853 00002C54 C606[B002]00            	mov	byte [Call_Flag],0
 24854                                  				; G  Either way, reset flag
 24855 00002C59 1F                      	pop	ds		; g  get data segment back
 24856 00002C5A 7403                    	jz	short INCALL	; G
 24857 00002C5C E9A5D4                  	jmp	TCOMMAND	; chill out...
 24858                                  INCALL:
 24859                                  	;jmp	DOCOM1
 24860                                  	; 11/06/2023
 24861                                  	; Retro DOS v4.2 - MSDOS 6.22 COMMAND.COM
 24862 00002C5F E993D6                  	jmp	DOCOM0
 24863                                  
 24864                                  ; =============== S U B	R O U T	I N E =======================================
 24865                                  
 24866                                  	; 25/02/2023
 24867                                  noswit:
 24868 00002C62 57                      	push	di		; Save di
 24869 00002C63 BF8100                  	mov	di,81h		; di = ptr to command args
 24870 00002C66 BE8000                  	mov	si,80h		; Get address of length of command args
 24871 00002C69 AC                      	lodsb			; Load length
 24872 00002C6A 88C1                    	mov	cl,al		; Move length to cl
 24873 00002C6C 30ED                    	xor	ch,ch		; Zero ch
 24874 00002C6E 2EA0[579C]              	mov	al,[cs:SWITCHAR] ; al = switch character
 24875                                  	;cmp	al,0		; Turn off ZF
 24876                                  	; 25/02/2023
 24877 00002C72 20C0                    	and	al,al
 24878 00002C74 F2AE                    	repne	scasb		; Scan for a switch character and return
 24879 00002C76 5F                      	pop	di		;  with ZF set if one was found
 24880 00002C77 C3                      	retn
 24881                                  
 24882                                  ; ---------------------------------------------------------------------------
 24883                                  
 24884                                  	; 25/02/2023 - Retro DOS v4.0 COMMAND.COM
 24885                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:29A6h
 24886                                  
 24887                                  EXTERNAL:
 24888 00002C78 E89102                  	call	test_append	; check to see if append installed
 24889 00002C7B 7403                    	jz	short NOT_BARRYF
 24890                                  				; no - truly external command
 24891 00002C7D E9FCFE                  	jmp	APPEND_INTERNAL	; yes - go to Barryf code
 24892                                  
 24893                                  NOT_BARRYF:
 24894 00002C80 2EC606[669C]00          	mov	byte [cs:FILTYP],0
 24895 00002C86 2E8A16[739C]            	mov	dl,[cs:SPECDRV]
 24896 00002C8B 2E8816[1B9D]            	mov	[cs:IDLEN],dl
 24897 00002C90 2EC606[139E]00          	mov	byte [cs:ROM_CALL],0
 24898 00002C96 52                      	push	dx
 24899 00002C97 BA[1B9D]                	mov	dx,IDLEN
 24900 00002C9A E836D8                  	call	ROM_SCAN
 24901 00002C9D 5A                      	pop	dx
 24902                                  	;jnc	short POSTSAVE
 24903 00002C9E 7305                    	jnc	short DO_SCAN
 24904 00002CA0 2EFE06[139E]            	inc	byte [cs:ROM_CALL]
 24905                                  	;jmp	short POSTSAVE
 24906                                  
 24907                                  	;nop
 24908                                  DO_SCAN:
 24909                                  POSTSAVE:
 24910 00002CA5 BF[7B9B]                	mov	di,EXECPATH
 24911 00002CA8 C60500                  	mov	byte [di],0	; Initialize to current directory
 24912                                  	
 24913 00002CAB 2E803E[139E]00          	cmp	byte [cs:ROM_CALL],0
 24914                                  	;jz	short RESEARCH
 24915                                  	; 25/02/2023
 24916                                  	;jmp	short NEOEXECUTE
 24917 00002CB1 7577                    	jnz	short NEOEXECUTE
 24918                                  
 24919                                  	;nop
 24920                                  RESEARCH:
 24921 00002CB3 E8EA08                  	call	path_search	; find the mother (result in execpath)
 24922 00002CB6 09C0                    	or	ax,ax		; did we find anything?
 24923                                  	;jz	short BADCOMJ45	; null means no (sob)
 24924                                  	; 25/02/2023
 24925 00002CB8 7465                    	jz	short BADCOM
 24926 00002CBA 83F804                  	cmp	ax,4		; 04H and 08H are .exe and .com
 24927                                  				; fuckin' sixteen-bit machine ought
 24928                                  	;jl	short BATCOMJ	; to be able to handle a SIXTEEN-BIT
 24929                                  				; DISPLACEMENT!!
 24930                                  	;;jmp	short NEOEXECUTE
 24931                                  	;jmp	short EXECUTE	
 24932                                  	; 25/02/2023
 24933 00002CBD 7D6B                    	jnl	short EXECUTE ; jge
 24934                                  
 24935                                  	; 02H is .bat
 24936                                  
 24937                                  ; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 24938                                  ; PCDOS 7.1 COMMAND.COM
 24939                                  %if 1
 24940                                  		; ... .BAT file	...
 24941 00002CBF BA[7B9B]                	mov	dx,EXECPATH
 24942 00002CC2 B8003D                  	mov	ax,3D00h
 24943 00002CC5 CD21                    	int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 24944                                  				; DS:DX	-> ASCIZ filename
 24945                                  				; AL = access mode
 24946                                  				; 0 - read
 24947 00002CC7 7253                    	jb	short BATCOMJ
 24948 00002CC9 8326[F5A3]00            	and	word [TPBUF],0	; clear 1st two bytes of the buffer
 24949 00002CCE BA[F5A3]                	mov	dx,TPBUF
 24950 00002CD1 B90200                  	mov	cx,2
 24951 00002CD4 89C3                    	mov	bx,ax
 24952 00002CD6 B43F                    	mov	ah,3Fh
 24953 00002CD8 CD21                    	int	21h		; DOS -	2+ - READ FROM FILE WITH HANDLE
 24954                                  				; BX = file handle, CX = number	of bytes to read
 24955                                  				; DS:DX	-> buffer
 24956 00002CDA B43E                    	mov	ah,3Eh
 24957 00002CDC CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 24958                                  				; BX = file handle
 24959 00002CDE 813E[F5A3]2F2A          	cmp	word [TPBUF],2A2Fh ; '/*' (NASM syntax)
 24960 00002CE4 7536                    	jnz	short BATCOMJ
 24961 00002CE6 B8[6797]                	mov	ax,REXX_EXE ; "REXX.EXE"
 24962                                  	;mov	[ARG_ARGV],ax
 24963 00002CE9 A3[AF9F]                	mov	[ARG+ARGV_ELE.argpointer],ax
 24964                                  	;mov	word [ARGV0_ARG_FLAGS],0
 24965 00002CEC C706[B19F]0000          	mov	word [ARG+ARGV_ELE.argflags],0
 24966                                  	;mov	[ARGV0_ARGSTARTEL],ax
 24967 00002CF2 A3[B29F]                	mov	[ARG+ARGV_ELE.argstartel],ax
 24968                                  	;mov	word [ARGV0_ARGLEN],8
 24969 00002CF5 C706[B49F]0800          	mov	word [ARG+ARGV_ELE.arglen],8
 24970                                  	;mov	word [ARGV0_ARGSW_WORD],0
 24971 00002CFB C706[B69F]0000          	mov	word [ARG+ARGV_ELE.argsw_word],0
 24972                                  	;mov	[ARGV0_ARG_OCOMPTR],ax
 24973 00002D01 A3[B89F]                	mov	[ARG+ARGV_ELE.arg_ocomptr],ax
 24974                                  				; pointer into original	command	string
 24975 00002D04 E89908                  	call	path_search
 24976 00002D07 85C0                    	test	ax,ax
 24977 00002D09 740C                    	jz	short rexx_nf_err
 24978 00002D0B BE[B39A]                	mov	si,COMBUF+1
 24979 00002D0E BF8000                  	mov	di,80h		; PSP command tail (arguments)
 24980 00002D11 89F9                    	mov	cx,di ; 128
 24981 00002D13 F3A4                    	rep movsb
 24982 00002D15 EB13                    	jmp	short NEOEXECUTE
 24983                                  rexx_nf_err:
 24984 00002D17 BA[F18F]                	mov	dx,REXXNOTF_PTR	; MSG_1012 ; REXX.EXE not found
 24985 00002D1A EB08                    	jmp	short cerror	
 24986                                  %endif
 24987                                  
 24988                                  	;nop
 24989                                  BATCOMJ:
 24990 00002D1C E97DDB                  	jmp	BATCOM
 24991                                  
 24992                                  	; 25/02/2023
 24993                                  ;BADCOMJ45:
 24994                                  	;jmp	short BADCOM
 24995                                  
 24996                                  ; 06/08/2024
 24997                                  ; ---------------------------------------------------------------------------
 24998                                  
 24999                                  	;  25/02/2023 - Retro DOS v4.0 COMMAND.COM
 25000                                  BADCOM:
 25001 00002D1F 0E                      	push	cs
 25002 00002D20 1F                      	pop	ds
 25003 00002D21 BA[EE8F]                	mov	dx,BADNAM_PTR
 25004                                  cerror:		
 25005 00002D24 E8EE26                  	call	std_eprintf
 25006 00002D27 E9DAD3                  	jmp	TCOMMAND
 25007                                  
 25008                                  ; ---------------------------------------------------------------------------
 25009                                  
 25010                                  	;nop
 25011                                  EXECUTE:
 25012                                  NEOEXECUTE:
 25013 00002D2A E88102                  	call	IOSET
 25014                                  
 25015                                  ; MSDOS 6.0
 25016                                  ;M051
 25017                                  ; Previously LoadHigh was jumping to the execute label above. This was wrong
 25018                                  ;because IOSET was getting invoked twice resulting in 2 sets of redirections.
 25019                                  ;After a close, this would still leave one open active resulting in sharing
 25020                                  ;errors on subsequent opens of the redirected file.
 25021                                  
 25022                                  LH_EXECUTE:			;M051	
 25023 00002D2D 8E06[639C]              	mov	es,[TRAN_TPA]
 25024                                  	;mov	ah,DEALLOC ; 49h
 25025 00002D31 B449                    	mov	ah,49h
 25026 00002D33 CD21                    	int	21h	; DOS -	2+ - FREE MEMORY
 25027                                  			; ES = segment address of area to be freed
 25028                                  				; Now running in "free" space
 25029 00002D35 8E06[539C]              	mov	es,[RESSEG]
 25030 00002D39 26FE06[9902]            	inc	byte [es:ExtCom] ; Indicate external command
 25031 00002D3E 26C606[A102]00          	mov	byte [es:RestDir],0 
 25032                                  				; Since USERDIR1 is in transient, insure
 25033                                  				; this flag value for re-entry to COMMAND
 25034                                  	; MSDOS 6.0
 25035 00002D44 BE[7B9B]                	mov	si,EXECPATH	  ; offset TRANGROUP:EXECPATH	
 25036 00002D47 BF[5E04]                	mov	di,SafePathBuffer ; offset RESGROUP:SAFEPATHBUFFER
 25037                                  	;mov	cx,LENMSGORPATHBUF
 25038 00002D4A B95000                  	mov	cx,80
 25039 00002D4D FC                      	cld
 25040 00002D4E F3A4                    	rep	movsb		; copy program pathname to resident
 25041                                  
 25042                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25043 00002D50 BF5C00                  	mov	di,FCB ; 5Ch
 25044 00002D53 89FE                    	mov	si,di
 25045                                  	;mov	cx,82 ; 52h	; moving (100h-5Ch)/2 = 80h-2Eh
 25046 00002D55 B152                    	mov	cl,82 ; 25/02/2023
 25047 00002D57 F3A5                    	rep	movsw		; Transfer parameters to resident header
 25048                                  	
 25049                                  	; 25/02/2023
 25050                                  	;mov	dx,EXECPATH  ; MSDOS 3.3
 25051                                  	; MSDOS 6.0 (& 5.0)
 25052                                  	;mov	dx,offset RESGROUP:SAFEPATHBUFFER
 25053 00002D59 BA[5E04]                	mov	dx,SafePathBuffer
 25054 00002D5C 06                      	push	es
 25055 00002D5D 1F                      	pop	ds
 25056                                  
 25057                                  	;mov	bx,offset RESGROUP:EXEC_BLOCK
 25058 00002D5E BB[3A04]                	mov	bx,Exec_Block  ; = offset EnvirSeg
 25059                                  	;mov	ax,EXEC*256 ; 4B00h
 25060 00002D61 B8004B                  	mov	ax,4B00h
 25061                                  	;test	byte [ROM_CALL],-1 ; 0FFh ; MSDOS 3.3
 25062 00002D64 2EF606[139E]FF          	test	byte [cs:ROM_CALL],-1 ; MSDOS 6.0 (& 5.0)
 25063 00002D6A 7403                    	jz	short OK_EXEC
 25064 00002D6C E9DDD7                  	jmp	ROM_EXEC
 25065                                  
 25066                                  OK_EXEC:
 25067                                  
 25068                                  ; we are now running in free space. Anything we do from here on may get
 25069                                  ; trashed. Move the stack (also in free space) to allocated space because
 25070                                  ; since EXEC restores the stack, somebody may trash what is on the stack.
 25071                                  
 25072 00002D6F 8CC1                    	mov	cx,es
 25073 00002D71 8ED1                    	mov	ss,cx
 25074 00002D73 BC[2E05]                	mov	sp,RStack
 25075                                  	; MSDOS 3.3
 25076                                  	;jmp	far [EXEC_ADDR]	; Jmp to the EXEC in the resident
 25077                                  	; 25/02/2023
 25078                                  	; MSDOS 6.0
 25079 00002D76 2EFF2E[599C]            	jmp	far [cs:EXEC_ADDR] ; Jmp to the EXEC in the resident
 25080                                  
 25081                                  ; =============== S U B	R O U T	I N E =======================================
 25082                                  
 25083                                  ; Prescan converts the input buffer into a canonicalized form.
 25084                                  ; All redirections and pipes are removed.
 25085                                  
 25086                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25087                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2A51h
 25088                                  
 25089                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25090                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:2FFBh
 25091                                  
 25092                                  	; 05/08/2024 - Retro DOS v5.0 COMMAND.COM
 25093                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2E8Dh
 25094                                  PRESCAN:
 25095 00002D7B 31C9                    	xor	cx,cx
 25096 00002D7D 8E06[539C]              	mov	es,[RESSEG]
 25097 00002D81 BE[B49A]                	mov	si,COMBUF+2
 25098 00002D84 89F7                    	mov	di,si
 25099                                  COUNTQUOTES:
 25100 00002D86 AC                      	lodsb			; get a byte
 25101 00002D87 3C22                    	cmp	al,22h	; '"'	; is it a quote?
 25102 00002D89 7504                    	jne	short COUNTEND	; no, try for end of road
 25103 00002D8B FEC5                    	inc	ch		; bump count
 25104 00002D8D EBF7                    	jmp	short COUNTQUOTES
 25105                                  				; go get next char
 25106                                  COUNTEND:
 25107 00002D8F 3C0D                    	cmp	al,0Dh	; 13	; end of road?
 25108 00002D91 75F3                    	jne	short COUNTQUOTES
 25109                                  				; no, go back for next char
 25110                                  	; 26/02/2023
 25111                                  	; MSDOS 5.0 (& 6.0)
 25112 00002D93 51                      	push	cx		; save count
 25113 00002D94 89FE                    	mov	si,di		; restore pointer to begining
 25114                                  KanjiScan:
 25115 00002D96 AC                      	lodsb			; get a byte
 25116 00002D97 E8C5F9                  	call	testkanj	; is it a leadin byte
 25117 00002D9A 740F                    	jz	short KanjiQuote
 25118                                  				; no, check for quotes
 25119 00002D9C 88C4                    	mov	ah,al		; save leadin
 25120 00002D9E AC                      	lodsb			; get trailing byte
 25121 00002D9F 3D2020                  	cmp	ax,2020h
 25122                                  	;cmp	ax,DB_SPACE	; is it Kanji space
 25123 00002DA2 75F2                    	jne	short KanjiScan	; no, go get next
 25124 00002DA4 C744FE2020              	mov	word [si-2],2020h
 25125                                  				; replace with spaces
 25126 00002DA9 EBEB                    	jmp	short KanjiScan	; go get next char
 25127                                  	
 25128                                  KanjiQuote:
 25129 00002DAB 3C22                    	cmp	al,22h	; '"'	; beginning of quoted string
 25130 00002DAD 750D                    	jne	short KanjiEnd	; no, check for end
 25131 00002DAF FECD                    	dec	ch		; drop count
 25132 00002DB1 74E3                    	jz	short KanjiScan	; if count is zero, no quoting
 25133                                  KanjiQuoteLoop:
 25134 00002DB3 AC                      	lodsb			; get next byte
 25135 00002DB4 3C22                    	cmp	al,22h	; '"'	; is it another quote
 25136 00002DB6 75FB                    	jne	short KanjiQuoteLoop
 25137                                  				; no, get another
 25138 00002DB8 FECD                    	dec	ch		; yes, drop count
 25139 00002DBA EBDA                    	jmp	short KanjiScan	; go get next char
 25140                                  KanjiEnd:
 25141 00002DBC 3C0D                    	cmp	al,13 ; 0Dh	; end of line character?
 25142 00002DBE 75D6                    	jne	short KanjiScan	; go back to beginning
 25143 00002DC0 59                      	pop	cx		; get back original count
 25144                                  	; 26/04/2023
 25145 00002DC1 89FE                    	mov	si,di		; restore pointer to beginning
 25146                                  	
 25147                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25148                                  PRESCANLP:
 25149 00002DC3 AC                      	lodsb
 25150                                  	; 26/02/2023
 25151 00002DC4 E898F9                  	call	testkanj
 25152 00002DC7 740C                    	jz	short NOTKANJ6
 25153                                  	; MSDOS 6.0
 25154 00002DC9 8805                    	mov	[di],al
 25155 00002DCB 47                      	inc	di		; fake STOSB into DS
 25156 00002DCC AC                      	lodsb			; grab second byte
 25157 00002DCD 8805                    	mov	[di],al		; fake stosb into DS
 25158 00002DCF FEC1                    	inc	cl
 25159 00002DD1 FEC1                    	inc	cl
 25160 00002DD3 EBEE                    	jmp	short PRESCANLP
 25161                                  
 25162                                  NOTKANJ6:
 25163                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25164 00002DD5 3C22                    	cmp	al,'"'	; 22h	; " character
 25165 00002DD7 7510                    	jne	short TRYGREATER
 25166 00002DD9 FECD                    	dec	ch
 25167 00002DDB 740C                    	jz	short TRYGREATER
 25168                                  QLOOP:
 25169 00002DDD 8805                    	mov	[di],al
 25170 00002DDF 47                      	inc	di
 25171 00002DE0 FEC1                    	inc	cl
 25172 00002DE2 AC                      	lodsb
 25173 00002DE3 3C22                    	cmp	al,'"'		; " character
 25174 00002DE5 75F6                    	jne	short QLOOP
 25175 00002DE7 FECD                    	dec	ch
 25176                                  TRYGREATER:
 25177 00002DE9 3C3E                    	cmp	al,'>' ; 3Eh
 25178                                  	;cmp	al,rabracket	; MSDOS 6.0 (& 5.0)
 25179                                  	;;cmp	al,[RABRACKET]	; MSDOS 3.3
 25180 00002DEB 7565                    	jne	short NOOUT
 25181                                  
 25182                                  ; We have found a ">" char. We need to see if there is another ">"
 25183                                  ; following it.
 25184                                  
 25185 00002DED 3804                    	cmp	[si],al
 25186 00002DEF 7506                    	jne	short NOAPPND
 25187 00002DF1 AC                      	lodsb
 25188 00002DF2 26FE06[C102]            	inc	byte [es:Re_Out_App] ; Flag >>
 25189                                  NOAPPND:
 25190                                  ; Now we attempt to find the file name. First, scan off all whitespace
 25191                                  
 25192 00002DF7 E88AFB                  	call	scanoff
 25193                                  
 25194                                  	; 26/02/2023
 25195                                  	; MSDOS 6.0
 25196 00002DFA 3C3C                    	cmp	al,'<' ; 3Ch
 25197                                  	;cmp	al,labracket	;AN040; was there no filename?
 25198 00002DFC 7404                    	je	short REOUT_ERRSET
 25199                                  				;AN040; yes - set up error
 25200                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25201 00002DFE 3C0D                    	cmp	al,0Dh
 25202 00002E00 750D                    	jnz	short GOTREOFIL
 25203                                  
 25204                                  ; There was no file present. Set us up at end-of-line.
 25205                                  
 25206                                  REOUT_ERRSET:			;AN040; set up for an error
 25207 00002E02 C6050D                  	mov	byte [di],0Dh	; Clobber first ">"
 25208 00002E05 26C706[C202]0900        	mov	word [es:Re_OutStr],9
 25209                                  				; Cause an error later
 25210 00002E0C E9B700                  	jmp	PRESCANEND
 25211                                  
 25212                                  GOTREOFIL:
 25213 00002E0F 57                      	push	di
 25214                                  	;mov	di,offset RESGROUP:RE_OUTSTR
 25215 00002E10 BF[C202]                	mov	di,Re_OutStr
 25216 00002E13 89FB                    	mov	bx,di
 25217 00002E15 06                      	push	es
 25218                                  
 25219                                  	; 26/02/2023
 25220                                  	; MSDOS 6.0
 25221                                  SETREOUTSTR:			; Get the output redirection name
 25222                                  				; MSKK06 07/14/89
 25223 00002E16 51                      	push	cx		; save cx
 25224 00002E17 B94D00                  	mov	cx,64+13	; CX = max string length
 25225                                  SETREOUTSTR_LOOP:
 25226 00002E1A AC                      	lodsb
 25227 00002E1B 3C0D                    	cmp	al,0Dh
 25228 00002E1D 741A                    	je	short GOTRESTR_J
 25229 00002E1F E86AFB                  	call	DELIM
 25230 00002E22 7415                    	jz	short GOTRESTR_J
 25231 00002E24 3A06[579C]              	cmp	al,[SWITCHAR]
 25232 00002E28 740F                    	je	short GOTRESTR_J
 25233 00002E2A 3C22                    	cmp	al,'"' ; 22h 	;AN033; Is the character a quote?
 25234 00002E2C 7421                    	je	short PIPEERRSYNJ5_J
 25235                                  				;AN033; Yes - get out quick - or system crashes
 25236 00002E2E 3C3C                    	cmp	al,'<' ; 3Ch
 25237                                  	;cmp	al,labracket	;AN002; Is char for input redirection
 25238 00002E30 7404                    	je	short ABRACKET_TERM
 25239                                  				;AN002; yes - end of string
 25240 00002E32 3C3E                    	cmp	al,'>' ; 3Eh
 25241                                  	;cmp	al,rabracket	;AN002; Is char for output redirection
 25242 00002E34 7506                    	jne	short NO_ABRACKET
 25243                                  				;AN002; no - not end of string
 25244                                  ABRACKET_TERM:			;AN002; have end of string by < or >
 25245 00002E36 4E                      	dec	si		;AN002; back up over symbol
 25246 00002E37 B020                    	mov	al,20h ; BLANK	;AN002; show delimiter as char
 25247                                  GOTRESTR_J:
 25248 00002E39 59                      	pop	cx		; MSKK06 07/14/89
 25249 00002E3A EB66                    	jmp	short GOTRESTR	;AN002; go process it
 25250                                  NO_ABRACKET:			;AN002; NOT AT END OF STRING
 25251 00002E3C AA                      	stosb			; store it into resgroup
 25252                                  
 25253                                  ; 05/08/2024 - PCDOS 7.1 COMMAND.COM
 25254                                  %if 1
 25255                                  ;ifdef DBCS
 25256                                  	;invoke	testkanj
 25257                                  	;jz	short @f	; if not lead byte of DBCS
 25258 00002E3D E81FF9                  	call	testkanj
 25259 00002E40 7409                    	jz	short NO_ABRACKET_@
 25260 00002E42 E3F5                    	jcxz	GOTRESTR_J	; if no tail byte
 25261 00002E44 AC                      	lodsb
 25262 00002E45 3C0D                    	cmp	al,0Dh
 25263 00002E47 74F0                    	jz	short GOTRESTR_J ; if tail byte does't come and ends
 25264 00002E49 AA                      	stosb			; copy tail byte
 25265 00002E4A 49                      	dec	cx
 25266                                  ;@@:
 25267                                  NO_ABRACKET_@:	; 05/08/2024
 25268                                  ;endif
 25269                                  %endif
 25270                                  
 25271 00002E4B E2CD                    	loop	SETREOUTSTR_LOOP
 25272                                  				; MSKK06 07/14/89
 25273 00002E4D EBEA                    	jmp	short GOTRESTR_J
 25274                                  PIPEERRSYNJ5_J:
 25275 00002E4F 59                      	pop	cx		; recover CX
 25276 00002E50 EB4B                    	jmp	short PIPEERRSYNJ5
 25277                                  
 25278                                  	; 26/02/2023
 25279                                  ;	; MSDOS 3.3
 25280                                  ;SETREOUTSTR_LOOP:		; Get the output redirection name
 25281                                  ;	lodsb
 25282                                  ;	cmp	al,0Dh
 25283                                  ;	jz	short GOTRESTR
 25284                                  ;	call	DELIM
 25285                                  ;	jz	short GOTRESTR
 25286                                  ;	cmp	al,[SWITCHAR]
 25287                                  ;	je	short GOTRESTR
 25288                                  ;	cmp	al,'"'
 25289                                  ;	jne	short NO_ABRACKET
 25290                                  ;	dec	ch
 25291                                  ;NO_ABRACKET:
 25292                                  ;	stosb
 25293                                  ;	jmp	short SETREOUTSTR_LOOP
 25294                                  
 25295                                  NOOUT:
 25296                                  	; 26/02/2023
 25297                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25298 00002E52 3C3C                    	cmp	al, '<' ; 3Ch
 25299                                  	;cmp	al,labracket	; MSDOS 6.0
 25300                                  	;;cmp	al,[LABRACKET]  ; MSDOS 3.3
 25301 00002E54 7523                    	jne	short CHKPIPE
 25302 00002E56 89F3                    	mov	bx,si		; Save loc of "<"
 25303 00002E58 E829FB                  	call	scanoff
 25304                                  	; MSDOS 6.0
 25305 00002E5B 3C3E                    	cmp	al,'>' ; 3Eh
 25306                                  	;cmp	al,rabracket	;AN040; was there no filename?
 25307 00002E5D 7404                    	je	short REIN_ERRSET ;AN040; yes - set up error
 25308                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25309 00002E5F 3C0D                    	cmp	al,0Dh
 25310 00002E61 750B                    	jne	short GOTREIFIL
 25311                                  REIN_ERRSET:			;AN040; set up for error
 25312 00002E63 C6050D                  	mov	byte [di],0Dh	; Clobber "<"
 25313 00002E66 C706[FE9B]0900          	mov	word [RE_INSTR],9 
 25314                                  				; Cause an error later
 25315 00002E6C EB58                    	jmp	short PRESCANEND
 25316                                  GOTREIFIL:
 25317 00002E6E 57                      	push	di
 25318 00002E6F BF[FE9B]                	mov	di,RE_INSTR
 25319 00002E72 89FB                    	mov	bx,di
 25320 00002E74 06                      	push	es
 25321 00002E75 0E                      	push	cs
 25322 00002E76 07                      	pop	es		; store in TRANGROUP
 25323                                  	; 26/04/2023
 25324                                  	;jmp	short SETREOUTSTR_LOOP  ; MSDOS 3.3 COMMAND.COM
 25325 00002E77 EB9D                    	jmp	short SETREOUTSTR ; MSDOS 5.0 (& 6.0) COMMAND.COM
 25326                                  				; Get the input redirection name
 25327                                  CHKPIPE:
 25328 00002E79 88C4                    	mov	ah,al
 25329                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25330 00002E7B 80FC7C                  	cmp	ah,'|' ; 7Ch
 25331                                  	;cmp	ah,ALTPIPECHR ; 7Ch
 25332                                  	;je	short ISPIPE3
 25333                                  	;; MSDOS 6.0
 25334                                  	;cmp	ah,'|' ; 7Ch
 25335                                  	;;cmp	al,vbar ; 7Ch
 25336                                  	;;;cmp	ah,[VBAR]  ; MSDOS 3.3
 25337 00002E7E 7539                    	jne	short CONTPRESCAN
 25338                                  ISPIPE3:
 25339                                  ; Only push the echo flag if we are entering the pipe for the first time.
 25340                                  
 25341 00002E80 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 25342 00002E86 7505                    	jne	short NOECHOPUSH
 25343 00002E88 26D026[9D02]            	shl	byte [es:EchoFlag],1 ; push echo state and turn it off
 25344                                  NOECHOPUSH:
 25345 00002E8D 26FE06[1303]            	inc	byte [es:PipeFlag]
 25346 00002E92 E8EFFA                  	call	scanoff
 25347 00002E95 3C0D                    	cmp	al,0Dh
 25348 00002E97 7404                    	je	short PIPEERRSYNJ5
 25349                                  	; 26/02/2023
 25350 00002E99 3C7C                    	cmp	al,'|' ; 7Ch
 25351                                  	;cmp	al,ALTPIPECHR ; 7Ch
 25352                                  	;je	short PIPEERRSYNJ5
 25353                                  	;; MSDOS 6.0
 25354                                  	;cmp	al,'|' ; 7Ch
 25355                                  	;;cmp	al,vbar ; 7Ch
 25356                                  	;;;cmp	al,[VBAR]  ; MSDOS 3.3	
 25357 00002E9B 751C                    	jne	short CONTPRESCAN
 25358                                  
 25359                                  PIPEERRSYNJ5:
 25360 00002E9D 06                      	push	es
 25361 00002E9E 1F                      	pop	ds
 25362 00002E9F E99E02                  	jmp	PIPEERRSYN
 25363                                  
 25364                                  ; Trailing :s are allowed on devices. Check to be sure that there is more
 25365                                  ; than just a : in the redir string.
 25366                                  
 25367                                  GOTRESTR:
 25368 00002EA2 86E0                    	xchg	ah,al
 25369 00002EA4 B03A                    	mov	al,':' ; 3Ah
 25370 00002EA6 29FB                    	sub	bx,di		; compute negative of number of chars
 25371 00002EA8 83FBFF                  	cmp	bx,-1		; is there just a :?
 25372 00002EAB 7407                    	je	short NOTRAILCOL ; yep, don't change
 25373 00002EAD 263845FF                	cmp	[es:di-1],al	; Trailing ':' OK on devices
 25374 00002EB1 7501                    	jne	short NOTRAILCOL
 25375 00002EB3 4F                      	dec	di		; Back up over trailing ':'
 25376                                  NOTRAILCOL:
 25377 00002EB4 30C0                    	xor	al,al
 25378 00002EB6 AA                      	stosb			; NUL terminate the string
 25379 00002EB7 07                      	pop	es
 25380 00002EB8 5F                      	pop	di		; Remember the start
 25381                                  CONTPRESCAN:
 25382 00002EB9 8825                    	mov	[di],ah		; "delete" the redirection string
 25383 00002EBB 47                      	inc	di
 25384 00002EBC 80FC0D                  	cmp	ah,0Dh
 25385 00002EBF 7405                    	je	short PRESCANEND
 25386 00002EC1 FEC1                    	inc	cl
 25387 00002EC3 E9FDFE                  	jmp	PRESCANLP
 25388                                  PRESCANEND:
 25389 00002EC6 26803E[1303]00          	cmp	byte [es:PipeFlag],0
 25390 00002ECC 7414                    	jz	short ISNOPIPE
 25391                                  
 25392                                  	; 11/06/2023
 25393                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:314Ah
 25394                                  	;mov	di,48Ah		; PipeStr ; RESGROUP:EndInit+160
 25395                                  	;mov	[es:488h],di	; [es:PipePtr],di
 25396                                  				; (RESGROUP:EndInit+158)
 25397                                  	; 26/02/2023
 25398                                  	;;MSDOS 5.0 COMMAND.COM - TRANGROUP:2BA0h
 25399                                  	;;mov	di,3C0h		; offset RESGROUP:PIPESTR
 25400                                  	;;			; (EndInit+160]
 25401                                  
 25402                                  	; 05/08/2024
 25403                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:2FEAh
 25404                                  	;mov	di,4BEh		; PipeStr ; RESGROUP:EndInit+160	
 25405                                  	;mov	[es:4BCh],di	; (RESGROUP:EndInit+158)
 25406                                  
 25407                                  	;mov	di,offset RESGROUP:PIPESTR
 25408 00002ECE BF[B503]                	mov	di,PipeStr	; RESGROUP:EndInit+160
 25409                                  
 25410                                  	;;MSDOS 5.0 COMMAND.COM - TRANGROUP:2BA3h
 25411                                  	;;mov	[es:3BEh],di	; [es:EndInit+158]
 25412 00002ED1 26893E[B303]            	mov	[es:PipePtr],di	; RESGROUP:EndInit+158
 25413                                  	
 25414 00002ED6 BE[B49A]                	mov	si,COMBUF+2
 25415 00002ED9 E8A8FA                  	call	scanoff
 25416                                  PIPESETLP:			; Transfer the pipe into the resident
 25417 00002EDC AC                      	lodsb			; pipe buffer
 25418 00002EDD AA                      	stosb
 25419 00002EDE 3C0D                    	cmp	al,0Dh
 25420 00002EE0 75FA                    	jnz	short PIPESETLP
 25421                                  ISNOPIPE:
 25422 00002EE2 880E[B39A]              	mov	[COMBUF+1],cl
 25423 00002EE6 26803E[1303]00          	cmp	byte [es:PipeFlag],0 ; [es:41Ch] ; PCDOS 7.1 COMMAND.COM
 25424 00002EEC 0E                      	push	cs
 25425 00002EED 07                      	pop	es
 25426 00002EEE C3                      	retn
 25427                                  
 25428                                  ; =============== S U B	R O U T	I N E =======================================
 25429                                  
 25430                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25431                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2BC1h
 25432                                  cmd_copy:
 25433 00002EEF BE[B49A]                	mov	si,COMBUF+2
 25434 00002EF2 E88FFA                  	call	scanoff		; advance past separators...
 25435 00002EF5 0336[F09D]              	add	si,[PathPos]
 25436 00002EF9 BF8100                  	mov	di,81h
 25437 00002EFC 31C9                    	xor	cx,cx
 25438                                  cmdcopy:
 25439 00002EFE AC                      	lodsb
 25440 00002EFF AA                      	stosb
 25441 00002F00 3C0D                    	cmp	al,0Dh
 25442 00002F02 7403                    	je	short copy_done
 25443 00002F04 41                      	inc	cx
 25444 00002F05 EBF7                    	jmp	short cmdcopy
 25445                                  copy_done:
 25446 00002F07 880E8000                	mov	[80h],cl
 25447 00002F0B C3                      	retn
 25448                                  
 25449                                  ; =============== S U B	R O U T	I N E =======================================
 25450                                  
 25451                                  	; 25/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25452                                  test_append:
 25453 00002F0C BB[B29A]                	mov	bx,COMBUF	; barry can address
 25454 00002F0F BE[1B9D]                	mov	si,IDLEN	; address command name, DS already set 	
 25455 00002F12 BAFFFF                  	mov	dx,-1
 25456 00002F15 B800AE                  	mov	ax,0AE00h
 25457 00002F18 CD2F                    	int	2Fh	; - Multiplex -	DOS 3.3+ internal 
 25458                                  			; - INSTALLABLE	COMMAND	- INSTALL CHECK
 25459                                  			; DX = FFFFh,[BX -> command line
 25460                                  			; Return: AL = FFh if this command is a TSR extension 
 25461                                  			;		   to COMMAND.COM
 25462                                  			; AL = 00h if the command should be executed as	usual
 25463                                  	;cmp	al,0
 25464 00002F1A 08C0                    	or	al,al ; 25/02/2023
 25465 00002F1C C3                      	retn
 25466                                  
 25467                                  	; 25/02/2023
 25468                                  	; INT 2Fh
 25469                                  	; 	AX = AE00h
 25470                                  	; entry:
 25471                                  	; 	DX = magic value FFFFh
 25472                                  	; 	CH = FFh
 25473                                  	; 	CL = length of command line tail
 25474                                  	; 	DS:BX -> command line buffer  -- (offset COMBUF)
 25475                                  	; 	DS:SI -> command name buffer  -- (offset IDLEN)
 25476                                  	; return:
 25477                                  	;	AL = FFh if this command is a TSR extension to COMMAND.COM
 25478                                  	;	AL = 00h if the command should be executed as usual
 25479                                  	;
 25480                                  	; Format of COMMAND.COM command line buffer:
 25481                                  	;	Offset  Size    Description
 25482                                  	;	00h     BYTE    max length of command line, as in INT 21/AH=0Ah
 25483                                  	;	01h     BYTE    count of bytes to follow, excluding terminating 0Dh
 25484                                  	;	N BYTEs command line text, terminated by 0Dh
 25485                                  	;
 25486                                  	; Format of command name buffer:
 25487                                  	;	Offset  Size    Description
 25488                                  	;	00h     BYTE    length of command name
 25489                                  	;	01h    N BYTEs  uppercased command name (blank-padded to 11 chars)
 25490                                  
 25491                                  ;============================================================================
 25492                                  ; TMISC2.ASM, MSDOS 6.0, 1991
 25493                                  ;============================================================================
 25494                                  ; 05/10/2018 - Retro DOS v3.0
 25495                                  
 25496                                  ;	More misc routines
 25497                                  
 25498                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1D9Bh
 25499                                  
 25500                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25501                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2BEFh
 25502                                  
 25503                                  ; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25504                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3199h
 25505                                  
 25506                                  ; 05/08/2024 - Retro DOS v5.0 COMMAND.COM
 25507                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 3039h
 25508                                  
 25509                                  ; =============== S U B	R O U T	I N E =======================================
 25510                                  
 25511                                  SETPATH:
 25512                                  
 25513                                  ; ENTRY PathPos = ptr to string
 25514                                  ;       PathCnt = length of string
 25515                                  ;
 25516                                  ; EXIT  PathPos = ptr to string after pathname
 25517                                  ;       PathCnt = length of rest of string
 25518                                  ;       DX = ptr to pathname in string, made ASCIIZ
 25519                                  ;       DestIsDir = 1 if pathname delimiters appeared in pathname, 0 otherwise
 25520                                  ;       DestInfo = 2 if wildcards (?, *) appeared in pathname, 0 otherwise
 25521                                  ;
 25522                                  ;       A null character is dropped at the end of the pathname. If the
 25523                                  ;       character in that spot previously was CR, it is copied into the
 25524                                  ;       following byte. So there must be at least two two character 
 25525                                  ;       positions in the buffer following the pathname.
 25526                                  
 25527                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25528                                  	
 25529                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25530                                  	; MSDOS 6.0
 25531                                  	;mov	ax,[PathCnt]	;AC000; get length of string
 25532                                  	;mov	si,[PathPos]	;AC000; get start of source buffer
 25533                                  
 25534                                  	; 26/02/2023
 25535                                  	; MSDOS 3.3
 25536                                  	;mov	si,80h
 25537                                  	;lodsb
 25538                                  	;xor	ah,ah
 25539                                  	;mov	[PATCNT],ax
 25540                                  	;mov	[PATHPOS],si
 25541                                  GETPATH:
 25542                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25543 00002F1D C606[1C9E]00            	mov	byte [DestInfo],0
 25544 00002F22 C606[189E]00            	mov	byte [DestIsDir],0
 25545 00002F27 8B36[F09D]              	mov	si,[PathPos]	; SI = ptr to string
 25546 00002F2B 8B0E[EE9D]              	mov	cx,[PathCnt]	; CX = string length
 25547 00002F2F 89F2                    	mov	dx,si		; DX = ptr to string
 25548 00002F31 E34D                    	jcxz	PATHDONE	; string length is zero, we're done
 25549 00002F33 51                      	push	cx		; save string length
 25550 00002F34 56                      	push	si		; save ptr to string
 25551 00002F35 E80AFC                  	call	SWITCH
 25552                                  
 25553                                  ;       After Switch, SI has been scanned past any switches, and
 25554                                  ;       switches that COMMAND intrinsically recognizes are recorded in AX.
 25555                                  
 25556 00002F38 A3[F29D]                	mov	[PathSw],ax	; PathSw = switch occurrence mask
 25557 00002F3B 5B                      	pop	bx		; BX = ptr to original string
 25558 00002F3C 29F3                    	sub	bx,si		; BX = -(# chars scanned by Switch)
 25559 00002F3E 59                      	pop	cx		; CX = string length
 25560 00002F3F 01D9                    	add	cx,bx		; CX = string length from current SI
 25561 00002F41 89F2                    	mov	dx,si		; DX = ptr to current string
 25562                                  SKIPPATH:
 25563                                  	; 26/02/2023
 25564                                  	; MSDOS 6.0
 25565 00002F43 C606[AE9F]00            	mov	byte [KPARSE],0
 25566                                  SKIPPATH2:
 25567 00002F48 E336                    	jcxz	PATHDONE	; string length is zero, we're done
 25568 00002F4A 49                      	dec	cx		; CX = length left after next char
 25569 00002F4B AC                      	lodsb			; AL = next char of string
 25570                                  				; SI = ptr to char after this one
 25571                                  	; 26/02/2023
 25572 00002F4C E810F8                  	call	testkanj
 25573 00002F4F 7408                    	jz	short TESTPPSEP
 25574 00002F51 49                      	dec	cx
 25575 00002F52 46                      	inc	si
 25576 00002F53 FE06[AE9F]              	inc	byte [KPARSE]
 25577 00002F57 EBEF                    	jmp	short SKIPPATH2
 25578                                  TESTPPSEP:
 25579 00002F59 E8B6FA                  	call	pathchrcmp	; compare AL to path delimiter char
 25580 00002F5C 7504                    	jnz	short TESTPMETA	; it's not a path delim
 25581 00002F5E FE06[189E]              	inc	byte [DestIsDir]
 25582                                  				; DestIsDir = 1, signalling path char
 25583                                  TESTPMETA:
 25584 00002F62 3C3F                    	cmp	al,'?'
 25585 00002F64 7505                    	jne	short TESTPSTAR	; char is not '?'
 25586 00002F66 800E[1C9E]02            	or	byte [DestInfo],2 ; DestInfo = 2, signalling wildcard
 25587                                  TESTPSTAR:
 25588 00002F6B 3C2A                    	cmp	al,'*'
 25589                                  	;cmp	al,[STAR] ; MSDOS 3.3	
 25590 00002F6D 7505                    	jne	short TESTPDELIM ; char is not '*'
 25591 00002F6F 800E[1C9E]02            	or	byte [DestInfo],2 ; DestInfo = 2, signalling wildcard
 25592                                  TESTPDELIM:
 25593 00002F74 E815FA                  	call	DELIM		; compare AL to all delimiters
 25594 00002F77 7406                    	jz	short PATHDONEDEC ; delimiter found, back up & leave
 25595 00002F79 3A06[579C]              	cmp	al,[SWITCHAR]
 25596 00002F7D 75C4                    	jne	short SKIPPATH	; char isn't switch, go get next char
 25597                                  PATHDONEDEC:
 25598 00002F7F 4E                      	dec	si		; SI = ptr to char after pathname
 25599                                  PATHDONE:
 25600 00002F80 30C0                    	xor	al,al		; AL = NULL
 25601 00002F82 8604                    	xchg	al,[si]		; place NULL after pathname
 25602 00002F84 46                      	inc	si		; SI = ptr to byte after NULL
 25603 00002F85 3C0D                    	cmp	al,0Dh		; were we at end of line?
 25604 00002F87 7502                    	jne	short NOPSTORE	; not EOL, finish up
 25605 00002F89 8804                    	mov	[si],al		; save EOL after NULL
 25606                                  NOPSTORE:
 25607 00002F8B 8936[F09D]              	mov	[PathPos],si	; PathPos = ptr to char after NULL
 25608 00002F8F 890E[EE9D]              	mov	[PathCnt],cx	; PathCnt = length of string left
 25609                                  SETPATH_RETN:
 25610 00002F93 C3                      	retn
 25611                                  
 25612                                  ; ---------------------------------------------------------------------------
 25613                                  
 25614                                  PGETARG:
 25615 00002F94 BE8000                  	mov	si,80h
 25616 00002F97 AC                      	lodsb
 25617 00002F98 08C0                    	or	al,al
 25618 00002F9A 74F7                    	jz	short SETPATH_RETN
 25619 00002F9C E80300                  	call	PSCANOFF
 25620 00002F9F 3C0D                    	cmp	al,0Dh
 25621 00002FA1 C3                      	retn
 25622                                  
 25623                                  ; ---------------------------------------------------------------------------
 25624                                  
 25625                                  PSCANOFF:
 25626 00002FA2 AC                      	lodsb
 25627 00002FA3 E8E6F9                  	call	DELIM
 25628 00002FA6 7504                    	jnz	short PSCANOFFD
 25629 00002FA8 3C3B                    	cmp	al,';' ; 3Bh
 25630 00002FAA 75F6                    	jne	short PSCANOFF	; ';' is not a delimiter
 25631                                  PSCANOFFD:
 25632 00002FAC 4E                      	dec	si		; Point to first non-delimiter
 25633 00002FAD C3                      	retn
 25634                                  
 25635                                  ; =============== S U B	R O U T	I N E =======================================
 25636                                  
 25637                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25638                                  IOSET:
 25639                                  	; ALL REGISTERS PRESERVED
 25640 00002FAE 1E                      	push	ds
 25641 00002FAF 52                      	push	dx
 25642 00002FB0 50                      	push	ax
 25643 00002FB1 53                      	push	bx
 25644 00002FB2 51                      	push	cx
 25645 00002FB3 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 25646 00002FB8 803E[1303]00            	cmp	byte [PipeFlag],0
 25647 00002FBD 750D                    	jne	short NOREDIR
 25648 00002FBF F606[AA02]FF            	test	byte [IfFlag],0FFh
 25649 00002FC4 7506                    	jnz	short NOREDIR
 25650 00002FC6 E88C00                  	call	TESTDOREIN
 25651 00002FC9 E80600                  	call	TESTDOREOUT
 25652                                  NOREDIR:
 25653 00002FCC 59                      	pop	cx
 25654 00002FCD 5B                      	pop	bx
 25655 00002FCE 58                      	pop	ax
 25656 00002FCF 5A                      	pop	dx
 25657 00002FD0 1F                      	pop	ds
 25658                                  IOSET_RETN:	; 06/08/2024
 25659 00002FD1 C3                      	retn
 25660                                  
 25661                                  ; =============== S U B	R O U T	I N E =======================================
 25662                                  
 25663                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25664                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CF3h
 25665                                  
 25666                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 25667                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:313Dh
 25668                                  TESTDOREOUT:
 25669 00002FD2 803E[C202]00            	cmp	byte [Re_OutStr],0
 25670                                  	;je	short NOREOUT  ; MSDOS 3.3
 25671                                  	; 26/02/2023
 25672                                  	;jne	short REOUTEXISTS
 25673                                  	;jmp	NOREOUT
 25674                                  	; 06/08/2024
 25675 00002FD7 74F8                    	jz	short IOSET_RETN
 25676                                  REOUTEXISTS:
 25677 00002FD9 803E[C102]00            	cmp	byte [Re_Out_App],0
 25678 00002FDE 745D                    	je	short REOUTCRT
 25679                                  
 25680 00002FE0 BA[C202]                	mov	dx,Re_OutStr
 25681                                  
 25682                                  	; 26/02/2023
 25683                                  	; MSDOS 6.0
 25684                                  	;mov	ax,(OPEN SHL 8) OR 2 ;AC011; Open for read/write
 25685 00002FE3 B8023D                  	mov	ax,3D02h
 25686                                  	; MSDOS 3.3
 25687                                  	;mov	ax,(OPEN<<8)|1  ; 3D01h ; Open for write
 25688                                  	
 25689                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25690 00002FE6 50                      	push	ax
 25691 00002FE7 CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 25692                                  			; DS:DX	-> ASCIZ filename
 25693                                  			; AL = access mode
 25694                                  			; 1 - write
 25695 00002FE9 5B                      	pop	bx
 25696 00002FEA 724B                    	jc	short OpenWriteError
 25697                                  
 25698                                  	; 26/02/2023
 25699                                  	; MSDOS 6.0
 25700 00002FEC 89C3                    	mov	bx,ax
 25701                                  	;mov	ax,IOCTL<<8		;AN035; Get attributes of handle
 25702 00002FEE B80044                  	mov	ax,4400h
 25703 00002FF1 CD21                    	int	21h			;AN035;
 25704                                  			; DOS - 2+ - IOCTL - GET DEVICE INFORMATION
 25705                                  			; BX = file or device handle
 25706 00002FF3 F6C280                  	test	dl,80h
 25707                                  	;test	dl,devid_ISDEV		;AN035; Is it a device?
 25708 00002FF6 7554                    	jnz	short SET_REOUT		;AN035; Yes, don't read from it
 25709                                  	
 25710                                  	;mov	ax,(LSEEK SHL 8) OR 2
 25711 00002FF8 B80242                  	mov	ax,4202h
 25712 00002FFB B9FFFF                  	mov	cx,-1			;AC011; MOVE TO EOF -1
 25713 00002FFE 89CA                    	mov	dx,cx			;AC011;
 25714 00003000 CD21                    	int	21h
 25715                                  			; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 25716                                  			; AL = method: offset from end of file
 25717 00003002 0E                      	push	cs			;AN011; Get transient seg to DS
 25718 00003003 1F                      	pop	ds			;AN011;
 25719                                  	
 25720                                  	;mov	ax,(READ SHL 8) 	;AN011; Read one byte from the
 25721 00003004 B8003F                  	mov	ax,3F00h
 25722 00003007 B90100                  	mov	cx,1			;AN011;  file into one_char_val
 25723 0000300A BA[109E]                	mov	dx,One_Char_Val		;AN011;
 25724 0000300D CD21                    	int	21h			;AN011;
 25725                                  			; DOS - 2+ - READ FROM FILE WITH HANDLE
 25726                                  			; BX = file handle, CX = number of bytes to read
 25727                                  			; DS:DX -> buffer
 25728 0000300F 7226                    	jc	short OpenWriteError	;AN011; If error, exit
 25729 00003011 39C8                    	cmp	ax,cx			;AN017; Did we read 1 byte?
 25730 00003013 7517                    	jnz	short reout_0_length	;AN017; No - file must be 0 length
 25731                                  	
 25732 00003015 803E[109E]1A            	cmp	byte [One_Char_Val],1Ah	;AN011; Was char an eof mark?
 25733 0000301A 8E1E[539C]              	mov	ds,[RESSEG]		;AN011; Get resident segment back
 25734 0000301E 752C                    	jne	short SET_REOUT		;AN011; No, just continue
 25735                                  	
 25736                                  	;mov	ax,(LSEEK<<8)|1		;AN011; EOF mark found
 25737 00003020 B80142                  	mov	ax,4201h
 25738 00003023 B9FFFF                  	mov	cx,-1			;AN011; LSEEK back one byte
 25739                                  setreout_p:	; 26/02/2023
 25740 00003026 89CA                    	mov	dx,cx			;AN011;
 25741 00003028 CD21                    	int	21h			;AN011;
 25742 0000302A EB20                    	jmp	short SET_REOUT
 25743                                  reout_0_length: 			;AN017; We have a 0 length file
 25744                                  	; ds = cs ; 26/02/2023
 25745                                  	;mov	ds,[cs:RESSEG] ; MSDOS 5.0 COMMAND.COM - TRANGROUP:2D50h
 25746                                  					;AN017; Get resident segment back
 25747                                  	; 26/02/2023
 25748 0000302C 8E1E[539C]              	mov	ds,[RESSEG]
 25749                                  	;mov	ax,(LSEEK SHL 8)	;AN017; Move to beginning of file
 25750 00003030 B80042                  	mov	ax,4200h
 25751 00003033 31C9                    	xor	cx,cx			;AN017; Offset is 0
 25752                                  	;mov	dx,cx			;AN017;
 25753                                  	;int	21h			;AN017;
 25754                                  	;jmp	short SET_REOUT 	;AN017; now finish setting up redirection
 25755                                  	; 26/02/2023
 25756 00003035 EBEF                    	jmp	short setreout_p
 25757                                  
 25758                                  	; 26/02/2023
 25759                                  	; MSDOS 3.3
 25760                                  	;xor	dx,dx
 25761                                  	;xor	cx,cx
 25762                                  	;mov	bx,ax
 25763                                  	;mov	ax,(LSEEK<<8)|2 ; 4202h
 25764                                  	;int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 25765                                  	;		; AL = method: offset from end of file
 25766                                  	;jmp	short SET_REOUT
 25767                                  		
 25768                                  	; MSDOS 3.3 (& MSDOS 6.0)
 25769                                  OpenWriteError:	
 25770                                  	;cmp	ax,5
 25771 00003037 83F805                  	cmp	ax,ERROR_ACCESS_DENIED
 25772 0000303A F9                      	stc
 25773                                  	;;je	short REDIRERR ; MSDOS 3.3
 25774                                  	; 26/02/2023
 25775                                  	;jnz	short REOUTCRT
 25776                                  	;jmp	REDIRERR
 25777 0000303B 743B                    	je	short REDIRERR
 25778                                  
 25779                                  REOUTCRT:	
 25780 0000303D BA[C202]                	mov	dx,Re_OutStr
 25781 00003040 31C9                    	xor	cx,cx
 25782                                  	;mov	ah,CREAT ; 3Ch
 25783 00003042 B43C                    	mov	ah,3Ch
 25784 00003044 50                      	push	ax
 25785 00003045 CD21                    	int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 25786                                  			; CX = attributes for file
 25787                                  			; DS:DX	-> ASCIZ filename (may include drive and path)
 25788 00003047 5B                      	pop	bx
 25789                                  	;jc	short REDIRERR ; MSDOS 3.3
 25790                                  	; 26/02/2023
 25791                                  	;jnc	short NOREDIRERR
 25792                                  	;jmp	REDIRERR
 25793 00003048 722E                    	jc	short REDIRERR
 25794                                  	
 25795                                  NOREDIRERR:
 25796 0000304A 89C3                    	mov	bx,ax
 25797                                  SET_REOUT:
 25798                                  
 25799                                  ; Mega sleaze!! We move the SFN from the new handle spot into the old stdout
 25800                                  ; spot. We invalidate the new JFN we got.
 25801                                  
 25802 0000304C B0FF                    	mov	al,0FFh
 25803                                  	;xchg	al,[bx+18h]
 25804 0000304E 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 25805 00003051 A21900                  	mov	[PDB.JFN_TABLE+1],al
 25806                                  NOREOUT:	; 06/08/2024
 25807 00003054 C3                      	retn
 25808                                  
 25809                                  ; =============== S U B	R O U T	I N E =======================================
 25810                                  
 25811                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25812                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CABh
 25813                                  
 25814                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 25815                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:30F5h
 25816                                  TESTDOREIN:
 25817 00003055 2E803E[FE9B]00          	cmp	byte [cs:RE_INSTR],0
 25818                                  	;jz	short IOSET_RETN
 25819                                  	; 06/08/2024
 25820 0000305B 74F7                    	jz	short NOREOUT
 25821 0000305D 1E                      	push	ds
 25822 0000305E 0E                      	push	cs
 25823 0000305F 1F                      	pop	ds
 25824 00003060 BA[FE9B]                	mov	dx,RE_INSTR
 25825                                  	;;mov	ax,OPEN*256 ; 3D00h
 25826                                  	;mov	ax,3D00h
 25827                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 25828                                  	;mov	ax,(OPEN*256)+SHARING_DENY_NONE
 25829 00003063 B8403D                  	mov	ax,3D40h
 25830 00003066 89C3                    	mov	bx,ax
 25831 00003068 CD21                    	int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 25832                                  			; DS:DX	-> ASCIZ filename
 25833                                  			; AL = access mode
 25834                                  			; 0 - read
 25835 0000306A 1F                      	pop	ds
 25836                                  
 25837 0000306B 720B                    	jc	short REDIRERR
 25838                                  
 25839 0000306D 89C3                    	mov	bx,ax
 25840 0000306F B0FF                    	mov	al,0FFh
 25841                                  
 25842                                  ; Mega sleaze!! We move the SFN from the new handle spot into the old stdin
 25843                                  ; spot. We invalidate the new JFN we got.
 25844                                  
 25845                                  	;xchg	al,[bx+18h]
 25846 00003071 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 25847 00003074 A21800                  	mov	[PDB.JFN_TABLE],al
 25848 00003077 C3                      	retn
 25849                                  
 25850                                  ; ---------------------------------------------------------------------------
 25851                                  
 25852                                  ; We had some kind of error on the redirection. Figure out what the
 25853                                  ; appropriate message should be; BX has the system call that failed
 25854                                  
 25855                                  REDIRERR:
 25856 00003078 0E                      	push	cs
 25857 00003079 1F                      	pop	ds
 25858 0000307A E82E00                  	call	TriageError  ; MSDOS 6.0
 25859                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 25860                                  
 25861                                  ; At this point, we have recognized the network-generated access denied error.
 25862                                  ; The correct message is in DX
 25863                                  
 25864 0000307D 83F841                  	cmp	ax,65
 25865 00003080 7408                    	je	short _CERRORJ	;AC000; just issue message returned
 25866 00003082 80FF3D                  	cmp	bh,OPEN ; 3Dh
 25867 00003085 7406                    	je	short OpenError
 25868 00003087 BA[E58F]                	mov	dx,FULLDIR_PTR
 25869                                  _CERRORJ:
 25870 0000308A E997FC                  	jmp	cerror
 25871                                  
 25872                                  OpenError:
 25873                                  ; The system call was an OPEN. Report either file not found or path not found.
 25874                                  
 25875                                  	; 26/02/2023
 25876                                  	; MSDOS 6.0
 25877                                  	;mov	byte [cs:msg_disp_class],1
 25878 0000308D 2EC606[C98F]01          	mov	byte [cs:msg_disp_class],ext_msg_class
 25879                                  				;AN000; set up extended error msg class
 25880 00003093 BA[CB8F]                	mov	dx,extend_buf_ptr
 25881                                  				;AC000; get extended message pointer
 25882 00003096 2EA3[CB8F]              	mov	[cs:extend_buf_ptr],ax
 25883                                  				;AN000; get message number in control block
 25884 0000309A E987FC                  	jmp	cerror
 25885                                  
 25886                                  	; 26/02/2023
 25887                                  	; MSDOS 3.3
 25888                                  	;mov	dx,FNOTFOUNDPTR
 25889                                  	;;cmp	ax,2
 25890                                  	;cmp	ax,ERROR_FILE_NOT_FOUND
 25891                                  	;je	short _CERRORJ
 25892                                  	;mov	dx,ACCDENPTR
 25893                                  	;;cmp	ax,5 ; Access denied error
 25894                                  	;cmp	ax,ERROR_ACCESS_DENIED
 25895                                  	;je	short _CERRORJ
 25896                                  	;	; ERROR_PATH_NOT_FOUND
 25897                                  	;mov	dx,PNOTFOUNDPTR
 25898                                  	;jmp	CERROR
 25899                                  
 25900                                  ; =============== S U B	R O U T	I N E =======================================
 25901                                  
 25902                                  ; Compute length of string (including NUL) in DS:SI into CX. Change no other
 25903                                  ; registers
 25904                                  
 25905                                  	; 26/02/2023 - Retro DOS v4.0 COMMAND.COM
 25906                                  dstrlen:
 25907 0000309D 50                      	push	ax
 25908 0000309E 31C9                    	xor	cx,cx
 25909 000030A0 FC                      	cld
 25910                                  dloop:
 25911 000030A1 AC                      	lodsb
 25912 000030A2 41                      	inc	cx
 25913 000030A3 08C0                    	or	al,al
 25914 000030A5 75FA                    	jnz	short dloop
 25915 000030A7 29CE                    	sub	si,cx
 25916 000030A9 58                      	pop	ax
 25917                                  TRIAGEERR_RETN:
 25918 000030AA C3                      	retn
 25919                                  
 25920                                  ; =============== S U B	R O U T	I N E =======================================
 25921                                  
 25922                                  ;Break	<Extended error support>
 25923                                  
 25924                                  TriageError:  ; MSDOS 6.0
 25925                                  
 25926                                  ; TriageError will examine the return from a carry-set system call and
 25927                                  ; return the correct error if applicable.
 25928                                  ;
 25929                                  ;   Inputs:	outputs from a carry-settable system call
 25930                                  ;		No system calls may be done in the interrim
 25931                                  ;   Outputs:	If carry was set on input
 25932                                  ;		   carry set on output
 25933                                  ;		   DX contains trangroup offset to printf message
 25934                                  ;		else
 25935                                  ;		   No registers changed
 25936                                  
 25937                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1EEEh
 25938                                  
 25939                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25940                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2D92h
 25941                                  
 25942                                  ; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25943                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 333Ch
 25944                                  
 25945                                  GET_EXT_ERR_NUMBER:  ; MSDOS 3.3
 25946 000030AB 73FD                    	jnc	short TRIAGEERR_RETN ; no carry => do nothing...
 25947 000030AD 9C                      	pushf
 25948 000030AE 53                      	push	bx
 25949 000030AF 51                      	push	cx
 25950 000030B0 56                      	push	si
 25951 000030B1 57                      	push	di
 25952 000030B2 55                      	push	bp
 25953 000030B3 06                      	push	es
 25954 000030B4 1E                      	push	ds
 25955 000030B5 50                      	push	ax
 25956 000030B6 52                      	push	dx
 25957 000030B7 B459                    	mov	ah,59h
 25958                                  	;mov	ah,GETEXTENDEDERROR
 25959 000030B9 CD21                    	int	21h	; DOS -	3+ - GET EXTENDED ERROR	CODE
 25960                                  			; BX = version code (0000h for DOS 3.x)
 25961 000030BB 59                      	pop	cx
 25962 000030BC 5B                      	pop	bx		; restore original AX
 25963 000030BD BA[F48F]                	mov	dx,ACCDEN_PTR
 25964 000030C0 83F841                  	cmp	ax,65		; network access denied?
 25965 000030C3 7404                    	je	short NoMove	; Yes, return it.
 25966 000030C5 89D8                    	mov	ax,bx
 25967 000030C7 89CA                    	mov	dx,cx
 25968                                  NoMove:
 25969 000030C9 1F                      	pop	ds
 25970 000030CA 07                      	pop	es
 25971 000030CB 5D                      	pop	bp
 25972 000030CC 5F                      	pop	di
 25973 000030CD 5E                      	pop	si
 25974 000030CE 59                      	pop	cx
 25975 000030CF 5B                      	pop	bx
 25976 000030D0 9D                      	popf
 25977 000030D1 C3                      	retn
 25978                                  
 25979                                  ; =============== S U B	R O U T	I N E =======================================
 25980                                  
 25981                                  	; Far call from resident portion/segment of COMMAND.COM
 25982                                  
 25983                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1F15h
 25984                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2DB9h
 25985                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3363h
 25986                                  
 25987                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 25988                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 25989                                  Triage_Init:
 25990 000030D2 E8D6FF                  	call	TriageError	 ; MSDOS 6.0
 25991                                  	;call	GET_EXT_ERR_NUMBER ; MSDOS 3.3
 25992 000030D5 CB                      	retf
 25993                                  
 25994                                  ; =============== S U B	R O U T	I N E =======================================
 25995                                  
 25996                                  ; MSDOS 6.0
 25997                                  
 25998                                  ; ****************************************************************
 25999                                  ; *
 26000                                  ; * ROUTINE:	 MOVE_TO_SRCBUF
 26001                                  ; *
 26002                                  ; * FUNCTION:	 Move ASCIIZ string from DS:SI to SRCBUF.  Change
 26003                                  ; *		 terminating 0 to 0dH.	Set PATHCNT to length of
 26004                                  ; *		 string.  Set PATHPOS to start of SRCBUF.
 26005                                  ; *
 26006                                  ; * INPUT:	 DS:SI points to ASCIIZ string
 26007                                  ; *		 ES    points to TRANGROUP
 26008                                  ; *
 26009                                  ; * OUTPUT:	 SRCBUF filled in with string terminated by 0dH
 26010                                  ; *		 PATHCNT set to length of string
 26011                                  ; *		 PATHPOS set to start of SRCBUF
 26012                                  ; *		 CX,AX	 changed
 26013                                  ; *
 26014                                  ; ****************************************************************
 26015                                  
 26016                                  	; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26017                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2CABh
 26018                                  Move_To_SrcBuf:
 26019 000030D6 56                      	push	si			;AN000;  save si,di
 26020 000030D7 57                      	push	di			;AN000;
 26021 000030D8 51                      	push	cx			;AN000;
 26022 000030D9 BF[809E]                	mov	di,SrcBuf		;AN000;  set ES:DI to srcbuf
 26023 000030DC 31C9                    	xor	cx,cx			;AN000; clear cx for counint
 26024 000030DE 89C8                    	mov	ax,cx			;AN000; clear ax
 26025 000030E0 57                      	push	di			;AN000; save start of srcbuf
 26026 000030E1 AC                      	lodsb				;AN000; get a character from DS:SI
 26027                                  mts_get_chars:				;AN000;
 26028                                  	;cmp	al,0			;AN000; was it a null char?
 26029 000030E2 20C0                    	and 	al,al ; al = 0 ?
 26030 000030E4 7405                    	jz	short mts_end_string	;AN000; yes - exit
 26031 000030E6 AA                      	stosb				;AN000; no - store it in srcbuf
 26032 000030E7 41                      	inc	cx			;AN000; increment length count
 26033 000030E8 AC                      	lodsb				;AN000; get a character from DS:SI
 26034 000030E9 EBF7                    	jmp	short mts_get_chars	;AN000; go check it
 26035                                  mts_end_string: 			;AN000; we've reached the end of line
 26036                                  	;mov	al,END_OF_LINE_IN	;AN000; store 0Dh in srcbuf
 26037 000030EB B00D                    	mov	al,0Dh
 26038 000030ED AA                      	stosb				;AN000;
 26039 000030EE 5F                      	pop	di			;AN000; restore start of srcbuf
 26040 000030EF 0E                      	push	cs			;AN000; set DS to local segment
 26041 000030F0 1F                      	pop	ds			;AN000;
 26042 000030F1 890E[EE9D]              	mov	[PathCnt],cx		;AN000; set patchcnt to length count
 26043 000030F5 893E[F09D]              	mov	[PathPos],di		;AN000; set pathpos to start of srcbuf
 26044 000030F9 59                      	pop	cx			;AN000; restore cx,di,si
 26045 000030FA 5F                      	pop	di			;AN000;
 26046 000030FB 5E                      	pop	si			;AN000;
 26047 000030FC C3                      	retn				;AN000; exit
 26048                                  
 26049                                  ;============================================================================
 26050                                  ; TPIPE.ASM, MSDOS 6.0, 1991
 26051                                  ;============================================================================
 26052                                  ; 03/10/2018 - Retro DOS v3.0
 26053                                  
 26054                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 1F19h
 26055                                  
 26056                                  ; 26/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26057                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 2DE4h
 26058                                  
 26059                                  ; =============== S U B	R O U T	I N E =======================================
 26060                                  
 26061                                  	; 26/02/2023
 26062                                  SINGLETEST:
 26063 000030FD 1E                      	push	ds
 26064 000030FE 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 26065 00003103 833E[A502]00            	cmp	word [SingleCom],0
 26066 00003108 7406                    	jz	short TESTDONE
 26067 0000310A 813E[A502]FFEF          	cmp	word [SingleCom],0EFFFh
 26068                                  TESTDONE:
 26069 00003110 1F                      	pop	ds
 26070 00003111 C3                      	retn
 26071                                  
 26072                                  ; =============== S U B	R O U T	I N E =======================================
 26073                                  
 26074                                  	; 26/02/2023
 26075                                  SetRest1:
 26076 00003112 B001                    	mov	al,1
 26077                                  
 26078                                  ; ---------------------------------------------------------------------------
 26079                                  
 26080                                  SETREST:
 26081 00003114 1E                      	push	ds
 26082 00003115 8E1E[539C]              	mov	ds,[RESSEG]
 26083 00003119 A2[A102]                	mov	[RestDir],al
 26084 0000311C 1F                      	pop	ds
 26085 0000311D C3                      	retn
 26086                                  
 26087                                  ; =============== S U B	R O U T	I N E =======================================
 26088                                  
 26089                                  ; Note that we need to handle the same thing that RestDir handles: the
 26090                                  ; requirement that we try only once to restore the user's environment after
 26091                                  ; and INT 24 or the like. If the condition that causes the INT 24 does not
 26092                                  ; disappear, we just give up.
 26093                                  
 26094                                  	; 26/02/2023 - Retro DOS v4.0 COMMAND.COM
 26095                                  	;
 26096                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26097                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33AFh
 26098                                  	;
 26099                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26100                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:324Fh
 26101                                  PIPEDEL:
 26102 0000311E 1E                      	push	ds
 26103 0000311F 52                      	push	dx
 26104 00003120 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 26105                                  	;;;mov	dx,320h	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2E0Ch
 26106                                  	;;mov	dx,3EAh	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33B1h
 26107                                  	;mov	dx,41Eh	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3256h
 26108                                  			; Pipe1 = offset RESGROUP:EndInit
 26109 00003125 BA[1503]                	mov	dx,Pipe1	; Clean up in case ^C
 26110                                  	;mov	ah,Unlink ; 41h 
 26111 00003128 B441                    	mov	ah,41h
 26112                                  	;int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 26113                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 26114                                  			;		(no wildcards allowed)
 26115                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26116 0000312A E88DD4                  	call	int_21h_indirect
 26117                                  
 26118                                  	;;;mov	dx,36Fh ; MSDOS 5.0 COMMAND.COM - TRANGROUP:2E13h
 26119                                  	;;mov	dx,439h	; MSDOS 6.22 COMMAND.COM - TRANGROUP:33BDh
 26120                                  	;mov	dx,46Dh	; PCDOS 7.1 COMMAND.COM - TRANGROUP:325Eh
 26121                                  			; Pipe2 = offset RESGROUP:EndInit+79
 26122 0000312D BA[6403]                	mov	dx,Pipe2
 26123                                  	;mov	ah,Unlink ; 41h
 26124 00003130 B441                    	mov	ah,41h
 26125                                  	;int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 26126                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 26127                                  			;		(no wildcards allowed)
 26128                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26129 00003132 E885D4                  	call	int_21h_indirect
 26130 00003135 5A                      	pop	dx
 26131 00003136 E86C02                  	call	PipeOff
 26132 00003139 C606[1403]00            	mov	byte [PipeFiles],0
 26133 0000313E 1F                      	pop	ds
 26134 0000313F C3                      	retn
 26135                                  
 26136                                  ; ---------------------------------------------------------------------------
 26137                                  
 26138                                  	; 26/02/2023
 26139                                  PIPEERRSYN:
 26140 00003140 BA[9E90]                	mov	dx,SYNTMES_PTR	; MSG_1030 ; 06/08/2024
 26141 00003143 E8D8FF                  	call	PIPEDEL
 26142 00003146 0E                      	push	cs
 26143 00003147 1F                      	pop	ds
 26144 00003148 E9D9FB                  	jmp	cerror
 26145                                  
 26146                                  ; ---------------------------------------------------------------------------
 26147                                  
 26148                                  	; 26/02/2023
 26149                                  PIPERR:
 26150 0000314B 9C                      	pushf
 26151 0000314C E85CFF                  	call    TriageError
 26152                                  	;call	GET_EXT_ERR_NUMBER  ; MSDOS 3.3
 26153 0000314F 50                      	push	ax		; Save results from TriageError
 26154 00003150 52                      	push	dx
 26155 00003151 BA[5191]                	mov	dx,PIPEEMES_PTR
 26156 00003154 E8C7FF                  	call	PIPEDEL
 26157 00003157 0E                      	push	cs
 26158 00003158 1F                      	pop	ds
 26159 00003159 E8B922                  	call	std_eprintf
 26160 0000315C 5A                      	pop	dx		; Restore results from TriageError
 26161 0000315D 58                      	pop	ax
 26162 0000315E 9D                      	popf
 26163 0000315F 83F841                  	cmp	ax,65		; network access denied
 26164 00003162 7503                    	jne	short TCOMMANDJ
 26165 00003164 E9BDFB                  	jmp	cerror
 26166                                  
 26167                                  TCOMMANDJ:
 26168 00003167 E99ACF                  	jmp	TCOMMAND
 26169                                  
 26170                                  ; ---------------------------------------------------------------------------
 26171                                  
 26172                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26173                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26174                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26175                                  PIPEPROCSTRT:
 26176 0000316A 8E1E[539C]              	mov	ds,[RESSEG]
 26177 0000316E FE06[1403]              	inc	byte [PipeFiles] ; Flag that the pipe files exist
 26178                                  
 26179                                  	; MSDOS 6.0
 26180 00003172 06                      	push	es
 26181 00003173 57                      	push	di
 26182 00003174 1E                      	push	ds
 26183 00003175 56                      	push	si
 26184                                  	
 26185 00003176 1E                      	push	ds
 26186 00003177 06                      	push	es
 26187 00003178 1F                      	pop	ds			;ds = TRANGROUP
 26188 00003179 BE[5997]                	mov	si,TempVarName		;ds:si = "TEMP="
 26189                                  
 26190                                  ;Some hideous code in Find_Name_In_Environment. Expects ds = TRANGROUP and
 26191                                  ;so the routine is not really general
 26192                                  
 26193 0000317C E836F5                  	call	find_name_in_environment
 26194                                  					;es:di points at path
 26195 0000317F 1F                      	pop	ds			;ds = DATARES again
 26196 00003180 7220                    	jc	short no_temp_path
 26197                                  	
 26198 00003182 1E                      	push	ds
 26199 00003183 06                      	push	es
 26200 00003184 1F                      	pop	ds
 26201 00003185 07                      	pop	es			;swap ds and es
 26202 00003186 89FE                    	mov	si,di			;ds:si points at path
 26203                                  	
 26204 00003188 E8B402                  	call	skip_white		;skip white space chars
 26205                                  
 26206                                  ;This copies the path into both buffers -- Pipe1 & Pipe2
 26207                                  
 26208 0000318B E8BD02                  	call	copy_pipe_path		;copy the pipe path
 26209                                  	
 26210                                  ;Check if the TEMP path is valid
 26211                                  
 26212 0000318E 06                      	push	es
 26213 0000318F 1F                      	pop	ds			;ds = DATARES
 26214                                  	;mov	dx,offset DATARES:Pipe1	;ds:dx = path to look for
 26215                                  	;;;mov	dx,320h ; MSDOS 5.0 - offset EndInit
 26216                                  	;;mov	dx,3EAh	; MSDOS 6.22 - offset EndInit
 26217                                  	;mov	dx,41Eh	; PCDOS 7.1 COMMAND.COM - offset EndInit
 26218 00003190 BA[1503]                	mov	dx,Pipe1
 26219                                  	;mov	ax,(CHMOD shl 8) or 0
 26220 00003193 B80043                  	mov	ax,4300h
 26221                                  	;int	21h
 26222                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26223 00003196 E821D4                  	call	int_21h_indirect
 26224 00003199 7207                    	jc	short no_temp_path
 26225                                  	
 26226 0000319B F7C11000                	test	cx,10h			;is it a directory?
 26227 0000319F 7501                    	jnz	short no_temp_path	;yes, continue (carry clear)
 26228                                  	
 26229 000031A1 F9                      	stc				;no, indicate fail
 26230                                  no_temp_path:
 26231 000031A2 5E                      	pop	si
 26232 000031A3 1F                      	pop	ds
 26233 000031A4 5F                      	pop	di
 26234 000031A5 07                      	pop	es
 26235 000031A6 730B                    	jnc	short crt_temp		;path found, create tempfiles
 26236                                  
 26237                                  	; 27/02/2023
 26238                                  	; MSDOS 3.3
 26239                                  	;mov	ah,GET_DEFAULT_DRIVE ; 19h
 26240                                  	;				; Get current drive
 26241                                  	;int	21h ; DOS - GET DEFAULT DISK NUMBER
 26242                                  	;add	al,[cs:CAPITAL_A]
 26243                                  	;mov	byte [PIPE2],al		; Make pipe files in root of def drv
 26244                                  	;mov	bx,PIPE1
 26245                                  	;mov	[bx],al
 26246                                  	;xor	ah,ah			; nul terminate path names
 26247                                  	;mov	byte [PIPE1+3],ah
 26248                                  	;mov	byte [PIPE2+3],ah
 26249                                  
 26250                                  	; MSDOS 6.0
 26251                                  ;SR;
 26252                                  ; We want to create temp files in the current directory rather than in the 
 26253                                  ;root of the drive. This is because the number of files that can be present
 26254                                  ;in the root directory is fixed, whereas it is not so in subdirectories.
 26255                                  
 26256                                  	;mov	ah,'.'
 26257                                  	;mov	[Pipe1],ah	; = RESGROUP:EndInit
 26258                                  	;mov	[Pipe2],ah	; = RESGROUP:EndInit+79
 26259                                  	;xor	ah,ah
 26260                                  	;mov	[Pipe1+1],ah	; = RESGROUP:EndInit+1
 26261                                  	;mov	[Pipe2+1],ah		;create files in current dir
 26262                                  	; 27/02/2023
 26263 000031A8 B92E00                  	mov	cx,002Eh
 26264 000031AB 890E[1503]              	mov	[Pipe1],cx
 26265 000031AF 890E[6403]              	mov	[Pipe2],cx
 26266                                  crt_temp:
 26267                                  	; MSDOS 6.0
 26268                                  	;mov	dx,offset DATARES:Pipe1	; = RESGROUP:EndInit
 26269                                  	;;mov	dx,320h ; MSDOS 5.0 COMMAND.COM
 26270                                  	;mov	dx,3EAh ; MSDOS 6.22 COMMAND.COM	
 26271 000031B3 BA[1503]                	mov	dx,Pipe1
 26272                                  	; MSDOS 3.3
 26273                                  	;mov	dx,bx
 26274                                  	
 26275                                  	; MSDOS 3.3 (& MSDOS 6.0)
 26276 000031B6 31C9                    	xor	cx,cx
 26277                                  	;mov	ah,CREATETEMPFILE ; 5Ah ; the CreateTemp call
 26278 000031B8 B45A                    	mov	ah,5Ah
 26279                                  	;int	21h
 26280                                  		; DOS -	3+ - CREATE UNIQUE FILE
 26281                                  		; DS:DX	-> ASCIZ directory path	name ending with a '' + 13 bytes
 26282                                  		;         to receive generated filename
 26283                                  		; CX = file attributes (only bits 0,1,2,5 may be set)
 26284                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26285 000031BA E8FDD3                  	call	int_21h_indirect
 26286 000031BD 728C                    	jc	short PIPERR	; Couldn't create
 26287                                  
 26288 000031BF 89C3                    	mov	bx,ax
 26289                                  	;mov	ah,CLOSE ; 3Eh	; Don't proliferate handles
 26290 000031C1 B43E                    	mov	ah,3Eh
 26291 000031C3 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 26292                                  			; BX = file handle
 26293                                  	;;;mov	dx,PIPE2
 26294                                  	;;;mov	dx,36Fh ; MSDOS 5.0 COMMAND.COM
 26295                                  	;;mov	dx,439h ; MSDOS 6.22 COMMAND.COM
 26296                                  	;mov	dx,46Dh ; PCDOS 7.1 COMMAND.COM
 26297 000031C5 BA[6403]                	mov	dx,Pipe2
 26298                                  	;mov	ah,CREATETEMPFILE ; 5Ah ; the CreateTemp call
 26299 000031C8 B45A                    	mov	ah,5Ah
 26300                                  	;int	21h
 26301                                  		; DOS -	3+ - CREATE UNIQUE FILE
 26302                                  		; DS:DX	-> ASCIZ directory path	name ending with a '' + 13 bytes to
 26303                                  		; receive generated filename
 26304                                  		; CX = file attributes (only bits 0,1,2,5 may be set)
 26305                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26306 000031CA E8EDD3                  	call	int_21h_indirect
 26307                                  	; 17/04/2023
 26308                                  	;jc	short PIPERR
 26309                                  	; 27/02/2023
 26310 000031CD 7303                    	jnc	short pps1
 26311 000031CF E979FF                  	jmp	PIPERR
 26312                                  pps1:
 26313 000031D2 89C3                    	mov	bx,ax
 26314 000031D4 B43E                    	mov	ah,CLOSE ; 3Eh	; Don't proliferate handles
 26315                                  	;int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 26316                                  				; BX = file handle
 26317                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26318 000031D6 E8E1D3                  	call	int_21h_indirect
 26319                                  	;
 26320                                  	;call	near ptr TESTDOREIN ; Set up a redirection if specified
 26321 000031D9 E879FE                  	call	TESTDOREIN
 26322                                  	;;mov	si,[488h] ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26323                                  	;mov	si,[4BCh] ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 26324 000031DC 8B36[B303]              	mov	si,[PipePtr]	; offset RESGROUP:EndInit+158
 26325 000031E0 833E[A502]FF            	cmp	word [SingleCom],-1 ; 0FFFFh
 26326 000031E5 7506                    	jne	short NOSINGP
 26327 000031E7 C706[A502]00F0          	mov	word [SingleCom],0F000h ; Flag single command pipe
 26328                                  NOSINGP:
 26329 000031ED EB2A                    	jmp	short FIRSTPIPE
 26330                                  
 26331                                  ; ---------------------------------------------------------------------------
 26332                                  
 26333                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26334                                  	; 11/06/2026 - Retro DOS v4.2 COMMAND.COM
 26335                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26336                                  PIPEPROC:
 26337 000031EF 8026[9D02]FE            	and	byte [EchoFlag],0FEh  ; force current echo to be off
 26338                                  	;;mov	si,[488h] ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26339 000031F4 8B36[B303]              	mov	si,[PipePtr]	; offset RESGROUP:EndInit+158
 26340 000031F8 AC                      	lodsb
 26341                                  	; 27/02/2023
 26342 000031F9 3C7C                    	cmp	al,'|'		
 26343                                  	;;cmp	al,ALTPIPECHR	; Alternate pipe char? 	
 26344                                  	;je	short ISPIPE1	; Yes
 26345                                  	;cmp	al,'|'
 26346                                  	;;cmp	al,[cs:VBAR]
 26347 000031FB 7403                    	je	short ISPIPE1
 26348 000031FD E98600                  	jmp	PIPEEND		; Pipe done
 26349                                  ISPIPE1:
 26350 00003200 8B16[3604]              	mov	dx,[InPipePtr]	; Get the input file name
 26351                                  	;mov	ax,OPEN*256 ; 3D00h
 26352 00003204 B8003D                  	mov	ax,3D00h
 26353                                  	;int	21h	; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 26354                                  			; DS:DX	-> ASCIZ filename
 26355                                  			; AL = access mode
 26356                                  			; 0 - read
 26357                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26358 00003207 E8B0D3                  	call	int_21h_indirect
 26359                                  PIPEERRJ:
 26360 0000320A 7303                    	jnc	short NO_PIPEERR
 26361 0000320C E93CFF                  	jmp	PIPERR		; Lost the pipe file
 26362                                  NO_PIPEERR:
 26363 0000320F 89C3                    	mov	bx,ax
 26364 00003211 B0FF                    	mov	al,0FFh
 26365                                  	;xchg	al,[bx+18h]
 26366 00003213 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 26367 00003216 A21800                  	mov	[PDB.JFN_TABLE],al ; Redirect
 26368                                  FIRSTPIPE:
 26369 00003219 BF[B49A]                	mov	di,COMBUF+2
 26370 0000321C 31C9                    	xor	cx,cx
 26371 0000321E 803C0D                  	cmp	byte [si],0Dh	; '|<CR>'
 26372 00003221 7503                    	jne	short PIPEOK1
 26373                                  PIPEERRSYNJ:
 26374 00003223 E91AFF                  	jmp	PIPEERRSYN
 26375                                  PIPEOK1:
 26376                                  	;;;mov	al,[cs:VBAR]
 26377                                  	; 27/02/2023
 26378                                  	;;mov	al,vbar
 26379                                  	;mov	al,'|'
 26380                                  	;cmp	[si],al		; '||'
 26381                                  	;je	short PIPEERRSYNJ
 26382 00003226 803C7C                  	cmp	byte [si],'|'
 26383                                  	;cmp	byte [si],ALTPIPECHR ; '##' or '|#'?
 26384 00003229 74F8                    	je	short PIPEERRSYNJ
 26385                                  PIPECOMLP:
 26386 0000322B AC                      	lodsb
 26387 0000322C AA                      	stosb
 26388                                  	; 27/02/2023
 26389 0000322D E82FF5                  	call	testkanj
 26390 00003230 7405                    	jz	short NOTKANJ5
 26391 00003232 A4                      	movsb
 26392                                  ;  Added following 2 commands to the fix pipe bug.
 26393 00003233 41                      	inc	cx		;AN000;  3/3/KK
 26394 00003234 41                      	inc	cx		;AN000;  3/3/KK
 26395 00003235 EBF4                    	jmp	short PIPECOMLP
 26396                                  NOTKANJ5:
 26397 00003237 3C0D                    	cmp	al,0Dh
 26398 00003239 7439                    	je	short LASTPIPE
 26399 0000323B 41                      	inc	cx
 26400                                  	; 27/02/2023
 26401 0000323C 3C7C                    	cmp	al,'|'
 26402                                  	;cmp	al,ALTPIPECHR
 26403                                  	;je	short ISPIPE2
 26404                                  	;;cmp	al,[cs:VBAR]
 26405                                  	;cmp	al,vbar
 26406 0000323E 75EB                    	jne	short PIPECOMLP
 26407                                  ISPIPE2:
 26408 00003240 26C645FF0D              	mov	byte [es:di-1],0Dh
 26409 00003245 49                      	dec	cx
 26410                                  	;mov	[cs:COMBUF+1],cl
 26411                                  	; 27/02/2023
 26412 00003246 26880E[B39A]            	mov	[es:COMBUF+1],cl
 26413 0000324B 4E                      	dec	si
 26414                                  	;;mov	[3BEh],si ; MSDOS 5.0 COMMAND.COM
 26415                                  	; 11/06/2023 - MSDOS 6.22 COMMAND.COM
 26416                                  	;mov	[488h],si ; [PipePtr] = [EndInit+158]
 26417                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26418                                  	;mov	[4BCh],si ; [PipePtr] = [EndInit+158]
 26419 0000324C 8936[B303]              	mov	[PipePtr],si		; On to next pipe element
 26420                                  			; mov [EndInit+158],si
 26421 00003250 8B16[3804]              	mov	dx,[OutPipePtr]
 26422 00003254 51                      	push	cx
 26423 00003255 31C9                    	xor	cx,cx
 26424                                  	;mov	ax,CREAT*256 ; 3C00h
 26425 00003257 B8003C                  	mov	ax,3C00h
 26426                                  	;int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 26427                                  			; CX = attributes for file
 26428                                  			; DS:DX	-> ASCIZ filename (may include drive and path)
 26429                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26430 0000325A E85DD3                  	call	int_21h_indirect
 26431 0000325D 59                      	pop	cx
 26432 0000325E 72AA                    	jc	short PIPEERRJ		; Lost the file
 26433 00003260 89C3                    	mov	bx,ax
 26434 00003262 B0FF                    	mov	al,0FFh
 26435                                  	;xchg	al,[bx+18h]
 26436 00003264 864718                  	xchg	al,[bx+PDB.JFN_TABLE]
 26437 00003267 A21900                  	mov	[PDB.JFN_TABLE+1],al
 26438 0000326A 8716[3604]              	xchg	dx,[InPipePtr]	; Swap for next element of pipe
 26439 0000326E 8916[3804]              	mov	[OutPipePtr],dx
 26440 00003272 EB0D                    	jmp	short PIPECOM
 26441                                  LASTPIPE:
 26442                                  	;mov	[cs:COMBUF+1],cl 
 26443                                  	; 27/02/2023
 26444 00003274 26880E[B39A]            	mov	[es:COMBUF+1],cl
 26445 00003279 4E                      	dec	si
 26446                                  	;;;mov	[3BEh],si ; MSDOS 5.0 COMMAND.COM
 26447                                  	;;mov	[488h],si ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 26448                                  	;mov	[4BCh],si ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 26449 0000327A 8936[B303]              	mov	[PipePtr],si	; Point at the CR (anything not '|' will do)
 26450                                  		; mov [EndInit+158],si
 26451 0000327E E851FD                  	call	TESTDOREOUT	; Set up the redirection if specified
 26452                                  PIPECOM:
 26453 00003281 0E                      	push	cs
 26454 00003282 1F                      	pop	ds
 26455 00003283 E996D0                  	jmp	NOPIPEPROC	; Process the pipe element
 26456                                  PIPEEND:
 26457 00003286 E895FE                  	call	PIPEDEL
 26458 00003289 813E[A502]00F0          	cmp	word [SingleCom],0F000h
 26459 0000328F 7506                    	jnz	short NOSINGP2
 26460 00003291 C706[A502]FFFF          	mov	word [SingleCom],-1 ; 0FFFFh ; Make it return
 26461                                  NOSINGP2:
 26462 00003297 E96ACE                  	jmp	TCOMMAND
 26463                                  
 26464                                  ; =============== S U B	R O U T	I N E =======================================
 26465                                  
 26466                                  ; Date and time are set during initialization and use
 26467                                  ; this routines since they need to do a long return
 26468                                  
 26469                                  	; 27/02/2023 - Retro DOS v4.0 COMMAND.COM
 26470                                  
 26471                                  DATINIT:
 26472 0000329A 2E8C1E[539C]            	mov	[cs:RESSEG],ds	; SetInitFlag needs resseg initialized
 26473 0000329F 06                      	push	es
 26474 000032A0 1E                      	push	ds		; Going to use the previous stack
 26475 000032A1 8CC8                    	mov	ax,cs		; Set up the appropriate segment registers
 26476 000032A3 8EC0                    	mov	es,ax
 26477 000032A5 8ED8                    	mov	ds,ax
 26478 000032A7 E85222                  	call	TSYSLOADMSG ; MSDOS 6.0 ; AN000; preload messages
 26479 000032AA BA[FEA5]                	mov	dx,INTERNATVARS
 26480 000032AD B80038                  	mov	ax,3800h
 26481                                  	;mov	ax,INTERNATIONAL*256 ; 3800h
 26482                                  	;int	21h	; DOS -	2+ - GET COUNTRY-DEPENDENT INFORMATION
 26483                                  			; get current-country info
 26484                                  			; DS:DX	-> buffer for returned info
 26485                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26486 000032B0 E807D3                  	call	int_21h_indirect
 26487                                  	; 20/10/2018
 26488 000032B3 C70681000D00            	mov	word [81h],0Dh ; Want to prompt for date during initialization
 26489 000032B9 C606[B29A]80            	mov	byte [COMBUF],128 ; Init COMBUF
 26490 000032BE C706[B39A]010D          	mov	word [COMBUF+1],0D01h
 26491 000032C4 E80600                  	call	DATE
 26492 000032C7 E86300                  	call	CTIME
 26493 000032CA 1F                      	pop	ds
 26494 000032CB 07                      	pop	es
 26495 000032CC CB                      	retf	; far return
 26496                                  
 26497                                  ; =============== S U B	R O U T	I N E =======================================
 26498                                  
 26499                                  ; MSDOS 6.0
 26500                                  
 26501                                  ; ****************************************************************
 26502                                  ; *
 26503                                  ; * ROUTINE:	 DATE - Set system date
 26504                                  ; *
 26505                                  ; * FUNCTION:	 If a date is specified, set the system date,
 26506                                  ; *		 otherwise display the current system date and
 26507                                  ; *		 prompt the user for a new date.  If an invalid
 26508                                  ; *		 date is specified, issue an error message and
 26509                                  ; *		 prompt for a new date.  If the user enters
 26510                                  ; *		 nothing when prompted for a date, terminate.
 26511                                  ; *
 26512                                  ; * INPUT:	 command line at offset 81H
 26513                                  ; *
 26514                                  ; * OUTPUT:	 none
 26515                                  ; *
 26516                                  ; ****************************************************************
 26517                                  
 26518                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26519                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:2FC4h
 26520                                  
 26521                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26522                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:356Eh
 26523                                  
 26524                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26525                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3417h
 26526                                  DATE:
 26527 000032CD BE8100                  	mov	si,81h			; Accepting argument for date inline
 26528 000032D0 BF[4696]                	mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26529 000032D3 31C9                    	xor	cx,cx			;AN000; clear counter for positionals
 26530 000032D5 31D2                    	xor	dx,dx			;AN000;
 26531 000032D7 E87216                  	call	cmd_parse		;AC000; call parser
 26532                                  
 26533                                  	; 27/02/2023
 26534                                  	;cmp	ax,-1
 26535                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26536                                  	;je	short PRMTDAT 		;AC000; yes - go ask for date
 26537                                  	;;cmp	ax,0
 26538                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26539                                  	;;jne	short DATERR		;AN000; yes - go issue message
 26540                                  	; 26/04/2023
 26541                                  	;or	ax,ax ; ax = 0 ?
 26542                                  	;jnz	short DATERR
 26543                                  	;;jmp	short COMDAT		;AC000; we have a date
 26544                                  	; 11/06/2023
 26545 000032DA 40                      	inc	ax  ; cmp ax,-1
 26546 000032DB 7429                    	jz	short PRMTDAT ; 0FFFFh -> 0
 26547 000032DD 48                      	dec	ax  ; cmp ax,0
 26548 000032DE 7542                    	jnz	short DATERR ; 1 -> 0
 26549                                  	; ax = 0
 26550                                  
 26551                                  	; 27/02/2023
 26552                                  COMDAT:
 26553 000032E0 8B0E[57A6]              	mov	cx,[DATE_YEAR]		;AC000; get parts of date in
 26554 000032E4 8A36[59A6]              	mov	dh,[DATE_MONTH]		;AC000;  cx and dx for set
 26555 000032E8 8A16[5AA6]              	mov	dl,[DATE_DAY]		;AC000;  date function call.
 26556 000032EC 51                      	push	cx			;AC000; save date
 26557 000032ED 52                      	push	dx			;AC000;
 26558 000032EE B90100                  	mov	cx,1			;AC000; set 1 positional entered
 26559 000032F1 31D2                    	xor	dx,dx			;AN029;
 26560 000032F3 E85616                  	call	cmd_parse		;AN029; call parser
 26561 000032F6 3CFF                    	cmp	al,0FFh ; -1
 26562                                  	;cmp	al,END_OF_LINE		;AN029; Are we at end of line?
 26563 000032F8 5A                      	pop	dx			;AC000; retrieve date
 26564 000032F9 59                      	pop	cx			;AC000;
 26565 000032FA 7526                    	jnz	short DATERR		;AC000; extra stuff on line - try again
 26566                                  	; 26/04/2023
 26567                                  	;mov	ah,SET_DATE		;yes - set date
 26568 000032FC B42B                    	mov	ah,2Bh
 26569                                  	;int	21h
 26570                                  			; DOS - SET CURRENT DATE
 26571                                  			; DL = day, DH = month, CX = year
 26572                                  			; Return: AL = 00h if no error /= FFh if bad value sent to routine
 26573                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26574 000032FE E8B9D2                  	call	int_21h_indirect
 26575 00003301 08C0                    	or	al,al
 26576 00003303 751D                    	jnz	short DATERR
 26577                                  date_end:
 26578 00003305 C3                      	retn
 26579                                  
 26580                                  PRMTDAT:
 26581                                  	; Print "Current date is
 26582 00003306 E81B08                  	call	GetDate 		;AN000; get date for output
 26583                                  
 26584 00003309 86F2                    	xchg	dh,dl			;AN000; switch month & day
 26585 0000330B 890E[B490]              	mov	[CurDat_yr],cx		;AC000; put year into message control block
 26586 0000330F 8916[B690]              	mov	[CurDat_mo_day],dx	;AC000; put month and day into message control block
 26587 00003313 BA[A490]                	mov	dx,CurDat_Ptr		;AC000; set up message for output
 26588 00003316 E80421                  	call	std_printf
 26589                                  
 26590                                  ;AD061; mov	word [CurDat_yr],0	;AC000; reset year, month and day
 26591                                  ;AD061; mov	word [CurDat_mo_day],0 	;AC000;  pointers in control block
 26592                                  
 26593                                  GET_NEW_DATE:				;AN000;
 26594 00003319 E8BE00                  	call	GETDAT			;AC000; prompt user for date
 26595                                  	
 26596                                  	; 11/06/2023
 26597                                  	;cmp	ax,0FFFFh ; -1
 26598                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26599                                  	;je	short date_end		;AC000; yes - exit
 26600                                  	; 26/04/2023
 26601                                  	;;cmp	ax,0
 26602                                  	;;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26603                                  	;;;jnz	short DATERR		;AN000; yes - go issue message
 26604                                  	;; 27/02/2023
 26605                                  	;;jz	short COMDAT
 26606                                  	; 26/04/2023
 26607                                  	;and	ax,ax ; 0 ?
 26608                                  	;jz	short COMDAT
 26609                                  
 26610                                  	; 11/06/2023
 26611 0000331C 40                      	inc	ax  ; cmp ax,-1
 26612 0000331D 74E6                    	jz	short date_end ; 0FFFFh -> 0
 26613 0000331F 48                      	dec	ax  ; cmp ax,0
 26614 00003320 74BE                    	jz	short COMDAT ; 1 -> 0
 26615                                  	; ax > 0
 26616                                  
 26617                                  ;COMDAT:
 26618                                  ;	....
 26619                                  DATERR:
 26620 00003322 E852F6                  	call	CRLF2			;AN028; print out a blank line
 26621 00003325 BA[A190]                	mov	dx,BADDAT_PTR
 26622 00003328 E8F220                  	call	std_printf
 26623 0000332B EBEC                    	jmp	short GET_NEW_DATE	;AC000; get date again
 26624                                  
 26625                                  ; =============== S U B	R O U T	I N E =======================================
 26626                                  
 26627                                  ; MSDOS 6.0
 26628                                  
 26629                                  ; TIME gets and sets the time
 26630                                  
 26631                                  ; ****************************************************************
 26632                                  ; *
 26633                                  ; * ROUTINE:	 TIME - Set system time
 26634                                  ; *
 26635                                  ; * FUNCTION:	 If a time is specified, set the system time,
 26636                                  ; *		 otherwise display the current system time and
 26637                                  ; *		 prompt the user for a new time.  If an invalid
 26638                                  ; *		 time is specified, issue an error message and
 26639                                  ; *		 prompt for a new time.  If the user enters
 26640                                  ; *		 nothing when prompted for a time, terminate.
 26641                                  ; *
 26642                                  ; * INPUT:	 command line at offset 81H
 26643                                  ; *
 26644                                  ; * OUTPUT:	 none
 26645                                  ; *
 26646                                  ; ****************************************************************
 26647                                  
 26648                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26649                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:302Dh
 26650                                  
 26651                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26652                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:35D7h
 26653                                  
 26654                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 26655                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3481h
 26656                                  CTIME:
 26657 0000332D BE8100                  	mov	si,81h			; Accepting argument for time inline
 26658 00003330 BF[5896]                	mov	di,PARSE_TIME		;AN000; Get address of PARSE_time
 26659 00003333 31C9                    	xor	cx,cx			;AN000; clear counter for positionals
 26660 00003335 31D2                    	xor	dx,dx			;AN000;
 26661 00003337 E81216                  	call	cmd_parse		;AC000; call parser
 26662                                  	
 26663                                  	; 27/02/2023
 26664                                  	;cmp	ax,-1
 26665                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26666                                  	;je	short PRMTTIM 		;AC000; yes - prompt for time
 26667                                  	;;cmp	ax,0
 26668                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26669                                  	;;jne	short TIMERR		;AN000; yes - go issue message
 26670                                  	;and	ax,ax ; ax = 0 ?
 26671                                  	;jnz	short TIMERR
 26672                                  	;;jmp	short COMTIM		;AC000; we have a time
 26673                                  	; 11/06/2023
 26674 0000333A 40                      	inc	ax  ; cmp ax,-1
 26675 0000333B 742D                    	jz	short PRMTTIM ; 0FFFFh -> 0
 26676 0000333D 48                      	dec	ax  ; cmp ax,0
 26677 0000333E 754A                    	jnz	short TIMERR ; 1 -> 0
 26678                                  	; ax = 0
 26679                                  	
 26680                                  	; 27/02/2023
 26681                                  COMTIM:
 26682 00003340 8A2E[5FA6]              	mov	ch,[TIME_HOUR]		;AC000; get parts of time in
 26683 00003344 8A0E[60A6]              	mov	cl,[TIME_MINUTES]	;AC000;  cx and dx for set
 26684 00003348 8A36[61A6]              	mov	dh,[TIME_SECONDS]	;AC000;  time function call
 26685 0000334C 8A16[62A6]              	mov	dl,[TIME_FRACTION]	;AC000;
 26686 00003350 51                      	push	cx			;AC000; save time
 26687 00003351 52                      	push	dx			;AC000;
 26688 00003352 B90100                  	mov	cx,1			;AC000; set 1 positional parm entered
 26689 00003355 31D2                    	xor	dx,dx			;AN029;
 26690 00003357 E8F215                  	call	cmd_parse		;AN029; call parser
 26691 0000335A 3CFF                    	cmp	al, -1
 26692                                  	;cmp	al,END_OF_LINE		;AN029; Are we at end of line?
 26693 0000335C 5A                      	pop	dx			;AC000; retieve time
 26694 0000335D 59                      	pop	cx			;AC000;
 26695 0000335E 752A                    	jnz	short TIMERR		;AC000; extra stuff on line - try again
 26696                                  SAVTIM:
 26697                                  	;mov	ah,SET_TIME
 26698 00003360 B42D                    	mov	ah,2Dh
 26699                                  	;int	21h
 26700                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26701 00003362 E855D2                  	call	int_21h_indirect
 26702 00003365 08C0                    	or	al,al
 26703 00003367 7521                    	jnz	short TIMERR		;AC000; if an error occured, try again
 26704                                  time_end:
 26705 00003369 C3                      	retn
 26706                                  
 26707                                  PRMTTIM:
 26708                                  	;Printf "Current time is ... "
 26709                                  
 26710                                  	;mov	ah,Get_Time		;AC000; get the current time
 26711 0000336A B42C                    	mov	ah,2Ch
 26712                                  	;int	21h			;AC000;   Get time in CX:DX
 26713                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 26714 0000336C E84BD2                  	call	int_21h_indirect
 26715 0000336F 86E9                    	xchg	ch,cl			;AN000; switch hours & minutes
 26716 00003371 86F2                    	xchg	dh,dl			;AN000; switch seconds & hundredths
 26717 00003373 890E[D690]              	mov	[CurTim_hr_min],cx	;AC000; put hours and minutes into message subst block
 26718 00003377 8916[D890]              	mov	[CurTim_Sec_hn],dx	;AC000; put seconds and hundredths into message subst block
 26719 0000337B BA[D190]                	mov	dx,CurTim_Ptr		;AC000; set up message for output
 26720 0000337E E89C20                  	call	std_printf
 26721                                  
 26722                                  ;AD061; mov	word [CurTim_hr_min],0 	;AC000; reset hour, minutes, seconds, and hundredths
 26723                                  ;AD061; mov	word [CurTim_Sec_hn],0 	;AC000;  pointers in control block
 26724                                  
 26725                                  GET_NEW_TIME:
 26726 00003381 E8AE00                  	call	GETTIM			;AC000;
 26727                                  	
 26728                                  	; 11/06/2023
 26729                                  	;cmp	ax,-1
 26730                                  	;;cmp	ax,END_OF_LINE		;AC000; are we at end of line?
 26731                                  	;je	short time_end		;AC000;
 26732                                  	;;cmp	ax,0
 26733                                  	;;cmp	ax,RESULT_NO_ERROR	;AN000; did we have an error?
 26734                                  	;;jne	short TIMERR		;AN000; yes - go issue message
 26735                                  	;or	ax,ax  ; ax = 0 ?
 26736                                  	;;jnz	short TIMERR
 26737                                  	; 27/02/2023
 26738                                  	;jz	short COMTIM
 26739                                  
 26740                                  	; 11/06/2023
 26741 00003384 40                      	inc	ax  ; cmp ax,-1
 26742 00003385 74E2                    	jz	short time_end ; 0FFFFh -> 0
 26743 00003387 48                      	dec	ax  ; cmp ax,0
 26744 00003388 74B6                    	jz	short COMTIM ; 1 -> 0
 26745                                  	; ax > 0
 26746                                  
 26747                                  ;COMTIM:
 26748                                  ;	....
 26749                                  TIMERR:
 26750 0000338A E8EAF5                  	call	CRLF2			;AN028; print out a blank line
 26751 0000338D BA[CE90]                	mov	dx,BadTim_Ptr
 26752 00003390 E88A20                  	call	std_printf		; Print error message
 26753 00003393 EBEC                    	jmp	short GET_NEW_TIME	;AC000; Try again
 26754                                  
 26755                                  ; =============== S U B	R O U T	I N E =======================================
 26756                                  
 26757                                  ; MSDOS 6.0
 26758                                  
 26759                                  ; Set the special flag in the INIT flag to the value in CX.
 26760                                  
 26761                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26762                                  SetInitFlag:
 26763 00003395 8E1E[539C]              	mov	ds,[RESSEG]
 26764                                  
 26765 00003399 8026[1203]FD            	and	byte [InitFlag],~INITSPECIAL ; 0FDh ; not initspecial
 26766                                  	;and	byte [InitFlag],0FDh
 26767 0000339E 080E[1203]              	or	byte [InitFlag],cl
 26768 000033A2 0E                      	push	cs
 26769 000033A3 1F                      	pop	ds
 26770 000033A4 C3                      	retn
 26771                                  
 26772                                  ; =============== S U B	R O U T	I N E =======================================
 26773                                  
 26774                                  ; MSDOS 6.0
 26775                                  
 26776                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26777                                  PipeOff:
 26778 000033A5 1E                      	push	ds
 26779 000033A6 50                      	push	ax
 26780 000033A7 2E8E1E[539C]            	mov	ds,[cs:RESSEG]
 26781 000033AC 30C0                    	xor	al,al
 26782 000033AE 8606[1303]              	xchg	[PipeFlag],al
 26783 000033B2 08C0                    	or	al,al
 26784 000033B4 7404                    	jz	short PipeOffDone
 26785 000033B6 D02E[9D02]              	shr	byte [EchoFlag],1
 26786                                  PipeOffDone:
 26787 000033BA 58                      	pop	ax
 26788 000033BB 1F                      	pop	ds
 26789 000033BC C3                      	retn
 26790                                  
 26791                                  ; =============== S U B	R O U T	I N E =======================================
 26792                                  
 26793                                  ; MSDOS 6.0
 26794                                  
 26795                                  	; 27/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26796                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26797                                  
 26798                                  ;burada kaldým... 06/08/2024
 26799                                  PRINT_TIME:
 26800                                  	;mov	ah,Get_Time
 26801 000033BD B42C                    	mov	ah,2Ch
 26802 000033BF CD21                    	int	21h			; Get time in CX:DX
 26803                                  
 26804 000033C1 06                      	push	es
 26805 000033C2 0E                      	push	cs
 26806 000033C3 07                      	pop	es
 26807 000033C4 86E9                    	xchg	ch,cl			;AN000; switch hours & minutes
 26808 000033C6 86F2                    	xchg	dh,dl			;AN000; switch seconds & hundredths
 26809 000033C8 2E890E[1892]            	mov	[cs:PromTim_hr_min],cx	;AC000; put hours and minutes into message subst block
 26810 000033CD 2E8916[1A92]            	mov	[cs:PromTim_Sec_hn],dx	;AC000; put seconds and hundredths into message subst block
 26811 000033D2 BA[1392]                	mov	dx,promtim_ptr		;AC000; set up message for output
 26812 000033D5 E84520                  	call	std_printf
 26813                                  
 26814                                  ;AD061; mov	word [cs:PromTim_hr_min],0
 26815                                  					;AC000; reset hour, minutes, seconds, and hundredths
 26816                                  ;AD061; mov	word [cs:PromTim_Sec_hn],0
 26817                                  					;AC000;  pointers in control block
 26818 000033D8 07                      	pop	es
 26819 000033D9 C3                      	retn
 26820                                  
 26821                                  ; =============== S U B	R O U T	I N E =======================================
 26822                                  
 26823                                  ; MSDOS 6.0
 26824                                  
 26825                                  ; ****************************************************************
 26826                                  ; *
 26827                                  ; * ROUTINE:	 GETDAT - Prompt user for date
 26828                                  ; *
 26829                                  ; * FUNCTION:	 Gets the date format from the COUNTRY DEPENDENT
 26830                                  ; *		 INFORMATION and issues the "Enter new date"
 26831                                  ; *		 message with the proper date format. COMBUF
 26832                                  ; *		 is reset to get a date from the command line.
 26833                                  ; *		 The PARSE_DATE blocks are then reset and the
 26834                                  ; *		 PARSE function call is issued.
 26835                                  ; *
 26836                                  ; * INPUT:	 NONE
 26837                                  ; *
 26838                                  ; * OUTPUT:	 COMBUF
 26839                                  ; *		 PARSER RETURN CODES
 26840                                  ; *
 26841                                  ; ****************************************************************
 26842                                  
 26843                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26844                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:30E2h
 26845                                  
 26846                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26847                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:368Ch
 26848                                  GETDAT:
 26849                                  	;mov	ax,(International SHL 8)
 26850 000033DA B80038                  	mov	ax,3800h
 26851                                  					; Determine what format the date
 26852 000033DD BA5C00                  	mov	dx,5Ch			;  should be entered in and
 26853 000033E0 CD21                    	int	21h			;  print a message describing it
 26854                                  			; DOS - 2+ - GET COUNTRY-DEPENDENT INFORMATION
 26855                                  			; get current-country info
 26856                                  			; DS:DX -> buffer for returned info
 26857 000033E2 89D6                    	mov	si,dx
 26858 000033E4 AD                      	lodsw
 26859 000033E5 2E8B16[F191]            	mov	dx,[cs:usadat_ptr]	;AC000; get mm-dd-yy
 26860 000033EA 48                      	dec	ax
 26861 000033EB 780C                    	js	short printformat
 26862 000033ED 2E8B16[F491]            	mov	dx,[cs:eurdat_ptr]	;AC000; get dd-mm-yy
 26863 000033F2 7405                    	jz	short printformat
 26864 000033F4 2E8B16[F791]            	mov	dx,[cs:japdat_ptr]	;AC000; get yy-mm-dd
 26865                                  printformat:
 26866 000033F9 89D0                    	mov	ax,dx			;AN000; get message number of format
 26867                                  	;mov	dh,util_msg_class	;AN000; this is a utility message
 26868 000033FB B6FF                    	mov	dh,-1 ; 0FFh
 26869 000033FD E80221                  	call	TSYSGETMSG		;AN000; get the address of the message
 26870 00003400 2E8936[C590]            	mov	[cs:NewDat_Format],si	;AN000; put the address in subst block
 26871 00003405 BA[C090]                	mov	dx,NewDat_Ptr		;AC000; get address of message to print
 26872 00003408 E81220                  	call	std_printf
 26873                                  	;mov	word [cs:NewDat_Format],no_subst
 26874                                  					;AN000; reset subst block
 26875 0000340B 2EC706[C590]0000        	mov	word [cs:NewDat_Format],0
 26876                                  
 26877                                  	; 28/02/2023
 26878 00003412 BF[4696]                	mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26879                                  ; 28/02/2023
 26880                                  gettim_p:	
 26881                                  	;mov	ah,Std_Con_String_Input
 26882 00003415 B40A                    	mov	ah,0Ah
 26883 00003417 BA[B29A]                	mov	dx,COMBUF
 26884 0000341A B90200                  	mov	cx,INITSPECIAL ; 2	; Set bit in InitFlag that indicates
 26885 0000341D E875FF                  	call	SetInitFlag		;  prompting for date.
 26886 00003420 CD21                    	int	21h			; Get input line
 26887 00003422 31C9                    	xor	cx,cx			; Reset bit in InitFlag that indicates
 26888 00003424 E86EFF                  	call	SetInitFlag		;  prompting for date.
 26889 00003427 E84DF5                  	call	CRLF2
 26890                                  	; 28/02/2023
 26891                                  	;mov	di,PARSE_DATE		;AN000; Get address of PARSE_DATE
 26892                                  ;gettim_p: ; 28/02/2023
 26893 0000342A BE[B49A]                	mov	si,COMBUF+2
 26894                                  	;xor	cx,cx	 ; cx = 0	;AN000; clear counter for positionals
 26895 0000342D 31D2                    	xor	dx,dx			;AN000;
 26896                                  	;call	cmd_parse		;AC000; call parser
 26897                                  	;retn
 26898                                  	; 28/02/2023
 26899 0000342F E91A15                  	jmp	cmd_parse
 26900                                  
 26901                                  ; =============== S U B	R O U T	I N E =======================================
 26902                                  
 26903                                  ; MSDOS 6.0
 26904                                  
 26905                                  ; ****************************************************************
 26906                                  ; *
 26907                                  ; * ROUTINE:	 GETTIME - Prompt user for time
 26908                                  ; *
 26909                                  ; * FUNCTION:	 Gets the time format from the COUNTRY DEPENDENT
 26910                                  ; *		 INFORMATION and issues the "Enter new time"
 26911                                  ; *		 message. COMBUF is reset to get a time from the
 26912                                  ; *		 command line. The PARSE_TIME blocks are then
 26913                                  ; *		 reset and the PARSE function call is issued.
 26914                                  ; *
 26915                                  ; * INPUT:	 NONE
 26916                                  ; *
 26917                                  ; * OUTPUT:	 COMBUF
 26918                                  ; *		 PARSER RETURN CODES
 26919                                  ; *
 26920                                  ; ****************************************************************
 26921                                  
 26922                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26923                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:313Dh
 26924                                  
 26925                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 26926                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:36E7h
 26927                                  GETTIM:
 26928 00003432 31C9                    	xor	cx,cx			; Initialize hours and minutes to zero
 26929 00003434 BA[DF90]                	mov	dx,NewTim_Ptr
 26930 00003437 E8E31F                  	call	std_printf
 26931                                  
 26932                                  	; 28/02/2023
 26933 0000343A BF[5896]                	mov	di,PARSE_TIME
 26934 0000343D EBD6                    	jmp	short gettim_p
 26935                                  
 26936                                  ; 28/02/2023
 26937                                  ;	;mov	ah,Std_Con_String_Input
 26938                                  ;	mov	ah,0Ah
 26939                                  ;	mov	dx,COMBUF
 26940                                  ;	mov	cx,INITSPECIAL ; 2	; Set bit in InitFlag that indicates
 26941                                  ;	call	SetInitFlag		;  prompting for time.
 26942                                  ;	int	21h			; Get input line
 26943                                  ;	; 28/02/2023
 26944                                  ;	xor	cx,cx			; Reset bit in InitFlag that indicates
 26945                                  ;	call	SetInitFlag		;  prompting for time.
 26946                                  ;	call	CRLF2
 26947                                  ;	; 28/02/2023
 26948                                  ;	;mov	si,COMBUF+2
 26949                                  ;	; 28/02/2023
 26950                                  ;	mov	di,PARSE_TIME		;AN000; Get address of PARSE_TIME
 26951                                  ;	; 28/02/2023
 26952                                  ;	jmp	short gettim_p	
 26953                                  ;	; 28/02/2023
 26954                                  ;	;;xor	cx,cx			;AN000; clear counter for positionals
 26955                                  ;	;xor	dx,dx			;AN000;
 26956                                  ;	;call	cmd_parse		;AC000; call parser
 26957                                  ;	;retn
 26958                                  
 26959                                  
 26960                                  ; =============== S U B	R O U T	I N E =======================================
 26961                                  
 26962                                  ; MSDOS 6.0
 26963                                  
 26964                                  ;Skip_white: Skips over the whitespace chars that could be present after
 26965                                  ;the '=' sign in the environment variable before the actual path.
 26966                                  ;
 26967                                  ;	ENTRY:	ds:si = arguments of the environment variable
 26968                                  ;
 26969                                  ;	EXIT:	ds:si = start of the path
 26970                                  ;
 26971                                  ;	REGISTERS AFFECTED: ax
 26972                                  
 26973                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 26974                                  skip_white:
 26975 0000343F FC                      	cld
 26976                                  skw_lp:
 26977 00003440 AC                      	lodsb
 26978 00003441 3C20                    	cmp	al,' '			;blank char?
 26979 00003443 74FB                    	jz	short skw_lp		;yes, skip it
 26980 00003445 3C09                    	cmp	al,9			;tab char?
 26981 00003447 74F7                    	jz	short skw_lp		;yes, skip it
 26982 00003449 4E                      	dec	si			;point at first non-white
 26983 0000344A C3                      	retn
 26984                                  
 26985                                  ; =============== S U B	R O U T	I N E =======================================
 26986                                  
 26987                                  ; MSDOS 6.0
 26988                                  
 26989                                  ;Copy_pipe_path: This routine copies the path from the TEMP environment
 26990                                  ;variable into the path buffers Pipe1 & Pipe2.
 26991                                  ;
 26992                                  ;	ENTRY:	ds:si = path to be copied
 26993                                  ;		es = RESGROUP
 26994                                  ;
 26995                                  ;	EXIT:	Path copied into Pipe1 and Pipe2.
 26996                                  ;
 26997                                  ;	REGISTERS AFFECTED: si, di, cx, ax
 26998                                  
 26999                                  	; 28/02/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27000                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3174h
 27001                                  
 27002                                  	; 11/06/2023 - Retro DOS v4.2 COMMAND.COM
 27003                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:371Eh
 27004                                  copy_pipe_path:
 27005 0000344B B9FFFF                  	mov	cx,0FFFFh ; 65535
 27006 0000344E 30C0                    	xor	al,al
 27007                                  
 27008 00003450 89F7                    	mov	di,si
 27009 00003452 06                      	push	es			;save es
 27010 00003453 1E                      	push	ds
 27011 00003454 07                      	pop	es			;es:di = path to be copied
 27012                                  	
 27013 00003455 FC                      	cld
 27014 00003456 57                      	push	di
 27015 00003457 F2AE                    	repnz	scasb			;look for the null char
 27016 00003459 5F                      	pop	di
 27017                                  
 27018 0000345A 07                      	pop	es			;es = RESGROUP again
 27019                                  
 27020 0000345B F7D1                    	not	cx			;length including the null
 27021                                  
 27022                                  	;;;mov	di,320h ; MSDOS 5.0 COMMAND.COM ; (RESGROUP:EndInit)
 27023                                  	;;mov	di,3EAh ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 27024                                  	;mov	di,offset DATARES:Pipe1
 27025 0000345D BF[1503]                	mov	di,Pipe1  ; (offset RESGROUP:EndInit)
 27026 00003460 57                      	push	di
 27027 00003461 51                      	push	cx			
 27028 00003462 F3A4                    	rep	movsb			;copy path into Pipe1
 27029 00003464 59                      	pop	cx
 27030 00003465 5F                      	pop	di
 27031                                  
 27032 00003466 1E                      	push	ds
 27033 00003467 06                      	push	es
 27034 00003468 1F                      	pop	ds			;ds:si = Pipe1
 27035 00003469 89FE                    	mov	si,di
 27036                                  	;;;mov	di,36Fh ; MSDOS 5.0 COMMAND.COM ; (RESGROUP:EndInit+79)
 27037                                  	;;mov	di,439h ; MSDOS 6.22 COMMAND.COM ; 11/06/2023
 27038                                  	;mov	di,offset DATARES:Pipe2	;es:di = Pipe2
 27039 0000346B BF[6403]                	mov	di,Pipe2  ; (offset RESGROUP:EndInit+79)
 27040 0000346E F3A4                    	rep	movsb			;copy path into Pipe2
 27041 00003470 1F                      	pop	ds
 27042 00003471 C3                      	retn
 27043                                  
 27044                                  ;============================================================================
 27045                                  ; PARSE2.ASM, MSDOS 6.0, 1991
 27046                                  ;============================================================================
 27047                                  ; 03/10/2018 - Retro DOS v3.0
 27048                                  
 27049                                  ;----------------------------------------------------------------------------
 27050                                  ; PARSELINE takes an MSDOS command line and maps it into a UNIX-style
 27051                                  ; argv[argvcnt] array. The most important difference between this array and
 27052                                  ; the tradition UNIX format is the extra cparse information included with
 27053                                  ; each argument element.
 27054                                  ;---------------
 27055                                  ; ENTRY:
 27056                                  ;	BL	     special delimiter for cparse -- not implemented)
 27057                                  ;---------------
 27058                                  ; EXIT:
 27059                                  ;	CF	    set if error
 27060                                  ;	AL	    error code (carry set). Note AH clobbered in any event.
 27061                                  ;	argv[]	    array of cparse flags and pointers to arguments
 27062                                  ;	argvcnt     argument count
 27063                                  ;---------------
 27064                                  ; NOTE(S):
 27065                                  ;	*   BL (special delimiter) is ignored, for now (set to space).
 27066                                  ;	*   Parseflags record contains cparse flags, as follows:
 27067                                  ;		sw_flag 	--	was this arg a switch?
 27068                                  ;		wildcard	--	whether or not it contained a * or ?
 27069                                  ;		path_sep	--	maybe it was a pathname
 27070                                  ;		unused		--	for future expansion
 27071                                  ;		special_delim	--	was there an initial special delimiter?
 27072                                  ;	*   argv[] and argvcnt are undefined if CF/AL indicates an error.
 27073                                  ;	*   Relationship between input, cparse output, and comtail can be
 27074                                  ;	    found in the following chart. Despite the claim of the cparse
 27075                                  ;	    documentation that, "Token buffer always starts d: for non switch
 27076                                  ;	    tokens", such is not the case (see column two, row two).
 27077                                  ;	    Similarly, [STARTEL] is not null when the command line is one of
 27078                                  ;	    the forms, "d:", "d:\", or "d:/". In fact, *STARTEL (i.e., what
 27079                                  ;	    STARTEL addresses) will be null. This is clearly just a
 27080                                  ;	    documentation error.
 27081                                  ;	*   cparse also returns a switch code in BP for each switch it
 27082                                  ;	    recognizes on the command line.
 27083                                  ;	*   arglen for each token does NOT include the terminating null.
 27084                                  ;	*   Finally, note that interesting constructions like 'foodir/*.exe'
 27085                                  ;	    parse as three separate tokens, and the asterisk is NOT a wildcard.
 27086                                  ;	    For example, 'for %i in (foodir/*.exe) do echo %i' will first
 27087                                  ;	    echo 'foodir', then '*', then '.exe'. Using cparse for command-
 27088                                  ;	    line parsing may result in slightly different behavior than
 27089                                  ;	    previously observed with the old COMMAND.COM command-line parser.
 27090                                  ;
 27091                                  ;	    Input		    Cparse		Command Line (80H)
 27092                                  ;	\alan\foo.bat		c:\alan\foo.bat 	\alan\foo.bat
 27093                                  ;	alan\foo.bat		alan\foo.bat		alan\foo.bat
 27094                                  ;	foo.bat 		foo.bat 		foo.bat
 27095                                  ;	c:\alan\foo.bat 	c:\alan\foo.bat 	c:\alan\foo.bat
 27096                                  ;	c:alan\foo.bat		c:alan\foo.bat		c:alan\foo.bat
 27097                                  ;	c:foo.bat		c:foo.bat		c:foo.bat
 27098                                  
 27099                                  ; =============== S U B	R O U T	I N E =======================================
 27100                                  
 27101                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 23D0h
 27102                                  
 27103                                  ; 01/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27104                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 319Bh
 27105                                  
 27106                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27107                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3745h
 27108                                  
 27109                                  ; 27/07/2024 - Retro DOS v4.0-v4.1-v4.2-v5.0 COMMAND.COM (PARSELINE)
 27110                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 35F5h
 27111                                  
 27112                                  PARSELINE:
 27113 00003472 50                      	push	ax			; most of these are clobbered
 27114 00003473 53                      	push	bx			; by cparse...
 27115 00003474 51                      	push	cx
 27116 00003475 52                      	push	dx
 27117 00003476 57                      	push	di
 27118 00003477 56                      	push	si
 27119 00003478 9C                      	pushf
 27120                                  	;mov	byte [cpyflag],0  ; Turn "CPARSE called from COPY flag" off
 27121 00003479 C706[75A4]FFFF          	mov	word [LASTARG],-1 ; last argument at which to accumulate
 27122 0000347F 31C0                    	xor	ax,ax
 27123                                  	;;mov	cx,1348
 27124                                  	; 27/07/2024
 27125                                  	;mov	cx,1092  ; PCDOS 7.1 COMMAND.COM
 27126 00003481 B94404                  	mov	cx,ARG_UNIT.SIZE ; 1092
 27127 00003484 A2[059E]                	mov	[cpyflag],al ; 0 ; 27/07/2024
 27128 00003487 BF[AF9F]                	mov	di,ARG
 27129 0000348A F3AA                    	rep	stosb
 27130                                  	;mov	word [ARGBUF_PTR],ARG_ARGBUF
 27131 0000348C C706[F3A3][73A2]        	mov	word [ARGBUF_PTR],ARG+ARG_UNIT.argbuf
 27132                                  	;mov	word [ARG_ARGSWINFO],0 ; switch information, and info to date
 27133                                  	;mov	word [ARG+ARG_UNIT.argswinfo],0
 27134 00003492 A3[71A2]                	mov	[ARG+ARG_UNIT.argswinfo],ax ; 0 ; 27/07/2024
 27135                                  	;mov	word [ARG_ARGVCNT],0 ; initialize argvcnt/argv[]
 27136                                  	;mov	word [ARG+ARG_UNIT.argvcnt],0
 27137 00003495 A3[6FA2]                	mov	[ARG+ARG_UNIT.argvcnt],ax ; 0 ; 27/07/2024 
 27138 00003498 BE[B49A]                	mov	si,COMBUF+2	; prescan leaves cooked input in combuf
 27139                                  
 27140                                  ; This next section of code (up to pcont:)  makes sure that si is set up for
 27141                                  ; parsing. It should point at COMBUF if FORFLAG is set and arg.argforcombuf
 27142                                  ; otherwise. This is done so that commands can get arg pointers into their
 27143                                  ; original command line (or an exact copy of it) in arg_ocomptr.
 27144                                  ; Arg.argforcombuf is used so that the for loop processor will always be able
 27145                                  ; to get a hold of its original command line; even after COMBUF is blasted by
 27146                                  ; the command to be repeated or the transient part of command has been
 27147                                  ; reloaded.
 27148                                  
 27149 0000349B 1E                      	push	ds
 27150 0000349C 8E1E[539C]              	mov	ds,[RESSEG]
 27151                                  	;cmp	byte [ForFlag],0
 27152 000034A0 3806[AB02]              	cmp	[ForFlag],al ; 0 ; 27/07/2024
 27153 000034A4 1F                      	pop	ds
 27154 000034A5 7510                    	jnz	short PCONT
 27155                                  	;mov	di,ARG_ARGFORCOMBUF
 27156 000034A7 BF[73A3]                	mov	di,ARG+ARG_UNIT.argforcombuf
 27157 000034AA 30ED                    	xor	ch,ch
 27158 000034AC 8A0E[B39A]              	mov	cl,[COMBUF+1]
 27159 000034B0 FEC1                    	inc	cl
 27160 000034B2 F3A4                    	rep	movsb
 27161                                  	;mov	si,ARG_ARGFORCOMBUF
 27162 000034B4 BE[73A3]                	mov	si,ARG+ARG_UNIT.argforcombuf
 27163                                  PCONT:
 27164 000034B7 BF[F5A3]                	mov	di,TPBUF	; destination is temporary token buffer
 27165 000034BA B320                    	mov	bl,' '		; no special delimiter, for now
 27166                                  PARSELOOP:
 27167 000034BC 8936[77A4]              	mov	[COMPTR],si	; save ptr into original command buffer
 27168 000034C0 31ED                    	xor	bp,bp		; switch information put here by cparse
 27169 000034C2 C606[919F]00            	mov	byte [expand_star],0 ; don't expand *'s to ?'s
 27170 000034C7 E8BAF4                  	call	scanoff		; skip leading blanks...
 27171 000034CA E8BA12                  	call	cparse		; byte off a token (args in SI, DI, BL)
 27172 000034CD 730B                    	jnb	short MORE_PRSE
 27173 000034CF 09ED                    	or	bp,bp		; Check for trailing switch character
 27174 000034D1 7403                    	jz	short PARSEDONE
 27175 000034D3 E81700                  	call	newarg		; We hit CR but BP is non-zero. The
 27176                                  				;   typical cause of this is that a
 27177                                  				;   switch char IMMEDIATELY preceeds
 27178                                  				;   the CR. We have an argument, but it
 27179                                  				;   is sort of an error.
 27180                                  	;jmp	short PARSEDONE	; We're done (found the CR).
 27181                                  	; 01/03/2023
 27182                                  PARSEDONE:
 27183 000034D6 9D                      	popf
 27184 000034D7 F8                      	clc
 27185 000034D8 EB0C                    	jmp	short PARSE_EXIT
 27186                                  
 27187                                  MORE_PRSE:
 27188 000034DA C606[059E]02            	mov	byte [cpyflag],2
 27189                                  				; tell CPARSE that 1st token is done
 27190 000034DF E80B00                  	call	newarg		; add to argv array (CX has char count)
 27191 000034E2 73D8                    	jnb	short PARSELOOP	; was everything OK?
 27192                                  	;jmp	short PARSE_ERROR ; NO, it wasn't -- bug out (CF set)
 27193                                  	; 01/03/2023
 27194                                  ;PARSEDONE:
 27195                                  	;popf
 27196                                  	;clc
 27197                                  	;jmp	short PARSE_EXIT
 27198                                  
 27199                                  PARSE_ERROR:			; error entry (er, exit) point
 27200 000034E4 9D                      	popf
 27201 000034E5 F9                      	stc
 27202                                  PARSE_EXIT:			; depend on not changing CF
 27203 000034E6 5E                      	pop	si
 27204 000034E7 5F                      	pop	di
 27205 000034E8 5A                      	pop	dx
 27206 000034E9 59                      	pop	cx
 27207 000034EA 5B                      	pop	bx
 27208 000034EB 58                      	pop	ax
 27209 000034EC C3                      	retn
 27210                                  
 27211                                  ; =============== S U B	R O U T	I N E =======================================
 27212                                  
 27213                                  ; NEWARG adds the supplied argstring and cparse data to arg.argv[].
 27214                                  ;
 27215                                  ; ENTRY:
 27216                                  ;   BH			argflags
 27217                                  ;   CX			character count in argstring
 27218                                  ;   DI			pointer to argstring
 27219                                  ;   comptr		ptr to starting loc of current token in original command
 27220                                  ;   [STARTEL]		cparse's answer to where the last element starts
 27221                                  ; EXIT:
 27222                                  ;   argbufptr		points to next free section of argbuffer
 27223                                  ;   arg.argbuf		contains null-terminated argument strings
 27224                                  ;   arg.argvcnt 	argument count
 27225                                  ;   arg.argv[]		array of flags and pointers
 27226                                  ;   arg.arg_ocomptr	ptr to starting loc of current token in original command
 27227                                  ;   CF			set if error
 27228                                  ;   AL			carry set:  error code; otherwise, zero
 27229                                  
 27230                                  	; 01/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27231                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27232                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27233                                  newarg:
 27234 000034ED 53                      	push	bx
 27235 000034EE 51                      	push	cx
 27236 000034EF 52                      	push	dx
 27237 000034F0 57                      	push	di
 27238 000034F1 56                      	push	si
 27239 000034F2 9C                      	pushf
 27240 000034F3 E86200                  	call	arg_switch		; if it's a switch, record switch info
 27241                                  					; LEAVE SWITCH ON COMMAND LINE!!
 27242                                  	;;;jc	short newarg_done 	; previous arg's switches -- and leave
 27243                                  
 27244                                  	;cmp	word [ARG_ARGVCNT],64	; check to ensure we've not
 27245 000034F6 833E[6FA2]40            	cmp	word [ARG+ARG_UNIT.argvcnt],ARGMAX ; 64
 27246 000034FB 7D50                    	jge	short to_many_args	; exceeded array limits
 27247 000034FD 88FE                    	mov	dh,bh			
 27248                                  	;mov	bx,[ARG_ARGVCNT]	; save argflags	
 27249 000034FF 8B1E[6FA2]              	mov	bx,[ARG+ARG_UNIT.argvcnt] ; argv[argvcnt++] = arg data
 27250                                  	;inc	word [ARG_ARGVCNT]
 27251 00003503 FF06[6FA2]              	inc	word [ARG+ARG_UNIT.argvcnt]
 27252                                  	;mov	ax,ARG_ARGV
 27253 00003507 B8[AF9F]                	mov	ax,ARG+ARG_UNIT.argv
 27254 0000350A E87E00                  	call	argv_calc		; convert offset to pointer
 27255                                  	;mov	[BX].argsw_word,0 	; no switch information, yet...
 27256                                  	;mov	word [bx+7],0
 27257 0000350D C747070000              	mov	word [bx+ARGV_ELE.argsw_word],0
 27258                                  	;mov	[BX].arglen,CX		; argv[argvcnt].arglen = arg length
 27259                                  	;mov	[bx+5],cx
 27260 00003512 894F05                  	mov	[bx+ARGV_ELE.arglen],cx 
 27261                                  	;mov	[BX].argflags,DH 	; argv[argvcnt].argflags = cparse flags
 27262                                  	;mov	[bx+2],dh
 27263 00003515 887702                  	mov	[bx+ARGV_ELE.argflags],dh
 27264 00003518 8B36[F3A3]              	mov	si,[ARGBUF_PTR]
 27265                                  	;mov	[BX].argpointer,SI 	; argv[argvcnt].argpointer = [argbufptr]
 27266                                  	;mov	[bx+ARGV_ELE.argpointer],si
 27267 0000351C 8937                    	mov	[bx],si			
 27268 0000351E 0336[559F]              	add	si,[STARTEL]		; save startel from new location
 27269 00003522 29FE                    	sub	si,di			; form pointer into argbuf
 27270                                  	;mov	[BX].argstartel,SI ; argv[argvcnt].argstartel = new [STARTEL]
 27271                                  	;mov	[bx+3],si
 27272 00003524 897703                  	mov	[bx+ARGV_ELE.argstartel],si
 27273 00003527 8B36[77A4]              	mov	si,[COMPTR]
 27274                                  	;mov	[BX].arg_ocomptr,si ; arg_ocomptr = ptr into original com line
 27275                                  	;mov	[bx+9],si
 27276 0000352B 897709                  	mov	[bx+ARGV_ELE.arg_ocomptr],si
 27277 0000352E 89FE                    	mov	si,di			; now save argstring in argbuffer
 27278 00003530 8B3E[F3A3]              	mov	di,[ARGBUF_PTR]		; load the argbuf pointer and make
 27279                                  
 27280                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27281                                  ; PCDOS 7.1 COMMAND.COM
 27282                                  %if 0
 27283                                  	add	di,cx			; sure we're not about to run off
 27284                                  	;cmp	DI,OFFSET TRANGROUP:arg.argbuf+ARGBLEN-1
 27285                                  	;;cmp	di,ARG_ARGBUF+255
 27286                                  	;cmp	di,ARG+ARG_UNIT.argbuf+127
 27287                                  	cmp	di,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27288                                  	jge	short buf_oflow		; the end of the buffer (plus null byte)
 27289                                  	sub	di,cx
 27290                                  %else
 27291                                  	; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27292                                  	;mov	bx,ARG_ARGBUF+127
 27293 00003534 BB[F2A2]                	mov	bx,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27294 00003537 29FB                    	sub	bx,di	; sure we're not about to run off
 27295 00003539 39CB                    	cmp	bx,cx
 27296 0000353B 7302                    	jnb	short newarg_@
 27297 0000353D 89D9                    	mov	cx,bx	
 27298                                  %endif
 27299                                  
 27300                                  newarg_@:	; 27/07/2024
 27301 0000353F FC                      	cld
 27302 00003540 F3A4                    	rep	movsb
 27303 00003542 B000                    	mov	al,ANULL ; 0		; tack a null byte on the end
 27304 00003544 AA                      	stosb
 27305 00003545 893E[F3A3]              	mov	[ARGBUF_PTR],di		; update argbufptr after copy
 27306                                  newarg_done:
 27307 00003549 9D                      	popf
 27308 0000354A F8                      	clc
 27309 0000354B EB05                    	jmp	short newarg_exit
 27310                                  
 27311                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27312                                  ; PCDOS 7.1 COMMAND.COM
 27313                                  %if 0
 27314                                  to_many_args:
 27315                                  	mov	ax,1
 27316                                  	jmp	short newarg_error
 27317                                  buf_oflow:
 27318                                  	mov	ax,2
 27319                                  %else
 27320                                  ; 27/07/2024 - Retro DOS v5.0 COMMAND.COM
 27321                                  ;buf_oflow:
 27322                                  ;	; 27/07/2024
 27323                                  ;	; PCDOS 7.1 COMMAND.COM
 27324                                  ;	sub	di,cx
 27325                                  ;	;mov	cx,ARG_ARGBUF+7Fh
 27326                                  ;	mov	cx,ARG+ARG_UNIT.argbuf+ARGBLEN-1
 27327                                  ;	sub	cx,di
 27328                                  ;	jmp     short newarg_@
 27329                                  to_many_args:
 27330 0000354D B80100                  	mov	ax,1
 27331                                  %endif
 27332                                  
 27333                                  newarg_error:
 27334 00003550 9D                      	popf
 27335 00003551 F9                      	stc
 27336                                  newarg_exit:
 27337 00003552 5E                      	pop	si
 27338 00003553 5F                      	pop	di
 27339 00003554 5A                      	pop	dx
 27340 00003555 59                      	pop	cx
 27341 00003556 5B                      	pop	bx
 27342 00003557 C3                      	retn
 27343                                  
 27344                                  ; =============== S U B	R O U T	I N E =======================================
 27345                                  
 27346                                  ; ARG_SWITCH decides if an argument might really be a switch. In the
 27347                                  ; event that it is, and we can recognize
 27348                                  ;
 27349                                  ; ENTRY:
 27350                                  ;   As in <newarg>.
 27351                                  ; EXIT:
 27352                                  ;   CF	    --	    clear (wasn't a switch); set (was a switch)
 27353                                  ; NOTE(S):
 27354                                  ;   *	The mechanism mapping a switch into a bit-value depends entirely
 27355                                  ;	on the order of definition in the <switch_list> variable and the
 27356                                  ;	values chosen to define the bits in CMDT:COMEQU.ASM. Change either
 27357                                  ;	<switch_list> or the definitions in CMDT:COMEQU.ASM -- and rewrite
 27358                                  ;	this mechanism. This code taken from CMDT:TCODE.ASM.
 27359                                  ;   *	The <switch_list> declared below is redundant to one declared in
 27360                                  ;	TDATA.ASM, and used in TCODE.ASM.
 27361                                  ;   *	An ugly routine.
 27362                                  
 27363                                  	; 01/03/2023 - Retro DOS v4.0 COMMAND.COM
 27364                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27365                                  arg_switch:
 27366 00003558 50                      	push	ax
 27367 00003559 53                      	push	bx
 27368 0000355A 51                      	push	cx
 27369 0000355B 57                      	push	di
 27370 0000355C 9C                      	pushf
 27371 0000355D F6C701                  	test	bh,1 ; sw_flag		; is it a switch? (preserve flag word)
 27372 00003560 741C                    	jz	short arg_no_switch0
 27373 00003562 833E[75A4]FF            	cmp	word [LASTARG],-1 	; have we encountered any REAL args yet?
 27374 00003567 741B                    	je	short arg_no_switch1 	; no, so leading switches don't matter
 27375 00003569 8B1E[75A4]              	mov	bx,[LASTARG]		; yes, add switch info to last REAL arg
 27376                                  	;mov	ax,offset TRANGROUP:arg.argv
 27377                                  	;mov	ax,ARG_ARGV
 27378 0000356D B8[AF9F]                	mov	ax,ARG+ARG_UNIT.argv  ; ARG+0
 27379 00003570 E81800                  	call	argv_calc
 27380                                  	;or	[BX].argsw_word,BP
 27381                                  	;or	[bx+7],bp
 27382 00003573 096F07                  	or	[bx+ARGV_ELE.argsw_word],bp
 27383                                  	;or	arg.argswinfo,BP
 27384                                  	;or	[ARG_ARGSWINFO],bp
 27385 00003576 092E[71A2]              	or	[ARG+ARG_UNIT.argswinfo],bp
 27386                                  arg_yes_switch:
 27387 0000357A 9D                      	popf
 27388 0000357B F9                      	stc
 27389 0000357C EB08                    	jmp	short arg_switch_exit
 27390                                  
 27391                                  arg_no_switch0:
 27392                                  	;mov	ax,[ARG_ARGVCNT]
 27393 0000357E A1[6FA2]                	mov	ax,[ARG+ARG_UNIT.argvcnt]
 27394 00003581 A3[75A4]                	mov	[LASTARG],ax
 27395                                  arg_no_switch1:
 27396 00003584 9D                      	popf
 27397 00003585 F8                      	clc
 27398                                  arg_switch_exit:
 27399 00003586 5F                      	pop	di
 27400 00003587 59                      	pop	cx
 27401 00003588 5B                      	pop	bx
 27402 00003589 58                      	pop	ax
 27403 0000358A C3                      	retn
 27404                                  
 27405                                  ; =============== S U B	R O U T	I N E =======================================
 27406                                  
 27407                                  ; ARGV_CALC maps an array index into a byte-offset from the base of
 27408                                  ; the supplied array.  Method used for computing the address is:
 27409                                  ;	Array Index * Array Elt Size + Base Addr = Elt Addr
 27410                                  ; ENTRY:
 27411                                  ;   AX	    --	    base of array
 27412                                  ;   BX	    --	    array index
 27413                                  ; EXIT:
 27414                                  ;   BX	    --	    byte offset
 27415                                  
 27416                                  	; 01/03/2023 - Retro DOS v4.0 COMMAND.COM
 27417                                  argv_calc:
 27418 0000358B 50                      	push	ax		; Save base
 27419 0000358C 88D8                    	mov	al,bl		; al = array index
 27420                                  	;mov	bl,11
 27421 0000358E B30B                    	mov	bl,ARGV_ELE.SIZE ; bl = size of an argv element
 27422 00003590 F6E3                    	mul	bl		; ax = base offset
 27423 00003592 5B                      	pop	bx		; Get base
 27424 00003593 01D8                    	add	ax,bx		; Add in base offset
 27425 00003595 93                      	xchg	ax,bx		; Restore ax and put byte offset in bx
 27426 00003596 C3                      	retn
 27427                                  
 27428                                  ; ---------------------------------------------------------------------------
 27429                                  	
 27430                                  	;db 0Ah dup(0)
 27431                                  	;times 10 db 0
 27432                                  
 27433 00003597 90<rep 9h>              align 16
 27434                                  
 27435                                  ;============================================================================
 27436                                  ; PATH1.ASM, MSDOS 6.0, 1991
 27437                                  ;============================================================================
 27438                                  ; 03/10/2018 - Retro DOS v3.0
 27439                                  
 27440                                  ;----------------------------------------------------------------------------
 27441                                  ;    PATH.ASM contains the routines to perform pathname incovation. Path and
 27442                                  ;    Parse share a temporary buffer and argv[] definitions. <Path_Search>,
 27443                                  ;    given a pathname, attempts to find a corresponding executable or batch
 27444                                  ;    file on disk. Directories specified in the user's search path will be
 27445                                  ;    searched for a matching file, if a match is not found in the current
 27446                                  ;    directory and if the pathname is actually only an MSDOS filename.
 27447                                  ;    <Path_Search> assumes that the parsed command name can be found in
 27448                                  ;    argv[0] -- in other words, <Parseline> should be executed prior to
 27449                                  ;    <Path_Search>. Alternatively, the command name and appropriate
 27450                                  ;    information could be placed in argv[0], or <Path_Search> could be
 27451                                  ;    (easily) modified to make no assumptions about where its input is found.
 27452                                  ;    Please find enclosed yet another important routine, <Save_Args>, which
 27453                                  ;    places the entire arg/argv[]/argbuf structure on a piece of newly
 27454                                  ;    allocated memory. This is handy for for-loop processing, and anything
 27455                                  ;    else that wants to save the whole shebang and then process other command
 27456                                  ;    lines.
 27457                                  ;
 27458                                  ; Alan L, OS/MSDOS				    August 15, 1983
 27459                                  ;
 27460                                  ; ENTRY:
 27461                                  ;   <Path_Search>:	    argv[0].
 27462                                  ;   <Save_Args>:	    bytes to allocate in addition to arg structure
 27463                                  ; EXIT:
 27464                                  ;   <Path_Search>:	    success flag, best pathname match in EXECPATH.
 27465                                  ;   <Save_Args>:	    success flag, segment address of new memory
 27466                                  ; NOTE(S):
 27467                                  ;   *	<Argv_calc> handily turns an array index into an absolute pointer.
 27468                                  ;	The computation depends on the size of an argv[] element (arg_ele).
 27469                                  ;   *	<Parseline> calls <cparse> for chunks of the command line. <Cparse>
 27470                                  ;	does not function as specified; see <Parseline> for more details.
 27471                                  ;   *	<Parseline> now knows about the flags the internals of COMMAND.COM
 27472                                  ;	need to know about. This extra information is stored in a switch_flag
 27473                                  ;	word with each command-line argument; the switches themselves will not
 27474                                  ;	appear in the resulting arg structure.
 27475                                  ;   *	With the exception of CARRY, flags are generally preserved across calls.
 27476                                  ;----------------------------------------------------------------------------
 27477                                  
 27478                                  ; =============== S U B	R O U T	I N E =======================================
 27479                                  
 27480                                  ; PATH_SEARCH tries to find the file it's given, somewhere. An initial value
 27481                                  ; of *argv[0].argstartel == 0 implies that there is no command (empty line
 27482                                  ; or 'd:' or 'd:/'). This check is done in strip; otherwise, strip formats
 27483                                  ; the filename/pathname into tpbuf. Search(tpbuf) is executed to see if we
 27484                                  ; have a match, either in the current working directory if we were handed
 27485                                  ; a filename, or in the specified directory, given a pathname. If this call
 27486                                  ; fails, and we were given a pathname, then Path_Search fails. Otherwise,
 27487                                  ; Path_Crunch is repeatedly invoked on tpbuf[STARTEL] (if there's a drive
 27488                                  ; prefix, we want to skip it) for each pathstring in userpath. Success on
 27489                                  ; either the first invocation of search or on one of the succeeding calls
 27490                                  ; sets up the appropriate information for copying the successful pathname
 27491                                  ; prefix (if any) into the result buffer, followed by the successful filename
 27492                                  ; match (from [search_best_buf]). The result is returned in in EXECPATH.
 27493                                  ;
 27494                                  ; ENTRY:
 27495                                  ;   argv[0]		--	command name and associated information
 27496                                  ; EXIT:
 27497                                  ;   AX			--	non-zero indicates type of file found
 27498                                  ;   EXECPATH		--	successful pathname (AX non-zero)
 27499                                  ; NOTE(S):
 27500                                  ;   1)	Uses the temporary buffer, tpbuf, from the parse routines.
 27501                                  ;   2)	Some files are more equal than others.	See search: for rankings.
 27502                                  ;   3)	Path_Search terminates as soon as a call to search succeeds, even
 27503                                  ;	if search returns an .exe or .bat.
 27504                                  ;   5)	Clobbers dma address.
 27505                                  
 27506                                  ;PBUFLEN 	EQU	128		; length of EXECPATH
 27507                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 27508                                  PBUFLEN 	EQU	256
 27509                                  PATH_SEP_CHAR	EQU	';'
 27510                                  
 27511                                  ;parseflags RECORD special_delim:1, unused:4, path_sep:1, wildcard:1, sw_flag:1
 27512                                  
 27513                                  	;special_delim equ 128
 27514                                  	;path_sep equ 4
 27515                                  	;wildcard equ 2
 27516                                  	;sw_flag  equ 1
 27517                                  
 27518                                  ;----------------------------------------------------------------------------
 27519                                  
 27520                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2510h
 27521                                  
 27522                                  ; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27523                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 32D1h
 27524                                  
 27525                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27526                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 387Bh
 27527                                  
 27528                                  ; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 27529                                  ; PCDOS 7.1 - COMMAND.COM, transient portion/segment offset 372Fh
 27530                                  
 27531                                  path_search:
 27532 000035A0 53                      	push	bx
 27533 000035A1 51                      	push	cx
 27534 000035A2 52                      	push	dx		; could use a "stack 'em" instruction
 27535 000035A3 56                      	push	si
 27536 000035A4 57                      	push	di
 27537 000035A5 55                      	push	bp
 27538 000035A6 9C                      	pushf
 27539                                  
 27540                                  	;test	ds:arg.argv[0].argflags, (MASK wildcard) + (MASK sw_flag)
 27541                                  	;test	byte [ARGV0_ARG_FLAGS],3
 27542 000035A7 F606[B19F]03            	test	byte [ARG+ARGV_ELE.argflags],3 ; wildcard+sw_flag
 27543 000035AC 7403                    	jz	short path_search_ok
 27544                                  path_failure_jmp:
 27545 000035AE E9C100                  	jmp	path_failure	; ambiguous commands not allowed
 27546                                  
 27547                                  path_search_ok:
 27548 000035B1 E85201                  	call	STORE_PCHAR	; figure out the pathname separator
 27549 000035B4 BA[79A4]                	mov	dx,FBUF		; clobber old dma value with
 27550 000035B7 B8001A                  	mov	ax,Set_DMA*256 ; 1A00h ; a pointer to our dma buffer
 27551 000035BA CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 27552                                  			; DS:DX	-> disk	transfer buffer
 27553 000035BC 06                      	push	es
 27554 000035BD E8EDF0                  	call	find_path	; get a handle (ES:DI) on user path
 27555 000035C0 8C06[A4A4]              	mov	[pathinfo+0],es	; and squirrel it away
 27556 000035C4 893E[A6A4]              	mov	[pathinfo+2],di	; "old" pathstring pointer
 27557 000035C8 893E[A8A4]              	mov	[pathinfo+4],di	; "new" pathstring pointer
 27558 000035CC 07                      	pop	es
 27559                                  	
 27560                                  	;mov	bx,PBUFLEN ; 128 ; copy/format argv[0] into temp buffer
 27561                                  	; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 27562                                  	;mov	bx,256
 27563 000035CD BB0001                  	mov	bx,PBUFLEN ; 256 ; copy/format argv[0] into temp buffer
 27564 000035D0 BE[7B9B]                	mov	si,EXECPATH
 27565 000035D3 E88002                  	call	STRIP
 27566 000035D6 72D6                    	jc	short path_failure_jmp ; if possible, of course
 27567                                  		
 27568 000035D8 89F2                    	mov	dx,si		; search (EXECPATH, error_message)
 27569 000035DA C706[F9A4][6290]        	mov	word [search_error],baddrv_ptr
 27570 000035E0 E89F01                  	call	PSEARCH		; must do at least one search
 27571 000035E3 09C0                    	or	ax,ax		; find anything?
 27572 000035E5 7469                    	jz	short path_noinit
 27573                                  				; failure ... search farther
 27574 000035E7 89C5                    	mov	bp,ax		; success... save filetype code
 27575 000035E9 BF[7B9B]                	mov	di,EXECPATH
 27576                                  	;mov	si,ds:arg.argv[0].argpointer
 27577                                  	;mov	si,[ARG_ARGV]
 27578 000035EC 8B36[AF9F]              	mov	si,[ARG+ARGV_ELE.argpointer]
 27579                                  	;mov	cx,ds:arg.argv[0].argstartel
 27580                                  	;mov	cx,[ARGV0_ARGSTARTEL]
 27581 000035F0 8B0E[B29F]              	mov	cx,[ARG+ARGV_ELE.argstartel]
 27582 000035F4 29F1                    	sub	cx,si		; compute prefix bytes to copy
 27583                                  
 27584                                  ; We have the number of bytes in the prefix (up to the final component).
 27585                                  ; We need to form the complete pathname including leading drive and current
 27586                                  ; directory.
 27587                                  ;
 27588                                  ; Is there a drive letter present?
 27589                                  
 27590 000035F6 B43A                    	mov	ah,':'
 27591 000035F8 83F902                  	cmp	cx,2		; room for drive letter?
 27592 000035FB 7205                    	jb	short adddrive	; no, stick it in
 27593 000035FD 386401                  	cmp	[si+1],	ah	; colon present?
 27594 00003600 7408                    	je	short movedrive	; yes, just move it
 27595                                  adddrive:
 27596 00003602 A0[679C]                	mov	al,[CURDRV]	; get current drive
 27597 00003605 0441                    	add	al,'A'		; convert to uppercase letter
 27598 00003607 AB                      	stosw			; store d:
 27599 00003608 EB05                    	jmp	short checkpath
 27600                                  
 27601                                  movedrive:
 27602 0000360A AD                      	lodsw			; move d:
 27603 0000360B AB                      	stosw
 27604 0000360C 83E902                  	sub	cx,2		; 2 bytes less to move
 27605                                  checkpath:
 27606 0000360F 0C20                    	or	al,20h
 27607 00003611 88C2                    	mov	dl,al
 27608                                  	;sub	dl,60h
 27609 00003613 80EA60                  	sub	dl,'a'-1	; convert to 1-based for current dir
 27610                                  
 27611                                  ; Stick in beginning path char
 27612                                  
 27613 00003616 A0[AAA4]                	mov	al,[psep_char]
 27614 00003619 AA                      	stosb
 27615                                  
 27616                                  ; Is there a leading /? If so, then no current dir copy is necessary.
 27617                                  ; Otherwise, get current dir for DL.
 27618                                  
 27619 0000361A 83F901                  	cmp	cx,1		; is there room for path char?
 27620 0000361D 720A                    	jb	short addpath	; no, go add path
 27621 0000361F AC                      	lodsb
 27622 00003620 49                      	dec	cx
 27623 00003621 3A06[AAA4]              	cmp	al,[psep_char]	; is there a path separator?
 27624 00003625 741C                    	je	short movepath	; yes, go move remainder of path
 27625 00003627 41                      	inc	cx
 27626 00003628 4E                      	dec	si		; undo the lodsb
 27627                                  addpath:
 27628 00003629 56                      	push	si
 27629 0000362A 89FE                    	mov	si,di		; remainder of buffer
 27630 0000362C B80047                  	mov	ax,Current_Dir*256 ; 4700h
 27631 0000362F CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 27632                                  			; DL = drive (0=default,1=A,etc.)
 27633                                  			; DS:SI	points to 64-byte buffer area
 27634                                  
 27635                                  ; The previous current dir will succeed a previous find_first already worked.
 27636                                  ;
 27637                                  ; Find end of string.
 27638                                  
 27639 00003631 89F7                    	mov	di,si
 27640 00003633 5E                      	pop	si
 27641 00003634 A0[AAA4]                	mov	al,[psep_char]
 27642 00003637 803D00                  	cmp	byte [di],0	; root (empty dir string)?
 27643 0000363A 7407                    	jz	short movepath	; yes, no need for path char
 27644                                  scanend:
 27645                                  	;cmp	byte [di],0	; end of string?
 27646                                  	;jz	short foundend
 27647                                  	;inc	di
 27648                                  	;jmp	short scanend
 27649                                  	; 18/03/2023 - Retro DOS v4.0 COMMAND.COM
 27650 0000363C 47                      	inc	di
 27651 0000363D 803D00                  	cmp	byte [di],0
 27652 00003640 75FA                    	jnz	short scanend
 27653                                  
 27654                                  ; Stick in a trailing path char.
 27655                                  
 27656                                  foundend:
 27657 00003642 AA                      	stosb
 27658                                  
 27659                                  ; Move remaining part of path. Skip leading path char if present.
 27660                                  
 27661                                  movepath:
 27662 00003643 3804                    	cmp	[si],al		; first char a path char?
 27663 00003645 7502                    	jne	short copypath
 27664                                  	; 26/04/2023
 27665 00003647 46                      	inc	si		; move past leading char
 27666 00003648 49                      	dec	cx		; drop from count
 27667                                  copypath:
 27668 00003649 E302                    	jcxz	_copydone	; no chars to move!
 27669 0000364B F3A4                    	rep	movsb
 27670                                  _copydone:
 27671 0000364D E9A100                  	jmp	path_success
 27672                                  				; run off and form complete pathname
 27673                                  path_noinit:
 27674                                  	;test	ds:arg.argv[0].argflags, MASK path_sep
 27675                                  	;test	byte [ARGV0_ARG_FLAGS],4
 27676 00003650 F606[B19F]04            	test	byte [ARG+ARGV_ELE.argflags],4 ; path_sep
 27677 00003655 751B                    	jnz	short path_failure
 27678                                  				; complete pathname specified ==> fail
 27679                                  	;mov	bh,';'
 27680 00003657 B73B                    	mov	bh,PATH_SEP_CHAR
 27681                                  				; semicolon terminates pathstring
 27682                                  	;mov	dx,ds:arg.argv[0].argstartel
 27683                                  				; this is where the last element starts
 27684                                  	;mov	dx,[ARGV0_ARGSTARTEL]
 27685 00003659 8B16[B29F]              	mov	dx,[ARG+ARGV_ELE.argstartel]
 27686                                  	;sub	dx,ds:arg.argv[0].argpointer
 27687                                  				; form pointer into EXECPATH,
 27688                                  	;sub	dx,[ARG_ARGV]
 27689 0000365D 2B16[AF9F]              	sub	dx,[ARG+ARGV_ELE.argpointer]
 27690 00003661 81C2[7B9B]              	add	dx,EXECPATH	; skipping over drive spec, if any
 27691                                  path_loop:
 27692 00003665 E8AD00                  	call	path_crunch	; pcrunch (EXECPATH, pathinfo)
 27693 00003668 89C5                    	mov	bp,ax		; save filetype code
 27694 0000366A 9F                      	lahf			; save flags, just in case
 27695 0000366B 09ED                    	or	bp,bp		; did path_crunch find anything?
 27696 0000366D 7508                    	jnz	short path_found
 27697 0000366F 9E                      	sahf			; see? needed those flags, after all!
 27698 00003670 73F3                    	jnc	short path_loop	; is there anything left to the path?
 27699                                  path_failure:
 27700 00003672 31C0                    	xor	ax,ax
 27701 00003674 E98700                  	jmp	path_exit
 27702                                  
 27703                                  path_found:				; pathinfo[] points to winner
 27704 00003677 BF[7B9B]                	mov	di,EXECPATH
 27705                                  	;mov	cx,pathinfo[4]
 27706 0000367A 8B0E[A8A4]              	mov	cx,[pathinfo+4]	; "new" pointer -- end of string
 27707                                  	;mov	si,pathinfo[2]
 27708 0000367E 8B36[A6A4]              	mov	si,[pathinfo+2]	; "old" pointer -- beginning of string
 27709                                  
 27710                                  ;	BAS Nov 20/84
 27711                                  ;   Look at the pathname and expand . and .. if they are the first element
 27712                                  ;   in the pathname (after the drive letter)
 27713                                  
 27714 00003682 06                      	push	es
 27715                                  	;push	pathinfo[0]
 27716 00003683 FF36[A4A4]              	push	word [pathinfo+0]
 27717 00003687 07                      	pop	es
 27718                                  ;SR;
 27719                                  ; Oops! Gets fooled if path= \;..
 27720                                  ; We should also check if a drive letter is really present
 27721                                  ;
 27722 00003688 26807C022E              	cmp	byte [es:si+2],'.'
 27723                                  				; Look for Current dir at start of path
 27724 0000368D 7534                    	jne	short path_cpy
 27725                                  
 27726                                  	; 18/03/2023
 27727                                  	; MSDOS 6.0
 27728 0000368F 26807C013A              	cmp	byte [es:si+1],':'
 27729                                  				; does path have drive letter?
 27730 00003694 752D                    	jne	short path_cpy	; no, copy the path string
 27731                                  
 27732 00003696 51                      	push	cx		; Save pointer to end of string
 27733                                  	;mov	al,[es:si]
 27734                                  	;mov	[di],al		; Copy drive letter, :, and root char
 27735                                  	;mov	al,[es:si+1]	; to EXECPATH
 27736                                  	;mov	[di+1],al
 27737                                  	; 05/05/2023
 27738 00003697 268B04                  	mov	ax,[es:si]
 27739 0000369A 8905                    	mov	[di],ax
 27740 0000369C A0[AAA4]                	mov	al,[psep_char]
 27741 0000369F 884502                  	mov	[di+2],	al
 27742 000036A2 56                      	push	si		; Save pointer to begining of string
 27743 000036A3 268A14                  	mov	dl,[es:si]	; Convert device letter for cur dir
 27744 000036A6 80CA20                  	or	dl,20h
 27745                                  	;sub	dl,60h
 27746 000036A9 80EA60                  	sub	dl,'a'-1
 27747 000036AC 89FE                    	mov	si,di		; pointer to EXECPATH
 27748 000036AE 83C603                  	add	si,3		; Don't wipe out drive and root info
 27749 000036B1 B80047                  	mov	ax,Current_Dir*256 ; 4700h
 27750 000036B4 CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 27751                                  			; DL = drive (0=default,1=A,etc.)
 27752                                  			; DS:SI	points to 64-byte buffer area
 27753 000036B6 E8E4F9                  	call	dstrlen		; Determine length of present info
 27754 000036B9 01CE                    	add	si,cx		; Don't copy over drive and root info
 27755 000036BB 4E                      	dec	si
 27756 000036BC 89F7                    	mov	di,si		; Point to end of target string
 27757 000036BE 5E                      	pop	si		; Restore pointer to begining of string
 27758 000036BF 83C603                  	add	si,3		; Point past drive letter, :, .
 27759 000036C2 59                      	pop	cx		; Restore pointer to end of string
 27760                                  path_cpy:
 27761 000036C3 07                      	pop	es
 27762 000036C4 29F1                    	sub	cx,si		; yields character count
 27763 000036C6 1E                      	push	ds		; time to switch segments
 27764 000036C7 FF36[A4A4]              	push	word [pathinfo+0]
 27765                                  				; string lives in this segment
 27766 000036CB 1F                      	pop	ds
 27767 000036CC FC                      	cld
 27768                                  
 27769                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27770                                  	; MSDOS 5.0 (& MSDOS 5.0)
 27771                                  	;;rep	movsb ; 3/3/KK	; copy the prefix path into EXECPATH
 27772                                  kloop:
 27773 000036CD AC                      	lodsb			;AN000;  3/3/KK
 27774 000036CE AA                      	stosb			;AN000;  3/3/KK
 27775 000036CF E88DF0                  	call	testkanj	;AN000;  3/3/KK
 27776 000036D2 7410                    	jz	short _notkanj1	;AN000;  3/3/KK
 27777 000036D4 49                      	dec	cx		;AN000;  3/3/KK
 27778 000036D5 E307                    	jcxz	popdone		;AN000;  Ignore boundary error 3/3/KK
 27779 000036D7 A4                      	movsb			;AN000;  3/3/KK
 27780 000036D8 49                      	dec	cx		;AN000;  3/3/KK
 27781 000036D9 83F901                  	cmp	cx,1		;AN000;  One char (the terminator) left ? 3/3/KK
 27782 000036DC 77EF                    	ja	short kloop	;AN000;  no.  3/3/KK
 27783                                  popdone:			;AN000;  3/3/KK
 27784 000036DE 1F                      	pop	ds		;AN000;  Yes ES:DI->terminator, last char is 3/3/KK
 27785 000036DF A0[AAA4]                	mov	al,[psep_char]	;AN000;  KANJI 3/3/KK
 27786 000036E2 EB0C                    	jmp	short path_store
 27787                                  				;AN000;  3/3/KK
 27788                                  _notkanj1:
 27789                                  	; 26/04/2023
 27790 000036E4 E2E7                    	loop	kloop
 27791 000036E6 1F                      	pop	ds		; return to our segment
 27792 000036E7 4F                      	dec	di		; overwrite terminator
 27793 000036E8 A0[AAA4]                	mov	al,[psep_char]	; with a pathname separator
 27794 000036EB 3A45FF                  	cmp	al,[di-1]
 27795 000036EE 7401                    	je	short path_success
 27796                                  path_store:
 27797 000036F0 AA                      	stosb
 27798                                  path_success:
 27799 000036F1 BE[ACA4]                	mov	si,search_best_buf
 27800 000036F4 31C9                    	xor	cx,cx
 27801                                  path_succ_loop:
 27802 000036F6 AC                      	lodsb			; append winning filename to path
 27803 000036F7 AA                      	stosb			; (including terminating null)
 27804 000036F8 08C0                    	or	al,al
 27805 000036FA 75FA                    	jnz	short path_succ_loop
 27806 000036FC 89E8                    	mov	ax,bp		; retrieve filetype code
 27807                                  path_exit:
 27808 000036FE 9D                      	popf
 27809 000036FF 5D                      	pop	bp
 27810 00003700 5F                      	pop	di
 27811 00003701 5E                      	pop	si		; chill out...
 27812 00003702 5A                      	pop	dx
 27813 00003703 59                      	pop	cx
 27814 00003704 5B                      	pop	bx
 27815 00003705 C3                      	retn
 27816                                  
 27817                                  ; =============== S U B	R O U T	I N E =======================================
 27818                                  
 27819                                  ; STORE_PCHAR determines the pathname-element separator and squirrels
 27820                                  ; it away. In other words, must we say '/bin/ls' or '\bin\ls'?
 27821                                  ;
 27822                                  ; ENTRY:
 27823                                  ; EXIT:
 27824                                  ; NOTE(S):
 27825                                  ;   *	Uses <psep_char>, defined in <path_search>.
 27826                                  
 27827                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27828                                  STORE_PCHAR:
 27829 00003706 50                      	push	ax
 27830 00003707 B02F                    	mov	al,'/'		; is the pathname-element separator
 27831 00003709 E806F3                  	call	pathchrcmp	; a regular slash?
 27832 0000370C 7402                    	jz	short STORE_SLASH
 27833                                  				; if yes, remember slash
 27834 0000370E B05C                    	mov	al,'\'
 27835                                  	; 18/03/2023
 27836                                  	;mov	[psep_char],al	; otherwise, remember back-slash
 27837                                  	;pop	ax
 27838                                  	;retn
 27839                                  STORE_SLASH:
 27840 00003710 A2[AAA4]                	mov	[psep_char],al
 27841 00003713 58                      	pop	ax
 27842 00003714 C3                      	retn
 27843                                  
 27844                                  ; =============== S U B	R O U T	I N E =======================================
 27845                                  
 27846                                  ; PATH_CRUNCH takes a prefix from a prefix string, and a suffix from
 27847                                  ; EXECPATH, and smooshes them into tpbuf. The caller may supply an
 27848                                  ; additional separator to use for breaking up the path-string. Null is the
 27849                                  ; default. Once the user-string has been formed, search is invoked to see
 27850                                  ; what's out there.
 27851                                  ;
 27852                                  ; ENTRY:
 27853                                  ;   BH			--	additional terminator character
 27854                                  ;   SI			--	pointer into pathstring to be dissected
 27855                                  ;   DX			--	pointer to stripped filename
 27856                                  ; EXIT:
 27857                                  ;   AX			--	non-zero (file type), zero (nothing found)
 27858                                  ;   SI			--	moves along pathstring from call to call
 27859                                  ;   [search_best_buf]	--	name of best file (AX non-zero)
 27860                                  ;   [tpbuf]		--	clobbered
 27861                                  ; NOTE(S):
 27862                                  ;   *	Implicit in this code is the ability to specify when to search
 27863                                  ;	the current directory (if at all) through the PATH defined by
 27864                                  ;	the user, a la UNIX (e.g., PATH=;c:\bin;c:\etc searches the
 27865                                  ;	current directory before the bin and etc directories of drive c).
 27866                                  
 27867                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27868                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3454h
 27869                                  
 27870                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 27871                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:39FEh
 27872                                  
 27873                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 27874                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:38B2h
 27875                                  path_crunch:
 27876 00003715 53                      	push	bx
 27877 00003716 51                      	push	cx
 27878 00003717 52                      	push	dx
 27879 00003718 57                      	push	di
 27880 00003719 56                      	push	si
 27881                                  	;pushf	; ** ; 18/03/2023
 27882 0000371A E8E9FF                  	call	STORE_PCHAR	; figure out pathname separator
 27883 0000371D BF[F5A3]                	mov	di,TPBUF	; destination of concatenated string
 27884 00003720 8B36[A8A4]              	mov	si,[pathinfo+4]	; "new" pointer to start with
 27885 00003724 8936[A6A4]              	mov	[pathinfo+2],si	; becomes "old" pointer
 27886 00003728 1E                      	push	ds		; save old segment pointer
 27887 00003729 FF36[A4A4]              	push	word [pathinfo+0]
 27888                                  				; replace with pointer to userpath's
 27889 0000372D 1F                      	pop	ds		; segment
 27890                                  	; 26/04/2023
 27891 0000372E 30C9                    	xor	cl,cl		;AN000; clear flag for later use 3/3/KK
 27892                                  path_cr_copy:
 27893 00003730 AC                      	lodsb			; get a pathname byte
 27894 00003731 08C0                    	or	al,al		; check for terminator(s)
 27895 00003733 7414                    	jz	short path_seg	; null terminates segment & pathstring
 27896 00003735 38F8                    	cmp	al,bh
 27897 00003737 7410                    	je	short path_seg	; BH terminates a pathstring segment
 27898                                  	;
 27899                                  	; 18/03/2023
 27900                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 27901 00003739 E823F0                  	call	testkanj	;AN000; 3/3/KK
 27902 0000373C 7406                    	jz	short _notkanj2	;AN000; 3/3/KK
 27903 0000373E AA                      	stosb			;AN000; 3/3/KK
 27904 0000373F A4                      	movsb			;AN000; 3/3/KK
 27905 00003740 B101                    	mov	cl,1 ; *	;AN000; CL=1 means latest stored char is DBCS 3/3/KK
 27906 00003742 EBEC                    	jmp	short path_cr_copy
 27907                                  _notkanj2:
 27908 00003744 30C9                    	xor	cl,cl ; *	;AN000; CL=0 means latest stored char is SBCS 3/3/KK
 27909                                  	;
 27910 00003746 AA                      	stosb
 27911 00003747 EBE7                    	jmp	short path_cr_copy
 27912                                  
 27913                                  path_seg:
 27914 00003749 1F                      	pop	ds		; restore old data segment
 27915 0000374A 8936[A8A4]              	mov	[pathinfo+4],si	; save "new" pointer for next time
 27916 0000374E 88C3                    	mov	bl,al		; remember if we saw null or not...
 27917                                  				;;; REMOVE NEXT 3 LINES FOR CURDIR SPEC
 27918 00003750 31C0                    	xor	ax,ax		; in case nothing in pathstr...
 27919 00003752 81FF[F5A3]              	cmp	di,TPBUF	; was there really anything in pathstr?
 27920 00003756 7421                    	je	short path_cr_leave
 27921                                  				; if nothing was copied, pathstr empty
 27922                                  path_cr_look:
 27923 00003758 A0[AAA4]                	mov	al,[psep_char]	; form complete pathname
 27924                                  	;
 27925                                  	; 18/03/2023
 27926                                  	; MSDOS 6.0
 27927 0000375B 08C9                    	or	cl,cl ; *	;AN000; 3/3/KK
 27928 0000375D 7505                    	jnz	short path_cr_store
 27929                                  				;AN000; this is a trailing byte of ECS code 3/3/KK
 27930                                  	;
 27931 0000375F 3A45FF                  	cmp	al,[di-1]	; add pathname separator for suffix
 27932 00003762 7401                    	je	short path_cr_l1
 27933                                  path_cr_store:
 27934 00003764 AA                      	stosb
 27935                                  path_cr_l1:
 27936 00003765 89D6                    	mov	si,dx
 27937                                  path_cr_l2:
 27938 00003767 AC                      	lodsb			; tack the stripped filename onto
 27939 00003768 AA                      	stosb			; the end of the path, up to and
 27940 00003769 08C0                    	or	al,al		; including the terminating null
 27941 0000376B 75FA                    	jnz	short path_cr_l2
 27942 0000376D BA[F5A3]                	mov	dx,TPBUF	; and look for an appropriate file...
 27943 00003770 C706[F9A4][4891]        	mov	word [search_error],BADPMES_PTR
 27944                                  	;invoke search
 27945 00003776 E80900                  	call	PSEARCH		; results are in AX & search_best_buf
 27946                                  
 27947                                  	; 18/03/2023
 27948                                  ;path_cr_leave:
 27949                                  	;or	bl,bl		; did we finish off the pathstring?
 27950                                  	;jz	short path_cr_empty
 27951                                  	;			; null in BL means all gone...
 27952                                  	;popf	; **		; otherwise, plenty left
 27953                                  	;clc
 27954                                  	;jmp	short path_cr_exit
 27955                                  ;path_cr_empty:
 27956                                  	;popf	; **
 27957                                  	;stc
 27958                                  ;path_cr_exit:
 27959                                  
 27960                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 27961                                  path_cr_leave:
 27962                                  	;popf ; ** ; 18/03/2023
 27963 00003779 80FB01                  	cmp	bl,1	; if bl = 0 -> cf = 1 (path_cr_empty:)
 27964                                  
 27965                                  path_cr_exit:
 27966 0000377C 5E                      	pop	si
 27967 0000377D 5F                      	pop	di
 27968 0000377E 5A                      	pop	dx
 27969 0000377F 59                      	pop	cx
 27970 00003780 5B                      	pop	bx
 27971 00003781 C3                      	retn
 27972                                  
 27973                                  ;============================================================================
 27974                                  ; PATH2.ASM, MSDOS 6.0, 1991
 27975                                  ;============================================================================
 27976                                  ; 02/10/2018 - Retro DOS v3.0
 27977                                  
 27978                                  ;----------------------------------------------------------------------------
 27979                                  ;   SEARCH, when given a pathname, attempts to find a file with
 27980                                  ; one of the following extensions: .com, .exe, .bat (highest to
 27981                                  ; lowest priority). Where conflicts arise, the extension with
 27982                                  ; the highest priority is favored.
 27983                                  ; ENTRY:
 27984                                  ;   DX		--	pointer to null-terminated pathname
 27985                                  ;   fbuf	--	dma buffer for findfirst/next
 27986                                  ; EXIT:
 27987                                  ;   AX		--	8)  file found with .com extension
 27988                                  ;			4)  file found with .exe extension
 27989                                  ;			2)  file found with .bat extension
 27990                                  ;			0)  no such file to be found
 27991                                  ;   (if AX is non-zero:)
 27992                                  ;   [search_best]	identical to AX
 27993                                  ;   [search_best_buf]	null-terminated filename
 27994                                  ; NOTES:
 27995                                  ;   1) Requires caller to have allocated a dma buffer and executed a setdma.
 27996                                  ;---------------
 27997                                  ; CONSTANTS:
 27998                                  ;---------------
 27999                                  SEARCH_FILE_NOT_FOUND	EQU	0
 28000                                  SEARCH_COM		EQU	8
 28001                                  SEARCH_EXE		EQU	4
 28002                                  SEARCH_BAT		EQU	2
 28003                                  FNAME_LEN		EQU	8
 28004                                  FNAME_MAX_LEN		EQU	13
 28005                                  DOT			EQU	'.'
 28006                                  WILDCHAR		EQU	'?'
 28007                                  
 28008                                  
 28009                                  ; =============== S U B	R O U T	I N E =======================================
 28010                                  
 28011                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 26D6h
 28012                                  
 28013                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28014                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:34C9h
 28015                                  
 28016                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28017                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3A73h
 28018                                  
 28019                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 28020                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3927h
 28021                                  PSEARCH:
 28022 00003782 51                      	push	cx
 28023 00003783 52                      	push	dx
 28024 00003784 57                      	push	di
 28025 00003785 56                      	push	si
 28026                                  	;pushf	; ** ; 18/03/2023
 28027 00003786 52                      	push	dx		; check drivespec (save pname ptr)
 28028 00003787 89D7                    	mov	di,dx		; working copy of pathname
 28029 00003789 BE[B9A4]                	mov	si,search_curdir_buf
 28030 0000378C 31D2                    	xor	dx,dx		; zero means current drive
 28031 0000378E 807D013A                	cmp	byte [di+1],':'	; is there a drive spec?
 28032 00003792 7508                    	jne	short SEARCH_DIR_CHECK
 28033 00003794 8A15                    	mov	dl,[di]		; get the drive byte
 28034 00003796 80E2DF                  	and	dl,0DFh ; ~20h	; uppercase the sucker
 28035 00003799 80EA40                  	sub	dl,'@' ; 40h	; and convert to drive number
 28036                                  SEARCH_DIR_CHECK:
 28037 0000379C B80047                  	mov	ax,Current_Dir*256 ; 4700h
 28038 0000379F CD21                    	int	21h	; DOS -	2+ - GET CURRENT DIRECTORY
 28039                                  			; DL = drive (0=default,1=A,etc.)
 28040                                  			; DS:SI	points to 64-byte buffer area
 28041 000037A1 5A                      	pop	dx		; directory? If we can't we'll
 28042 000037A2 724C                    	jc	short SEARCH_INVALID_DRIVE
 28043                                  				; assume it's a bad drive...
 28044 000037A4 B91300                  	mov	cx,search_attr	; 13h
 28045                                  				; filetypes to search for
 28046 000037A7 B8004E                  	mov	ax,Find_First*256 ; 4E00h ; request first match, if any
 28047 000037AA CD21                    	int	21h	; DOS -	2+ - FIND FIRST	ASCIZ (FINDFIRST)
 28048                                  			; CX = search attributes
 28049                                  			; DS:DX	-> ASCIZ filespec
 28050                                  			; (drive,path, and wildcards allowed)
 28051 000037AC 7249                    	jc	short SEARCH_NO_FILE
 28052 000037AE C606[ABA4]00            	mov	byte [search_best],SEARCH_FILE_NOT_FOUND ; 0
 28053 000037B3 C606[ACA4]00            	mov	byte [search_best_buf],ANULL
 28054                                  				; 0 ; nothing's been found, yet
 28055                                  SEARCH_LOOP:
 28056 000037B8 E84300                  	call	SEARCH_FTYPE	; determine if .com, &c...
 28057 000037BB 3A06[ABA4]              	cmp	al,[search_best]
 28058                                  				; better than what we've found so far?
 28059 000037BF 7E13                    	jle	short SEARCH_NEXT
 28060                                  				; no, look for another
 28061 000037C1 A2[ABA4]                	mov	[search_best],al
 28062                                  				; found something... save its code
 28063                                  	;mov	si,offset TRANGROUP:fbuf.find_buf_pname
 28064                                  	;mov	si,FBUF_PNAME
 28065 000037C4 BE[97A4]                	mov	si,FBUF+FIND_BUF.PNAME ; FBUF+30
 28066 000037C7 BF[ACA4]                	mov	di,search_best_buf
 28067 000037CA B90D00                  	mov	cx,FNAME_MAX_LEN ; 13
 28068 000037CD FC                      	cld
 28069 000037CE F3A4                    	rep	movsb		; save complete pathname representation
 28070 000037D0 3C08                    	cmp	al,SEARCH_COM	; 8
 28071                                  				; have we found the best of all?
 28072 000037D2 740A                    	je	short SEARCH_DONE
 28073                                  SEARCH_NEXT:			; keep on looking
 28074 000037D4 B91300                  	mov	cx,search_attr ; 13h
 28075 000037D7 B8004F                  	mov	ax,Find_Next*256 ; 4F00h ; next match
 28076 000037DA CD21                    	int	21h	; DOS -	2+ - FIND NEXT ASCIZ (FINDNEXT)
 28077                                  			; [DTA]	= data block from
 28078                                  			; last AH = 4Eh/4Fh call
 28079 000037DC 73DA                    	jnc	short SEARCH_LOOP
 28080                                  SEARCH_DONE:			; it's all over with...
 28081 000037DE A0[ABA4]                	mov	al,[search_best]
 28082                                  				; pick best to return with
 28083                                  	; 18/03/2023
 28084                                  	; MSDOS 6.0
 28085 000037E1 803E[659F]01            	cmp	byte [ext_entered],1
 28086                                  				;AN005; Did user request a specific ext?
 28087 000037E6 7411                    	je	short SEARCH_EXIT
 28088                                  				;AN005; no - exit
 28089 000037E8 A0[659F]                	mov	al,[ext_entered]
 28090                                  				;AN005; yes - get the real file type back
 28091 000037EB A2[ABA4]                	mov	[search_best],al
 28092                                  				;AN005; save the real file type
 28093                                  	;
 28094 000037EE EB09                    	jmp	short SEARCH_EXIT
 28095                                  
 28096                                  SEARCH_INVALID_DRIVE:		; Tell the user path/drive
 28097 000037F0 8B16[F9A4]              	mov	dx,[search_error]
 28098                                  				; appropriate error message
 28099 000037F4 E8261C                  	call	std_printf	; and pretend no file found
 28100                                  
 28101                                  SEARCH_NO_FILE:			; couldn't find a match
 28102                                  	;mov	ax,SEARCH_FILE_NOT_FOUND ; 0
 28103                                  	; 18/03/2023
 28104 000037F7 31C0                    	xor	ax,ax
 28105                                  SEARCH_EXIT:
 28106                                  	;popf	; ** ; 18/03/2023
 28107 000037F9 5E                      	pop	si
 28108 000037FA 5F                      	pop	di
 28109 000037FB 5A                      	pop	dx
 28110 000037FC 59                      	pop	cx
 28111 000037FD C3                      	retn
 28112                                  
 28113                                  ; =============== S U B	R O U T	I N E =======================================
 28114                                  
 28115                                  ; SEARCH_FTYPE determines the type of a file by examining its extension.
 28116                                  ;
 28117                                  ; ENTRY:
 28118                                  ;   fbuf    --	dma buffer containing filename
 28119                                  ; EXIT:
 28120                                  ;   AX	    --	file code, as given in search header
 28121                                  ; NOTE(S):
 28122                                  ;   *	Implicit assumption that NULL == search_file_not_found
 28123                                  
 28124                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28125                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28126                                  	; 04/08/2024 - Retro DOS v5.0 COMMAND.COM
 28127                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:3927h
 28128                                  SEARCH_FTYPE:
 28129 000037FE 57                      	push	di
 28130 000037FF 56                      	push	si
 28131                                  	;mov	ax,ANULL ; 0	; find the end of the filename
 28132                                  	; 18/02/2023
 28133 00003800 31C0                    	xor	ax,ax ; ax = 0		
 28134                                  	;mov	di,offset TRANGROUP:fbuf.find_buf_pname
 28135                                  	;mov	di,FBUF_PNAME
 28136 00003802 BF[97A4]                	mov	di,FBUF+FIND_BUF.PNAME ; FBUF+1Eh
 28137 00003805 B90D00                  	mov	cx,FNAME_MAX_LEN ; 13
 28138 00003808 FC                      	cld
 28139 00003809 F2AE                    	repnz	scasb		; search for the terminating null
 28140 0000380B 7535                    	jnz	short FTYPE_EXIT
 28141                                  				; weird... no null byte at end
 28142 0000380D 83EF05                  	sub	di,5		; . + E + X + T + NULL
 28143                                  
 28144                                  	; Compare .COM
 28145                                  
 28146 00003810 BE[B895]                	mov	si,comext ; ".COM"
 28147 00003813 89F8                    	mov	ax,di
 28148 00003815 A7                      	cmpsw
 28149 00003816 7508                    	jnz	short FTYPE_EXE
 28150 00003818 A7                      	cmpsw
 28151 00003819 7505                    	jnz	short FTYPE_EXE
 28152                                  	;mov	ax,8
 28153 0000381B B80800                  	mov	ax,SEARCH_COM	; success!
 28154 0000381E EB22                    	jmp	short FTYPE_EXIT
 28155                                  
 28156                                  	; Compare .EXE
 28157                                  FTYPE_EXE:			; still looking... now for '.exe'
 28158 00003820 89C7                    	mov	di,ax
 28159 00003822 BE[BC95]                	mov	si,exeext ; ".EXE"
 28160 00003825 A7                      	cmpsw
 28161 00003826 7508                    	jnz	short FTYPE_BAT
 28162 00003828 A7                      	cmpsw
 28163 00003829 7505                    	jnz	short FTYPE_BAT
 28164                                  	;mov	ax,4
 28165 0000382B B80400                  	mov	ax,SEARCH_EXE	; success!
 28166 0000382E EB12                    	jmp	short FTYPE_EXIT
 28167                                  
 28168                                  	; Compare .BAT
 28169                                  FTYPE_BAT:			; still looking... now for '.bat'
 28170 00003830 89C7                    	mov	di,ax
 28171 00003832 BE[C095]                	mov	si,batext ; ".BAT"
 28172 00003835 A7                      	cmpsw
 28173 00003836 7508                    	jnz	short FTYPE_FAIL
 28174 00003838 A7                      	cmpsw
 28175 00003839 7505                    	jnz	short FTYPE_FAIL
 28176                                  	;mov	ax,2
 28177 0000383B B80200                  	mov	ax,SEARCH_BAT	; success!
 28178 0000383E EB02                    	jmp	short FTYPE_EXIT
 28179                                  
 28180                                  FTYPE_FAIL:			; file doesn't match what we need
 28181                                  	;mov	ax,ANULL ; 0
 28182                                  	; 18/03/2023
 28183 00003840 29C0                    	sub	ax,ax  ; ax = 0
 28184                                  FTYPE_EXIT:
 28185                                  	; 18/03/2023
 28186                                  	; MSDOS 6.0
 28187 00003842 803E[659F]01            	cmp	byte [ext_entered],1
 28188                                  				;AN005; was an extension entered?
 28189 00003847 740A                    	jz	short FTYPE_DONE
 28190                                  				;AN005; no - exit
 28191                                  	;cmp	ax,ANULL	;AN005; was any match found
 28192 00003849 21C0                    	and	ax,ax  ; ax = 0 ?
 28193 0000384B 7406                    	jz	short FTYPE_DONE
 28194                                  				;AN005; no - exit
 28195 0000384D A2[659F]                	mov	[ext_entered],al
 28196                                  				;AN005; save the match type found
 28197 00003850 B80800                  	mov	ax,SEARCH_COM	;AN005; send back best was found to stop search
 28198                                  FTYPE_DONE:
 28199 00003853 5E                      	pop	si
 28200 00003854 5F                      	pop	di
 28201 00003855 C3                      	retn
 28202                                  
 28203                                  ; =============== S U B	R O U T	I N E =======================================
 28204                                  
 28205                                  ; STRIP copies the source string (argv[0]) into the destination buffer,
 28206                                  ; replacing any extension with wildcards.
 28207                                  ;
 28208                                  ; ENTRY:
 28209                                  ;	BX	--	maximum length of destination buffer
 28210                                  ;	DS:SI	--	address of destination buffer
 28211                                  ;	argv[0] --	command name to be stripped
 28212                                  ; EXIT:
 28213                                  ;	CF	--	set if failure, clear if successful
 28214                                  ; NOTE(S):
 28215                                  
 28216                                  	; 18/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28217                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28218                                  STRIP:
 28219 00003856 50                      	push	ax
 28220 00003857 53                      	push	bx
 28221 00003858 51                      	push	cx
 28222 00003859 52                      	push	dx
 28223 0000385A 57                      	push	di
 28224 0000385B 56                      	push	si
 28225                                  	;pushf	; ** ; 18/03/2023
 28226                                  		
 28227                                  	; 05/05/2023
 28228                                  	; MSDOS 6.0
 28229 0000385C C606[659F]01            	mov	byte [ext_entered],1
 28230                                  				;AN005; assume no extension on file name
 28231                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28232                                  	;mov	dx,[ARG_ARGV]
 28233                                  	;mov	dx,ds:arg.argv[0].argpointer
 28234                                  				; save pointer to beginning of argstring
 28235                                  	;mov	dx,[ARGV0_ARGPOINTER]
 28236 00003861 8B16[AF9F]              	mov	dx,[ARG+ARGV_ELE.argpointer]
 28237                                  	;mov	di,ds:arg.argv[0].argstartel
 28238                                  				; beginning of last pathname element
 28239                                  	;mov	di,[ARGV0_ARGSTARTEL] ; beginning of last pathname element
 28240 00003865 8B3E[B29F]              	mov	di,[ARG+ARGV_ELE.argstartel]
 28241 00003869 803D00                  	cmp	byte [di],0	; *STARTEL == NULL means no command
 28242 0000386C 743D                    	je	short STRIP_ERROR
 28243 0000386E 89D1                    	mov	cx,dx		; compute where end of argstring lies
 28244                                  	;add	cx,ds:arg.argv[0].arglen
 28245                                  	;add	cx,[ARGV0_ARGLEN]
 28246 00003870 030E[B49F]              	add	cx,[ARG+ARGV_ELE.arglen]
 28247 00003874 29F9                    	sub	cx,di		; and then find length of last element
 28248 00003876 41                      	inc	cx		; include null as well
 28249 00003877 B02E                    	mov	al,'.'
 28250                                  	;mov	al,DOT		; let's find the filetype extension
 28251 00003879 FC                      	cld
 28252 0000387A F2AE                    	repnz	scasb		; wind up pointing to either null or dot
 28253                                  
 28254                                  	; 18/03/2023
 28255                                  	; MSDOS 6.0
 28256 0000387C E307                    	jcxz	PROCESS_EXT	;AN005; if no extension found, just continue
 28257 0000387E B000                    	mov	al,0 ; 18/03/2023
 28258                                  	;mov	byte [ext_entered],0
 28259 00003880 A2[659F]                	mov	[ext_entered],al
 28260                                  				;AN005; we found an extension
 28261                                  	;;mov	al,ANULL	;AN005; continue scanning until the
 28262                                  	;mov	al,0
 28263 00003883 F2AE                    	repnz	scasb		;AN005; end of line is reached.
 28264                                  PROCESS_EXT:
 28265                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28266 00003885 89F9                    	mov	cx,di		; pointer to end of argstring yields
 28267 00003887 29D1                    	sub	cx,dx		; number of bytes to be copied
 28268 00003889 83EB04                  	sub	bx,4		; can argstring fit into dest. buffer?
 28269 0000388C 39D9                    	cmp	cx,bx
 28270 0000388E 7F1B                    	jg	short STRIP_ERROR
 28271                                  				; if not, we must have a bad pathname
 28272 00003890 89F7                    	mov	di,si		; destination buffer
 28273 00003892 89D6                    	mov	si,dx		; source is beginning of pathname
 28274 00003894 FC                      	cld
 28275 00003895 F3A4                    	rep	movsb		; SI=arg,DI=buffer,CX=argend-argbeg
 28276                                  
 28277                                  	; 18/03/2023
 28278                                  	; MSDOS 6.0
 28279 00003897 803E[659F]01            	cmp	byte [ext_entered],1
 28280                                  				;AN005; if an extension was entered
 28281 0000389C 750A                    	jne	short SKIP_WILDS ; cf = 1 ; 12/06/2023
 28282                                  				;AN005;    don't set up wildcard ext.
 28283                                  
 28284                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28285 0000389E 4F                      	dec	di		; overwrite null or dot
 28286 0000389F AA                      	stosb			; with a dot
 28287 000038A0 B03F                    	mov	al,'?'
 28288                                  	;mov	al,WILDCHAR	; now add wildcards
 28289 000038A2 AA                      	stosb
 28290 000038A3 AA                      	stosb
 28291 000038A4 AA                      	stosb
 28292 000038A5 B000                    	mov	al,0
 28293                                  	;mov	al,ANULL	; and a terminating null	
 28294 000038A7 AA                      	stosb
 28295                                  SKIP_WILDS:
 28296                                  	;popf	; ** ; 18/03/2023
 28297 000038A8 F8                      	clc
 28298 000038A9 EB01                    	jmp	short STRIP_EXIT ; chill out...
 28299                                  
 28300                                  STRIP_ERROR:
 28301                                  	;popf	; ** ; 18/03/2023
 28302 000038AB F9                      	stc
 28303                                  STRIP_EXIT:
 28304 000038AC 5E                      	pop	si
 28305 000038AD 5F                      	pop	di
 28306 000038AE 5A                      	pop	dx
 28307 000038AF 59                      	pop	cx
 28308 000038B0 5B                      	pop	bx
 28309 000038B1 58                      	pop	ax
 28310 000038B2 C3                      	retn
 28311                                  
 28312                                  ; =============== S U B	R O U T	I N E =======================================
 28313                                  
 28314                                  ; SAVE_ARGS attempts to preserve the existing argv[]/argvcnt/argbuffer
 28315                                  ;
 28316                                  ; structure in newly allocated memory. The argv[] structure is found at the
 28317                                  ; beginning of this area. The caller indicates how much extra space is
 28318                                  ; needed in the resulting structure; Save_Args returns a segment number and
 28319                                  ; an offset into that area, indicating where the caller may preserve its own
 28320                                  ; data. Note that <argvcnt> can be found at <offset-2>.
 28321                                  ; ENTRY:
 28322                                  ;   BX	    --	size (in bytes) of extra area to allocate
 28323                                  ; EXIT:
 28324                                  ;   AX	    --	segment of new area.
 28325                                  ;   CF	    --	set if unable to save a copy.
 28326                                  ; NOTE(S):
 28327                                  ;   1)	The allocated area will be AT LEAST the size requested -- since
 28328                                  ;	the underlying MSDOS call, <alloc> returns an integral number of
 28329                                  ;	paragraphs.
 28330                                  ;   2)	It is an error if MSDOS can't allocate AT LEAST as much memory
 28331                                  ;	as the caller of Save_Args requests.
 28332                                  ;   3)	AX is undefined if CF indicates an error.
 28333                                  
 28334                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28335                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28336                                  SAVE_ARGS:
 28337 000038B3 53                      	push	bx
 28338 000038B4 51                      	push	cx
 28339 000038B5 52                      	push	dx
 28340 000038B6 57                      	push	di
 28341 000038B7 56                      	push	si
 28342 000038B8 55                      	push	bp
 28343                                  	; 01/05/2023
 28344                                  	; 26/04/2023
 28345                                  	;pushf ; **
 28346                                  	;add	bx,1363		; space for arg structure, round up
 28347 000038B9 81C35304                	add	bx,ARG_UNIT.SIZE+15 ; 1348+15
 28348 000038BD B104                    	mov	cl,4		; to paragraph size and convert
 28349 000038BF D3EB                    	shr	bx,cl		; size in bytes to size in paragraphs
 28350 000038C1 B80048                  	mov	ax,ALLOC*256 ; 4800h
 28351 000038C4 CD21                    	int	21h	; DOS -	2+ - ALLOCATE MEMORY
 28352                                  			; BX = number of 16-byte paragraphs desired
 28353 000038C6 7242                    	jc	short SAVE_ERROR ; ***
 28354 000038C8 89C5                    	mov	bp,ax		; save segment id
 28355 000038CA 06                      	push	es		; save TRANGROUP address
 28356 000038CB 8EC0                    	mov	es,ax		; switch to new memory segment
 28357                                  	; assume es:nothing
 28358                                  	;mov	cx,1348		; get back structure size
 28359 000038CD B94404                  	mov	cx,ARG_UNIT.SIZE
 28360 000038D0 31FF                    	xor	di,di		; destination is new memory area
 28361                                  	;mov	si,ARG_ARGV
 28362 000038D2 BE[AF9F]                	mov	si,ARG		; source is arg structure
 28363 000038D5 F3A4                    	rep	movsb		; move that sucker!
 28364                                  	;mov	cx,arg.argvcnt 	; adjust argv pointers
 28365                                  	;mov	cx,[ARG_ARGVCNT]
 28366 000038D7 8B0E[6FA2]              	mov	cx,[ARG+ARG_UNIT.argvcnt]
 28367 000038DB 31C0                    	xor	ax,ax		; base address for argv_calc
 28368                                  
 28369                                  ;	Bugbug:	What did they mean by this?
 28370                                  ;	Note that the replacement line produces exactly the same code.
 28371                                  ;;	mov	SI, OFFSET TRANGROUP:arg.argbuf - OFFSET arg_unit.argbuf
 28372                                  ;	mov	SI, OFFSET TRANGROUP:arg
 28373                                  
 28374                                  	;mov	si,ARG_ARGV
 28375 000038DD BE[AF9F]                	mov	si,ARG	
 28376                                  SAVE_PTR_LOOP:
 28377 000038E0 49                      	dec	cx		; exhausted all args?
 28378 000038E1 7C24                    	jl	short SAVE_DONE
 28379 000038E3 89CB                    	mov	bx,cx		; get arg index and
 28380 000038E5 E8A3FC                  	call	argv_calc	; convert to a pointer
 28381                                  	;mov	dx,ds:arg.argv[bx].argpointer
 28382                                  	;mov	dx,[ARG_ARGV+bx]
 28383 000038E8 8B97[AF9F]              	mov	dx,[ARG+ARGV_ELE.argpointer+bx]
 28384 000038EC 29F2                    	sub	dx,si		; adjust argpointer
 28385                                  	;mov	es:argv[BX].argpointer,dx
 28386                                  	;mov	[es:bx+ARGV_ELE.argpointer],dx ; mov [es:bx+0],dx
 28387 000038EE 268917                  	mov	[es:bx],dx
 28388                                  	;mov	dx,ds:arg.argv[bx].argstartel
 28389                                  	;mov	dx,[ARGV0_ARGSTARTEL+bx]
 28390 000038F1 8B97[B29F]              	mov	dx,[ARG+ARGV_ELE.argstartel+bx]
 28391 000038F5 29F2                    	sub	dx,si		; and adjust argstartel
 28392                                  	;mov	es:argv[bx].argstartel,dx
 28393                                  	;mov	[es:bx+3],dx
 28394 000038F7 26895703                	mov	[es:bx+ARGV_ELE.argstartel],dx
 28395                                  	;mov	dx,ds:arg.argv[bx].arg_ocomptr
 28396                                  	;mov	dx,[ARGV0_OCOMPTR+bx]
 28397 000038FB 8B97[B89F]              	mov	dx,[ARG+ARGV_ELE.arg_ocomptr+bx]
 28398 000038FF 29F2                    	sub	dx,si		; and adjust arg_ocomptr
 28399                                  	;mov	es:argv[bx].arg_ocomptr,dx
 28400                                  	;mov	[es:bx+9],dx
 28401 00003901 26895709                	mov	[es:bx+ARGV_ELE.arg_ocomptr],dx
 28402 00003905 EBD9                    	jmp	short SAVE_PTR_LOOP
 28403                                  SAVE_DONE:
 28404 00003907 07                      	pop	es		; back we go to TRANGROUP
 28405                                  	; assume es:nothing
 28406 00003908 89E8                    	mov	ax,bp		; restore segment id
 28407                                  	; 26/04/2023
 28408                                  	; cf = 0 ; *
 28409                                  	;jmp	short SAVE_OK
 28410                                  
 28411                                  	; 26/04/2023
 28412                                  ;SAVE_ERROR:
 28413                                  ;	; 26/04/2023
 28414                                  ;	;popf ; **
 28415                                  ;	stc
 28416                                  ;	jmp	short SAVE_EXIT
 28417                                  
 28418                                  SAVE_OK:
 28419                                  	; 26/04/2023
 28420                                  	;popf ; **
 28421                                  	; 26/04/2023
 28422                                  	; cf = 0 ; *
 28423                                  	;clc
 28424                                  SAVE_EXIT:
 28425                                  SAVE_ERROR:	; 26/04/2023 (cf=1) ; ***
 28426 0000390A 5D                      	pop	bp
 28427 0000390B 5E                      	pop	si
 28428 0000390C 5F                      	pop	di
 28429 0000390D 5A                      	pop	dx
 28430 0000390E 59                      	pop	cx
 28431 0000390F 5B                      	pop	bx
 28432                                  answ_no:	; 26/04/2023
 28433 00003910 C3                      	retn
 28434                                  
 28435                                  ;============================================================================
 28436                                  ; TUCODE.ASM, MSDOS 6.0, 1991 (1)
 28437                                  ;============================================================================
 28438                                  ; 02/10/2018 - Retro DOS v3.0
 28439                                  
 28440                                  ; Title	COMMAND Language midifiable Code Transient
 28441                                  
 28442                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2843h
 28443                                  
 28444                                  ; =============== S U B	R O U T	I N E =======================================
 28445                                  
 28446                                  ; ****************************************************************
 28447                                  ; *
 28448                                  ; * ROUTINE:	 NOTEST2 - execution of DEL/ERASE command
 28449                                  ; *
 28450                                  ; * FUNCTION:	 Delete files based on user parsed input. Prompt
 28451                                  ; *		 user for Y/N if necessary. If an error occurs,
 28452                                  ; *		 set up an error message and go to CERROR.
 28453                                  ; *
 28454                                  ; * INPUT:	 FCB at 5ch set up with filename(s) entered
 28455                                  ; *		 Current directory set to entered directory
 28456                                  ; *
 28457                                  ; * OUTPUT:	 none
 28458                                  ; *
 28459                                  ; ****************************************************************
 28460                                  ;
 28461                                  ; ARE YOU SURE prompt when deleting *.*
 28462                                  
 28463                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28464                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28465                                  notest2:
 28466 00003911 B90B00                  	mov	cx,11
 28467 00003914 BE5D00                  	mov	si,FCB+1 ; 5Dh
 28468                                  ambspec:
 28469 00003917 AC                      	lodsb
 28470 00003918 3C3F                    	cmp	al,'?'
 28471 0000391A 7502                    	jne	short allfil
 28472 0000391C E2F9                    	loop	ambspec
 28473                                  allfil:
 28474                                  	; 19/03/2023
 28475                                  	;cmp	cx,0
 28476 0000391E 09C9                    	or	cx,cx
 28477 00003920 752E                    	jnz	short noprmpt
 28478                                  askagn:	
 28479 00003922 BA[E590]                	mov	dx,SureMes_Ptr	; "Are you sure (Y/N)?"
 28480 00003925 E8F51A                  	call	std_printf
 28481 00003928 BE8000                  	mov	si,80h
 28482 0000392B 89F2                    	mov	dx,si
 28483 0000392D C7047800                	mov	word [si],120	; zero length
 28484                                  	;mov	ax,0C0Ah
 28485 00003931 B80A0C                  	mov	ax,(STD_CON_INPUT_FLUSH<<8)|Std_Con_String_Input
 28486 00003934 CD21                    	int	21h	; DOS -	CLEAR KEYBOARD BUFFER
 28487                                  			; AL must be 01h,06h,07h,08h or 0Ah.
 28488 00003936 AD                      	lodsw
 28489 00003937 08E4                    	or	ah,ah
 28490 00003939 74E7                    	jz	short askagn
 28491 0000393B E846F0                  	call	scanoff
 28492                                  	; 19/03/2023
 28493                                  	; MSDOS 6.0
 28494 0000393E E80C02                  	call	char_in_xlat	; Convert to upper case
 28495                                  	;retc			; return if function not supported
 28496                                  	; 19/03/2023
 28497                                  	;jnc	short check_yn
 28498                                  ;answ_no:
 28499                                  	;retn
 28500 00003941 72CD                    	jc	short answ_no
 28501                                  
 28502                                  	; 19/03/2023
 28503                                  	; AL = 0 if it was (country depended) NO character
 28504                                  	; AL = 1 if it was (country depenced) YES character
 28505                                  
 28506                                  	; MSDOS 3.3
 28507                                  	;call	UPCONV
 28508                                  
 28509                                  	; 19/03/2023	
 28510                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28511                                  	;cmp	al,[CAPITAL_N]
 28512                                  	;jne	short CHECK_Y
 28513                                  	;retn
 28514                                  ;CHECK_Y:
 28515                                  	;cmp	al,[CAPITAL_Y]
 28516                                  	;pushf
 28517                                  	;call	CRLF2
 28518                                  	;popf
 28519                                  	;jne	short ASKAGN
 28520                                  
 28521                                  check_yn:
 28522                                  	; 19/03/2023
 28523                                  	;cmp	al,0	; NO character
 28524 00003943 08C0                    	or	al,al
 28525 00003945 74C9                    	jz	short answ_no
 28526                                  	;cmp	al,1	 ;YES character
 28527 00003947 FEC8                    	dec	al ; 1 -> 0 --> zf = 1
 28528 00003949 9C                      	pushf
 28529 0000394A E82AF0                  	call	CRLF2
 28530 0000394D 9D                      	popf
 28531 0000394E 75D2                    	jnz	short askagn
 28532                                  noprmpt:
 28533 00003950 B413                    	mov	ah,FCB_Delete ; 13h
 28534 00003952 BA5C00                  	mov	dx,FCB ; 5Ch
 28535 00003955 CD21                    	int	21h	; DOS -	DELETE FILE via	FCB
 28536                                  			; DS:DX	-> FCB with filename field filled with
 28537                                  			; template for deletion ('?' wildcard allowed,but not '*')
 28538                                  			; Return: AL = 00h file	found,FFh file	not found
 28539 00003957 FEC0                    	inc	al
 28540 00003959 7403                    	jz	short eraerr
 28541                                  	; 26/04/2023
 28542                                  	;call	RestUDir
 28543                                  ;answ_no:
 28544                                  	;retn
 28545 0000395B E9D0EE                  	jmp	RestUDir ; 26/04/2023
 28546                                  
 28547                                  	; 19/03/2023
 28548                                  	; MSDOS 6.0
 28549                                  eraerr:
 28550                                  	;invoke	set_ext_error_msg
 28551                                  				;AN022; set up the extended error
 28552 0000395E E8D8E6                  	call	Set_Ext_Error_Msg
 28553 00003961 52                      	push	dx		;AN022; save message
 28554                                  	;invoke	RESTUDIR
 28555 00003962 E8C9EE                  	call	RestUDir
 28556 00003965 5A                      	pop	dx		;AN022; restore message
 28557                                  	
 28558 00003966 833E[CB8F]12            	cmp	word [extend_buf_ptr],ERROR_NO_MORE_FILES ; 18
 28559                                  				;AN022; convert no more files to
 28560 0000396B 7506                    	jne	short cerrorj2	;AN022;  file not found
 28561 0000396D C706[CB8F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2  
 28562                                  				;AN000; get message number in control block
 28563                                  cerrorj2:
 28564 00003973 E9AEF3                  	jmp	cerror
 28565                                  	
 28566                                  	; 19/03/2023
 28567                                  	; MSDOS 3.3
 28568                                  ;ERAERR:	
 28569                                  	;mov	ah,Set_DMA ; 1Ah
 28570                                  	;mov	dx,FCB ; 5Ch
 28571                                  	;int	21h		; DOS -	SET DISK TRANSFER AREA ADDRESS
 28572                                  	;			; DS:DX	-> disk	transfer buffer
 28573                                  	;mov	ah,Dir_Search_First ; 11h
 28574                                  	;int	21h		; DOS -	SEARCH FIRST USING FCB
 28575                                  	;			; DS:DX	-> FCB
 28576                                  	;push	ax
 28577                                  	;call	RESTUDIR
 28578                                  	;pop	ax
 28579                                  	;mov	dx,FNOTFOUNDPTR
 28580                                  	;inc	al
 28581                                  	;jz	short CERRORJ
 28582                                  	;mov	dx,ACCDENPTR
 28583                                  	;jmp	CERROR
 28584                                  
 28585                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28586                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:36D4h
 28587                                  
 28588                                  ; ****************************************************************
 28589                                  ; *
 28590                                  ; * ROUTINE:	 SLASHP_ERASE - execution of DEL/ERASE /P
 28591                                  ; *
 28592                                  ; * FUNCTION:	 Delete files based on user parsed input. Prompt
 28593                                  ; *		 user for Y/N where necessary. If an error occurs
 28594                                  ; *		 set up and error message and transfer control
 28595                                  ; *		 to CERROR.
 28596                                  ; *
 28597                                  ; * INPUT:	 FCB at 5Ch set up with filename(s) entered
 28598                                  ; *		 Current directory set to entered directory
 28599                                  ; *
 28600                                  ; * OUTPUT:	 none
 28601                                  ; *
 28602                                  ; ****************************************************************
 28603                                  
 28604                                  	; 19/03/2023
 28605                                  slashp_erase:				;AN000; entry point
 28606                                  	;invoke	build_dir_string	;AN000; set up current directory string for output
 28607 00003976 E882E8                  	call	build_dir_string
 28608                                  
 28609 00003979 B41A                    	mov	ah,Set_DMA ; 1Ah	;AN000; issue set dta int 21h
 28610                                  	;mov	dx,offset trangroup:destdir
 28611 0000397B BA[579D]                	mov	dx,DESTDIR		;AN000; use Destdir for target
 28612 0000397E CD21                    	int	21h			;AN000;
 28613                                  
 28614                                  	;mov	ah,11h
 28615 00003980 B411                    	mov	ah,Dir_Search_First	;AN000; do dir search first int 21h
 28616 00003982 BA5C00                  	mov	dx,FCB	; 5Ch		;AN000; use FCB at 5Ch for target
 28617 00003985 CD21                    	int	21h			;AN000;
 28618 00003987 FEC0                    	inc	al			;AN000; did an error occur
 28619                                  	;jz	short eraerr		;AN022; go to error exit
 28620                                  	; 26/04/2023
 28621 00003989 7502                    	jnz	short delete_prompt_loop
 28622                                  
 28623                                  	; 26/04/2023
 28624                                  stop_del:
 28625 0000398B EBD1                    	jmp	short eraerr		;AN022; go to error exit - need long jmp
 28626                                  
 28627                                  delete_prompt_loop:			;AN000;
 28628                                  	;mov	si,offset trangroup:destdir+1
 28629 0000398D BE[589D]                	mov	si,DESTDIR+1		;AN000; set up FCB as source
 28630                                  	;mov	di,offset trangroup:dest
 28631 00003990 BF[279D]                	mov	di,DEST			;AN000; set up dest as target
 28632 00003993 A0[589C]                	mov	al,[DIRCHAR]		;AN000; store a "\" in the first char
 28633 00003996 AA                      	stosb				;AN000;   of DEST
 28634                                  	;invoke	FCB_TO_ASCZ		;AN000; convert filename from FCB to ASCIIZ string
 28635 00003997 E809F0                  	call	FCB_TO_ASCZ
 28636                                  
 28637                                  slashp_askagn:				;AN000;
 28638 0000399A E8DAEF                  	call	CRLF2			;AN000; print out carriage return, line feed
 28639                                  	;mov	dx,offset trangroup:bwdbuf
 28640 0000399D BA[9A9D]                	mov	dx,BWDBUF		;AN000; print out current directory string
 28641 000039A0 89D3                    	mov	bx,dx			;AN000; get string pointer in bx
 28642 000039A2 807F0300                	cmp	byte [bx+3],END_OF_LINE_OUT ; 0
 28643                                  					;AN000; see if only D:\,0
 28644 000039A6 7504                    	jnz	short not_del_root	;AN000; no continue
 28645 000039A8 C6470200                	mov	byte [bx+2],END_OF_LINE_OUT ; 0
 28646                                  					;AN000; yes, get rid of \ ;
 28647                                  not_del_root:				;AN000;
 28648 000039AC 8916[019E]              	mov	[string_ptr_2],dx 	;AN000;
 28649                                  	;mov	dx,offset trangroup:string_buf_ptr
 28650 000039B0 BA[D391]                	mov	dx,string_buf_ptr	;AN000;
 28651                                  	;invoke	std_printf		;AN000;
 28652 000039B3 E8671A                  	call	std_printf
 28653                                  	;mov	dx,offset trangroup:dest
 28654 000039B6 BA[279D]                	mov	dx,DEST			;AN000; print out file name string
 28655 000039B9 8916[019E]              	mov	[string_ptr_2],dx 	;AN000;
 28656                                  	;mov	dx,offset trangroup:string_buf_ptr
 28657 000039BD BA[D391]                	mov	dx,string_buf_ptr	;AN000;
 28658                                  	;invoke	std_printf		;AN000;
 28659 000039C0 E85A1A                  	call	std_printf
 28660                                  	;mov	dx,offset trangroup:Del_Y_N_Ptr
 28661 000039C3 BA[E290]                	mov	dx,Del_Y_N_Ptr		;AN000; issue ", Delete (Y/N)?" message
 28662                                  	;invoke	std_printf		;AN000;
 28663 000039C6 E8541A                  	call	std_printf
 28664                                  
 28665                                  ;;M029	mov	si,80H			;AN000; set up buffer for input
 28666                                  ;;M029	mov	dx,si			;AN000;
 28667                                  ;;M029	mov	word ptr [si],combuflen ;AN000;
 28668                                  ;;M029	mov	ax,(std_con_input_flush shl 8) or std_con_string_input	;AN000;
 28669                                  ;;M029	int	21h			;AN000; get input from the user
 28670                                  ;;M029	lodsw				;AN000;
 28671                                  ;;M029	or	ah,ah			;AN000; was a character entered?
 28672                                  ;;M029	jz	short slashp_askagn	;AN000; no - ask again
 28673                                  ;;M029	invoke	scanoff 		;AN000; scan off leading delimiters
 28674                                  
 28675                                  ;	Get a single character input.
 28676                                  
 28677                                  	;;mov	ax,(STD_CON_INPUT_FLUSH shl 8) or STD_CON_INPUT	;M029
 28678                                  	;mov	ax,(STD_CON_INPUT_FLUSH<<8)|STD_CON_INPUT
 28679 000039C9 B8010C                  	mov	ax,0C01h
 28680 000039CC CD21                    	int	21h			;M029
 28681                                  
 28682 000039CE E87C01                  	call	char_in_xlat		;AN000; yes - upper case it
 28683                                  	;retc				;AN000; return if function not supported
 28684                                  	; 19/03/2023
 28685 000039D1 7301                    	jnc	short slashp_check_yn
 28686                                  slashp_ans_no:
 28687 000039D3 C3                      	retn
 28688                                  
 28689                                  slashp_check_yn:
 28690                                  	; 19/03/2023
 28691                                  	; AL = 0 if it was (country depended) NO character
 28692                                  	; AL = 1 if it was (country depenced) YES character
 28693                                  
 28694                                  	;cmp	al,capital_n		;AN000; was it no?
 28695                                  	;cmp	al,0
 28696 000039D4 20C0                    	and	al,al ; 0
 28697 000039D6 7420                    	jz	short next_del_file	;AN000; yes - don't delete file
 28698                                  	;cmp	al,capital_y		;AN000; was it yes?
 28699                                  	;cmp	al,1
 28700 000039D8 FEC8                    	dec	al  ; 1-> 0 --> zf = 1
 28701                                  	;jz	short delete_this_file	;AN000; yes - delete the file
 28702                                  	;jmp	short slashp_askagn	;AN000; it was neither - ask again
 28703                                  	; 19/03/2023
 28704 000039DA 75BE                    	jnz	short slashp_askagn
 28705                                  
 28706                                  delete_this_file:			;AN000;
 28707 000039DC B413                    	mov	ah,FCB_Delete ; 13h	;AN000; delete the file
 28708                                  	;mov	dx,offset trangroup:destdir
 28709 000039DE BA[579D]                	mov	dx,DESTDIR		;AN000; use Destdir for target
 28710 000039E1 CD21                    	int	21h			;AN000;
 28711 000039E3 FEC0                    	inc	al			;AN000; did an error occur?
 28712 000039E5 7511                    	jnz	short next_del_file	;AN000; no - get next file
 28713                                  ;
 28714                                  ;M041; Begin changes
 28715                                  ; We got an error deleting the file. If this is access denied, we can go on
 28716                                  ;to the next file after printing an error message.
 28717                                  ;
 28718                                  	;invoke	Get_ext_error_number	;see what error we got
 28719 000039E7 E85FE6                  	call	get_ext_error_number
 28720 000039EA 83F805                  	cmp	ax,ERROR_ACCESS_DENIED ; 5
 28721                                  					;is it access denied?
 28722 000039ED 759C                    	jne	short stop_del		;no, some other error
 28723                                  	;invoke	CrLf2			;print a CR-LF
 28724 000039EF E885EF                  	call	CRLF2
 28725                                  	;invoke set_ext_error_msg	;error message
 28726 000039F2 E844E6                  	call	Set_Ext_Error_Msg
 28727                                  	;invoke	std_eprintf		;"Access denied"
 28728 000039F5 E81D1A                  	call	std_eprintf
 28729                                  	; 26/04/2023
 28730                                  	;jmp	short next_del_file	;try next file
 28731                                  	; 26/04/2023
 28732                                  ;stop_del:
 28733                                  ;;
 28734                                  ;;M041; End changes
 28735                                  ;;
 28736                                  ;	jmp	eraerr			;AN022; go to error exit - need long jmp
 28737                                  
 28738                                  next_del_file:				;AN000;
 28739                                  ;
 28740                                  ; M050 - begin
 28741                                  ; 	Norton Utilities 5.0 has a bug. DiskMon when invoked
 28742                                  ;       with /protect+ and /light+ makes it intercept all
 28743                                  ;       deletes. This hook does not save and restore the DTA correctly.
 28744                                  ;       They save the DWORD in a WORD by mistake! They save both the
 28745                                  ;       segment and the offset in the SAME variable (WORD)!!!
 28746                                  ;
 28747 000039F8 B41A                    	mov	ah,Set_DMA ; 1Ah
 28748                                  	;mov	dx,offset trangroup:destdir
 28749 000039FA BA[579D]                	mov	dx,DESTDIR
 28750 000039FD CD21                    	int	21h
 28751                                  ;
 28752                                  ; M050 - end
 28753                                  
 28754 000039FF B412                    	mov	ah,Dir_Search_Next ; 12h
 28755                                  					;AN000; search for another file
 28756 00003A01 BA5C00                  	mov	dx,FCB	; 5Ch		;AN000;
 28757 00003A04 CD21                    	int	21h			;AN000;
 28758 00003A06 FEC0                    	inc	al			;AN000; was a file found?
 28759                                  	;jz	short slash_p_exit	;AN000; no - exit
 28760                                  	;jmp	delete_prompt_loop	;AN000; yes - continue (need long jump)
 28761                                  	; 26/04/2023
 28762 00003A08 7583                    	jnz	short delete_prompt_loop
 28763                                  
 28764                                  slash_p_exit:
 28765                                  	;invoke	get_ext_error_number	;AN022; get the extended error number
 28766 00003A0A E83CE6                  	call	get_ext_error_number
 28767 00003A0D 83F812                  	cmp	ax,ERROR_NO_MORE_FILES	;AN022; was error file not found?
 28768 00003A10 7403                    	jz	short good_erase_exit 	;AN022; yes - clean exit
 28769 00003A12 E969E3                  	jmp	extend_setup		;AN022; go issue error message
 28770                                  
 28771                                  good_erase_exit:
 28772                                  	;invoke	restudir		;AN000; we're finished - restore user's dir
 28773 00003A15 E816EE                  	call	RestUDir
 28774                                  	;call	CRLF2			;AN000; print out carriage return, line feed
 28775                                  	;retn				;AN000; exit
 28776                                  	; 19/03/2023
 28777 00003A18 E95CEF                  	jmp	CRLF2
 28778                                  
 28779                                  ; =============== S U B	R O U T	I N E =======================================
 28780                                  
 28781                                  ; ECHO, BREAK, and VERIFY commands. Check for "ON" and "OFF"
 28782                                  
 28783                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 28784                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 28785                                  _ECHO:
 28786 00003A1B E89900                  	call	ON_OFF
 28787 00003A1E 7212                    	jb	short DOEMES
 28788 00003A20 8E1E[539C]              	mov	ds,[RESSEG]
 28789 00003A24 7506                    	jnz	short ECH_OFF
 28790 00003A26 800E[9D02]01            	or	byte [EchoFlag],1
 28791 00003A2B C3                      	retn
 28792                                  
 28793                                  ECH_OFF:
 28794 00003A2C 8026[9D02]FE            	and	byte [EchoFlag],0FEh
 28795 00003A31 C3                      	retn
 28796                                  
 28797                                  	; 19/03/2023
 28798                                  	; MSDOS 6.0 (& MSDOS 5.0)
 28799                                  ;CERRORJ:
 28800                                  	;jmp	cerror
 28801                                  
 28802                                  ; There was no discrenable ON or OFF after the ECHO. If there is nothing but
 28803                                  ; delimiters on the command line, we issue the ECHO is ON/OFF message.
 28804                                  
 28805                                  DOEMES:
 28806                                  	; 19/03/2023
 28807                                  	; MSDOS 6.0
 28808                                  	;cmp	cl,0		;AC000; was anything on the line?
 28809 00003A32 20C9                    	and	cl,cl
 28810 00003A34 7409                    	jz	short PECHO	; just display current state.
 28811 00003A36 BA8200                  	mov	dx,82h		; Skip one char after "ECHO"
 28812 00003A39 E894EF                  	call	CRPRINT
 28813 00003A3C E938EF                  	jmp	CRLF2
 28814                                  
 28815                                  	; 19/03/2023
 28816                                  	; MSDOS 3.3
 28817                                  	;call	MOVE_TO_FIRST_ARG
 28818                                  	;jz	short PECHO
 28819                                  	;mov	dx,82h
 28820                                  	;call	CRPRINT
 28821                                  	;jmp	CRLF2
 28822                                  
 28823                                  PECHO:
 28824                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28825 00003A3F 8E1E[539C]              	mov	ds,[RESSEG]
 28826 00003A43 8A1E[9D02]              	mov	bl,[EchoFlag]
 28827 00003A47 0E                      	push	cs
 28828 00003A48 1F                      	pop	ds
 28829 00003A49 80E301                  	and	bl,1
 28830 00003A4C BA[7391]                	mov	dx,EchoMes_Ptr
 28831 00003A4F EB24                    	jmp	short PYN
 28832                                  
 28833                                  ; ---------------------------------------------------------------------------
 28834                                  
 28835                                  	; 19/03/2023
 28836                                  	; MSDOS 3.3
 28837                                  CERRORJ:
 28838 00003A51 E9D0F2                  	jmp	cerror
 28839                                  
 28840                                  ; =============== S U B	R O U T	I N E =======================================
 28841                                  
 28842                                  	; 19/03/2023
 28843                                  	; MSDOS 3.3
 28844                                  ;MOVE_TO_FIRST_ARG:
 28845                                  	;mov	si,81h
 28846                                  	;call	SCANOFF
 28847                                  	;cmp	al,0Dh
 28848                                  	;retn
 28849                                  
 28850                                  ; =============== S U B	R O U T	I N E =======================================
 28851                                  
 28852                                  CNTRLC:
 28853 00003A54 E86000                  	call	ON_OFF
 28854 00003A57 B80133                  	mov	ax,(Set_CTRL_C_Trapping<<8)|1 ; 3301h
 28855 00003A5A 720C                    	jc	short PCNTRLC
 28856 00003A5C 7505                    	jnz	short CNTRLC_OFF
 28857 00003A5E B201                    	mov	dl,1
 28858 00003A60 CD21                    	int	21h	; DOS -	EXTENDED CONTROL-BREAK CHECKING
 28859                                  			; AL = 00h get state / 01h set state / 02h set AND get
 28860                                  			; DL = 00h for OFF or 01h for ON
 28861 00003A62 C3                      	retn
 28862                                  
 28863                                  ; ---------------------------------------------------------------------------
 28864                                  
 28865                                  CNTRLC_OFF:
 28866 00003A63 30D2                    	xor	dl,dl
 28867 00003A65 CD21                    	int	21h		; Turn off ^C check
 28868 00003A67 C3                      	retn
 28869                                  
 28870                                  ; ---------------------------------------------------------------------------
 28871                                  
 28872                                  PCNTRLC:
 28873                                  	; 19/03/2023
 28874                                  	; MSDOS 6.0
 28875                                  	;cmp	cl,0		;AC000; rest of line blank?
 28876 00003A68 08C9                    	or	cl,cl
 28877 00003A6A 75E5                    	jnz	short CERRORJ 	; no, oops!
 28878                                  
 28879                                  	; 19/03/2023
 28880                                  	; MSDOS 3.3
 28881                                  	;call	MOVE_TO_FIRST_ARG
 28882                                  	;jnz	short CERRORJ
 28883                                  ;pccont:
 28884                                  	; MSDOS 3.3 (& MSDOS 6.0)
 28885 00003A6C 30C0                    	xor	al,al
 28886 00003A6E CD21                    	int	21h		; get Ctrl-Break state (ah=33h)
 28887 00003A70 88D3                    	mov	bl,dl
 28888 00003A72 BA[5791]                	mov	dx,CtrlcMes_Ptr
 28889                                  
 28890                                  ; ---------------------------------------------------------------------------
 28891                                  
 28892                                  PYN:	; write "ON" or "OFF" state 
 28893                                  
 28894                                  	; 26/04/2023
 28895                                  	; 19/03/2023
 28896                                  	; MSDOS 3.3
 28897                                  	;call	STD_PRINTF
 28898                                  	;mov	dx,ONMES_PTR	;AC000; get ON pointer
 28899                                  	;or	bl,bl
 28900                                  	;jnz	short PRINTVAL
 28901                                  	;mov	dx,OFFMES_PTR	;AC000; get OFF pointer
 28902                                  	
 28903                                  	; 26/04/2023
 28904                                  	; 19/03/2023
 28905                                  	; MSDOS 6.0
 28906 00003A75 BE[8491]                	mov	si,ONMES_PTR
 28907 00003A78 08DB                    	or	bl,bl
 28908 00003A7A 7503                    	jnz	short PRINTVAL
 28909 00003A7C BE[8191]                	mov	si,OFFMES_PTR
 28910                                  PRINTVAL:
 28911                                  	; 19/03/2023
 28912                                  	; MSDOS 3.3
 28913                                  	;jmp	STD_PRINTF
 28914                                  
 28915                                  	; 19/03/2023
 28916                                  	; MSDOS 6.0
 28917 00003A7F 52                      	push	dx		;AN000; save offset of message block
 28918 00003A80 89D3                    	mov	bx,dx		;AN000; save offset value
 28919 00003A82 AD                      	lodsw			;AN000; get message number of on or off
 28920 00003A83 B6FF                    	mov	dh,util_msg_class ; -1 ; 0FFh
 28921                                  				;AN000; this is a utility message
 28922 00003A85 E87A1A                  	call	TSYSGETMSG	;AN000; get the address of the message
 28923                                  	;add	bx,5
 28924 00003A88 83C305                  	add	bx,Ptr_off_pos	;AN000; point to offset of ON/OFF
 28925                                  	
 28926 00003A8B 8937                    	mov	[bx],si		;AN000; put the offset in the message block
 28927 00003A8D 5A                      	pop	dx		;AN000; get message back
 28928 00003A8E E88C19                  	call	std_printf	;AC000; go print message
 28929 00003A91 C7070000                	mov	word [bx],0	;AN000; zero out message pointer
 28930 00003A95 C3                      	retn			;AN000; exit
 28931                                  
 28932                                  ; =============== S U B	R O U T	I N E =======================================
 28933                                  
 28934                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.CO
 28935                                  VERIFY:
 28936 00003A96 E81E00                  	call	ON_OFF
 28937 00003A99 B8012E                  	mov	ax,(SET_VERIFY_ON_WRITE<<8)|1 ; 2E01h
 28938 00003A9C 720A                    	jc	short PVERIFY
 28939 00003A9E 7503                    	jnz	short VER_OFF
 28940 00003AA0 CD21                    	int	21h	; DOS -	SET VERIFY FLAG
 28941                                  			; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 28942 00003AA2 C3                      	retn
 28943                                  
 28944                                  ; ---------------------------------------------------------------------------
 28945                                  
 28946                                  VER_OFF:
 28947 00003AA3 FEC8                    	dec	al
 28948 00003AA5 CD21                    	int	21h		; Turn off verify after write
 28949 00003AA7 C3                      	retn
 28950                                  
 28951                                  ; ---------------------------------------------------------------------------
 28952                                  
 28953                                  PVERIFY:
 28954                                  	; 19/03/2023
 28955                                  	; MSDOS 6.0
 28956                                  	;cmp	cl,0		;AC000; is rest of line blank?
 28957 00003AA8 20C9                    	and	cl,cl
 28958 00003AAA 75A5                    	jnz	short CERRORJ 	; nope...
 28959                                  
 28960                                  	 ;19/03/2023
 28961                                  	; MSDOS 3.3
 28962                                  	;call	MOVE_TO_FIRST_ARG
 28963                                  	;jnz	short CERRORJ
 28964                                  
 28965 00003AAC B454                    	mov	ah,Get_Verify_On_Write ; 54h
 28966 00003AAE CD21                    	int	21h		; DOS -	2+ - GET VERIFY	FLAG
 28967                                  				; Return: AL = 00h if flag OFF
 28968                                  				; AL = 01h if flag ON
 28969 00003AB0 88C3                    	mov	bl,al
 28970 00003AB2 BA[6591]                	mov	dx,VeriMes_Ptr
 28971 00003AB5 EBBE                    	jmp	short PYN
 28972                                  
 28973                                  ; =============== S U B	R O U T	I N E =======================================
 28974                                  
 28975                                  ; ****************************************************************
 28976                                  ; *
 28977                                  ; * ROUTINE:	 ON_OFF
 28978                                  ; *
 28979                                  ; * FUNCTION:	 Parse the command line for an optional ON or
 28980                                  ; *		 OFF string for the BREAK, VERIFY, and ECHO
 28981                                  ; *		 routines.
 28982                                  ; *
 28983                                  ; * INPUT:	 command line at offset 81H
 28984                                  ; *		 PARSE_BREAK control block
 28985                                  ; *
 28986                                  ; * OUTPUT:	 If carry is clear
 28987                                  ; *		    If ON is found
 28988                                  ; *		       Zero flag set
 28989                                  ; *		    If OFF is found
 28990                                  ; *		       Zero flag clear
 28991                                  ; *		 If carry set
 28992                                  ; *		    If nothing on command line
 28993                                  ; *		       CL set to zero
 28994                                  ; *		    If error
 28995                                  ; *		       CL contains error value from parse
 28996                                  ; *
 28997                                  ; ****************************************************************
 28998                                  
 28999                                  	; 19/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29000                                  ON_OFF:
 29001 00003AB7 BE8100                  	mov	si,81h
 29002                                  
 29003                                  	; 19/03/2023
 29004                                  	; MSDOS 3.3
 29005                                  	;call	SCANOFF		; scan off leading blanks & equal
 29006                                  	;cmp	al,0Dh		; are we at end of line?
 29007                                  	;je	short BAD_ONF	; yes, return error
 29008                                  	;lodsw
 29009                                  	;or	ax,2020h	; convert to lowercase
 29010                                  	;cmp	ax,6E6Fh ;'on'
 29011                                  	;je	short ON_CHECK
 29012                                  	;cmp	ax,666Fh ;'of'
 29013                                  	;jne	short BAD_ONF
 29014                                  	;lodsb
 29015                                  	;or	al,20h		; convert to lowercase		
 29016                                  	;cmp	al,66h	 ; 'f'
 29017                                  	;jne	short BAD_ONF	
 29018                                  	;or	al,66h ; or al,'f'
 29019                                  	;jmp	short OFF_CHECK
 29020                                  ;ON_CHECK:
 29021                                  	;xor	al,al
 29022                                  ;OFF_CHECK:
 29023                                  	;lahf
 29024                                  	;mov	bx,ax
 29025                                  	;call	SCANOFF		; scan off leading blanks & equal
 29026                                  	;cmp	al,0Dh		; are we at end of line?	
 29027                                  	;jne	short BAD_ONF	; no, return error
 29028                                  	;mov	ax,bx
 29029                                  	;sahf
 29030                                  	;clc
 29031                                  	;retn
 29032                                  
 29033                                  	; 19/03/2023
 29034                                  	; MSDOS 6.0
 29035                                  scan_on_off:			;AN032; scan off leading blanks & equal
 29036 00003ABA AC                      	lodsb			;AN032; get a char
 29037                                  	;cmp	al,blank	;AN032; if whitespace
 29038 00003ABB 3C20                    	cmp	al,20h
 29039 00003ABD 74FB                    	je	short scan_on_off
 29040                                  				;AN032;    keep scanning
 29041 00003ABF 3C09                    	cmp	al,tab_chr	;AN032; if tab
 29042                                  	;cmp	al,09h
 29043 00003AC1 74F7                    	je	short scan_on_off
 29044                                  				;AN032;    keep scanning
 29045                                  	;cmp	al,equal_chr	;AN032; if equal char
 29046 00003AC3 3C3D                    	cmp	al,'=' ; 3Dh
 29047 00003AC5 7401                    	je	short parse_on_off
 29048                                  				;AN032;    start parsing
 29049 00003AC7 4E                      	dec	si		;AN032; if none of above - back up
 29050                                  
 29051                                  parse_on_off:			;AN032;    and start parsing
 29052 00003AC8 BF[0496]                	mov	di,PARSE_BREAK	;AN000; Get address of PARSE_BREAK
 29053 00003ACB 31C9                    	xor	cx,cx		;AN000; clear cx,dx
 29054 00003ACD 31D2                    	xor	dx,dx		;AN000;
 29055 00003ACF E87A0E                  	call	cmd_parse	;AC000; call parser
 29056                                  	;cmp	ax,-1 ; 0FFFFh
 29057 00003AD2 83F8FF                  	cmp	ax,END_OF_LINE	;AC000; are we at end of line?
 29058 00003AD5 742E                    	je	short BADONF	;AC000; yes, return error
 29059                                  	;cmp	ax,RESULT_NO_ERROR ;AN000; did an error occur
 29060                                  	;cmp	ax,0
 29061 00003AD7 21C0                    	and	ax,ax ; ax = 0 ?
 29062 00003AD9 7404                    	jz	short on_off_there
 29063                                  				;AN000; no - continue
 29064 00003ADB 89C1                    	mov	cx,ax		;AN000; yes - set cl to error code
 29065 00003ADD EB26                    	jmp	short BADONF	;AN000; return error
 29066                                  
 29067                                  on_off_there:
 29068 00003ADF 803E[4CA6]FF            	cmp	byte [PARSE1_CODE],-1 ; 0FFh
 29069                                  				;AN014; was a valid positional present?
 29070 00003AE4 7505                    	jnz	short good_on_off
 29071                                  				;AN014; yes - continue
 29072 00003AE6 B90A00                  	mov	cx,BadParm_Ptr	;AN014; something other than ON/OFF
 29073                                  	;mov	cx,10 ; 0Ah
 29074 00003AE9 EB1A                    	jmp	short BADONF	;AN014; return error
 29075                                  
 29076                                  good_on_off:			;AN014;
 29077 00003AEB 31C0                    	xor	ax,ax		;AC000; set up return code for
 29078 00003AED 0A06[4CA6]              	or	al,[PARSE1_CODE]
 29079                                  				;AC000;    ON or OFF in AX
 29080 00003AF1 9C                      	pushf			;AN000; save flags
 29081 00003AF2 BF[0496]                	mov	di,PARSE_BREAK	;AN000; Get address of PARSE_BREAK
 29082 00003AF5 31D2                    	xor	dx,dx		;AN000;
 29083 00003AF7 E8520E                  	call	cmd_parse	;AN000; call parser
 29084 00003AFA 83F8FF                  	cmp	ax,END_OF_LINE	;AN000; are we at end of line?
 29085                                  	;cmp	ax,-1 ; 0FFFFh
 29086 00003AFD 7503                    	jne	short BADONF_flags
 29087                                  				;AN000; NO, return error
 29088 00003AFF 9D                      	popf			;AN000; restore flags
 29089 00003B00 F8                      	clc			;AC000; no error
 29090                                  	;jmp	short on_off_end
 29091                                  				;AN000; return to caller
 29092                                  	; 26/04/2023
 29093 00003B01 C3                      	retn
 29094                                  
 29095                                  BADONF_flags:
 29096 00003B02 89C1                    	mov	cx,ax
 29097 00003B04 9D                      	popf
 29098                                  
 29099                                  ; ---------------------------------------------------------------------------
 29100                                  
 29101                                  ; No discernable ON or OFF has been found. Put an error message pointer in DX
 29102                                  ; and return the error
 29103                                  
 29104                                  BADONF:
 29105 00003B05 BA[3491]                	mov	dx,bad_on_off_ptr
 29106 00003B08 F9                      	stc
 29107                                  on_off_end:
 29108 00003B09 C3                      	retn
 29109                                  
 29110                                  ;============================================================================
 29111                                  ; TUCODE.ASM, MSDOS 6.0, 1991 (2)
 29112                                  ;============================================================================
 29113                                  ; 02/10/2018 - Retro DOS v3.0
 29114                                  
 29115                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 29BFh
 29116                                  
 29117                                  ; =============== S U B	R O U T	I N E =======================================
 29118                                  
 29119                                  	; 20/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29120                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3876h
 29121                                  	
 29122                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29123                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3E20h
 29124                                  PRINT_DATE:
 29125                                  	; 20/03/2023
 29126                                  	; MSDOS 3.3
 29127                                  	;push	es
 29128                                  	;push	di
 29129                                  	;push	cs
 29130                                  	;pop	es
 29131                                  	;mov	di,ARG_BUF
 29132                                  	;mov	ah,Get_Date ; 2Ah
 29133                                  	;int	21h	; DOS -	GET CURRENT DATE
 29134                                  	;		; Return: DL = day,DH = month,	CX = year
 29135                                  	;		; AL = day of the week (0=Sunday,1=Monday,etc.)
 29136                                  	;cbw
 29137                                  	;call	GETDATE
 29138                                  	;call	P_DATE
 29139                                  	;xor	al,al
 29140                                  	;stosb
 29141                                  	;mov	dx,ARG_BUF_PTR
 29142                                  	;call	STD_PRINTF
 29143                                  		; 20/03/2023 (MSDOS 3.3 COMMAND.COM - TRANGROUP:29DAh)
 29144                                  	;pop	es ; !!??!! 
 29145                                  	;pop	di
 29146                                  	;retn
 29147                                  
 29148                                  	; 20/03/2023
 29149                                  	; MSDOS 6.0
 29150 00003B0A 06                      	push	es
 29151 00003B0B 57                      	push	di
 29152 00003B0C 0E                      	push	cs
 29153 00003B0D 07                      	pop	es
 29154 00003B0E E81300                  	call	GetDate 		; get date
 29155 00003B11 86F2                    	xchg	dh,dl			;AN000; switch month & day
 29156 00003B13 890E[0A92]              	mov	[promptDat_yr],cx 	;AC000; put year into message control block
 29157 00003B17 8916[0C92]              	mov	[promptDat_moday],dx	;AC000; put month and day into message control block
 29158 00003B1B BA[FA91]                	mov	dx,promptdat_ptr	;AC000; set up message for output
 29159 00003B1E E8FC18                  	call	std_printf
 29160                                  	;AD061; mov word [promptDat_yr],0 ;AC000; reset year, month and day
 29161                                  	;AD061; mov word [promptDat_moday],0 ;AC000; pointers in control block
 29162 00003B21 5F                      	pop	di			;AC000; restore di,es
 29163 00003B22 07                      	pop	es			;AC000;
 29164 00003B23 C3                      	retn
 29165                                  
 29166                                  ; ---------------------------------------------------------------------------
 29167                                  
 29168                                  	; 21/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29169                                  
 29170                                  ;GETDATE:
 29171                                  	; 21/03/2023
 29172                                  	; MSDOS 3.3
 29173                                  	;mov	si,ax
 29174                                  	;shl	si,1
 29175                                  	;add	si,ax
 29176                                  	;add	si,WEEKTAB ; "SunMonTueWedThuFriSat"
 29177                                  	;mov	bx,cx
 29178                                  	;mov	cx,3
 29179                                  	;rep	movsb
 29180                                  	;mov	al,' '
 29181                                  	;stosb
 29182                                  	;retn
 29183                                  
 29184                                  	; 21/03/2023
 29185                                  	; MSDOS 6.0
 29186                                  
 29187                                  ; Do GET DATE system call and set up 3 character day of week in ARG_BUF
 29188                                  ; for output. Date will be returned in CX,DX.
 29189                                  
 29190                                  GetDate:
 29191 00003B24 BF[F5A3]                	mov	di,Arg_Buf		;AC000; target for day of week
 29192 00003B27 B42A                    	mov	ah,Get_Date ;2Ah	;AC000; get current date
 29193 00003B29 CD21                    	int	21h			;AC000; Get date in CX:DX
 29194 00003B2B 98                      	cbw				;AC000;
 29195 00003B2C 51                      	push	cx			;AN000; save date returned in
 29196 00003B2D 52                      	push	dx			;AN000;  CX:DX
 29197 00003B2E 89C6                    	mov	si,ax
 29198 00003B30 D1E6                    	shl	si,1
 29199 00003B32 01C6                    	add	si,ax			; SI=AX*3
 29200 00003B34 89F1                    	mov	cx,si			;AN000; save si
 29201 00003B36 A1[BD90]                	mov	ax,[WeekTab]		;AN000; get message number of weektab
 29202 00003B39 B6FF                    	mov	dh,util_msg_class ;0FFh	;AN000; this is a utility message
 29203 00003B3B 57                      	push	di			;AN000; save argument buffer
 29204 00003B3C E8C319                  	call	TSYSGETMSG		;AN000; get the address of the message
 29205 00003B3F 5F                      	pop	di			;AN000; retrieve argument buffer
 29206 00003B40 01CE                    	add	si,cx			;AC000; get day of week
 29207 00003B42 B90300                  	mov	cx,3
 29208 00003B45 F3A4                      	rep	movsb
 29209 00003B47 B000                    	mov	al,END_OF_LINE_OUT ; 0	;AC000; terminate the string
 29210 00003B49 AA                      	stosb
 29211 00003B4A 5A                      	pop	dx			;AN000; get back date
 29212 00003B4B 59                      	pop	cx			;AN000;
 29213 00003B4C C3                      	retn
 29214                                  
 29215                                  ; =============== S U B	R O U T	I N E =======================================
 29216                                  
 29217                                  	; 21/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29218                                  
 29219                                  	; MSDOS 6.0
 29220                                  
 29221                                  ; This routine determines whether the character in AL is a
 29222                                  ; Yes or No character. On return, if AL=0, the character is
 29223                                  ; No, if AL=1, the character is Yes.
 29224                                  
 29225                                  ;	assume	ds:trangroup
 29226                                  
 29227                                  char_in_xlat:	; proc	near
 29228                                  	; 21/03/2023
 29229 00003B4D 88C2                    	mov	dl,al			;AC000; get character into DX
 29230 00003B4F 30F6                    	xor	dh,dh			;AC000;
 29231                                  	;mov	ax,(GetExtCntry<<8)+35	;AC000; Yes/No char call
 29232 00003B51 B82365                  	mov	ax,6523h
 29233 00003B54 CD21                    	int	21h			;AC000;
 29234 00003B56 C3                      	retn
 29235                                  
 29236                                  ;char_in_xlat	endp
 29237                                  
 29238                                  ;============================================================================
 29239                                  ; TENV.ASM, MSDOS 6.0, 1991
 29240                                  ;============================================================================
 29241                                  ; 02/10/2018 - Retro DOS v3.0
 29242                                  
 29243                                  ;	Environment utilities and misc. routines
 29244                                  
 29245                                  ; MSDOS 6.0
 29246                                  ; ****************************************************************
 29247                                  ; *
 29248                                  ; * ROUTINE:	 UPCONV     (ADDED BY EMG 4.00)
 29249                                  ; *
 29250                                  ; * FUNCTION:	 This routine returns the upper case equivalent of
 29251                                  ; *		 the character in AL from the file upper case table
 29252                                  ; *		 in DOS if character if above  ascii 128, else
 29253                                  ; *		 subtracts 20H if between "a" and "z".
 29254                                  ; *
 29255                                  ; * INPUT:	 AL	      char to be upper cased
 29256                                  ; *		 FUCASE_ADDR  set to the file upper case table
 29257                                  ; *
 29258                                  ; * OUTPUT:	 AL	      upper cased character
 29259                                  ; *
 29260                                  ; ****************************************************************
 29261                                  ;
 29262                                  ;assume	ds:trangroup				;AN000;
 29263                                  ;
 29264                                  ;upconv	proc	near				;AN000;
 29265                                  ;
 29266                                  ;	cmp	al,80h				;AN000;  see if char is > ascii 128
 29267                                  ;	jb	oth_fucase			;AN000;  no - upper case math
 29268                                  ;	sub	al,80h				;AN000;  only upper 128 chars in table
 29269                                  ;	push	ds				;AN000;
 29270                                  ;	push	bx				;AN000;
 29271                                  ;	mov	ds,[resseg]			;AN000;  get resident data segment
 29272                                  ;assume	ds:resgroup				;AN000;
 29273                                  ;	lds	bx,dword ptr FUCase_Addr+1	;AN000;  get table address
 29274                                  ;	add	bx,2				;AN000;  skip over first word
 29275                                  ;	xlat	ds:byte ptr [bx]		;AN000;  convert to upper case
 29276                                  ;	pop	bx				;AN000;
 29277                                  ;	pop	ds				;AN000;
 29278                                  ;assume	ds:trangroup				;AN000;
 29279                                  ;	jmp	short upconv_end		;AN000;  we finished - exit
 29280                                  ;
 29281                                  ;oth_fucase:					;AN000;
 29282                                  ;	cmp	al,small_a			;AC000; if between "a" and "z",
 29283                                  ;	jb	upconv_end			;AC000;     subtract 20h to get
 29284                                  ;	cmp	al,small_z			;AC000;    upper case equivalent.
 29285                                  ;	ja	upconv_end			;AC000;
 29286                                  ;	sub	al,20h				;AC000; Change lower-case to upper
 29287                                  ;
 29288                                  ;upconv_end:					;AN000;
 29289                                  ;	ret
 29290                                  ;
 29291                                  ;upconv	endp					;AN000;
 29292                                  
 29293                                  ;============================================================================
 29294                                  ; COPY.ASM, MSDOS 6.0, 1991
 29295                                  ;============================================================================
 29296                                  ; 01/10/2018 - Retro DOS v3.0
 29297                                  
 29298                                  ;	title	COMMAND COPY routines.
 29299                                  
 29300                                  ;/*
 29301                                  ; *                      Microsoft Confidential
 29302                                  ; *                      Copyright (C) Microsoft Corporation 1991
 29303                                  ; *                      All Rights Reserved.
 29304                                  ; */
 29305                                  
 29306                                  ;***	COPY.ASM
 29307                                  
 29308                                  ;Source files:  copy.asm, copypr1.asm, copypr2.asm
 29309                                  
 29310                                  
 29311                                  ;***	MODIFICATION HISTORY
 29312                                  
 29313                                  ;11/01/83 EE  Added a few lines at the end of SCANSRC2 to get multiple
 29314                                  ;	     file concatenations (eg copy a.*+b.*+c.*) to work properly.
 29315                                  ;11/02/83 EE  Commented out the code in CPARSE which added drive designators
 29316                                  ;	     to tokens which begin with path characters so that PARSELINE
 29317                                  ;	     will work correctly.
 29318                                  ;11/04/83 EE  Commented out the code in CPARSE that considered paren's to be
 29319                                  ;	     individual tokens. That distinction is no longer needed for
 29320                                  ;	     FOR loop processing.
 29321                                  ;11/17/83 EE  CPARSE upper case conversion is now flag dependent. Flag is
 29322                                  ;	     1 when Cparse is called from COPY.
 29323                                  ;11/17/83 EE  Took out the comment chars around code described in 11/04/83
 29324                                  ;	     mod. It now is conditional on flag like previous mod.
 29325                                  ;11/21/83 NP  Added printf
 29326                                  ;12/09/83 EE  CPARSE changed to use CPYFLAG to determine when a colon should
 29327                                  ;	     be added to a token.
 29328                                  ;05/30/84 MZ  Initialize all copy variables. Fix confusion with destclosed
 29329                                  ;	     NOTE: DestHand is the destination handle. There are two
 29330                                  ;	     special values: -1 meaning destination was never opened and
 29331                                  ;	     0 which means that the destination has been openned and
 29332                                  ;	     closed.
 29333                                  ;06/01/84 MZ  Above reasoning totally specious. Returned things to normal
 29334                                  ;06/06/86 EG  Change to fix problem of source switches /a and /b getting
 29335                                  ;	     lost on large and multiple file (wildcard) copies.
 29336                                  ;06/09/86 EG  Change to use xnametrans call to verify that source and
 29337                                  ;	     destination are not equal.
 29338                                  ;
 29339                                  ;06/24/90 DO  If the destination of a file concatenation is the same as
 29340                                  ;	     first source file AND we run out of disk space before
 29341                                  ;	     completing the concatenation, restore the first source
 29342                                  ;	     file as best we can. See SeekEnd and CopErr. Bug #859.
 29343                                  ;
 29344                                  ;M031 SR 10/11/90  Bug #3069. Use deny write sharing mode to open files
 29345                                  ;		instead of compatibility mode. This gives lesser sharing
 29346                                  ;		violations when files are opened for read on a copy.
 29347                                  
 29348                                  ; ---------------------------------------------------------------------------
 29349                                  ;***	COPY CODE
 29350                                  ; ---------------------------------------------------------------------------
 29351                                  
 29352                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2A15h
 29353                                  
 29354                                  ; 23/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29355                                  ; MSDOS 5.0 - COMMAND.COM, transient portion/segment offset 38C3h
 29356                                  
 29357                                  ; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29358                                  ; MSDOS 6.22 - COMMAND.COM, transient portion/segment offset 3E6Dh
 29359                                  
 29360                                  COPY:
 29361                                  	; 	Initialize internal variables.
 29362                                  
 29363 00003B57 31C0                    	xor	ax,ax		; AX = 0
 29364 00003B59 A3[039E]                	mov	[Copy_num],ax	; # files copied (destinations) = 0
 29365 00003B5C A3[319F]                	mov	[SRCPT],ax	; cmd line ptr for source scan = 0
 29366 00003B5F A3[7D9E]                	mov	[SrcTail],ax	; ptr to last element of source pathname = 0
 29367 00003B62 A2[729C]                	mov	[CFLAG],al	; 'destination file created' = false
 29368 00003B65 A3[789C]                	mov	[NXTADD],ax	; ptr into TPA buffer = 0
 29369 00003B68 A3[6E9C]                	mov	[DestSwitch],ax	; destination switches = none
 29370 00003B6B A3[559F]                	mov	[STARTEL],ax	; CParse ptr to last pathname element = 0
 29371 00003B6E A3[1A9E]                	mov	[DestTail],ax	; ptr to last element of dest pathname = 0
 29372 00003B71 A2[739C]                	mov	[DestClosed],al	; 'destination file closed' = false
 29373 00003B74 A2[199E]                	mov	[DestSiz],al	; length of destination pathname = 0
 29374 00003B77 A2[7C9E]                	mov	[SrcSiz],al	; length of source pathname = 0
 29375 00003B7A A2[1C9E]                	mov	[DestInfo],al	; destination pathname flags = none
 29376 00003B7D A2[7F9E]                	mov	[SrcInfo],al	; source pathname flags = none
 29377 00003B80 A2[339F]                	mov	[INEXACT],al	; 'inexact copy' = false
 29378 00003B83 A2[189E]                	mov	[DestVars],al	; 'dest pathname is directory' = false  ;*!*
 29379 00003B86 A2[7B9E]                	mov	[SrcVars],al	; 'source pathname is directory' = false
 29380 00003B89 A2[359B]                	mov	[USERDIR1],al	; saved working directory = null
 29381 00003B8C A2[349F]                	mov	[NOWRITE],al	; 'no write' (source = dest) = false
 29382 00003B8F A2[669C]                	mov	[RDEOF],al	; 'read end of file' = false
 29383 00003B92 A3[D79E]                	mov	[SRCHAND],ax	; source handle = 0
 29384 00003B95 A3[3C9F]                	mov	[CPDATE],ax	; copy date = 0
 29385 00003B98 A3[3E9F]                	mov	[CPTIME],ax	; copy time = 0
 29386 00003B9B A2[D99E]                	mov	[SRCISDEV],al	; 'source is device' = false
 29387                                  	; 23/03/2023
 29388                                  	; MSDOS 6.0 (& MSDOS 5.0) COMMAND.COM	
 29389 00003B9E A2[449F]                	mov	[OCtrlZ],al	; 'Ctrl+Z removed from original' = false
 29390 00003BA1 A3[409F]                	mov	[OFilePtr_Lo],ax
 29391 00003BA4 A3[429F]                	mov	[OFilePtr_Hi],ax ; original destination file ptr = null
 29392 00003BA7 A2[389F]                	mov	[TERMREAD],al	; 'terminate read' = false
 29393 00003BAA A2[F69D]                	mov	[comma],al	; '"+,," found' = false
 29394 00003BAD A2[F79D]                	mov	[plus_comma],al ; '"+,," found last time' = false (?)
 29395 00003BB0 A2[929F]                	mov	[msg_flag],al	;AN022; 'non-utility msg issued' = false
 29396 00003BB3 A3[709C]                	mov	[AllSwitch],ax	; all switches = none
 29397 00003BB6 A2[699C]                	mov	[ArgC],al	; source/dest argument count = 0
 29398 00003BB9 A2[3A9F]                	mov	[PLUS],al	; '"+" in command line' = false
 29399 00003BBC A2[359F]                	mov	[BINARY],al	; 'binary copy' = false
 29400 00003BBF A2[399F]                	mov	[ASCII],al	; 'ascii copy' = false
 29401 00003BC2 A3[819C]                	mov	[FileCnt],ax	; # files copied (destinations) = 0
 29402 00003BC5 A3[369F]                	mov	[WRITTEN],ax	; 'destination written to' = false
 29403 00003BC8 A2[689C]                	mov	[Concat],al	; 'concatenating' = false
 29404 00003BCB A2[789E]                	mov	[MELCOPY],al	; 'Mel Hallerman copy' = false
 29405 00003BCE A3[799E]                	mov	[MELSTART],ax	; Mel Hallerman cmd line ptr = 0
 29406                                  	
 29407                                  	; 12/06/2023
 29408                                  	; MSDOS 6.22 COMMAND.COM
 29409                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29410 00003BD1 A2[519F]                	mov     [cox_dest_file], al ; MSDOS 6.22
 29411 00003BD4 A2[529F]                	mov     [cox_src_file], al  ; MSDOS 6.22
 29412                                  
 29413                                  	;	Initialize buffers with double-nulls.
 29414                                  
 29415 00003BD7 A3[DA9E]                	mov	[ScanBuf],ax
 29416 00003BDA A3[1D9E]                	mov	[DestBuf],ax
 29417 00003BDD A3[809E]                	mov	[SrcBuf],ax
 29418 00003BE0 A3[E09D]                	mov	[SDIRBUF],ax
 29419 00003BE3 A3[9A9D]                	mov	[DIRBUF],ax
 29420 00003BE6 A3[579D]                	mov	[DestFcb],ax
 29421                                  
 29422 00003BE9 A2[3B9F]                	mov	[objcnt],al	; # CParse cmd-line objects found = 0
 29423                                  		
 29424 00003BEC 48                      	dec	ax ; -1		; AX = 0FFFFh
 29425 00003BED A3[749E]                	mov	[DESTHAND],ax	; destination handle = 'never opened'
 29426 00003BF0 A2[7A9C]                	mov	[FRSTSRCH],al	; 'first search for source' = true
 29427 00003BF3 A2[779E]                	mov	[FIRSTDEST],al	; 'first time for dest' = true
 29428 00003BF6 A2[189E]                	mov	[DestIsDir],al	; 'haven't analyzed destination' ; *!*
 29429                                  
 29430                                  	; 12/06/2023
 29431                                  	; Retro DOS v4.2 COMMAND.COM
 29432                                  	; MSDOS 6.22 COMMAND.COM code only !
 29433                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29434                                  	;
 29435 00003BF9 E8F306                  	call	init_copycmd_option ; MSDOS 6.22 
 29436                                  		
 29437 00003BFC BE8100                  	mov	si,81h		; SI = ptr to command line
 29438                                  	;mov	bl,[PLUS_CHR]	; BL = special delimiter = "+"
 29439                                  	; 23/03/2023
 29440 00003BFF B32B                    	mov	bl,'+'
 29441 00003C01 FE06[919F]              	inc	byte [expand_star] ; CParse 'expand * to ?s' = true
 29442 00003C05 C606[059E]01            	mov	byte [cpyflag],1 ; CParse 'called from COPY' = true
 29443                                  
 29444                                  	;*	Scan the command line for destination information.
 29445                                  
 29446                                  DESTSCAN:
 29447 00003C0A 31ED                    	xor	bp,bp			; BP = switch flag accumulator
 29448 00003C0C BF[DA9E]                	mov	di,ScanBuf		; ES:DI = ptr to pathname buf
 29449                                  	; 23/03/2023
 29450 00003C0F 8936[F99D]              	mov	[parse_last],si		;AN018; save cmd line ptr
 29451 00003C13 E8710B                  	call	cparse			; parse next object
 29452 00003C16 9C                      	pushf	; (*)			; save CParse flags
 29453 00003C17 FE06[3B9F]              	inc	byte [objcnt]		; count object
 29454 00003C1B F6C780                  	test	bh,80h
 29455 00003C1E 7405                    	jz	short NOCOPY		; no "+" delimiter
 29456 00003C20 C606[3A9F]01            	mov	byte [PLUS],1		; "+" delimiter occurred
 29457                                  NOCOPY:
 29458 00003C25 F6C701                  	test	bh,1
 29459 00003C28 747D                    	jz	short TESTP2		; not a switch
 29460                                  
 29461                                  	;	Found a switch.
 29462                                  
 29463                                  	; 23/03/2023 - Retro DOS v4.0 COMMAND.COM
 29464                                  	;
 29465                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29466                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3F43h
 29467                                  CHK_CP_SWITCH:
 29468                                  	; MSDOS 6.0
 29469 00003C2A F7C51000                	test	bp,10h
 29470                                  	;test	bp,SwitchV ; 10h	;AN038; Verify requested?
 29471 00003C2E 740B                    	jz	short NOT_SLASHV	;AN038; No - set the switch
 29472                                  	;test	word [AllSwitch],10h
 29473 00003C30 F606[709C]10            	test	byte [AllSwitch],10h
 29474                                  	;test	byte [AllSwitch],SwitchV ;AN038; Verify already entered?
 29475 00003C35 7404                    	jz	short NOT_SLASHV	;AN038; No - set the switch
 29476                                  ;AD018; ;or	word [AllSwitch],FBadSwitch ;AN038; Set up bad switch
 29477                                  	;or	bp,FBadSwitch		;AN018; Set up bad switch
 29478 00003C37 81CD0040                	or	bp,4000h
 29479                                  NOT_SLASHV:
 29480                                  	; ****************************************
 29481                                  	; 12/06/2023
 29482                                  	; Retro DOS v4.2 COMMAND.COM
 29483                                  	; MSDOS 6.22 COMMAND.COM code only !
 29484                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29485                                  	; ****************************************
 29486                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:3F55h
 29487                                  	;
 29488 00003C3B F7C54000                	test    bp,40h			; negative Y (-Y) switch flag
 29489 00003C3F 7417                    	jz	short CHK_SLASHY0
 29490                                  	;
 29491                                  	;test	word [AllSwitch],40h
 29492 00003C41 F606[709C]40            	test	byte [AllSwitch],40h	; [AllSwitch] negative (-Y) flag
 29493 00003C46 7507                    	jnz	short NOT_SLASHY1	; N flag
 29494                                  	;test	word [AllSwitch],80h
 29495 00003C48 F606[709C]80            	test	byte [AllSwitch],80h	; [AllSwitch] SwitchY (Y) flag
 29496 00003C4D 7404                    	jz	short NOT_SLASHY2
 29497                                  NOT_SLASHY1:
 29498 00003C4F 81CD0040                	or	bp,4000h		; FBadSwitch (Repetitive)
 29499                                  NOT_SLASHY2:				; Set up bad switch
 29500 00003C53 C606[509F]00            	mov	byte [cox_y_override],0	; cox_y setting will be used
 29501                                  CHK_SLASHY0:
 29502 00003C58 F7C58000                	test    bp,80h
 29503 00003C5C 742B                    	jz      short CHK_SLASHY4	; not a /Y switch
 29504                                  	;
 29505 00003C5E 8A04                    	mov	al,[si]
 29506 00003C60 3C79                    	cmp	al,'y'
 29507 00003C62 740A                    	je	short CHK_SLASHY1
 29508 00003C64 3C59                    	cmp	al,'Y'
 29509 00003C66 7406                    	je	short CHK_SLASHY1
 29510 00003C68 81CD0040                	or	bp,4000h		; FBadSwitch
 29511                                  	;				; Set up bad switch
 29512 00003C6C EB1B                    	jmp	short CHK_SLASHY4
 29513                                  CHK_SLASHY1:
 29514 00003C6E C60420                  	mov	byte [si],20h ; ' '
 29515 00003C71 46                      	inc	si
 29516                                  	;test	word [AllSwitch],40h
 29517 00003C72 F606[709C]40            	test	byte [AllSwitch],40h	; [AllSwitch] negative (-Y) flag
 29518 00003C77 7507                    	jnz	short CHK_SLASHY2	; N flag
 29519                                  	;test	word [AllSwitch],80h
 29520 00003C79 F606[709C]80            	test	byte [AllSwitch],80h	; [AllSwitch] SwitchY (Y) flag
 29521 00003C7E 7404                    	jz	short CHK_SLASHY3
 29522                                  CHK_SLASHY2:
 29523 00003C80 81CD0040                	or	bp,4000h		; FBadSwitch (Repetitive)
 29524                                  	;				; Set up bad switch
 29525                                  CHK_SLASHY3:
 29526 00003C84 C606[509F]01            	mov	byte [cox_y_override],1
 29527                                  CHK_SLASHY4:
 29528                                  	; ****************************************
 29529                                  	; 12/06/2023
 29530                                  ;NOT_SLASHV:
 29531                                  	;or	[DestSwitch],bp		; assume destination
 29532                                  	;or	[AllSwitch],bp		; keep tabs on all switches
 29533                                  
 29534                                  	; 12/06/2023
 29535                                  	; Retro DOS v4.2 COMMAND.COM
 29536                                  	; MSDOS 6.22 COMMAND.COM -TRANGROUP:3FA7h
 29537 00003C89 092E[6E9C]              	or	[DestSwitch],bp		; set [DestSwitch] SwitchY flag to 1
 29538 00003C8D 092E[709C]              	or	[AllSwitch],bp		; set [AllSwitch] SwitchY flag to 1
 29539                                  	;test	bp,~SwitchCopy		; Bad switch?
 29540 00003C91 F7C5237F                	test	bp,7F23h ; MSDOS 6.22	; ~SwitchCopy ; not SwitchCopy
 29541 00003C95 740A                    	jz	short NOT_BAD_SWITCH	; Switches are okay
 29542                                  
 29543                                  	; 12/06/2023
 29544                                  	; 23/03/2023
 29545                                  	; MSDOS 6.0
 29546                                  	;;test	bp,not SwitchCopy	;AN018; Bad switch?
 29547                                  	;test	bp,7FE3h ; test bp,~SwitchCopy
 29548                                  	;jz	short NOT_BAD_SWITCH	;AN018; Switches are okay
 29549                                  	
 29550 00003C97 9D                      	popf	; (*)			;AN018; fix up stack
 29551 00003C98 B80300                  	mov	ax,BadSwt_Ptr ; 3	;AN018; get "Invalid switch" message number
 29552 00003C9B E8CAE8                  	call	setup_parse_error_msg	;AN018; setup to print the message
 29553 00003C9E E983F0                  	jmp	cerror			;AC018; exit
 29554                                  NOT_BAD_SWITCH:
 29555 00003CA1 9D                      	popf				; restore CParse flags
 29556 00003CA2 7235                    	jc	short CHECKDONE		; found CR
 29557 00003CA4 E963FF                  	jmp	DESTSCAN		; continue scanning for destination
 29558                                  TESTP2:
 29559 00003CA7 9D                      	popf	; (*)			; restore CParse flags
 29560 00003CA8 722F                    	jc	short CHECKDONE		; found CR
 29561 00003CAA F6C780                  	test	bh,80h
 29562 00003CAD 7504                    	jnz	short GOTPLUS		; found a "+pathname" argument
 29563 00003CAF FE06[699C]              	inc	byte [ArgC]		; count independent pathname args
 29564                                  GOTPLUS:
 29565 00003CB3 56                      	push	si			; save cmd line ptr
 29566 00003CB4 A1[559F]                	mov	ax,[STARTEL]		; AX = ptr to last path element
 29567 00003CB7 BE[DA9E]                	mov	si,ScanBuf		; SI = ptr to path string
 29568 00003CBA 29F0                    	sub	ax,si			; AX = offset of last element
 29569 00003CBC BF[1D9E]                	mov	di,DestBuf		; DI = ptr to destination buf
 29570 00003CBF 01F8                    	add	ax,di			; AX = ptr to last element in
 29571                                  					;  destination path buffer
 29572 00003CC1 A3[1A9E]                	mov	[DestTail],ax		; save ptr to last element
 29573 00003CC4 880E[199E]              	mov	[DestSiz],cl		; save path string length
 29574 00003CC8 41                      	inc	cx			; CX = mov length (incl null)
 29575 00003CC9 F3A4                    	rep	movsb			; DestBuf = possible destination path
 29576 00003CCB 883E[1C9E]              	mov	[DestInfo],bh		; save CParse info flags
 29577 00003CCF C706[6E9C]0000          	mov	word [DestSwitch],0	; clear destination switches
 29578 00003CD5 5E                      	pop	si			; SI = ptr into cmd line again
 29579 00003CD6 E931FF                  	jmp	DESTSCAN		;AC018; continue scanning for dest
 29580                                  
 29581                                  CHECKDONE:
 29582                                  	;	We reached the CR. The destination scan is finished.
 29583                                  
 29584                                  	;	Disallow "copy file1+" as file overwriting itself.
 29585                                  	;
 29586                                  	;	(Note that "copy file1+file2+" will be accepted, and
 29587                                  	;	equivalent to "copy file1+file2".)
 29588                                  
 29589                                  	;	Bugbug: it looks like "copy /x file1+" would slip
 29590                                  	;	through this check, since the switch would count
 29591                                  	;	as another object in ObjCnt.
 29592                                  
 29593 00003CD9 803E[3A9F]01            	cmp	byte [PLUS],1		; "+" with
 29594 00003CDE 7514                    	jnz	short CDCONT
 29595 00003CE0 803E[699C]01            	cmp	byte [ArgC],1		; one arg,
 29596 00003CE5 750D                    	jnz	short CDCONT
 29597 00003CE7 803E[3B9F]02            	cmp	byte [objcnt],2		; two objects..
 29598 00003CEC 7506                    	jnz	short CDCONT
 29599 00003CEE BA[F78F]                	mov	dx,OVERWR_PTR
 29600 00003CF1 E9AE07                  	jmp	COPYERR			; is file overwrite
 29601                                  
 29602                                  CDCONT:
 29603 00003CF4 A0[3A9F]                	mov	al,[PLUS]		; AL = '"+" occurred'
 29604 00003CF7 A2[689C]                	mov	[Concat],al		; if "+" occurred, we're concatenating
 29605 00003CFA D0E0                    	shl	al,1
 29606 00003CFC D0E0                    	shl	al,1
 29607 00003CFE A2[339F]                	mov	[INEXACT],al		; therefore making an inexact copy
 29608                                  	;mov	dx,BADARGSPTR ; MSDOS 3.3 ; 18/04/2023
 29609 00003D01 A0[699C]                	mov	al,[ArgC]		; AL = # independent arguments
 29610                                  
 29611                                  	; 23/03/2023
 29612                                  	; MSDOS 3.3		
 29613                                  	;or	al,al
 29614                                  	;jz	short CERROR4J
 29615                                  	; MSDOS 6.0
 29616 00003D04 08C0                    	or	al,al
 29617 00003D06 750B                    	jnz	short TRY_TOO_MANY	; more than 0 args; check if too many
 29618                                  		
 29619 00003D08 BA[CB8F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29620 00003D0B C706[CB8F]0200          	mov	word [extend_buf_ptr],LessArgs_Ptr ; 2
 29621                                  	;mov	word [extend_buf_ptr],2	; set msg # "param missing"
 29622 00003D11 EB0D                    	jmp	short CERROR_PARSEJ	; take parse error exit		
 29623                                  
 29624                                  	; more than 0 args; check if too many
 29625                                  TRY_TOO_MANY:
 29626 00003D13 3C02                    	cmp	al,2
 29627 00003D15 7611                    	jbe	short ACOUNTOK		; <= 2 arguments - ok
 29628                                  
 29629                                  	; 23/03/2023
 29630                                  	; MSDOS 6.0
 29631 00003D17 BA[CB8F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29632 00003D1A C706[CB8F]0100          	mov	word [extend_buf_ptr],MoreArgs_Ptr
 29633                                  	;mov	word [extend_buf_ptr],1 ; set msg # "too many params"
 29634                                  CERROR_PARSEJ:
 29635 00003D20 C606[C98F]02            	mov	byte [msg_disp_class],parse_msg_class ; 2
 29636                                  					; parse error message	
 29637                                  CERROR4J:
 29638 00003D25 E9FCEF                  	jmp	cerror
 29639                                  
 29640                                  ACOUNTOK:
 29641 00003D28 BD[189E]                	mov	bp,DestVars		; BP = base of dest variables
 29642                                  
 29643 00003D2B 3C01                    	cmp	al,1
 29644 00003D2D 7520                    	jnz	short GOT2ARGS
 29645                                  
 29646                                  	;	Only one independent pathname argument on command line.
 29647                                  	;	Set destination to d:*.*, where d: is current drive.
 29648                                  
 29649                                  	;	Bugbug: but is this appropriate for "copy x:file1+x:file2"?
 29650                                  	;	The two files would be appended as d:file1, rather than x:file1.
 29651                                  
 29652 00003D2F A0[679C]                	mov	al,[CURDRV]		; AL = current drive (0 = A)
 29653                                  	;add	al,[CAPITAL_A]		; AL = current drive letter
 29654                                  	; 23/03/2023
 29655 00003D32 0441                    	add	al,'A'
 29656 00003D34 B43A                    	mov	ah,':'			; AX = "d:"
 29657                                  	;mov	byte [bp+1],2
 29658 00003D36 C6460102                	mov	byte [bp+VARSTRUC.SIZ],2 ; pathname length = 2
 29659                                  
 29660 00003D3A BF[1D9E]                	mov	di,DestBuf		; ES:DI = ptr to dest path buf
 29661 00003D3D AB                      	stosw				; store "d:"
 29662                                  		
 29663 00003D3E C706[6E9C]0000          	mov	word [DestSwitch],0	; clear destination switches
 29664                                  	;mov	byte [bp+4],2		
 29665 00003D44 C6460402                	mov	byte [bp+VARSTRUC.INFO],2 ; mark destination 'wildcard present'
 29666                                  	;mov	byte [bp+VARSTRUC.ISDIR],0 ; mark destination 'not a directory'
 29667                                  	;mov	byte [bp+0],0		
 29668 00003D48 C6460000                	mov	byte [bp],0
 29669 00003D4C E8090A                  	call	SETSTARS		; add wildcards
 29670                                  GOT2ARGS:
 29671                                  	;	If destination pathname is "d:", add full wildcard filename
 29672                                  
 29673                                  	;cmp	byte [bp+1],2
 29674 00003D4F 807E0102                	cmp	byte [bp+VARSTRUC.SIZ],2
 29675 00003D53 7516                    	jnz	short NOTSHORTDEST	; not two chars, can't be "d:"
 29676 00003D55 B03A                    	mov	al,':'  ; 3Ah
 29677 00003D57 3806[1E9E]              	cmp	byte [DestBuf+1],al
 29678 00003D5B 750E                    	jnz	short NOTSHORTDEST	; it's just a 2-character filename
 29679                                  	;or	byte [bp+4],2
 29680 00003D5D 804E0402                	or	byte [bp+VARSTRUC.INFO],2 ; mark destination 'wildcard present'
 29681 00003D61 BF[1F9E]                	mov	di,DestBuf+2		; ES:DI = ptr after "d:"
 29682                                  	;mov	byte [bp+VARSTRUC.ISDIR],0 ; mark destination 'not a directory'
 29683                                  	;mov	byte [bp+0],0		
 29684 00003D64 C6460000                	mov	byte [bp],0
 29685 00003D68 E8ED09                  	call	SETSTARS		; add wildcards
 29686                                  NOTSHORTDEST:
 29687                                  	;	If destination pathname ends with "\", try to make
 29688                                  	;	sure it's "d:\".
 29689                                  
 29690                                  	;mov	di,[bp+2]
 29691 00003D6B 8B7E02                  	mov	di,[bp+VARSTRUC.TTAIL]	; DI = ptr to last path element
 29692 00003D6E 803D00                  	cmp	byte [di],0
 29693 00003D71 7515                    	jnz	short CHKSWTCHES	; not a null, so last char not "\"
 29694                                  
 29695 00003D73 BA[2B91]                	mov	dx,badcd_ptr
 29696 00003D76 B03A                    	mov	al,':'
 29697 00003D78 3845FE                  	cmp	[di-2],al
 29698 00003D7B 75A8                    	jne	short CERROR4J		; it's not "d:\", exit with error msg
 29699                                  	;mov	byte [bp+0],2
 29700                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; destination 'is a directory'
 29701 00003D7D C6460002                	mov	byte [bp],2
 29702                                  	;or	byte [bp+4],6
 29703 00003D81 804E0406                	or	byte [bp+VARSTRUC.INFO],6 ; destination wildcarded and contains
 29704                                  					  ;  path character
 29705 00003D85 E8D009                  	call	SETSTARS		; add wildcards
 29706                                  CHKSWTCHES:
 29707                                  	;	We have enough information about the destination for now.
 29708                                  
 29709                                  	;	Turn on verify if requested. Save the current verify flag.
 29710                                  
 29711                                  	; 23/03/2023
 29712                                  	; MSDOS 6.0 (& MSDOS 5.0) COMMAND.COM
 29713                                  	;mov	dx,BADPARMPTR
 29714                                  	
 29715 00003D88 A1[709C]                	mov	ax,[AllSwitch]		; AX = all switch flags
 29716                                  
 29717                                  	; 23/03/2023
 29718                                  	; MSDOS 3.3
 29719                                  	;;test	ax,~SWITCHCOPY ; 7FE3h
 29720                                  	;test	ax,NOT_SWITCHCOPY ; 7FE3h ; 13/10/2018
 29721                                  	;jnz	short CERROR4J
 29722                                  	
 29723                                  	; 23/03/2023
 29724                                  	; MSDOS 3.3 (& MSDOS 6.0)
 29725                                  	;test	ax,SwitchV ; 10h
 29726                                  	; 18/04/2023
 29727                                  	;test	ax,10h
 29728 00003D8B A810                    	test	al,10h  ; test al,SwitchV
 29729 00003D8D 7414                    	jz	short NOVERIF		; no /v, no verify
 29730                                  
 29731 00003D8F B454                    	mov	ah,Get_Verify_On_Write ; 54h
 29732 00003D91 CD21                    	int	21h		; DOS -	2+ - GET VERIFY	FLAG
 29733                                  				; Return: AL = 00h if flag OFF
 29734                                  				; AL = 01h if flag ON
 29735 00003D93 1E                      	push	ds
 29736 00003D94 8E1E[539C]              	mov	ds,[RESSEG]
 29737 00003D98 30E4                    	xor	ah,ah
 29738 00003D9A A3[A702]                	mov	[VerVal],ax		; save current verify flag
 29739 00003D9D 1F                      	pop	ds
 29740 00003D9E B8012E                  	mov	ax,(SET_VERIFY_ON_WRITE<<8)|1 ; 2E01h
 29741 00003DA1 CD21                    	int	21h		; DOS -	SET VERIFY FLAG
 29742                                  				; DL = 00h,AL = 01h VERIFY on / 00h VERIFY off
 29743                                  NOVERIF:
 29744                                  	;*	Scan for first source.
 29745                                  
 29746 00003DA3 31ED                    	xor	bp,bp			; BP = switch flags accumulator
 29747 00003DA5 BE8100                  	mov	si,81h			; SI = ptr into command line
 29748                                  	;mov	bl,[PLUS_CHR]		; BL = special CParse delimiter = "+"
 29749                                  	; 23/03/2023
 29750 00003DA8 B32B                    	mov	bl,'+' ; 2Bh
 29751                                  SCANFSRC:
 29752 00003DAA BF[DA9E]                	mov	di,ScanBuf		; DI = ptr to pathname buf
 29753 00003DAD E8D709                  	call	cparse			; parse first source pathname
 29754 00003DB0 F6C701                  	test	bh,1			; switch?
 29755 00003DB3 75F5                    	jnz	short SCANFSRC		; yes, try again
 29756 00003DB5 092E[6E9C]              	or	[DestSwitch],bp		; include copy-wide switches on dest
 29757                                  
 29758                                  ;	Set ascii copying mode if concatenating, unless /b is specified.
 29759                                  
 29760                                  	; 23/03/2023
 29761 00003DB9 F7C50800                	test	bp,8
 29762                                  	;test	bp,SWITCHB
 29763 00003DBD 750C                    	jnz	short NOSETCASC		; /b - explicit binary copy
 29764 00003DBF 803E[689C]00            	cmp	byte [Concat],0
 29765 00003DC4 7405                    	jz	short NOSETCASC		; we're not concatenating
 29766 00003DC6 C606[399F]04            	mov	byte [ASCII],4
 29767                                  	;mov	byte [ASCII],SWITCHA	; set ascii copy
 29768                                  NOSETCASC:
 29769 00003DCB E82604                  	call	SOURCE_SET		; set source variables
 29770 00003DCE E84400                  	call	FRSTSRC			; set up first source copy
 29771 00003DD1 E99500                  	jmp	FIRSTENT		; jump into the copy loop
 29772                                  
 29773                                  ; ---------------------------------------------------------------------------
 29774                                  
 29775                                  	; 24/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29776                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3AE9h
 29777                                  ENDCOPY:
 29778                                  	;*	End of the road. Close destination, display # files
 29779                                  	;	copied (meaning # destinations), and go back to main
 29780                                  	;	transient COMMAND code.
 29781                                  
 29782 00003DD4 E83203                  	call	CLOSEDEST
 29783                                  ENDCOPY2:
 29784 00003DD7 BA[0090]                	mov	dx,copied_ptr
 29785 00003DDA 8B36[819C]              	mov	si,[FileCnt]
 29786 00003DDE 8936[039E]              	mov	[Copy_num],si
 29787 00003DE2 E83816                  	call	std_printf
 29788 00003DE5 E91CC3                  	jmp	TCOMMAND		; stack could be messed up
 29789                                  
 29790                                  ; ---------------------------------------------------------------------------
 29791                                  
 29792                                  SRCNONEXIST:
 29793                                  	;*	Source doesn't exist. If concatenating, ignore and continue.
 29794                                  	;	Otherwise, say 'file not found' and quit.
 29795                                  
 29796 00003DE8 803E[689C]00            	cmp	byte [Concat],0
 29797 00003DED 7543                    	jne	short NEXTSRC		; concatenating - go on to next source
 29798                                  
 29799                                  	; 24/03/2023
 29800                                  	; MSDOS 3.3
 29801                                  	;mov	dx,SRCBUF
 29802                                  	;mov	[STRING_PTR_1],dx
 29803                                  	;mov	dx,STRINGBUF1PTR
 29804                                  	;call	STD_PRINTF
 29805                                  	;mov	dx,FNOTFOUNDPTR
 29806                                  	;jmp	COPYERR
 29807                                  
 29808                                  	; 24/*03/2023
 29809                                  	; MSDOS 6.0
 29810                                  	;	Set up error message.
 29811 00003DEF C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 29812                                  				  	; extended error msg
 29813 00003DF4 BA[CB8F]                	mov	dx,extend_buf_ptr	; DX = ptr to msg block
 29814 00003DF7 C706[CB8F]0200          	mov	word [extend_buf_ptr],ERROR_FILE_NOT_FOUND ; 2
 29815                                  					; 'file not found' msg#
 29816 00003DFD C706[019E][809E]        	mov	word [string_ptr_2],SrcBuf
 29817                                  					; point at bad pathname
 29818 00003E03 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst ; 1
 29819                                  					; 1 substitution
 29820 00003E08 E99706                  	jmp	COPYERR			; print msg and clean up
 29821                                  
 29822                                  ; ---------------------------------------------------------------------------
 29823                                  
 29824                                  SOURCEPROC:
 29825                                  
 29826                                  	;*	Preparatory processing for each source file.
 29827                                  	;	Called at FrstSrc for first source file.
 29828                                  
 29829 00003E0B E8E603                  	call	SOURCE_SET		; set source variables & ascii/binary
 29830 00003E0E 803E[689C]00            	cmp	byte [Concat],0
 29831 00003E13 750B                    	jne	short LEAVECFLAG	; concatenating - leave CFlag alone
 29832                                  
 29833                                  ; ---------------------------------------------------------------------------
 29834                                  
 29835                                  FRSTSRC:
 29836 00003E15 31C0                    	xor	ax,ax
 29837 00003E17 A2[729C]                	mov	[CFLAG],al		; 'destination not created'
 29838 00003E1A A3[789C]                	mov	[NXTADD],ax		; copy buffer ptr = 0
 29839 00003E1D A2[739C]                	mov	[DestClosed],al		; 'destination not closed'
 29840                                  
 29841                                  LEAVECFLAG:
 29842 00003E20 8936[319F]              	mov	[SRCPT],si		; save cmd-line ptr
 29843 00003E24 BF[359B]                	mov	di,USERDIR1		; DI = ptr to buf for user's 
 29844                                  						;   current dir
 29845 00003E27 BD[7B9E]                	mov	bp,SrcVars		; BP = base of source variables
 29846 00003E2A E8DB07                  	call	BUILDPATH		; cd to source dir, figure
 29847                                  						;   out stuff about source
 29848 00003E2D 8B36[7D9E]              	mov	si,[SrcTail]		; SI = ptr to source filename
 29849 00003E31 C3                      	retn
 29850                                  
 29851                                  ; ---------------------------------------------------------------------------
 29852                                  
 29853                                  	; 25/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 29854                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 29855                                  NEXTSRC:
 29856                                  	;*	Next source. Come here after handling each pathname.
 29857                                  	;	We're done unless there are additional source pathnames
 29858                                  	;	to be appended.
 29859                                  	;
 29860                                  	;	Note that all files matching an ambiguous pathname
 29861                                  	;	are processed before coming here.
 29862                                  
 29863 00003E32 803E[3A9F]00            	cmp	byte [PLUS],0
 29864                                  	;jne	short MORECP		; copying "+" sources - keep going
 29865                                  	; 26/04/2023
 29866                                  ;ENDCOPYJ2:
 29867                                  	;jmp	short ENDCOPY
 29868 00003E37 749B                    	je	short ENDCOPY
 29869                                  MORECP:
 29870 00003E39 31ED                    	xor	bp,bp			; BP = switch flags accumulator
 29871 00003E3B 8B36[319F]              	mov	si,[SRCPT]		; SI = ptr to current pos'n in cmd line
 29872                                  	;mov	bl,[PLUS_CHR]		; BL = special delimiter = "+"
 29873 00003E3F B32B                    	mov	bl,'+' ; 2Bh
 29874                                  SCANSRC:
 29875 00003E41 BF[DA9E]                	mov	di,ScanBuf		; DI = ptr to pathname buf
 29876 00003E44 E84009                  	call	cparse			; parse first source name
 29877                                  	;jb	short ENDCOPYJ2		; CR found - we're done
 29878                                  	; 26/04/2023
 29879 00003E47 728B                    	jb	short ENDCOPY
 29880                                  
 29881 00003E49 F6C780                  	test	bh,80h
 29882                                  	;jz	short ENDCOPYJ2		; no "+" delimiter - we're done
 29883                                  	; 26/04/2023
 29884 00003E4C 7486                    	jz	short ENDCOPY
 29885                                  
 29886 00003E4E F6C701                  	test	bh,1
 29887 00003E51 75EE                    	jnz	short SCANSRC		; switch found - keep looking
 29888                                  
 29889                                  	;	ScanBuf contains the next source pathname.
 29890                                  
 29891 00003E53 E8B5FF                  	call	SOURCEPROC		; prepare this source
 29892 00003E56 803E[F69D]01            	cmp	byte [comma],1		; was +,, found last time?
 29893 00003E5B 7507                    	jnz	short NOSTAMP		;  no - try for a file
 29894 00003E5D C606[F79D]01            	mov	byte [plus_comma],1	; yes - set flag
 29895 00003E62 EB84                    	jmp	short SRCNONEXIST	; we know we won't find it
 29896                                  
 29897                                  NOSTAMP:
 29898 00003E64 C606[F79D]00            	mov	byte [plus_comma],0	; reset +,, flag
 29899                                  
 29900                                  ; ---------------------------------------------------------------------------
 29901                                  
 29902                                  FIRSTENT:
 29903                                  
 29904                                  ;M047
 29905                                  ; The only case we need to worry about is when the source is wildcarded and
 29906                                  ;the destination is not. For this case, ConCat is not yet set to indicate
 29907                                  ;concatenation. We check for this case.
 29908                                  ;
 29909                                  ;NB: This change has been backed out and replaced by M048. This is not the
 29910                                  ;right place to do this check.
 29911                                  
 29912                                  	;	This is where we enter the loop with the first source.
 29913                                  
 29914 00003E69 BF5C00                  	mov	di,FCB ; 5Ch		; DI = ptr to FCB
 29915 00003E6C B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 29916 00003E6F CD21                    	int	21h		; DOS -	PARSE FILENAME
 29917                                  				; DS:SI	-> string to parse
 29918                                  				; ES:DI	-> buffer to fill with unopened	FCB
 29919                                  				; AL = bit mask	to control parsing
 29920 00003E71 803C00                  	cmp	byte [si],0		; did we parse the whole thing?
 29921 00003E74 7516                    	jne	short SRCHDONE		; no, error, simulate 'not found'
 29922 00003E76 A1[809E]                	mov	ax,[SrcBuf]		; AX = possible "d:"
 29923 00003E79 80FC3A                  	cmp	ah,':'
 29924 00003E7C 7402                    	je	short DRVSPEC1		; AX = definite "d:"
 29925 00003E7E B040                    	mov	al,'@'	; 40h		; AL = drive 'letter' for current drive
 29926                                  DRVSPEC1:
 29927 00003E80 0C20                    	or	al,20h			; AL = lowercase drive letter
 29928 00003E82 2C60                    	sub	al,60h			; AL = drive id (0=current,1=A,..)
 29929                                  	;mov	[5Ch],al
 29930 00003E84 A25C00                  	mov	[FCB],al		; put drive id in FCB
 29931                                  
 29932                                  	;	FCB contains drive and filename to search.
 29933                                  		
 29934 00003E87 B411                    	mov	ah,Dir_Search_First ; 11h  ; AH = 'Find First File'	
 29935 00003E89 E86D01                  	call	SEARCH
 29936                                  SRCHDONE:
 29937 00003E8C 9C                      	pushf				; save flags from Search
 29938 00003E8D E891E9                  	call	RestUDir1		; restore users current directory
 29939 00003E90 9D                      	popf				; restore flags from search
 29940 00003E91 7403                    	jz	short NEXTAMBIG0	; found the source - continue
 29941 00003E93 E952FF                  	jmp	SRCNONEXIST		; didn't find the source
 29942                                  
 29943                                  NEXTAMBIG0:
 29944 00003E96 30C0                    	xor	al,al
 29945 00003E98 8606[7A9C]              	xchg	al,[FRSTSRCH]
 29946 00003E9C 08C0                    	or	al,al
 29947 00003E9E 740B                    	jz	short NEXTAMBIG
 29948                                  SETNMEL:
 29949 00003EA0 B90C00                  	mov	cx,12
 29950 00003EA3 BF[E09D]                	mov	di,SDIRBUF
 29951 00003EA6 BE[9A9D]                	mov	si,DIRBUF
 29952 00003EA9 F3A4                    	rep	movsb			; save very first source name
 29953                                  NEXTAMBIG:
 29954 00003EAB 30C0                    	xor	al,al
 29955 00003EAD A2[349F]                	mov	[NOWRITE],al		; turn off nowrite
 29956 00003EB0 8B3E[7D9E]              	mov	di,[SrcTail]
 29957 00003EB4 BE[9B9D]                	mov	si,DIRBUF+1
 29958 00003EB7 E8E9EA                  	call	FCB_TO_ASCZ		; SrcBuf has complete name
 29959                                  ;MELDO:
 29960                                  	; ****************************************
 29961                                  	; 12/06/2023
 29962                                  	; Retro DOS v4.2 COMMAND.COM
 29963                                  	; MSDOS 6.22 COMMAND.COM code only !
 29964                                  	; (Disassembled source code by using Hex-Rays IDA disassembler)
 29965                                  	; ****************************************
 29966                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:41DBh
 29967                                  MELDO0:
 29968 00003EBA 803E[509F]00            	cmp	byte [cox_y_override],0 ; /Y switch override (question) enabled ?
 29969 00003EBF 746C                    	jz	short MELDO ; no
 29970                                  	; ----------------------
 29971                                  	; yes
 29972 00003EC1 E85406                  	call	BUILDDEST
 29973 00003EC4 BE[809E]                	mov	si,SrcBuf
 29974 00003EC7 BF[8199]                	mov	di,SRCXNAME
 29975                                  	;mov	ah,60h
 29976 00003ECA B460                    	mov	ah,xNameTrans ; 60h
 29977 00003ECC CD21                    	int	21h	; DOS - RESOLVE PATH STRING TO CANONICAL PATH STRING
 29978                                  			; DS:SI -> ASCIZ relative path string or directory name
 29979                                  			; ES:DI -> 128-byte buffer for ASCIZ canonical fully qualified name
 29980 00003ECE E8A308                  	call	COMPNAME
 29981 00003ED1 7540                    	jnz	short MELDO1    	; different file names
 29982 00003ED3 803E[689C]00            	cmp	byte [Concat],0
 29983 00003ED8 7539                    	jnz	short MELDO1		; concatenating
 29984                                  	; "File cannot be copied onto itself"
 29985 00003EDA BA[9B91]                	mov	dx,file_name_ptr
 29986 00003EDD E83D15                  	call	std_printf
 29987 00003EE0 E894EA                  	call	CRLF2
 29988 00003EE3 BA[F78F]                	mov	dx,OVERWR_PTR
 29989 00003EE6 E9B905                  	jmp	COPYERR
 29990                                  ;MELDO1:
 29991                                  	;cmp	byte [CFLAG],0		; destination file created flag
 29992                                  	;jnz	short MELDO		; yes, new (created) file
 29993                                  	;				; no, overwrite question (must be confirmed)
 29994                                  	;call	get_answer_YNA
 29995                                  	;jb	short MELDO2    	; answer is no
 29996                                  	;cmp	byte [Concat],0
 29997                                  	;jnz	short MELDO
 29998                                  	;cmp	byte [cox_dest_file],0	; is there a (valid) target file ?
 29999                                  	;jnz	short DOREAD    	; yes
 30000                                  	;jmp	short MELDO     	; no, destination/target file does not exist
 30001                                  MELDO2:
 30002 00003EE9 803E[789E]00            	cmp	byte [MELCOPY],0	; is 'Mel Hallerman copy' false ?
 30003 00003EEE 7507                    	jnz	short MELDO3    	; no (, it is true)
 30004 00003EF0 803E[689C]00            	cmp	byte [Concat],0
 30005 00003EF5 7408                    	jz	short MELDO4
 30006                                  MELDO3:
 30007 00003EF7 C606[739C]01            	mov	byte [DestClosed],1
 30008 00003EFC E9D5FE                  	jmp	ENDCOPY
 30009                                  MELDO4:
 30010 00003EFF E8EB00                  	call	SEARCHNEXT
 30011 00003F02 74A7                    	jz	short NEXTAMBIG
 30012 00003F04 803E[529F]00            	cmp	byte [cox_src_file],0
 30013                                  	;jz	short MELDO5
 30014                                  	;jmp	NEXTSRC
 30015                                  	; 18/06/2023
 30016 00003F09 7505                    	jnz	short NEXTSRCJ
 30017                                  MELDO5:
 30018 00003F0B C606[739C]01            	mov	byte [DestClosed],1
 30019                                  NEXTSRCJ:	; 18/06/2023
 30020 00003F10 E91FFF                  	jmp	NEXTSRC
 30021                                  
 30022                                  	; 12/06/2023
 30023                                  MELDO1:
 30024 00003F13 803E[729C]00            	cmp	byte [CFLAG],0		; destination file created flag
 30025 00003F18 7513                    	jnz	short MELDO     	; yes, new (created) file
 30026                                  					; no, overwrite question (must be confirmed)
 30027 00003F1A E81803                  	call	get_answer_YNA
 30028 00003F1D 72CA                    	jb	short MELDO2    	; answer is no
 30029 00003F1F 803E[689C]00            	cmp	byte [Concat],0
 30030 00003F24 7507                    	jnz	short MELDO
 30031 00003F26 803E[519F]00            	cmp	byte [cox_dest_file],0	; is there a (valid) target file ?
 30032 00003F2B 7517                    	jnz	short DOREAD    	; yes
 30033                                  	; 12/06/2023
 30034                                  	;jmp	short MELDO     	; no, destination/target file does not exist
 30035                                  
 30036                                  	; ****************************************
 30037                                  	; 12/06/2023
 30038                                  MELDO:
 30039 00003F2D 803E[689C]00            	cmp	byte [Concat],0
 30040 00003F32 7507                    	jnz	short SHOWCPNAM		; concatenating - show name
 30041 00003F34 F606[7F9E]02            	test	byte [SrcInfo],2	; wildcard - show name
 30042 00003F39 7409                    	jz	short DOREAD
 30043                                  SHOWCPNAM:
 30044                                  	; 25/03/2023
 30045                                  	; MSDOS 3.3
 30046                                  	;mov	dx,SRCBUF
 30047                                  	;mov	[STRING_PTR_2],dx
 30048                                  	;mov	dx,STRINGBUF2PTR
 30049                                  	;call	STD_PRINTF
 30050                                  	;call	CRLF2
 30051                                  	; 25/03/2023 - Retro DOS 4.0 COMMAND.COM
 30052                                  	; MSDOS 6.0 (& MSDOS 5.0
 30053 00003F3B BA[9B91]                	mov	dx,file_name_ptr
 30054 00003F3E E8DC14                  	call	std_printf
 30055 00003F41 E833EA                  	call	CRLF2
 30056                                  DOREAD:
 30057 00003F44 E8C300                  	call	DOCOPY
 30058 00003F47 803E[689C]00            	cmp	byte [Concat],0
 30059 00003F4C 750A                    	jnz	short NODCLOSE		; concatenating - don't close dest
 30060                                  
 30061 00003F4E E8B801                  	call	CLOSEDEST		; close current destination
 30062 00003F51 7205                    	jc	short NODCLOSE		; concatenating - dest not closed
 30063                                  
 30064 00003F53 C606[729C]00            	mov	byte [CFLAG],0		; 'destination not created'
 30065                                  NODCLOSE:
 30066 00003F58 803E[689C]00            	cmp	byte [Concat],0		
 30067 00003F5D 740A                    	jz	short NOFLUSH
 30068                                  
 30069                                  ;	Concatenating - flush output between source files so LostErr
 30070                                  ;	stuff works correctly.
 30071                                  
 30072                                  	;invoke	FlshFil  ; MSDOS 6.0
 30073                                  	; 25/03/2023
 30074 00003F5F E80304                  	call	FlshFil
 30075                                  	;call	FLUSHFIL ; MSDOS 3.3
 30076                                  
 30077 00003F62 F606[789E]FF            	test	byte [MELCOPY],0FFh
 30078                                  	;jz	short NOFLUSH
 30079                                  	;jmp	short DOMELCOPY
 30080                                  	; 25/03/2023
 30081 00003F67 750D                    	jnz	short DOMELCOPY
 30082                                  NOFLUSH:
 30083 00003F69 E88100                  	call	SEARCHNEXT		; try next match
 30084 00003F6C 75A2                    	jnz	short NEXTSRCJ		; not found - finished with 
 30085                                  					;   this source spec
 30086 00003F6E C606[739C]00            	mov	byte [DestClosed],0	; 'destination not closed'
 30087 00003F73 E935FF                  	jmp	NEXTAMBIG		; do next ambig match
 30088                                  
 30089                                  DOMELCOPY:
 30090 00003F76 803E[789E]FF            	cmp	byte [MELCOPY],0FFh
 30091 00003F7B 740D                    	je	short CONTMEL
 30092 00003F7D 8B36[319F]              	mov	si,[SRCPT]
 30093 00003F81 8936[799E]              	mov	[MELSTART],si
 30094 00003F85 C606[789E]FF            	mov	byte [MELCOPY],0FFh
 30095                                  
 30096                                  CONTMEL:
 30097 00003F8A 31ED                    	xor	bp,bp
 30098 00003F8C 8B36[319F]              	mov	si,[SRCPT]
 30099                                  	;mov	bl,[PLUS_CHR]
 30100                                  	; 25/03/2023
 30101 00003F90 B32B                    	mov	bl,'+'
 30102                                  SCANSRC2:
 30103 00003F92 BF[DA9E]                	mov	di,ScanBuf
 30104 00003F95 E8EF07                  	call	cparse
 30105 00003F98 F6C780                  	test	bh,80h
 30106 00003F9B 742F                    	jz	short NEXTMEL		; no "+" - go back to start
 30107 00003F9D F6C701                  	test	bh,1
 30108 00003FA0 75F0                    	jnz	short SCANSRC2		; switch - keep scanning
 30109 00003FA2 E866FE                  	call	SOURCEPROC
 30110 00003FA5 E879E8                  	call	RestUDir1
 30111 00003FA8 BF[1B9D]                	mov	di,DESTFCB2
 30112 00003FAB B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 30113 00003FAE CD21                    	int	21h		; DOS -	PARSE FILENAME
 30114                                  				; DS:SI	-> string to parse
 30115                                  				; ES:DI	-> buffer to fill with unopened	FCB
 30116                                  				; AL = bit mask	to control parsing
 30117 00003FB0 BB[E19D]                	mov	bx,SDIRBUF+1
 30118 00003FB3 BE[1C9D]                	mov	si,DESTFCB2+1
 30119 00003FB6 8B3E[7D9E]              	mov	di,[SrcTail]
 30120                                  
 30121 00003FBA E81C06                  	call	BUILDNAME
 30122                                  
 30123 00003FBD 803E[689C]00            	cmp	byte [Concat],0
 30124 00003FC2 7405                    	je	short MELDOJ		; not concatenating - continue
 30125                                  
 30126                                  	;	Yes, turn off nowrite because this part of the code 
 30127                                  	;	is only reached after the first file has been dealt with.
 30128                                  
 30129 00003FC4 C606[349F]00            	mov	byte [NOWRITE],0
 30130                                  MELDOJ:
 30131 00003FC9 E961FF                  	jmp	MELDO
 30132                                  	; 18/06/2023
 30133                                  ;NEXTSRCJ:
 30134                                  	;jmp	NEXTSRC
 30135                                  
 30136                                  NEXTMEL:
 30137 00003FCC E83A01                  	call	CLOSEDEST
 30138 00003FCF 31C0                    	xor	ax,ax
 30139 00003FD1 A2[729C]                	mov	[CFLAG],al
 30140 00003FD4 A3[789C]                	mov	[NXTADD],ax
 30141 00003FD7 A2[739C]                	mov	[SPECDRV],al
 30142 00003FDA 8B36[799E]              	mov	si,[MELSTART]
 30143 00003FDE 8936[319F]              	mov	[SRCPT],si
 30144 00003FE2 E80800                  	call	SEARCHNEXT
 30145 00003FE5 7403                    	jz	short SETNMELJ
 30146 00003FE7 E9EDFD                  	jmp	ENDCOPY2
 30147                                  SETNMELJ:
 30148 00003FEA E9B3FE                  	jmp	SETNMEL
 30149                                  
 30150                                  ; ---------------------------------------------------------------------------
 30151                                  
 30152                                  SEARCHNEXT:
 30153 00003FED B412                    	mov	ah,Dir_Search_Next ; 12h
 30154 00003FEF F606[7F9E]02            	test	byte [SrcInfo],2
 30155 00003FF4 7503                    	jnz	short SEARCH		; do search-next if ambig
 30156 00003FF6 08E4                    	or	ah,ah			; reset zero flag
 30157 00003FF8 C3                      	retn
 30158                                  
 30159                                  ; ---------------------------------------------------------------------------
 30160                                  
 30161                                  SEARCH:
 30162 00003FF9 50                      	push	ax
 30163 00003FFA B41A                    	mov	ah,Set_DMA ; 1Ah
 30164 00003FFC BA[9A9D]                	mov	dx,DIRBUF	; put result of search in dirbuf
 30165 00003FFF CD21                    	int	21h	; DOS -	SET DISK TRANSFER AREA ADDRESS
 30166                                  			; DS:DX	-> disk	transfer buffer
 30167 00004001 58                      	pop	ax		; restore search first/next command
 30168 00004002 BA5C00                  	mov	dx,FCB ; 5Ch
 30169 00004005 CD21                    	int	21h		; Do the search
 30170 00004007 08C0                    	or	al,al
 30171 00004009 C3                      	retn
 30172                                  
 30173                                  ; ---------------------------------------------------------------------------
 30174                                  
 30175                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30176                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30177                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4335h
 30178                                  DOCOPY:
 30179 0000400A BE[809E]                	mov	si,SrcBuf	; do name translate of source
 30180 0000400D BF[8199]                	mov	di,SRCXNAME	; save for name comparison
 30181 00004010 B460                    	mov	ah,xNameTrans ; 60h
 30182                                  	;mov	ah,60h
 30183 00004012 CD21                    	int	21h	; DOS -	RESOLVE	PATH STRING TO CANONICAL PATH STRING
 30184                                  			; DS:SI	-> ASCIZ relative path string or directory name
 30185                                  			; ES:DI	-> 128-byte buffer for ASCIZ canonical fully qualified name
 30186 00004014 C606[669C]00            	mov	byte [RDEOF],0	; no EOF yet
 30187                                  
 30188                                  	; MSDOS 6.0
 30189                                  	;mov	ax,ExtOpen shl 8	; open the file
 30190                                  	; 26/03/2023
 30191 00004019 B8006C                  	mov	ax,6C00h
 30192                                  ;M046
 30193                                  ; For reads, the sharing mode should be deny none so that any process can
 30194                                  ;open this file again in any other sharing mode. This is mainly to allow
 30195                                  ;multiple command.com's to access the same file without getting sharing
 30196                                  ;violations
 30197                                  ;
 30198                                  	;mov	bx,deny_none|read_open_mode
 30199 0000401C BB4000                  	mov	bx,40h			; open mode for COPY ;M046
 30200 0000401F 31C9                    	xor	cx,cx			; no special files
 30201                                  	;mov	dx,read_open_flag	; set up open flags
 30202 00004021 BA0101                  	mov	dx,101h
 30203 00004024 CD21                    	int	21h
 30204                                  	; 26/03/2023
 30205 00004026 7230                    	jc	short Error_On_Source
 30206                                  	;jnc	short OPENOK
 30207                                  
 30208                                  	;	Bogosity: IBM wants us to issue Access Denied in this case.
 30209                                  	;	They asked for it...
 30210                                  
 30211                                  	;jmp	short Error_On_Source ;AC022; clean up and exit
 30212                                  
 30213                                  	; 26/03/2023
 30214                                  	; MSDOS 3.3
 30215                                  	;mov	dx,SRCBUF
 30216                                  	;mov	ax,OPEN*256 ; 3D00h
 30217                                  	;int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 30218                                  	;			; DS:DX	-> ASCIZ filename
 30219                                  	;			; AL = access mode
 30220                                  	;			; 0 - read
 30221                                  	;jnc	short OPENOK
 30222                                  	;call	GET_EXT_ERR_NUMBER
 30223                                  	;pushf
 30224                                  	;cmp	ax,65
 30225                                  	;jnz	short DOCOPY_ERR
 30226                                  	;mov	dx,ACCDENPTR
 30227                                  	;call	STD_PRINTF
 30228                                  ;DOCOPY_ERR:
 30229                                  	;popf
 30230                                  	;retn
 30231                                  
 30232                                  	; 26/03/2023
 30233                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30234                                  OPENOK:
 30235 00004028 89C3                    	mov	bx,ax
 30236 0000402A 891E[D79E]              	mov	[SRCHAND],bx		; save handle
 30237 0000402E B80057                  	mov	ax,File_Times*256 ; 5700h
 30238 00004031 CD21                    	int	21h		; DOS -	2+ - GET FILE'S DATE/TIME
 30239                                  				; BX = file handle
 30240                                  
 30241 00004033 7223                    	jc	short Error_On_Source ; MSDOS 6.0
 30242                                  
 30243 00004035 8916[3C9F]              	mov	[CPDATE],dx		; save date
 30244 00004039 890E[3E9F]              	mov	[CPTIME],cx		; save time
 30245                                  
 30246                                  	; MSDOS 6.0
 30247                                  	;jmp	short No_Copy_Xa 	; (xa copy code removed)
 30248                                  	; 26/04/2023
 30249                                  No_Copy_Xa:
 30250                                  	; 26/03/2023
 30251                                  	;mov	bx,[SRCHAND]		;AN022; get handle back
 30252                                  
 30253                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30254 0000403D B80044                  	mov	ax,(IOCTL<<8) ; 4400h
 30255 00004040 CD21                    	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30256                                  				; BX = file or device handle
 30257                                  	;and	dl,devid_ISDEV ; 80h
 30258                                  	; 18/04/2023
 30259 00004042 80E280                  	and	dl,80h ; devid_ISDEV
 30260 00004045 8816[D99E]              	mov	[SRCISDEV],dl		; set source info
 30261 00004049 7436                    	jz	short COPYLP		; source not a device
 30262 0000404B 803E[359F]00            	cmp	byte [BINARY],0
 30263 00004050 742F                    	je	short COPYLP		; ascii device ok
 30264 00004052 BA[5491]                	mov	dx,INBDEV_PTR		; cannot do binary input
 30265 00004055 E94A04                  	jmp	COPYERR
 30266                                  
 30267                                  Error_On_Source:			;AN022; we have a BAD error
 30268 00004058 E8DEDF                  	call	Set_Ext_Error_Msg	;AN022; set up the error message
 30269 0000405B C706[019E][809E]        	mov	word [string_ptr_2],SrcBuf
 30270                                  				;AN022; get address of failed string
 30271 00004061 C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst ; 1
 30272                                  				;AN022; put number of subst in control block
 30273 00004066 E8AC13                  	call	std_eprintf		;AN022; print it
 30274                                  	; 26/03/2023 - Retro DOS v4.0 COMMAND.COM
 30275 00004069 8B1E[D79E]              	mov	bx,[SRCHAND]
 30276                                  	;cmp	word [SRCHAND],0	;AN022; did we open the file?
 30277                                  	;je	short No_Close_Src	;AN022; no - don't close
 30278 0000406D 09DB                    	or	bx,bx
 30279 0000406F 7403                    	jz	short No_Close_Src
 30280                                  	;call	CLOSESRC		;AN022; clean up
 30281                                  	; 26/03/2023
 30282 00004071 E89000                  	call	CLOSESRC2 ; bx = [SRCHAND]
 30283                                  No_Close_Src:				;AN022;
 30284 00004074 803E[729C]00            	cmp	byte [CFLAG],0		;AN022; was destination created?
 30285 00004079 7403                    	je	short EndCopyJ3		;AN022; no - just cleanup and exit
 30286 0000407B E956FD                  	jmp	ENDCOPY			;AN022; clean up concatenation and exit
 30287                                  EndCopyJ3:				;AN022;
 30288 0000407E E956FD                  	jmp	ENDCOPY2		;AN022;
 30289                                  
 30290                                  	; 26/04/2023
 30291                                  ;No_Copy_Xa:
 30292                                  ;	; 26/03/2023
 30293                                  ;	;mov	bx,[SRCHAND]		;AN022; get handle back
 30294                                  ;
 30295                                  ;	; MSDOS 3.3 (& MSDOS 6.0)
 30296                                  ;	mov	ax,(IOCTL<<8) ; 4400h
 30297                                  ;	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30298                                  ;				; BX = file or device handle
 30299                                  ;	;and	dl,devid_ISDEV ; 80h
 30300                                  ;	; 18/04/2023
 30301                                  ;	and	dl,80h ; devid_ISDEV
 30302                                  ;	mov	[SRCISDEV],dl		; set source info
 30303                                  ;	jz	short COPYLP		; source not a device
 30304                                  ;	cmp	byte [BINARY],0
 30305                                  ;	je	short COPYLP		; ascii device ok
 30306                                  ;	mov	dx,INBDEV_PTR		; cannot do binary input
 30307                                  ;	jmp	COPYERR
 30308                                  
 30309                                  COPYLP:
 30310                                  	; 26/03/2023
 30311 00004081 8B1E[D79E]              	mov	bx,[SRCHAND] ; ? ; 26/03/2023
 30312 00004085 8B0E[749C]              	mov	cx,[BYTCNT]
 30313 00004089 8B16[789C]              	mov	dx,[NXTADD]
 30314 0000408D 29D1                    	sub	cx,dx			; compute available space
 30315 0000408F 750E                    	jnz	short GOTROOM
 30316 00004091 E8D102                  	call	FlshFil   ; MSDOS 6.0
 30317                                  	;call	FLUSHFIL  ; MSDOS 3.3
 30318 00004094 803E[389F]00            	cmp	byte [TERMREAD],0
 30319 00004099 7565                    	jne	short CLOSESRC		; give up
 30320 0000409B 8B0E[749C]              	mov	cx,[BYTCNT]
 30321                                  GOTROOM:
 30322 0000409F 1E                      	push	ds
 30323 000040A0 8E1E[559C]              	mov	ds,[TPA]
 30324 000040A4 B43F                    	mov	ah,READ ; 3Fh
 30325 000040A6 CD21                    	int	21h		; DOS -	2+ - READ FROM FILE WITH HANDLE
 30326                                  				; BX = file handle,CX = number of bytes to read
 30327                                  				; DS:DX	-> buffer
 30328 000040A8 1F                      	pop	ds
 30329                                  	;jc	short CLOSESRC	; MSDOS 3.3
 30330                                  	; 26/03/2023
 30331 000040A9 72AD                    	jc	short Error_On_Source ; MSDOS 6.0
 30332 000040AB 89C1                    	mov	cx,ax			; get count
 30333 000040AD E351                    	jcxz	CLOSESRC		; no more to read
 30334 000040AF 803E[D99E]00            	cmp	byte [SRCISDEV],0
 30335 000040B4 7507                    	jne	short NOTESTA		; is a device, ascii mode
 30336 000040B6 803E[399F]00            	cmp	byte [ASCII],0
 30337 000040BB 741B                    	je	short BINREAD
 30338                                  NOTESTA:
 30339 000040BD 89CA                    	mov	dx,cx
 30340 000040BF 8B3E[789C]              	mov	di,[NXTADD]
 30341 000040C3 B01A                    	mov	al,1Ah
 30342 000040C5 06                      	push	es
 30343 000040C6 8E06[559C]              	mov	es,[TPA]		; scan for EOF
 30344 000040CA F2AE                    	repne	scasb
 30345 000040CC 07                      	pop	es
 30346 000040CD 7505                    	jnz	short USEALL
 30347 000040CF FE06[669C]              	inc	byte [RDEOF]
 30348 000040D3 41                      	inc	cx
 30349                                  USEALL:
 30350 000040D4 29CA                    	sub	dx,cx
 30351 000040D6 89D1                    	mov	cx,dx
 30352                                  BINREAD:
 30353 000040D8 030E[789C]              	add	cx,[NXTADD]
 30354 000040DC 890E[789C]              	mov	[NXTADD],cx
 30355 000040E0 3B0E[749C]              	cmp	cx,[BYTCNT]		; is buffer full?
 30356 000040E4 720C                    	jb	short TESTDEV		; if not, we may have found eof
 30357                                  	; 26/03/2023
 30358 000040E6 E87C02                  	call	FlshFil
 30359                                  	;call	FLUSHFIL
 30360 000040E9 803E[389F]00            	cmp	byte [TERMREAD],0
 30361 000040EE 7510                    	jne	short CLOSESRC		; give up
 30362 000040F0 EB8F                    	jmp	short COPYLP
 30363                                  TESTDEV:
 30364 000040F2 803E[D99E]00            	cmp	byte [SRCISDEV],0	; if file then EOF
 30365 000040F7 7407                    	je	short CLOSESRC
 30366 000040F9 803E[669C]00            	cmp	byte [RDEOF],0
 30367 000040FE 7481                    	je	short COPYLP		; on device, go till ^Z
 30368                                  CLOSESRC:
 30369 00004100 8B1E[D79E]              	mov	bx,[SRCHAND]
 30370                                  CLOSESRC2:
 30371 00004104 B43E                    	mov	ah,CLOSE ; 3Eh
 30372 00004106 CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 30373                                  				; BX = file handle
 30374                                  CLOSESRCDEST_RETN:
 30375 00004108 C3                      	retn
 30376                                  
 30377                                  ; ---------------------------------------------------------------------------
 30378                                  
 30379                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30380                                  CLOSEDEST:
 30381                                  
 30382                                  	;	We are called to close the destination.
 30383                                  	;	We need to note whether or not there is any internal data left
 30384                                  	;	to be flushed out.
 30385                                  
 30386 00004109 803E[739C]00            	cmp	byte [DestClosed],0
 30387 0000410E 75F8                    	jne	short CLOSESRCDEST_RETN	; don't double close
 30388 00004110 A0[6E9C]                	mov	al,[DestSwitch]
 30389 00004113 E8E803                  	call	SETASC			; check for b or a switch
 30390 00004116 742E                    	jz	short BINCLOS		;   on destination
 30391 00004118 8B1E[789C]              	mov	bx,[NXTADD]
 30392                                  ;
 30393                                  ;M048 -- TryFlush changes the state of ConCat flag. So, before we append a
 30394                                  ;^Z, let's always flush out. This way if the ConCat flag changes, we will
 30395                                  ;just return without appending a ^Z incorrectly for the first file (since we
 30396                                  ;are concatenating now). Also, in case it is a single file copy, we will
 30397                                  ;anyway write the ^Z out separately. The only drawback is that there is a
 30398                                  ;performance overhead on single ASCII file copies which now always involve
 30399                                  ;2 writes instead of 1 before. Is this really that important?
 30400                                  ;
 30401                                  ;M048;	cmp	bx,[BYTCNT]		; is memory full?
 30402                                  ;M048;	jne	short PutZ
 30403                                  
 30404                                  	; 26/03/2023
 30405                                  	; MSDOS 3.3
 30406                                  	;cmp	bx,[BYTCNT]		; is memory full?
 30407                                  	;jne	short PUTZ
 30408                                  
 30409                                  	; 26/03/2023
 30410 0000411C E83902                  	call	TRYFLUSH		; flush (and double-check for concat)	
 30411 0000411F 7402                    	jz	short NOCONC
 30412                                  CONCHNG:
 30413 00004121 F9                      	stc
 30414 00004122 C3                      	retn
 30415                                  
 30416                                  NOCONC:	
 30417 00004123 31DB                    	xor	bx,bx
 30418                                  PUTZ:
 30419 00004125 1E                      	push	ds
 30420 00004126 8E1E[559C]              	mov	ds,[TPA]
 30421 0000412A C7071A00                	mov	word [bx],1Ah	; add EOF mark (ctrl-Z)
 30422 0000412E 1F                      	pop	ds
 30423 0000412F FF06[789C]              	inc	word [NXTADD]	; make sure our ^z gets written	
 30424 00004133 C606[349F]00            	mov	byte [NOWRITE],0
 30425 00004138 A1[369F]                	mov	ax,[WRITTEN]
 30426 0000413B 0306[789C]              	add	ax,[NXTADD]
 30427 0000413F 7205                    	jc	short BINCLOS	; > 1
 30428 00004141 83F801                  	cmp	ax,1
 30429 00004144 740C                    	je	short FORGETITJ	; Written = 0 NxtAdd = 1 (the ^Z)
 30430                                  BINCLOS:
 30431 00004146 E80F02                  	call	TRYFLUSH
 30432 00004149 75D6                    	jnz	short CONCHNG
 30433                                  
 30434                                  	; 26/04/2023
 30435 0000414B 833E[369F]00            	cmp	word [WRITTEN],0
 30436                                  	; 26/03/2023
 30437 00004150 7503                    	jnz	short NO_FORGET
 30438                                  FORGETITJ:
 30439                                  	;jz	short FORGETIT	; never wrote nothing
 30440                                  	; 26/03/2023
 30441 00004152 E98500                  	jmp	FORGETIT ; 18/04/2023
 30442                                  NO_FORGET:			; wrote something
 30443 00004155 8B1E[749E]              	mov	bx,[DESTHAND]
 30444 00004159 8B0E[3E9F]              	mov	cx,[CPTIME]
 30445 0000415D 8B16[3C9F]              	mov	dx,[CPDATE]
 30446 00004161 803E[339F]00            	cmp	byte [INEXACT],0 ; copy not exact?
 30447 00004166 7431                    	je	short DODCLOSE	; if no, copy date & time
 30448 00004168 B42C                    	mov	ah,Get_Time ; 2Ch
 30449 0000416A CD21                    	int	21h		; DOS -	GET CURRENT TIME
 30450                                  				; Return: CH = hours,CL = minutes,DH = seconds
 30451                                  				; DL = hundredths of seconds
 30452 0000416C D0E1                    	shl	cl,1
 30453 0000416E D0E1                    	shl	cl,1		; left justify min in cl
 30454 00004170 D1E1                    	shl	cx,1
 30455 00004172 D1E1                    	shl	cx,1
 30456 00004174 D1E1                    	shl	cx,1		; hours to high 5 bits, min to 5-10
 30457 00004176 D0EE                    	shr	dh,1		; divide seconds by 2 (now 5 bits)
 30458 00004178 08F1                    	or	cl,dh		; and stick into low 5 bits of cx
 30459 0000417A 51                      	push	cx		; save packed time
 30460 0000417B B42A                    	mov	ah,Get_Date ; 2Ah
 30461 0000417D CD21                    	int	21h		; DOS -	GET CURRENT DATE
 30462                                  				; Return: DL = day,DH = month,	CX = year
 30463                                  				; AL = day of the week (0=Sunday,1=Monday,etc.)
 30464 0000417F 81E9BC07                	sub	cx,1980
 30465 00004183 86E9                    	xchg	ch,cl
 30466 00004185 D1E1                    	shl	cx,1		; year to high 7 bits
 30467 00004187 D0E6                    	shl	dh,1		; month to high 3 bits
 30468 00004189 D0E6                    	shl	dh,1
 30469 0000418B D0E6                    	shl	dh,1
 30470 0000418D D0E6                    	shl	dh,1
 30471 0000418F D0E6                    	shl	dh,1		; most sig bit of month in carry
 30472 00004191 80D500                  	adc	ch,0		; put that bit next to year
 30473 00004194 08F2                    	or	dl,dh		; or low three of month into day
 30474 00004196 88EE                    	mov	dh,ch		; get year and high bit of month
 30475 00004198 59                      	pop	cx
 30476                                  DODCLOSE:
 30477 00004199 83FB00                  	cmp	bx,0
 30478 0000419C 7E36                    	jle	short CLOSEDONE
 30479 0000419E B80157                  	mov	ax,(File_Times<<8)|1 ; 5701h
 30480 000041A1 CD21                    	int	21h		; DOS -	2+ - SET FILE'S DATE/TIME
 30481                                  				; BX = file handle,CX = time to be set
 30482                                  				; DX = date to be set
 30483                                  	; 26/03/2023
 30484                                  	; MSDOS 6.0
 30485 000041A3 721A                    	jc	short Cleanup_Err ;AN022; handle error
 30486                                  
 30487                                  	;	See if the destination has *anything* in it.
 30488                                  	;	If not, just close and delete it.
 30489                                  
 30490 000041A5 B80242                  	mov	ax,(LSEEK<<8)+2 ; 4202h	; seek to EOF
 30491 000041A8 31D2                    	xor	dx,dx
 30492 000041AA 89D1                    	mov	cx,dx
 30493 000041AC CD21                    	int	21h	; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 30494                                  			; AL = method: offset from end of file
 30495                                  	;	DX:AX is file size
 30496                                  
 30497 000041AE 09C2                    	or	dx,ax
 30498 000041B0 9C                      	pushf
 30499 000041B1 B80044                  	mov	ax,(IOCTL<<8)+0 ; 4400h	; get the destination attributes
 30500 000041B4 CD21                    	int	21h	; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 30501                                  			; BX = file or device handle
 30502 000041B6 52                      	push	dx		; save them away
 30503 000041B7 B43E                    	mov	ah,CLOSE ; 3Eh
 30504 000041B9 CD21                    	int	21h	; DOS -	2+ - CLOSE A FILE WITH HANDLE
 30505                                  			; BX = file handle
 30506 000041BB 5A                      	pop	dx
 30507                                  
 30508                                  	; 26/03/2023 - Retro DOS v4.0 COMMAND.COM
 30509                                  	; MSDOS 6.0
 30510 000041BC 730D                    	jnc	short Close_Cont ;AN022; handle error on close
 30511 000041BE 9D                      	popf			;AN022; get the flags back
 30512                                  Cleanup_Err: 			;AN022;
 30513 000041BF E85A00                  	call	CleanUpErr	;AN022; attempt to delete the target
 30514                                  	; 26/03/2023
 30515                                  	;call	DestDelete	;AN022; attempt to delete the target
 30516                                  	;jmp	short FILECLOSED
 30517                                  	;			;AN022; close the file
 30518                                  	; 26/03/2023
 30519                                  DestDel_fclosed:
 30520 000041C2 E82700                  	call	DestDelete
 30521                                  FILECLOSED:
 30522 000041C5 FE06[739C]              	inc	byte [DestClosed]
 30523                                  RET50:
 30524 000041C9 F8                      	clc
 30525 000041CA C3                      	retn
 30526                                  	
 30527                                  Close_Cont:			;AN022; no error - co
 30528                                  	; MSDOS 3.3 (& MSDOS 6.0)
 30529 000041CB 9D                      	popf
 30530 000041CC 7506                    	jnz	short CLOSEDONE
 30531 000041CE F7C28000                	test	dx,80h		; is the destination a device?
 30532                                  	;jnz	short CLOSEDONE	; yes, copy succeeded
 30533                                  	;call	DestDelete
 30534                                  	;jmp	short FILECLOSED
 30535                                  	; 26/03/2023
 30536 000041D2 74EE                    	jz	short DestDel_fclosed
 30537                                  CLOSEDONE:
 30538 000041D4 FF06[819C]              	inc	word [FileCnt]
 30539                                  	; 26/03/2023
 30540 000041D8 EBEB                    	jmp	short FILECLOSED
 30541                                  	
 30542                                  ;FILECLOSED:
 30543                                  ;	inc	byte [DestClosed]
 30544                                  ;RET50:
 30545                                  	;clc
 30546                                  	;retn
 30547                                  
 30548                                  FORGETIT:
 30549 000041DA 8B1E[749E]              	mov	bx,[DESTHAND]
 30550 000041DE E8B8FF                  	call	DODCLOSE	 ; close the dest	
 30551 000041E1 E80800                  	call	DestDelete
 30552 000041E4 C706[819C]0000          	mov	word [FileCnt],0 ; no files transferred
 30553 000041EA EBDD                    	jmp	short RET50
 30554                                  
 30555                                  ; ---------------------------------------------------------------------------
 30556                                  
 30557                                  	; 26/03/2023
 30558                                  DestDelete:
 30559 000041EC BA[1D9E]                	mov	dx,DestBuf
 30560 000041EF B441                    	mov	ah,Unlink ; 41h
 30561 000041F1 CD21                    	int	21h	; DOS -	2+ - DELETE A FILE (UNLINK)
 30562                                  			; DS:DX	-> ASCIZ pathname of file to delete 
 30563                                  			;		(no wildcards allowed)
 30564 000041F3 C3                      	retn
 30565                                  
 30566                                  ; ---------------------------------------------------------------------------
 30567                                  
 30568                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30569                                  SOURCE_SET:
 30570 000041F4 56                      	push	si
 30571 000041F5 A1[559F]                	mov	ax,[STARTEL]
 30572 000041F8 BE[DA9E]                	mov	si,ScanBuf	; adjust to copy
 30573 000041FB 29F0                    	sub	ax,si
 30574 000041FD BF[809E]                	mov	di,SrcBuf
 30575 00004200 01F8                    	add	ax,di
 30576 00004202 A3[7D9E]                	mov	[SrcTail],ax
 30577 00004205 880E[7C9E]              	mov	[SrcSiz],cl	; save its size
 30578 00004209 41                      	inc	cx		; include the nul
 30579 0000420A F3A4                    	rep	movsb		; save this source
 30580 0000420C 883E[7F9E]              	mov	[SrcInfo],bh	; save info about it
 30581 00004210 5E                      	pop	si
 30582 00004211 89E8                    	mov	ax,bp		; switches so far
 30583 00004213 E8E802                  	call	SETASC		; set a,b switches accordingly
 30584 00004216 E829E9                  	call	SWITCH		; get any more switches on this arg
 30585                                  	;call	SETASC		; set
 30586                                  	;retn
 30587                                  	; 26/03/2023
 30588 00004219 E9E202                  	jmp	SETASC
 30589                                  
 30590                                  ; =============== S U B	R O U T	I N E =======================================
 30591                                  
 30592                                  ; MSDOS 6.0
 30593                                  
 30594                                  ;****************************************************************
 30595                                  ;*
 30596                                  ;* ROUTINE:	CleanupErr
 30597                                  ;*
 30598                                  ;* FUNCTION:	Issues extended error message for destination
 30599                                  ;*		if not alreay issued
 30600                                  ;*
 30601                                  ;* INPUT:	return from INT 21
 30602                                  ;*
 30603                                  ;* OUTPUT:	none
 30604                                  ;*
 30605                                  ;****************************************************************
 30606                                  
 30607                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30608                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30609                                  	; MSDOS 6.0 (MSDOS 5.0) COMMAND.COM
 30610                                  CleanUpErr:	;proc near		;AN022;
 30611                                  
 30612 0000421C 803E[929F]00            	cmp	byte [msg_flag],0	;AN022; have we already issued a message?
 30613 00004221 7511                    	jnz	short CleanupErr_Cont	;AN022; yes - don't issue duplicate error
 30614 00004223 E813DE                  	call	Set_Ext_Error_Msg	;AN022; set up error message
 30615 00004226 C706[019E][1D9E]        	mov	word [string_ptr_2],DestBuf 
 30616                                  					;AN022; get address of failed string
 30617 0000422C C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst ; 1 
 30618                                  					;AN022; put number of subst in control block
 30619 00004231 E8E111                  	call	std_eprintf		;AN022; issue the error message
 30620                                  CleanupErr_Cont:			;AN022;
 30621                                  getansw_8:	; 12/06/2023
 30622 00004234 C3                      	retn				;AN022; return to caller
 30623                                  
 30624                                  ;CleanUpErr	endp			;AN022;
 30625                                  
 30626                                  
 30627                                  ; 12/06/2023
 30628                                  ; ---------------------------------------------------------------------------
 30629                                  ; MSDOS 6.2(2) COMMAND.COM procedure only !
 30630                                  ; -----------------------------------------
 30631                                  ; Hex-Rays IDA / disassembled source code ! modified for NASM by Erdogan Tan
 30632                                  ; ---------------------------------------------------------------------------
 30633                                  
 30634                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30635                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:456Dh
 30636                                  
 30637                                  get_answer_YNA:
 30638 00004235 C606[519F]00            	mov	byte [cox_dest_file],0	; clear validation flag
 30639 0000423A B80043                  	mov	ax,4300h
 30640 0000423D BA[1D9E]                	mov	dx,DestBuf
 30641 00004240 CD21                    	int	21h		; DOS -	2+ - GET FILE ATTRIBUTES
 30642                                  				; DS:DX	-> ASCIZ file name or directory
 30643                                  				; name without trailing	slash
 30644                                  	;jnc	short getansw_1
 30645                                  	;jmp	getansw_5
 30646                                  	; 12/06/2023
 30647 00004242 F5                      	cmc
 30648 00004243 73EF                    	jnc	short getansw_8 
 30649                                  getansw_1:
 30650 00004245 FE06[519F]              	inc	byte [cox_dest_file]	; valid destination file
 30651 00004249 8D36[459F]              	lea	si,cox_sublist_buff
 30652 0000424D C7040B00                	mov	word [si],11		; sublist size, 11 bytes
 30653 00004251 C74402[1D9E]            	mov	word [si+2],DestBuf	; sublist value	(pointer)
 30654 00004256 8C5C04                  	mov	[si+4],ds		; sublist segment
 30655                                  	;mov	byte [si+6],1		; sub id (N of %N)
 30656 00004259 C6440710                	mov	byte [si+7],10h		; data type flags
 30657                                  	;mov	byte [si+8],0		; maximum length (chars)
 30658                                  	;mov	byte [si+9],0		; minimum length (chars)
 30659                                  	;mov	byte [si+10],0		; pad field character (0)
 30660                                  	; 12/06/2023
 30661 0000425D 31C9                    	xor	cx,cx
 30662 0000425F 894C08                  	mov	[si+8],cx ; 0
 30663 00004262 884C0A                  	mov	[si+10],cl ; 0
 30664 00004265 FEC1                    	inc	cl
 30665 00004267 884C06                  	mov	[si+6],cl ; 1	
 30666                                  
 30667                                  	; 12/06/2023
 30668                                  	;lea	si,cox_sublist_buff
 30669 0000426A B84F04                  	mov	ax,1103			; message number
 30670                                  					; 'Overwrite %1 (Yes/No/All)?'
 30671 0000426D BB0200                  	mov	bx,2			; std error (file handle = 2)
 30672                                  	; 12/06/2023
 30673                                  	;mov	cx,1			; byte count
 30674                                  	; cx = 1
 30675                                  	;mov	dh,0FFh			; message class	(utility)
 30676                                  	;xor	dl,dl			; control flag = 0
 30677 00004270 31D2                    	xor	dx,dx
 30678 00004272 FECE                    	dec	dh  ; dh = 0FFh
 30679 00004274 E87314                  	call	SYSDISPMSG
 30680                                  	; 12/06/2023
 30681                                  	;xor	bx,bx
 30682                                  	; bh = 0
 30683                                  getansw_2:
 30684 00004277 B8080C                  	mov	ax,0C08h
 30685 0000427A CD21                    	int	21h		; DOS -	CLEAR KEYBOARD BUFFER
 30686                                  				; AL must be 01h, 06h, 07h, 08h, or 0Ah.
 30687                                  	;cmp	al,0
 30688                                  	;jz	short getansw_2
 30689                                  	; 12/06/2023
 30690 0000427C 20C0                    	and	al,al
 30691 0000427E 74F7                    	jz	short getansw_2
 30692 00004280 3C0D                    	cmp	al,0Dh
 30693 00004282 743B                    	je	short getansw_4
 30694 00004284 88C3                    	mov	bl,al
 30695 00004286 88C2                    	mov	dl,al
 30696 00004288 B82065                  	mov	ax,6520h
 30697 0000428B CD21                    	int	21h		; DOS -	4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
 30698                                  				; AL = function	-
 30699 0000428D 3A16[836D]              	cmp	dl,[_Y_es]		; 'Y' ?
 30700 00004291 740C                    	je	short getansw_3
 30701 00004293 3A16[846D]              	cmp	dl,[_N_o]		; 'N' ?
 30702 00004297 7406                    	je	short getansw_3
 30703 00004299 3A16[856D]              	cmp	dl,[_A_ll]		; 'A' ?
 30704 0000429D 75D8                    	jne	short getansw_2
 30705                                  getansw_3:
 30706 0000429F 88DF                    	mov	bh,bl
 30707 000042A1 53                      	push	bx
 30708 000042A2 881E[826D]              	mov	[MSG_1104],bl
 30709 000042A6 B440                    	mov	ah,40h
 30710 000042A8 BB0200                  	mov	bx,2			; std error (file handle = 2)
 30711 000042AB B90100                  	mov	cx,1			; byte count
 30712 000042AE BA[826D]                	mov	dx,MSG_1104
 30713 000042B1 CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 30714                                  				; BX = file handle, CX = number	of bytes to write, DS:DX -> buffer
 30715 000042B3 B440                    	mov	ah,40h
 30716 000042B5 C606[826D]08            	mov	byte [MSG_1104],8	; backspace (move cursor to back)
 30717 000042BA CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 30718                                  				; BX = file handle, CX = number	of bytes to write, DS:DX -> buffer
 30719 000042BC 5B                      	pop	bx
 30720 000042BD EBB8                    	jmp	short getansw_2
 30721                                  getansw_4:
 30722                                  	;cmp	bh,0
 30723                                  	;jz	short getansw_2
 30724                                  	; 12/06/2023
 30725 000042BF 08FF                    	or	bh,bh
 30726 000042C1 74B4                    	jz	short getansw_2
 30727 000042C3 88FA                    	mov	dl,bh
 30728 000042C5 B82065                  	mov	ax,6520h
 30729 000042C8 CD21                    	int	21h		; DOS -	4.x internal - COUNTRY-DEPENDENT FILENAME CAPITALIZATION
 30730                                  				; AL = function	-
 30731 000042CA 52                      	push	dx
 30732 000042CB B82E04                  	mov	ax,1070			; message number
 30733 000042CE BB0200                  	mov	bx,2			; std error (file handle = 2)
 30734 000042D1 31C9                    	xor	cx,cx
 30735                                  	;mov	dh,0FFh			; message class	(utility)
 30736                                  	;xor	dl,dl
 30737                                  	; 12/06/2023
 30738 000042D3 31D2                    	xor	dx,dx
 30739 000042D5 FECE                    	dec	dh  ; dh = 0FFh
 30740 000042D7 E81014                  	call	SYSDISPMSG
 30741 000042DA 5A                      	pop	dx
 30742 000042DB 3A16[836D]              	cmp	dl,[_Y_es]
 30743 000042DF 740B                    	jz	short getansw_5
 30744 000042E1 3A16[846D]              	cmp	dl,[_N_o]
 30745 000042E5 7406                    	jz	short getansw_6
 30746 000042E7 C606[509F]00            	mov	byte [cox_y_override],0
 30747                                  	; 12/06/2023
 30748                                  	;jmp	short $+2
 30749                                  getansw_5:
 30750                                  	; 12/06/2023
 30751                                  	;clc
 30752                                  	; cf = 0
 30753                                  	;jmp	short getansw_7
 30754                                  	; 12/06/2023
 30755 000042EC C3                      	retn
 30756                                  getansw_6:
 30757                                  gcpcmdo_2:	; 12/06/2023
 30758                                  gecpcmd_3:	; 12/06/2023
 30759 000042ED F9                      	stc
 30760                                  getansw_7:
 30761 000042EE C3                      	retn
 30762                                  
 30763                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30764                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:463Ah
 30765                                  init_copycmd_option:
 30766 000042EF C606[509F]01            	mov	byte [cox_y_override],1 ; suppress copy overwrite confirmation
 30767 000042F4 06                      	push	es
 30768 000042F5 8E06[539C]              	mov	es,[RESSEG]
 30769 000042F9 268E06[3A04]            	mov	es,[es:EnvirSeg]
 30770 000042FE 8D36[5F97]              	lea	si,copycmd		; "COPYCMD="
 30771 00004302 B90800                  	mov	cx,8
 30772 00004305 E83500                  	call	getenv_copycmd
 30773 00004308 7216                    	jc	short icpcmd_3
 30774 0000430A E82000                  	call	get_copycmd_option	; copycmd=/Y or copycmd=/-Y
 30775 0000430D 720F                    	jc	short icpcmd_2
 30776 0000430F 47                      	inc	di			; skip '/'
 30777 00004310 268A05                  	mov	al,[es:di]
 30778 00004313 24DF                    	and	al,0DFh			; convert to uppercase
 30779 00004315 3C59                    	cmp	al,'Y'
 30780 00004317 7505                    	jnz	short icpcmd_2
 30781                                  icpcmd_1:
 30782 00004319 C606[509F]00            	mov	byte [cox_y_override],0	; clear copy overwrite question/confirmation
 30783                                  					; (don't suppress)
 30784                                  icpcmd_2:
 30785 0000431E 07                      	pop	es
 30786 0000431F C3                      	retn
 30787                                  icpcmd_3:				; ...
 30788 00004320 8E06[539C]              	mov	es,[RESSEG]
 30789 00004324 803E[FD01]00            	cmp	byte [cox_Y_option],0	; default (/Y) switch option (1 = enabled)
 30790 00004329 74F3                    	jz	short icpcmd_2
 30791 0000432B EBEC                    	jmp	short icpcmd_1
 30792                                  
 30793                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30794                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4679h
 30795                                  get_copycmd_option:
 30796 0000432D 26803D00                	cmp	byte [es:di],0
 30797 00004331 74BA                    	jz	short gcpcmdo_2
 30798 00004333 26803D2F                	cmp	byte [es:di],'/'
 30799 00004337 7403                    	jz	short gcpcmdo_1
 30800 00004339 47                      	inc	di
 30801 0000433A EBF1                    	jmp	short get_copycmd_option
 30802                                  gcpcmdo_1:
 30803                                  	; 12/06/2023
 30804                                  	;clc
 30805                                  	; cf = 0
 30806                                  	;jmp	short gcpcmdo_3
 30807                                  	; 12/06/2023
 30808 0000433C C3                      	retn
 30809                                  	; 12/06/2023
 30810                                  ;gcpcmdo_2:
 30811                                  ;	stc
 30812                                  ;gcpcmdo_3:
 30813                                  ;	retn
 30814                                  
 30815                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30816                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:468Dh
 30817                                  getenv_copycmd:
 30818 0000433D 31FF                    	xor	di,di
 30819 0000433F 30C0                    	xor	al,al
 30820                                  gecpcmd_1:
 30821                                  	;cmp	byte [es:di],0
 30822                                  	; 12/06/2023
 30823 00004341 263805                  	cmp	[es:di],al ; 0
 30824 00004344 74A7                    	jz	short gecpcmd_3
 30825 00004346 51                      	push	cx
 30826 00004347 56                      	push	si
 30827 00004348 F3A6                    	repe	cmpsb
 30828 0000434A 5E                      	pop	si
 30829 0000434B 59                      	pop	cx
 30830 0000434C 7409                    	jz	short gecpcmd_2 ; cf = 0
 30831 0000434E 51                      	push	cx
 30832 0000434F B90080                  	mov	cx,32768
 30833 00004352 F2AE                    	repne	scasb	; al = 0
 30834 00004354 59                      	pop	cx
 30835 00004355 EBEA                    	jmp	short gecpcmd_1
 30836                                  gecpcmd_2:
 30837                                  	;clc
 30838                                  	; 12/06/2023
 30839                                  	; cf = 0
 30840                                  	;jmp	short gecpcmd_4
 30841                                  	; 12/06/2023
 30842 00004357 C3                      	retn
 30843                                  	; 12/06/2023
 30844                                  ;gecpcmd_3:
 30845                                  ;	stc
 30846                                  ;gecpcmd_4:
 30847                                  ;	retn
 30848                                  
 30849                                  ;============================================================================
 30850                                  ; COPYPR1.ASM, MSDOS 6.0, 1991
 30851                                  ;============================================================================
 30852                                  ; 01/10/2018 - Retro DOS v3.0
 30853                                  
 30854                                  ; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 2FBBh
 30855                                  
 30856                                  ; =============== S U B	R O U T	I N E =======================================
 30857                                  
 30858                                  ;***	TryFlush - flush copy buffer, double-check for concatenation
 30859                                  ;
 30860                                  ;	EXIT	ZR set if concatenate flag unchanged
 30861                                  
 30862                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30863                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3EEAh
 30864                                  
 30865                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 30866                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:46ADh
 30867                                  TRYFLUSH:
 30868 00004358 A0[689C]                	mov	al,[Concat]
 30869 0000435B 50                      	push	ax
 30870                                  	;call	FLUSHFIL
 30871 0000435C E80600                  	call	FlshFil
 30872 0000435F 58                      	pop	ax
 30873 00004360 3A06[689C]              	cmp	al,[Concat]
 30874 00004364 C3                      	retn
 30875                                  
 30876                                  ; =============== S U B	R O U T	I N E =======================================
 30877                                  
 30878                                  	; 26/03/2023
 30879                                  	; MSDOS 3.3
 30880                                  ;FLUSHFIL:
 30881                                  	;mov	al,[BINARY]
 30882                                  	;mov	ah,[ASCII]
 30883                                  	;push	ax
 30884                                  	;call	FLSHFIL
 30885                                  	;pop	ax
 30886                                  	;mov	[ASCII],ah
 30887                                  	;mov	[BINARY],al
 30888                                  	;retn
 30889                                  
 30890                                  ; =============== S U B	R O U T	I N E =======================================
 30891                                  
 30892                                  ;***	Flshfil - write out any data remaining in copy buffer.
 30893                                  ;
 30894                                  ;	Inputs:
 30895                                  ;	  [NXTADD] = No. of bytes to write
 30896                                  ;	  [CFLAG] <> 0 if file has been created
 30897                                  ;	Outputs:
 30898                                  ;	  [NXTADD] = 0
 30899                                  
 30900                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 30901                                  	;
 30902                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 30903                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:46BAh
 30904                                  FlshFil:
 30905 00004365 C606[389F]00            	mov	byte [TERMREAD],0
 30906 0000436A 803E[729C]00            	cmp	byte [CFLAG],0
 30907 0000436F 7403                    	jz	short NotExists
 30908 00004371 E99600                  	jmp	Exists
 30909                                  NotExists:
 30910 00004374 E8A101                  	call	BUILDDEST		; find out all about the destination
 30911 00004377 E8FA03                  	call	COMPNAME		; source and dest. the same?
 30912 0000437A 7519                    	jnz	short ProcDest		; if not, go ahead
 30913 0000437C 803E[D99E]00            	cmp	byte [SRCISDEV],0
 30914 00004381 7512                    	jnz	short ProcDest		; same name on device ok
 30915 00004383 803E[689C]00            	cmp	byte [Concat],0		; concatenation?
 30916 00004388 BA[F78F]                	mov	dx,OVERWR_PTR
 30917                                  	;je	short COPERR		; not concatenating - overwrite error
 30918                                  	; 26/03/2023
 30919 0000438B 7503                    	jne	short No_Concat_Err
 30920 0000438D E91201                  	jmp	COPYERR
 30921                                  	
 30922                                  No_Concat_Err:	; concatenating
 30923 00004390 C606[349F]01            	mov	byte [NOWRITE],1 	; flag not writing (just seeking)
 30924                                  ProcDest:
 30925                                  	; MSDOS 6.0
 30926                                  	;mov	ax,(ExtOpen<<8)		; open the file
 30927                                  	; 26/03/2023
 30928 00004395 B8006C                  	mov	ax,6C00h
 30929 00004398 BE[1D9E]                	mov	si,DestBuf		; get file name
 30930                                  ;M046
 30931                                  ; For writes, we want to deny writes by anyone else at the same time that we
 30932                                  ;are writing to it. For instance, on a network, 2 workstations could try
 30933                                  ;writing to the same file. Also, because we opened the source file with
 30934                                  ;DENY NONE, it is fine if the source and destination files are the same as
 30935                                  ;would happen when we append to an existing file.
 30936                                  
 30937                                  	; 26/03/2023
 30938                                  	;mov	bx,deny_write|write_open_mode
 30939 0000439B BB2100                  	mov	bx,21h			; get open mode for copy; M046
 30940 0000439E 31C9                    	xor	cx,cx			; no special files
 30941                                  	;mov	dx,write_open_flag	; set up open flags
 30942 000043A0 BA0101                  	mov	dx,101h	
 30943                                  
 30944 000043A3 803E[349F]00            	cmp	byte [NOWRITE],0
 30945 000043A8 7503                    	jne	short DoDestOpen	; don't actually create if nowrite set
 30946                                  	;mov	dx,creat_open_flag	; set up create flags
 30947 000043AA BA1201                  	mov	dx,112h
 30948                                  
 30949                                  	; 26/03/2023
 30950                                  	; MSDOS 3.3
 30951                                  	;mov	ax,(OPEN*256)+1 ; 3D01h ; open file, write access
 30952                                  	;cmp	byte [NOWRITE],0
 30953                                  	;jne	short DODESTOPEN
 30954                                  	;mov	ah,CREAT ; 3Ch
 30955                                  	;xor	cx,cx
 30956                                  ;DODESTOPEN:
 30957                                  	;mov	dx,DESTBUF
 30958                                  	;int	21h	; DOS -	2+ - CREATE A FILE WITH	HANDLE (CREAT)
 30959                                  	;		; CX = attributes for file
 30960                                  	;		; DS:DX	-> ASCIZ filename (may include drive and path)
 30961                                  
 30962                                  ; 26/03/2023
 30963                                  ;	; MSDOS 3.3 - COMMAND.COM, transient portion/segment offset 301Ch
 30964                                  ;	;mov	dx,FULDIRPTR
 30965                                  ;	;call	GET_EXT_ERR_NUMBER
 30966                                  ;	;jc	short COPERR
 30967                                  ;
 30968                                  ;	; 01/10/2018
 30969                                  ;	;jnc	short DEST_OPEN_OKAY
 30970                                  ;		
 30971                                  ;	;mov	dx,FULDIRPTR
 30972                                  ;	;call	GET_EXT_ERR_NUMBER
 30973                                  ;	;jmp	short COPERR
 30974                                  ;
 30975                                  ;	jc	short DEST_OPEN_ERROR
 30976                                  
 30977                                  	; 26/03/2023
 30978                                  DoDestOpen:
 30979 000043AD CD21                    	int     21h	; DOS - 4.0 - EXTENDED OPEN/CREATE
 30980                                  			; BL = open mode as in AL for normal open (INT 21h/AH=3Dh)
 30981                                  			; BH = flags
 30982                                  			; CX = create attribute
 30983                                  			; DL = action if file exists/does not exists
 30984                                  			; DH = 00h (reserved), DS:SI -> ASCIZ file name
 30985                                  
 30986                                  ;	We assume that the error is normal.
 30987                                  ;	TriageError will correct the DX value appropriately.
 30988                                  	
 30989 000043AF 7311                    	jnc	short Dest_Open_Okay
 30990                                  Xa_Set_Error:				;AN030; error occurred on XA
 30991 000043B1 E885DC                  	call	Set_Ext_Error_Msg	;AN030; get extended error
 30992                                  
 30993                                  	; 26/04/2023 - Retro DOS v4.0 ( 4.1) COMMAND.COM
 30994                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:3F46h
 30995                                  Ext_Err_Set:				;AN030;
 30996 000043B4 C706[019E][1D9E]        	mov	word [string_ptr_2],DestBuf
 30997                                  					;AN000; get address of failed string
 30998 000043BA C606[CD8F]01            	mov	byte [extend_buf_sub],one_subst ; 1 
 30999                                  					;AN030; put number of subst in control block
 31000                                  CopErrJ2:				;AN030;
 31001 000043BF E9E000                  	jmp	COPYERR			;AN030; go issue message
 31002                                  
 31003                                  ;DEST_OPEN_OKAY:
 31004                                  	; 26/03/2023
 31005                                  Dest_Open_Okay:
 31006 000043C2 A3[749E]                	mov	[DESTHAND],ax		; save handle
 31007 000043C5 C606[729C]01            	mov	byte [CFLAG],1		; destination now exists
 31008 000043CA 89C3                    	mov	bx,ax
 31009 000043CC B80044                  	mov	ax,IOCTL*256 ; 4400h 	; get device stuff
 31010 000043CF CD21                    	int	21h	   	; DOS - 2+ - IOCTL - GET DEVICE INFORMATION
 31011                                  			   	; BX = file or device handle
 31012                                  
 31013 000043D1 8816[769E]              	mov	[DESTISDEV],dl		; set dest info
 31014                                  	; 18/04/2023
 31015 000043D5 F6C280                  	test	dl,80h
 31016                                  	;test	dl,devid_ISDEV
 31017 000043D8 7430                    	jz	short Exists		; Dest not a device
 31018                                  
 31019                                  ;	Destination is device.
 31020                                  
 31021 000043DA A0[6E9C]                	mov	al,[DestSwitch]
 31022                                  	; 26/03/2023
 31023 000043DD 240C                    	and	al,0Ch
 31024                                  	;and	al,SWITCHA+SWITCHB ; 4+8
 31025 000043DF 7509                    	jnz	short TestBoth
 31026 000043E1 A0[399F]                	mov	al,[ASCII]		; neither set, use current setting
 31027 000043E4 0A06[359F]              	or	al,[BINARY]
 31028 000043E8 7416                    	jz	short ExSetA		; neither set, default to ascii
 31029                                  TestBoth:
 31030 000043EA 7A1E                    	jpe	short Exists		; both are set, ignore
 31031 000043EC A808                    	test	al,8
 31032                                  	;test	al,SWITCHB
 31033 000043EE 741A                    	jz	short Exists
 31034                                  	;mov	ax,(IOCTL shl 8) or 1
 31035 000043F0 B80144                  	mov	ax,(IOCTL<<8)|1 ; 4401h
 31036 000043F3 30F6                    	xor	dh,dh
 31037                                  	; 18/04/2023
 31038 000043F5 80CA20                  	or	dl,20h
 31039                                  	;or	dl,devid_RAW
 31040 000043F8 8816[769E]              	mov	[DESTISDEV],dl
 31041 000043FC CD21                    	int	21h	; DOS -	2+ - IOCTL - SET DEVICE	INFORMATION
 31042                                  			; BX = device handle,DH = 0
 31043                                  			; DL = device information to set (bits 0-7 from	function 0)
 31044 000043FE EB0A                    	jmp	short Exists
 31045                                  
 31046                                  	; 26/03/2023
 31047                                  	; 01/10/2018 - Retro DOS v3.0 modification
 31048                                  ;DEST_OPEN_ERROR:
 31049                                  	;mov	dx,FULDIRPTR
 31050                                  	;call	GET_EXT_ERR_NUMBER
 31051                                  ;COPERR:
 31052                                  	; 26/03/2023
 31053                                  ;CopyErrj:
 31054                                  	;jmp	short COPYERR
 31055                                  
 31056                                  ExSetA:
 31057                                  ;	What we read in may have been in binary mode, flag zapped write OK
 31058                                  
 31059 00004400 C606[399F]04            	mov	byte [ASCII],4
 31060                                  	;mov	byte [ASCII],SWITCHA	; set ascii mode
 31061 00004405 800E[339F]04            	or	byte [INEXACT],4
 31062                                  	;or	byte [INEXACT],SWITCHA	; ascii -> inexact
 31063                                  Exists:
 31064 0000440A 803E[349F]00            	cmp	byte [NOWRITE],0
 31065 0000440F 7524                    	jnz	short NoChecking	; if nowrite don't bother with name check
 31066 00004411 803E[F79D]01            	cmp	byte [plus_comma],1	; don't check if just doing +,,
 31067 00004416 741D                    	jz	short NoChecking
 31068 00004418 E85903                  	call	COMPNAME		; source and dest. the same?
 31069 0000441B 7518                    	jnz	short NoChecking	; if not, go ahead
 31070 0000441D 803E[D99E]00            	cmp	byte [SRCISDEV],0
 31071 00004422 7511                    	jne	short NoChecking	; same name on device ok
 31072                                  
 31073                                  ;	At this point we know in append (would have gotten overwrite error
 31074                                  ;	on first destination create otherwise), and user trying to specify
 31075                                  ;	destination which has been scribbled already (if dest had been named
 31076                                  ;	first, NoWrite would be set).
 31077                                  
 31078 00004424 BA[FA8F]                	mov	dx,LOSTERR_PTR		; tell him he's not going to get it
 31079                                  	;invoke	Std_EprintF		;ac022;
 31080                                  	; 26/03/2023
 31081 00004427 E8EB0F                  	call	std_eprintf ; MSDOS 6.0 (& 5.0)
 31082                                  	;call	STD_PRINTF  ; MSDOS 3.3	
 31083 0000442A C706[789C]0000          	mov	word [NXTADD],0		; set return
 31084 00004430 FE06[389F]              	inc	byte [TERMREAD]		; tell read to give up
 31085                                  Ret60:
 31086 00004434 C3                      	retn
 31087                                  
 31088                                  NoChecking:
 31089 00004435 8B1E[749E]              	mov	bx,[DESTHAND]		; get handle
 31090 00004439 31C9                    	xor	cx,cx
 31091 0000443B 870E[789C]              	xchg	cx,[NXTADD]
 31092 0000443F E3F3                    	jcxz	Ret60			; if nothing to write, forget it
 31093 00004441 FF06[369F]              	inc	word [WRITTEN]		; flag that we wrote something
 31094 00004445 803E[349F]00            	cmp	byte [NOWRITE],0	; if nowrite set, just seek cx bytes
 31095 0000444A 7514                    	jnz	short SeekEnd
 31096 0000444C 31D2                    	xor	dx,dx
 31097 0000444E 1E                      	push	ds
 31098 0000444F 8E1E[559C]              	mov	ds,[TPA]
 31099 00004453 B440                    	mov	ah,Write ; 40h
 31100 00004455 CD21                    	int	21h	; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 31101                                  			; BX = file handle,CX = number	of bytes to write,DS:DX -> buffer
 31102 00004457 1F                      	pop	ds
 31103 00004458 BA[DF8F]                	mov	dx,NOSPACE_PTR
 31104                                  	;jc	short COPERRP		; failure
 31105                                  	; 26/03/2023
 31106                                  	; MSDOS 6.0
 31107 0000445B 7326                    	jnc	short NoChecking2
 31108 0000445D E951FF                  	jmp	Xa_Set_Error
 31109                                  
 31110                                  	; 18/04/2023
 31111                                  	; 26/03/2023
 31112                                  SeekEnd:
 31113 00004460 31D2                    	xor	dx,dx
 31114 00004462 87D1                    	xchg	dx,cx
 31115                                  	;mov	ax,(LSEEK shl 8) or 1
 31116 00004464 B80142                  	mov	ax,(LSEEK<<8)|1 ; 4201h
 31117 00004467 CD21                    	int	21h		; DOS -	2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
 31118                                  				; AL = method: offset from present location
 31119                                  
 31120                                  	; 26/03/2023
 31121                                  	; MSDOS 6.0
 31122                                  
 31123                                  ;	Save the file pointer in DX:AX to restore the file
 31124                                  ;	with in case the copy should fail.
 31125                                  
 31126 00004469 A3[409F]                	mov	[OFilePtr_Lo],ax
 31127 0000446C 8916[429F]              	mov	[OFilePtr_Hi],dx
 31128                                  
 31129                                  	; 26/03/2023
 31130                                  	; MSDOS 3.3  MSDOS 6.0
 31131                                  
 31132 00004470 803E[669C]00            	cmp	byte [RDEOF],0
 31133 00004475 740B                    	jz	short Retz60
 31134                                  
 31135                                  ;	^Z has been read - we must set the file size to the current
 31136                                  ;	file pointer location
 31137                                  
 31138 00004477 B440                    	mov	ah,Write ; 40h
 31139 00004479 CD21                    	int	21h		; DOS -	2+ - WRITE TO FILE WITH	HANDLE
 31140                                  				; BX = file handle,CX = number	of bytes to write,DS:DX -> buffer
 31141                                  
 31142                                  	; 26/03/2023
 31143                                  	; MSDOS 6.0
 31144 0000447B 727E                    	jc	short Xa_Set_Error_Jmp	;AC022; failure
 31145                                  
 31146                                  ;	Make note that ^Z was removed, in case the
 31147                                  ;	copy should fail and we need to restore the file.
 31148                                  
 31149 0000447D C606[449F]1A            	mov	byte [OCtrlZ],1Ah
 31150                                  Retz60:
 31151 00004482 C3                      	retn
 31152                                  
 31153                                  NoChecking2:
 31154 00004483 29C1                    	sub	cx,ax
 31155 00004485 74AD                    	jz	short Ret60		; wrote all supposed to
 31156                                  	; 18/04/2023
 31157 00004487 F606[769E]80            	test	byte [DESTISDEV],80h ; devid_ISDEV
 31158                                  	;test	byte [DESTISDEV],devid_ISDEV ;80h
 31159 0000448C 7414                    	jz	short COPYERR		; is a file, error
 31160 0000448E F606[769E]20            	test	byte [DESTISDEV],20h  ; devid_RAW
 31161                                  	;test	byte [DESTISDEV],devid_RAW ; 20h
 31162 00004493 750A                    	jnz	short DevWrtErr	; is a raw device, error
 31163 00004495 803E[339F]00            	cmp	byte [INEXACT],0
 31164 0000449A 7598                    	jnz	short Ret60		; inexact so ok
 31165 0000449C 49                      	dec	cx
 31166                                  ;Retz60:
 31167 0000449D 7495                    	jz	short Ret60		; wrote one byte less (the ^z)		
 31168                                  
 31169                                  DevWrtErr:
 31170 0000449F BA[8791]                	mov	dx,DEVWMES_PTR
 31171                                  	; 26/03/2023
 31172                                  COPYERR:
 31173                                  	;invoke	Std_EPrintF		;AC022;
 31174 000044A2 E8700F                  	call	std_eprintf  ; MSDOS 6.0
 31175                                  	;call	STD_PRINTF   ; MSDOS 3.3
 31176                                  CopErrP:
 31177 000044A5 FE06[739C]              	inc	byte [DestClosed]
 31178 000044A9 803E[729C]00            	cmp	byte [CFLAG],0
 31179 000044AE 7448                    	jz	short EndCopyJ		; never actually got it open
 31180 000044B0 8B1E[749E]              	mov	bx,[DESTHAND]
 31181 000044B4 83FB00                  	cmp	bx,0
 31182 000044B7 7E33                    	jle	short NoClose
 31183                                  
 31184                                  ;	Check to see if we should save part of the destination file.
 31185                                  
 31186                                  	; 26/03/2023
 31187                                  	; MSDOS 6.0
 31188 000044B9 8B0E[429F]              	mov	cx,[OFilePtr_Hi]	; CX = hi word of original file ptr
 31189 000044BD 8B16[409F]              	mov	dx,[OFilePtr_Lo]	; DX = lo word of original file ptr
 31190                                  			
 31191 000044C1 89C8                    	mov	ax,cx
 31192 000044C3 09D0                    	or	ax,dx
 31193 000044C5 7421                    	jz	short ceClose		; null file ptr means nothing to save
 31194                                  
 31195                                  ;	Destination was also the first source. Do the best we can to
 31196                                  ;	restore it. Truncate it back to the size we took from it (which
 31197                                  ;	may have been due to a Ctrl-Z, so may not have included the whole
 31198                                  ;	file). If a Ctrl-Z was originally read, put it back.
 31199                                  
 31200 000044C7 B80042                  	mov	ax,(LSEEK<<8) ; 4200h
 31201 000044CA CD21                    	int	21h
 31202                                  
 31203 000044CC 31C9                    	xor	cx,cx			; CX = # bytes to write = 0
 31204 000044CE B440                    	mov	ah,Write ; 40h
 31205 000044D0 CD21                    	int	21h			; truncate file
 31206                                  
 31207 000044D2 803E[449F]00            	cmp	byte [OCtrlZ],0
 31208 000044D7 7408                    	je	short ceClose0		; no ctrl-z removed from original
 31209 000044D9 41                      	inc	cx			; CX = # bytes to write = 1
 31210 000044DA BA[449F]                	mov	dx,OCtrlZ		; DS:DX = ptr to original ctrl-z
 31211 000044DD B440                    	mov	ah,Write ; 40h
 31212 000044DF CD21                    	int	21h			; write ctrl-z
 31213                                  ceClose0:
 31214 000044E1 B43E                    	mov	ah,CLOSE ; 3Eh
 31215 000044E3 CD21                    	int	21h			; close it
 31216                                  ;;	;mov	byte [CFLAG],0
 31217 000044E5 E9ECF8                  	jmp	ENDCOPY			; and go home
 31218                                  
 31219                                  	; MSDOS 3.3 (& MSDOS 6.0)
 31220                                  ceClose:
 31221 000044E8 B43E                    	mov	ah,CLOSE ; 3Eh		; close the file
 31222 000044EA CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 31223                                  				; BX = file handle
 31224                                  NoClose:
 31225 000044EC BA[1D9E]                	mov	dx,DestBuf
 31226 000044EF B441                    	mov	ah,Unlink ; 41h 	; and delete it
 31227 000044F1 CD21                    	int	21h		; DOS -	2+ - DELETE A FILE (UNLINK)
 31228                                  				; DS:DX	-> ASCIZ pathname of file to delete (no	wildcards allowed)
 31229 000044F3 C606[729C]00            	mov	byte [CFLAG],0
 31230                                  EndCopyJ:
 31231 000044F8 E9D9F8                  	jmp	ENDCOPY
 31232                                  
 31233                                  Xa_Set_Error_Jmp:			;AN022; go set up error message
 31234 000044FB E9B3FE                  	jmp	Xa_Set_Error
 31235                                  
 31236                                  ;============================================================================
 31237                                  ; COPYPR2.ASM, MSDOS 6.0, 1991
 31238                                  ;============================================================================
 31239                                  ; 01/10/2018 - Retro DOS v3.0
 31240                                  
 31241                                  ; MSDOS 3.3 COMMAND.COM (1987) Transient portion offset 311Fh
 31242                                  
 31243                                  	; 26/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31244                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4095h
 31245                                  
 31246                                  ; =============== S U B	R O U T	I N E =======================================
 31247                                  
 31248                                  ;***	SetAsc - set Ascii, Binary, Inexact flags based on switches
 31249                                  ;
 31250                                  ;	Given switch vector in AX,
 31251                                  ;	  Set Ascii flag if /a is set
 31252                                  ;	  Clear Ascii flag if /b is set
 31253                                  ;	  Binary set if /b specified
 31254                                  ;	  Leave Ascii unchanged if neither or both are set
 31255                                  ; 	Also sets Inexact if Ascii is ever set. 
 31256                                  ;	AL = Ascii on exit, flags set
 31257                                  
 31258                                  	; 26/03/2023
 31259                                  SETASC:
 31260                                  	;and	al,SWITCHA+SWITCHB ; 0Ch ; AL = /a, /b flags
 31261 000044FE 240C                    	and	al,0Ch ; 4+8
 31262 00004500 7A10                    	jpe	short LOADSW	; even parity - both or neither
 31263 00004502 50                      	push	ax
 31264                                  	;and	al,SWITCHB  ; 8
 31265 00004503 2408                    	and	al,8
 31266 00004505 A2[359F]                	mov	[BINARY],al
 31267 00004508 58                      	pop	ax
 31268                                  	;and	al,SWITCHA
 31269 00004509 2404                    	and	al,4	
 31270 0000450B A2[399F]                	mov	[ASCII],al
 31271 0000450E 0806[339F]              	or	[INEXACT],al
 31272                                  LOADSW:
 31273 00004512 A0[399F]                	mov	al,[ASCII]
 31274 00004515 08C0                    	or	al,al
 31275 00004517 C3                      	retn
 31276                                  
 31277                                  ; =============== S U B	R O U T	I N E =======================================
 31278                                  
 31279                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31280                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 31281                                  BUILDDEST:
 31282 00004518 803E[189E]FF            	cmp	byte [DestIsDir],-1 ; 0FFh
 31283 0000451D 750C                    	jnz	short KNOWABOUTDEST	; figuring already done
 31284 0000451F BF[359B]                	mov	di,USERDIR1
 31285 00004522 BD[189E]                	mov	bp,DestVars
 31286 00004525 E8E000                  	call	BUILDPATH
 31287 00004528 E8F6E2                  	call	RestUDir1
 31288                                  
 31289                                  ;	We now know all about the destination
 31290                                  
 31291                                  KNOWABOUTDEST:
 31292 0000452B 30C0                    	xor	al,al
 31293 0000452D 8606[779E]              	xchg	al,[FIRSTDEST]
 31294 00004531 08C0                    	or	al,al
 31295 00004533 7503                    	jnz	short FIRSTDST
 31296 00004535 E98D00                  	jmp	NOFIRSTDEST
 31297                                  
 31298                                  FIRSTDST:
 31299                                  ;	Create an fcb of the original dest.
 31300                                  
 31301 00004538 8B36[1A9E]              	mov	si,[DestTail]
 31302 0000453C BF[579D]                	mov	di,DestFcb
 31303 0000453F B80029                  	mov	ax,Parse_File_Descriptor*256 ; 2900h
 31304 00004542 CD21                    	int	21h		; DOS -	PARSE FILENAME
 31305                                  				; DS:SI	-> string to parse
 31306                                  				; ES:DI	-> buffer to fill with unopened	FCB
 31307                                  				; AL = bit mask	to control parsing
 31308 00004544 803C00                  	cmp	byte [si],0
 31309 00004547 7406                    	jz	short GOODPARSE
 31310                                  
 31311                                  	; 27/03/2023	
 31312                                  	; MSDOS 6.0
 31313                                  	;mov	byte [di+1],"|"	;AD052; must be illegal file name character
 31314                                  	
 31315 00004549 BA[E58F]                	mov	dx,FULLDIR_PTR		;AN052; issue "file creation error"
 31316 0000454C E953FF                  	jmp	COPYERR			;AN052;
 31317                                  GOODPARSE:
 31318 0000454F A1[1D9E]                	mov	ax,[DestBuf]		; AX = possible "d:"
 31319 00004552 80FC3A                  	cmp	ah,':'
 31320 00004555 7402                    	jz	short DRVSPEC4
 31321 00004557 B040                    	mov	al,'@'  ; 40h
 31322                                  DRVSPEC4:
 31323                                  ;	AX = "d:" for following FCB drive computation
 31324                                  
 31325 00004559 8A0E[399F]              	mov	cl,[ASCII]		; CL = saved Ascii flag
 31326 0000455D 0C20                    	or	al,20h
 31327 0000455F 2C60                    	sub	al,60h
 31328 00004561 A2[579D]                	mov	[DestFcb],al		; store drive # in FCB
 31329                                  
 31330                                  ;*	Figure out what copy mode we're in.
 31331                                  ;	Letters stand for unambiguous, * for ambiguous pathnames.
 31332                                  ;	+n stands for additional sources delimited by +'s.
 31333                                  ;
 31334                                  ;	copy a b	not concatenating
 31335                                  ;	copy a *	not concatenating
 31336                                  ;	copy * a	concatenating
 31337                                  ;	copy * *	not concatenating
 31338                                  ;	copy a+n b	concatenating
 31339                                  ;	copy *+n a	concatenating
 31340                                  ;	copy *+n *	concatenating, Mel Hallerman style
 31341                                  
 31342                                  ;	Bugbug:  copy *.a+a.b *.t  picks up only 1st *.a file.. Why?
 31343                                  ;		 copy a.b+*.a *.t  picks up all *.a files.
 31344                                  
 31345 00004564 A0[1C9E]                	mov	al,[DestInfo]		; AL = destination CParse flags
 31346 00004567 8A26[7F9E]              	mov	ah,[SrcInfo]		; AH = source CParse flags
 31347 0000456B 250202                  	and	ax,202h			; AH,AL = source,dest wildcard flags
 31348 0000456E 08C0                    	or	al,al
 31349 00004570 7413                    	jz	short NOTMELCOPY 	; no destination wildcard
 31350                                  
 31351                                  ;	Destination is wildcarded.
 31352                                  	
 31353 00004572 38E0                    	cmp	al,ah
 31354 00004574 750F                    	jnz	short NOTMELCOPY ; no source wildcard
 31355                                  
 31356                                  ;	Source and destination are both wildcarded.
 31357                                  
 31358 00004576 803E[3A9F]00            	cmp	byte [PLUS],0
 31359 0000457B 7408                    	jz	short NOTMELCOPY	; no +'s in source
 31360                                  
 31361                                  ;	Source and destination are wildcarded, and source includes +'s.
 31362                                  ;	It's Mel Hallorman copy time.
 31363                                  
 31364 0000457D FE06[789E]              	inc	byte [MELCOPY]		; 'Mel copy' = true
 31365 00004581 30C0                    	xor	al,al
 31366 00004583 EB06                    	jmp	short SETCONC
 31367                                  
 31368                                  NOTMELCOPY:
 31369 00004585 3402                    	xor	al,2			; AL=0 -> ambiguous destination, 2 otherwise
 31370 00004587 20E0                    	and	al,ah
 31371 00004589 D0E8                    	shr	al,1			; AL=1 -> ambiguous source, unambiguous dest
 31372                                  					;   (implies concatenation)
 31373                                  SETCONC:
 31374 0000458B 0A06[3A9F]              	or	al,[PLUS]		; "+" always infers concatenation
 31375                                  
 31376                                  ;	Whew. AL = 1 if concatenating, 0 if not.
 31377                                  
 31378 0000458F A2[689C]                	mov	[Concat],al
 31379 00004592 D0E0                    	shl	al,1
 31380 00004594 D0E0                    	shl	al,1
 31381 00004596 A2[339F]                	mov	[INEXACT],al		; concatenation -> inexact copy
 31382 00004599 803E[359F]00            	cmp	byte [BINARY],0
 31383 0000459E 7525                    	jne	short NOFIRSTDEST 	; explicit binary copy	
 31384                                  
 31385                                  	; 13/06/2023 - Retro DOS v4.2 COMMAND.COM
 31386                                  	; MSDOS 6.0 (MSDOS.50)
 31387                                  	;mov	[ASCII],al		; otherwise, concatenate in ascii mode
 31388                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:48FAh
 31389 000045A0 0806[399F]              	or	[ASCII],al	
 31390                                  
 31391 000045A4 08C9                    	or	cl,cl
 31392 000045A6 751D                    	jnz	short NOFIRSTDEST 	; Ascii flag set before, data read correctly	
 31393 000045A8 08C0                    	or	al,al
 31394 000045AA 7419                    	jz	short NOFIRSTDEST 	; Ascii flag did not change state
 31395                                  
 31396                                  ;	At this point there may already be binary read data in the read
 31397                                  ;	buffer. We need to find the first ^Z (if there is one) and trim the
 31398                                  ;	amount of data in the buffer correctly.
 31399                                  
 31400 000045AC 8B0E[789C]              	mov	cx,[NXTADD]
 31401 000045B0 E313                    	jcxz	NOFIRSTDEST		; no data, everything ok
 31402 000045B2 B01A                    	mov	al,1Ah
 31403 000045B4 06                      	push	es
 31404 000045B5 31FF                    	xor	di,di
 31405 000045B7 8E06[559C]              	mov	es,[TPA]
 31406 000045BB F2AE                    	repne	scasb			; scan for EOF
 31407 000045BD 07                      	pop	es
 31408 000045BE 7505                    	jnz	short NOFIRSTDEST 	; no ^z in buffer, everything ok
 31409 000045C0 4F                      	dec	di			; point at ^z
 31410 000045C1 893E[789C]              	mov	[NXTADD],di		; new buffer length
 31411                                  
 31412                                  NOFIRSTDEST:
 31413 000045C5 BB[9B9D]                	mov	bx,DIRBUF+1		; Source of replacement chars
 31414 000045C8 803E[689C]00            	cmp	byte [Concat],0
 31415 000045CD 7403                    	jz	short GOTCHRSRC		; Not a concat
 31416 000045CF BB[E19D]                	mov	bx,SDIRBUF+1		; Source of replacement chars
 31417                                  GOTCHRSRC:
 31418 000045D2 BE[589D]                	mov	si,DestFcb+1		; Original dest name
 31419 000045D5 8B3E[1A9E]              	mov	di,[DestTail]		; Where to put result
 31420                                  
 31421                                  ; --------------- S U B	R O U T	I N E --------------------------------------- 
 31422                                  
 31423                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31424                                  BUILDNAME:
 31425 000045D9 B90800                  	mov	cx,8
 31426                                  BUILDMAIN:
 31427 000045DC AC                      	lodsb
 31428 000045DD 3C3F                    	cmp	al,'?'
 31429 000045DF 7502                    	jne	short NOTAMBIG
 31430 000045E1 8A07                    	mov	al,[bx]
 31431                                  NOTAMBIG:
 31432 000045E3 3C20                    	cmp	al,' '
 31433 000045E5 7401                    	je	short NOSTORE
 31434 000045E7 AA                      	stosb
 31435                                  NOSTORE:
 31436 000045E8 43                      	inc	bx
 31437 000045E9 E2F1                    	loop	BUILDMAIN
 31438 000045EB B103                    	mov	cl,3
 31439                                  	;mov	al,' ' ; 20h
 31440                                  	;cmp	[si],al
 31441                                  	; 27/03/2023
 31442 000045ED 803C20                  	cmp	byte [si],20h ; ' '
 31443 000045F0 7412                    	je	short ENDDEST		; No extension
 31444                                  	;mov	al,[DOT_CHR]
 31445                                  	; 27/03/2023
 31446 000045F2 B02E                    	mov	al,'.' ; 2Eh ; dot_chr
 31447 000045F4 AA                      	stosb
 31448                                  BUILDEXT:
 31449 000045F5 AC                      	lodsb
 31450 000045F6 3C3F                    	cmp	al,'?'
 31451 000045F8 7502                    	jne	short NOTAMBIGE
 31452 000045FA 8A07                    	mov	al,[bx]
 31453                                  NOTAMBIGE:
 31454 000045FC 3C20                    	cmp	al,' '
 31455 000045FE 7401                    	je	short NOSTOREE
 31456 00004600 AA                      	stosb
 31457                                  NOSTOREE:
 31458 00004601 43                      	inc	bx
 31459 00004602 E2F1                    	loop	BUILDEXT
 31460                                  ENDDEST:
 31461 00004604 30C0                    	xor	al,al
 31462 00004606 AA                      	stosb				; NUL terminate
 31463 00004607 C3                      	retn
 31464                                  
 31465                                  ; =============== S U B	R O U T	I N E =======================================
 31466                                  
 31467                                  	; 28/03/2023
 31468                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31469                                  	;
 31470                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31471                                  BUILDPATH:
 31472 00004608 F6460402                	test	byte [bp+VARSTRUC.INFO],2 ; test byte [bp+4],2
 31473 0000460C 7543                    	jnz	short NOTPFILE		; If ambig don't bother with open
 31474 0000460E 89EA                    	mov	dx,bp			; Set DX to spec
 31475 00004610 83C205                  	add	dx,VARSTRUC.BUF 	; add dx,5
 31476                                  
 31477                                  	; 27/03/2023
 31478                                  	; MSDOS 6.0
 31479 00004613 57                      	push	di			;AN000;
 31480 00004614 B8006C                  	mov	ax,(ExtOpen<<8)	; 6C00h	;AC000; open the file
 31481                                  	;mov	bx,deny_none|read_open_mode
 31482 00004617 BB4000                  	mov	bx,40h			; open mode for COPY ;M046
 31483 0000461A 31C9                    	xor	cx,cx			;AN000; no special files
 31484 0000461C 89D6                    	mov	si,dx			;AN030; get file name offset
 31485                                  	;mov	dx,read_open_flag	;AN000; set up open flags
 31486 0000461E BA0101                  	mov	dx,101h
 31487 00004621 CD21                    	INT	21h
 31488 00004623 5F                      	pop	di			;AN000;
 31489 00004624 7315                    	jnc	short PURE_FILE		;AN022; is pure file
 31490 00004626 E820DA                  	call	get_ext_error_number	;AN022; get the extended error
 31491                                  	;cmp	ax,2
 31492 00004629 83F802                  	cmp	ax,ERROR_FILE_NOT_FOUND ;AN022; if file not found - okay
 31493 0000462C 7423                    	jz	short NOTPFILE		;AN022;
 31494                                  	;cmp	ax,3
 31495 0000462E 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found - okay
 31496 00004631 741E                    	jz	short NOTPFILE		;AN022;
 31497                                  	;cmp	ax,5
 31498 00004633 83F805                  	cmp	ax,ERROR_ACCESS_DENIED	;AN022; if access denied - okay
 31499 00004636 7419                    	jz	short NOTPFILE		;AN022;
 31500 00004638 E943D7                  	jmp	extend_setup		;AN022; exit with error
 31501                                  
 31502                                  	; 27/03/2023
 31503                                  	; MSDOS 3.3
 31504                                  	;mov	ax,OPEN*256 ; 3D00h
 31505                                  	;int	21h		; DOS -	2+ - OPEN DISK FILE WITH HANDLE
 31506                                  	;			; DS:DX	-> ASCIZ filename
 31507                                  	;			; AL = access mode
 31508                                  	;			; 0 - read
 31509                                  	;jc	short NOTPFILE
 31510                                  
 31511                                  PURE_FILE:
 31512 0000463B 89C3                    	mov	bx,ax
 31513 0000463D B80044                  	mov	ax,IOCTL*256 ; 4400h
 31514 00004640 CD21                    	int	21h		; DOS -	2+ - IOCTL - GET DEVICE	INFORMATION
 31515                                  				; BX = file or device handle
 31516 00004642 B43E                    	mov	ah,CLOSE ;3Eh
 31517 00004644 CD21                    	int	21h		; DOS -	2+ - CLOSE A FILE WITH HANDLE
 31518                                  				; BX = file handle
 31519                                  	; 18/04/2023
 31520 00004646 F6C280                  	test	dl,80h
 31521                                  	;test	dl,devid_ISDEV ; test dl,80h
 31522 00004649 7553                    	jnz	short ISADEV
 31523 0000464B F6460404                	test	byte [bp+VARSTRUC.INFO],4 ; test byte [bp+4],4
 31524 0000464F 744D                    	jz	short ISADEV
 31525                                  NOTPFILE:
 31526 00004651 8B5605                  	mov	dx,[bp+VARSTRUC.BUF] ; mov dx,[bp+5]
 31527                                  	
 31528                                  	; 27/03/2023	
 31529                                  	; MSDOS 6.0
 31530 00004654 80FA00                  	cmp	dl,0		     	;AN034; If no drive specified, get
 31531 00004657 7405                    	je	short SET_DRIVE_SPEC	;AN034;    default drive dir
 31532                                  
 31533 00004659 80FE3A                  	cmp	dh,':'
 31534 0000465C 7402                    	je	short DRVSPEC5
 31535                                  SET_DRIVE_SPEC:
 31536 0000465E B240                    	mov	dl,'@' ; 40h
 31537                                  DRVSPEC5:
 31538 00004660 80CA20                  	or	dl,20h
 31539 00004663 80EA60                  	sub	dl,60h		; A = 1
 31540 00004666 E8EAE2                  	call	SAVUDIR1
 31541                                  	
 31542                                  	; 27/03/2023
 31543                                  	; MSDOS 6.0
 31544 00004669 7306                    	jnc	short CURDIR_OK		;AN022; if error - exit
 31545 0000466B E8DBD9                  	call	get_ext_error_number	;AN022; get the extended error
 31546 0000466E E90DD7                  	jmp	extend_setup		;AN022; exit with error
 31547                                  
 31548                                  CURDIR_OK:
 31549 00004671 89EA                    	mov	dx,bp
 31550                                  	;add	dx,5
 31551 00004673 83C205                  	add	dx,VARSTRUC.BUF		; Set DX for upcomming CHDIRs
 31552                                  	;mov	bh,[bp+4]
 31553 00004676 8A7E04                  	mov	bh,[bp+VARSTRUC.INFO]
 31554 00004679 80E706                  	and	bh,6
 31555 0000467C 80FF06                  	cmp	bh,6			; Ambig and path ?
 31556 0000467F 7518                    	jne	short CHECKAMB		; jmp if no
 31557                                  	;mov	si,[bp+2]
 31558 00004681 8B7602                  	mov	si,[bp+VARSTRUC.TTAIL]
 31559 00004684 B33A                    	mov	bl,':'
 31560 00004686 385CFE                  	cmp	[si-2],bl
 31561 00004689 7506                    	jne	short KNOWNOTSPEC
 31562                                  	;mov	byte [bp+VARSTRUC.ISDIR],2
 31563                                  					; Know is d:/file
 31564                                  	;mov	byte [bp+0],2
 31565 0000468B C6460002                	mov	byte [bp],2
 31566 0000468F EB05                    	jmp	short DOPCDJ
 31567                                  KNOWNOTSPEC:
 31568                                  	;mov	byte [bp+VARSTRUC.ISDIR],1
 31569                                  					; Know is path/file
 31570                                  	;mov	byte [bp+0],1		
 31571 00004691 C6460001                	mov	byte [bp],1
 31572 00004695 4E                      	dec	si
 31573                                  DOPCDJ:
 31574 00004696 E98300                  	jmp	DOPCD
 31575                                  CHECKAMB:
 31576 00004699 80FF02                  	cmp	bh,2
 31577 0000469C 7505                    	jnz	short CHECKCD
 31578                                  ISSIMPFILE:
 31579                                  ISADEV:
 31580                                  	;mov	byte [bp+VARSTRUC.ISDIR],0
 31581                                  	;mov	byte [bp+0],0		
 31582 0000469E C6460000                	mov	byte [bp],0
 31583 000046A2 C3                      	retn
 31584                                  CHECKCD:
 31585 000046A3 E86CEA                  	call	SetRest1
 31586 000046A6 B43B                    	mov	ah,CHDir ; 3Bh
 31587 000046A8 CD21                    	int	21h		; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 31588                                  				; DS:DX	-> ASCIZ directory name	(may include drive)
 31589 000046AA 7239                    	jb	short NOTPDIR
 31590 000046AC 89D7                    	mov	di,dx
 31591 000046AE 31C0                    	xor	ax,ax
 31592 000046B0 89C1                    	mov	cx,ax
 31593 000046B2 49                      	dec	cx
 31594                                  	; 14/06/2023
 31595                                  	;repne	scasb	 ; MSDOS 3.3
 31596                                  
 31597                                  	; 27/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31598                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:424Ah)
 31599                                  	; MSDOS 6.0
 31600                                  Kloop:					;AN000;  3/3/KK
 31601 000046B3 268A05                  	mov	al,[es:di]		;AN000;  3/3/KK
 31602 000046B6 47                      	inc	di			;AN000;  3/3/KK
 31603 000046B7 08C0                    	or	al,al			;AN000;  3/3/KK
 31604 000046B9 740C                    	jz	short DONE		;AN000;  3/3/KK
 31605 000046BB 30E4                    	xor	ah,ah			;AN000;  3/3/KK
 31606 000046BD E89FE0                  	call	testkanj		;AN000;  3/3/KK
 31607 000046C0 74F1                    	jz	short Kloop		;AN000;  3/3/KK
 31608 000046C2 47                      	inc	di			;AN000;  3/3/KK
 31609 000046C3 FEC4                    	inc	ah			;AN000;  3/3/KK
 31610 000046C5 EBEC                    	jmp	short Kloop		;AN000;  3/3/KK
 31611                                  DONE:
 31612 000046C7 4F                      	dec	di
 31613 000046C8 A0[589C]                	mov	al,[DIRCHAR]
 31614                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; assume d:/file
 31615                                  	;mov	byte [bp+0],2
 31616 000046CB C6460002                	mov	byte [bp],2
 31617                                  	; 27/03/2023
 31618                                  	; MSDOS 6.0
 31619 000046CF 08E4                    	or	ah,ah			;AN000; 3/3/KK
 31620 000046D1 7505                    	jnz	short _STORE_PCHAR	;AN000; 3/3/KK	 this is the tra
 31621                                  	;
 31622 000046D3 3A45FF                  	cmp	al,[di-1]
 31623 000046D6 7405                    	jz	short GOTSRCSLSH
 31624                                  _STORE_PCHAR:
 31625 000046D8 AA                      	stosb
 31626                                  	;mov	byte [bp+VARSTRUC.ISDIR],1 ; know path/file
 31627                                  	;mov	byte [bp+0],1
 31628 000046D9 C6460001                	mov	byte [bp],1
 31629                                  GOTSRCSLSH:
 31630                                  	;or	byte [bp+4],6
 31631 000046DD 804E0406                	or 	byte [bp+VARSTRUC.INFO],6 
 31632 000046E1 E87400                  	call	SETSTARS
 31633                                  NOTPDIR_RETN:
 31634 000046E4 C3                      	retn
 31635                                  
 31636                                  	; 28/03/2023
 31637                                  NOTPDIR:
 31638                                  	; MSDOS 6.0
 31639 000046E5 E861D9                  	call	get_ext_error_number	;AN022; get the extended error
 31640                                  	;cmp	ax,3
 31641 000046E8 83F803                  	cmp	ax,ERROR_PATH_NOT_FOUND ;AN022; if path not found - okay
 31642 000046EB 7405                    	je	short NOTPDIR_TRY	;AN022;
 31643                                  	;cmp	ax,5
 31644 000046ED 83F805                  	cmp	ax,ERROR_ACCESS_DENIED	;AN022; if access denied - okay
 31645 000046F0 7560                    	jne	short EXTEND_SETUPJ	;AN022; otherwise - exit error
 31646                                  NOTPDIR_TRY:
 31647                                  	; MSDOS 3.3 (& MSDOS 6.0)
 31648                                  	;mov	byte [bp+VARSTRUC.ISDIR],0
 31649                                  	;mov	byte [bp+0],0
 31650 000046F2 C6460000                	mov	byte [bp],0
 31651                                  	;mov	bh,[bp+4]
 31652 000046F6 8A7E04                  	mov	bh,[bp+VARSTRUC.INFO]
 31653 000046F9 F6C704                  	test	bh,4
 31654 000046FC 74E6                    	jz	short NOTPDIR_RETN	; Know pure file, no path seps
 31655                                  	;mov	byte [bp+VARSTRUC.ISDIR],2 ; assume d:/file
 31656                                  	;mov	byte [bp+0],2		
 31657 000046FE C6460002                	mov	byte [bp],2
 31658                                  	;mov	si,[bp+2]
 31659 00004702 8B7602                  	mov	si,[bp+VARSTRUC.TTAIL]
 31660 00004705 803C00                  	cmp	byte [si],0
 31661 00004708 744B                    	je	short BADCDERRJ2	; Trailing '/'	
 31662                                  	;mov	bl,[DOT_CHR]
 31663                                  	; 28/03/2023 - Retro DOS v4.0 COMMAND.COM
 31664                                  	; MSDOS 6.0 (& 5.0) COMMAND.COM
 31665 0000470A B32E                    	mov	bl,'.'  ; 2Eh ; dot_chr
 31666 0000470C 381C                    	cmp	[si],bl
 31667 0000470E 7445                    	je	short BADCDERRJ2	; If . or .. pure cd should have worked
 31668 00004710 B33A                    	mov	bl,':'  ; 3Ah
 31669 00004712 385CFE                  	cmp	[si-2],bl
 31670 00004715 7405                    	je	short DOPCD		; Know d:/file
 31671                                  	;mov	byte [bp+VARSTRUC.ISDIR],1 
 31672                                  					; Know path/file
 31673                                  	;mov	byte [bp+0],1
 31674 00004717 C6460001                	mov	byte [bp],1
 31675 0000471B 4E                      	dec	si			; Point at last '/'
 31676                                  DOPCD:
 31677 0000471C 30DB                    	xor	bl,bl
 31678 0000471E 861C                    	xchg	bl,[si]			; Stick in a NUL
 31679 00004720 E8EFE9                  	call	SetRest1
 31680                                  
 31681                                  	; 28/03/2023
 31682                                  	; MSDOS 6.0 (& MSDOS 5.0)
 31683 00004723 39F2                    	cmp	dx,si			;AN000;  3/3/KK
 31684 00004725 771B                    	ja	short LookBack		;AN000;  3/3/KK
 31685 00004727 56                      	push	si			;AN000;  3/3/KK
 31686 00004728 51                      	push	cx			;AN000;  3/3/KK
 31687 00004729 89F1                    	mov	cx,si			;AN000;  3/3/KK
 31688 0000472B 89D6                    	mov	si,dx			;AN000;  3/3/KK
 31689                                  Kloop2: 				;AN000;  3/3/KK
 31690 0000472D AC                      	lodsb				;AN000;  3/3/KK
 31691 0000472E E82EE0                  	call	testkanj		;AN000;  3/3/KK
 31692 00004731 7409                    	jz	short NotKanj4		;AN000;  3/3/KK
 31693 00004733 AC                      	lodsb				;AN000;  3/3/KK
 31694 00004734 39CE                    	cmp	si,cx			;AN000;  3/3/KK
 31695 00004736 72F5                    	jb	short Kloop2		;AN000;  3/3/KK
 31696 00004738 59                      	pop	cx			;AN000;  3/3/KK
 31697 00004739 5E                      	pop	si			;AN000;  3/3/KK
 31698 0000473A EB0B                    	jmp	short DoCdr		;AN000;  3/3/KK  Last char is ECS code, don't check for
 31699                                  					;		 trailing path sep
 31700                                  NotKanj4:				;AN000;  3/3/KK
 31701 0000473C 39CE                    	cmp	si,cx			;AN000;  3/3/KK
 31702 0000473E 72ED                    	jb	short Kloop2		;AN000;  3/3/KK
 31703 00004740 59                      	pop	cx			;AN000;  3/3/KK
 31704 00004741 5E                      	pop	si			;AN000;  3/3/KK
 31705                                  LookBack:				;AN000;  3/3/KK
 31706                                  	; 28/03/2023
 31707                                  	; MSDOS 3.3 & MSDOS 6.0
 31708 00004742 3A5CFF                  	cmp	bl,[si-1]		; if double slash, then complain.
 31709 00004745 740E                    	je	short BADCDERRJ2
 31710                                  DoCdr:
 31711 00004747 B43B                    	mov	ah,CHDir ; 3Bh
 31712 00004749 CD21                    	int	21h		; DOS -	2+ - CHANGE THE	CURRENT	DIRECTORY (CHDIR)
 31713                                  				; DS:DX	-> ASCIZ directory name	(may include drive)
 31714 0000474B 861C                    	xchg	bl,[si]
 31715 0000474D 7395                    	jnc	short NOTPDIR_RETN
 31716                                  	
 31717                                  	; 28/03/2023
 31718                                  	; MSDOS 3.3
 31719                                  ;BADCDERRJ2:
 31720                                  	;stc
 31721                                  	;jmp	BADCDERR
 31722                                  
 31723                                  	; 28/03/2023
 31724                                  	; MSDOS 6.0 (& MSDOS 5.0)
 31725 0000474F E8F7D8                  	call	get_ext_error_number	;AN022; get the extended error
 31726                                  EXTEND_SETUPJ:					;AN022;
 31727 00004752 E929D6                  	jmp	extend_setup		;AN022; go issue the error message
 31728                                  BADCDERRJ2:
 31729 00004755 E923D6                  	jmp	badpath_err		;AC022; go issue path not found message
 31730                                  
 31731                                  ; =============== S U B	R O U T	I N E =======================================
 31732                                  
 31733                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31734                                  SETSTARS:
 31735                                  	;mov	[bp+2],di
 31736 00004758 897E02                  	mov	[bp+VARSTRUC.TTAIL],di
 31737                                  	;add	byte [bp+1],12
 31738 0000475B 8046010C                	add	byte [bp+VARSTRUC.SIZ],12
 31739                                  	;;mov	ax,[DOT_QMARK] ; '?.' (2E3Fh)
 31740                                  	; 28/03/2023
 31741                                  	; MSDOS 6.0
 31742 0000475F B83F2E                  	mov	ax,dot_qmark ; 2E3Fh
 31743                                  	;mov	ax,'?.' ; dot_qmark
 31744                                  
 31745 00004762 B90800                  	mov	cx,8
 31746 00004765 F3AA                    	rep	stosb
 31747 00004767 86C4                    	xchg	al,ah
 31748 00004769 AA                      	stosb
 31749 0000476A 86C4                    	xchg	al,ah
 31750 0000476C B103                    	mov	cl,3
 31751 0000476E F3AA                    	rep	stosb
 31752 00004770 30C0                    	xor	al,al
 31753 00004772 AA                      	stosb
 31754 00004773 C3                      	retn
 31755                                  
 31756                                  ; =============== S U B	R O U T	I N E =======================================
 31757                                  
 31758                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31759                                  	; 12/06/2023 - Retro DOS v4.2 COMMAND.COM
 31760                                  COMPNAME:
 31761 00004774 BE[1D9E]                	mov	si,DestBuf	; do name translate of target
 31762 00004777 BF[D899]                	mov	di,TRGXNAME	; save for name comparison
 31763 0000477A B460                    	mov	ah,xNameTrans ; 60h
 31764                                  	;mov	ah,60h
 31765 0000477C CD21                    	int	21h	; DOS -	RESOLVE	PATH STRING TO CANONICAL PATH STRING
 31766                                  			; DS:SI	-> ASCIZ relative path string or directory name
 31767                                  			; ES:DI	-> 128-byte buffer for ASCIZ canonical fully qualified name
 31768 0000477E BE[8199]                	mov	si,SRCXNAME	; get name translate of source
 31769 00004781 BF[D899]                	mov	di,TRGXNAME	; get name translate of target
 31770                                  	;call	STRCOMP
 31771                                  	;retn
 31772                                  	; 28/03/2023
 31773 00004784 E93FE2                  	jmp	STRCOMP
 31774                                  
 31775                                  ;============================================================================
 31776                                  ; CPARSE.ASM, MSDOS 6.0, 1991
 31777                                  ;============================================================================
 31778                                  ; 30/09/2018 - Retro DOS v3.0
 31779                                  ; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31780                                  ; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31781                                  
 31782                                  ;-----------------------------------------------------------------------;
 31783                                  ; ENTRY:								;
 31784                                  ;	DS:SI	Points input buffer					;
 31785                                  ;	ES:DI	Points to the token buffer				;
 31786                                  ;	BL	Special delimiter for this call 			;
 31787                                  ;		    Always checked last 				;
 31788                                  ;		    set it to space if there is no special delimiter	;
 31789                                  ; EXIT: 								;
 31790                                  ;	DS:SI	Points to next char in the input buffer 		;
 31791                                  ;	ES:DI	Points to the token buffer				;
 31792                                  ;	[STARTEL] Points to start of last element of path in token	;
 31793                                  ;		points to a NUL for no element strings 'd:' 'd:/'       ;
 31794                                  ;	CX	Character count 					;
 31795                                  ;	BH	Condition Code						;
 31796                                  ;			Bit 1H of BH set if switch character		;
 31797                                  ;				Token buffer contains char after	;
 31798                                  ;				switch character			;
 31799                                  ;				BP has switch bits set (ORing only)	;
 31800                                  ;			Bit 2H of BH set if ? or * in token		;
 31801                                  ;				if * found element ? filled		;
 31802                                  ;			Bit 4H of BH set if path sep in token		;
 31803                                  ;			Bit 80H of BH set if the special delimiter	;
 31804                                  ;			   was skipped at the start of this token	;
 31805                                  ;		Token buffer always starts d: for non switch tokens	;
 31806                                  ;	CARRY SET							;
 31807                                  ;	    if CR on input						;
 31808                                  ;		token buffer not altered				;
 31809                                  ;									;
 31810                                  ;	DOES NOT RETURN ON BAD PATH, OR TRAILING SWITCH CHAR ERROR	;
 31811                                  ; MODIFIES:								;
 31812                                  ;	CX, SI, AX, BH, DX and the Carry Flag				;
 31813                                  ;									;
 31814                                  ;-----------------------------------------------------------------------;
 31815                                  
 31816                                  ; Modifications to cparse: recognition of right and left parentheses
 31817                                  ; as integral tokens, and removal of automatic upper-case conversion code.
 31818                                  ;
 31819                                  ; Both modifications were installed in the course of adding a coherent
 31820                                  ; command-line parser to COMMAND.COM which builds a UNIX-style argv[]/argc
 31821                                  ; structure for command-line arguments. This parser relies on cparse to
 31822                                  ; recognize individual tokens.
 31823                                  ;
 31824                                  ; To process for-loops correctly, parentheses must therefore be
 31825                                  ; recognized as tokens. The upper-case conversion code was removed so
 31826                                  ; that commands (such as for and echo) would be able to use the "original"
 31827                                  ; text of the command line.
 31828                                  ;
 31829                                  ; Note also the modification to prevent the automatic conversion of colons
 31830                                  ; into spaces WITHIN THE SOURCE TEXT!
 31831                                  ;
 31832                                  ; Also note that BP is also clobbered if cparse recognizes any switches
 31833                                  ; on the command line.
 31834                                  ;
 31835                                  ; Alan L, OS/MSDOS				    14 August 1983
 31836                                  
 31837                                  ; ---------------------------------------------------------------------------
 31838                                  
 31839                                  ; COMEQU.ASM (MSDOS 6.0, 1991)
 31840                                  
 31841                                  ;FSWITCH	EQU	8000h
 31842                                  ;FBADSWITCH	EQU	4000h
 31843                                  
 31844                                  	; MSDOS 3.3 COMMAND.COM (1987) Transient portion offset 3334h
 31845                                  
 31846                                  ; =============== S U B	R O U T	I N E =======================================
 31847                                  		
 31848                                  	; 28/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 31849                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 431Fh
 31850                                  
 31851                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 31852                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 4AE3h
 31853                                  cparse:
 31854 00004787 31C0                    	xor	ax,ax
 31855 00004789 893E[559F]              	mov	[STARTEL],di		; No path element (Is DI correct?)
 31856 0000478D A2[589F]                	mov	[ELPOS],al		; Start in 8 char prefix
 31857                                  	; MSDOS 3.3
 31858                                  	;mov	[SOURCE],al		
 31859                                  	; MSDOS 6.0
 31860 00004790 A2[599F]                	mov	[SKPDEL], al		; No skip delimiter yet
 31861 00004793 88C7                    	mov	bh,al			; Init nothing
 31862 00004795 9C                      	pushf				; save flags
 31863 00004796 57                      	push	di			; save the token buffer addrss
 31864 00004797 31C9                    	xor	cx,cx			; no chars in token buffer
 31865 00004799 880E[F69D]              	mov	[comma],cl		; reset comma flag
 31866                                  moredelim:
 31867 0000479D AC                      	lodsb
 31868 0000479E E8EBE1                  	call	DELIM
 31869 000047A1 751D                    	jnz	short SCANCDONE
 31870 000047A3 3C20                    	cmp	al,' '
 31871 000047A5 74F6                    	jz	short moredelim
 31872 000047A7 3C09                    	cmp	al,9
 31873 000047A9 74F2                    	jz	short moredelim
 31874                                  	;xchg	al,[SOURCE]
 31875                                  	; 28/03/2023
 31876 000047AB 8606[599F]              	xchg	al,[SKPDEL]
 31877 000047AF 08C0                    	or	al,al
 31878 000047B1 74EA                    	jz	short moredelim		; One non space/tab delimiter allowed
 31879 000047B3 F6C780                  	test	bh,80h			; has a special char been found?
 31880 000047B6 7405                    	jz	short no_comma		; no - just exit
 31881 000047B8 C606[F69D]01            	mov	byte [comma],1		; set comma flag
 31882                                  no_comma:
 31883 000047BD E92A01                  	jmp	x_done			; Nul argument
 31884                                  
 31885                                  SCANCDONE:
 31886                                  	; 28/03/2023
 31887                                  	; MSDOS 6.0
 31888                                  	; -----------------------------------
 31889                                  	; Mod to avoid upper-case conversion.
 31890                                  	; -----------------------------------
 31891                                  	; MSDOS 3.3
 31892                                  	;cmp	byte [CPYFLAG],1	; 3/3/KK
 31893                                  	;jnz	short cpcont1		; 3/3/KK
 31894                                  	;call	UPCONV_MAPCALL		; 3/3/KK
 31895                                  cpcont1:
 31896                                  	; -----------------------------------
 31897                                  	; 28/03/2023
 31898 000047C0 38D8                    	cmp	al,bl			; Special delimiter?
 31899 000047C2 7505                    	jne	short nospec
 31900 000047C4 80CF80                  	or	bh,80h
 31901 000047C7 EBD4                    	jmp	short moredelim
 31902                                  nospec:
 31903 000047C9 3C0D                    	cmp	al,0Dh			; a CR?
 31904 000047CB 7503                    	jne	short ncperror
 31905 000047CD E91501                  	jmp	cperror
 31906                                  ncperror:
 31907 000047D0 3A06[579C]              	cmp	al,[SWITCHAR]		; is the char the switch char?
 31908 000047D4 7503                    	jne	short na_switch		; yes, process...
 31909 000047D6 E91401                  	jmp	a_switch
 31910                                  na_switch:
 31911 000047D9 B23A                    	mov	dl,':'
 31912 000047DB 3814                    	cmp	[si],dl
 31913 000047DD 751D                    	jne	short anum_chard	; Drive not specified
 31914                                  	; 28/03/2023
 31915                                  	; MSDOS 6.0 
 31916 000047DF 803E[059E]01            	cmp	byte [cpyflag],1	; 3/3/KK
 31917 000047E4 7503                    	jne	short cpcont2		; 3/3/KK
 31918 000047E6 E8A0DF                  	call	UPCONV			; 3/3/KK
 31919                                  cpcont2:
 31920 000047E9 E85901                  	call	move_char
 31921 000047EC AC                      	lodsb				; Get the ':'
 31922 000047ED E85501                  	call	move_char
 31923 000047F0 893E[559F]              	mov	[STARTEL],di
 31924 000047F4 C606[579F]00            	mov	byte [ELCNT],0
 31925 000047F9 E9B300                  	jmp	anum_test
 31926                                  anum_chard:
 31927 000047FC 893E[559F]              	mov	[STARTEL],di
 31928 00004800 C606[579F]00            	mov	byte [ELCNT],0		; Store of this char sets it to one
 31929 00004805 803E[059E]01            	cmp	byte [cpyflag],1	; Was CPARSE called from COPY?
 31930 0000480A 751D                    	jnz	short anum_char		; No, don't add drive spec.
 31931 0000480C E803E2                  	call	pathchrcmp		; Starts with a pathchar?
 31932 0000480F 7518                    	jnz	short anum_char		; no
 31933 00004811 50                      	push	ax
 31934 00004812 A0[679C]                	mov	al,[CURDRV]		; Insert drive spec
 31935                                  	;add	al,[CAPITAL_A]
 31936                                  	; 28/03/2023
 31937                                  	; MSDOS 6.0
 31938 00004815 0441                    	add	al,'A' ; 41h
 31939 00004817 E82B01                  	call	move_char
 31940 0000481A B03A                    	mov	al,':' ; 3Ah
 31941 0000481C E82601                  	call	move_char
 31942 0000481F 58                      	pop	ax
 31943 00004820 893E[559F]              	mov	[STARTEL],di
 31944 00004824 C606[579F]00            	mov	byte [ELCNT],0
 31945                                  anum_char:
 31946                                  	; 28/03/2023
 31947                                  	; MSDOS 6.0
 31948 00004829 E833DF                  	call	testkanj		;AC048			
 31949 0000482C 7406                    	jz	short NOTKANJ		;AC048;
 31950 0000482E E81401                  	call	move_char
 31951 00004831 AC                      	lodsb
 31952 00004832 EB78                    	jmp	short notspecial
 31953                                  
 31954                                  NOTKANJ:				;AN048; If not kanji
 31955 00004834 803E[059E]01            	cmp	byte [cpyflag],1	;AN048; and if we're in COPY
 31956 00004839 7503                    	jne	short TESTDOT 		;AN048;
 31957 0000483B E84BDF                  	call	UPCONV			;AN048; upper case the char
 31958                                  TESTDOT:
 31959                                  	; 28/03/2023
 31960                                  	;cmp	al,dot_chr  ; 2Eh
 31961 0000483E 3C2E                    	cmp	al,'.'
 31962 00004840 7509                    	jne	short testquest
 31963 00004842 FE06[589F]              	inc	byte [ELPOS] 		; flag in extension
 31964 00004846 C606[579F]FF            	mov	byte [ELCNT],0FFh	; Store of the '.' resets it to 0
 31965                                  testquest:
 31966 0000484B 3C3F                    	cmp	al,'?'  ; 3Fh
 31967 0000484D 7503                    	jnz	short testsplat
 31968 0000484F 80CF02                  	or	bh,2
 31969                                  testsplat:
 31970                                  	;cmp	al,[STAR]
 31971 00004852 3C2A                    	cmp	al,star	; 2Ah
 31972                                  	; 27/04/2023
 31973                                  	;cmp	al,'*' 
 31974 00004854 7530                    	jne	short testpath
 31975 00004856 80CF02                  	or	bh,2
 31976 00004859 803E[919F]00            	cmp	byte [expand_star],0
 31977 0000485E 7504                    	jne	short expand_filename
 31978 00004860 EB24                    	jmp	short testpath
 31979                                  
 31980                                  BADPERR2J:
 31981                                  	;jmp	BADPERR2
 31982                                  	; 28/03/2023
 31983                                  	; MSDOS 6.0
 31984 00004862 EB75                    	jmp	short BADPERR2
 31985                                  
 31986                                  expand_filename:
 31987 00004864 B407                    	mov	ah,7
 31988 00004866 803E[589F]00            	cmp	byte [ELPOS],0
 31989 0000486B 7402                    	jz	short gotelcnt
 31990 0000486D B402                    	mov	ah,2
 31991                                  gotelcnt:
 31992 0000486F B03F                    	mov	al,'?'
 31993 00004871 2A26[579F]              	sub	ah,[ELCNT]
 31994 00004875 72EB                    	jb	short BADPERR2J
 31995 00004877 86E1                    	xchg	ah,cl
 31996 00004879 E309                    	jcxz	testpathx
 31997                                  qmove:
 31998 0000487B 86E1                    	xchg	ah,cl
 31999 0000487D E8C500                  	call	move_char
 32000 00004880 86E1                    	xchg	ah,cl
 32001 00004882 E2F7                    	loop	qmove
 32002                                  testpathx:
 32003 00004884 86E1                    	xchg	ah,cl
 32004                                  testpath:
 32005 00004886 E889E1                  	call	pathchrcmp
 32006 00004889 7521                    	jnz	short notspecial
 32007 0000488B 80CF04                  	or	bh,4
 32008 0000488E 803E[919F]00            	cmp	byte [expand_star],0
 32009 00004893 7405                    	jz	short no_err_check
 32010 00004895 F6C702                  	test	bh,2			; If just hit a '/', cannot have ? or * yet
 32011 00004898 7545                    	jnz	short BADPERR
 32012                                  no_err_check:
 32013 0000489A 893E[559F]              	mov	[STARTEL],di	  	; New element
 32014 0000489E FF06[559F]              	inc	word [STARTEL]	  	; Point to char after /
 32015 000048A2 C606[579F]FF            	mov	byte [ELCNT],0FFh 	; Store of '/' sets it to 0
 32016 000048A7 C606[589F]00            	mov	byte [ELPOS],0
 32017                                  notspecial:
 32018 000048AC E89600                  	call	move_char		; just an alphanum string
 32019                                  anum_test:
 32020 000048AF AC                      	lodsb
 32021                                  
 32022                                  	; 28/03/2023
 32023                                  	; MSDOS 6.0
 32024                                  	; -----------------------------------
 32025                                  	; Mod to avoid upper-case conversion.
 32026                                  	; -----------------------------------
 32027                                  	; MSDOS 3.3
 32028                                  	;cmp	byte [CPYFLAG],1	; 3/3/KK
 32029                                  	;jnz	short cpcont3		; 3/3/KK
 32030                                  	;call	UPCONV_MAPCALL		; 3/3/KK
 32031                                  cpcont3:
 32032                                  	; -----------------------------------
 32033                                  
 32034 000048B0 E8D9E0                  	call	DELIM
 32035 000048B3 7435                    	jz	short x_done
 32036 000048B5 3C0D                    	cmp	al,0Dh
 32037 000048B7 7431                    	je	short x_done
 32038 000048B9 3A06[579C]              	cmp	al,[SWITCHAR]
 32039 000048BD 742B                    	je	short x_done
 32040 000048BF 38D8                    	cmp	al,bl
 32041 000048C1 7427                    	je	short x_done
 32042 000048C3 3C3A                    	cmp	al,':'			; ':' allowed as trailer because of devices
 32043                                  	; 28/03/2023
 32044                                  	; MSDOS 3.3
 32045                                  	;jnz	short ANUM_CHARJ 
 32046                                  	; MSDOS 6.0
 32047 000048C5 7403                    	je	short FOO15
 32048 000048C7 E95FFF                  	jmp	anum_char
 32049                                  
 32050                                  ; Modification made for parseline.
 32051                                  ; Why would it be necessary to change colons to spaces? In this
 32052                                  ; case, EVERY colon is changed to a space; e.g., 'f:' yields 'f ',
 32053                                  ; but so does 'echo foo:bar' yield 'echo foo bar'.
 32054                                  
 32055                                  FOO15:
 32056 000048CA 803E[059E]02            	cmp	byte [cpyflag],2
 32057 000048CF 7505                    	jnz	short cpcont4
 32058 000048D1 E87100                  	call	move_char
 32059 000048D4 EBD9                    	jmp	short anum_test
 32060                                  cpcont4:
 32061 000048D6 46                      	inc	si			; Skip the ':'
 32062 000048D7 EB11                    	jmp	short x_done
 32063                                  
 32064                                  	; 28/03/2023
 32065                                  ;ANUM_CHARJ:
 32066                                  	;jmp	anum_char
 32067                                  
 32068                                  BADPERR2:
 32069 000048D9 BA[DC8F]                	mov	dx,BADCPMES_PTR
 32070 000048DC E945E4                  	jmp	cerror
 32071                                  
 32072                                  BADPERR:
 32073                                  	; 28/03/2023
 32074                                  	;jmp	BADCDERR  ; MSDOS 3.3	
 32075                                  BADCDERR:
 32076                                  	; MSDOS 6.0
 32077 000048DF BA[2B91]                	mov	dx,badcd_ptr		;AC022; Issue "Invalid Directory"
 32078 000048E2 E93FE4                  	jmp	cerror			;AC022;  message
 32079                                  	
 32080                                  cperror:
 32081 000048E5 4E                      	dec	si			; adjust the pointer
 32082 000048E6 5F                      	pop	di			; retrive token buffer address
 32083 000048E7 9D                      	popf				; restore flags
 32084 000048E8 F9                      	stc				; set the carry bit
 32085 000048E9 C3                      	retn
 32086                                  
 32087                                  x_done:
 32088 000048EA 4E                      	dec	si			; adjust for next round
 32089                                  
 32090                                  ; Mod to recognize right and left parens as integral tokens.
 32091                                  ;x_done2:
 32092 000048EB EB51                    	jmp	short out_token
 32093                                  
 32094                                  a_switch:
 32095 000048ED 80CF01                  	or	bh,1			; Indicate switch
 32096                                  	;or	bp,FSWITCH ; 8000h
 32097                                  	; 28/03/2023
 32098 000048F0 81CD0080                	or	bp,8000h
 32099 000048F4 E88DE0                  	call	scanoff
 32100 000048F7 46                      	inc	si
 32101                                  	; 28/03/2023
 32102                                  	; MSDOS 6.0
 32103 000048F8 E864DE                  	call	testkanj		;AN057; See if DBCS lead byte
 32104 000048FB 740D                    	jz	short a_switch_notkanj	;AN057; no - continue processing
 32105 000048FD E84500                  	call	move_char		;AN057; DBCS - store first byte
 32106 00004900 AC                      	lodsb				;AN057; get second byte
 32107 00004901 E84100                  	call	move_char		;AN057; store second byte
 32108                                  	;or	bp,FBADSWITCH ; 4000h	;AN057; DBCS switch is invalid
 32109 00004904 81CD0040                	or	bp,4000h
 32110 00004908 EB34                    	jmp	short out_token 	;AN057; don't bother checking switch
 32111                                  a_switch_notkanj:			;AN057;
 32112 0000490A 3C0D                    	cmp	al,0Dh
 32113 0000490C 7509                    	jne	short Store_swt
 32114 0000490E B000                    	mov	al,0
 32115 00004910 AA                      	stosb
 32116                                  	;or	bp,FBADSWITCH ; 4000h
 32117 00004911 81CD0040                	or	bp,4000h
 32118 00004915 EBCE                    	jmp	short cperror		; Trailing switch character error
 32119                                  					;   BP = fSwitch but no switch
 32120                                  					;   bit is set (unknown switch)
 32121                                  Store_swt:
 32122 00004917 E82B00                  	call	move_char		; store the character
 32123                                  
 32124                                  ; This upconv call must stay. It is used to identify copy-switches
 32125                                  ; on the command line, and won't store anything into the output buffer.
 32126                                  
 32127                                  	;call	UPCONV_MAPCALL ; MSDOS 3.3 (Retro DOS 3.0)
 32128                                  	; 28/03/2023
 32129 0000491A E86CDE                  	call	UPCONV 	; MSDOS 6.0 & MSDOS 5.0 (Retro DOS 4.0)
 32130                                  	
 32131 0000491D 06                      	push	es
 32132 0000491E 57                      	push	di
 32133 0000491F 51                      	push	cx
 32134 00004920 0E                      	push	cs
 32135 00004921 07                      	pop	es
 32136                                  	; 28/03/2023
 32137                                  	; MSDOS 3.3
 32138                                  	;;mov	di,SWITCH_LIST ; "VBAPW"
 32139                                  	; MSDOS 6.0
 32140                                  	;mov	di,switch_list ; "?VBAPW"
 32141                                  	; 14/06/*2023
 32142                                  	; MSDOS 6.22
 32143 00004922 BF[C495]                	mov	di,switch_list ; "-Y?VBAPW"
 32144                                  
 32145                                  	; MSDOS 3.3
 32146                                  	;mov	cx,SWCOUNT ; 5
 32147                                  	; MSDOS 6.0
 32148                                  	;mov	cx,6  ; SWCOUNT = 6
 32149                                  	; 14/06/2023
 32150                                  	; MSDOS 6.22
 32151 00004925 B90800                  	mov	cx,8  ; SWCOUNT = 8	
 32152                                  
 32153                                  	;or	bp,FBADSWITCH  ; 4000h
 32154 00004928 81CD0040                	or	bp,4000h
 32155 0000492C F2AE                    	repne	scasb
 32156 0000492E 750B                    	jnz	short out_tokenp
 32157                                  	;and	bp,~FBADSWITCH ; 0BFFFh
 32158 00004930 81E5FFBF                	and	bp,0BFFFh
 32159 00004934 B80100                  	mov	ax,1
 32160 00004937 D3E0                    	shl	ax,cl
 32161 00004939 09C5                    	or	bp,ax
 32162                                  out_tokenp:
 32163 0000493B 59                      	pop	cx
 32164 0000493C 5F                      	pop	di
 32165 0000493D 07                      	pop	es
 32166                                  out_token:
 32167 0000493E B000                    	mov	al,0			; null at the end
 32168 00004940 AA                      	stosb
 32169 00004941 5F                      	pop	di			; restore token buffer pointer	
 32170 00004942 9D                      	popf
 32171 00004943 F8                      	clc				; clear carry flag
 32172 00004944 C3                      	retn
 32173                                  
 32174                                  ; =============== S U B	R O U T	I N E =======================================
 32175                                  
 32176                                  	; 28/03/2023
 32177                                  move_char:
 32178 00004945 AA                      	stosb				; store char in token buffer
 32179 00004946 41                      	inc	cx			; increment char count
 32180 00004947 FE06[579F]              	inc	byte [ELCNT]		; increment element count for * substi
 32181 0000494B C3                      	retn
 32182                                  
 32183                                  ;============================================================================
 32184                                  ; PARSE.ASM, MSDOS 6.0, 1991
 32185                                  ;============================================================================
 32186                                  ; 29/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32187                                  ; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 32188                                  
 32189                                  ; -----------------------------
 32190                                  ; (PSDATA.INC, MSDOS 6.0, 1991)
 32191                                  ; -----------------------------
 32192                                  
 32193                                  ;**** Equation field
 32194                                  ;-------- Character code definition
 32195                                  
 32196                                  $P_DBSP1	   equ	20h ; DB_SP_HI	;AN000; 1st byte of DBCS blank
 32197                                  $P_DBSP2	   equ	20h ; DB_SP_LO	;AN000; 2nd byte of DBCS blank
 32198                                  $P_Period	   equ	"."             ;AN020;
 32199                                  $P_Slash	   equ	"/"             ;AN020;
 32200                                  $P_Space	   equ	" "             ;AN000; SBCS blank
 32201                                  $P_Comma	   equ	","             ;AN000;
 32202                                  $P_Switch	   equ	"/"             ;AN000;
 32203                                  $P_Keyword	   equ	"="             ;AN000;
 32204                                  $P_Colon	   equ	":"             ;AN000;
 32205                                  $P_Plus 	   equ	"+"             ;AN000;
 32206                                  $P_Minus	   equ	"-"             ;AN000;
 32207                                  $P_Rparen	   equ	")"             ;AN000;
 32208                                  $P_Lparen	   equ	"("             ;AN000;
 32209                                  ;(deleted ;AN025;) $P_SQuote equ  "'"
 32210                                  $P_DQuote	   equ	'"'             ;AN000;
 32211                                  $P_NULL 	   equ	0		;AN000;
 32212                                  $P_TAB		   equ	9		;AN000;
 32213                                  $P_CR		   equ	0Dh		;AN000;
 32214                                  $P_LF		   equ	0Ah		;AN000;
 32215                                  $P_ASCII80	   equ	80h		;AN000; ASCII 80h character code
 32216                                  
 32217                                  $P_DOSTBL_File	   equ	4		;AN000; get file uppercase table
 32218                                  $P_DOSTBL_Char	   equ	2		;AN000; get character uppercase table
 32219                                  
 32220                                  $P_error_filespec  equ  1
 32221                                  
 32222                                  ;----------------------------------------------------------------------------
 32223                                  ; PARMS LABEL	BYTE
 32224                                  ;	DW	PARMSX
 32225                                  ;	DB	2		; NUMBER OF STRINGS (0, 1, 2)
 32226                                  ;	DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 32227                                  ;	DB	" .. "          ; EXTRA DELIMITER LIST,
 32228                                  ;				; TYPICAL ARE ";", "="
 32229                                  ;				; "," & WHITESPACE ALWAYS
 32230                                  ;	DB	length		; LENGTH OF THE NEXT LIST, 0 IF NONE
 32231                                  ;	DB	" .. "          ; EXTRA END OF LINE LIST, CR, LF OR 0 ALWAYS
 32232                                  ;----------------------------------------------------------------------------
 32233                                  
 32234                                  struc $P_PARMS_BLK			;AN000;
 32235 00000000 ????                    .$P_PARMSX_Address:  resw 1		;AN000; Address of PARMSX
 32236 00000002 ??                      .$P_Num_Extra:	     resb 1		;AN000; Number of extra stuff
 32237 00000003 ??                      .$P_Len_Extra_Delim: resb 1		;AN000; Length of extra delimiter
 32238                                  endstruc 				;AN000;
 32239                                  
 32240                                  $P_Len_PARMS	   equ	4		;AN000;
 32241                                  $P_I_Use_Default   equ	0		;AN000; no extra stuff specified
 32242                                  $P_I_Have_Delim    equ	1		;AN000; extra delimiter specified
 32243                                  $P_I_Have_EOL	   equ	2		;AN000; extra EOL specified
 32244                                  
 32245                                  ;----------------------------------------------------------------------------
 32246                                  ; PARMSX LABEL	BYTE
 32247                                  ;	DB	minp,maxp		; MIN, MAX POSITIONAL OPERANDS ALLOWED
 32248                                  ;	DW	CONTROL 		; DESCRIPTION OF POSITIONAL 1
 32249                                  ;	:				; REPEATS maxp-1 TIMES
 32250                                  ;	DB	maxs			; # OF SWITCHES
 32251                                  ;	DW	CONTROL 		; DESCRIPTION OF SWITCH 1
 32252                                  ;	:				; REPEATS maxs-1 TIMES
 32253                                  ;	DB	maxk			; # OF KEYWORD
 32254                                  ;	DW	CONTROL 		; DESCRIPTION OF KEYWORD 1
 32255                                  ;	:				; REPEATS maxk-1 TIMES
 32256                                  ;----------------------------------------------------------------------------
 32257                                  
 32258                                  struc $P_PARMSX_BLK			;AN000;
 32259 00000000 ??                      .$P_MinP: 	 resb 1	 ; 27/04/2023	;AN000; Minimum positional number
 32260 00000001 ??                      .$P_MaxP: 	 resb 1			;AN000; Maximum positional number
 32261 00000002 ??                      .$P_1st_Control: resb 1			;AN000; Address of the 1st CONTROL block
 32262                                  endstruc				;AN000;
 32263                                  
 32264                                  ; 31/03/2023
 32265                                  ;----------------------------------------------------------------------------
 32266                                  ; << Control field definition >>
 32267                                  ;
 32268                                  ;CONTROL   LABEL   BYTE
 32269                                  ;	   DW MATCH_FLAGS	; CONTROLS TYPE MATCHED
 32270                                  ;				; 8000H=NUMERIC VALUE, (VALUE LIST WILL BE CHECKED)
 32271                                  ;				; 4000H=SIGNED NUMERIC VALUE (VALUE LIST WILL BE CHECKED)
 32272                                  ;				; 2000H=SIMPLE STRING(VALUE LIST WILL BE CHECKED)
 32273                                  ;				; 1000H=DATE STRING (VALUE LIST WON'T BE CHECKED)
 32274                                  ;				; 0800H=TIME STRING (VALUE LIST WON'T BE CHECKED)
 32275                                  ;				; 0400H=COMPLEX LIST (VALUE LIST WON'T BE CHECKED)
 32276                                  ;				; 0200H=FILE SPEC (VALUE LIST WON'T BE CHECKED)
 32277                                  ;				; 0100H=DRIVE ONLY (VALUE LIST WON'T BE CHECKED)
 32278                                  ;				; 0080H=QUOTED STRING (VALUE LIST WON'T BE CHECKED)
 32279                                  ;				; 0010H=IGNORE ":" AT END IN MATCH
 32280                                  ;				; 0002H=REPEATS ALLOWED
 32281                                  ;				; 0001H=OPTIONAL
 32282                                  ;	   DW FUNCTION_FLAGS
 32283                                  ;				; 0001H=CAP RESULT BY FILE TABLE
 32284                                  ;				; 0002H=CAP RESULT BY CHAR TABLE
 32285                                  ;				; 0010H=REMOVE ":" AT END
 32286                                  ; (tm10)			; 0020H=colon is not necessary for switch
 32287                                  ;
 32288                                  ;	   DW RESULT		; RESULT BUFFER
 32289                                  ;	   DW VALUES		; VALUE LISTS
 32290                                  ;	   DB nid		; NUMBER OF KEYWORD/SWITCH SYNONYMS IN FOLLOWING LIST
 32291                                  ;	   DB "...",0		; IF n >0, KEYWORD 1
 32292                                  ;	   :
 32293                                  ;
 32294                                  ;Note:
 32295                                  ;    - The MATCH_FLAG is bit significant. You can set, for example, TIME bit and
 32296                                  ;      DATE bit simalteniously.
 32297                                  ;
 32298                                  ;      The parser examins each bit along with the following priority.
 32299                                  ;
 32300                                  ;      COMPLEX -> DATE -> TIME -> NUMERIC VAL -> SIGNED NUMERIC VAL -> DRIVE ->
 32301                                  ;      FILE SPEC -> SIMPLE STRING.
 32302                                  ;
 32303                                  ;
 32304                                  ;    - When the FUNCTION_FLAG is 0001 or 0002, the STRING pointed to by a pointer
 32305                                  ;      in the result buffer is capitalized.
 32306                                  ;
 32307                                  ;    - Match_Flags 0001H and 0002H have meaning only for the positional.
 32308                                  ;
 32309                                  ;
 32310                                  ;    - The "...",0 (bottom most line) does require '=' or '/'. When you need a
 32311                                  ;      switch, for example, '/A', then STRING points to;
 32312                                  ;
 32313                                  ;		DB    1 	; number of following synonyms
 32314                                  ;		DB   '/A',0
 32315                                  ;
 32316                                  ;      When you need a keyword, for example, 'CODEPAGE=', then "...",0 will be;
 32317                                  ;
 32318                                  ;		DB    1 	; number of following synonyms
 32319                                  ;		DB   'CODEPAGE=',0
 32320                                  ;
 32321                                  ;
 32322                                  ;    - "..." must consist of upper case characters only because the parser
 32323                                  ;      performs pattern matching after converting input to upper case (by
 32324                                  ;      using the current country upper case table)
 32325                                  ;
 32326                                  ;
 32327                                  ;    - One "..." can contain only one switch or keyword. If you need, for
 32328                                  ;      example /A and /B, the format will be;
 32329                                  ;
 32330                                  ;		DB    2 	; number of following synonyms
 32331                                  ;		DB    '/A',0
 32332                                  ;		DB    '/B',0
 32333                                  ;----------------------------------------------------------------------------
 32334                                  
 32335                                  ;**** Match_Flags
 32336                                  
 32337                                  $P_Num_Val	   equ	8000h		;AN000; Numeric Value
 32338                                  $P_SNum_Val	   equ	4000h		;AN000; Signed numeric value
 32339                                  $P_Simple_S	   equ	2000h		;AN000; Simple string
 32340                                  $P_Date_S	   equ	1000h		;AN000; Date string
 32341                                  $P_Time_S	   equ	0800h		;AN000; Time string
 32342                                  $P_Cmpx_S	   equ	0400h		;AN000; Complex string
 32343                                  $P_File_Spc	   equ	0200h		;AN000; File Spec
 32344                                  $P_Drv_Only	   equ	0100h		;AN000; Drive Only
 32345                                  $P_Qu_String	   equ	0080h		;AN000; Quoted string
 32346                                  $P_Ig_Colon	   equ	0010h		;AN000; Ignore colon at end in match
 32347                                  $P_Repeat	   equ	0002h		;AN000; Repeat allowed
 32348                                  $P_Optional	   equ	0001h		;AN000; Optional
 32349                                  
 32350                                  ;**** Function flags
 32351                                  
 32352                                  $P_CAP_File	   equ	0001h		;AN000; CAP result by file table
 32353                                  $P_CAP_Char	   equ	0002h		;AN000; CAP result by character table
 32354                                  $P_Rm_Colon	   equ	0010h		;AN000; Remove ":" at the end
 32355                                  $P_colon_is_not_necessary equ 0020h	;AN000;(tm10) /+10 and /+:10
 32356                                  
 32357                                  ;-------------------------------- Control block structure
 32358                                  struc $P_CONTROL_BLK
 32359 00000000 ????                    .$P_Match_Flag:	   resw 1		;AN000; Controls type matched
 32360 00000002 ????                    .$P_Function_Flag: resw 1		;AN000; Function should be taken
 32361 00000004 ????                    .$P_Result_Buf:	   resw 1		;AN000; Result buffer address
 32362 00000006 ????                    .$P_Value_List:	   resw 1		;AN000; Value list address
 32363 00000008 ??                      .$P_nid:	   resb 1		;AN000; # of keyword/SW synonyms
 32364 00000009 ??                      .$P_KEYorSW:	   resb 1		;AN000; keyword or sw
 32365                                  endstruc
 32366                                  
 32367                                  ; 31/03/2023
 32368                                  ;----------------------------------------------------------------------------
 32369                                  ;
 32370                                  ;VALUES LABEL	BYTE
 32371                                  ;	DB	nval		; NUMBER OF VALUE DEFINITIONS (0 - 3)
 32372                                  ;	+-
 32373                                  ;	| DB	nrng		; NUMBER OF RANGES
 32374                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF RANGE MATCHED
 32375                                  ;	| +DD	X,Y		; RANGE OF VALUES
 32376                                  ;	|	:
 32377                                  ;	| DB	nnval		; NUMBER OF CHOICES
 32378                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF NUMBER CHOICE MATCHED
 32379                                  ;	| +DD	VALUE		; SPECIFIC CHOICE IF NUMBER
 32380                                  ;	|	:
 32381                                  ;	| DB	nstrval 	; NUMBER OF CHOICES
 32382                                  ;	| +DB	ITEM_TAG	; RETURN VALUE IF STRING CHOICE MATCHED
 32383                                  ;	| +DW	STRING		; SPECIFIC CHOICE IF STING
 32384                                  ;	+-	:
 32385                                  ;
 32386                                  ;STRING DB	"...",0		; ASCIIZ STRING IMAGE
 32387                                  ;
 32388                                  ;Note:
 32389                                  ;    - ITEM_TAG must not be 0FFH, which will be used in the result buffer
 32390                                  ;      when no choice lists are provided.
 32391                                  ;
 32392                                  ;    - STRING must consist of upper case characters only because the parser
 32393                                  ;      performs pattern matching after converting input to upper case (by
 32394                                  ;      using the current country upper case table)
 32395                                  ;----------------------------------------------------------------------------
 32396                                  
 32397                                  $P_nval_None	equ 0		;AN000; no value list ID
 32398                                  $P_nval_Range	equ 1		;AN000; range list ID
 32399                                  $P_nval_Value	equ 2		;AN000; value list ID
 32400                                  $P_nval_String	equ 3		;AN000; string list ID
 32401                                  $P_Len_Range	equ 9		;AN000; Length of a range choice(two DD plus one DB)
 32402                                  $P_Len_Value	equ 5		;AN000; Length of a value choice(one DD plus one DB)
 32403                                  $P_Len_String	equ 3		;AN000; Length of a string choice(one DW plus one DB)
 32404                                  $P_No_nrng	equ 0		;AN000; (tm07) no nrng. nnval must not be 0.
 32405                                  
 32406                                  struc $P_VAL_LIST
 32407 00000000 ??                      .$P_NumofList:	resb 1		;AN000; number of following choice
 32408 00000001 ????                    .$P_Val_XL:	resw 1		;AN000; lower word of value
 32409 00000003 ????                    .$P_Val_XH:	resw 1		;AN000; higher word of value
 32410 00000005 ????                    .$P_Val_YL:	resw 1		;AN000; lower word of another value
 32411 00000007 ????                    .$P_Val_YH:	resw 1		;AN000; higher word of another value
 32412                                  endstruc
 32413                                  
 32414                                  ; 31/03/2023
 32415                                  ;----------------------------------------------------------------------------
 32416                                  ;
 32417                                  ;RESULT LABEL	BYTE			; BELOW FILLED IN FOR DEFAULTS
 32418                                  ;	DB	type			; TYPE RETURNED: 0=RESERVED,
 32419                                  ;					;	1=NUMBER, 2=LIST INDEX,
 32420                                  ;					;	3=STRING, 4=COMPLEX,
 32421                                  ;					;	5=FILESPEC, 6=DRIVE
 32422                                  ;					;	7=DATE, 8=TIME
 32423                                  ;					;	9=QUOTED STRING
 32424                                  ;	DB	ITEM_TAG		; MATCHED ITEM TAG
 32425                                  ;
 32426                                  ;	dw	synonym@		; es:@ points to found SYNONYM if provided.
 32427                                  ;
 32428                                  ;       +-
 32429                                  ;       | DD	n			; VALUE IF NUMBER
 32430                                  ;       | or
 32431                                  ;       |	DW i			; INDEX (OFFSET) INTO VALUE LIST
 32432                                  ;       |				; (ES presents Segment address)
 32433                                  ;       | or
 32434                                  ;       |	DD STRING		; OFFSET OF STRING VALUE
 32435                                  ;       | or
 32436                                  ;       |	DB drv			; DRIVE NUMBER (1-A, 2-B,..., 26-Z)
 32437                                  ;       | or
 32438                                  ;       |	DW YEAR	   		;(1980-2099)  IN CASE OF DATE
 32439                                  ;       |	DB MONTH   ;(1-12)	 Note: Range check is not performed.
 32440                                  ;       |	DB DATE	   ;(1-31)	 0 is filled when the corresponding field was not specified.
 32441                                  ;       | or
 32442                                  ;       |	DB HOUR	   ;(0-23)	 IN CASE OF TIME
 32443                                  ;       |	DB MINUTES    ;(0-59)	 Note: Range check is not performed .
 32444                                  ;       |	DB SECONDS    ;(0-59)	 0 is filled when the corresponding field was not specified .
 32445                                  ;       |	DB HUNDREDTHS ;(0-99)
 32446                                  ;       +-
 32447                                  ;
 32448                                  ;Note: ITEM_TAG is 0FFH when the caller does not specify the choice
 32449                                  ;      list.
 32450                                  ;
 32451                                  ;      YEAR: If the input value for the year is less than 100, parser
 32452                                  ;	     adds 1900 to it. For example, when 87 is input to parser for
 32453                                  ;	     the year value, he returns 1987.
 32454                                  ;----------------------------------------------------------------------------
 32455                                  
 32456                                  ;-------------------------------- Result block structure
 32457                                  struc $P_RESULT_BLK;
 32458 00000000 ??                      .$P_Type:	 resb 1		;AN000; Type returned
 32459 00000001 ??                      .$P_Item_Tag:	 resb 1		;AN000; Matched item tag
 32460 00000002 ????                    .$P_SYNONYM_Ptr: resw 1		;AN000; pointer to Synonym list returned
 32461 00000004 ????????                .$P_Picked_Val:	 resb 4		;AN000; value
 32462                                  endstruc
 32463                                  
 32464                                  ;**** values for the type field in the result block
 32465                                  
 32466                                  $P_EOL		 equ 0		;AN000; End of line
 32467                                  $P_Number	 equ 1		;AN000; Number
 32468                                  $P_List_Idx	 equ 2		;AN000; List Index
 32469                                  $P_String	 equ 3		;AN000; String
 32470                                  $P_Complex	 equ 4		;AN000; Complex
 32471                                  $P_File_Spec	 equ 5		;AN000; File Spec
 32472                                  $P_Drive	 equ 6		;AN000; Drive
 32473                                  $P_Date_F	 equ 7		;AN000; Date
 32474                                  $P_Time_F	 equ 8		;AN000; Time
 32475                                  $P_Quoted_String equ 9		;AN000; Quoted String
 32476                                  
 32477                                  $P_No_Tag	 equ 0FFh	;AN000; No ITEM_TAG found
 32478                                  
 32479                                  ;**** Return code
 32480                                  ;
 32481                                  ; following return code will be returned in the AX register.
 32482                                  
 32483                                  $P_No_Error	 equ 0		;AN000; No error
 32484                                  $P_Too_Many	 equ 1		;AN000; Too many operands
 32485                                  $P_Op_Missing	 equ 2		;AN000; Required operand missing
 32486                                  $P_Not_In_SW	 equ 3		;AN000; Not in switch list provided
 32487                                  $P_Not_In_Key	 equ 4		;AN000; Not in keyword list provided
 32488                                  $P_Out_Of_Range  equ 6		;AN000; Out of range specified
 32489                                  $P_Not_In_Val	 equ 7		;AN000; Not in value list provided
 32490                                  $P_Not_In_Str	 equ 8		;AN000; Not in string list provided
 32491                                  $P_Syntax	 equ 9		;AN000; Syntax error
 32492                                  $P_RC_EOL	 equ -1		;AN000; End of command line
 32493                                  
 32494                                  ;in second byte of $P_Flags, referenced as $P_Flags2:
 32495                                  $P_equ		 equ 01h	;AN000; "=" packed in string buffet
 32496                                  $P_Neg		 equ 02h	;AN000; Negative value
 32497                                  $P_Time12	 equ 04h	;AN000; set when PM is specified
 32498                                  $P_Key_Cmp	 equ 08h	;AN000; set when keyword compare
 32499                                  $P_SW_Cmp	 equ 10h	;AN000; set when switch compare
 32500                                  $P_Extra	 equ 20h	;AN000; set when extra delimiter found
 32501                                  $P_SW		 equ 40h	;AN000; set when switch found (tm08)
 32502                                  $P_Signed	 equ 80h	;AN000; signed numeric specified
 32503                                  
 32504                                  ;-------- Masks
 32505                                  $P_Make_Lower	 equ 20h	;AN000; make lower case character
 32506                                  $P_Make_Upper	 equ 0FFh-$P_Make_Lower ;AN000; make upper case character
 32507                                  
 32508                                  ;-------------
 32509                                  
 32510                                  struc $P_DOS_TBL
 32511 00000000 ??                      .$P_DOS_InfoID:	 resb 1		;AN000; information id for the table
 32512 00000001 ????                    .$P_DOS_TBL_Off: resw 1		;AN000; offset address of the table
 32513 00000003 ????                    .$P_DOS_TBL_Seg: resw 1		;AN000; segment address of the table
 32514                                  endstruc
 32515                                  
 32516                                  $P_DOS_Get_TBL	 equ 65h	;AN000; get uppercase table call
 32517                                  				;AN000; following parameters are set
 32518                                  				;AN000; to get casemap table.
 32519                                  $P_DOSTBL_Def	 equ -1		;AN000; get default
 32520                                  $P_DOSTBL_BL	 equ 5		;AN000; buffer length for Tbl pointer
 32521                                  $P_DOSTBL_File	 equ 4		;AN000; get file uppercase table
 32522                                  $P_DOSTBL_Char	 equ 2		;AN000; get character uppercase table
 32523                                  				; By this call following information
 32524                                  				; is returned.
 32525                                  
 32526                                  ; 03/04/2023
 32527                                  ;-------------------------------- country dependent information
 32528                                  
 32529                                  $P_DOS_Get_CDI	equ 3800h
 32530                                  
 32531                                  struc $P_CDI
 32532 00000000 ????                    .$P_CDI_DateF:	resw 1		;AN000;
 32533 00000002 ????????                .$P_CDI_Money:	resb 4		;AN000;
 32534 00000006 ????                    .$P_CDI_1000:	resb 2		;AN000;
 32535 00000008 ????                    .$P_CDI_Dec:	resb 2		;AN000;
 32536 0000000A ????                    .$P_CDI_DateS:	resb 2		;AN000;
 32537 0000000C ????                    .$P_CDI_TimeS:	resb 2		;AN000;
 32538 0000000E ??                      		resb 1		;AN000;
 32539 0000000F ??                      		resb 1		;AN000;
 32540 00000010 ??                      .$P_CDI_TimeF:	resb 1		;AN000;
 32541 00000011 ????????                		resw 2		;AN000;
 32542 00000015 ????                    		resb 2		;AN000;
 32543 00000017 <res Ah>                		resw 5		;AN000;
 32544                                  endstruc
 32545                                  
 32546                                  $P_Date_MDY	equ 0		;AN000;
 32547                                  $P_Date_DMY	equ 1		;AN000;
 32548                                  $P_Date_YMD	equ 2		;AN000;
 32549                                  
 32550                                  ; ----------------------------
 32551                                  ; (PARSE.ASM, MSDOS 6.0, 1991)
 32552                                  ; ----------------------------
 32553                                  
 32554                                  ;***********************************************************************
 32555                                  ; SysParse;
 32556                                  ;
 32557                                  ;  Function : Parser Entry
 32558                                  ;
 32559                                  ;  Input: DS:SI -> command line
 32560                                  ;	  ES:DI -> parameter block
 32561                                  ;	  psdata_seg -> psdata.inc
 32562                                  ;	  CX = operand ordinal
 32563                                  ;
 32564                                  ;	  Note:  ES is the segment containing all the control blocks defined
 32565                                  ;		 by the caller, except for the DOS COMMAND line parms, which
 32566                                  ;		 is in DS.
 32567                                  ;
 32568                                  ;  Output: CY = 1   error of caller, means invalid parameter block or
 32569                                  ;		    invalid value list. But this parser does NOT implement
 32570                                  ;		    this feature. Therefore CY always zero.
 32571                                  ;
 32572                                  ;	   CY = 0   AX = return code
 32573                                  ;		    BL = terminated delimiter code
 32574                                  ;		    CX = new operand ordinal
 32575                                  ;		    SI = set past scaned operand
 32576                                  ;		    DX = selected result buffer
 32577                                  ;
 32578                                  ; Use:	$P_Skip_Delim, $P_Chk_EOL, $P_Chk_Delim, $P_Chk_DBCS
 32579                                  ;	$P_Chk_Swtch, $P_Chk_Pos_Control, $P_Chk_Key_Control
 32580                                  ;	$P_Chk_Sw_Control, $P_Fill_Result
 32581                                  ;
 32582                                  ; Vars: $P_Ordinal(RW), $P_RC(RW), $P_SI_Save(RW), $P_DX(R), $P_Terminator(R)
 32583                                  ;	$P_SaveSI_Cmpx(W), $P_Flags(RW), $P_Found_SYNONYM(R), $P_Save_EOB(W)
 32584                                  ;
 32585                                  ;-------- Modification History -----------------------------------------
 32586                                  ;
 32587                                  ;  4/04/87 : Created by K. K,
 32588                                  ;  4/28/87 : $P_Val_YH assemble error (tm01)
 32589                                  ;	   : JMP SHORT assemble error (tm02)
 32590                                  ;  5/14/87 : Someone doesn't want to include psdata (tm03)
 32591                                  ;  6/12/87 : $P_Bridge is missing when TimeSw equ 0 and (CmpxSw equ 1 or
 32592                                  ;	     DateSW equ 1)	      (tm04)
 32593                                  ;  6/12/87 : $P_SorD_Quote is missing when QusSw equ 0 and CmpxSW equ 1
 32594                                  ;				      (tm05) in PSDATA.INC
 32595                                  ;  6/12/87 : $P_FileSp_Char and $P_FileSP_Len are missing
 32596                                  ;	     when FileSW equ 0 and DrvSW equ 1 (tm06) in PSDATA.INC
 32597                                  ;  6/18/87 : $VAL1 and $VAL3, $VAL2 and $VAL3 can be used in the same
 32598                                  ;	     value-list block	      (tm07)
 32599                                  ;  6/20/87 : Add $P_SW to check if there's an omiting parameter after
 32600                                  ;	     switch (keyword) or not. If there is, backup si for next call
 32601                                  ;	     (tm08)
 32602                                  ;  6/24/87 : Complex Item checking does not work correctly when CmpSW equ 1
 32603                                  ;	     and DateSW equ 0 and TimeSW equ 0 (tm09)
 32604                                  ;  6/24/87 : New function flag $P_colon_is_not_necessary for switch
 32605                                  ;	     /+15 and /+:15 are allowed for user (tm10)
 32606                                  ;  6/29/87 : ECS call changes DS register but it causes the address problem
 32607                                  ;	     in user's routines. $P_Chk_DBCS (tm11)
 32608                                  ;  7/10/87 : Switch with no_match flag (0x0000H) does not work correctly
 32609                                  ;					  (tm12)
 32610                                  ;  7/10/87 : Invalid switch/keyword does not work correctly
 32611                                  ;					  (tm13)
 32612                                  ;  7/10/87 : Drive_only breaks 3 bytes after the result buffer
 32613                                  ;					  (tm14)
 32614                                  ;  7/12/87 : Too_Many_Operands sets DX=0 as the PARSE result
 32615                                  ;					  (tm15)
 32616                                  ;  7/24/87 : Negative lower bound on numeric ranges cause trouble
 32617                                  ;
 32618                                  ;  7/24/87 : Quoted strings being returned with quotes.
 32619                                  ;
 32620                                  ;  7/28/87 : Kerry S (;AN018;)
 32621                                  ;	     Non optional value on switch (match flags<>0 and <>1) not flagged
 32622                                  ;	     as an error when missing.	Solution: return error 2.  Modules
 32623                                  ;	     affected: $P_Chk_SW_Control.
 32624                                  ;
 32625                                  ;  7/29/87 : Kerry S (;AN019;)
 32626                                  ;	     Now allow the optional bit in match flags for switches.  This
 32627                                  ;	     allows the switch to be encountered with a value or without a
 32628                                  ;	     value and no error is returned.
 32629                                  ;
 32630                                  ;
 32631                                  ;  8/28/87 : Ed K, Kerry S (;AN020;)
 32632                                  ;  9/14/87   In PROC $P_Get_DecNum, when checking for field separators
 32633                                  ;	     within a date response, instead of checking just for the one
 32634                                  ;	     character defined by the COUNTRY DEPENDENT INFO, check for
 32635                                  ;	     all three chars, "-", "/", and ".". Change $P_Chk_Switch to allow
 32636                                  ;	     slashes in date strings when DateSw (assembler switch) is set.
 32637                                  ;
 32638                                  ;  9/1/87  : Kerry S (;AN021)
 32639                                  ;	     In PROC $P_String_Comp, when comparing the switch or keyword on
 32640                                  ;	     the command line with the string in the control block the
 32641                                  ;	     comparing was stopping at a colon (switch) or equal (keyword)
 32642                                  ;	     on the command line and assuming a match.	This allowed a shorter
 32643                                  ;	     string on the command line than in the synonym list in the control
 32644                                  ;	     block.  I put in a test for a null in the control block so the
 32645                                  ;	     string in the control block must be the same length as the string
 32646                                  ;	     preceeding the colon or equal on the command line.
 32647                                  ;
 32648                                  ;  8/28/87 : Kerry S (;AN022;)
 32649                                  ;	     All references to data in PSDATA.INC had CS overrides.  This caused
 32650                                  ;	     problems for people who included it themselves in a segment other
 32651                                  ;	     than CS.  Added switch to allow including PSDATA.INC in any
 32652                                  ;	     segment.
 32653                                  ;
 32654                                  ;  9/16/87 : Ed K (;AN023;) PTM1040
 32655                                  ;	     in $p_set_cdi PROC, it assumes CS points to psdata. Change Push CS
 32656                                  ;	     into PUSH PSDATA_SEG.  In $P_Get_DecNum PROC, fix AN020
 32657                                  ;	     forced both TIME and DATE to use the delims, "-","/",".".
 32658                                  ;	     Created FLag, in $P_time_Format PROC, to request the delim in
 32659                                  ;	     BL be used if TIME is being parsed.
 32660                                  ;
 32661                                  ;  9/24/87 : Ed K
 32662                                  ;	     Removed the include to STRUC.INC.	Replaced the STRUC macro
 32663                                  ;	     invocations with their normally expanded code; made comments
 32664                                  ;	     out of the STRUC macro invocation statements to maintain readability.
 32665                                  ;
 32666                                  ;  9/24/87 : Ed K (;AN024;) PTM1222
 32667                                  ;	     When no CONTROL for a keyword found, tried to fill in RESULT
 32668                                  ;	     pointed to by non-existant CONTROL.
 32669                                  ;
 32670                                  ; 10/15/87 : Ed K (;AN025;) PTM1672
 32671                                  ;	     A quoted text string can be framed only by double quote.  Remove
 32672                                  ;	     support to frame quoted text string with single quote.
 32673                                  ;	     (apostrophe) $P_SorD_Quote is removed from PSDATA.INC.
 32674                                  ;	     $P_SQuote EQU also removed from PSDATA.INC.  Any references to
 32675                                  ;	     single quote in PROC prologues are left as is for history reasons.
 32676                                  ;
 32677                                  ;	     This fixes another bug, not mentioned in p1672, in that two
 32678                                  ;	     quote chars within a quoted string is supposed to be reported as
 32679                                  ;	     one quote character, but is reported as two quotes.  This changed
 32680                                  ;	     two instructions in PROC $P_Quoted_Str.
 32681                                  ;
 32682                                  ;	     Also fixed are several JMP that caused a NOP, these changed to
 32683                                  ;	     have the SHORT operator to avoid the unneeded NOP.
 32684                                  ;
 32685                                  ;	     The code and PSDATA.INC have been aligned for ease of reading.
 32686                                  ;
 32687                                  ; 10/26/87 : Ed K (;AN026;) PTM2041, DATE within SWITCH, BX reference to
 32688                                  ;	     psdata buffer should have psdata_seg.
 32689                                  ;
 32690                                  ; 10/27/87 : Ed K (;AN027;) PTM2042 comma between keywords implies
 32691                                  ;	     positional missing.
 32692                                  ;
 32693                                  ; 11/06/87 : Ed K (;AN028;) PTM 2315 Parser should not use line feed
 32694                                  ;	     as a line delimiter, should use carriage return.
 32695                                  ;	     Define switch: LFEOLSW, if on, accept LF as end of line char.
 32696                                  ;
 32697                                  ; 11/11/87 : Ed K (;AN029;) PTM 1651 GET RID OF WHITESPACE AROUND "=".
 32698                                  ;
 32699                                  ; 11/18/87 : Ed K (;AN030;) PTM 2551 If filename is just "", then
 32700                                  ;	     endless loop since SI is returned still pointing to start
 32701                                  ;	     of that parm.
 32702                                  ;
 32703                                  ; 11/19/87 : Ed K (;AN031;) PTM 2585 date & time getting bad values.
 32704                                  ;	     Vector to returned string has CS instead of Psdata_Seg, but
 32705                                  ;	     when tried to fix it on previous version, changed similar
 32706                                  ;	     but wrong place.
 32707                                  ;
 32708                                  ; 12/09/87 : Bill L (;AN032;) PTM 2772 colon and period are now valid
 32709                                  ;	     delimiters between hours, minutes, seconds for time. And period
 32710                                  ;	     and comma are valid delimiters between seconds and 100th second.
 32711                                  ;
 32712                                  ; 12/14/87 : Bill L (;AN033;) PTM 2722 if illegal delimiter characters
 32713                                  ;	     in a filespec, then flag an error.
 32714                                  ;
 32715                                  ; 12/22/87 : Bill L (;AN034;)	    All local data to parser is now
 32716                                  ;	     indexed off of the psdata_seg equate instead of the DS register.
 32717                                  ;	     Using this method, DS can point to the segment of PSP or to psdata
 32718                                  ;  -->	     local parser data. Why were some references to local data changed
 32719                                  ;	     to do this before, but not all ?????
 32720                                  ;
 32721                                  ; 02/02/88 : Ed K (;AC035;) INSPECT utility, suggests optimizations.
 32722                                  ;
 32723                                  ; 02/05/88 : Ed K (;AN036;) P3372-UPPERCASE TRANSLATION, PSDATA_SEG HOSED.
 32724                                  ;
 32725                                  ; 02/08/88 : Ed K (;AN037;) P3410-AVOID POP OF CS, CHECK BASESW FIRST.
 32726                                  ;
 32727                                  ; 02/19/88 : Ed K (;AN038;) p3524 above noon and "am" should be error
 32728                                  ;
 32729                                  ; 02/23/88 : Ed K (;AN039;) p3518 accept "comma" and "period" as decimal
 32730                                  ;	     separator in TIME before hundredths field.
 32731                                  ;
 32732                                  ; 08/09/90 : SA	M005	Prevented parser from recognizing '=' signs within
 32733                                  ;			strings as keywords.
 32734                                  ;
 32735                                  ;***********************************************************************
 32736                                  
 32737                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32738                                  cmd_parse:
 32739                                  	;call	sysparse
 32740                                  	;retn
 32741                                  
 32742                                  ; -----------------------------------
 32743                                  
 32744                                  	; 29/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32745                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:44E7h
 32746                                  
 32747                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 32748                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4CABh
 32749                                  sysparse:
 32750 0000494C 2EC706[AE97]0000        	mov	word [cs:$P_Flags],0	;AC034; Clear all internal flags
 32751 00004953 2E890E[3898]            	mov	[cs:$P_ORIG_ORD],cx	;AN039; ORIGINAL ORDINAL FROM CX
 32752 00004958 2E8926[3A98]            	mov	[cs:$P_ORIG_STACK],sp	;AN039; ORIGINAL VALUE OF STACK FROM SP
 32753 0000495D 2E8936[3C98]            	mov	[cs:$P_ORIG_SI],si	;AN039; ORIGINAL START PARSE POINTER FROM SI
 32754                                  $P_Redo_Time:				;AN039; try to parse time again
 32755 00004962 FC                      	cld				;AN000; confirm forward direction
 32756 00004963 2E890E[A197]            	mov	[cs:$P_ORDINAL],cx      ;AC034; save operand ordinal
 32757                                  	;mov	word [cs:$P_RC],$P_No_Error
 32758 00004968 2EC706[A397]0000        	mov	word [cs:$P_RC],0	;AC034; Assume no error
 32759 0000496F 2EC706[B697]0000        	mov	word [cs:$P_Found_SYNONYM],0
 32760                                  					;AC034; initalize synonym pointer
 32761 00004976 2EC706[A797]0000        	mov	word [cs:$P_DX],0	;AC034; (tm15)
 32762                                  
 32763                                  ;M029 -- Begin changes
 32764                                  ; The table of special chars $P_FileSp_Char should be initialized on every
 32765                                  ;entry to SysParse. This is in the non-checksum region and any program that
 32766                                  ;corrupts this table but does not corrupt the checksum region will leave
 32767                                  ;command.com parsing in an inconsistent state.
 32768                                  ; NB: The special characters string has been hardcoded here. If any change
 32769                                  ;is made to it in psdata.inc, a corresponding change needs to be made here.
 32770                                  
 32771 0000497D 2EC706[7398]5B5D        	mov	word [cs:$P_FileSp_Char], '[]'	 ; "[]|<>+=;\""
 32772 00004984 2EC706[7598]7C3C        	mov	word [cs:$P_FileSp_Char+2], '|<'
 32773 0000498B 2EC706[7798]3E2B        	mov	word [cs:$P_FileSp_Char+4], '>+'
 32774 00004992 2EC706[7998]3D3B        	mov 	word [cs:$P_FileSp_Char+6], '=;'
 32775                                  
 32776                                  ;M029 -- End of changes
 32777                                  
 32778 00004999 E83609                  	call	$P_Skip_Delim		;AN000; Move si to 1st non white space
 32779 0000499C 7312                    	jnc	short $P_Start		;AN000; If EOL is not encountered, do parse
 32780                                  
 32781                                  ;--------------------------- End of Line
 32782                                  	;mov	ax,$P_RC_EOL		;AN000; set exit code to -1
 32783 0000499E B8FFFF                  	mov	ax,0FFFFh
 32784 000049A1 53                      	push	bx			;AN000;
 32785                                  	;mov	bx,[es:di+$P_PARMS_BLK.$P_PARMSX_Address]
 32786 000049A2 268B1D                  	mov	bx,[es:di]		;AN000; Get the PARMSX address to
 32787                                  	
 32788                                  	;cmp	cl,[es:bx+$P_PARMSX_BLK.$P_MinP]
 32789 000049A5 263A0F                  	cmp	cl,[es:bx]		;AN000; check ORDINAL to see if the minimum
 32790 000049A8 7304                    	jae	short $P_Fin		;AN000; positional found.
 32791                                  
 32792                                  	;mov	ax,2
 32793 000049AA B80200                  	mov	ax,$P_Op_Missing ; 2	;AN000; If no, set exit code to missing operand
 32794                                  	; 27/04/2023
 32795 000049AD F8                      	clc
 32796                                  $P_Fin: 				;AN000;
 32797 000049AE 5B                      	pop	bx			;AN000;
 32798                                  	;jmp	$P_Single_Exit		;AN000; return to the caller
 32799                                  	; 27/04/2023
 32800                                  	; cf = 0
 32801                                  	;clc
 32802 000049AF C3                      	retn
 32803                                  
 32804                                  ;---------------------------
 32805                                  $P_Start:				;AN000;
 32806 000049B0 2E8936[B097]            	mov	[cs:$P_SaveSI_Cmpx],si	;AN000;AC034;  save ptr to command line for later use by complex,
 32807 000049B5 53                      	push	bx			;AN000; quoted string or file spec.
 32808 000049B6 57                      	push	di			;AN000;
 32809 000049B7 55                      	push	bp			;AN000;
 32810 000049B8 8D1E[B897]              	lea	bx,$P_STRING_BUF	;AC034; set buffer to copy from command string
 32811 000049BC 2EF606[AF97]20          	test	byte [cs:$P_Flags2],$P_Extra ; 20h
 32812                                  	;test	byte [cs:$P_Flags2],20h	;AC034; 3/9 extra delimiter encountered ?
 32813 000049C2 7543                    	jnz	short $P_Pack_End	;AN000; 3/9 if yes, no need to copy
 32814                                  $P_Pack_Loop:				;AN000;
 32815 000049C4 AC                      	lodsb				;AN000; Pick a operand from buffer
 32816 000049C5 E8BF09                  	call	$P_Chk_Switch		;AN000; Check switch character
 32817 000049C8 723C                    	jc	short $P_Pack_End_BY_EOL ;AN020; if carry set found delimiter type slash, need backup si, else continue
 32818                                  
 32819 000049CA E82709                  	call	$P_Chk_EOL		;AN000; Check EOL character
 32820 000049CD 7437                    	je	short $P_Pack_End_BY_EOL ;AN000; need backup si
 32821                                  
 32822 000049CF E85409                  	call	$P_Chk_Delim		;AN000; Check delimiter
 32823 000049D2 7518                    	jne	short $P_PL01 		;AN000; If no, process next byte
 32824                                  
 32825 000049D4 2EF606[AF97]20          	test	byte [cs:$P_Flags2],$P_Extra ; 20h
 32826                                  	;test	byte [cs:$P_Flags2],20h ;AC034; 3/9 If yes and white spec,
 32827 000049DA 7505                    	jnz	short $P_Pack_End_backup_si
 32828                                  					;AN000; (tm08)
 32829 000049DC E8F308                  	call	$P_Skip_Delim		;AN000; skip subsequent white space,too
 32830 000049DF EB26                    	jmp	short $P_Pack_End	;AN000; finish copy by placing NUL at end
 32831                                  
 32832                                  $P_Pack_End_backup_si:			;AN000; (tm08)
 32833 000049E1 2EF606[AF97]41          	test	byte [cs:$P_Flags2],$P_SW+$P_equ ; 41h
 32834                                  	;test	byte [cs:$P_Flags2],41h ;AN000;AC034;  (tm08)
 32835 000049E7 741E                    	jz	short $P_Pack_End	;AN000; (tm08)
 32836                                  
 32837 000049E9 4E                      	dec	si			;AN000; (tm08)
 32838 000049EA EB1B                    	jmp	short $P_Pack_End	;AN025; (tm08)
 32839                                  $P_PL01:				;AN000;
 32840 000049EC 2E8807                  	mov	[cs:bx],al		;AN000; move byte to STRING_BUF
 32841                                  	;cmp	al,'='
 32842 000049EF 3C3D                    	cmp	al,$P_Keyword ; '='	;AN000; if it is equal character,
 32843 000049F1 7506                    	jne	short $P_PL00 		;AN000; then
 32844                                  
 32845 000049F3 2E800E[AF97]01          	or	byte [cs:$P_Flags2],$P_equ
 32846                                  	;or	byte [cs:$P_Flags_2],1	;AC034; remember it in flag
 32847                                  $P_PL00:				;AN000;
 32848 000049F9 43                      	inc	bx			;AN000; ready to see next byte
 32849 000049FA E8B509                  	call	$P_Chk_DBCS		;AN000; was it 1st byte of DBCS ?
 32850 000049FD 73C5                    	jnc	short $P_Pack_Loop	;AN000; if no, process to next byte
 32851                                  
 32852 000049FF AC                      	lodsb				;AN000; if yes, store
 32853 00004A00 2E8807                  	mov	[cs:bx],al		;AN000;    2nd byte of DBCS
 32854 00004A03 43                      	inc	bx			;AN000; update pointer
 32855 00004A04 EBBE                    	jmp	short $P_Pack_Loop	;AN000; process to next byte
 32856                                  
 32857                                  $P_Pack_End_BY_EOL:			;AN000;
 32858 00004A06 4E                      	dec	si			;AN000; backup si pointer
 32859                                  $P_Pack_End:				;AN000;
 32860 00004A07 2E8936[A597]            	mov	[cs:$P_SI_Save],si	;AC034; save next pointer, SI
 32861                                  	;mov	byte [cs:bx],0
 32862 00004A0C 2EC60700                	mov	byte [cs:bx],$P_NULL	;AN000; put NULL at the end
 32863 00004A10 2E891E[B497]            	mov	[cs:$P_Save_EOB],bx
 32864                                  					;AC034; 3/17/87 keep the address for later use of complex
 32865                                  	;mov	bx,[es:di+$P_PARMS_BLK.$P_PARMSX_Address]
 32866 00004A15 268B1D                  	mov	bx,[es:di]		;AN000; get PARMSX address
 32867 00004A18 8D36[B897]              	lea	si,$P_STRING_BUF	;AC034;
 32868                                  	;cmp	byte [cs:si],'/'
 32869 00004A1C 2E803C2F                	cmp	byte [cs:si],$P_Switch	;AN000; the operand begins w/ switch char ?
 32870 00004A20 7436                    	je	short $P_SW_Manager	;AN000; if yes, process as switch
 32871                                  
 32872 00004A22 2E803C22                	cmp	byte [cs:si],$P_DQuote	;M005;is it a string?
 32873 00004A26 7408                    	je	short $P_Positional_Manager
 32874                                  					;M005;if so, process as one!
 32875 00004A28 2EF606[AF97]01          	test	byte [cs:$P_Flags2],$P_equ
 32876                                  	;test	byte [cs:$P_Flags2],1	;AC034; the operand includes equal char ?
 32877 00004A2E 7554                    	jnz	short $P_Key_Manager	;AN000; if yes, process as keyword
 32878                                  
 32879                                  $P_Positional_Manager:			;AN000; else process as positional
 32880                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 32881 00004A30 268A4701                	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 32882 00004A34 30E4                    	xor	ah,ah			;AN000; ax = maxp
 32883 00004A36 2E3906[A197]            	cmp	[cs:$P_ORDINAL],ax	;AC034; too many positional ?
 32884 00004A3B 7312                    	jae	short $P_Too_Many_Error	;AN000; if yes, set exit code to too many
 32885                                  
 32886 00004A3D 2EA1[A197]              	mov	ax,[cs:$P_ORDINAL]	;AC034; see what the current ordinal
 32887 00004A41 D1E0                    	shl	ax,1			;AN000; ax = ax*2
 32888 00004A43 43                      	inc	bx			;AC035; add '2' to
 32889 00004A44 43                      	inc	bx			;AC035;  BX reg
 32890                                  					;AN000; now bx points to 1st CONTROL
 32891 00004A45 01C3                    	add	bx,ax			;AN000; now bx points to specified CONTROL address
 32892 00004A47 268B1F                  	mov	bx,[es:bx]		;AN000; now bx points to specified CONTROL itself
 32893 00004A4A E88800                  	call	$P_Chk_Pos_Control	;AN000; Do process for positional
 32894 00004A4D EB69                    	jmp	short $P_Return_to_Caller
 32895                                  					;AN000; and return to the caller
 32896                                  $P_Too_Many_Error:			;AN000;
 32897                                  	;mov	word [cs:$P_RC],1
 32898 00004A4F 2EC706[A397]0100        	mov	word [cs:$P_RC],$P_Too_Many
 32899                                  					;AC034; set exit code
 32900 00004A56 EB60                    	jmp	short $P_Return_to_Caller
 32901                                  					;AN000; and return to the caller
 32902                                  $P_SW_Manager:				;AN000;
 32903                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 32904 00004A58 268A4701                	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 32905 00004A5C 30E4                    	xor	ah,ah			;AN000; ax = maxp
 32906 00004A5E 40                      	inc	ax			;AN000;
 32907 00004A5F D1E0                    	shl	ax,1			;AN000; ax = (ax+1)*2
 32908 00004A61 01C3                    	add	bx,ax			;AN000; now bx points to maxs
 32909 00004A63 268A0F                  	mov	cl,[es:bx]		;AN000;
 32910 00004A66 30ED                    	xor	ch,ch			;AN000; cx = maxs
 32911 00004A68 09C9                    	or	cx,cx			;AN000; at least one switch ?
 32912 00004A6A 740F                    	jz	short $P_SW_Not_Found 	;AN000;
 32913 00004A6C 43                      	inc	bx			;AN000; now bx points to 1st CONTROL address
 32914                                  $P_SW_Mgr_Loop: 			;AN000;
 32915 00004A6D 53                      	push	bx			;AN000;
 32916 00004A6E 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to Switch CONTROL itself
 32917 00004A71 E8C100                  	call	$P_Chk_SW_Control	;AN000; do process for switch
 32918 00004A74 5B                      	pop	bx			;AN000;
 32919 00004A75 7341                    	jnc	short $P_Return_to_Caller
 32920                                  					;AN000; if the CONTROL is for the switch, exit
 32921 00004A77 43                      	inc	bx			;AC035; add '2' to
 32922 00004A78 43                      	inc	bx			;AC035;  BX reg
 32923                                  					;AN000; else bx points to the next CONTROL
 32924 00004A79 E2F2                    	loop	$P_SW_Mgr_Loop		;AN000; and loop
 32925                                  $P_SW_Not_Found:			;AN000;
 32926                                  	;mov	word [cs:$P_RC],3
 32927 00004A7B 2EC706[A397]0300        	mov	word [cs:$P_RC],$P_Not_In_SW
 32928                                  					;AC034; here no CONTROL for the switch has
 32929 00004A82 EB34                    	jmp	short $P_Return_to_Caller0
 32930                                  					;AN000; not been found, means error.
 32931                                  $P_Key_Manager: 			;AN000;
 32932                                  	;mov	al,[es:bx+1]		;AN000; get maxp
 32933 00004A84 268A4701                	mov	al,[es:bx+$P_PARMSX_BLK.$P_MaxP]
 32934 00004A88 30E4                    	xor	ah,ah			;AN000; ax = maxp
 32935 00004A8A 40                      	inc	ax			;AN000;
 32936 00004A8B D1E0                    	shl	ax,1			;AN000; ax = (ax+1)*2
 32937 00004A8D 01C3                    	add	bx,ax			;AN000; now bx points to maxs
 32938 00004A8F 268A07                  	mov	al,[es:bx]		;AN000;
 32939 00004A92 30E4                    	xor	ah,ah			;AN000; ax = maxs
 32940 00004A94 D1E0                    	shl	ax,1			;AN000;
 32941 00004A96 40                      	inc	ax			;AN000; ax = ax*2+1
 32942 00004A97 01C3                    	add	bx,ax			;AN000; now bx points to maxk
 32943 00004A99 268A0F                  	mov	cl,[es:bx]		;AN000;
 32944 00004A9C 30ED                    	xor	ch,ch			;AN000; cx = maxk
 32945 00004A9E 09C9                    	or	cx,cx			;AN000; at least one keyword ?
 32946 00004AA0 740F                    	jz	short $P_Key_Not_Found	;AN000;
 32947 00004AA2 43                      	inc	bx			;AN000; now bx points to 1st CONTROL
 32948                                  $P_Key_Mgr_Loop:			;AN000;
 32949 00004AA3 53                      	push	bx			;AN000;
 32950 00004AA4 268B1F                  	mov	bx,[es:bx]		;AN000; bx points to keyword CONTROL itself
 32951 00004AA7 E85A00                  	call	$P_Chk_Key_Control	;AN000; do process for keyword
 32952 00004AAA 5B                      	pop	bx			;AN000;
 32953 00004AAB 730B                    	jnc	short $P_Return_to_Caller
 32954                                  					;AN000; if the CONTROL is for the keyword, exit
 32955 00004AAD 43                      	inc	bx			;AC035; add '2' to
 32956 00004AAE 43                      	inc	bx			;AC035;  BX reg
 32957                                  					;AN000; else bx points to the next CONTROL
 32958 00004AAF E2F2                    	loop	$P_Key_Mgr_Loop 	;AN000; and loop
 32959                                  $P_Key_Not_Found:			;AN000;
 32960                                  	;mov	word [cs:$P_RC],4
 32961 00004AB1 2EC706[A397]0400        	mov	word [cs:$P_RC],$P_Not_In_Key
 32962                                  					;AC034; here no CONTROL for the keyword has
 32963                                  $P_Return_to_Caller0:
 32964                                  $P_Return_to_Caller:			;AN000; not been found, means error.
 32965 00004AB8 5D                      	pop	bp			;AN000;
 32966 00004AB9 5F                      	pop	di			;AN000;
 32967 00004ABA 5B                      	pop	bx			;AN000;
 32968 00004ABB 2E8B0E[A197]            	mov	cx,[cs:$P_ORDINAL]	;AC034; return next ordinal
 32969 00004AC0 2EA1[A397]              	mov	ax,[cs:$P_RC]		;AC034; return exit code
 32970 00004AC4 2E8B36[A597]            	mov	si,[cs:$P_SI_Save]	;AC034; return next operand pointer
 32971 00004AC9 2E8B16[A797]            	mov	dx,[cs:$P_DX]		;AC034; return result buffer address
 32972 00004ACE 2E8A1E[A997]            	mov	bl,[cs:$P_Terminator]	;AC034; return delimiter code found
 32973                                  $P_Single_Exit: 			;AN000;
 32974 00004AD3 F8                      	clc				;AN000;
 32975 00004AD4 C3                      	retn				;AN000;
 32976                                  
 32977                                  ;***********************************************************************
 32978                                  ; $P_Chk_Pos_Control
 32979                                  ;
 32980                                  ; Function: Parse CONTROL block for a positional
 32981                                  ;
 32982                                  ; Input:     ES:BX -> CONTROL block
 32983                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 32984                                  ;
 32985                                  ; Output:    None
 32986                                  ;
 32987                                  ; Use:	 $P_Fill_Result, $P_Check_Match_Flags
 32988                                  ;
 32989                                  ; Vars: $P_Ordinal(W), $P_RC(W)
 32990                                  ;***********************************************************************
 32991                                  
 32992                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 32993                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4671h
 32994                                  
 32995                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 32996                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4E35h
 32997                                  $P_Chk_Pos_Control:
 32998 00004AD5 50                      	push	ax			;AN000;
 32999                                  	;mov	ax,[es:bx+$P_CONTROL_BLK.$P_Match_Flag]
 33000 00004AD6 268B07                  	mov	ax,[es:bx]		;AN000;
 33001                                  	;test	ax,2
 33002 00004AD9 A90200                  	test	ax,$P_Repeat		;AN000; repeat allowed ?
 33003 00004ADC 7505                    	jnz	short $P_CPC00		;AN000; then do not increment ORDINAL
 33004                                  
 33005 00004ADE 2EFF06[A197]            	inc	word [cs:$P_ORDINAL]	;AC034; update the ordinal
 33006                                  $P_CPC00:				;AN000;
 33007                                  	;cmp	byte [cs:si],0
 33008 00004AE3 2E803C00                	cmp	byte [cs:si],$P_NULL	;AN000; no data ?
 33009 00004AE7 7516                    	jne	short $P_CPC01		;AN000;
 33010                                  
 33011                                  	;test	ax,1
 33012 00004AE9 A90100                  	test	ax,$P_Optional		;AN000; yes, then is it optional ?
 33013 00004AEC 7509                    	jnz	short $P_CPC02		;AN000;
 33014                                  
 33015 00004AEE 2EC706[A397]0200        	mov	word [cs:$P_RC],$P_Op_Missing ; 2
 33016                                  					;AC034; no, then error	 3/17/87
 33017 00004AF5 EB0B                    	jmp	short $P_CPC_Exit	;AN000;
 33018                                  $P_CPC02:				;AN000;
 33019                                  	; 27/04/2023
 33020                                  	;push	ax ; *			;AN000;
 33021                                  	;
 33022                                  	;;mov	al,3
 33023                                  	;mov	al,$P_String		;AN000; if it is optional return NULL
 33024                                  	;;mov	ah,0FFh
 33025                                  	;mov	ah,$P_No_Tag		;AN000; no item tag indication
 33026                                  	;31/03/2023
 33027 00004AF7 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33028 00004AFA E89500                  	call	$P_Fill_Result		;AN000;
 33029                                  	; 27/04/2023
 33030                                  	;pop	ax ; *			;AN000;
 33031 00004AFD EB03                    	jmp	short $P_CPC_Exit	;AN000;
 33032                                  $P_CPC01:				;AN000;
 33033 00004AFF E81101                  	call	$P_Check_Match_Flags	;AN000;
 33034                                  $P_CPC_Exit:				;AN000;
 33035 00004B02 58                      	pop	ax			;AN000;
 33036 00004B03 C3                      	retn				;AN000;
 33037                                  
 33038                                  ;***********************************************************************
 33039                                  ; $P_Chk_Key_Control
 33040                                  ;
 33041                                  ; Function: Parse CONTROL block for a keyword
 33042                                  ;
 33043                                  ; Input:     ES:BX -> CONTROL block
 33044                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33045                                  ;
 33046                                  ; Output:    CY = 1 : not match
 33047                                  ;
 33048                                  ; Use:	 $P_Fill_Result, $P_Search_KEYorSW, $P_Check_Match_Flags
 33049                                  ;
 33050                                  ; Vars: $P_RC(W), $P_SaveSI_Cmpx(W), $P_KEYorSW_Ptr(R), $P_Flags(W)
 33051                                  ;***********************************************************************
 33052                                  
 33053                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33054                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33055                                  $P_Chk_Key_Control:			;AN000;
 33056 00004B04 F9                      	stc				;AN000;this logic works when the KeySW
 33057 00004B05 C3                      	retn				;AN000;is reset.
 33058                                  
 33059                                  ;***********************************************************************
 33060                                  ; $P_Search_KEYorSW:
 33061                                  ;
 33062                                  ; Function: Seach specified keyword or switch from CONTROL
 33063                                  ;
 33064                                  ; Input:     ES:BX -> CONTROL block
 33065                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33066                                  ;
 33067                                  ; Output:    CY = 1 : not match
 33068                                  ;
 33069                                  ; Use:	 $P_String_Comp, $P_MoveBP_NUL, $P_Found_SYNONYM
 33070                                  ;***********************************************************************
 33071                                  
 33072                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33073                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33074                                  $P_Search_KEYorSW:
 33075 00004B06 55                      	push	bp			;AN000;
 33076 00004B07 51                      	push	cx			;AN000;
 33077 00004B08 268A4F08                	mov	cl,[es:bx+$P_CONTROL_BLK.$P_nid]
 33078                                  	;mov	cl,[es:bx+8]		;AN000; Get synonym count
 33079                                  	; 14/06/2023
 33080                                  	;xor	ch,ch			;AN000; and set it to cx
 33081                                  	;or	cx,cx			;AN000; No synonyms specified ?
 33082 00004B0C 08C9                    	or	cl,cl
 33083 00004B0E 740E                    	jz	short $P_KEYorSW_Not_Found
 33084                                  					;AN000; then indicate not found by CY
 33085 00004B10 268D6F09                	lea	bp,[es:bx+$P_CONTROL_BLK.$P_KEYorSW]
 33086                                  	;lea	bp,[es:bx+9]		;AN000; BP points to the 1st synonym
 33087                                  $P_KEYorSW_Loop:			;AN000;
 33088 00004B14 E8F803                  	call	$P_String_Comp		;AN000; compare string in buffer w/ the synonym
 33089 00004B17 7308                    	jnc	short $P_KEYorSW_Found	;AN000; If match, set it to synonym pointer
 33090 00004B19 E80D00                  	call	$P_MoveBP_NUL		;AN000; else, bp points to the next string
 33091 00004B1C E2F6                    	loop	$P_KEYorSW_Loop 	;AN000; loop nid times
 33092                                  $P_KEYorSW_Not_Found:			;AN000;
 33093 00004B1E F9                      	stc				;AN000; indicate not found in synonym list
 33094 00004B1F EB05                    	jmp	short $P_KEYorSW_Exit	;AN000; and exit
 33095                                  $P_KEYorSW_Found:			;AN000;
 33096 00004B21 2E892E[B697]            	mov	[cs:$P_Found_SYNONYM],bp
 33097                                  					;AC034; set synonym pointer
 33098                                  	; 27/04/2023
 33099                                  	; cf = 0
 33100                                  	;clc				;AN000; indicate found
 33101                                  $P_KEYorSW_Exit:			;AN000;
 33102 00004B26 59                      	pop	cx			;AN000;
 33103 00004B27 5D                      	pop	bp			;AN000;
 33104 00004B28 C3                      	retn				;AN000;
 33105                                  
 33106                                  ;***********************************************************************
 33107                                  ; $P_MoveBP_NUL
 33108                                  ;***********************************************************************
 33109                                  
 33110                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33111                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33112                                  $P_MoveBP_NUL:
 33113                                  $P_MBP_Loop:				;AN000;
 33114                                  	;cmp	byte [es:bp+0],0
 33115 00004B29 26807E0000              	cmp	byte [es:bp],$P_NULL	;AN000; Increment BP that points
 33116 00004B2E 7403                    	je	short $P_MBP_Exit	;AN000; to the synomym list
 33117 00004B30 45                      	inc	bp			;AN000; until
 33118 00004B31 EBF6                    	jmp	short $P_MBP_Loop	;AN000; NULL encountered.
 33119                                  $P_MBP_Exit:				;AN000;
 33120 00004B33 45                      	inc	bp			;AN000; bp points to next to NULL
 33121 00004B34 C3                      	retn				;AN000;
 33122                                  
 33123                                  ;***********************************************************************
 33124                                  ; $P_Chk_SW_Control
 33125                                  ;
 33126                                  ; Function: Parse CONTROL block for a switch
 33127                                  ;
 33128                                  ; Input:     ES:BX -> CONTROL block
 33129                                  ;	     psdata_seg:SI -> $P_STRING_BUF
 33130                                  ;
 33131                                  ; Output:    CY = 1 : not match
 33132                                  ;
 33133                                  ; Use:	 $P_Fill_Result, $P_Search_KEYorSW, $P_Check_Match_Flags
 33134                                  ;
 33135                                  ; Vars:  $P_SaveSI_Cmpx(W), $P_KEYorSW_Ptr(R), $P_Flags(W)
 33136                                  ;***********************************************************************
 33137                                  
 33138                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33139                                  	;
 33140                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33141                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:4E9Ah 
 33142                                  $P_Chk_SW_Control:
 33143 00004B35 2E800E[AF97]10          	or	byte [cs:$P_Flags2],$P_SW_Cmp
 33144                                  	;or	byte [cs:$P_Flags2],10h	;AC034; Indicate switch for later string comparison
 33145 00004B3B E8C8FF                  	call	$P_Search_KEYorSW	;AN000; Search the switch in the CONTROL block
 33146 00004B3E 7251                    	jc	short $P_Chk_SW_Err0	;AN000; not found, then try next CONTROL
 33147                                  
 33148 00004B40 2E8026[AF97]EF          	and	byte [cs:$P_Flags2],0FFh-$P_SW_Cmp
 33149                                  	;and	byte [cs:$P_Flags2],0EFh
 33150                                  					;AC034; reset the indicator previously set
 33151 00004B46 50                      	push	ax			;AN000;       /switch:
 33152 00004B47 2EA1[B297]              	mov	ax,[cs:$P_KEYorSW_Ptr]	;AC034;	      ^       ^
 33153 00004B4B 29F0                    	sub	ax,si			;AN000;  SI	KEYorSW
 33154 00004B4D 2E0106[B097]            	add	[cs:$P_SaveSI_Cmpx],ax	;AC034; update for complex list
 33155 00004B52 58                      	pop	ax			;AN000;
 33156                                  
 33157 00004B53 2E8B36[B297]            	mov	si,[cs:$P_KEYorSW_Ptr]	;AC034; set si at the end or colon
 33158                                  	;cmp	byte [cs:si],0
 33159 00004B58 2E803C00                	cmp	byte [cs:si],$P_NULL	;AN000; any data after colon
 33160 00004B5C 7525                    	jne	short $P_CSW00		;AN000; if yes, process match flags
 33161                                  
 33162                                  	;cmp	byte [cs:si],':'
 33163 00004B5E 2E807CFF3A              	cmp	byte [cs:si-1],$P_Colon
 33164                                  					;AN000; if no, the switch terminated by colon ?
 33165 00004B63 7509                    	jne	short $P_Chk_if_data_required
 33166                                  					;AN000; if yes,
 33167                                  
 33168 00004B65 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax
 33169                                  	;mov	word [cs:$P_RC],9	;AC034; return syntax error
 33170 00004B6C EB1A                    	jmp	short $P_Chk_SW_Exit	;AN000;
 33171                                  
 33172                                  $P_Chk_if_data_required:		;AN018; no data, no colon
 33173                                  	;cmp	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],0
 33174                                  	; 27/04/2023
 33175 00004B6E 26833F00                	cmp	word [es:bx],0		;AN018; should have data? zero match flag means switch followed by nothing is OK
 33176 00004B72 7414                    	je	short $P_Chk_SW_Exit	;AN018; match flags not zero so should have something if optional bit is not on
 33177                                  
 33178                                  	;;test	word [es:bx],1 ; $P_Optional
 33179                                  	;test	byte [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Optional
 33180 00004B74 26F60701                	test	byte [es:bx],$P_Optional
 33181                                  					;AN019; see if no value is valid
 33182 00004B78 750E                    	jnz	short $P_Chk_SW_Exit	;AN019; if so, then leave, else yell
 33183                                  
 33184 00004B7A 2EC706[A397]0200        	mov	word [cs:$P_RC],$P_Op_Missing
 33185                                  	;mov	word [cs:$P_RC],2	;AC034; return required operand missing
 33186 00004B81 EB05                    	jmp	short $P_Chk_SW_Exit	;AN018;
 33187                                  
 33188                                  $P_CSW00:				;AN000;
 33189 00004B83 E88D00                  	call	$P_Check_Match_Flags	;AN000; process match flag
 33190 00004B86 F8                      	clc				;AN000; indicate match
 33191                                  	;jmp	short $P_Chk_SW_Single_Exit
 33192 00004B87 C3                      	retn	; 31/03/2023		;AN000;
 33193                                  	; 31/03/2023
 33194                                  ;$P_Chk_SW_Err0: 			;AN000;
 33195                                  ;	stc				;AN000; not found in switch synonym list
 33196                                  ;	;jmp	short $P_Chk_SW_Single_Exit
 33197                                  ;	retn	; 31/03/2023		;AN000;
 33198                                  	
 33199                                  $P_Chk_SW_Exit: 			;AN000;
 33200 00004B88 50                      	push	ax			;AN000;
 33201                                  	; 31/03/2023
 33202 00004B89 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33203                                  	;;mov	al,3
 33204                                  	;;mov	ah,0FFh
 33205                                  	;mov	al,$P_String		;AN000; set
 33206                                  	;mov	ah,$P_No_Tag		;AN000;    result
 33207 00004B8C E80300                  	call	$P_Fill_Result		;AN000; 	 buffer
 33208 00004B8F 58                      	pop	ax			;AN000;
 33209 00004B90 F8                      	clc				;AN000;
 33210                                  	; 31/03/2023
 33211                                  $P_Chk_SW_Err0:
 33212                                  $P_Chk_SW_Single_Exit:			;AN000;
 33213 00004B91 C3                      	retn				;AN000;
 33214                                  
 33215                                  ;***********************************************************************
 33216                                  ; $P_Fill_Result
 33217                                  ;
 33218                                  ; Function: Fill the result buffer
 33219                                  ;
 33220                                  ; Input:    AH = Item tag
 33221                                  ;	    AL = type
 33222                                  ;		  AL = 1: CX,DX has 32bit number (CX = high)
 33223                                  ;		  AL = 2: DX has index(offset) into value list
 33224                                  ;		  AL = 6: DL has driver # (1-A, 2-B, ... , 26 - Z)
 33225                                  ;		  AL = 7: DX has year, CL has month and CH has date
 33226                                  ;		  AL = 8: DL has hours, DH has minutes, CL has secondsn,
 33227                                  ;			  amd CH has hundredths
 33228                                  ;		  AL = else: psdata_seg:SI points to returned string buffer
 33229                                  ;	    ES:BX -> CONTROL block
 33230                                  ;
 33231                                  ; Output:   None
 33232                                  ;
 33233                                  ; Use:	$P_Do_CAPS_String, $P_Remove_Colon, $P_Found_SYNONYM
 33234                                  ;
 33235                                  ; Vars: $P_DX(W)
 33236                                  ;***********************************************************************
 33237                                  
 33238                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33239                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33240                                  $P_Fill_Result:
 33241 00004B92 57                      	push	di			;AN000;
 33242 00004B93 268B7F04                	mov	di,[es:bx+$P_CONTROL_BLK.$P_Result_Buf]
 33243                                  	;mov	di,[es:bx+4]		;AN000; di points to result buffer
 33244 00004B97 2E893E[A797]            	mov	[cs:$P_DX],di		;AC034; set returned result address
 33245                                  	;mov	[es:di+$P_RESULT_BLK.$P_Type],al
 33246                                  	;;mov	[es:di],al		;AN000; store type
 33247                                  	;mov	[es:di+$P_RESULT_BLK.$P_Item_Tag],ah
 33248                                  	;;mov	[es:di+1],ah		;AN000; store item tag
 33249                                  	; 31/03/2023
 33250 00004B9C 268905                  	mov	[es:di],ax
 33251 00004B9F 50                      	push	ax			;AN000;
 33252 00004BA0 2EA1[B697]              	mov	ax,[cs:$P_Found_SYNONYM]
 33253                                  					;AC034; if yes,
 33254 00004BA4 26894502                	mov	[es:di+$P_RESULT_BLK.$P_SYNONYM_Ptr],ax
 33255                                  	;mov	[es:di+2],ax		;AN000;   then set it to the result
 33256 00004BA8 58                      	pop	ax			;AN000;
 33257                                  $P_RLT04:				;AN000;
 33258                                  	;cmp	al,1
 33259 00004BA9 3C01                    	cmp	al,$P_Number		;AN000; if number
 33260 00004BAB 750A                    	jne	short $P_RLT00		;AN000;
 33261                                  $P_RLT02:				;AN000;
 33262 00004BAD 26895504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dx
 33263                                  	;mov	[es:di+4],dx		;AN000; then store 32bit
 33264 00004BB1 26894D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],cx
 33265                                  	;mov	[es:di+6],cx		;AN000;	number
 33266 00004BB5 EB5A                    	jmp	short $P_RLT_Exit	;AN000;
 33267                                  $P_RLT00:				;AN000;
 33268                                  	;cmp	al,2
 33269 00004BB7 3C02                    	cmp	al,$P_List_Idx		;AN000; if list index
 33270 00004BB9 7506                    	jne	short $P_RLT01		;AN000;
 33271 00004BBB 26895504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dx
 33272                                  	;mov	[es:di+4],dx		;AN000; then store list index
 33273 00004BBF EB50                    	jmp	short $P_RLT_Exit	;AN000;
 33274                                  $P_RLT01:				;AN000;
 33275                                  	;cmp	al,7
 33276 00004BC1 3C07                    	cmp	al,$P_Date_F ; 7	;AN000; Date format ?
 33277 00004BC3 74E8                    	je	short $P_RLT02		;AN000;
 33278                                  	;cmp	al,8
 33279 00004BC5 3C08                    	cmp	al,$P_Time_F ; 8	;AN000; Time format ?
 33280 00004BC7 74E4                    	je	short $P_RLT02		;AN000;
 33281                                  	;cmp	al,6
 33282 00004BC9 3C06                    	cmp	al,$P_Drive  ; 6	;AN000; drive format ?
 33283 00004BCB 7506                    	jne	short $P_RLT03		;AN000;
 33284                                  
 33285 00004BCD 26885504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],dl
 33286                                  	;mov	[es:di+4],dl		;AN000; store drive number
 33287 00004BD1 EB3E                    	jmp	short $P_RLT_Exit	;AN000;
 33288                                  
 33289                                  $P_RLT03:				;AN000;
 33290                                  	;cmp	al,4
 33291 00004BD3 3C04                    	cmp	al,$P_Complex		;AN000; complex format ?
 33292 00004BD5 750F                    	jne	short $P_RLT05		;AN000;
 33293                                  
 33294 00004BD7 2EA1[B097]              	mov	ax,[cs:$P_SaveSI_Cmpx]	;AC034; then get pointer in command buffer
 33295 00004BDB 40                      	inc	ax			;AN000; skip left Parentheses
 33296 00004BDC 26894504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],ax
 33297                                  	;mov	[es:di+4],ax		;AN000; store offset
 33298 00004BE0 268C5D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],ds
 33299                                  	;mov	[es:di+6],ds		;AN000; store segment
 33300 00004BE4 EB2B                    	jmp	short $P_RLT_Exit	;AN000;
 33301                                  
 33302                                  $P_RLT05:				;AN000;
 33303                                  ;------------------------  AL = 3, 5, or 9
 33304 00004BE6 26897504                	mov	[es:di+$P_RESULT_BLK.$P_Picked_Val],si
 33305                                  	;mov	[es:di+4],si		;AN000; store offset of STRING_BUF
 33306 00004BEA 268C4D06                	mov	[es:di+2+$P_RESULT_BLK.$P_Picked_Val],cs
 33307                                  	;mov	[es:di+6],cs		;AN031; store segment of STRING_BUF
 33308                                  
 33309 00004BEE 50                      	push	ax			;AN000;
 33310 00004BEF 26F6470201              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_CAP_File
 33311                                  	;test	byte [es:bx+2],1	;AN000; need CAPS by file table?
 33312 00004BF4 7404                    	jz	short $P_RLT_CAP00	;AN000;
 33313                                  
 33314                                  	;mov	al,4
 33315 00004BF6 B004                    	mov	al,$P_DOSTBL_File ; 4	;AN000; use file upper case table
 33316 00004BF8 EB09                    	jmp	short $P_RLT_CAP02	;AN000;
 33317                                  
 33318                                  $P_RLT_CAP00:				;AN000;
 33319 00004BFA 26F6470202              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_CAP_Char
 33320                                  	;test	byte [es:bx+2],2	;AN000; need CAPS by char table ?
 33321 00004BFF 7405                    	jz	short $P_RLT_CAP01	;AN000;
 33322                                  
 33323                                  	;mov	al,2
 33324 00004C01 B002                    	mov	al,$P_DOSTBL_Char ; 2	;AN000; use character upper case table
 33325                                  $P_RLT_CAP02:				;AN000;
 33326 00004C03 E80C01                  	call	$P_Do_CAPS_String	;AN000;  process CAPS along the table
 33327                                  $P_RLT_CAP01:				;AN000;
 33328 00004C06 58                      	pop	ax			;AN000;
 33329 00004C07 26F6470210              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_Rm_Colon
 33330                                  	;test	byte [es:bx+2],10h	;AN000; removing colon at end ?
 33331 00004C0C 7403                    	jz	short $P_RLT_Exit	;AN000;
 33332                                  
 33333 00004C0E E8DD00                  	call	$P_Remove_Colon 	;AN000; then process it.
 33334                                  $P_RLT_Exit:				;AN000;
 33335 00004C11 5F                      	pop	di			;AN000;
 33336 00004C12 C3                      	retn				;AN000;
 33337                                  
 33338                                  ;***********************************************************************
 33339                                  ; $P_Check_Match_Flags
 33340                                  ;
 33341                                  ; Function:  Check the mutch_flags and make the exit code and set the
 33342                                  ;	     result buffer
 33343                                  ;
 33344                                  ;	    Check for types in this order:
 33345                                  ;		Complex
 33346                                  ;		Date
 33347                                  ;		Time
 33348                                  ;		Drive
 33349                                  ;		Filespec
 33350                                  ;		Quoted String
 33351                                  ;		Simple String
 33352                                  ;
 33353                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 33354                                  ;	     ES:BX -> CONTROL block
 33355                                  ;
 33356                                  ; Output:    None
 33357                                  ;
 33358                                  ; Use:	     $P_Value, P$_SValue, $P_Simple_String, $P_Date_Format
 33359                                  ;	     $P_Time_Format, $P_Complex_Format, $P_File_Foemat
 33360                                  ;	     $P_Drive_Format
 33361                                  ;***********************************************************************
 33362                                  
 33363                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33364                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33365                                  $P_Check_Match_Flags:
 33366 00004C13 2EC606[7C98]00          	mov	byte [cs:$P_err_flag],$P_NULL ; 0
 33367                                  					;AN033;AC034;; clear filespec error flag.
 33368 00004C19 50                      	push	ax			;AN000;
 33369                                  	;mov	ax,[es:bx+$P_CONTROL_BLK.$P_Match_Flag]
 33370 00004C1A 268B07                  	mov	ax,[es:bx]		;AN000; load match flag(16bit) to ax
 33371 00004C1D 09C0                    	or	ax,ax			;AC035; test ax for zero
 33372 00004C1F 7518                    	jnz	short $P_Mat		;AN000; (tm12)
 33373 00004C21 50                      	push	ax			;AN000; (tm12)
 33374 00004C22 53                      	push	bx			;AN000; (tm12)
 33375 00004C23 52                      	push	dx			;AN000; (tm12)
 33376 00004C24 57                      	push	di			;AN000; (tm12)
 33377 00004C25 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax
 33378                                  	;mov	word [cs:$P_RC],9	;AC034; (tm12)
 33379                                  	; 31/03/2023
 33380 00004C2C B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33381                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; (tm12)
 33382                                  	;mov	al,$P_String ; 3	;AN000; (tm12)
 33383 00004C2F E860FF                  	call	$P_Fill_Result		;AN000; (tm12)
 33384 00004C32 5F                      	pop	di			;AN000; (tm12)
 33385 00004C33 5A                      	pop	dx			;AN000; (tm12)
 33386 00004C34 5B                      	pop	bx			;AN000; (tm12)
 33387 00004C35 58                      	pop	ax			;AN000; (tm12)
 33388                                  	;jmp	short $P_Bridge 	;AC035; (tm12)
 33389                                  	; 31/03/2023
 33390                                  $P_Bridge:	; 18/04/2023		;AN000;
 33391 00004C36 E99C00                  	jmp	$P_Match_Exit		;AN000; (tm02)
 33392                                  $P_Mat: 				;AN000; (tm12)
 33393                                  $P_Match01:				;AN000;
 33394                                  	;test	ax,1000h
 33395 00004C39 A90010                  	test	ax,$P_Date_S		;AN000; Date string
 33396 00004C3C 7412                    	jz	short $P_Match02	;AN000;
 33397 00004C3E 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33398                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33399 00004C45 E86503                  	call	$P_Date_Format		;AN000; do process
 33400 00004C48 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33401                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33402                                  	; 18/04/2023
 33403 00004C4E 75E6                    	jne	short $P_Bridge		;AN000;
 33404                                  $P_Match02:				;AN000;
 33405                                  	;test	ax,800h
 33406 00004C50 A90008                  	test	ax,$P_Time_S		;AN000; Time string
 33407 00004C53 7412                    	jz	short $P_Match03	;AN000;
 33408 00004C55 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33409                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33410 00004C5C E86004                  	call	$P_Time_Format		;AN000; do process
 33411 00004C5F 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33412                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33413                                  	;jne	short $P_Bridge		;AN000; (tm09)
 33414                                  	;jmp	short $P_Match03	;AN025; (tm09)
 33415                                  	; 31/03/2023
 33416 00004C65 756E                    	jne	short $P_Match_Exit
 33417                                  ;$P_Bridge:				;AN000;
 33418                                  	;jmp	short $P_Match_Exit	;AN000; (tm02)
 33419                                  $P_Match03:				;AN000;
 33420                                  	;test	ax,8000h
 33421 00004C67 A90080                  	test	ax,$P_Num_Val		;AN000; Numeric value
 33422 00004C6A 7412                    	jz	short $P_Match04	;AN000;
 33423 00004C6C 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33424                                  	;mov	word [cs:$P_RC],0	;AC034; assume no error
 33425 00004C73 E82C01                  	call	$P_Value		;AN000; do process
 33426 00004C76 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33427                                  	;cmp	word [cs:$P_RC],9	;AC034; if error, examine the next type
 33428 00004C7C 7557                    	jne	short $P_Match_Exit	;AN000;
 33429                                  $P_Match04:				;AN000;
 33430                                  	;test	ax,4000h
 33431 00004C7E A90040                  	test	ax,$P_SNum_Val		;AN000; Signed numeric value
 33432 00004C81 7412                    	jz	short $P_Match05	;AN000;
 33433 00004C83 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33434                                  					;AC034; assume no error
 33435 00004C8A E8F100                  	call	$P_SValue		;AN000; do process
 33436 00004C8D 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33437                                  					;AC034; if error, examine the next type
 33438 00004C93 7540                    	jne	short $P_Match_Exit	;AN000;
 33439                                  $P_Match05:				;AN000;
 33440                                  	;test	ax,100h
 33441 00004C95 A90001                  	test	ax,$P_Drv_Only		;AN000; Drive only
 33442 00004C98 7415                    	jz	short $P_Match06	;AN000;
 33443 00004C9A 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33444                                  					;AC034; assume no error
 33445 00004CA1 E86805                  	call	$P_File_Format		;AN000; 1st, call file format
 33446 00004CA4 E8E905                  	call	$P_Drive_Format 	;AN000; check drive format, next
 33447 00004CA7 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33448                                  					;AC034; if error, examinee the next type
 33449 00004CAD 7526                    	jne	short $P_Match_Exit	;AN000;
 33450                                  $P_Match06:				;AN000;
 33451                                  	;test	ax,200h
 33452 00004CAF A90002                  	test	ax,$P_File_Spc		;AN000; File spec
 33453 00004CB2 7412                    	jz	short $P_Match07	;AN000;
 33454 00004CB4 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33455                                  					;AC034; assume no error
 33456 00004CBB E84E05                  	call	$P_File_Format		;AN000; do process
 33457 00004CBE 2E833E[A397]09          	cmp	word [cs:$P_RC],$P_Syntax
 33458                                  					;AC034; if error, examine the next type
 33459 00004CC4 750F                    	jne	short $P_Match_Exit	;AN000;
 33460                                  $P_Match07:				;AN000;
 33461                                  $P_Match08:				;AN000;
 33462                                  	;test	ax,2000h
 33463 00004CC6 A90020                  	test	ax,$P_Simple_S		;AN000; Simple string
 33464 00004CC9 740A                    	jz	short $P_Match09	;AN000;
 33465 00004CCB 2EC706[A397]0000        	mov	word [cs:$P_RC],$P_No_Error
 33466                                  					;AC034; assume no error
 33467 00004CD2 E8D601                  	call	$P_Simple_String	;AN000; do process
 33468                                  $P_Match09:				;AN000;
 33469                                  $P_Match_Exit:				;AN000;
 33470 00004CD5 2E833E[7C98]01          	cmp	word [cs:$P_err_flag],$P_error_filespec
 33471                                  	;cmp	word [cs:$P_err_flag],1 ;AC034; bad filespec ?
 33472 00004CDB 750F                    	jne	short $P_Match2_Exit	;AN033; no, continue
 33473 00004CDD 2E833E[A397]00          	cmp	word [cs:$P_RC],$P_No_Error
 33474                                  	;cmp	word [cs:$P_RC],0	;AN033;AC034;; check for other errors ?
 33475 00004CE3 7507                    	jne	short $P_Match2_Exit	;AN033; no, continue
 33476 00004CE5 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax
 33477                                  	;mov	word [cs:$P_RC],9	;AN033;AC034;; set error flag
 33478                                  $P_Match2_Exit: 			;AN033;
 33479 00004CEC 58                      	pop	ax			;AN000;
 33480 00004CED C3                      	retn
 33481                                  
 33482                                  ;***********************************************************************
 33483                                  ; $P_Remove_Colon;
 33484                                  ;
 33485                                  ; Function: Remove colon at end
 33486                                  ;
 33487                                  ; Input:    psdata_seg:SI points to string buffer to be examineed
 33488                                  ;
 33489                                  ; Output:   None
 33490                                  ;
 33491                                  ; Use:	$P_Chk_DBCS
 33492                                  ;***********************************************************************
 33493                                  
 33494                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33495                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33496                                  $P_Remove_Colon:
 33497 00004CEE 50                      	push	ax			;AN000;
 33498 00004CEF 56                      	push	si			;AN000;
 33499                                  $P_RCOL_Loop:				;AN000;
 33500 00004CF0 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 33501 00004CF3 08C0                    	or	al,al			;AN000; end of string ?
 33502 00004CF5 740F                    	jz	short $P_RCOL_Exit	;AN000; if yes, just exit
 33503                                  
 33504 00004CF7 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; is it colon ?
 33505 00004CF9 750E                    	jne	short $P_RCOL00		;AN000;
 33506                                  
 33507                                  	;cmp	byte [cs:si+1],0
 33508 00004CFB 2E807C0100              	cmp	byte [cs:si+1],$P_NULL	;AN000; if so, next is NULL ?
 33509 00004D00 7507                    	jne	short $P_RCOL00		;AN000; no, then next char
 33510                                  
 33511 00004D02 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000; yes, remove colon
 33512                                  	; 31/03/2023
 33513                                  	;jmp	short $P_RCOL_Exit	;AN000; and exit.
 33514                                  $P_RCOL_Exit:
 33515 00004D06 5E                      	pop	si
 33516 00004D07 58                      	pop	ax
 33517 00004D08 C3                      	retn
 33518                                  
 33519                                  $P_RCOL00:				;AN000;
 33520 00004D09 E8A606                  	call	$P_Chk_DBCS		;AN000; if not colon, then check if
 33521 00004D0C 7301                    	jnc	short $P_RCOL01		;AN000; DBCS leading byte.
 33522                                  
 33523 00004D0E 46                      	inc	si			;AN000; if yes, skip trailing byte
 33524                                  $P_RCOL01:				;AN000;
 33525 00004D0F 46                      	inc	si			;AN000; si points to next byte
 33526 00004D10 EBDE                    	jmp	short $P_RCOL_Loop	;AN000; loop until NULL encountered
 33527                                  
 33528                                  	; 31/03/2023
 33529                                  ;$P_RCOL_Exit:				;AN000;
 33530                                  	;pop	si			;AN000;
 33531                                  	;pop	ax			;AN000;
 33532                                  	;retn
 33533                                  
 33534                                  ;***********************************************************************
 33535                                  ; $P_Do_CAPS_String;
 33536                                  ;
 33537                                  ; Function: Perform capitalization along with the file case map table
 33538                                  ;	    or character case map table.
 33539                                  ;
 33540                                  ; Input:    AL = 2 : Use character table
 33541                                  ;	    AL = 4 : Use file table
 33542                                  ;	    psdata_seg:SI points to string buffer to be capitalized
 33543                                  ;
 33544                                  ; Output:   None
 33545                                  ;
 33546                                  ; Use:	$P_Do_CAPS_Char, $P_Chk_DBCS
 33547                                  ;***********************************************************************
 33548                                  
 33549                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33550                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33551                                  $P_Do_CAPS_String:
 33552 00004D12 56                      	push	si			;AN000;
 33553 00004D13 52                      	push	dx			;AN000;
 33554 00004D14 88C2                    	mov	dl,al			;AN000; save info id
 33555                                  $P_DCS_Loop:				;AN000;
 33556 00004D16 2E8A04                  	mov	al,[cs:si]		;AN000; load character and
 33557 00004D19 E89606                  	call	$P_Chk_DBCS		;AN000; check if DBCS leading byte
 33558 00004D1C 720C                    	jc	short $P_DCS00		;AN000; if yes, do not need CAPS
 33559                                  
 33560 00004D1E 08C0                    	or	al,al			;AN000; end of string ?
 33561 00004D20 740C                    	jz	short $P_DCS_Exit	;AN000; then exit.
 33562                                  
 33563 00004D22 E80C00                  	call	$P_Do_CAPS_Char 	;AN000; Here a SBCS char need to be CAPS
 33564 00004D25 2E8804                  	mov	[cs:si],al		;AN000; stored upper case char to buffer
 33565 00004D28 EB01                    	jmp	short $P_DCS01		;AN000; process nexit
 33566                                  $P_DCS00:				;AN000;
 33567 00004D2A 46                      	inc	si			;AN000; skip DBCS leading and trailing byte
 33568                                  $P_DCS01:				;AN000;
 33569 00004D2B 46                      	inc	si			;AN000; si point to next byte
 33570 00004D2C EBE8                    	jmp	short $P_DCS_Loop	;AN000; loop until NULL encountered
 33571                                  $P_DCS_Exit:				;AN000;
 33572 00004D2E 5A                      	pop	dx			;AN000;
 33573 00004D2F 5E                      	pop	si			;AN000;
 33574 00004D30 C3                      	retn
 33575                                  
 33576                                  ;***********************************************************************
 33577                                  ; $P_Do_CAPS_Char;
 33578                                  ;
 33579                                  ; Function: Perform capitalization along with the file case map table
 33580                                  ;	    or character case map table.
 33581                                  ;
 33582                                  ; Input:    DL = 2 : Use character table
 33583                                  ;	    DL = 4 : Use file table
 33584                                  ;	    AL = character to be capitalized
 33585                                  ;
 33586                                  ; Output:   None
 33587                                  ;
 33588                                  ; Use:	INT 21h /w AH=65h
 33589                                  ;***********************************************************************
 33590                                  
 33591                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33592                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33593                                  $P_Do_CAPS_Char:
 33594 00004D31 3C80                    	cmp	al,$P_ASCII80	; 80h	;AN000; need upper case table ?
 33595 00004D33 730B                    	jae	short $P_DCC_Go		;AN000;
 33596                                  
 33597 00004D35 3C61                    	cmp	al,"a"  ; 61h		;AN000; if no,
 33598 00004D37 7244                    	jb	short $P_CAPS_Ret	;AN000;   check if  "a" <= AL <= "z"
 33599                                  
 33600 00004D39 3C7A                    	cmp	al,"z"  ; 7Ah		;AN000;
 33601 00004D3B 7740                    	ja	short $P_CAPS_Ret	;AN000;   if yes, make CAPS
 33602                                  
 33603 00004D3D 24DF                    	and	al,$P_Make_Upper ; 0DFh	;AN000;   else do nothing.
 33604                                  	;jmp	short $P_CAPS_Ret	;AN000;
 33605                                  	; 18/04/2023
 33606 00004D3F C3                      	retn
 33607                                  
 33608                                  $P_DCC_Go:				;AN000;
 33609 00004D40 53                      	push	bx			;AN000;
 33610 00004D41 06                      	push	es			;AN000;
 33611 00004D42 57                      	push	di			;AN000;
 33612                                  	; 18/04/2023
 33613 00004D43 8D3E[6E98]              	lea	di,$P_File_CAP_Ptr	;AC034;
 33614 00004D47 80FA04                  	cmp	dl,$P_DOSTBL_File ; 4	;AN000; Use file CAPS table ?
 33615 00004D4A 7404                    	je	short $P_DCC00		;AN000;
 33616                                  	; 27/04/2023
 33617 00004D4C 8D3E[6998]              	lea	di,$P_Char_CAP_Ptr	;AC034; or use char CAPS table ?
 33618                                  $P_DCC00:				;AN000;
 33619 00004D50 2E3815                  	cmp	[cs:di],dl		;AN000; already got table address ?
 33620 00004D53 7417                    	je	short $P_DCC01		;AN000; if no,
 33621                                  
 33622                                  ;In this next section, ES will be used to pass a 5 byte workarea to INT 21h,
 33623                                  ; the GET COUNTYRY INFO call. This usage of ES is required by the function
 33624                                  ; call, regardless of what base register is currently be defined as PSDATA_SEG.
 33625                                  
 33626 00004D55 50                      	push	ax			;AN000; get CAPS table thru DOS call
 33627 00004D56 51                      	push	cx			;AN000;
 33628 00004D57 52                      	push	dx			;AN000;
 33629 00004D58 0E                      	push	cs			;AC036; pass current base seg into
 33630                                  					;(Note: this used to push CS. BUG...
 33631 00004D59 07                      	pop	es			;AN000;   ES reg, required for
 33632                                  					;get extended country information
 33633                                  	; 31/03/2023
 33634 00004D5A B465                    	mov	ah,$P_DOS_Get_TBL ; 65h	;AN000; get extended CDI
 33635                                  	;mov	ah,65h
 33636 00004D5C 88D0                    	mov	al,dl			;AN000; upper case table
 33637                                  	;mov	bx,-1 ; 0FFFFh
 33638                                  	;mov	cx,5
 33639                                  	;mov	dx,-1
 33640 00004D5E BBFFFF                  	mov	bx,$P_DOSTBL_Def ; -1	;AN000; get active CON
 33641 00004D61 B90500                  	mov	cx,$P_DOSTBL_BL  ; 5 	;AN000; buffer length
 33642 00004D64 BAFFFF                  	mov	dx,$P_DOSTBL_Def ; -1	;AN000; get for default code page
 33643                                  					;DI already set to point to buffer
 33644 00004D67 CD21                    	int	21h			;AN000; es:di point to buffer that
 33645                                  					;now has been filled in with info
 33646 00004D69 5A                      	pop	dx			;AN000;
 33647 00004D6A 59                      	pop	cx			;AN000;
 33648 00004D6B 58                      	pop	ax			;AN000;
 33649                                  
 33650                                  $P_DCC01:				;AN000;
 33651                                  
 33652                                  ;In this next section, ES will be used as the base of the XLAT table, provided
 33653                                  ; by the previous GET COUNTRY INFO DOS call. This usage of ES is made
 33654                                  ; regardless of which base reg is currently the PSDATA_SEG reg.
 33655                                  
 33656 00004D6C 2E8B5D01                	mov	bx,[cs:di+$P_DOS_TBL.$P_DOS_TBL_Off]
 33657                                  	;mov	bx,[cs:di+1]		;AN000; get offset of table
 33658 00004D70 2E8E4503                	mov	es,[cs:di+$P_DOS_TBL.$P_DOS_TBL_Seg]
 33659                                  	;mov	es,[cs:di+3]		;AN000; get segment of table
 33660 00004D74 43                      	inc	bx			;AC035; add '2' to
 33661 00004D75 43                      	inc	bx			;AC035;  BX reg
 33662                                  					;AN000; skip length field
 33663 00004D76 2C80                    	sub	al,$P_ASCII80 ; 80h	;AN000; make char to index
 33664                                  	;xlat	es:[bx] 		;AN000; perform case map
 33665                                  	; 31/03/2023
 33666 00004D78 26D7                    	es	xlat
 33667                                  
 33668 00004D7A 5F                      	pop	di			;AN000;
 33669 00004D7B 07                      	pop	es			;AN000;
 33670 00004D7C 5B                      	pop	bx			;AN000;
 33671                                  $P_CAPS_Ret:				;AN000;
 33672 00004D7D C3                      	retn
 33673                                  
 33674                                  ;***********************************************************************
 33675                                  ; $P_Value / $P_SValue
 33676                                  ;
 33677                                  ; Function:  Make 32bit value from psdata_seg:SI and see value list
 33678                                  ;	     and make result buffer.
 33679                                  ;	     $P_SValue is an entry point for the signed value
 33680                                  ;	     and this will simply call $P_Value after the handling
 33681                                  ;	     of the sign character, "+" or "-"
 33682                                  ;
 33683                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 33684                                  ;	     ES:BX -> CONTROL block
 33685                                  ;
 33686                                  ; Output:    None
 33687                                  ;
 33688                                  ; Use:	$P_Fill_Result, $P_Check_OVF
 33689                                  ;
 33690                                  ; Vars: $P_RC(W), $P_Flags(RW)
 33691                                  ;***********************************************************************
 33692                                  
 33693                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33694                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33695                                  $P_SValue:
 33696 00004D7E 50                      	push	ax			;AN000;
 33697                                  	;or	byte [cs:$P_Flags2],80h
 33698 00004D7F 2E800E[AF97]80          	or	byte [cs:$P_Flags2],$P_Signed
 33699                                  					;AC034; indicate a signed numeric
 33700                                  	;and	byte [cs:$P_Flags2],0FDh
 33701 00004D85 2E8026[AF97]FD          	and	byte [cs:$P_Flags2],0FFh-$P_Neg
 33702                                  					;AC034; assume positive value
 33703 00004D8B 2E8A04                  	mov	al,[cs:si]		;AN000; get sign
 33704 00004D8E 3C2B                    	cmp	al,'+' ; 2Bh
 33705                                  	;cmp	al,$P_Plus ; '+'	;AN000; "+" ?
 33706 00004D90 740A                    	je	short $P_SVal00		;AN000;
 33707                                  
 33708 00004D92 3C2D                    	cmp	al,'-' ; 2Dh
 33709                                  	;cmp	al,$P_Minus ; '-'	;AN000; "-" ?
 33710 00004D94 7507                    	jne	short $P_Sval01		;AN000; else
 33711                                  
 33712 00004D96 2E800E[AF97]02          	or	byte [cs:$P_Flags2],$P_Neg ; 2
 33713                                  					;AC034; set this is negative value
 33714                                  $P_SVal00:				;AN000;
 33715 00004D9C 46                      	inc	si			;AN000; skip sign char
 33716                                  $P_Sval01:				;AN000;
 33717 00004D9D E80200                  	call	$P_Value		;AN000; and process value
 33718 00004DA0 58                      	pop	ax			;AN000;
 33719 00004DA1 C3                      	retn				;AN000;
 33720                                  
 33721                                  ;***********************************************************************
 33722                                  
 33723                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33724                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4955h
 33725                                  
 33726                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33727                                  	; MSDOS 6.2 COMMAND.COM - TRANGROUP:5119h
 33728                                  $P_Value:
 33729 00004DA2 50                      	push	ax			;AN000;
 33730 00004DA3 51                      	push	cx			;AN000;
 33731 00004DA4 52                      	push	dx			;AN000;
 33732 00004DA5 56                      	push	si			;AN000;
 33733 00004DA6 31C9                    	xor	cx,cx			;AN000; cx = higher 16 bits
 33734 00004DA8 31D2                    	xor	dx,dx			;AN000; dx = lower 16 bits
 33735 00004DAA 53                      	push	bx			;AN000; save control pointer
 33736                                  $P_Value_Loop:				;AN000;
 33737 00004DAB 2E8A04                  	mov	al,[cs:si]		;AN000; get character
 33738 00004DAE 08C0                    	or	al,al			;AN000; end of line ?
 33739 00004DB0 7442                    	jz	short $P_Value00	;AN000;
 33740                                  
 33741 00004DB2 E8EB00                  	call	$P_0099 		;AN000; make asc(0..9) to bin(0..9)
 33742 00004DB5 7239                    	jc	short $P_Value_Err0	;AN000;
 33743                                  
 33744 00004DB7 30E4                    	xor	ah,ah			;AN000;
 33745 00004DB9 89C5                    	mov	bp,ax			;AN000; save binary number
 33746 00004DBB D1E2                    	shl	dx,1			;AN000; to have 2*x
 33747 00004DBD D1D1                    	rcl	cx,1			;AN000; shift left w/ carry
 33748 00004DBF E8CC00                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33749 00004DC2 722C                    	jc	short $P_Value_Err0	;AN000; then error, exit
 33750                                  
 33751 00004DC4 89D3                    	mov	bx,dx			;AN000; save low(2*x)
 33752 00004DC6 89C8                    	mov	ax,cx			;AN000; save high(2*x)
 33753 00004DC8 D1E2                    	shl	dx,1			;AN000; to have 4*x
 33754 00004DCA D1D1                    	rcl	cx,1			;AN000; shift left w/ carry
 33755 00004DCC E8BF00                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33756 00004DCF 721F                    	jc	short $P_Value_Err0	;AN000; then error, exit
 33757                                  
 33758 00004DD1 D1E2                    	shl	dx,1			;AN000; to have 8*x
 33759 00004DD3 D1D1                    	rcl	cx,1			;AN000; shift left w/ carry
 33760 00004DD5 E8B600                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33761 00004DD8 7216                    	jc	short $P_Value_Err0	;AN000; then error, exit
 33762                                  
 33763 00004DDA 01DA                    	add	dx,bx			;AN000; now have 10*x
 33764 00004DDC 11C1                    	adc	cx,ax			;AN000; 32bit ADD
 33765 00004DDE E8AD00                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33766 00004DE1 720D                    	jc	short $P_Value_Err0	;AN000; then error, exit
 33767                                  
 33768 00004DE3 01EA                    	add	dx,bp			;AN000; Add the current one degree decimal
 33769 00004DE5 83D100                  	adc	cx,0			;AN000; if carry, add 1 to high 16bit
 33770 00004DE8 E8A300                  	call	$P_Check_OVF		;AN000; Overflow occurred ?
 33771 00004DEB 7203                    	jc	short $P_Value_Err0	;AN000; then error, exit
 33772                                  
 33773 00004DED 46                      	inc	si			;AN000; update pointer
 33774 00004DEE EBBB                    	jmp	short $P_Value_Loop	;AN000; loop until NULL encountered
 33775                                  
 33776                                  $P_Value_Err0:				;AN000;
 33777 00004DF0 5B                      	pop	bx			;AN000;
 33778 00004DF1 E98800                  	jmp	$P_Value_Err		;AN000; Bridge
 33779                                  
 33780                                  $P_Value00:				;AN000;
 33781 00004DF4 5B                      	pop	bx			;AN000; restore control pointer
 33782 00004DF5 2EF606[AF97]02          	test	byte [cs:$P_Flags2],$P_Neg ; 2 
 33783                                  					;AC034; here cx,dx = 32bit value
 33784 00004DFB 740A                    	jz	short $P_Value01	;AN000; was it negative ?
 33785                                  
 33786 00004DFD F7D1                    	not	cx			;AN000; +
 33787 00004DFF F7D2                    	not	dx			;AN000; |- Make 2's complement
 33788 00004E01 83C201                  	add	dx,1			;AN000; |
 33789 00004E04 83D100                  	adc	cx,0			;AN000; +
 33790                                  $P_Value01:				;AN000; / nval =0
 33791 00004E07 268B7706                	mov	si,[es:bx+$P_CONTROL_BLK.$P_Value_List]
 33792                                  	;mov	si,[es:bx+6]		;AN000; si points to value list
 33793 00004E0B 268A04                  	mov	al,[es:si]		;AN000; get nval
 33794 00004E0E 3C00                    	cmp	al,$P_nval_None ; 0	;AN000; no value list ?
 33795 00004E10 7505                    	jne	short $P_Value02	;AN000;
 33796                                  
 33797                                  	;mov	al,$P_Number	; 1	;AN000; Set type
 33798                                  	;mov	ah,$P_No_Tag	; 0FFh	;AN000; No ITEM_TAG set
 33799                                  	; 31/03/2023
 33800 00004E12 B801FF                  	mov	ax,($P_No_Tag<<8)+$P_Number
 33801 00004E15 EB6F                    	jmp	short $P_Value_Exit	;AN000;
 33802                                  
 33803                                  $P_Value02:				;AN000; / nval = 1
 33804 00004E17 46                      	inc	si			;AN000;
 33805 00004E18 268A04                  	mov	al,[es:si]		;AN000; al = number of range
 33806 00004E1B 3C00                    	cmp	al,$P_No_nrng	; 0	;AN000; (tm07)
 33807 00004E1D 745D                    	je	short $P_Value03	;AN000; (tm07)
 33808                                  
 33809 00004E1F 46                      	inc	si			;AN000; si points to 1st item_tag
 33810                                  $P_Val02_Loop:				;AN000;
 33811 00004E20 2EF606[AF97]80          	test	byte [cs:$P_Flags2],$P_Signed ; 80h
 33812                                  	;test	byte [cs:$P_Flags2],80h	;AC034;
 33813 00004E26 751E                    	jnz	short $P_Val02_Sign	;AN000;
 33814                                  
 33815 00004E28 263B4C03                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_XH]
 33816                                  	;cmp	cx,[es:si+3]		;AN000; comp cx with XH
 33817 00004E2C 723B                    	jb	short $P_Val02_Next	;AN000;
 33818 00004E2E 7706                    	ja	short $P_Val_In		;AN000;
 33819                                  
 33820 00004E30 263B5401                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_XL]
 33821                                  	;cmp	dx,[es:si+1]		;AN000; comp dx with XL
 33822 00004E34 7233                    	jb	short $P_Val02_Next	;AN000;
 33823                                  
 33824                                  $P_Val_In:				;AN000;
 33825 00004E36 263B4C07                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_YH]
 33826                                  	;cmp	cx,[es:si+7]		;AN000; comp cx with YH (tm01)
 33827 00004E3A 772D                    	ja	short $P_Val02_Next	;AN000;
 33828 00004E3C 7224                    	jb	short $P_Val_Found	;AN000;
 33829                                  
 33830 00004E3E 263B5405                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_YL]
 33831                                  	;cmp	dx,[es:si+5]		;AN000; comp dx with YL
 33832 00004E42 7725                    	ja	short $P_Val02_Next	;AN000;
 33833                                  
 33834 00004E44 EB1C                    	jmp	short $P_Val_Found	;AN000;
 33835                                  
 33836                                  $P_Val02_Sign:				;AN000;
 33837 00004E46 263B4C03                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_XH]
 33838                                  	;cmp	cx,[es:si+3]		;AN000; comp cx with XH
 33839 00004E4A 7C1D                    	jl	short $P_Val02_Next	;AN000;
 33840 00004E4C 7F06                    	jg	short $P_SVal_In	;AN000;
 33841                                  
 33842 00004E4E 263B5401                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_XL]
 33843                                  	;cmp	dx,[es:si+1]		;AN000; comp dx with XL
 33844 00004E52 7C15                    	jl	short $P_Val02_Next	;AN000;
 33845                                  
 33846                                  $P_SVal_In:				;AN000;
 33847 00004E54 263B4C07                	cmp	cx,[es:si+$P_VAL_LIST.$P_Val_YH]
 33848                                  	;cmp	cx,[es:si+7]		;AN000; comp cx with YH
 33849 00004E58 7F0F                    	jg	short $P_Val02_Next	;AN000;
 33850 00004E5A 7C06                    	jl	short $P_Val_Found	;AN000;
 33851                                  
 33852 00004E5C 263B5405                	cmp	dx,[es:si+$P_VAL_LIST.$P_Val_YL]
 33853                                  	;cmp	dx,[es:si+5]		;AN000; comp dx with YL
 33854 00004E60 7F07                    	jg	short $P_Val02_Next	;AN000;
 33855                                  
 33856                                  	;jmp	short $P_Val_Found	;AN000;
 33857                                  	; 27/04/2023
 33858                                  $P_Val_Found:				;AN000;
 33859 00004E62 B001                    	mov	al,$P_Number ; 1	;AN000;
 33860 00004E64 268A24                  	mov	ah,[es:si]		;AN000; found ITEM_TAG set
 33861 00004E67 EB1D                    	jmp	short $P_Value_Exit	;AN000;
 33862                                  
 33863                                  $P_Val02_Next:				;AN000;
 33864 00004E69 83C609                  	add	si,$P_Len_Range ; 9 	;AN000;
 33865 00004E6C FEC8                    	dec	al			;AN000; loop nrng times in AL
 33866 00004E6E 75B0                    	jnz	short $P_Val02_Loop	;AN000;
 33867                                  					; / Not found
 33868 00004E70 2EC706[A397]0600        	mov	word [cs:$P_RC],$P_Out_Of_Range
 33869                                  	;mov	word [cs:$P_RC],6	;AC034;
 33870                                  	
 33871                                  	;mov	al,$P_Number ; 1	;AN000;
 33872                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; No ITEM_TAG set
 33873                                  	; 31/03/2023
 33874 00004E77 B801FF                  	mov	ax,($P_No_Tag<<8)+$P_Number
 33875 00004E7A EB0A                    	jmp	short $P_Value_Exit	;AN000;
 33876                                  
 33877                                  	; 27/04/2023
 33878                                  ;$P_Val_Found:				;AN000;
 33879                                  	;mov	al,$P_Number ; 1	;AN000;
 33880                                  	;mov	ah,[es:si]		;AN000; found ITEM_TAG set
 33881                                  	;jmp	short $P_Value_Exit	;AN000;
 33882                                  
 33883                                  $P_Value03:				;AN000; / nval = 2
 33884                                  $P_Value04:				;AN000; / nval = 3 or else
 33885                                  $P_Value_Err:				;AN000;
 33886 00004E7C 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9
 33887                                  					;AC034;
 33888                                  	;mov	al,$P_String ; 3	;AN000; Set type
 33889                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 33890                                  	; 31/03/2023
 33891 00004E83 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 33892                                  $P_Value_Exit:				;AN000;
 33893 00004E86 E809FD                  	call	$P_Fill_Result		;AN000;
 33894 00004E89 5E                      	pop	si			;AN000;
 33895 00004E8A 5A                      	pop	dx			;AN000;
 33896 00004E8B 59                      	pop	cx			;AN000;
 33897 00004E8C 58                      	pop	ax			;AN000;
 33898 00004E8D C3                      	retn				;AN000;
 33899                                  
 33900                                  ;***********************************************************************
 33901                                  ; $P_Check_OVF
 33902                                  ;
 33903                                  ; Function:  Check if overflow is occurred with consideration of
 33904                                  ;	     signed or un-signed numeric value
 33905                                  ;
 33906                                  ; Input:     Flag register
 33907                                  ;
 33908                                  ; Output:    CY = 1  :	Overflow
 33909                                  ;
 33910                                  ; Vars:     $P_Flags(R)
 33911                                  ;***********************************************************************
 33912                                  
 33913                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33914                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33915                                  $P_Check_OVF:
 33916 00004E8E 9C                      	pushf				;AN000;
 33917 00004E8F 2EF606[AF97]02          	test	byte [cs:$P_Flags2],$P_Neg ; 2
 33918                                  					;AC034; is it negative value ?
 33919 00004E95 7502                    	jnz	short $P_COVF		;AN000; if no, check overflow
 33920 00004E97 9D                      	popf				;AN000; by the CY bit
 33921 00004E98 C3                      	retn				;AN000;
 33922                                  $P_COVF:				;AN000;
 33923 00004E99 9D                      	popf				;AN000; else,
 33924 00004E9A 7002                    	jo	short $P_COVF00		;AN000; check overflow by the OF
 33925 00004E9C F8                      	clc				;AN000; indicate it with CY bit
 33926 00004E9D C3                      	retn				;AN000; CY=0 means no overflow
 33927                                  $P_0099Err:	; 31/03/2023
 33928                                  $P_COVF00:				;AN000;
 33929 00004E9E F9                      	stc				;AN000; and CY=1 means overflow
 33930                                  $P_0099Err2:	; 31/03/2023
 33931 00004E9F C3                      	retn				;AN000;
 33932                                  
 33933                                  ;***********************************************************************
 33934                                  ; $P_0099;
 33935                                  ;
 33936                                  ; Function:  Make ASCII 0-9 to Binary 0-9
 33937                                  ;
 33938                                  ; Input:     AL = character code
 33939                                  ;
 33940                                  ; Output:    CY = 1 : AL is not number
 33941                                  ;	     CY = 0 : AL contains binary value
 33942                                  ;***********************************************************************
 33943                                  
 33944                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33945                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33946                                  $P_0099:
 33947 00004EA0 3C30                    	cmp	al,"0"                  ;AN000;
 33948                                  	;jb	short $P_0099Err	;AN000;  must be 0 =< al =< 9
 33949                                  	; 31/03/2023
 33950 00004EA2 72FB                    	jb	short $P_0099Err2
 33951                                  
 33952 00004EA4 3C39                    	cmp	al,"9"                  ;AN000;
 33953 00004EA6 77F6                    	ja	short $P_0099Err	;AN000;  must be 0 =< al =< 9
 33954                                  
 33955 00004EA8 2C30                    	sub	al,"0"                  ;AN000; make char -> bin
 33956                                  	; 31/03/2023
 33957                                  	;clc				;AN000; indicate no error
 33958 00004EAA C3                      	retn				;AN000;
 33959                                  	 ;31/03/2023
 33960                                  ;$P_0099Err:				;AN000;
 33961                                  ;	stc				;AN000; indicate error
 33962                                  ;	retn				;AN000;
 33963                                  
 33964                                  ;***********************************************************************
 33965                                  ; $P_Simple_String
 33966                                  ;
 33967                                  ; Function:  See value list for the simple string
 33968                                  ;	     and make result buffer.
 33969                                  ;
 33970                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 33971                                  ;	     ES:BX -> CONTROL block
 33972                                  ;
 33973                                  ; Output:    None
 33974                                  ;
 33975                                  ; Use:	$P_Fill_Result, $P_String_Comp
 33976                                  ;
 33977                                  ; Vars: $P_RC(W)
 33978                                  ;***********************************************************************
 33979                                  
 33980                                  	; 31/03/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 33981                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 33982                                  $P_Simple_String:
 33983 00004EAB 50                      	push	ax			;AN000;
 33984 00004EAC 53                      	push	bx			;AN000;
 33985 00004EAD 52                      	push	dx			;AN000;
 33986 00004EAE 57                      	push	di			;AN000;
 33987 00004EAF 268B7F06                	mov	di,[es:bx+$P_CONTROL_BLK.$P_Value_List]
 33988                                  	;mov	di,[es:bx+6]		;AN000; di points to value list
 33989 00004EB3 268A05                  	mov	al,[es:di]		;AN000; get nval
 33990 00004EB6 08C0                    	or	al,al			;AN000; no value list ?
 33991 00004EB8 7502                    	jnz	short $P_Sim00		;AN000; then
 33992                                  	; 31/03/2023
 33993                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 33994 00004EBA EB48                    	jmp	short $P_Sim_Exit	;AN000; and set result buffer
 33995                                  $P_Sim00:				;AN000;
 33996 00004EBC 3C03                    	cmp	al,$P_nval_String ; 3	;AN000; String choice list provided ?
 33997 00004EBE 753D                    	jne	short $P_Sim01		;AN000; if no, syntax error
 33998                                  
 33999 00004EC0 47                      	inc	di			;AN000;
 34000 00004EC1 268A05                  	mov	al,[es:di]		;AN000; al = nrng
 34001 00004EC4 B409                    	mov	ah,$P_Len_Range ; 9	;AN000;
 34002 00004EC6 F6E4                    	mul	ah			;AN000;  Skip nrng field
 34003 00004EC8 40                      	inc	ax			;AN000; ax = (nrng*9)+1
 34004 00004EC9 01C7                    	add	di,ax			;AN000; di points to nnval
 34005 00004ECB 268A05                  	mov	al,[es:di]		;AN000; get nnval
 34006 00004ECE B405                    	mov	ah,$P_Len_Value ; 5	;AN000;
 34007 00004ED0 F6E4                    	mul	ah			;AN000; Skip nnval field
 34008 00004ED2 40                      	inc	ax			;AN000; ax = (nnval*5)+1
 34009 00004ED3 01C7                    	add	di,ax			;AN000; di points to nstrval
 34010 00004ED5 268A05                  	mov	al,[es:di]		;AN000; get nstrval
 34011 00004ED8 47                      	inc	di			;AC035; add '2' to
 34012 00004ED9 47                      	inc	di			;AC035;  DI reg
 34013                                  					;AN000; di points to 1st string in list
 34014                                  $P_Sim_Loop:				;AN000;
 34015 00004EDA 268B2D                  	mov	bp,[es:di]		;AN000; get string pointer
 34016 00004EDD E82F00                  	call	$P_String_Comp		;AN000; compare it with operand
 34017 00004EE0 7310                    	jnc	short $P_Sim_Found	;AN000; found on list ?
 34018                                  
 34019 00004EE2 83C703                  	add	di,$P_Len_String ; 3	;AN000; if no, point to next choice
 34020 00004EE5 FEC8                    	dec	al			;AN000; loop nstval times in AL
 34021 00004EE7 75F1                    	jnz	short $P_Sim_Loop	;AN000;
 34022                                  					;AN000; / Not found
 34023 00004EE9 2EC706[A397]0800        	mov	word [cs:$P_RC],$P_Not_In_Str
 34024                                  	;mov	[cs:$P_RC],8		;AC034;
 34025                                  	; 31/03/2023
 34026                                  	;mov	ah,$P_No_Tag		;AN000; No ITEM_TAG set
 34027 00004EF0 EB12                    	jmp	short $P_Sim_Exit	;AN000;
 34028                                  $P_Sim_Found:				;AN000;
 34029 00004EF2 268A65FF                	mov	ah,[es:di-1]		;AN000; set item_tag
 34030 00004EF6 B002                    	mov	al,$P_List_Idx	; 2	;AN000;
 34031 00004EF8 268B15                  	mov	dx,[es:di]		;AN000; get address of STRING
 34032 00004EFB EB0A                    	jmp	short $P_Sim_Exit0	;AN000;
 34033                                  $P_Sim01:				;AN000;
 34034 00004EFD 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax
 34035                                  	;mov	word [cs:$P_RC],9	;AC034;
 34036                                  $P_Sim_Exit:
 34037                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; No ITEM_TAG set
 34038                                  ;$P_Sim_Exit:				;AN000;
 34039                                  	;mov	al,$P_String ; 3	;AN000; Set type
 34040                                  	; 31/03/2023
 34041 00004F04 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34042                                  $P_Sim_Exit0:				;AN000;
 34043 00004F07 E888FC                  	call	$P_Fill_Result		;AN000;
 34044 00004F0A 5F                      	pop	di			;AN000;
 34045 00004F0B 5A                      	pop	dx			;AN000;
 34046 00004F0C 5B                      	pop	bx			;AN000;
 34047 00004F0D 58                      	pop	ax			;AN000;
 34048 00004F0E C3                      	retn				;AN000;
 34049                                  
 34050                                  ;***********************************************************************
 34051                                  ; $P_String_Comp:
 34052                                  ;
 34053                                  ; Function:  Compare two string
 34054                                  ;
 34055                                  ; Input:     psdata_seg:SI -> 1st string
 34056                                  ;	     ES:BP -> 2nd string  (Must be upper case)
 34057                                  ;	     ES:BX -> CONTROL block
 34058                                  ;
 34059                                  ; Output:    CY = 1 if not match
 34060                                  ;
 34061                                  ; Use:	$P_Chk_DBCS, $P_Do_CAPS_Char
 34062                                  ;
 34063                                  ; Vars: $P_KEYor_SW_Ptr(W), $P_Flags(R). $P_KEYorSW_Ptr
 34064                                  ;***********************************************************************
 34065                                  
 34066                                  	; 01/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34067                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34068                                  $P_String_Comp:
 34069 00004F0F 50                      	push	ax			;AN000;
 34070 00004F10 55                      	push	bp			;AN000;
 34071 00004F11 52                      	push	dx			;AN000;
 34072 00004F12 56                      	push	si			;AN000;
 34073 00004F13 B202                    	mov	dl,$P_DOSTBL_Char ; 2	;AN000; use character case map table
 34074                                  $P_SCOM_Loop:				;AN000;
 34075 00004F15 2E8A04                  	mov	al,[cs:si]		;AN000; get command character
 34076 00004F18 E89704                  	call	$P_Chk_DBCS		;AN000; DBCS ?
 34077 00004F1B 723C                    	jc	short $P_SCOM00		;AN000; yes,DBCS
 34078                                  
 34079 00004F1D E811FE                  	call	$P_Do_CAPS_Char 	;AN000; else, upper case map before comparison
 34080                                  	
 34081 00004F20 2EF606[AF97]08          	test	byte [cs:$P_Flags2],$P_Key_Cmp ; 8
 34082                                  					;AC034; keyword search ?
 34083 00004F26 740D                    	jz	short $P_SCOM04		;AN000;
 34084                                  
 34085                                  	;cmp	al,'=' ; 3Dh
 34086 00004F28 3C3D                    	cmp	al,$P_Keyword  ;'='	;AN000; "=" is delimiter
 34087 00004F2A 751F                    	jne	short $P_SCOM03		;AN000;IF "=" on command line AND  (bp+1=> char after the "=" in synonym list)
 34088                                  
 34089 00004F2C 26807E0100              	cmp	byte [es:bp+1],$P_NULL	;AN021;   at end of keyword string in the control block THEN
 34090 00004F31 7562                    	jne	short $P_SCOM_Differ	;AN021;
 34091                                  
 34092 00004F33 EB13                    	jmp	short $P_SCOM05 	;AN000;   keyword found in synonym list
 34093                                  
 34094                                  $P_SCOM04:				;AN000;
 34095 00004F35 2EF606[AF97]10          	test	byte [cs:$P_Flags2],$P_SW_Cmp ; 10h 
 34096                                  					;AC034; switch search ?
 34097 00004F3B 740E                    	jz	short $P_SCOM03		;AN000;
 34098                                  
 34099 00004F3D 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; ":" is delimiter, at end of switch on command line
 34100 00004F3F 750A                    	jne	short $P_SCOM03		;AN000; continue compares
 34101                                  
 34102 00004F41 26807E0000              	cmp	byte [es:bp],$P_NULL 	;AN021; IF at end of switch on command AND
 34103 00004F46 754D                    	jne	short $P_SCOM_Differ	;AN021;   at end of switch string in the control block THEN
 34104                                  
 34105                                  $P_SCOM05:				;AN000;   found a match
 34106 00004F48 46                      	inc	si			;AN000; si points to just after "=" or ":"
 34107 00004F49 EB58                    	jmp	short $P_SCOM_Same	;AN000; exit
 34108                                  
 34109                                  $P_SCOM03:				;AN000;
 34110 00004F4B 263A4600                	cmp	al,[es:bp]		;AN000; compare operand w/ a synonym
 34111 00004F4F 751D                    	jne	short $P_SCOM_Differ0 	;AN000; if different, check ignore colon option
 34112                                  
 34113 00004F51 08C0                    	or	al,al			;AN000; end of line
 34114 00004F53 744E                    	jz	short $P_SCOM_Same	;AN000; if so, exit
 34115                                  
 34116 00004F55 46                      	inc	si			;AN000; update operand pointer
 34117 00004F56 45                      	inc	bp			;AN000;    and synonym pointer
 34118 00004F57 EB13                    	jmp	short $P_SCOM01 	;AN000; loop until NULL or "=" or ":" found in case
 34119                                  
 34120                                  $P_SCOM00:				;AN000; Here al is DBCS leading byte
 34121 00004F59 263A4600                	cmp	al,[es:bp]		;AN000; compare leading byte
 34122 00004F5D 7536                    	jne	short $P_SCOM_Differ	;AN000; if not match, say different
 34123                                  
 34124 00004F5F 46                      	inc	si			;AN000; else, load next byte
 34125 00004F60 2E8A04                  	mov	al,[cs:si]		;AN000; and
 34126 00004F63 45                      	inc	bp			;AN000;
 34127 00004F64 263A4600                	cmp	al,[es:bp]		;AN000; compare 2nd byte
 34128 00004F68 752B                    	jne	short $P_SCOM_Differ	;AN000; if not match, say different, too
 34129                                  
 34130 00004F6A 46                      	inc	si			;AN000; else update operand pointer
 34131 00004F6B 45                      	inc	bp			;AN000; 	and synonym pointer
 34132                                  $P_SCOM01:				;AN000;
 34133 00004F6C EBA7                    	jmp	short $P_SCOM_Loop	;AN000; loop until NULL or "=" or "/" found in case
 34134                                  
 34135                                  $P_SCOM_Differ0:			;AN000;
 34136 00004F6E 2EF606[AF97]40          	test	byte [cs:$P_Flags2],$P_SW ; 40h 
 34137                                  	;test	byte [cs:$P_Flags2],40h	;AC034;(tm10)
 34138 00004F74 740E                    	jz	short $P_not_applicable	;AN000;(tm10)
 34139                                  
 34140                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_colon_is_not_necessary
 34141                                  	;;test	word [es:bx+2],20h	;AN000;(tm10)
 34142                                  	; 03/04/2023
 34143 00004F76 26F6470220              	test	byte [es:bx+$P_CONTROL_BLK.$P_Function_Flag],$P_colon_is_not_necessary	
 34144 00004F7B 7407                    	jz	short $P_not_applicable	;AN000;(tm10)
 34145                                  
 34146 00004F7D 26807E0000              	cmp	byte [es:bp],$P_NULL	;AN000;(tm10)
 34147 00004F82 741F                    	je	short $P_SCOM_Same	;AN025;(tm10)
 34148                                  
 34149                                  $P_not_applicable:			;AN000;(tm10)
 34150                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 34151                                  	;;test	word [es:bx],10h	;AN000; ignore colon option specified ?
 34152                                  	; 03/04/2023
 34153 00004F84 26F60710                	test	byte [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 34154 00004F88 740B                    	jz	short $P_SCOM_Differ	;AN000; if no, say different.
 34155                                  
 34156 00004F8A 3C3A                    	cmp	al,$P_Colon ; ':' ; 3Ah	;AN000; End up with ":" and
 34157 00004F8C 750A                    	jne	short $P_SCOM02		;AN000;    subseqently
 34158                                  
 34159 00004F8E 26807E0000              	cmp	byte [es:bp],$P_NULL 	;AN000;      NULL ?
 34160                                  	;jne	short $P_SCOM_Differ	;AN000; if no, say different
 34161                                  	;jmp	short $P_SCOM_Same	;AN000; else, say same
 34162                                  	; 01/04/2023
 34163 00004F93 740E                    	je	short $P_SCOM_Same
 34164                                  $P_SCOM_Differ:
 34165 00004F95 F9                      	stc
 34166 00004F96 EB10                    	jmp	short $P_SCOM_Exit
 34167                                  
 34168                                  $P_SCOM02:				;AN000;
 34169 00004F98 3C00                    	cmp	al,$P_NULL ; 0		;AN000; end up NULL and :
 34170 00004F9A 75F9                    	jne	short $P_SCOM_Differ	;AN000;
 34171                                  
 34172                                  	;cmp	byte [es:bp],':'
 34173 00004F9C 26807E003A              	cmp	byte [es:bp],$P_Colon	;AN000; if no, say different
 34174                                  	;je	short $p_SCOM_Same	;AN000; else, say same
 34175                                  	; 01/04/2023
 34176 00004FA1 75F2                    	jne	short $P_SCOM_Differ
 34177                                  ;$P_SCOM_Differ: 			;AN000;
 34178                                  	;stc				;AN000; indicate not found
 34179                                  	;jmp	short $P_SCOM_Exit	;AN000;
 34180                                  
 34181                                  $P_SCOM_Same:				;AN000;
 34182 00004FA3 2E8936[B297]            	mov	[cs:$P_KEYorSW_Ptr],si	;AC034; for later use by keyword or switch
 34183                                  	; 01/04/2023
 34184                                  	;clc
 34185                                  	; cf = 0			;AN000; indicate found
 34186                                  $P_SCOM_Exit:				;AN000;
 34187 00004FA8 5E                      	pop	si			;AN000;
 34188 00004FA9 5A                      	pop	dx			;AN000;
 34189 00004FAA 5D                      	pop	bp			;AN000;
 34190 00004FAB 58                      	pop	ax			;AN000;
 34191 00004FAC C3                      	retn				;AN000;
 34192                                  
 34193                                  ;***********************************************************************
 34194                                  ; $P_Date_Format
 34195                                  ;
 34196                                  ; Function:  Convert a date string to DOS date format for int 21h
 34197                                  ;	     with format validation.
 34198                                  ;
 34199                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34200                                  ;	     ES:BX -> CONTROL block
 34201                                  ;
 34202                                  ; Output:    None
 34203                                  ;
 34204                                  ; Use:	$P_Fill_Result, $P_Set_CDI, $P_Get_DecNum
 34205                                  ;
 34206                                  ; Vars: $P_RC(W), $P_1st_Val(RW), $P_2nd_Val(RW), $P_3rd_Val(RW)
 34207                                  ;***********************************************************************
 34208                                  
 34209                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34210                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34211                                  $P_Date_Format:
 34212 00004FAD 50                      	push	ax			;AN000;
 34213 00004FAE 51                      	push	cx			;AN000;
 34214 00004FAF 52                      	push	dx			;AN000;
 34215 00004FB0 56                      	push	si			;AN000;
 34216 00004FB1 53                      	push	bx			;AN000;
 34217 00004FB2 56                      	push	si			;AN000;
 34218 00004FB3 E89F00                  	call	$P_Set_CDI		;AN000; set country dependent information before process
 34219                                  	; 03/04/2023
 34220                                  	;pop	si			;AN000;
 34221                                  	;mov	word [cs:$P_1st_Val],0	;AC034; set initial value
 34222                                  	;mov	word [cs:$P_2nd_Val],0	;AC034; set initial value
 34223                                  	;mov	word [cs:$P_3rd_Val],0	;AC034; set initial value
 34224 00004FB6 31F6                    	xor	si,si
 34225 00004FB8 2E8936[6198]            	mov	[cs:$P_1st_Val],si ; 0	;AC034; set initial value
 34226 00004FBD 2E8936[6398]            	mov	[cs:$P_2nd_Val],si ; 0	;AC034; set initial value
 34227                                  	;mov	[cs:$P_3rd_Val],si ; 0	;AC034; set initial value
 34228 00004FC2 5E                      	pop	si
 34229 00004FC3 E8A900                  	call	$P_Get_DecNum		;AN000; get 1st number
 34230 00004FC6 7218                    	jc	short $P_DateF_Err0	;AN000;-----------------------+
 34231 00004FC8 2EA3[6198]              	mov	[cs:$P_1st_Val],ax	;AC034;			      |
 34232 00004FCC 08DB                    	or	bl,bl			;AN000; end of line ?	      |
 34233 00004FCE 741A                    	jz	short $P_DateF_YMD	;AN000; 		      |
 34234 00004FD0 E89C00                  	call	$P_Get_DecNum		;AN000; get 2nd number	      |
 34235 00004FD3 726D                    	jc	short $P_DateF_Error	;AN000; 		      |
 34236 00004FD5 2EA3[6398]              	mov	[cs:$P_2nd_Val],ax	;AC034;			      |
 34237 00004FD9 08DB                    	or	bl,bl			;AN000; end of line ?	      |
 34238 00004FDB 740D                    	jz	short $P_DateF_YMD	;AN000; 		      |
 34239 00004FDD E88F00                  	call	$P_Get_DecNum		;AN000; get 3rd number	      |
 34240                                  $P_DateF_Err0:				;AN000; Bridge	  <-----------+
 34241 00004FE0 7260                    	jc	short $P_DateF_Error	;AN000;
 34242 00004FE2 2EA3[6598]              	mov	[cs:$P_3rd_Val],ax	;AC034;
 34243 00004FE6 08DB                    	or	bl,bl			;AN000; end of line ?
 34244 00004FE8 7558                    	jnz	short $P_DateF_Error	;AN000;
 34245                                  $P_DateF_YMD:				;AN000;
 34246 00004FEA 2E8B1E[3F98]            	mov	bx,[cs:$P_Country_Info+$P_CDI.$P_CDI_DateF]
 34247                                  	;mov	bx,[cs:$P_Country_Info]	;AC034; get date format
 34248 00004FEF 83FB02                  	cmp	bx,$P_Date_YMD ; 2	;AN000;
 34249 00004FF2 7422                    	je	short $P_DateF00	;AN000;
 34250 00004FF4 2EA1[6198]              	mov	ax,[cs:$P_1st_Val]	;AC034;
 34251 00004FF8 08E4                    	or	ah,ah			;AN000;
 34252 00004FFA 7546                    	jnz	short $P_DateF_Error	;AN000;
 34253 00004FFC 88C1                    	mov	cl,al			;AN000; set month
 34254 00004FFE 2EA1[6398]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34255 00005002 08E4                    	or	ah,ah			;AN000; if overflow, error.
 34256 00005004 753C                    	jnz	short $P_DateF_Error	;AN000;
 34257 00005006 88C5                    	mov	ch,al			;AN000; set date
 34258 00005008 2E8B16[6598]            	mov	dx,[cs:$P_3rd_Val]	;AC034; set year
 34259 0000500D 83FB01                  	cmp	bx,$P_Date_DMY ; 1	;AN000; from here format = MDY
 34260 00005010 7502                    	jne	short $P_DateF01	;AN000; if it is DMY
 34261 00005012 86E9                    	xchg	ch,cl			;AN000;  then swap M <-> D
 34262                                  $P_DateF01:				;AN000;
 34263 00005014 EB19                    	jmp	short $P_DateF02	;AN000;
 34264                                  $P_DateF00:				;AN000; / here format = YMD
 34265 00005016 2E8B16[6198]            	mov	dx,[cs:$P_1st_Val]	;AC034; set year
 34266 0000501B 2EA1[6398]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34267 0000501F 08E4                    	or	ah,ah			;AN000; if overflow, error
 34268 00005021 751F                    	jnz	short $P_DateF_Error	;AN000;
 34269                                  
 34270 00005023 88C1                    	mov	cl,al			;AN000; set month
 34271 00005025 2EA1[6598]              	mov	ax,[cs:$P_3rd_Val]	;AC034;
 34272 00005029 08E4                    	or	ah,ah			;AN000; if overflow, error
 34273 0000502B 7515                    	jnz	short $P_DateF_Error	;AN000;
 34274 0000502D 88C5                    	mov	ch,al			;AN000; set date
 34275                                  $P_DateF02:				;AN000;
 34276 0000502F 83FA64                  	cmp	dx,100			;AN000; year is less that 100 ?
 34277 00005032 7304                    	jae	short $P_DateF03	;AN000;
 34278 00005034 81C26C07                	add	dx,1900 		;AN000; set year 19xx
 34279                                  $P_DateF03:				;AN000;
 34280 00005038 5B                      	pop	bx			;AN000; recover CONTROL block
 34281 00005039 5E                      	pop	si			;AN000; recover string pointer
 34282                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34283                                  	;mov	al,$P_Date_F ; 7	;AN000;   result
 34284                                  	; 03/04/2023
 34285 0000503A B807FF                  	mov	ax,($P_No_Tag<<8)+$P_Date_F
 34286 0000503D E852FB                  	call	$P_Fill_Result		;AN000;        buffer
 34287 00005040 EB0F                    	jmp	short $P_Date_Format_Exit
 34288                                  					;AN000;	to Date
 34289                                  $P_DateF_Error: 			;AN000;
 34290 00005042 5B                      	pop	bx			;AN000; recover CONTROL block
 34291 00005043 5E                      	pop	si			;AN000; recover string pointer
 34292                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34293                                  	;mov	al,$P_String ; 3	;AN000;   result
 34294                                  	; 03/04/2023
 34295 00005044 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34296 00005047 E848FB                  	call	$P_Fill_Result		;AN000; 	buffer
 34297                                  					;AN000; to string
 34298 0000504A 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9
 34299                                  					;AC034; indicate syntax error
 34300                                  $P_Date_Format_Exit:			;AN000;
 34301 00005051 5A                      	pop	dx			;AN000;
 34302 00005052 59                      	pop	cx			;AN000;
 34303 00005053 58                      	pop	ax			;AN000;
 34304 00005054 C3                      	retn				;AN000;
 34305                                  
 34306                                  ;***********************************************************************
 34307                                  ; $P_Set_CDI:
 34308                                  ;
 34309                                  ; Function: Read CDI from DOS if it has not been read yet
 34310                                  ;
 34311                                  ; Input:    None
 34312                                  ;
 34313                                  ; Output:   psdata_seg:SI -> CDI
 34314                                  ;
 34315                                  ; Use:	INT 21h w/ AH = 38h
 34316                                  ;***********************************************************************
 34317                                  
 34318                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34319                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34320                                  $P_Set_CDI:
 34321                                  	; 18/04/2023
 34322 00005055 8D36[3F98]              	lea	si,$P_Country_Info	;AC034;
 34323                                  	;cmp	word [cs:si+$P_CDI.$P_CDI_DateF],-1 ; $P_NeedToBeRead
 34324 00005059 2E833CFF                	cmp	word [cs:si],-1 ; $P_NeedToBeRead ; 0FFFFh
 34325                                  					;AN000; already read ?
 34326                                  	;je	short $P_Read_CDI	;AN000;
 34327                                  	;jmp	short $P_Set_CDI_Exit	;AN000; then do nothing
 34328                                  	; 03/04/2023
 34329 0000505D 750F                    	jne	short $P_Set_CDI_Exit
 34330                                  $P_Read_CDI:				;AN000; else read CDI thru DOS
 34331 0000505F 1E                      	push	ds			;AN000;
 34332 00005060 52                      	push	dx			;AN000;
 34333 00005061 50                      	push	ax			;AN000;
 34334 00005062 0E                      	push	cs			;AC023;
 34335 00005063 1F                      	pop	ds			;AN000; set segment register
 34336                                  	;mov	ax,3800h
 34337 00005064 B80038                  	mov	ax,$P_DOS_Get_CDI	;AN000; get country information
 34338 00005067 89F2                    	mov	dx,si			;AN000; set offset of CDI in local data area
 34339 00005069 CD21                    	int	21h			;AN000;
 34340 0000506B 58                      	pop	ax			;AN000;
 34341 0000506C 5A                      	pop	dx			;AN000;
 34342 0000506D 1F                      	pop	ds			;AN000;
 34343                                  $P_Set_CDI_Exit:			;AN000;
 34344 0000506E C3                      	retn				;AN000;
 34345                                  
 34346                                  ;***********************************************************************
 34347                                  ; $P_Get_DecNum:
 34348                                  ;
 34349                                  ; Function:  Read a chcrater code from psdata_seg:SI until specified delimiter
 34350                                  ;	     or NULL encountered. And make a decimal number.
 34351                                  ;
 34352                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34353                                  ;
 34354                                  ; Output:    BL = delimiter code or NULL
 34355                                  ;	     AX = Decimal number
 34356                                  ;	     SI advanced to the next number
 34357                                  ;	     CY = 1 : Syntax error, AL = Latest examineed number
 34358                                  ;
 34359                                  ; Use:	$P_0099
 34360                                  ;***********************************************************************
 34361                                  
 34362                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34363                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34364                                  $P_Get_DecNum:
 34365 0000506F 51                      	push	cx			;AN000;
 34366 00005070 52                      	push	dx			;AN000;
 34367 00005071 31C9                    	xor	cx,cx			;AN000; cx will have final value
 34368                                  $P_GetNum_Loop: 			;AN000;
 34369 00005073 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 34370 00005076 08C0                    	or	al,al			;AN000; end of line ?
 34371 00005078 7438                    	jz	short $P_GetNum00	;AN000; if yes, exit
 34372 0000507A 2E803E[3E98]00          	cmp	byte [cs:$P_Got_Time],0 ;AC034; is this numeric in a time field? ;AC023
 34373 00005080 740B                    	je	short $P_Do_Date_Delims	;AN000; no, go check out Date delimiters ;AC023
 34374                                  
 34375                                  ; Determine which delimiter(s) to check for. Colon & period  or period only
 34376                                  	;cmp	bl,$P_colon_period
 34377 00005082 80FB01                  	cmp	bl,1 ; $P_colon_period	;AN032; ;Time
 34378 00005085 750E                    	jne	short $P_Do_Time_Delim1	;AN032; ;only check for period
 34379                                  
 34380 00005087 3C3A                    	cmp	al,$P_Colon ; ':'	;AN032; ;Is this a valid delimiter ?
 34381 00005089 742B                    	je	short $P_GetNum01	;AN032; ;yes, exit
 34382                                  
 34383                                  	; 03/04/2023
 34384 0000508B EB08                    	jmp	short $P_Do_Time_Delim1
 34385                                  ;$P_Do_Time_Delim1:			;AN000;
 34386                                  	;cmp	al,$P_Period ; '.'	;;AC032;;AC023;Is this a valid delimiter ?
 34387                                  	;je	short $P_GetNum01	;AC023; yes, exit
 34388                                  	;
 34389                                  	;jmp	short $P_Neither_Delims ;AN023;
 34390                                  
 34391                                  $P_Do_Date_Delims:			;AN000;
 34392                                  ;Regardless of the date delimiter character specified in the country
 34393                                  ;dependent information, check for the presence of any one of these
 34394                                  ;three field delimiters: "-", "/", or ".".
 34395 0000508D 3C2D                    	cmp	al,$P_Minus ;'-'	;AN020;is this a date delimiter character?
 34396 0000508F 7425                    	je	short $P_GetNum01	;AN020;if yes, exit
 34397                                  
 34398 00005091 3C2F                    	cmp	al,$P_Slash ; '/'	;AN020;is this a date delimiter character?
 34399 00005093 7421                    	je	short $P_GetNum01	;AN020;if yes, exit
 34400                                  
 34401                                  $P_Do_Time_Delim1:  ; 03/04/2023
 34402 00005095 3C2E                    	cmp	al,$P_Period ; '.'	;AN020;is this a date delimiter character?
 34403 00005097 741D                    	je	short $P_GetNum01	;AN000; if yes, exit
 34404                                  
 34405                                  $P_Neither_Delims:			;AN023;
 34406 00005099 E804FE                  	call	$P_0099 		;AN000; convert it to binary
 34407 0000509C 721C                    	jc	short $P_GetNum_Exit	;AN000; if error exit
 34408                                  
 34409 0000509E B400                    	mov	ah,0			;AN000;
 34410 000050A0 91                      	xchg	ax,cx			;AN000;
 34411 000050A1 BA0A00                  	mov	dx,10			;AN000;
 34412 000050A4 F7E2                    	mul	dx			;AN000; ax = ax * 10
 34413 000050A6 09D2                    	or	dx,dx			;AN000; overflow
 34414 000050A8 750F                    	jnz	short $P_GetNum02	;AN000; then exit
 34415                                  
 34416 000050AA 01C8                    	add	ax,cx			;AN000;
 34417 000050AC 720C                    	jc	short $P_GetNum_Exit	;AN000;
 34418                                  
 34419 000050AE 91                      	xchg	ax,cx			;AN000;
 34420 000050AF 46                      	inc	si			;AN000;
 34421 000050B0 EBC1                    	jmp	short $P_GetNum_Loop	;AN000;
 34422                                  
 34423                                  $P_GetNum00:				;AN000;
 34424 000050B2 88C3                    	mov	bl,al			;AN000; set bl to NULL
 34425                                  	;03/04/2023
 34426                                  	; cf=0
 34427                                  	;clc				;AN000; indicate no error
 34428 000050B4 EB04                    	jmp	short $P_GetNum_Exit	;AN000;
 34429                                  
 34430                                  $P_GetNum01:				;AN000;
 34431 000050B6 46                      	inc	si			;AN000; si points to next number
 34432                                  	;03/04/2023
 34433                                  	; cf=0
 34434                                  	;clc				;AN000; indicate no error
 34435 000050B7 EB01                    	jmp	short $P_GetNum_Exit	;AN000;
 34436                                  
 34437                                  $P_GetNum02:				;AN000;
 34438 000050B9 F9                      	stc				;AN000; indicate error
 34439                                  $P_GetNum_Exit: 			;AN000;
 34440 000050BA 89C8                    	mov	ax,cx			;AN000;return value
 34441 000050BC 5A                      	pop	dx			;AN000;
 34442 000050BD 59                      	pop	cx			;AN000;
 34443 000050BE C3                      	retn				;AN000;
 34444                                  
 34445                                  ;***********************************************************************
 34446                                  ; $P_Time_Format
 34447                                  ;
 34448                                  ; Function:  Convert a time string to DOS time format for int 21h
 34449                                  ;	     with format validation.
 34450                                  ;
 34451                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34452                                  ;	     ES:BX -> CONTROL block
 34453                                  ;
 34454                                  ; Output:    None
 34455                                  ;
 34456                                  ; Use:	$P_Fill_Result, $P_Set_CDI, $P_Get_DecNum, $P_Time_2412
 34457                                  ;
 34458                                  ; Vars: $P_RC(W), $P_Flags(R), $P_1st_Val(RW), $P_2nd_Val(RW)
 34459                                  ;	$P_3rd_Val(RW), $P_4th_Val(RW)
 34460                                  ;***********************************************************************
 34461                                  
 34462                                  	; 03/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34463                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34464                                  $P_Time_Format:				;AN000;
 34465 000050BF 50                      	push	ax			;AN000;
 34466 000050C0 51                      	push	cx			;AN000;
 34467 000050C1 52                      	push	dx			;AN000;
 34468 000050C2 56                      	push	si			;AN000;
 34469 000050C3 53                      	push	bx			;AN000;
 34470 000050C4 56                      	push	si			;AN000;
 34471 000050C5 E88DFF                  	call	$P_Set_CDI		;AN000; Set country independent
 34472                                  					; information before process
 34473                                  	;test	byte [cs:si+11h], 1
 34474 000050C8 2EF6441001              	test	byte [cs:si+$P_CDI.$P_CDI_TimeF],1 
 34475                                  					;AN000; 24 hour system
 34476 000050CD 5E                      	pop	si			;AN000;
 34477 000050CE 7503                    	jnz	short $P_TimeF00	;AN000; if no, means 12 hour system
 34478 000050D0 E8F800                  	call	$P_Time_2412		;AN000; this routine handle "am" "pm"
 34479                                  $P_TimeF00:				;AN000;
 34480                                  	;mov	word [cs:$P_1st_Val],0	;AC034; set initial value
 34481                                  	;mov	word [cs:$P_2nd_Val],0	;AC034; set initial value
 34482                                  	;mov	word [cs:$P_3rd_Val],0	;AC034; set initial value
 34483                                  	;mov	word [cs:$P_4th_Val],0	;AC034; set initial value
 34484                                  	;mov	byte [cs:$P_Got_Time],1	;AN023;AC034;; use time delimiter
 34485                                  	; 03/04/2023
 34486 000050D3 31DB                    	xor	bx,bx
 34487 000050D5 2E891E[6198]            	mov	[cs:$P_1st_Val],bx ; 0
 34488 000050DA 2E891E[6398]            	mov	[cs:$P_2nd_Val],bx ; 0
 34489 000050DF 2E891E[6598]            	mov	[cs:$P_3rd_Val],bx ; 0
 34490 000050E4 2E891E[6798]            	mov	[cs:$P_4th_Val],bx ; 0
 34491                                  	;inc	bl
 34492                                  	;mov	[cs:$P_Got_Time],bl ; 1
 34493                                  
 34494                                  	;mov	bl,$P_colon_period
 34495                                  	;mov	bl,1 ; $P_colon_period	;AN032; flag, indicates use of
 34496                                  					; delimiters between hours,
 34497                                  					;  minutes,seconds
 34498                                  	; 03/04/2023 - Retro DOS v4.0 COMMAND.COM
 34499 000050E9 FEC3                    	inc	bl ; bl = 1
 34500 000050EB 2E881E[3E98]            	mov	[cs:$P_Got_Time],bl ; 1
 34501                                  	;
 34502 000050F0 E87CFF                  	call	$P_Get_DecNum		;AN000; get 1st number
 34503 000050F3 725D                    	jc	short $P_TimeF_Err0	;AN000;
 34504 000050F5 2EA3[6198]              	mov	[cs:$P_1st_Val],ax	;AC034;
 34505 000050F9 08DB                    	or	bl,bl			;AN000; end of line ?
 34506 000050FB 745F                    	jz	short $P_TimeF_Rlt	;AN000;
 34507 000050FD E86FFF                  	call	$P_Get_DecNum		;AN000; get 2nd number
 34508 00005100 7250                    	jc	short $P_TimeF_Err0	;AC038; if OK
 34509 00005102 2EA3[6398]              	mov	[cs:$P_2nd_Val],ax	;AC034;
 34510 00005106 08DB                    	or	bl,bl			;AN000; end of line ?
 34511 00005108 7452                    	jz	short $P_TimeF_Rlt	;AN000;
 34512 0000510A B302                    	mov	bl,2 ; $P_period_only	;AN032; flag, which to decimal separator
 34513 0000510C E860FF                  	call	$P_Get_DecNum		;AN000; get 3rd number
 34514 0000510F 7241                    	jc	short $P_TimeF_Err0	;AC039; if problem, bridge to error
 34515 00005111 2EA3[6598]              	mov	[cs:$P_3rd_Val],ax	;AC034;
 34516 00005115 08DB                    	or	bl,bl			;AN000; end of line ?
 34517 00005117 7536                    	jnz	short $P_Time_4		;AN039; NOT END OF LINE,
 34518                                  					;AN039;   GO TO 4TH NUMBER
 34519                                  	;test	byte [cs:$P_Flags1],$P_Time_Again ; 2
 34520 00005119 2EF606[AE97]02          	test	byte [cs:$P_Flags1],2 	;AN039; HAS TIME PARSE
 34521                                  					;AN039;    BEEN REPEATED?
 34522 0000511F 753B                    	jnz	short $P_TimeF_Rlt	;AN039; yes, this is really
 34523                                  					;AN039;   the end of line
 34524                                  					;AN039; no, time has not been repeated
 34525 00005121 2E8B36[A597]            	mov	si,[cs:$P_SI_Save]	;AN039; get where parser quit
 34526                                  					;AN039;   in command line
 34527 00005126 807CFF2C                	cmp	byte [si-1],$P_Comma ; ','
 34528                                  					;AN039; look at delimiter
 34529                                  					;AN039;   from command line
 34530 0000512A 7530                    	jne	short $P_TimeF_Rlt	;AN039; was not a comma, this is
 34531                                  					;AN039;  really end of line
 34532                                  					;AN039; is comma before hundredths,
 34533                                  					;AN039;   redo TIME
 34534 0000512C C644FF2E                	mov	byte [si-1],$P_Period ; '.' 
 34535                                  					;AN039; change that ambiguous
 34536                                  					;AN039;    comma to a decimal point
 34537                                  					;AN039;     parse can understand
 34538 00005130 2EC706[AE97]0000        	mov	word [cs:$P_Flags],0	;AN039; Clear all internal flags
 34539                                  	;or	byte [cs:$P_Flags1],$P_Time_Again
 34540 00005137 2E800E[AE97]02          	or	byte [cs:$P_Flags1],2	;AN039; indicate TIME
 34541                                  					;AN039; is being repeated
 34542 0000513D 2E8B0E[3898]            	mov	cx,[cs:$P_ORIG_ORD]	;AN039; ORIGINAL ORDINAL FROM CX
 34543 00005142 2E8B26[3A98]            	mov	sp,[cs:$P_ORIG_STACK]	;AN039; ORIGINAL VALUE
 34544                                  					;AN039;   OF STACK FROM SP
 34545 00005147 2E8B36[3C98]            	mov	si,[cs:$P_ORIG_SI]	;AN039; ORIGINAL START
 34546                                  					;AN039;   PARSE POINTER FROM SI
 34547 0000514C E913F8                  	jmp	$P_Redo_Time		;AN039; go try TIME again
 34548                                  $P_Time_4:				;AN039; READY FOR 4TH (HUNDREDTHS) NUMBER
 34549 0000514F E81DFF                  	call	$P_Get_DecNum		;AN000; get 4th number
 34550                                  $P_TimeF_Err0:				;AN000; Bridge
 34551 00005152 725E                    	jc	short $P_TimeF_Error	;AN000;
 34552                                  	;
 34553 00005154 2EA3[6798]              	mov	[cs:$P_4th_Val],ax	;AC034;
 34554 00005158 08DB                    	or	bl,bl			;AN000; After hundredth, no data allowed
 34555 0000515A 7556                    	jnz	short $P_TimeF_Error	;AN000; if some, then error
 34556                                  $P_TimeF_Rlt:				;AN000;
 34557 0000515C 2EA1[6198]              	mov	ax,[cs:$P_1st_Val]	;AC034;
 34558 00005160 08E4                    	or	ah,ah			;AN000; if overflow then error
 34559 00005162 754E                    	jnz	short $P_TimeF_Err	;AN000;
 34560                                  	;test	byte [cs:$P_Flags1],$P_Time12am ; 1
 34561 00005164 2EF606[AE97]01          	test	byte [cs:$P_Flags1],1	;AN038;if "am" specified
 34562 0000516A 7408                    	jz	short $P_Time_notAM	;AN038;skip if no "AM" specified
 34563                                  					;since "AM" was specified,
 34564 0000516C 3C0C                    	cmp	al,12			;AN038: if hour specified as later than noon
 34565 0000516E 7742                    	ja	short $P_TimeF_Err	;AN038; error if "AM" on more than noon
 34566 00005170 7502                    	jne	short $P_Time_notAM	;AN038; for noon exactly,
 34567 00005172 30C0                    	xor	al,al			;AN038; set hour = zero
 34568                                  $P_Time_notAM:				;AN038;
 34569                                  	;test	byte [cs:$P_Flags2],$P_Time12
 34570 00005174 2EF606[AF97]04          	test	byte [cs:$P_Flags2],4	;AC034; if 12 hour system and pm is specified
 34571 0000517A 740C                    	jz	short $P_TimeSkip00	;AN000; then
 34572 0000517C 3C0C                    	cmp	al,12			;AN038; if 12:00 o'clock already
 34573 0000517E 7408                    	je	short $P_TimeSkip00	;AN038; it is PM already
 34574 00005180 040C                    	add	al,12			;AN000; add 12 hours to make it afternoon
 34575 00005182 722E                    	jc	short $P_TimeF_Err	;AN000; if overflow then error
 34576 00005184 3C18                    	cmp	al,24			;AN038; after adding 12, now cannot be >24
 34577 00005186 772A                    	ja	short $P_TimeF_Err	;AN038; if too big, error
 34578                                  $P_TimeSkip00:				;AN000;
 34579 00005188 88C2                    	mov	dl,al			;AN000; set hour
 34580 0000518A 2EA1[6398]              	mov	ax,[cs:$P_2nd_Val]	;AC034;
 34581 0000518E 08E4                    	or	ah,ah			;AN000; if overflow then error
 34582 00005190 7520                    	jnz	short $P_TimeF_Err	;AN000;
 34583 00005192 88C6                    	mov	dh,al			;AN000; set minute
 34584 00005194 2EA1[6598]              	mov	ax,[cs:$P_3rd_Val]	;AC034;
 34585 00005198 08E4                    	or	ah,ah			;AN000; if overflow then error
 34586 0000519A 7516                    	jnz	short $P_TimeF_Err	;AN000;
 34587 0000519C 88C1                    	mov	cl,al			;AN000; set second
 34588 0000519E 2EA1[6798]              	mov	ax,[cs:$P_4th_Val]	;AC034;
 34589 000051A2 08E4                    	or	ah,ah			;AN000; if overflow then error
 34590 000051A4 750C                    	jnz	short $P_TimeF_Err	;AN000;
 34591 000051A6 88C5                    	mov	ch,al			;AN000; set hundredth
 34592 000051A8 5B                      	pop	bx			;AN000; recover CONTROL block
 34593 000051A9 5E                      	pop	si			;AN000; recover string pointer
 34594                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34595                                  	;mov	al,$P_Time_F ; 8 	;AN000;   result
 34596                                  	; 03/04/2023
 34597 000051AA B808FF                  	mov	ax,($P_No_Tag<<8)+$P_Time_F
 34598 000051AD E8E2F9                  	call	$P_Fill_Result		;AN000;        buffer
 34599 000051B0 EB0F                    	jmp	short $P_Time_Format_Exit
 34600                                  					;AN000; to time
 34601                                  $P_TimeF_Error: 			;AN000;
 34602                                  $P_TimeF_Err:				;AN000;
 34603 000051B2 5B                      	pop	bx			;AN000; recover CONTROL block
 34604 000051B3 5E                      	pop	si			;AN000; recover string pointer
 34605                                  	;mov	ah,$P_No_Tag		;AN000; set
 34606                                  	;mov	al,$P_String		;AN000;     result
 34607                                  	; 03/04/2023
 34608 000051B4 B803FF                  	mov	ax,($P_No_Tag<<8)+$P_String
 34609 000051B7 E8D8F9                  	call	$P_Fill_Result		;AN000; 	  buffer
 34610                                  					;AN000; to string
 34611 000051BA 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax ; 9	
 34612                                  					;AC034; return syntax error
 34613                                  $P_Time_Format_Exit:			;AN000;
 34614 000051C1 2EC606[3E98]00          	mov	byte [cs:$P_Got_Time],0	;AN023;AC034; finished with this time field
 34615 000051C7 5A                      	pop	dx			;AN000;
 34616 000051C8 59                      	pop	cx			;AN000;
 34617 000051C9 58                      	pop	ax			;AN000;
 34618 000051CA C3                      	retn
 34619                                  
 34620                                  ;***********************************************************************
 34621                                  ; $P_Time_2412:
 34622                                  ;
 34623                                  ; Function:  Remove "a", "p", "am", or "pm" from the end of stinrg
 34624                                  ;
 34625                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34626                                  ;
 34627                                  ; Output:    Set $P_Time12 flag when the string is terminated by "p"
 34628                                  ;	     or "pm"
 34629                                  ;
 34630                                  ; Vars:  $P_Flags(W)
 34631                                  ;***********************************************************************
 34632                                  
 34633                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34634                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34635                                  $P_Time_2412:				;AN000;
 34636 000051CB 50                      	push	ax			;AN000;
 34637 000051CC 56                      	push	si			;AN000;
 34638                                  $P_T12_Loop:				;AN000;
 34639 000051CD 2E8A04                  	mov	al,[cs:si]		;AN000; Move
 34640 000051D0 46                      	inc	si			;AN000;     si
 34641 000051D1 08C0                    	or	al,al			;AN000;       to
 34642 000051D3 75F8                    	jnz	short $P_T12_Loop	;AN000; 	end of string
 34643                                  
 34644 000051D5 2E8A44FE                	mov	al,[cs:si-2]		;AN000; get char just before NULL
 34645                                  	;or	al,20h
 34646 000051D9 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case map
 34647 000051DB 3C70                    	cmp	al,"p"                  ;AN000; only "p" of "pm" ?
 34648 000051DD 7425                    	je	short $P_T1200		;AN000;
 34649                                  
 34650 000051DF 3C61                    	cmp	al,"a"                  ;AN000; only "a" of "am" ?
 34651 000051E1 7413                    	je	short $P_T1201		;AN000;
 34652                                  
 34653 000051E3 3C6D                    	cmp	al,"m"                  ;AN000; "m" of "am" or "pm"
 34654 000051E5 751A                    	jne	short $P_T12_Exit	;AN000;
 34655                                  
 34656 000051E7 4E                      	dec	si			;AN000;
 34657 000051E8 2E8A44FE                	mov	al,[cs:si-2]		;AN000;
 34658                                  	;or	al,20h
 34659 000051EC 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case map
 34660 000051EE 3C70                    	cmp	al,"p"                  ;AN000; "p" of "pm" ?
 34661 000051F0 7412                    	je	short $P_T1200		;AN000;
 34662                                  
 34663 000051F2 3C61                    	cmp	al,"a"                  ;AN000; "a" of "am" ?
 34664                                  	;je	short $P_T1201		;AN000; go process "a"
 34665                                  	;jmp	short $P_T12_Exit	;AN000; no special chars found
 34666                                  	; 05/04/2023
 34667 000051F4 750B                    	jne	short $P_T12_Exit
 34668                                  
 34669                                  ;$P_T1200:				;AN000; "P" found
 34670                                  	;;or	byte [cs:$P_Flags2],$P_Time12
 34671                                  	;or	byte [cs:$P_Flags2],4	;AC034; flag "PM" found
 34672                                  	;jmp	short $P_Tclr_chr	;AN038; go clear the special char
 34673                                  
 34674                                  $P_T1201:				;AN000; "A" found
 34675                                  	;or	byte [cs:$P_Flags1],$P_Time12AM
 34676 000051F6 2E800E[AE97]01          	or	byte [cs:$P_Flags1],1	;AN038; flag "AM" found
 34677                                  $P_Tclr_chr:				;AN038;
 34678 000051FC 2EC644FE00              	mov	byte [cs:si-2],$P_NULL	;AN000; null out special char
 34679                                  $P_T12_Exit:				;AN000;
 34680 00005201 5E                      	pop	si			;AN000;
 34681 00005202 58                      	pop	ax			;AN000;
 34682 00005203 C3                      	retn				;AN000;
 34683                                  
 34684                                  	; 05/04/2023
 34685                                  $P_T1200:				;AN000; "P" found
 34686                                  	;or	byte [cs:$P_Flags2],$P_Time12
 34687 00005204 2E800E[AF97]04          	or	byte [cs:$P_Flags2],4	;AC034; flag "PM" found
 34688 0000520A EBF0                    	jmp	short $P_Tclr_chr	;AN038; go clear the special char
 34689                                  
 34690                                  ;***********************************************************************
 34691                                  ; $P_File_Format;
 34692                                  ;
 34693                                  ; Function:  Check if the input string is valid file spec format.
 34694                                  ;	     And set the result buffer.
 34695                                  ;
 34696                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34697                                  ;	     ES:BX -> CONTROL block
 34698                                  ;
 34699                                  ; Output:    None
 34700                                  ;
 34701                                  ; Use:	$P_Fill_Result, $P_Chk_DBCS, $P_FileSp_Chk
 34702                                  ;
 34703                                  ; Vars: $P_RC(W), $P_SI_Save(W), $P_Terminator(W), $P_SaveSI_Cmpx(R)
 34704                                  ;	$P_SaveSI_Cmpx(R)
 34705                                  ;***********************************************************************
 34706                                  
 34707                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34708                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4DF0h
 34709                                  
 34710                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34711                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:55B4h
 34712                                  $P_File_Format:
 34713 0000520C 50                      	push	ax			;AN000;
 34714 0000520D 57                      	push	di			;AN000;
 34715 0000520E 56                      	push	si			;AN000;
 34716 0000520F 2E8B3E[B097]            	mov	di,[cs:$P_SaveSI_Cmpx]	;AC034; get user buffer address
 34717 00005214 2E8A04                  	mov	al,[cs:si]		;AN000; load character
 34718 00005217 08C0                    	or	al,al			;AN000; end of line ?
 34719 00005219 7413                    	je	short $P_FileF_Err	;AN000; if yes, error exit
 34720 0000521B E85D00                  	call	$P_FileSp_Chk		;AN000; else, check if file special character
 34721 0000521E 7523                    	jne	short $P_FileF03	;AN000; if yes,
 34722 00005220 2EC606[7C98]01          	mov	byte [cs:$P_err_flag],$P_error_filespec ; 1
 34723                                  					;AN033;AC034;; set error flag- bad char.
 34724 00005226 5E                      	pop	si			;AN033;
 34725 00005227 2EC60400                	mov	byte [cs:si],$P_NULL	;AN033;
 34726 0000522B 5F                      	pop	di			;AN033;
 34727 0000522C EB3E                    	jmp	short $P_FileF02	;AN033;
 34728                                  $P_FileF_Err:				;AN000;
 34729 0000522E 5E                      	pop	si			;AN000;
 34730 0000522F 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000;
 34731 00005233 5F                      	pop	di			;AN000;
 34732                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Optional
 34733                                  	;test	word [es:bx],1		;AN000; is it optional ?
 34734 00005234 26F60701                	test	byte [es:bx],$P_Optional ; 1
 34735 00005238 7532                    	jnz	short $P_FileF02	;AN000;
 34736 0000523A 2EC706[A397]0200        	mov	word [cs:$P_RC],$P_Op_Missing
 34737                                  	;mov	word [cs:$P_RC],2	;AC034; 3/17/87
 34738 00005241 EB29                    	jmp	short $P_FileF02	;AN000;
 34739                                  $P_FileF03:				;AN000;
 34740 00005243 58                      	pop	ax			;AN000; discard save si
 34741 00005244 56                      	push	si			;AN000; save new si
 34742                                  $P_FileF_Loop1: 			;AN000;
 34743 00005245 2E8A04                  	mov	al,[cs:si]		;AN000; load character (not special char)
 34744 00005248 08C0                    	or	al,al			;AN000; end of line ?
 34745 0000524A 741E                    	jz	short $P_FileF_RLT	;AN000;
 34746 0000524C E82C00                  	call	$P_FileSp_Chk		;AN000; File special character ?
 34747 0000524F 740B                    	jz	short $P_FileF00	;AN000;
 34748 00005251 E85E01                  	call	$P_Chk_DBCS		;AN000; no, then DBCS ?
 34749 00005254 7302                    	jnc	short $P_FileF01	;AN000;
 34750 00005256 47                      	inc	di			;AN000; if yes, skip next byte
 34751 00005257 46                      	inc	si			;AN000;
 34752                                  $P_FileF01:				;AN000;
 34753 00005258 47                      	inc	di			;AN000;
 34754 00005259 46                      	inc	si			;AN000;
 34755 0000525A EBE9                    	jmp	short $P_FileF_Loop1	;AN000;
 34756                                  $P_FileF00:				;AN000;
 34757 0000525C 2EA2[A997]              	mov	[cs:$P_Terminator],al	;AC034;
 34758 00005260 2EC60400                	mov	byte [cs:si],$P_NULL	;AN000; update end of string
 34759 00005264 47                      	inc	di			;AN000;
 34760 00005265 2E893E[A597]            	mov	[cs:$P_SI_Save],di	;AC034; update next pointer in command line
 34761                                  $P_FileF_RLT:				;AN000;
 34762 0000526A 5E                      	pop	si			;AN000;
 34763 0000526B 5F                      	pop	di			;AN000;
 34764                                  $P_FileF02:				;AN000;
 34765 0000526C 58                      	pop	ax			;AN000; (tm14)
 34766                                  	;;test	ax,200h
 34767                                  	;test	ax,$P_File_Spc		;AN000; (tm14)
 34768                                  	; 05/04/2023
 34769 0000526D F6C402                  	test	ah,($P_File_Spc>>8)
 34770 00005270 7408                    	jz	short $P_Drv_Only_Exit	;AN000; (tm14)
 34771 00005272 50                      	push	ax			;AN000; (tm14)
 34772                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000; set
 34773                                  	;mov	al,$P_File_Spec ; 5 	;AN000;    result
 34774                                  	; 05/04/2023
 34775 00005273 B805FF                  	mov	ax,($P_No_Tag<<8)+$P_File_Spec
 34776 00005276 E819F9                  	call	$P_Fill_Result		;AN000; 	buffer to file spec
 34777 00005279 58                      	pop	ax			;AN000;
 34778                                  $P_Drv_Only_Exit:			;AN000; (tm14)
 34779 0000527A C3                      	retn				;AN000;
 34780                                  
 34781                                  ;***********************************************************************
 34782                                  ; $P_FileSp_Chk
 34783                                  ;
 34784                                  ; Function:  Check if the input byte is one of file special characters
 34785                                  ;
 34786                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34787                                  ;	     AL = character code to be examineed
 34788                                  ;
 34789                                  ; Output:    ZF = 1 , AL is one of special characters
 34790                                  ;***********************************************************************
 34791                                  
 34792                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34793                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34794                                  $P_FileSp_Chk:
 34795 0000527B 53                      	push	bx			;AN000;
 34796 0000527C 51                      	push	cx			;AN000;
 34797                                  	;lea	bx,[cs:$P_FileSp_Char]	;AC034; special character table
 34798 0000527D 8D1E[7398]              	lea	bx,$P_FileSp_Char ; "[]|<>+=;\""
 34799 00005281 B90900                  	mov	cx,$P_FileSp_Len ; 9
 34800                                  	;mov	cx,9			;AN000; load length of it
 34801                                  $P_FileSp_Loop: 			;AN000;
 34802 00005284 2E3A07                  	cmp	al,[cs:bx]		;AN000; is it one of special character ?
 34803 00005287 7404                    	je	short $P_FileSp_Exit	;AN000;
 34804 00005289 43                      	inc	bx			;AN000;
 34805 0000528A E2F8                    	loop	$P_FileSp_Loop		;AN000;
 34806 0000528C 41                      	inc	cx			;AN000; reset ZF
 34807                                  $P_FileSp_Exit: 			;AN000;
 34808 0000528D 59                      	pop	cx			;AN000;
 34809 0000528E 5B                      	pop	bx			;AN000;
 34810 0000528F C3                      	retn				;AN000;
 34811                                  
 34812                                  ;***********************************************************************
 34813                                  ; $P_Drive_Format;
 34814                                  ;
 34815                                  ; Function:  Check if the input string is valid drive only format.
 34816                                  ;	     And set the result buffer.
 34817                                  ;
 34818                                  ; Input:     psdata_seg:SI -> $P_STRING_BUF
 34819                                  ;	     ES:BX -> CONTROL block
 34820                                  ;
 34821                                  ; Output:    None
 34822                                  ;
 34823                                  ; Use:	$P_Fill_Result, $P_Chk_DBCS
 34824                                  ;
 34825                                  ; Vars: $P_RC(W)
 34826                                  ;***********************************************************************
 34827                                  
 34828                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34829                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34830                                  $P_Drive_Format:
 34831 00005290 50                      	push	ax			;AN000;
 34832 00005291 52                      	push	dx			;AN000;
 34833 00005292 2E8A04                  	mov	al,[cs:si]		;AN000;
 34834 00005295 08C0                    	or	al,al			;AN000; if null string
 34835 00005297 7436                    	jz	short $P_Drv_Exit	;AN000; do nothing
 34836 00005299 E81601                  	call	$P_Chk_DBCS		;AN000; is it leading byte ?
 34837 0000529C 722A                    	jc	short $P_Drv_Err	;AN000;
 34838                                  	;cmp	word [cs:si+1],3Ah ; $P_Colon  ; ':'
 34839 0000529E 2E837C013A              	cmp	word [cs:si+1],$P_Colon ;AN000; "d", ":", 0  ?
 34840 000052A3 740D                    	je	short $P_DrvF00		;AN000;
 34841                                  	;test	word [es:bx+$P_CONTROL_BLK.$P_Match_Flag],$P_Ig_Colon
 34842                                  	;test	word [es:bx],10h	;AN000; colon can be ignored?
 34843 000052A5 26F60710                	test	byte [es:bx],$P_Ig_Colon ; 10h
 34844 000052A9 741D                    	jz	short $P_Drv_Err	;AN000;
 34845 000052AB 2E807C0100              	cmp	byte [cs:si+1],$P_NULL	;AN000; "d", 0  ?
 34846 000052B0 7516                    	jne	short $P_Drv_Err	;AN000;
 34847                                  $P_DrvF00:				;AN000;
 34848 000052B2 0C20                    	or	al,$P_Make_Lower ; 20h	;AN000; lower case
 34849 000052B4 3C61                    	cmp	al,"a" ; 61h            ;AN000; drive letter must
 34850 000052B6 7210                    	jb	short $P_Drv_Err	;AN000; in range of
 34851 000052B8 3C7A                    	cmp	al,"z" ; 7Ah            ;AN000; "a" - "z"
 34852 000052BA 770C                    	ja	short $P_Drv_Err	;AN000; if no, error
 34853 000052BC 2C60                    	sub	al,"a"-1  ; 60h         ;AN000; make text drive to binary drive
 34854 000052BE 88C2                    	mov	dl,al			;AN000; set
 34855                                  	;mov	ah,$P_No_Tag ; 0FFh	;AN000;    result
 34856                                  	;mov	al,$P_Drive ; 6		;AN000; 	 buffer
 34857                                  	; 05/04/2023
 34858 000052C0 B806FF                  	mov	ax,($P_No_Tag<<8)+$P_Drive ; 06FFh
 34859 000052C3 E8CCF8                  	call	$P_Fill_Result		;AN000; 	       to drive
 34860 000052C6 EB07                    	jmp	short $P_Drv_Exit	;AN000;
 34861                                  $P_Drv_Err:				;AN000;
 34862 000052C8 2EC706[A397]0900        	mov	word [cs:$P_RC],$P_Syntax
 34863                                  	;mov	word [cs:$P_RC],9	;AC034;
 34864                                  $P_Drv_Exit:				;AN000;
 34865 000052CF 5A                      	pop	dx			;AN000;
 34866 000052D0 58                      	pop	ax			;AN000;
 34867 000052D1 C3                      	retn				;AN000;
 34868                                  
 34869                                  ;***********************************************************************
 34870                                  ; $P_Skip_Delim;
 34871                                  ;
 34872                                  ; Function: Skip delimiters specified in the PARMS list, white space
 34873                                  ;	    and comma.
 34874                                  ;
 34875                                  ; Input:    DS:SI -> Command String
 34876                                  ;	    ES:DI -> Parameter List
 34877                                  ;
 34878                                  ; Output:   CY = 1 if the end of line encounterd
 34879                                  ;	    CY = 0 then SI move to 1st non-delimiter character
 34880                                  ;	    AL = Last examineed character
 34881                                  ;
 34882                                  ; Use:	    $P_Chk_EOL, $P_Chk_Delim,
 34883                                  ;
 34884                                  ; Vars:     $P_Flags(R)
 34885                                  ;***********************************************************************
 34886                                  
 34887                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34888                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34889                                  $P_Skip_Delim:				;AN000;
 34890                                  $P_Skip_Delim_Loop:			;AN000;
 34891 000052D2 AC                      	lodsb				;AN000;
 34892 000052D3 E81E00                  	call	$P_Chk_EOL		;AN000; is it EOL character ?
 34893 000052D6 7416                    	je	short $P_Skip_Delim_CY	;AN000; if yes, exit w/ CY on
 34894                                  
 34895 000052D8 E84B00                  	call	$P_Chk_Delim		;AN000; is it one of delimiters ?
 34896 000052DB 7514                    	jne	short $P_Skip_Delim_NCY	;AN000; if no, exit w/ CY off
 34897                                  
 34898 000052DD 2EF606[AF97]20          	test	byte [cs:$P_Flags2],$P_Extra
 34899                                  	;test	byte [cs:$P_Flags2],20h ;AC034; extra delim or comma found ?
 34900 000052E3 74ED                    	jz	short $P_Skip_Delim_Loop
 34901                                  					;AN000; if no, loop
 34902 000052E5 2EF606[AF97]41          	test	byte [cs:$P_Flags2],$P_SW+$P_equ
 34903                                  	;;test	byte [cs:$P_Flags2],41h	;AC034; /x , or xxx=zzz , (tm08)
 34904                                  	;jz	short $P_Exit_At_Extra	;AN000; no switch, no keyword (tm08)
 34905                                  	;dec	si ; *			;AN000; backup si for next call (tm08)
 34906                                  	;;jmp	short $P_Exit_At_Extra	;AN000; else exit w/ CY off
 34907                                  	; 05/04/2023
 34908 000052EB 7505                    	jnz	short $P_Skip_Delim_Exit ; cf = 0
 34909                                  $P_Exit_At_Extra:			;AN000;
 34910                                  	; cf = 0
 34911                                  	;clc				;AN000; indicate extra delim
 34912 000052ED C3                      	retn				;AN000;
 34913                                  
 34914                                  $P_Skip_Delim_CY:			;AN000;
 34915 000052EE F9                      	stc				;AN000; indicate EOL
 34916 000052EF EB01                    	jmp	short $P_Skip_Delim_Exit
 34917                                  					;AN000;
 34918                                  $P_Skip_Delim_NCY:			;AN000;
 34919 000052F1 F8                      	clc				;AN000; indicate non delim
 34920                                  $P_Skip_Delim_Exit:			;AN000; in this case, need
 34921 000052F2 4E                      	dec	si ; *			;AN000;  backup index pointer
 34922 000052F3 C3                      	retn				;AN000;
 34923                                  	; 05/04/2023
 34924                                  ;$P_Exit_At_Extra:			;AN000;
 34925                                  	;clc				;AN000; indicate extra delim
 34926                                  	;retn				;AN000;
 34927                                  
 34928                                  ;***********************************************************************
 34929                                  ; $P_Chk_EOL;
 34930                                  ;
 34931                                  ; Function: Check if AL is one of End of Line characters.
 34932                                  ;
 34933                                  ; Input:    AL = character code
 34934                                  ;	    ES:DI -> Parameter List
 34935                                  ;
 34936                                  ; Output:   ZF = 1 if one of End of Line characters
 34937                                  ;***********************************************************************
 34938                                  
 34939                                  	; 05/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34940                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34941                                  $P_Chk_EOL:
 34942 000052F4 53                      	push	bx			;AN000;
 34943 000052F5 51                      	push	cx			;AN000;
 34944 000052F6 3C0D                    	cmp	al,$P_CR ; 0Dh		;AN000; Carriage return ?
 34945 000052F8 7429                    	je	short $P_Chk_EOL_Exit 	;AN000;
 34946 000052FA 3C00                    	cmp	al,$P_NULL ; 0		;AN000; zero ?
 34947 000052FC 7425                    	je	short $P_Chk_EOL_Exit 	;AN000;
 34948 000052FE 26807D0202              	cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],$P_I_Have_EOL
 34949                                  	;cmp	byte [es:di+2],2	;AN000; EOL character specified ?
 34950 00005303 721E                    	jb	short $P_Chk_EOL_Exit 	;AN000;
 34951 00005305 31DB                    	xor	bx,bx			;AN000;
 34952 00005307 268A5D03                	mov	bl,[es:di+$P_PARMS_BLK.$P_Len_Extra_Delim]
 34953                                  	;mov	bl,[es:di+3]		;AN000; get length of delimiter list
 34954 0000530B 83C304                  	add	bx,$P_Len_PARMS; 4 	;AN000; skip it
 34955 0000530E 26803900                	cmp	byte [es:bx+di],$P_I_Use_Default
 34956                                  	;cmp	byte [es:bx+di],0	;AN000; No extra EOL character ?
 34957 00005312 740D                    	je	short $P_Chk_EOL_NZ	;AN000;
 34958 00005314 31C9                    	xor	cx,cx			;AN000; Get number of extra chcracter
 34959 00005316 268A09                  	mov	cl,[es:bx+di]		;AN000;
 34960                                  $P_Chk_EOL_Loop:			;AN000;
 34961 00005319 43                      	inc	bx			;AN000;
 34962 0000531A 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra EOL character
 34963 0000531D 7404                    	je	short $P_Chk_EOL_Exit 	;AN000;
 34964 0000531F E2F8                    	loop	$P_Chk_EOL_Loop 	;AN000;
 34965                                  $P_Chk_EOL_NZ:				;AN000;
 34966 00005321 3C0D                    	cmp	al,$P_CR ; 0Dh		;AN000; reset ZF
 34967                                  $P_Chk_EOL_Exit:			;AN000;
 34968 00005323 59                      	pop	cx			;AN000;
 34969 00005324 5B                      	pop	bx			;AN000;
 34970 00005325 C3                      	retn				;AN000;
 34971                                  
 34972                                  ;***********************************************************************
 34973                                  ; $P_Chk_Delim;
 34974                                  ;
 34975                                  ; Function: Check if AL is one of delimiter characters.
 34976                                  ;	    if AL+[si] is DBCS blank, it is replaced with two SBCS
 34977                                  ;	    blanks.
 34978                                  ;
 34979                                  ; Input:    AL = character code
 34980                                  ;	    DS:SI -> Next Character
 34981                                  ;	    ES:DI -> Parameter List
 34982                                  ;
 34983                                  ; Output:   ZF = 1 if one of delimiter characters
 34984                                  ;	    SI points to the next character
 34985                                  ; Vars:  $P_Terminator(W), $P_Flags(W)
 34986                                  ;***********************************************************************
 34987                                  
 34988                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 34989                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 34990                                  $P_Chk_Delim:
 34991 00005326 53                      	push	bx			;AN000;
 34992 00005327 51                      	push	cx			;AN000;
 34993 00005328 2EC606[A997]20          	mov	byte [cs:$P_Terminator],$P_Space ; 20h
 34994                                  					;AC034; Assume terminated by space
 34995 0000532E 2E8026[AF97]DF          	and	byte [cs:$P_Flags2],0FFh-$P_Extra ; 0DFh
 34996                                  					;AC034;
 34997 00005334 3C20                    	cmp	al,$P_Space ; 20h ; ' '	;AN000; Space ?
 34998 00005336 7436                    	je	short $P_Chk_Delim_Exit	;AN000;
 34999                                  
 35000 00005338 3C09                    	cmp	al,$P_TAB ; 09h		;AN000; TAB ?
 35001 0000533A 7432                    	je	short $P_Chk_Delim_Exit	;AN000;
 35002                                  
 35003 0000533C 3C2C                    	cmp	al,$P_Comma  ; ',' 	;AN000; Comma ?
 35004 0000533E 7431                    	je	short $P_Chk_Delim_Exit0
 35005                                  					;AN000;
 35006                                  $P_Chk_Delim00: 			;AN000;
 35007 00005340 3C20                    	cmp	al,20h ; $P_DBSP1	;AN000; 1st byte of DBCS Space ?
 35008 00005342 750C                    	jne	short $P_Chk_Delim01	;AN000;
 35009 00005344 803C20                  	cmp	byte [si],20h ; $P_DBSP2
 35010                                  					;AN000; 2nd byte of DBCS Space ?
 35011 00005347 7507                    	jne	short $P_Chk_Delim01	;AN000;
 35012 00005349 B020                    	mov	al,$P_Space ; 20h	;AN000;
 35013 0000534B 46                      	inc	si			;AN000; make si point to next character
 35014 0000534C 38C0                    	cmp	al,al			;AN000; Set ZF
 35015 0000534E EB1E                    	jmp	short $P_Chk_Delim_Exit ;AN000;
 35016                                  
 35017                                  $P_Chk_Delim01: 			;AN000;
 35018                                  	;cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],$P_I_Have_Delim
 35019 00005350 26807D0201              	cmp	byte [es:di+$P_PARMS_BLK.$P_Num_Extra],1
 35020                                  	;cmp	byte [es:di+2],1	;AN000; delimiter character specified ?
 35021 00005355 7217                    	jb	short $P_Chk_Delim_Exit	;AN000;
 35022                                  
 35023 00005357 31C9                    	xor	cx,cx			;AN000;
 35024 00005359 268A4D03                	mov	cl,[es:di+$P_PARMS_BLK.$P_Len_Extra_Delim]
 35025                                  	;mov	cl,[esi:di+3]		;AN000; get length of delimiter list
 35026 0000535D 09C9                    	or	cx,cx			;AN000; No extra Delim character ?
 35027 0000535F 740B                    	jz	short $P_Chk_Delim_NZ	;AN000;
 35028                                  
 35029 00005361 BB0300                  	mov	bx,$P_Len_PARMS-1 ; 3	;AN000; set bx to 1st extra delimiter
 35030                                  $P_Chk_Delim_Loop:			;AN000;
 35031 00005364 43                      	inc	bx			;AN000;
 35032 00005365 263A01                  	cmp	al,[es:bx+di]		;AN000; Check extra Delim character
 35033 00005368 7407                    	je	short $P_Chk_Delim_Exit0
 35034                                  					;AN000;
 35035 0000536A E2F8                    	loop	$P_Chk_Delim_Loop	;AN000; examine all extra delimiter
 35036                                  
 35037                                  $P_Chk_Delim_NZ:			;AN000;
 35038 0000536C 3C20                    	cmp	al,$P_Space ; 20h	;AN000; reset ZF
 35039                                  $P_Chk_Delim_Exit:			;AN000;
 35040 0000536E 59                      	pop	cx			;AN000;
 35041 0000536F 5B                      	pop	bx			;AN000;
 35042 00005370 C3                      	retn				;AN000;
 35043                                  
 35044                                  $P_Chk_Delim_Exit0:			;AN000;
 35045 00005371 2EA2[A997]              	mov	[cs:$P_Terminator],al	;AC034; keep terminated delimiter
 35046 00005375 2EF606[AF97]01          	test	byte [cs:$P_Flags2],$P_equ
 35047                                  	;test	byte [cs:$P_Flags2],1	;AN027;AC034;; if terminating a key=
 35048 0000537B 7506                    	jnz	short $P_No_Set_Extra 	;AN027; then do not set the EXTRA bit
 35049                                  
 35050 0000537D 2E800E[AF97]20          	or	byte [cs:$P_Flags2],$P_Extra ; 20h
 35051                                  	;or	byte [cs:$P_Flags2],20h	;AC034; flag terminated extra delimiter or comma
 35052                                  $P_No_Set_Extra:			;AN027;
 35053 00005383 38C0                    	cmp	al,al			;AN000; set ZF
 35054 00005385 EBE7                    	jmp	short $P_Chk_Delim_Exit ;AN000;
 35055                                  
 35056                                  ;***********************************************************************
 35057                                  ; $P_Chk_Switch;
 35058                                  ;
 35059                                  ; Function: Check if AL is the switch character not in first position of
 35060                                  ;	    $P_STRING_BUF
 35061                                  ;
 35062                                  ; Input:    AL = character code
 35063                                  ;	    BX = current pointer within $P_String_Buf
 35064                                  ;	    SI =>next char on command line (following the one in AL)
 35065                                  ;
 35066                                  ; Output:   CF = 1 (set)if AL is switch character, and not in first
 35067                                  ;		 position, and has no chance of being part of a date string,
 35068                                  ;		 i.e. should be treated as a delimiter.
 35069                                  ;
 35070                                  ;	    CF = 0 (reset, cleared) if AL is not a switch char, is in the first
 35071                                  ;		 position, or is a slash but may be part of a date string, i.e.
 35072                                  ;		 should not be treated as a delimiter.
 35073                                  ;
 35074                                  ; Vars:  $P_Terminator(W)
 35075                                  ;
 35076                                  ; Use:	 $P_0099
 35077                                  ;***********************************************************************
 35078                                  
 35079                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35080                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35081                                  $P_Chk_Switch:
 35082                                  	; 18/04/2023
 35083 00005387 8D2E[B897]              	lea	bp,$P_STRING_BUF	;AN020;AC034; BP=OFFSET of $P_String_Buf even in group addressing
 35084                                  
 35085 0000538B 39EB                    	cmp	bx,bp			;AN000;
 35086 0000538D 7418                    	je	short $P_STRUC_L2	;AN000;
 35087                                  
 35088 0000538F 3C2F                    	cmp     al,$P_Switch ; '/'	;AN000;
 35089 00005391 7512                    	jne	short $P_STRUC_L5	;AN000;
 35090                                  
 35091 00005393 F9                      	stc				;AN020;not in first position and is slash, now see if might be in date string
 35092 00005394 50                      	push	ax			;AN020;save input char
 35093 00005395 2E8A47FF                	mov	al,[cs:bx-1]		;AN026;AL=char before the current char
 35094 00005399 E804FB                  	call	$P_0099 		;AN020;return carry set if not numeric
 35095 0000539C 7205                    	jc	short $P_STRUC_L7	;AN000;
 35096                                  
 35097 0000539E 8A04                    	mov	al,[si]			;AN020;AL=char after the current char
 35098 000053A0 E8FDFA                  	call	$P_0099			;AN020;return carry set if not numeric
 35099                                  $P_STRUC_L7:				;AN000;
 35100 000053A3 58                      	pop	ax			;AN020;restore AL to input char
 35101                                  	;jmp	short $P_STRUC_L1	;AN000;
 35102                                  	; 18/04/2023
 35103 000053A4 C3                      	retn
 35104                                  
 35105                                  $P_STRUC_L5:				;AN000;
 35106 000053A5 F8                      	clc				;AN020;not a slash
 35107                                  	;jmp	short $P_STRUC_L1	;AN000;
 35108                                  	 ;18/04/2023
 35109 000053A6 C3                      	retn
 35110                                  
 35111                                  $P_STRUC_L2:				;AN000;
 35112 000053A7 3C2F                    	cmp     al,$P_Switch ; '/'	;AN000;
 35113                                  	;jne	short $P_STRUC_L12	;AN000;
 35114                                  	; 18/04/2023
 35115 000053A9 75FA                    	jne	short $P_STRUC_L5
 35116                                  
 35117 000053AB 2E800E[AF97]40          	or	byte [cs:$P_Flags2],$P_SW
 35118                                  	;or	byte [cs:$P_Flags2],40h	;AN020;AC034;;could be valid switch, first char and is slash
 35119                                  	; 18/04/2023
 35120                                  ;$P_STRUC_L12:				;AN000;
 35121                                  	;clc				;AN020;CF=0 indicating first char
 35122                                  $P_STRUC_L1:				;AN000;
 35123 000053B1 C3                      	retn				;AN000;
 35124                                  
 35125                                  ;**************************************************************************
 35126                                  ; $P_Chk_DBCS:
 35127                                  ;
 35128                                  ;  Function: Check if a specified byte is in ranges of the DBCS lead bytes
 35129                                  ;
 35130                                  ;  Input:
 35131                                  ;	  AL	= Code to be examineed
 35132                                  ;
 35133                                  ;  Output:
 35134                                  ;	  If CF is on then a lead byte of DBCS
 35135                                  ;
 35136                                  ; Use: INT 21h w/AH=63
 35137                                  ;
 35138                                  ; Vars:  $P_DBCSEV_Seg(RW), $P_DBCSEV_Off(RW)
 35139                                  ;***************************************************************************
 35140                                  
 35141                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35142                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35143                                  $P_Chk_DBCS:
 35144 000053B2 1E                      	push	ds			;AN000;
 35145 000053B3 56                      	push	si			;AN000;
 35146 000053B4 53                      	push	bx			;AN000; (tm11)
 35147 000053B5 2E833E[AC97]00          	cmp	word [cs:$P_DBCSEV_SEG],0
 35148                                  					;AC034; ALREADY SET ?
 35149 000053BB 7527                    	jne	short $P_DBCS00		;AN000;
 35150 000053BD 50                      	push	ax			;AN000;
 35151 000053BE 1E                      	push	ds			;AN000; (tm11)
 35152 000053BF 51                      	push	cx			;AN000;
 35153 000053C0 52                      	push	dx			;AN000;
 35154 000053C1 57                      	push	di			;AN000;
 35155 000053C2 55                      	push	bp			;AN000;
 35156 000053C3 06                      	push	es			;AN000;
 35157 000053C4 31F6                    	xor	si,si			;AN000;
 35158 000053C6 8EDE                    	mov	ds,si			;AN000;
 35159                                  	;mov	ax,$P_DOS_GetEV 	;AN000; GET DBCS EV CALL
 35160 000053C8 B80063                  	mov	ax,6300h
 35161 000053CB CD21                    	int	21h			;AN000;
 35162 000053CD 8CDB                    	mov	bx,ds			;AN000; (tm11)
 35163 000053CF 09DB                    	or	bx,bx			;AN000; (tm11)
 35164 000053D1 07                      	pop	es			;AN000;
 35165 000053D2 5D                      	pop	bp			;AN000;
 35166 000053D3 5F                      	pop	di			;AN000;
 35167 000053D4 5A                      	pop	dx			;AN000;
 35168 000053D5 59                      	pop	cx			;AN000;
 35169 000053D6 1F                      	pop	ds			;AN000; (tm11)
 35170 000053D7 58                      	pop	ax			;AN000;
 35171 000053D8 7429                    	jz	short $P_NON_DBCS	;AN000;
 35172                                  $P_DBCS02:				;AN000;
 35173 000053DA 2E8936[AA97]            	mov	[cs:$P_DBCSEV_OFF],si	;AC034; save EV offset
 35174 000053DF 2E891E[AC97]            	mov	[cs:$P_DBCSEV_SEG],bx	;AC034; save EV segment (tm11)
 35175                                  $P_DBCS00:				;AN000;
 35176 000053E4 2E8B36[AA97]            	mov	si,[cs:$P_DBCSEV_OFF]	;AC034; load EV offset
 35177 000053E9 2E8E1E[AC97]            	mov	ds,[cs:$P_DBCSEV_SEG]	;AC034; and segment
 35178                                  $P_DBCS_LOOP:				;AN000;
 35179 000053EE 833C00                  	cmp	word [si],0 		;AN000; zero vector ?
 35180 000053F1 7410                    	je	short $P_NON_DBCS	;AN000; then exit
 35181 000053F3 3A04                    	cmp	al,[si] 		;AN000;
 35182 000053F5 7208                    	jb	short $P_DBCS01		;AN000; Check if AL is in
 35183 000053F7 3A4401                  	cmp	al,[si+1]		;AN000;   range of
 35184 000053FA 7703                    	ja	short $P_DBCS01		;AN000;      the vector
 35185 000053FC F9                      	stc				;AN000; if yes, indicate DBCS and exit
 35186 000053FD EB04                    	jmp	short $P_DBCS_EXIT	;AN000;
 35187                                  $P_DBCS01:				;AN000;
 35188 000053FF 46                      	inc	si			;AC035; add '2' to
 35189 00005400 46                      	inc	si			;AC035;  SI reg
 35190                                  					;AN000; get next vector
 35191 00005401 EBEB                    	jmp	short $P_DBCS_LOOP	;AN000; loop until zero vector found
 35192                                  
 35193                                  $P_NON_DBCS:				;AN000;
 35194                                  	; 18/04/2023
 35195                                  	; cf=0
 35196                                  	;clc				;AN000; indicate SBCS
 35197                                  $P_DBCS_EXIT:				;AN000;
 35198 00005403 5B                      	pop	bx			;AN000; (tm11)
 35199 00005404 5E                      	pop	si			;AN000;
 35200 00005405 1F                      	pop	ds			;AN000;
 35201 00005406 C3                      	retn				;AN000;
 35202                                  
 35203                                  ;============================================================================
 35204                                  ; TPARSE.ASM, MSDOS 6.0, 1991
 35205                                  ;============================================================================
 35206                                  ; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35207                                  
 35208                                  ; ****************************************************************
 35209                                  ; *
 35210                                  ; * ROUTINE:	 CMD_PARSE
 35211                                  ; *
 35212                                  ; * FUNCTION:	 Interface for transient COMMAND to invoke
 35213                                  ; *		 SYSPARSE.
 35214                                  ; *
 35215                                  ; * INPUT:	 inputs to SYSPARSE
 35216                                  ; *
 35217                                  ; * OUTPUT:	 outputs from SYSPARSE
 35218                                  ; *
 35219                                  ; ****************************************************************
 35220                                  
 35221                                  	; 06/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35222                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:4FF7h
 35223                                  	; 14/06/2023 - Retro DOS v4.2 COMMAND.COM
 35224                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:57BBh
 35225                                  ;cmd_parse:
 35226                                  	;call	sysparse		;AN000;
 35227                                  	;retn				;AN000;
 35228                                  	; 06/04/2023
 35229                                  	;jmp	sysparse
 35230                                  
 35231                                  append_parse:
 35232 00005407 E842F5                  	call	sysparse		;AN010;
 35233 0000540A CB                      	retf				;AN010;
 35234                                  
 35235                                  ;============================================================================
 35236                                  ; TPRINTF.ASM, MSDOS 6.0, 1991
 35237                                  ;============================================================================
 35238                                  ; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35239                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35240                                  
 35241                                  ; ----------------------------
 35242                                  ; MSDOS 6.0, MSGSERV.ASM, 1991
 35243                                  ; ----------------------------
 35244                                  
 35245                                  ;; Replacable parameters are described by a sublist structure
 35246                                  
 35247                                  struc $M_SUBLIST_STRUC		;;AN000;;
 35248 00000000 ??                       .$M_S_SIZE:	resb 1		;;AN000;; SUBLIST size (PTR to next SUBLIST)
 35249 00000001 ??                       .$M_S_RESV:	resb 1		;;AN000;; RESERVED
 35250 00000002 ????????                 .$M_S_VALUE:	resd 1 		;;AN000;; Time, Date or PTR to data item
 35251 00000006 ??                       .$M_S_ID:	resb 1		;;AN000;; n of %n
 35252 00000007 ??                       .$M_S_FLAG:	resb 1		;;AN000;; Data-type flags
 35253 00000008 ??                       .$M_S_MAXW:	resb 1		;;AN000;; Maximum field width
 35254 00000009 ??                       .$M_S_MINW:	resb 1		;;AN000;; Minimum field width
 35255 0000000A ??                       .$M_S_PAD:	resb 1		;;AN000;; Character for Pad field
 35256                                  endstruc
 35257                                  
 35258                                  ; ---------------------------------------------------------------------------
 35259                                  ; ---------------------------------------------------------------------------
 35260                                  
 35261                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35262                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 4FFFh
 35263                                  
 35264                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35265                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 57C3h
 35266                                  
 35267                                  Printf_Init:
 35268 0000540B E80F00                  	call	std_printf
 35269 0000540E CB                      	retf
 35270                                  
 35271                                  Printf_Crlf:
 35272 0000540F E80B00                  	call	std_printf
 35273                                  	;call	CRLF2
 35274                                  	;retn
 35275                                  	; 07/04/2023
 35276 00005412 E962D5                  	jmp	CRLF2
 35277                                  
 35278                                  ;****************************************************************
 35279                                  ;*
 35280                                  ;* ROUTINE:	STD_PRINTF/STD_EPRINTF
 35281                                  ;*
 35282                                  ;* FUNCTION:	Set up to print out a message using SYSDISPMSG.
 35283                                  ;*		Set up substitutions if utility message.  Make
 35284                                  ;*		sure any changes to message variables in TDATA
 35285                                  ;*		are reset to avoid reloading the transient.
 35286                                  ;*
 35287                                  ;* INPUT:	Msg_Disp_Class	-  set to message class
 35288                                  ;*		Msg_Cont_Flag	-  set to control flags
 35289                                  ;*		DS	points to transient segment
 35290                                  ;*
 35291                                  ;*		if utility message:
 35292                                  ;*		DX	points to a block with message number
 35293                                  ;*			(word), number of substitutions (byte),
 35294                                  ;*			followed by substitution list if there
 35295                                  ;*			are substitutions.  If substitutions
 35296                                  ;*			are not in transient segment they must
 35297                                  ;*			be set.
 35298                                  ;*		else
 35299                                  ;*		AX	set to message number
 35300                                  ;*
 35301                                  ;* OUTPUT:	none
 35302                                  ;*
 35303                                  ;****************************************************************
 35304                                  
 35305                                  std_eprintf:
 35306 00005415 C706[7F99]0200          	mov	word [PRINTF_HANDLE],2 		;AC000;Print to STDERR
 35307 0000541B EB06                    	jmp	short new_printf		;AC000;
 35308                                  
 35309                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35310                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 5012h
 35311                                  
 35312                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35313                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 57D6h
 35314                                  
 35315                                  std_printf:
 35316 0000541D C706[7F99]0100          	mov	word [PRINTF_HANDLE],1 		;AC000;Print to STDOUT
 35317                                  
 35318                                  new_printf:
 35319 00005423 50                      	push	ax				;AN000;save registers
 35320 00005424 53                      	push	bx				;AN000;
 35321 00005425 51                      	push	cx				;AN000;
 35322 00005426 06                      	push	es				;AN000;get local ES
 35323 00005427 1E                      	push	ds				;AN000;
 35324 00005428 07                      	pop	es				;AN000;
 35325 00005429 57                      	push	di				;AN000;
 35326 0000542A 56                      	push	si				;AN000;
 35327 0000542B 52                      	push	dx				;AN000;
 35328                                  
 35329                                  	; 07/04/2023
 35330                                  	;mov	word [print_err_flag],0		;AN000;
 35331 0000542C 31C9                    	xor	cx,cx
 35332 0000542E 890E[969F]              	mov	[print_err_flag],cx ; 0
 35333                                  
 35334 00005432 89D6                    	mov	si,dx				;AN000;Get offset of message number
 35335 00005434 AD                      	lodsw					;AN000;load message number
 35336                                  	; 15/06/2023
 35337                                  	;push	ax				;AN000;save it
 35338                                  	;lodsb					;AN000;get number of substitutions
 35339                                  	;mov	cl,al				;AN000;set up CX as # of subst
 35340                                  	;; 07/04/2023
 35341                                  	;;xor	ch,ch				;AN000;SI now points to subst list
 35342                                  	;pop	ax				;AN000;get message number back
 35343                                  	; 15/06/2023
 35344 00005435 8A0C                    	mov	cl,[si]
 35345 00005437 46                      	inc	si
 35346                                  
 35347                                  	;cmp	cx,0				;AN000;Any substitutions?
 35348                                  	; 07/04/2023
 35349 00005438 21C9                    	and	cx,cx
 35350 0000543A 745C                    	jz	short ready_to_print		;AN000;No - continue
 35351                                  
 35352 0000543C BF[989F]                	mov	di,subst_buffer			;AN061; Get address of message subst buffer
 35353 0000543F 57                      	push	di				;AN061; save it
 35354 00005440 51                      	push	cx				;AN061; save number of subst
 35355                                  
 35356                                  move_subst:
 35357 00005441 51                      	push	cx				;AN061;save number of subst
 35358 00005442 89F3                    	mov	bx,si				;AN061;save start of sublist
 35359                                  	;mov	cx,parm_block_size ; 11		;AN061;get size of sublist
 35360                                  	; 07/04/2023
 35361 00005444 B10B                    	mov	cl,parm_block_size ; 11
 35362 00005446 F3A4                    	rep	movsb				;AN061;move sublist
 35363                                  	;test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],date_type
 35364 00005448 F6470704                	test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],4
 35365                                  	;test	byte [bx+7],4			;AN061;are we doing date/time?
 35366 0000544C 7406                    	jz	short move_subst_cont 		;AN061;no - no need to reset
 35367                                  	;mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE],0
 35368                                  	;mov	word [bx+2],0			;AN061;reset original date or time to 0
 35369 0000544E 894F02                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE],cx ; 0
 35370                                  	;mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],0
 35371                                  	;mov	word [bx+4],0			;AN061;
 35372 00005451 894F04                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],cx ; 0
 35373                                  
 35374                                  move_subst_cont:				;AN061;
 35375 00005454 59                      	pop	cx				;AN061;get number of subst back
 35376 00005455 E2EA                    	loop	move_subst			;AN061;move cx sublists
 35377                                  
 35378 00005457 59                      	pop	cx				;AN061;get number of subst
 35379 00005458 50                      	push	ax				;AN061;save message number
 35380 00005459 803E[C98F]FF            	cmp	byte [msg_disp_class],util_msg_class
 35381                                  	;cmp	byte [msg_disp_class],0FFh	;AN061;Is this a utility message
 35382 0000545E 740C                    	je	short check_fix			;AN061;YES - go see if substitutions
 35383                                  	;mov	byte [msg_flag],1 ; ext_msg_class
 35384 00005460 C606[929F]01            	mov	byte [msg_flag],ext_msg_class	;AN061;set message flag
 35385 00005465 BF[CB8F]                	mov	di,extend_buf_ptr		;AN061; Get address of extended message block
 35386 00005468 31C0                    	xor	ax,ax				;AN061;clear ax register
 35387 0000546A AB                      	stosw					;AN061;clear out message number
 35388 0000546B AA                      	stosb					;AN061;clear out subst count
 35389                                  
 35390                                  check_fix:					;AN061;
 35391 0000546C 58                      	pop	ax				;AN061;get message number back
 35392 0000546D 5F                      	pop	di				;AN061;get start of sublists
 35393 0000546E 89FE                    	mov	si,di				;AN061;get into SI for msgserv
 35394 00005470 89F3                    	mov	bx,si				;AN061;get into BX for addressing
 35395 00005472 51                      	push	cx				;AN061;save number of subst
 35396                                  
 35397                                  set_subst:					;AN061;store the segment of the subst
 35398 00005473 837F0400                	cmp	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],0
 35399                                  	;cmp	word [bx+4],0			;AN061;was it set already?
 35400 00005477 7509                    	jnz	short subst_seg_set		;AN061;if not 0, don't replace it
 35401 00005479 F6470704                	test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],4
 35402                                  	;test	byte [bx+$M_SUBLIST_STRUC.$M_S_FLAG],date_type
 35403                                  	;test	byte [bx+7],4			;AN061;don't replace if date or time
 35404 0000547D 7503                    	jnz	short subst_seg_set		;AN061;yes - skip it
 35405 0000547F 8C4F04                  	mov	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE+2],cs
 35406                                  	;mov	word [bx+4],cs			;AN061;set segment value
 35407                                  
 35408                                  subst_seg_set:					;AN061;
 35409 00005482 83C30B                  	add	bx,parm_block_size ; add bx,11	;AN061;go to next sublist
 35410 00005485 E2EC                    	loop	set_subst			;AN061;loop CX times
 35411 00005487 59                      	pop	cx				;AN061;get number of subst back
 35412                                  
 35413 00005488 89F3                    	mov	bx,si				;AN061;get start of sublist to BX
 35414 0000548A 817F02[019E]            	cmp	word [bx+$M_SUBLIST_STRUC.$M_S_VALUE],string_ptr_2
 35415                                  	;cmp	word [bx+2],string_ptr_2	;AN061;are we using double indirection?
 35416 0000548F 7507                    	jne	short ready_to_print		;AN061;no - we already have address
 35417                                  	; 01/05/2023
 35418 00005491 8B16[019E]              	mov	dx,[string_ptr_2] 		;AN061;get address in string_ptr_2
 35419 00005495 895702                  	mov	[bx+$M_SUBLIST_STRUC.$M_S_VALUE],dx
 35420                                  						;AN061;put it into the subst block
 35421                                  	;mov	[bx+2],dx
 35422                                  
 35423                                  ready_to_print:
 35424 00005498 8B1E[7F99]              	mov	bx,[PRINTF_HANDLE]		;AN000;get print handle
 35425 0000549C 8A16[CA8F]              	mov	dl,[msg_cont_flag]		;AN000;set up control flag
 35426 000054A0 8A36[C98F]              	mov	dh,[msg_disp_class]		;AN000;set up display class
 35427 000054A4 C606[CA8F]00            	mov	byte [msg_cont_flag],0 ; no_cont_flag
 35428                                  						;AN061;reset flags to avoid
 35429 000054A9 C606[C98F]FF            	mov	byte [msg_disp_class],util_msg_class
 35430                                  	;mov	byte [msg_disp_class],0FFh	;AN061; transient reload
 35431                                  
 35432 000054AE 1E                      	push	ds				;AN026;
 35433 000054AF 06                      	push	es				;AN026;
 35434                                  
 35435 000054B0 E83702                  	call	SYSDISPMSG			;AN000;call Rod
 35436                                  
 35437 000054B3 07                      	pop	es				;AN026; restore registers
 35438 000054B4 1F                      	pop	ds				;AN026;
 35439                                  
 35440 000054B5 7303                    	jnc	short print_success		;AN000; everything went okay
 35441 000054B7 A3[969F]                	mov	[print_err_flag],ax		;AN000;
 35442                                  
 35443                                  print_success:
 35444 000054BA 5A                      	pop	dx				;AN061;restore dx
 35445 000054BB 5E                      	pop	si				;AN000;restore registers
 35446 000054BC 5F                      	pop	di				;AN000;
 35447 000054BD 07                      	pop	es				;AN000;restore registers
 35448 000054BE 59                      	pop	cx				;AN000;
 35449 000054BF 5B                      	pop	bx				;AN000;
 35450 000054C0 58                      	pop	ax				;AN000;
 35451 000054C1 833E[969F]00            	cmp	word [print_err_flag],0		;AN000; if an error occurred - handle it
 35452 000054C6 7501                    	jnz	short print_err			;AN000;
 35453                                  
 35454 000054C8 C3                      	retn					;AC000;
 35455                                  
 35456                                  print_err:
 35457 000054C9 0E                      	push	cs
 35458 000054CA 07                      	pop	es
 35459 000054CB 833E[7F99]02            	cmp	word [PRINTF_HANDLE],2 		;AN026;Print to STDERR?
 35460 000054D0 7503                    	jne	short not_stderr		;AN026;no - continue
 35461 000054D2 E92FAC                  	jmp	TCOMMAND			;AN026;Yes - hopless - just exit
 35462                                  
 35463                                  not_stderr:
 35464 000054D5 A1[969F]                	mov	ax,[print_err_flag]		;AN026;get extended error number back
 35465 000054D8 8E06[539C]              	mov	es,[RESSEG]			; No, set up for error, load the
 35466                                  						;  right error msg, and jmp to cerror.
 35467 000054DC 26F606[1303]FF          	test	byte [es:PipeFlag],-1 ; 0FFh
 35468 000054E2 7408                    	jz	short _go_to_error
 35469 000054E4 E8BEDE                  	call	PipeOff
 35470 000054E7 BA[5191]                	mov	dx,PIPEEMES_PTR
 35471 000054EA EB0B                    	jmp	short print_err_exit			;AC000;
 35472                                  
 35473                                  _go_to_error:
 35474 000054EC C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class
 35475                                  	;mov	byte [msg_disp_class],1		;AN000; set up extended error msg class
 35476 000054F1 BA[CB8F]                	mov	dx,extend_buf_ptr		;AC000; get extended message pointer
 35477 000054F4 A3[CB8F]                	mov	[extend_buf_ptr],ax		;AN000; get message number in control block
 35478                                  
 35479                                  print_err_exit: 				;AC000;
 35480 000054F7 0E                      	push	cs
 35481 000054F8 07                      	pop	es
 35482 000054F9 E928D8                  	jmp	cerror
 35483                                  
 35484                                  ;****************************************************************
 35485                                  ;*
 35486                                  ;* ROUTINE:	TSYSLOADMSG
 35487                                  ;*
 35488                                  ;* FUNCTION:	Interface to call SYSLOADMSG to avoid duplicate
 35489                                  ;*		names since these routines are also used in the
 35490                                  ;*		resident.
 35491                                  ;*
 35492                                  ;* INPUT:	Inputs to SYSLOADMSG
 35493                                  ;*
 35494                                  ;* OUTPUT:	Outputs from SYSLOADMSG
 35495                                  ;*
 35496                                  ;****************************************************************
 35497                                  
 35498                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35499                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35500                                  TSYSLOADMSG:
 35501 000054FC 53                      	push	bx				;AN000;
 35502 000054FD E80800                  	call	SYSLOADMSG			;AN000; call routine
 35503 00005500 5B                      	pop	bx				;AN000;
 35504 00005501 C3                      	retn					;AN000; exit
 35505                                  
 35506                                  ;****************************************************************
 35507                                  ;*
 35508                                  ;* ROUTINE:	TSYSGETMSG
 35509                                  ;*
 35510                                  ;* FUNCTION:	Interface to call SYSGETMSG to avoid duplicate
 35511                                  ;*		names since these routines are also used in the
 35512                                  ;*		resident.
 35513                                  ;*
 35514                                  ;* INPUT:	Inputs to SYSGETMSG
 35515                                  ;*
 35516                                  ;* OUTPUT:	Outputs from SYSGETMSG
 35517                                  ;*
 35518                                  ;****************************************************************
 35519                                  
 35520                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35521                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35522                                  TSYSGETMSG:
 35523 00005502 51                      	push	cx				;AN000;
 35524 00005503 E8B500                  	call	SYSGETMSG			;AN000; call routine
 35525 00005506 59                      	pop	cx				;AN000;
 35526 00005507 C3                      	retn					;AN000; exit
 35527                                  
 35528                                  ;============================================================================
 35529                                  ; MSGSERV.ASM, MSDOS 6.0, 1991
 35530                                  ;============================================================================
 35531                                  ; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35532                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35533                                  
 35534                                  ; ---------------------------------------------------------------------------
 35535                                  ; MODULE NAME: MSGSERV.SAL
 35536                                  ;
 35537                                  ; DESCRIPTIVE NAME: Message Services SALUT file
 35538                                  ;
 35539                                  ; FUNCTION: This module incorporates all the messages services and
 35540                                  ;	    is called upon at build time to INCLUDE the code requested
 35541                                  ;	    by a utility. Code is requested using the macro MSG_SERVICES.
 35542                                  ;
 35543                                  ; ENTRY POINT: Since this a collection of subroutines, entry point is at
 35544                                  ;	    requested procedure.
 35545                                  ;
 35546                                  ; INPUT: Since this a collection of subroutines, input is dependent on
 35547                                  ;	    function requested.
 35548                                  ;
 35549                                  ; EXIT-NORMAL: In all cases, CARRY FLAG = 0
 35550                                  ;
 35551                                  ; EXIT-ERROR: In all cases, CARRY FLAG = 1
 35552                                  ;
 35553                                  ; INTERNAL REFERENCES: (list of included subroutines)
 35554                                  ;
 35555                                  ;	- SYSLOADMSG
 35556                                  ;	- SYSDISPMSG
 35557                                  ;	- SYSGETMSG
 35558                                  ;
 35559                                  ; EXTERNAL REFERENCES: None
 35560                                  ;
 35561                                  ; NOTES: At build time, some modules must be included. These are only included
 35562                                  ;	 once using assembler switches. Other logic is included at the request
 35563                                  ;	 of the utility.
 35564                                  ;
 35565                                  ;	 COMR and COMT are assembler switches to conditionally assemble code
 35566                                  ;	 for RESIDENT COMMAND.COM and TRANSIENT COMMAND.COM to reduce resident
 35567                                  ;	 storage and multiple EQUates.
 35568                                  ;
 35569                                  ; REVISION HISTORY: Created MAY 1987
 35570                                  ;
 35571                                  ;     Label: DOS - - Message Retriever
 35572                                  ;	     (c) Copyright 1988 Microsoft
 35573                                  ; ---------------------------------------------------------------------------
 35574                                  
 35575                                  ;	Revision History
 35576                                  ;	================
 35577                                  ;
 35578                                  ;	M007	SR	08/24/90	Fixed bug #1818 -- changed
 35579                                  ;				$M_DISPLAY_H_STRING to properly
 35580                                  ;				handle Ctrl-Z being passed
 35581                                  ;
 35582                                  ;	M013	SR	9/12/90	Make SETSTDIO flag false so that all
 35583                                  ;				these routines are no longer assembled.
 35584                                  ;
 35585                                  ;	M016	SR	10/14/90	Bug #3380. Changed SYSLOADMSG so that
 35586                                  ;				CR-LF string also gets reinitialized
 35587                                  ;				on every cycle.
 35588                                  ;
 35589                                  ;	M020	SR	10/26/90	Bug #3380 again. Initialize $M_DIVISOR
 35590                                  ;				& $_MSG_NUM also in SYSLOADMSG.
 35591                                  
 35592                                  ; ---------------------------------------------------------------------------
 35593                                  
 35594                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35595                                  
 35596                                  ;;; Replacable parameters are described by a sublist structure
 35597                                  ;
 35598                                  ;struc $M_SUBLIST_STRUC		;;AN000;;
 35599                                  ; .$M_S_SIZE:	resb 1		;;AN000;; SUBLIST size (PTR to next SUBLIST)
 35600                                  ; .$M_S_RESV:	resb 1		;;AN000;; RESERVED
 35601                                  ; .$M_S_VALUE:	resd 1 		;;AN000;; Time, Date or PTR to data item
 35602                                  ; .$M_S_ID:	resb 1		;;AN000;; n of %n
 35603                                  ; .$M_S_FLAG:	resb 1		;;AN000;; Data-type flags
 35604                                  ; .$M_S_MAXW:	resb 1		;;AN000;; Maximum field width
 35605                                  ; .$M_S_MINW:	resb 1		;;AN000;; Minimum field width
 35606                                  ; .$M_S_PAD:	resb 1		;;AN000;; Character for Pad field
 35607                                  ;endstruc
 35608                                  
 35609                                  ;; Each class will be defined by this structure.
 35610                                  
 35611                                  struc $M_CLASS_ID		;;AN000;;
 35612 00000000 ??                       .$M_CLS_ID:	  resb 1	;;AN000;; Class identifer
 35613 00000001 ????                     .$M_COMMAND_VER: resw 1	;;AN003;; COMMAND.COM version check
 35614 00000003 ??                       .$M_NUM_CLS_MSG: resb 1	;;AN000;; Total number of message in class
 35615                                   .size:
 35616                                  endstruc
 35617                                  
 35618                                  $M_CLASS_ID_SZ	EQU $M_CLASS_ID.size	;;AN000;;
 35619                                  
 35620                                  ;; Each message will be defined by this structure.
 35621                                  
 35622                                  struc $M_ID			;;AN000;;
 35623 00000000 ????                     .$M_NUM:	resw 1		;;AN000;; Message Number
 35624 00000002 ????                     .$M_TXT_PTR:	resw 1		;;AN000;; Pointer to message text
 35625                                   .size:	
 35626                                  endstruc
 35627                                  
 35628                                  $M_ID_SZ	EQU  $M_ID.size	;;AN000;;
 35629                                  
 35630                                  ; ---------------------------
 35631                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 35632                                  ; ---------------------------
 35633                                  $M_TEMP_BUF_SZ	EQU 64     ;; Size of temporary buffer	 ;AN003;
 35634                                  
 35635                                  ; --------------------------- 
 35636                                  
 35637                                  ; 07/04/2023
 35638                                  $M_NUM_CLS equ 3
 35639                                  
 35640                                  ;; Resident data area definition of variables
 35641                                  
 35642                                  struc $M_RES_ADDRS			;;AN000;;
 35643 00000000 ????????                 .$M_EXT_ERR_ADDRS: resd 1		;;AN000;; Allow pointers to THREE Extended error locations
 35644 00000004 ????????                 .$M_EXT_FILE:	    resd 1		;;AN001;;
 35645 00000008 ????????                 .$M_EXT_COMMAND:   resd 1		;;AN000;;
 35646 0000000C ????????                 .$M_EXT_TERM:	    resd 1		;;AN000;;
 35647 00000010 ????????                 .$M_PARSE_COMMAND: resd 1		;;AN000;;
 35648 00000014 ????????                 .$M_PARSE_ADDRS:   resd 1		;;AN000;; Allow pointers to TWO Parse error locations
 35649 00000018 ????????                 .$M_PARSE_TERM:    resd 1		;;AN000;;
 35650 0000001C ????????                 .$M_CRIT_ADDRS:    resd 1		;;AN000;; Allow pointers to TWO Critical error locations
 35651 00000020 ????????                 .$M_CRIT_COMMAND:  resd 1		;;AN000;;
 35652 00000024 ????????                 .$M_CRIT_TERM:	    resd 1		;;AN000;;
 35653 00000028 ????????                 .$M_DISK_PROC_ADDR: resd 1		;;AN004;; Address of READ_DISK_PROC
 35654 0000002C <res Ch>                 .$M_CLASS_ADDRS:   resd $M_NUM_CLS ; 3	;;AN000;; Allow pointers to specified classes
 35655 00000038 ????????                 .$M_CLS_TERM:	    resd 1		;;AN000;;
 35656 0000003C ????????                 .$M_DBCS_VEC:	    resd 1		;;AN000;; Save DBCS vector
 35657 00000040 ????                     .$M_HANDLE:	    resw 1 		;;AN000;;
 35658 00000042 ??                       .$M_SIZE:	    resb 1		;;AN000;;
 35659 00000043 ????                     .$M_CRLF:	    resb 2  		;;AN004;; CR LF message
 35660 00000045 ??                       .$M_CLASS:	    resb 1		;;AN004;; Saved class
 35661 00000046 ????                     .$M_RETURN_ADDR:   resw 1		;;AN000;;
 35662 00000048 ????                     .$M_MSG_NUM:	    resw 1		;;AN000;;
 35663 0000004A ????                     .$M_DIVISOR:	    resw 1		;;AN000;; Default = 10 (must be a WORD for division)
 35664 0000004C <res 40h>                .$M_TEMP_BUF:	    resb $M_TEMP_BUF_SZ	;;AN000;; Temporary buffer
 35665 0000008C ??                       .$M_BUF_TERM:	    resb 1		;;AN000;;
 35666                                   .size:
 35667                                  endstruc				;;AN000;;
 35668                                  
 35669                                  $M_RES_ADDRS_SZ	EQU $M_RES_ADDRS.size	;;AN000;;
 35670                                  
 35671                                  ;; Important fields of the Get Country Information call
 35672                                  
 35673                                  struc $M_COUNTRY_INFO			;;AN000;; Expected Country infomation
 35674 00000000 <res 4Ch>                .$M_HEADER:	    resb $M_RES_ADDRS_SZ-$M_TEMP_BUF_SZ-1
 35675                                  					;;AN000;; Go past first part of struc
 35676 0000004C ????                     .$M_DATE_FORMAT:   resw 1		;;AN000;; <------- Date Format
 35677 0000004E ??????????               .$M_CURR_SEPARA:   resb 5		;;AN000;;
 35678 00000053 ????                     .$M_THOU_SEPARA:   resb 2		;;AN000;; <------- Thou Separator
 35679 00000055 ????                     .$M_DECI_SEPARA:   resb 2		;;AN000;; <------- Decimal Separator
 35680 00000057 ????                     .$M_DATE_SEPARA:   resb 2		;;AN000;; <------- Date Separator
 35681 00000059 ????                     .$M_TIME_SEPARA:   resb 2		;;AN000;; <------- Time Separator
 35682 0000005B ??                       .$M_CURR_FORMAT:   resb 1		;;AN000;;
 35683 0000005C ??                       .$M_SIG_DIGS_CU:   resb 1		;;AN000;;
 35684 0000005D ??                       .$M_TIME_FORMAT:   resb 1		;;AN000;; <------- Time Format
 35685                                  endstruc				;;AN000;;
 35686                                  
 35687                                  ; ---------------------------------------------------------------------------
 35688                                  
 35689                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35690                                  ;;
 35691                                  ;;	PROC NAME: SYSLOADMSG
 35692                                  ;;
 35693                                  ;;	FUNCTION:
 35694                                  ;;	INPUTS:
 35695                                  ;;
 35696                                  ;;	OUTPUTS:
 35697                                  ;;
 35698                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35699                                  
 35700                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35701                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5107h
 35702                                  
 35703                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35704                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:58CBh
 35705                                  
 35706                                  SYSLOADMSG:
 35707 00005508 50                      	push	ax				;;AN000;
 35708 00005509 53                      	push	bx				;;AN000;
 35709 0000550A 52                      	push	dx				;;AN000;
 35710 0000550B 06                      	push	es				;;AN000;
 35711 0000550C 57                      	push	di				;;AN000;
 35712 0000550D 31C9                    	xor	cx,cx				;;AN000;  Reset to zero
 35713 0000550F 8EC1                    	mov	es,cx				;;AN000;
 35714 00005511 31FF                    	xor	di,di				;;AN000;
 35715 00005513 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 35716 00005516 B200                    	mov	dl,0 ; DOS_GET_EXTENDED		;;AN000;; Where are the Extended errors in COMMAND.COM
 35717 00005518 CD2F                    	int	2Fh				;;AN000;; Private interface
 35718                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 35719                                  		; DL = subfunction - get standard DOS error table (errors 00h-12h,50h-5Bh)
 35720                                  		; Return: ES:DI -> error table
 35721                                  	
 35722 0000551A 8C06[8798]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_COMMAND+2],es
 35723                                  	;mov	[$M_RT+10],es			;;AN000;; Move into first avaliable table location
 35724 0000551E 893E[8598]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_COMMAND],di
 35725                                  	;mov	[$M_RT+8],di			;;AN000;;
 35726                                  
 35727 00005522 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 35728 00005525 B202                    	mov	dl,2 ; DOS_GET_PARSE		;;AN000;; Where are the Parse errors in COMMAND.COM
 35729 00005527 CD2F                    	int	2Fh				;;AN000;; Private interface
 35730                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 35731                                  		; DL = subfunction - get critical/SHARE error table (errors 13h-2Bh)
 35732                                  		; ES:DI -> error table
 35733                                  
 35734 00005529 8C06[8F98]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND+2],es
 35735                                  	;mov	[$M_RT+18],es			;;AN000;; Move into first avaliable table location
 35736 0000552D 893E[8D98]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND],di
 35737                                  	;mov	[$M_RT+16],di			;;AN000;;
 35738                                  
 35739 00005531 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN000;; 2FH Interface
 35740 00005534 B204                    	mov	dl,4 ; DOS_GET_CRITICAL		;;AN000;; Where are the Critical errors in COMMAND.COM
 35741 00005536 CD2F                    	int	2Fh				;;AN000;; Private interface
 35742                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 35743                                  		; DL = subfunction - get ??? error table
 35744                                  		; ES:DI -> error table
 35745                                  
 35746 00005538 8C06[9F98]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_COMMAND+2],es
 35747                                  	;mov	[$M_RT+34],es			;;AN000;; Move into first avaliable table location
 35748 0000553C 893E[9D98]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_COMMAND],di
 35749                                  	;mov	[$M_RT+32],di			;;AN000;;
 35750                                  
 35751 00005540 B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN001;; 2FH Interface
 35752 00005543 B206                    	mov	dl,6 ; DOS_GET_FILE		;;AN001;; Where are the FILE dependant in IFSFUNC.EXE
 35753 00005545 CD2F                    	int	2Fh					     ;;AN001;; Private interface
 35754                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 35755                                  		; DL = subfunction - get ??? error table
 35756                                  		; ES:DI -> error table
 35757                                  
 35758 00005547 8C06[8398]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_FILE+2],es
 35759                                  	;mov	[$M_RT+6],es			;;AN001;; Move into first avaliable table location
 35760 0000554B 893E[8198]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_FILE],di
 35761                                  	;mov	[$M_RT+4],di			;;AN001;;
 35762                                  
 35763 0000554F E8523A                  	call	$M_MSGSERV_1			;;AN000;; Get addressibility to MSGSERV CLASS 1 (EXTENDED Errors)
 35764                                  						;;AN000;;
 35765 00005552 8C06[7F98]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS+2],es
 35766                                  	;mov	[$M_RT+2],es			;;AN000;; Move into first avaliable table location
 35767 00005556 893E[7D98]              	mov	[$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS],di
 35768                                  	;mov	[$M_RT+0],di			;;AN000;;
 35769 0000555A 8C06[9B98]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS+2],es
 35770                                  	;mov	[$M_RT+30],es			;;AN000;; Move into first avaliable table location
 35771 0000555E 893E[9998]              	mov	[$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS],di
 35772                                  	;mov	[$M_RT+28],di			;;AN000;;
 35773                                  
 35774 00005562 E85D3A                  	call	$M_MSGSERV_2			;;AN000;; Get addressibility to MSGSERV CLASS 2 (PARSE Errors)
 35775                                  
 35776 00005565 8C06[9398]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_ADDRS+2],es
 35777                                  	;mov	[$M_RT+22],es			;;AN000;; Move into first avaliable table location
 35778 00005569 893E[9198]              	mov	[$M_RT+$M_RES_ADDRS.$M_PARSE_ADDRS],di
 35779                                  	;mov	[$M_RT+20],di			;;AN000;;
 35780                                  
 35781 0000556D B82E12                  	mov	ax,122Eh ; DOS_GET_EXT_PARSE_ADD ;;AN001;; 2FH Interface
 35782 00005570 B208                    	mov	dl,8 ; DOS_GET_ADDR 		;;AN001;; Where is the READ_DISK_PROC in COMMAND.COM
 35783 00005572 CD2F                    	int	2Fh				;;AN001;; Private interface
 35784                                  		; Multiplex - DOS 3+ internal - GET OR SET ERROR TABLE ADDRESSES
 35785                                  		; DL = subfunction - get ??? error table
 35786                                  		; ES:DI -> error table
 35787                                  
 35788 00005574 8C06[A798]              	mov	[$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR+2],es
 35789                                  	;mov	[$M_RT+42],es			;;AN001;; Move into first avaliable table location
 35790 00005578 893E[A598]              	mov	[$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR],di
 35791                                  	;mov	[$M_RT+40],di			;;AN001;;
 35792                                  
 35793                                  ;M016; M020
 35794                                  ; Reinitialize the CR-LF string. Also, reinit the buffer terminator just to
 35795                                  ;be safe. Initialize $M_MSG_NUM and $M_DIVISOR also.
 35796                                  
 35797 0000557C C706[C098]0D0A          	mov	word [$M_RT+$M_RES_ADDRS.$M_CRLF],0A0Dh
 35798                                  	;mov	word [$M_RT+67],0A0Dh		; Reinit CR-LF ;M016
 35799 00005582 C606[0999]24            	mov	byte [$M_RT+$M_RES_ADDRS.$M_BUF_TERM],'$'
 35800                                  	;mov	word [$M_RT+140],'$'		; Reinit buffer end;M016
 35801 00005587 C706[C598]0000          	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 35802                                  	;mov	word [$M_RT+72],0		; M020
 35803 0000558D C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 35804                                  	;mov	word [$M_RT+74],10		; M020
 35805                                  
 35806                                  	; 07/04/2023 - Retro DOS v4.0 COMMAND.COM
 35807                                  	; --------------------------
 35808                                  	; MSDOS 6.0 SYSMSG.INC, 1991
 35809                                  	; --------------------------
 35810                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP5192h
 35811                                  
 35812                                  	;$M_BUILD_PTRS %$M_NUM_CLS     		;;AN000;; Build all utility classes	
 35813 00005593 E8AB39                  	call    $M_CLS_3			; Get addressibility to class F
 35814 00005596 893E[A998]              	mov	[$M_RT+$M_RES_ADDRS.$M_CLASS_ADDRS],di
 35815                                  	;mov	[$M_RT+44],di
 35816                                  	
 35817 0000559A E80600                  	CALL	$M_GET_DBCS_VEC 		;;AN000;; Save the DBCS vector
 35818                                  
 35819                                  	; 15/04/2023
 35820                                  	;clc					;;AN000;; Make sure carry is clear
 35821                                  	;jc	short $MIF20
 35822                                  	
 35823 0000559D 5F                      	pop	di				;;AN000;; Restore REGS
 35824 0000559E 07                      	pop	es				;;AN000;;
 35825 0000559F 5A                      	pop	dx				;;AN000;;
 35826 000055A0 5B                      	pop	bx				;;AN000;;
 35827 000055A1 58                      	pop	ax				;;AN000;;
 35828                                  	;jmp	short $MEN20
 35829                                  	; 15/04/2023
 35830 000055A2 C3                      	retn
 35831                                  
 35832                                  	; 15/04/2023
 35833                                  ;$MIF20:
 35834                                  	;add	sp,10				;;AN000;;
 35835                                  	;stc					;;AN000;; Reset carry flag
 35836                                  ;$MEN20:
 35837                                  	;retn					;;AN000;;
 35838                                  
 35839                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35840                                  ;;
 35841                                  ;;  Proc Name:	$M_GET_DBCS_VEC
 35842                                  ;;
 35843                                  ;;  Function:	Get the DBCS vector and save it for later use
 35844                                  ;;
 35845                                  ;;  Inputs:	None
 35846                                  ;;
 35847                                  ;;  Outputs:	None
 35848                                  ;;
 35849                                  ;;  Regs Changed:
 35850                                  ;;
 35851                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35852                                  
 35853                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35854                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35855                                  $M_GET_DBCS_VEC:
 35856 000055A3 50                      	push	ax				;;AN000;; Save character to check
 35857 000055A4 56                      	push	si				;;AN000;;
 35858 000055A5 1E                      	push	ds				;;AN000;;
 35859 000055A6 B80063                  	mov	ax,6300h ;DOS_GET_DBCS_INFO	;;AN000;; DOS function to get DBSC environment
 35860 000055A9 CD21                    	int	21h				;;AN000;; Get environment pointer
 35861 000055AB 1E                      	push	ds				;;AN000;; Get environment pointer
 35862 000055AC 07                      	pop	es				;;AN000;; Get environment pointer
 35863 000055AD 1F                      	pop	ds				;;AN000;; Get environment pointer
 35864 000055AE 7208                    	jc	short $MIF23
 35865                                  	
 35866 000055B0 8936[B998]              	mov	word [$M_RT+$M_RES_ADDRS.$M_DBCS_VEC],si
 35867                                  	;mov	word [$M_RT+60],si		;;AN000;; Save DBCS Vector
 35868 000055B4 8C06[BB98]              	mov	word [$M_RT+$M_RES_ADDRS.$M_DBCS_VEC+2],es
 35869                                  	;mov	word [$M_RT+62],es		;;AN000;;
 35870                                  $MIF23:
 35871 000055B8 5E                      	pop	si				;;AN000;;
 35872 000055B9 58                      	pop	ax				;;AN000;; Retrieve character to check
 35873 000055BA C3                      	retn					;;AN000;; Return
 35874                                  
 35875                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35876                                  ;;
 35877                                  ;;  Proc Name:	SYSGETMSG
 35878                                  ;;
 35879                                  ;;  Function:	The GET service returns the segment, offset and size of the
 35880                                  ;;		message text to the caller based on a message number.
 35881                                  ;;		The GET function will not display the message thus assumes
 35882                                  ;;		caller will handle replaceable parameters.
 35883                                  ;;
 35884                                  ;;  Inputs:
 35885                                  ;;
 35886                                  ;;  Outputs:
 35887                                  ;;
 35888                                  ;;  Psuedocode:
 35889                                  ;;		Call $M_GET_MSG_ADDRESS
 35890                                  ;;		IF MSG_NUM exists THEN
 35891                                  ;;		   Set DS:SI = MSG_TXT_PTR + 1
 35892                                  ;;		   CARRY_FLAG = 0
 35893                                  ;;		ELSE
 35894                                  ;;		   CARRY_FLAG = 1
 35895                                  ;;		ENDIF
 35896                                  ;;
 35897                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35898                                  
 35899                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35900                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35901                                  
 35902                                  	utility_msg_class equ 0FFh ; 18/04/2023
 35903                                  
 35904                                  SYSGETMSG:
 35905                                  	;; Save registers needed later
 35906 000055BB 50                      	push	ax				;;AN000;; Save changed regs
 35907 000055BC 06                      	push	es				;;AN000;;
 35908 000055BD 57                      	push	di				;;AN000;;
 35909 000055BE 55                      	push	bp				;;AN000;;
 35910                                  
 35911 000055BF E81400                  	call	$M_GET_MSG_ADDRESS		;;AN000;; Scan thru classes to find message
 35912 000055C2 720D                    	jc	short $MIF31
 35913                                  	
 35914 000055C4 80FEFF                  	cmp	dh,utility_msg_class ; 0FFh	;;AN000;; Were utility messages requested?
 35915                                  	;clc					;;AN000;;
 35916 000055C7 7404                    	je	short $MIF32			;;AN000;;
 35917                                  	; 15/06/2023
 35918 000055C9 F8                      	clc	
 35919                                  
 35920 000055CA 06                      	push	es				;;AN000;;
 35921                                  	;pop	ds				;;AN000;;
 35922 000055CB EB01                    	jmp	short $MEN32
 35923                                  $MIF32:
 35924 000055CD 0E                      	push	cs				;;AN000;;			
 35925                                  	;pop	ds				;;AN000;;
 35926                                  $MEN32:
 35927                                  	; 07/04/2023
 35928 000055CE 1F                      	pop	ds
 35929 000055CF 89FE                    	mov	si,di				;;AN000;; Return message in DS:SI
 35930                                  $MIF31:
 35931 000055D1 5D                      	pop	bp				;;AN000;; Restore changed regs
 35932 000055D2 5F                      	pop	di				;;AN000;;
 35933 000055D3 07                      	pop	es				;;AN000;;
 35934 000055D4 58                      	pop	ax				;;AN000;;
 35935 000055D5 C3                      	retn					;;AN000;; Return
 35936                                  
 35937                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35938                                  ;;
 35939                                  ;;	PROC NAME: $M_GET_MSG_ADDRESS
 35940                                  ;;
 35941                                  ;;	FUNCTION:  To scan thru classes to return pointer to the message header
 35942                                  ;;	INPUTS:    Access to $M_RES_ADDRESSES
 35943                                  ;;	OUTPUTS:   IF CX = 0 THEN Message was not found
 35944                                  ;;		   IF CX > 1 THEN ES:DI points to the specified message
 35945                                  ;;	REGS CHANGED: ES,DI,CX
 35946                                  ;;
 35947                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 35948                                  
 35949                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 35950                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 35951                                  $M_GET_MSG_ADDRESS:
 35952 000055D6 56                      	push	si				;;AN000;;
 35953 000055D7 53                      	push	bx				;;AN000;;
 35954 000055D8 31F6                    	xor	si,si				;;AN000;; Use SI as an index
 35955 000055DA 31C9                    	xor	cx,cx				;;AN000;; Use CX as an size
 35956                                  $MDO36:
 35957 000055DC 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN000;; Were utility messages requested?
 35958 000055DF 7508                    	jne	short $MIF37			;;AN000;; No
 35959                                  
 35960                                  	; 07/04/2023
 35961                                  	;;mov	di,[si+89CAh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 35962 000055E1 8BBC[A998]              	mov	di,[si+$M_RT+$M_RES_ADDRS.$M_CLASS_ADDRS]
 35963                                  	;mov	di,[si+$M_RT+44]		;;AN000;; Get address of class
 35964 000055E5 89FB                    	mov	bx,di				;;AN000;;
 35965 000055E7 EB21                    	jmp	short $MEN37
 35966                                  $MIF37:
 35967 000055E9 F6C602                  	test	dh,2 ; parse_err_class		;;AN000;; Were parse errors requested?
 35968 000055EC 7406                    	jz	short $MIF39
 35969                                  	
 35970                                  	; 07/04/2023
 35971                                  	;;les	di,[si+89AEh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 35972 000055EE C4BC[8D98]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_PARSE_COMMAND]
 35973                                  	;les	di,[si+$M_RT+16]		;;AN000;; Get address of class
 35974                                  
 35975                                  	; 07/04/2023
 35976                                  	;mov	bx,es ; *			;;AN000;;
 35977 000055F2 EB14                    	jmp	short $MEN39
 35978                                  $MIF39:
 35979 000055F4 83F813                  	cmp	ax,19 ; $M_CRIT_LO		;;AN000;; Is this a critical error?
 35980 000055F7 720B                    	jnae	short $MIF41  ; jb short $MIF41 ;;AN000;;
 35981                                  
 35982 000055F9 83F827                  	cmp	ax,39 ; $M_CRIT_HI		;;AN000;;
 35983 000055FC 7706                    	jnbe	short $MIF41  ; ja short $MIF41 ;;AN000;;
 35984                                  
 35985                                  	; 07/04/2023
 35986                                  	;;les	di,[si+89BAh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 35987 000055FE C4BC[9998]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_CRIT_ADDRS]
 35988                                  	;les	di,[si+$M_RT+28]		;;AN000;; Get address of class
 35989                                  	
 35990                                  	; 07/04/2023
 35991                                  	;mov	bx,es ; *			;;AN000;;
 35992 00005602 EB04                    	jmp	short $MEN41
 35993                                  $MIF41:
 35994                                  	; 07/04/2023
 35995                                  	;;les	di,[si+899Eh] ; MSDOS 5.0 COMMAND.COM ($M_RT at offset 899Eh)
 35996 00005604 C4BC[7D98]              	les	di,[si+$M_RT+$M_RES_ADDRS.$M_EXT_ERR_ADDRS]
 35997                                  	;les	di,[si+$M_RT+0]			;;AN000;; Get address of class
 35998                                  	
 35999                                  	; 07/04/2023
 36000                                  	;mov	bx,es ; *			;;AN000;;
 36001                                  $MEN41:
 36002                                  $MEN39:
 36003                                  	; 07/04/2023
 36004 00005608 8CC3                    	mov	bx,es ; *
 36005                                  $MEN37:						;;AN000;;
 36006 0000560A 83FBFF                  	cmp	bx,-1 ; $M_TERMINATING_FLAG	;;AN000;; Are we finished all classes?
 36007 0000560D 7515                    	jne	short $MIF46			;;AN000;; No
 36008                                  
 36009 0000560F 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN000;; Was it a UTILITY class?
 36010 00005612 7503                    	jne	short $MIF47			;;AN000;; No
 36011 00005614 F9                      	stc		     ; **-		;;AN000;; Set the carry flag
 36012                                  	; 07/04/2023
 36013                                  	;jmp	short $MEN47 ; **-
 36014 00005615 EB1B                    	jmp	short $MEN36 ; **-
 36015                                  $MIF47:
 36016 00005617 A3[C598]                	mov	[$M_RT+$M_RES_ADDRS.$M_MSG_NUM],ax
 36017                                  	;mov	[$M_RT+72],ax			;;AN000;; Save message number
 36018 0000561A B8FFFF                  	mov	ax,0FFFFh ; $M_SPECIAL_MSG_NUM	;;AN000;; Set special message number
 36019 0000561D BD0100                  	mov	bp,1 ; $M_ONE_REPLACE		;;AN000;; Set one replace in message
 36020 00005620 31F6                    	xor	si,si				;;AN000;; Reset the SI index to start again
 36021                                  	; 28/04/2023
 36022                                  	; 07/04/2023
 36023                                  	;clc	; **+				;;AN000;;
 36024                                  ;$MEN47:
 36025                                  	;jmp	short $MEN46 ; ***
 36026 00005622 EB0A                    	jmp	short $MEN47 ; ***
 36027                                  $MIF46:
 36028                                  	;cmp	bx,0 ; $M_CLASS_NOT_EXIST	;;AN000;; Does this class exist?
 36029 00005624 21DB                    	and	bx,bx ; 0 ?
 36030 00005626 7403                    	jz	short $MIF51			;;AN000;; No
 36031                                  	
 36032 00005628 E84D00                  	call	$M_FIND_SPECIFIED_MSG		;;AN000;; Try to find the message
 36033                                  $MIF51:
 36034 0000562B 83C604                  	add	si,4 ; $M_ADDR_SZ_FAR 		;;AN000;; Get next class
 36035                                  	; 07/04/2023
 36036                                  	;clc					;;AN000;;
 36037                                  ;$MEN46:
 36038                                  	;jc	short $MEN36 ; **- ; **+	;;AN000;;
 36039                                  $MEN47:	; 07/04/2023	; **+
 36040 0000562E 09C9                    	or	cx,cx				;;AN000;; Was the message found?
 36041                                  	;jnz	short $MXL2			;;AN000;; Yes
 36042                                  	;jmp	short $MDO36
 36043                                  	; 07/04/2023
 36044 00005630 74AA                    	jz	short $MDO36	
 36045                                  $MXL2:
 36046                                  $MEN36:
 36047 00005632 9C                      	pushf 					;;AN006;; Save the flag state
 36048                                  	
 36049 00005633 80FE01                  	cmp	dh,1 ; EXT_ERR_CLASS		;;AN006;; Was an extended error requested?
 36050                                  	;jne	short $MIF56			;;AN006;; No
 36051                                  	; 28/04/2023
 36052 00005636 752A                    	jne	short $M_MYRET	
 36053                                  
 36054 00005638 52                      	push	dx				;;AN006;; Save all needed registers
 36055 00005639 55                      	push	bp				;;AN006;;
 36056 0000563A 51                      	push	cx				;;AN006;;
 36057 0000563B 06                      	push	es				;;AN006;;
 36058 0000563C 57                      	push	di				;;AN006;;
 36059 0000563D 50                      	push	ax				;;AN006;;
 36060                                  
 36061 0000563E B80005                  	mov	ax,500h ; IFSFUNC_INSTALL_CHECK	;;AN006;; Check if IFSFUNC is installed
 36062 00005641 CD2F                    	int	2Fh				;;AN006;;
 36063                                  		; Multiplex - DOS 3+ CRITICAL ERROR HANDLER - INSTALLATION CHECK
 36064                                  		; Return: AL = 00h not installed, OK to install
 36065                                  		; 01h not installed, can't install
 36066                                  		; FFh installed
 36067                                  
 36068 00005643 3CFF                    	cmp	al,0FFh ; IFSFUNC_INSTALLED	;;AN006;; Is it installed?
 36069 00005645 58                      	pop	ax				;;AN006;; Restore msg number
 36070 00005646 7513                    	jne	short $MIF57			;;AN006;; No (not installed)
 36071                                  
 36072 00005648 89C3                    	mov	bx,ax				;;AN006;; BX is the extended error number
 36073 0000564A B80205                  	mov	ax,502h ; IFS_GET_ERR_TEXT	;;AN006;; AX is the muliplex number
 36074 0000564D CD2F                    	int	2Fh				;;AN006;; Call IFSFUNC
 36075                                  		; Multiplex - DOS 3+ CRITICAL ERROR HANDLER
 36076                                  
 36077                                  	;jmp	short $MEN57			;;AN006;;
 36078                                  	; 28/04/2023
 36079 0000564F 720B                    	jc	short $MEN57
 36080                                  $MIF60:
 36081 00005651 83C406                  	add	sp,6				;;AN006;; Throw away old pointer
 36082 00005654 E81200                  	call	$M_SET_LEN_IN_CX		;;AN006;; Get the length of the ASCIIZ string
 36083                                  $MEN60:
 36084 00005657 5D                      	pop	bp				;;AN006;; Restore other Regs
 36085 00005658 5A                      	pop	dx				;;AN006;;
 36086                                  $MIF56:
 36087                                  	; 07/04/2023
 36088                                  	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36089 00005659 EB07                    	jmp	short $M_MYRET			;;AN006;; Restore the flag state
 36090                                  
 36091                                  $MIF57:
 36092 0000565B F9                      	stc					;;AN006;; Carry conditon
 36093                                  $MEN57:
 36094                                  	; 28/04/2023
 36095                                  	;jnc	short $MIF60			;;AN006;;
 36096                                  
 36097 0000565C 5F                      	pop	di				;;AN006;;
 36098 0000565D 07                      	pop	es				;;AN006;; Restore old pointer
 36099 0000565E 59                      	pop	cx				;;AN006;;
 36100 0000565F EBF6                    	jmp	short $MEN60
 36101                                  
 36102                                  ;$MIF60:
 36103                                  ;	add	sp,6				;;AN006;; Throw away old pointer
 36104                                  ;	call	$M_SET_LEN_IN_CX		;;AN006;; Get the length of the ASCIIZ string
 36105                                  ;$MEN60:
 36106                                  ;	pop	bp				;;AN006;; Restore other Regs
 36107                                  ;	pop	dx				;;AN006;;
 36108                                  ;$MIF56:
 36109                                  ;	; 07/04/2023
 36110                                  ;	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36111                                  ;	jmp	short $M_MYRET			;;AN006;; Restore the flag state
 36112                                  
 36113                                  ; 07/04/2023
 36114                                  ; ---------------------------
 36115                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 36116                                  ; ---------------------------
 36117                                  	; $M_POPF macro
 36118                                  	;jmp	short $+3
 36119                                  m_popf_iret:
 36120 00005661 CF                      	iret
 36121                                  $M_MYRET:
 36122 00005662 0E                      	push	cs
 36123 00005663 E8FBFF                  	call	m_popf_iret
 36124                                  	;;; end macro	
 36125                                  ; ---------------------------
 36126                                  
 36127 00005666 5B                      	pop	bx				;;AN000;;
 36128 00005667 5E                      	pop	si				;;AN000;;
 36129 00005668 C3                      	retn					;;AN000;; Return ES:DI pointing to the message
 36130                                  
 36131                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36132                                  
 36133                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36134                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36135                                  $M_SET_LEN_IN_CX:			
 36136 00005669 57                      	push	di				;;AN006;; Save position
 36137 0000566A 50                      	push	ax				;;AN006;;
 36138 0000566B B9FFFF                  	mov	cx,-1 ; 65535 ; 0FFFFh		;;AN006;; Set CX for decrements
 36139 0000566E 30C0                    	xor	al,al				;;AN006;; Prepare compare register
 36140 00005670 F2AE                    	repne	scasb				;;AN006;; Scan for zero
 36141 00005672 F7D1                    	not	cx				;;AN006;; Change decrement into number
 36142 00005674 49                      	dec	cx				;;AN006;; Don't include the zero
 36143 00005675 58                      	pop	ax				;;AN006;;
 36144 00005676 5F                      	pop	di				;;AN006;; Restore position
 36145 00005677 C3                      	retn					;;AN006;;
 36146                                  
 36147                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36148                                  ;;
 36149                                  ;;	PROC NAME: $M_FIND_SPECIFIED_MSG
 36150                                  ;;
 36151                                  ;;	FUNCTION:  To scan thru message headers until message is found
 36152                                  ;;	INPUTS:    ES:DI points to beginning of msg headers
 36153                                  ;;		   CX contains the number of messages in class
 36154                                  ;;		   DH contains the message class
 36155                                  ;;	OUPUTS:    IF CX = 0 THEN Message was not found
 36156                                  ;;		   IF CX > 1 THEN ES:DI points to header of specified message
 36157                                  ;;
 36158                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36159                                  
 36160                                  	; 07/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36161                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36162                                  $M_FIND_SPECIFIED_MSG:
 36163 00005678 83FB01                  	cmp	bx,1				;;AN004;; Do we have an address to CALL?
 36164 0000567B 751F                    	jne	short $MIF64
 36165 0000567D 833E[A598]FF            	cmp	word [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR],-1
 36166                                  	;cmp	word [$M_RT+40],-1 ; 0FFFFh	;;AN004;; Do we have an address to CALL?
 36167                                  	; 15/06/2023
 36168 00005682 7418                    	je	short $MIF64
 36169                                  
 36170 00005684 83F8FF                  	cmp	ax,0FFFFh ; $M_SPECIAL_MSG_NUM	;;AN004;; Are we displaying a default Ext Err?
 36171 00005687 750B                    	jne	short $MIF65
 36172                                  	
 36173 00005689 50                      	push	ax				;;AN004;; Reset the special message number
 36174 0000568A A1[C598]                	mov	ax,[$M_RT+$M_RES_ADDRS.$M_MSG_NUM]
 36175                                  	;mov	ax,[$M_RT+72]			;;AN004;; Get the old message number
 36176 0000568D FF1E[A598]              	call	far [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR]
 36177                                  						;;AN004;; Call the READ_DISK_PROC to get error text
 36178 00005691 58                      	pop	ax				;;AN004;; Reset the special message number
 36179                                  	; 28/04/2023
 36180 00005692 EB04                    	jmp	short $MEN65
 36181                                  	; 18/04/2023
 36182                                  	;jmp	short $MEN64
 36183                                  $MIF65:
 36184 00005694 FF1E[A598]              	call	far [$M_RT+$M_RES_ADDRS.$M_DISK_PROC_ADDR]
 36185                                  						;;AN004;; Call the READ_DISK_PROC to get error text
 36186                                  $MEN65:
 36187                                  	; 28/04/2023
 36188 00005698 7344                    	jnc	short $MIF75
 36189                                  	;
 36190 0000569A EB19                    	jmp	short $MEN64 ; $MDO76		;;AN004;;
 36191                                  $MIF64:
 36192 0000569C 31C9                    	xor	cx,cx				;;AN002;; CX = 0 will allow us to
 36193 0000569E 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;;
 36194 000056A1 7406                    	je	short $MIF69
 36195                                  	
 36196 000056A3 268A4D03                	mov	cl,[es:di+$M_CLASS_ID.$M_NUM_CLS_MSG]
 36197                                  	;mov	cl,[es:di+3]			;;AN001;; Get number of messages in class
 36198 000056A7 EB09                    	jmp	short $MEN69
 36199                                  $MIF69:
 36200                                  	;cmp	[cs:di+$M_CLASS_ID.$M_CLS_ID],dh
 36201                                  	;cmp	[cs:di+0],dh
 36202 000056A9 2E3835                  	cmp	[cs:di],dh			;;AN002;; Check if class still exists at
 36203 000056AC 7504                    	jne	short $MIF71
 36204                                  
 36205 000056AE 2E8A4D03                	mov	cl,[cs:di+$M_CLASS_ID.$M_NUM_CLS_MSG]
 36206                                  	;mov	cl,[cs:di+3]			;;AN000;; Get number of messages in class
 36207                                  $MIF71:						;;AN001;;
 36208                                  $MEN69:
 36209 000056B2 83C704                  	add	di,$M_CLASS_ID_SZ ; add di,4	;;AN000;; Point past the class header
 36210                                  	; 02/05/2023
 36211                                  	;stc					;;AN004;; Flag that we haven't found anything yet
 36212                                  $MEN64:
 36213                                  	;jnc	short $MIF75
 36214                                  	; 28/04/2023
 36215                                  	; (or instruction clears carry flag)
 36216                                  	;clc					;;AN004;; No, reset carry
 36217                                  $MDO76:
 36218 000056B5 09C9                    	or	cx,cx				;;AN000;; Do we have any to check?
 36219 000056B7 7417                    	jz	short $MEN76
 36220                                  
 36221 000056B9 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;;
 36222 000056BC 7405                    	je	short $MIF78
 36223                                  
 36224                                  	;cmp	ax,[es:di+$M_ID.$M_NUM]		;;AN001;; Is this the message requested?
 36225 000056BE 263B05                  	cmp	ax,[es:di]
 36226 000056C1 EB03                    	jmp	short $MEN78
 36227                                  $MIF78:
 36228                                  	;cmp	ax,[cs:di+$M_ID.$M_NUM]		;;AN000;; Is this the message requested?
 36229 000056C3 2E3B05                  	cmp	ax,[cs:di]
 36230                                  $MEN78:
 36231                                  	;jne	short $MIF76
 36232                                  	;jmp	short $MSR76
 36233                                  	; 07/04/2023
 36234 000056C6 740B                    	je	short $MSR76 ; *
 36235                                  $MIF76:
 36236 000056C8 49                      	dec	cx				;;AN000;; No, well do we have more to check?
 36237 000056C9 7405                    	jz	short $MEN76
 36238                                  
 36239 000056CB 83C704                  	add	di,$M_ID_SZ ; add di,4		;;AN000;; Yes, skip past msg header
 36240 000056CE EBE5                    	jmp	short $MDO76			;;AN000;;
 36241                                  $MEN76:
 36242 000056D0 F9                      	stc					;;AN000;;
 36243                                  ;$MSR76:	; 07/04/2023
 36244                                  	;jc	short $MIF86			;;AN000;;
 36245                                  	; 07/04/2023
 36246                                  	;jc	short $MIF91
 36247 000056D1 EB11                    	jmp	short $MIF91 ;*
 36248                                  $MSR76:	; 07/04/2023 ; *	
 36249 000056D3 80FEFF                  	cmp	dh,utility_msg_class ; -1	;;AN001;; Yes, is it a utility message?
 36250                                  	; 07/04/2023
 36251                                  	;clc					;;AN001;;
 36252 000056D6 7502                    	jne	short $MIF87
 36253                                  
 36254 000056D8 0E                      	push	cs				;;AN000;;
 36255 000056D9 07                      	pop	es				;;AN000;; Return ES:DI pointing to the message
 36256                                  $MIF87:
 36257                                  	;add	di,[es:di+2]
 36258 000056DA 26037D02                	add	di,[es:di+$M_ID.$M_TXT_PTR]     ;;AN000;; Prepare ES:DI pointing to the message
 36259                                  $MIF86:
 36260                                  ;$MIF75:
 36261                                  	; 02/05/2023
 36262                                  	;jc	short $MIF91
 36263                                  $MIF75:	; 28/04/2023
 36264 000056DE 30ED                    	xor	ch,ch				;;AN000;;
 36265 000056E0 268A0D                  	mov	cl,[es:di]			;;AN000;; Move size into CX
 36266 000056E3 47                      	inc	di				;;AN000;; Increment past length
 36267                                  $MIF91:
 36268 000056E4 C606[BF98]00            	mov	byte [$M_RT+$M_RES_ADDRS.$M_SIZE],0 ; $M_NULL
 36269                                  	;mov	byte [$M_RT+66],0		;;AN004;; Reset variable
 36270 000056E9 C3                      	retn					;;AN000;; Return
 36271                                  
 36272                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36273                                  ;;
 36274                                  ;;  Proc Name:	SYSDISPMSG
 36275                                  ;;
 36276                                  ;;  Function:	The DISPLAY service will output a defined message to a handle
 36277                                  ;;		requested by the caller. It also provides function to display
 36278                                  ;;		messages when handles are not applicable (ie. DOS function calls
 36279                                  ;;		00h to 0Ah) Replaceable parameters are allowed and are
 36280                                  ;;		defined previous to entry.
 36281                                  ;;
 36282                                  ;;		It is assumes that a PRELOAD function has already determined
 36283                                  ;;		the addressibilty internally to the message retriever services.
 36284                                  ;;  Inputs:
 36285                                  ;;
 36286                                  ;;  Outputs:
 36287                                  ;;
 36288                                  ;;  Psuedocode:
 36289                                  ;;		Save registers needed later
 36290                                  ;;		Get address of the message requested
 36291                                  ;;		IF Message number exists THEN
 36292                                  ;;		  IF replacable parameters were specified THEN
 36293                                  ;;		     Display message with replacable parms
 36294                                  ;;		  ELSE
 36295                                  ;;		     Display string without replacable parms
 36296                                  ;;		  ENDIF
 36297                                  ;;		  IF character input was requested THEN
 36298                                  ;;		     Wait for character input
 36299                                  ;;		  ENDIF
 36300                                  ;;		  Clear CARRY FLAG
 36301                                  ;;		ELSE
 36302                                  ;;		   Set CARRY FLAG
 36303                                  ;;		ENDIF
 36304                                  ;;		Return
 36305                                  ;;
 36306                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36307                                  
 36308                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36309                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5307h
 36310                                  	;
 36311                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36312                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5ACBh
 36313                                  SYSDISPMSG:
 36314                                  	;; Save registers and values needed later
 36315 000056EA 50                      	push	ax				;;AN000;; Save changed REGs
 36316 000056EB 53                      	push	bx				;;AN000;;
 36317 000056EC 51                      	push	cx				;;AN000;;
 36318 000056ED 55                      	push	bp				;;AN000;;
 36319 000056EE 57                      	push	di				;;AN000;; Save pointer to input buffer (offset)
 36320 000056EF 06                      	push	es				;;AN000;; Save pointer to input buffer (segment)
 36321 000056F0 52                      	push	dx				;;AN000;; Save Input/Class request
 36322                                  
 36323 000056F1 89CD                    	mov	bp,cx				;;AN000;; Use BP to hold replace count
 36324 000056F3 891E[BD98]              	mov	[$M_RT+$M_RES_ADDRS.$M_HANDLE],bx
 36325                                  	;mov	[$M_RT+64],bx			;;AN000;; Save handle
 36326 000056F7 8836[C298]              	mov	[$M_RT+$M_RES_ADDRS.$M_CLASS],dh
 36327                                  	;mov	[$M_RT+69],dh			;;AN004;; Save class
 36328                                  
 36329                                  	;; Get address of the message requested
 36330 000056FB E8D8FE                  	call	$M_GET_MSG_ADDRESS		;;AN000;; Scan thru classes to find message
 36331                                  
 36332 000056FE 09C9                    	or	cx,cx				;;AN000;; Was message found?
 36333 00005700 7427                    	jz	short $MIF93
 36334                                  						;;AN000;; Yes, Message address in ES:DI
 36335                                  	
 36336                                  	;; Test if replacable parameters were specified
 36337 00005702 09ED                    	or	bp,bp				;;AN000;; Were replacable parameters requested
 36338 00005704 7505                    	jnz	short $MIF94
 36339                                  
 36340                                  	;; Display string without replacable parms
 36341 00005706 E82800                  	call	$M_DISPLAY_STRING		;;AN000;; No, great . . . Display message
 36342 00005709 EB03                    	jmp	short $MEN94
 36343                                  $MIF94:
 36344                                  	;; Display message with replacable parms
 36345 0000570B E88B01                  	call	$M_DISPLAY_MESSAGE		;;AN000;; Display the message with substitutions
 36346                                  $MEN94:
 36347 0000570E 7214                    	jc	short $MIF97
 36348 00005710 5A                      	pop	dx				;;AN000;; Get Input/Class request
 36349 00005711 E8FC00                  	call	$M_ADD_CRLF 			;;AN004;; Check if we need to add the CR LF chars.
 36350 00005714 07                      	pop	es				;;AN000;; Get location of input buffer (if specified)
 36351 00005715 5F                      	pop	di				;;AN000;;
 36352                                  	
 36353                                  ; 15/06/2023 - MSDOS 5.0
 36354                                  ;	;jmp	short $MEN97 ; ***
 36355                                  ;	; 08/04/2023
 36356                                  ;	;jmp	short $MEN93 ; **
 36357                                  ;
 36358                                  ;	; 08/04/2023
 36359                                  ;;$MEN93:
 36360                                  ;	jc	short $MIF104
 36361                                  
 36362                                  	; 15/06/2023 Retro DOS v4.2 COMMAND.COM
 36363                                   	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5AF7h
 36364                                  
 36365                                  	; MSDOS 6.0 (MSDOS 6.22)
 36366                                  	; Test if character input was requested	;;AN000;;
 36367 00005716 08D2                    	or	dl,dl
 36368 00005718 7403                    	jz	short $MIF98
 36369                                  	;jz	short $MEN98 ; *
 36370                                  
 36371 0000571A E88E05                  	call	$M_WAIT_FOR_INPUT	; MSDOS 6.0 (to 6.22)
 36372                                  	; cf = 0 ; *
 36373                                  $MIF98:
 36374                                  	;jmp	short $MEN97
 36375                                  	;;jc	short $MIF104 ; *
 36376                                  $MEN98:
 36377                                  ;$MEN97:
 36378 0000571D 5D                      	pop	bp				;;AN000;;
 36379 0000571E 59                      	pop	cx				;;AN000;;
 36380 0000571F 5B                      	pop	bx				;;AN000;;
 36381                                  	; 15/06/2023
 36382                                  	;pop	ax	; MSDOS 5.0		;;AN000;;
 36383 00005720 83C402                  	add	sp,2	; MSDOS 6.0 (to 6.22)
 36384 00005723 C3                      	retn
 36385                                   
 36386                                  $MIF97:
 36387                                  	; 08/04/2023
 36388                                  	;add	sp,6				;;AN000;;
 36389                                  	;stc					;;AN000;; Reset carry flag
 36390                                  ;$MEN97: ; ***
 36391                                  	;jmp	short $MEN93
 36392                                  	; 08/04/2023
 36393                                  	;jmp	short $MIF104
 36394                                  	; 08/04/2023
 36395 00005724 83C40E                  	add	sp,14 ; 6+8
 36396 00005727 F9                      	stc
 36397 00005728 C3                      	retn
 36398                                  $MIF93:
 36399                                  	; 08/04/2023 - 15/06/2023
 36400                                  	; (wrong pops ?) - correct order: pop dx, pop es, pop di -
 36401                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:533Bh
 36402                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5B06h
 36403 00005729 07                      	pop	es				;;AN000;; Get pointer to input buffer (segment)
 36404 0000572A 5F                      	pop	di				;;AN000;; Get base pointer to first sublist (offset)
 36405 0000572B 5A                      	pop	dx				;;AN000;; Get base pointer to first sublist (segment)
 36406                                  	;stc	; * 				;;AN000;; Set carry flag
 36407                                  	; 08/04/2023
 36408                                  	;jmp	short $MIF104 ; *
 36409                                  
 36410                                  ;$MEN93: ; **
 36411                                  ;	jc	short $MIF104
 36412                                  ;$MEN97: ; 08/04/2023
 36413                                  ;	pop	bp				;;AN000;;
 36414                                  ;	pop	cx				;;AN000;;
 36415                                  ;	pop	bx				;;AN000;;
 36416                                  ;	pop	ax				;;AN000;;
 36417                                  ;	;jmp	short $MEN104
 36418                                  ;	; 08/04/2023
 36419                                  ;	retn
 36420                                  
 36421                                  $MIF104: ; *
 36422 0000572C 83C408                  	add	sp,8				;;AN000;; Eliminate from stack
 36423 0000572F F9                      	stc					;;AN000;;
 36424                                  $MEN104:
 36425 00005730 C3                      	retn					;;AN000;; Return
 36426                                  
 36427                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36428                                  ;;
 36429                                  ;;	PROC NAME: $M_DISPLAY_STRING
 36430                                  ;;
 36431                                  ;;	FUNCTION:  Will display or write string
 36432                                  ;;	INPUTS:    ES:DI points to beginning of message
 36433                                  ;;		   CX contains the length of string to write (if applicable)
 36434                                  ;;	OUTPUTS:   None
 36435                                  ;;	REGS Revised: None
 36436                                  ;;
 36437                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36438                                  
 36439                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36440                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36441                                  $M_DISPLAY_STRING:
 36442 00005731 50                      	push	ax				;;AN000;;
 36443 00005732 53                      	push	bx				;;AN000;;
 36444 00005733 52                      	push	dx				;;AN000;;
 36445 00005734 8B1E[BD98]              	mov	bx,[$M_RT+$M_RES_ADDRS.$M_HANDLE]
 36446                                  	;mov	bx,[$M_RT+64]			;;AN000;; Retrieve handle
 36447                                  	
 36448 00005738 83FBFF                  	cmp	bx,0FFFFh ; $M_NO_HANDLE 	;;AN000;; Was there a handle specified?
 36449 0000573B 7505                    	jne	short $MIF107
 36450                                  
 36451 0000573D E82600                  	call	$M_DISPLAY_$_STRING		;;AN000;; No, display $ terminated string
 36452 00005740 EB03                    	jmp	short $MEN107
 36453                                  $MIF107:
 36454 00005742 E86E00                  	call	$M_DISPLAY_H_STRING		;;AN000;; Yes, display string to handle
 36455                                  $MEN107:
 36456 00005745 730D                    	jnc	short $MIF110
 36457                                  	
 36458 00005747 B459                    	mov	ah,59h	; DOS_GET_EXT_ERROR	;;AN000;;
 36459                                  	;mov	bx,0	; DOS_GET_EXT_ERROR_BX	;;AN000;; Get extended error
 36460                                  	; 08/04/2023
 36461 00005749 31DB                    	xor	bx,bx
 36462 0000574B CD21                    	int	21h				;;AN000;;
 36463                                  		; DOS - 3+ - GET EXTENDED ERROR CODE
 36464                                  		; BX = version code (0000h for DOS 3.x)
 36465 0000574D 30E4                    	xor	ah,ah				;;AN000;; Clear AH
 36466                                  $MEN110: ; 08/04/2023 ; ***
 36467 0000574F 83C406                  	add	sp,6				;;AN000;; Clean up stack
 36468 00005752 F9                      	stc					;;AN000;; Flag that there was an error
 36469                                  	;jmp	short $MEN110 ; ****
 36470                                  	; 08/04/2023
 36471 00005753 C3                      	retn
 36472                                  $MIF110:
 36473                                  	;cmp	bx,$M_NO_HANDLE
 36474 00005754 83FBFF                  	cmp	bx,0FFFFh ; $M_NO_HANDLE	;;AN000;; Was there a handle specified?
 36475 00005757 7409                    	je	short $MIF112 ; *  ; cf = 0
 36476 00005759 39C8                    	cmp	ax,cx				;;AN001;; Was it ALL written?
 36477 0000575B 7405                    	je	short $MIF113 ; ** ; cf = 0
 36478 0000575D E8A700                  	call	$M_GET_EXT_ERR_39		;;AN001;; Set Extended error
 36479                                  	;add	sp,6				;;AN001;; Clean up stack
 36480                                  	;stc					;;AN001;; Flag that there was an error
 36481                                  	; 08/04/2023
 36482 00005760 EBED                    	jmp	short $MEN110 ; ***
 36483                                  	; 08/04/2023
 36484                                  ;$MIF112:
 36485                                  ;$MEN110: ; ****
 36486                                  	;jc	short $MIF117
 36487                                  $MIF112: ; 08/04/2023	; *
 36488                                  $MIF113:	; **
 36489 00005762 5A                      	pop	dx				;;AN000;; Restore regs
 36490 00005763 5B                      	pop	bx				;;AN000;;
 36491 00005764 58                      	pop	ax				;;AN000;;
 36492                                  $MIF117:
 36493 00005765 C3                      	retn
 36494                                  
 36495                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36496                                  ;;
 36497                                  ;;	PROC NAME: $M_DISPLAY_$_STRING
 36498                                  ;;
 36499                                  ;;	FUNCTION:  Will display a $ terminated string
 36500                                  ;;	INPUTS:    ES:DI points to beginning of message text (not the length)
 36501                                  ;;	OUTPUTS:   None
 36502                                  ;;	REGS USED: AX,DX
 36503                                  ;;
 36504                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36505                                  
 36506                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36507                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36508                                  $M_DISPLAY_$_STRING:
 36509 00005766 1E                      	push	ds				;;AN000;;
 36510 00005767 06                      	push	es				;;AN000;;
 36511 00005768 1F                      	pop	ds				;;AN000;; Set DS to segment of message text
 36512                                  
 36513                                  	; 08/04/2023
 36514 00005769 B402                    	mov	ah,2 ; DOS_DISP_CHAR
 36515                                  
 36516                                  	;cmp	cx,$M_SINGLE_CHAR		;;AN000;; Is this a single character?
 36517 0000576B 83F901                  	cmp	cx,1 ; $M_SINGLE_CHAR
 36518 0000576E 7518                    	jne	short $MIF119			;;AN000;; No
 36519                                  	
 36520                                  	;mov	ah,2 ; DOS_DISP_CHAR		;;AN000;; DOS Function to display CHARACTER
 36521 00005770 268A15                  	mov	dl,[es:di]			;;AN000;; Get the character
 36522 00005773 CD21                    	int	21h				;;AN000;; Write character
 36523                                  		; DOS - DISPLAY OUTPUT
 36524                                  		; DL = character to send to standard output
 36525 00005775 1F                      	pop	ds				;;AN000;;
 36526 00005776 88D0                    	mov	al,dl				;;AN000;; Get the character in AL
 36527 00005778 E8AC00                  	call	$M_IS_IT_DBCS 			;;AN000;; Is this the first byte of a DB character
 36528 0000577B 1E                      	push	ds				;;AN000;;
 36529 0000577C 06                      	push	es				;;AN000;;
 36530 0000577D 1F                      	pop	ds				;;AN000;; Set DS to segment of message text
 36531 0000577E 7316                    	jnc	short $MIF120 ; *
 36532                                  
 36533 00005780 268A5501                	mov	dl,[es:di+1]			;;AN000;; Get the next character
 36534 00005784 CD21                    	int	21h				;;AN000;; Write character
 36535                                  		; DOS - DISPLAY OUTPUT
 36536                                  		; DL = character to send to standard output
 36537                                  	; 08/04/2023
 36538                                  	;clc					;;AN000;; Clear the DBCS indicator
 36539                                  ;$MIF120:
 36540 00005786 EB0D                    	jmp	short $MEN119
 36541                                  $MIF119:
 36542                                  	; 08/04/2023
 36543                                  	;mov	ah,2 ; DOS_DISP_CHAR		;;AN000;; DOS Function to display CHARACTER
 36544                                  ;$MDO123:
 36545 00005788 09C9                    	or	cx,cx				;;AN002;; Are there any left to display?
 36546                                  	;jz	short $MEN123
 36547                                  	; 18/04/2023
 36548 0000578A 740A                    	jz	short $MIF120 ; cf = 0
 36549                                  $MDO123: ; 08/04/2023
 36550 0000578C 268A15                  	mov	dl,[es:di]			;;AN002;; Get the character
 36551 0000578F CD21                    	int	21h				;;AN002;; Display the character
 36552                                  		; DOS - DISPLAY OUTPUT
 36553                                  		; DL = character to send to standard output
 36554 00005791 47                      	inc	di				;;AN002;; Set pointer to next character
 36555 00005792 49                      	dec	cx				;;AN002;; Count this character
 36556 00005793 75F7                    	jnz	short $MDO123
 36557                                  ;$MEN123:
 36558                                  $MEN119:
 36559 00005795 F8                      	clc					;;AN000;;Char functions used don't return carry as error
 36560                                  $MIF120: ; 08/04/2023 ; *
 36561 00005796 1F                      	pop	ds				;;AN000;;
 36562 00005797 C3                      	retn
 36563                                  
 36564                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36565                                  ;;
 36566                                  ;; Scan_ctrlZ: This routine looks through the string to be printed and 
 36567                                  ;; truncates it at the Ctrl-Z if any present.
 36568                                  ;;
 36569                                  ;;	ENTRY:	ds:dx = String to be displayed
 36570                                  ;;		cx = number of chars to be displayed
 36571                                  ;;
 36572                                  ;;	EXIT:	cx = number of chars to be displayed
 36573                                  ;;
 36574                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36575                                  
 36576                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36577                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36578                                  scan_ctrlz:
 36579 00005798 57                      	push	di
 36580 00005799 50                      	push	ax
 36581 0000579A 06                      	push	es
 36582 0000579B 53                      	push	bx
 36583                                  
 36584 0000579C 89D7                    	mov	di,dx
 36585 0000579E 1E                      	push	ds
 36586 0000579F 07                      	pop	es   			;es:di points at string
 36587                                  
 36588 000057A0 89CB                    	mov	bx,cx			;save current count
 36589                                  
 36590 000057A2 B01A                    	mov	al,1Ah	; Ctrl-Z
 36591 000057A4 FC                      	cld
 36592 000057A5 F2AE                    	repne	scasb			;find first Ctrl-Z
 36593 000057A7 7503                    	jnz	short noCtrlZ		;no CtrlZ found in string
 36594                                  
 36595 000057A9 29CB                    	sub	bx,cx
 36596 000057AB 4B                      	dec	bx			;bx = new count to display
 36597                                  noCtrlZ:
 36598 000057AC 89D9                    	mov	cx,bx			;cx = actual display count
 36599                                  
 36600 000057AE 5B                      	pop	bx
 36601 000057AF 07                      	pop	es
 36602 000057B0 58                      	pop	ax
 36603 000057B1 5F                      	pop	di
 36604                                  $MIF127:	; 08/04/2023
 36605 000057B2 C3                      	retn
 36606                                  
 36607                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36608                                  ;;
 36609                                  ;;	PROC NAME: $M_DISPLAY_H_STRING
 36610                                  ;;
 36611                                  ;;	FUNCTION:  Will display a string to a specified handle
 36612                                  ;;	INPUTS:    ES:DI points to beginning of message
 36613                                  ;;		   CX contains the number of bytes to write
 36614                                  ;;		   BX contains the handle to write to
 36615                                  ;;	OUPUTS:    None
 36616                                  ;;	REGS USED: AX,DX
 36617                                  ;;
 36618                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36619                                  
 36620                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36621                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36622                                  $M_DISPLAY_H_STRING:
 36623 000057B3 31C0                    	xor	ax,ax			;;AN002;; Set number of bytes written to 0
 36624 000057B5 09C9                    	or	cx,cx			;;AN002;; For performance, don't write if not necessary
 36625 000057B7 74F9                    	jz	short $MIF127
 36626                                  	
 36627 000057B9 1E                      	push	ds			;;AN000;;
 36628 000057BA 06                      	push	es			;;AN000;;
 36629 000057BB 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36630                                  	
 36631 000057BC B440                    	mov	ah,40h ; DOS_WRITE_HANDLE ;;AN000;; DOS function to write to a handle
 36632 000057BE 89FA                    	mov	dx,di			;;AN000;; Pointer to data to write
 36633                                  
 36634 000057C0 83F901                  	cmp	cx,1 ; $M_SINGLE_CHAR	;;AN000;; Is this a single character?
 36635 000057C3 7528                    	jne	short $MIF128		;;AN000;; No
 36636                                  
 36637 000057C5 CD21                    	int	21h			;;AN000;; Write character
 36638                                  		; DOS - 2+ - WRITE TO FILE WITH HANDLE
 36639                                  		; BX = file handle, CX = number of bytes to writ
 36640                                  
 36641 000057C7 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36642 000057C8 50                      	push	ax			;;AN000;;
 36643 000057C9 268A05                  	mov	al,[es:di] 		;;AN000;; Get the character
 36644 000057CC E85800                  	CALL    $M_IS_IT_DBCS		;;AN000;; Is this the first byte of a DB character
 36645 000057CF 58                      	pop	ax			;;AN000;;
 36646 000057D0 1E                      	push	ds			;;AN000;;
 36647 000057D1 06                      	push	es			;;AN000;;
 36648 000057D2 1F                      	pop	ds			;;AN000;; Set DS to segment of message text
 36649 000057D3 7306                    	jnc	short $MIF129
 36650                                  	
 36651 000057D5 F8                      	clc				;;AN000;; Clear the DBCS indicator
 36652 000057D6 B440                    	mov	ah,40h ; DOS_WRITE_HANDLE ;;AN000;; DOS function to write to a handle
 36653 000057D8 42                      	inc	dx			;;AN000;; Point to next character
 36654 000057D9 CD21                    	int	21h			;;AN000;; Write character
 36655                                  		; DOS - 2+ - WRITE TO FILE WITH HANDLE
 36656                                  		; BX = file handle, CX = number of bytes to write, 
 36657                                  $MIF129:
 36658                                  ;SR;
 36659                                  ; If the single char happened to be a Ctrl-Z, the dos write would return
 36660                                  ;0 chars written making the caller think there was an error writing. To 
 36661                                  ;avoid this, we check if the single char was a Ctrl-Z and if so, return that
 36662                                  ;the char was written, thus fooling the caller.
 36663                                  
 36664 000057DB 9C                      	pushf				;save flags
 36665 000057DC 26803D1A                	cmp	byte [es:di],1Ah	;is char a Ctrl-Z?
 36666 000057E0 7502                    	jne	short m_popf_j		;no, continue
 36667                                  
 36668 000057E2 89C8                    	mov	ax,cx			;yes, fake as if it was written
 36669                                  m_popf_j:
 36670                                  	; 08/04/2023
 36671                                  	;$M_POPF  ; macro in 'sysmsg.inc' (MSDOS 6.0)
 36672 000057E4 EB01                    	jmp	short m_popf		;restore flags
 36673                                  
 36674                                  ; 07/04/2023
 36675                                  ; ---------------------------
 36676                                  ; MSDOS 6.0, SYSMSG.INC, 1991
 36677                                  ; ---------------------------
 36678                                  	; $M_POPF macro
 36679                                  	;jmp	short $+3
 36680                                  intret:
 36681 000057E6 CF                      	iret
 36682                                  m_popf:
 36683 000057E7 0E                      	push	cs
 36684 000057E8 E8FBFF                  	call	intret
 36685                                  	;;; end macro	
 36686                                  ; ---------------------------
 36687                                  
 36688 000057EB EB18                    	jmp	short $MEN128
 36689                                  
 36690                                  $MIF128:
 36691                                  ;SR;
 36692                                  ; Prescan the string looking for Ctrl-Z. We terminate the message the moment 
 36693                                  ;we hit a Ctrl-Z. cx will contain the number of characters to be printed.
 36694                                  
 36695 000057ED 55                      	push	bp			; M007
 36696 000057EE 51                      	push	cx
 36697 000057EF E8A6FF                  	call	scan_ctrlz		;cx = count without Ctrl-Z
 36698 000057F2 89CD                    	mov	bp,cx			;store no ^Z count in bp ;M007
 36699 000057F4 59                      	pop	cx			;get old count back ;M007
 36700                                  	
 36701 000057F5 CD21                    	int	21h			;;AN000;; Write String at DS:SI to handle
 36702                                  	;jnc	short chk_count		;no error, adjust return count
 36703                                  	;jmp	short m_cnt_ok		;error, return with carry set;M007
 36704                                  	; 08/04/2023
 36705 000057F7 720B                    	jc	short m_cnt_ok 
 36706                                  ;M007
 36707                                  ; If we are writing to con and there is a Ctrl-Z in the string, the
 36708                                  ;return count will be much less and if this returns to the caller we can get
 36709                                  ;spurious error messages. We check here if the count returned is same as
 36710                                  ;original count or same as the count if we stop at Ctrl-Z. In the second
 36711                                  ;case, we fake it as if all bytes have been written. If the return count
 36712                                  ;does not match either count, then we had some other disk error (such as
 36713                                  ;insufficient disk space) and we pass it through
 36714                                  
 36715                                  chk_count:
 36716 000057F9 39C1                    	cmp	cx,ax			;have all bytes been written?;M007
 36717 000057FB 7407                    	je	short m_cnt_ok		;there was an error writing ;M007
 36718 000057FD 39C5                    	cmp	bp,ax			;count = Ctrl-Z count? ;M007
 36719 000057FF F8                      	clc				;no error either way ;M007
 36720 00005800 7502                    	jne	short m_cnt_ok		;no, pass it through ;M007
 36721 00005802 89C8                    	mov	ax,cx			;return old count ;M007
 36722                                  m_cnt_ok:				; M007
 36723 00005804 5D                      	pop	bp			; M007
 36724                                  $MEN128:
 36725 00005805 1F                      	pop	ds			;;AN000;;
 36726                                  ;$MIF127: ; 08/04/2023
 36727 00005806 C3                      	retn
 36728                                  
 36729                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36730                                  ;;
 36731                                  ;;	PROC NAME: $M_GET_EXT_ERR_39
 36732                                  ;;
 36733                                  ;;	FUNCTION:  Will set registers for extended error #39
 36734                                  ;;	INPUTS:    None
 36735                                  ;;	OUPUTS:    AX,BX,CX set
 36736                                  ;;	REGS USED:
 36737                                  ;;
 36738                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36739                                  
 36740                                  	; 08/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36741                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:542Dh
 36742                                  
 36743                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36744                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5BFAh
 36745                                  
 36746                                  $M_GET_EXT_ERR_39:
 36747 00005807 B82700                  	mov	ax,27h ; EXT_ERR_39	;AN001; Set AX=39
 36748                                  	;mov	bx,(ERROR_CLASS_39 SHR 8) + ACTION_39
 36749 0000580A BB0400                  	mov	bx,4			;AN001; Set BH=1 BL=4
 36750                                  	;mov	ch,LOCUS_39		;AN001; Set CH=1
 36751 0000580D B501                    	mov	ch,1			;AN001;
 36752 0000580F C3                      	retn				;AN001;
 36753                                  
 36754                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36755                                  ;;
 36756                                  ;;	PROC NAME: $M_ADD_CRLF
 36757                                  ;;
 36758                                  ;;	FUNCTION:  Will decide whether to display a CRLF
 36759                                  ;;	INPUTS:    DX contains the Input/Class requested
 36760                                  ;;	OUTPUTS:   None
 36761                                  ;;	REGS Revised: CX,ES,DI
 36762                                  ;;
 36763                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36764                                  
 36765                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36766                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36767                                  $M_ADD_CRLF:
 36768                                  	;cmp	dh,0FFh
 36769 00005810 80FEFF                  	cmp	dh,utility_msg_class	;;AN004;; Is it a utility message?
 36770 00005813 7411                    	je	short $MIF134		;;AN004;; Yes
 36771 00005815 F6C680                  	test	dh,80h; $M_NO_CRLF_MASK	;;AN004;; Are we to supress the CR LF?
 36772 00005818 750C                    	jnz	short $MIF135
 36773                                  					;;AN004;; No	
 36774 0000581A 1E                      	push	ds			;;AN004;;
 36775 0000581B 07                      	pop	es			;;AN004;; Set ES to data segment
 36776 0000581C 8D3E[C098]              	lea	di,[$M_RT+$M_RES_ADDRS.$M_CRLF]
 36777                                  	;lea	di,[$M_RT+67]		;;AN004;; Point at CRLF message
 36778 00005820 B90200                  	mov	cx,2 ; $M_CRLF_SIZE	;;AN004;; Set the message size
 36779 00005823 E80BFF                  	call	$M_DISPLAY_STRING	;;AN004;; Display the CRLF
 36780                                  $MIF135:
 36781                                  $MIF134:
 36782 00005826 C3                      	retn				;;AN004;; Return
 36783                                  
 36784                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36785                                  ;;
 36786                                  ;;	PROC NAME: $M_IS_IT_DBCS
 36787                                  ;;
 36788                                  ;;	FUNCTION:  Will decide whether character is Single or Double Byte
 36789                                  ;;	INPUTS:    AL contains the byte to be checked
 36790                                  ;;	OUTPUTS:   Carry flag = 0 if byte is NOT in DBCS range
 36791                                  ;;		   Carry flag = 1 if byte IS in DBCS range
 36792                                  ;;	REGS USED: All restored
 36793                                  ;;
 36794                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36795                                  
 36796                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36797                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36798                                  $M_IS_IT_DBCS:
 36799 00005827 06                      	push	es			;;AN000;; Save Extra Segment register
 36800 00005828 57                      	push	di			;;AN000;; Save DI register
 36801                                  
 36802 00005829 C43E[B998]              	les	di,[$M_RT+$M_RES_ADDRS.$M_DBCS_VEC]
 36803                                  	;les	di,[$M_RT+60]		;;AN000;;
 36804 0000582D 09FF                    	or	di,di			;;AN000;; Was the DBCS vector set?
 36805 0000582F 7417                    	jz	short $MIF138		;;AN000;; No
 36806                                  $MDO139:
 36807 00005831 26833D00                	cmp	word [es:di],0 ; $M_DBCS_TERM
 36808                                  					;;AN000;; Is this the terminating flag?
 36809 00005835 F8                      	clc				;;AN000;;
 36810 00005836 7410                    	jz	short $MEN139
 36811                                  					;;AN000;; No
 36812 00005838 263A05                  	cmp	al,[es:di]		;;AN000;; Does the character fall in the DBCS range?
 36813 0000583B 7207                    	jnae	short $MIF141 ; jb	;;AN000;; No		
 36814 0000583D 263A4501                	cmp	al,[es:di+1]		;;AN000;; Does the character fall in the DBCS range?
 36815 00005841 7701                    	jnbe	short $MIF141 ; ja	;;AN000;; No
 36816                                  					;;AN000;; Yes
 36817 00005843 F9                      	stc				;;AN000;; Set carry flag
 36818                                  $MIF141:
 36819 00005844 47                      	inc	di			;;AN000;;
 36820 00005845 47                      	inc	di			;;AN000;;
 36821 00005846 EBE9                    	jmp	short $MDO139		;;AN000;; Go to next vector
 36822                                  $MEN139:
 36823                                  $MIF138:
 36824 00005848 5F                      	pop	di			;;AN000;; Restore DI register
 36825 00005849 07                      	pop	es			;;AN000;; Restore Extra Segment register
 36826 0000584A C3                      	retn				;;AN000;; Return
 36827                                  
 36828                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36829                                  ;;
 36830                                  ;;	PROC NAME: $M_CONVERT2ASC
 36831                                  ;;
 36832                                  ;;	FUNCTION: Convert a binary number to a ASCII string
 36833                                  ;;	INPUTS: DX:AX contains the number to be converted
 36834                                  ;;		$M_RT_DIVISOR contains the divisor
 36835                                  ;;	OUTPUTS: CX contains the number of characters
 36836                                  ;;		Top of stack  --> Last character
 36837                                  ;;				     . . .
 36838                                  ;;		Bot of stack  --> First character
 36839                                  ;;	REGS USED:
 36840                                  ;;
 36841                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36842                                  
 36843                                  	; 09/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36844                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36845                                  $M_CONVERT2ASC:
 36846 0000584B 8F06[C398]              	pop	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 36847                                  	;pop	word [$M_RT+70]			;;AN000;; Save Return Address
 36848                                  	
 36849 0000584F 31DB                    	xor	bx,bx				;;AN000;; Use BX as a swapping register
 36850 00005851 93                      	xchg	bx,ax				;;AN000;; Initialize - Low Word in BX
 36851 00005852 92                      	xchg	ax,dx				;;AN000;;	  - High Word in AX
 36852                                  $MDO145:					;;AN000;; DO UNTIL Low Word becomes zero
 36853 00005853 F736[C798]              	div	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR]
 36854                                  	;div	word [$M_RT+74]			;;AN000;; Divide High Word by divisor
 36855 00005857 93                      	xchg	bx,ax				;;AN000;; Setup to divide Low Word using remainder
 36856                                  						;;AN000;;  and save reduced High Word in BX
 36857 00005858 F736[C798]              	div	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR]
 36858                                  	;div	word [$M_RT+74]			;;AN000;; Divide Low Word by divisor
 36859                                  
 36860 0000585C 83FA09                  	cmp	dx,9				;;AN000;; Make a digit of the remainder
 36861 0000585F 7605                    	jna	short $MIF146			;;AN000;; 0-9
 36862 00005861 80C237                  	add	dl,55	; add dl,37h		;;AN000;; Make A to F ASCII
 36863 00005864 EB03                    	jmp	short $MEN146
 36864                                  $MIF146:
 36865 00005866 80C230                  	add	dl,'0'				;;AN000;; Make 0 to 9 ASCII
 36866                                  $MEN146:
 36867 00005869 52                      	push	dx				;;AN000;; Save the digit on the stack
 36868 0000586A 41                      	inc	cx				;;AN000;; Count that digit
 36869 0000586B 09C0                    	or	ax,ax				;;AN000;; Are we done?
 36870 0000586D 7504                    	jnz	short $MLL149			;;AN000;; No
 36871 0000586F 09DB                    	or	bx,bx				;;AN000;; AX and BX must be ZERO!!
 36872 00005871 741F                    	jz	short $MEN145 ; * ; ax = 0	;;AN000;; Yes
 36873                                  $MLL149:
 36874 00005873 83F903                  	cmp	cx,3 ; $M_FIRST_THOU		;;AN000;; Are we at the first thousands mark
 36875                                  ; 28/04/2023
 36876 00005876 740A                    	je	short $MIF153
 36877                                  ;	jne	short $MIF150			;;AN000;; No
 36878                                  ;	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 36879                                  ;	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','	
 36880                                  ;	;cmp	byte [si+0Ah],',' ; $M_COMMA
 36881                                  ;	;jne	short $MIF151
 36882                                  ;	; 09/04/2023
 36883                                  ;	jne	short $MEN150
 36884                                  ;						;;AN000;; Yes
 36885                                  ;	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 36886                                  ;	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 36887                                  ;	inc	cx				;;AN000;;
 36888                                  ;$MIF151:
 36889                                  ;	jmp	short $MEN150
 36890                                  
 36891                                  $MIF150:
 36892                                  	; 15/06/2023 (6)
 36893                                  	; MSDOS 6.0
 36894                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54ABh 
 36895                                  	;cmp	cx,6 ; $M_SECOND_THOU		;;AN000;; Are we at the first thousands mark
 36896                                  	; 15/06/2023 (7)
 36897                                  	; MSDOS 6.22
 36898                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5C78h 
 36899 00005878 83F907                  	cmp	cx,7 ; $M_SECOND_THOU		;;AN000;; Are we at the first thousands mark	
 36900                                  
 36901                                  ; 28/04/2023
 36902 0000587B 7405                    	je	short $MIF153
 36903                                  ;	jne	short $MIF154			;;AN000;; No
 36904                                  ;	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 36905                                  ;	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','	
 36906                                  ;	;cmp	byte [si+0Ah],',' ; $M_COMMA
 36907                                  ;	;jne	short $MIF155			;;AN000;; No
 36908                                  ;	; 09/04/2023
 36909                                  ;	jne	short $MEN154
 36910                                  ;						;;AN000;; Yes				
 36911                                  ;	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 36912                                  ;	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 36913                                  ;	inc	cx				;;AN000;;
 36914                                  ;$MIF155:
 36915                                  ;	jmp	short $MEN154
 36916                                  
 36917                                  $MIF154:
 36918                                  	; 15/06/2023 (9)
 36919                                  	; MSDOS 6.0
 36920                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54BDh 
 36921                                  	;cmp	cx,9 ; $M_THIRD_THOU		;;AN000;; Are we at the first thousands mark
 36922                                  	; 15/06/2023 (11)
 36923                                  	; MSDOS 6.22
 36924                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5C8Ah 
 36925 0000587D 83F90B                  	cmp	cx,11 ; $M_THIRD_THOU		;;AN000;; Are we at the first thousands mark
 36926 00005880 750B                    	jne	short $MIF158			;;AN000;; No  
 36927                                  ; 28/04/2023
 36928                                  $MIF153:
 36929                                  	;cmp	$M_SL.$M_S_PAD,$M_COMMA		;;AN000;; Is the pad character a comma?
 36930 00005882 807C0A2C                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','	
 36931                                  	;cmp	byte [si+0Ah],',' ; $M_COMMA
 36932 00005886 7505                    	jne	short $MIF159			;;AN000;; No
 36933                                  						;;AN000;; Yes
 36934 00005888 FF36[D098]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA]
 36935                                  	;push	word [$M_RT+83]			;;AN000;; Insert a thousand separator
 36936 0000588C 41                      	inc	cx				;;AN000;;
 36937                                  $MIF159:
 36938                                  $MIF158:
 36939                                  $MEN154:
 36940                                  $MEN150:					;;AN000;;
 36941 0000588D 93                      	xchg	ax,bx				;;AN000;; Setup to divide the reduced High Word
 36942                                  						;;AN000;;  and Revised Low Word
 36943 0000588E 31D2                    	xor	dx,dx				;;AN000;; Reset remainder
 36944                                  	; 28/04/2023
 36945 00005890 EBC1                    	jmp	short $MDO145
 36946                                  ;$MEN145:
 36947                                  	; 28/04/2023
 36948                                  	;xor	ax,ax				;;AN000;; Reset remainder
 36949                                  $MEN145: ; 09/04/2023 ; * ; ax = 0
 36950 00005892 31D2                    	xor	dx,dx				;;AN000;; Reset remainder
 36951 00005894 FF36[C398]              	push	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 36952                                  	;push	word [$M_RT+70]			;;AN000;; Restore Return Address
 36953 00005898 C3                      	retn					;;AN000;; Return
 36954                                  
 36955                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36956                                  ;;
 36957                                  ;;	PROC NAME: $M_DISPLAY_MESSAGE
 36958                                  ;;
 36959                                  ;;	FUNCTION:  Will display or write entire message (with replacable parameters)
 36960                                  ;;	INPUTS:    ES:DI points to beginning of message
 36961                                  ;;		   DS:SI points to first sublist structure in chain
 36962                                  ;;		   BX contains the handle to write to (if applicable)
 36963                                  ;;		   CX contains the length of string to write (before substitutions)
 36964                                  ;;		   BP contains the count of replacables
 36965                                  ;;
 36966                                  ;;	OUTPUTS:
 36967                                  ;;	REGS USED: All
 36968                                  ;;
 36969                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 36970                                  
 36971                                  	; 10/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 36972                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:54DBh
 36973                                  
 36974                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 36975                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:54DBh
 36976                                  
 36977                                  $M_DISPLAY_MESSAGE:
 36978                                  ; $DO						;;AN000;; Note: DS:SI -> message
 36979                                  $MDO165:
 36980 00005899 31D2                    	xor	dx,dx				;;AN000;; Set size = 0
 36981 0000589B 09C9                    	or	cx,cx				;;AN000;; Are we finished the message yet?
 36982                                  ;; $IF NZ					;;AN000;; No
 36983 0000589D 7421                    	jz	short $MIF166			;;AN000;; Yes
 36984 0000589F B425                    	mov	ah,"%"				;;AN000;; Prepare to scan for %
 36985 000058A1 B000                    	mov	al,0				;;AN004;;
 36986                                  ;; $DO						;;AN000;; Scan through string until %
 36987                                  $MDO167:
 36988 000058A3 263825                  	cmp	byte [es:di],ah			;;AN000;; Is this character NOT a %
 36989                                  ;; $LEAVE E,AND					;;AN000;; No
 36990 000058A6 750A                    	jne	short $MLL168
 36991 000058A8 26386501                	cmp	byte [es:di+1],ah		;;AN000;; Is the next character also a %
 36992                                  ;; $LEAVE NE,AND				;;AN000;; No
 36993 000058AC 7404                    	je	short $MLL168
 36994                                  
 36995 000058AE 38E0                    	cmp	al,ah				;;AN000;; Was the character before a %
 36996                                  ;; $LEAVE NE					;;AN000;; No, GREAT found it
 36997 000058B0 750E                    	jne	short MEN167
 36998                                  $MLL168:
 36999 000058B2 268A05                  	mov	al,[es:di]			;;AN004;; Yes, (to any of the above)
 37000 000058B5 E86FFF                  	call	$M_IS_IT_DBCS			;;AN004;; Is this character the first part of a DBCS?
 37001                                  ;;; $IF C					;;AN004;; Yes
 37002 000058B8 7301                    	jnc	short $MIF169
 37003 000058BA 47                      	inc	di				;;AN004;; Increment past second part
 37004                                  ;;; $ENDIF					;;AN004;;
 37005                                  $MIF169:
 37006 000058BB 47                      	inc	di				;;AN000;; Next character in string
 37007 000058BC 42                      	inc	dx				;;AN000;; Size = Size + 1
 37008 000058BD 49                      	dec	cx				;;AN000;; Decrement total size
 37009                                  ;; $ENDDO Z					;;AN000;; Exit scan if we're at the end of the line
 37010 000058BE 75E3                    	jnz	short $MDO167
 37011                                  $MEN167:
 37012                                  ;; $ENDIF					;;AN000;;
 37013                                  $MIF166:
 37014 000058C0 56                      	push	si				;;AN000;; Save beginning of sublists
 37015 000058C1 87CA                    	xchg	cx,dx				;;AN000;; Get size of message to display (tot sz in DX)
 37016 000058C3 09ED                    	or	bp,bp				;;AN000;; Do we have any replacables to do?
 37017                                  ;; $IF NZ					;;AN000;; Yes
 37018 000058C5 7431                    	jz	short $MIF173
 37019 000058C7 4D                      	dec	bp				;;AN000;; Decrement number of replacables
 37020                                  
 37021                                  ;; Search through sublists to find applicable one
 37022                                  
 37023 000058C8 833E[C598]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37024                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37025                                  ;;; $IF E					;;AN000;; No
 37026 000058CD 7529                    	jne	short $MIF174
 37027                                  ;;; $SEARCH					;;AN000;;
 37028                                  $MDO175:
 37029                                  	;mov	al,$M_SL.$M_S_ID ;$M_SL=DS:[SI]	;;AN000;; Get ID byte
 37030 000058CF 8A4406                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_ID]
 37031                                  	;mov	al,[si+6]
 37032 000058D2 0430                    	add	al,30h				;;AN000;; Convert to ASCII
 37033                                  	; 28/04/2023					
 37034 000058D4 263A4501                	cmp	al,[es:di+1]			;;AN000;; Is this the right sublist?
 37035                                  ;;; $EXITIF E					;;AN000;;
 37036                                  	;jne	short $MIF175
 37037                                  ;;; $ORELSE					;;AN000;; No
 37038                                  	;jmp	short $MSR175
 37039                                  	; 28/04/2023
 37040 000058D8 741E                    	je	short $MSR175
 37041                                  $MIF175:
 37042 000058DA 3C30                    	cmp	al,30h ; $M_SPECIAL_CASE	;;AN000;; Does this sublist have ID = 0
 37043                                  ;;; $LEAVE E,AND				;;AN000;; Yes
 37044 000058DC 7504                    	jne	short $MLL178
 37045 000058DE 09D2                    	or	dx,dx				;;AN000;; Are we at the end of the message?
 37046                                  ;;; $LEAVE Z					;;AN000;; No
 37047 000058E0 7404                    	jz	short $MEN175
 37048                                  $MLL178:
 37049                                  	;add	si,$M_SL.$M_S_SIZE		;;AN000;; Next SUBLIST
 37050                                  	;add	si,[si+$M_SUBLIST_STRUC.$M_S_SIZE] ; [si+0]
 37051                                  	;;add	si,[si+0]
 37052 000058E2 0334                    	add	si,[si]
 37053                                  ;;; ENDLOOP					;;AN000;; Yes
 37054 000058E4 EBE9                    	jmp	short $MDO175
 37055                                  $MEN175:
 37056 000058E6 803E[C298]FF            	cmp	byte [$M_RT+$M_RES_ADDRS.$M_CLASS],utility_msg_class
 37057                                  	;cmp	byte [$M_RT+69],0FFh		;;AN004;; Is it a utility message?
 37058                                  ;;;; $IF E					;;AN004;; Yes
 37059 000058EB 7508                    	jne	short $MIF180
 37060 000058ED 42                      	inc	dx				;;AN000;; Remember to display CR,LF
 37061 000058EE 42                      	inc	dx				;;AN000;;  at the end of the message
 37062 000058EF 49                      	dec	cx				;;AN000;; Adjust message length
 37063 000058F0 49                      	dec	cx				;;AN000;;
 37064 000058F1 4F                      	dec	di				;;AN000;; Adjust ending address of message
 37065 000058F2 4F                      	dec	di				;;AN000;;
 37066                                  ;;;; $ELSE					;;AN004;; No
 37067 000058F3 EB03                    	jmp	short $MEN180
 37068                                  $MIF180:
 37069 000058F5 BAFFFF                  	mov	dx,-1 				;;AN004;; Set special case
 37070                                  ;;;; $ENDIF					;;AN004;;
 37071                                  $MEN180:
 37072                                  ;;; $ENDSRCH					;;AN000;;
 37073                                  $MSR175:
 37074                                  ;; $ENDIF					;;AN000;;
 37075                                  $MIF174:
 37076                                  ; $ENDIF					;;AN000;;
 37077                                  $MIF173:
 37078                                  ;; Prepare and display this part of message
 37079                                  
 37080 000058F8 57                      	push	di				;;AN000;; Save pointer to replace number
 37081 000058F9 29CF                    	sub	di,cx				;;AN000;; Determine beginning of string
 37082 000058FB E833FE                  	call	$M_DISPLAY_STRING		;;AN000;; Display string until % (or end)
 37083 000058FE 5F                      	pop	di				;;AN000;; Get back pointer to replace number
 37084 000058FF 59                      	pop	cx				;;AN000;; Clean up stack in case error
 37085                                  ; $LEAVE C,LONG					;;AN000;; Fail if carry was set
 37086                                  	;jnc	short $MXL3
 37087                                  	;jmp	$MEN165
 37088                                  	; 02/05/2023
 37089 00005900 7214                    	jc	short $MEN165
 37090                                  $MXL3:
 37091 00005902 51                      	push	cx				;;AN000;;
 37092                                  
 37093                                  ;; Save and reset pointer registers
 37094                                  
 37095 00005903 89D1                    	mov	cx,dx				;;AN000;; Get the size of the rest of the message
 37096                                  	;cmp	$M_SL.$M_S_ID,$M_SPECIAL_CASE-30h
 37097 00005905 807C0600                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_ID],0 ; $M_SPECIAL_CASE-30h
 37098                                  	;cmp	byte [si+6],0 			;;AN000;; Is this the %0 case?
 37099                                  ; $IF NE					;;AN000;; No
 37100 00005909 7412                    	je	short $MIF187			;;AN000;; Yes			
 37101 0000590B 09C9                    	or	cx,cx				;;AN000;; Are we finished the whole message?
 37102                                  ;; $IF NZ					;;AN000;; No
 37103 0000590D 7406                    	jz	short $MIF188			;;AN000;; Yes
 37104 0000590F 49                      	dec	cx				;;AN000;; Decrement total size (%)
 37105 00005910 49                      	dec	cx				;;AN000;; Decrement total size (#)
 37106 00005911 47                      	inc	di				;;AN000;; Go past %
 37107 00005912 47                      	inc	di				;;AN000;; Go past replace number
 37108                                  ;; $ELSE					;;AN000;; Yes, (Note this will not leave because INC)
 37109                                  	;jmp	short $MEN188
 37110                                  	; 28/04/2023
 37111 00005913 EB15                    	jmp	short $MEN187
 37112                                  $MIF188:
 37113 00005915 5E                      	pop	si				;;AN000;; Get back pointer to beginning of SUBLISTs
 37114                                  ;; $ENDIF					;;AN000;; Yes, Note this will not leave because INC
 37115                                  $MEN188:
 37116                                  ; $ELSE 					;;AN000;;
 37117                                  	;jmp	short $MEN187
 37118                                  	; 28/04/2023
 37119                                  	; zf = 1
 37120                                  	;jmp	short $MEN165 
 37121                                  
 37122                                  ; 28/04/2023
 37123                                  $MXL4:
 37124                                  $MLL214:
 37125                                  $MEN165:
 37126 00005916 C706[C598]0000          	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0
 37127                                  	;mov	word [$M_RT+72],0		;;AN000;; IF there was an error displaying then EXIT
 37128                                  						;;AN000;; Reset message number to null
 37129 0000591C C3                      	retn					;;AN000;; Return
 37130                                  
 37131                                  $MIF187:
 37132 0000591D 09C9                    	or	cx,cx				;;AN000;; Are we finished the whole message?
 37133                                  ;; $IF Z					;;AN004;; No
 37134                                  	;jnz	short $MIF192
 37135                                  	;pop	si				;;AN000;; Get back pointer to beginning of SUBLISTs
 37136                                  ;; $ELSE					;;AN000;; No
 37137                                  	;jmp	short $MEN192
 37138                                  	; 28/04/2023
 37139 0000591F 74F4                    	jz	short $MIF188
 37140                                  $MIF192:
 37141 00005921 83F9FF                  	cmp	cx,-1				;;AN004;; Are we at the end of the message?
 37142                                  ;;; $IF Z					;;AN004;; No
 37143 00005924 7502                    	jnz	short $MIF194
 37144 00005926 31C9                    	xor	cx,cx				;;AN004;;
 37145                                  ;;; $ENDIF					;;AN000;;
 37146                                  $MIF194:
 37147 00005928 09FF                    	or	di,di				;;AN004;; Turn ZF off
 37148                                  ;; $ENDIF					;;AN000;;
 37149                                  $MEN192:
 37150                                  ; $ENDIF					;;AN000;; Note this will not leave because INC
 37151                                  $MEN187:
 37152                                  ; $LEAVE Z					;;AN000;;
 37153 0000592A 74EA                    	jz	short $MEN165
 37154                                  	;
 37155 0000592C 55                      	push	bp				;;AN000;; Save the replace count
 37156 0000592D 57                      	push	di				;;AN000;; Save location to complete message
 37157 0000592E 06                      	push	es				;;AN000;;
 37158 0000592F 51                      	push	cx				;;AN000;; Save size of the rest of the message
 37159 00005930 31C9                    	xor	cx,cx				;;AN000;; Reset CX used for character count
 37160                                  
 37161                                  ;; Determine what action is required on parameter
 37162                                  
 37163 00005932 833E[C598]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37164                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37165                                  ; $IF E						;;AN000;;
 37166 00005937 753B                    	jne	short $MIF199
 37167                                  
 37168                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type and $M_TYPE_MASK
 37169 00005939 F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37170                                  	;test	byte [si+7],0Fh			;;AN000;;
 37171                                  ;; $IF Z					;;AN000;;
 37172 0000593D 7508                    	jnz	short $MIF200
 37173                                  
 37174                                  ;; Character type requested
 37175                                  
 37176                                  	;les	di,dword ptr $M_SL.$M_S_VALUE	;;AN000;; Load pointer to replacing parameter
 37177 0000593F C47C02                  	les	di,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 37178                                  	;les	di,[si+2]
 37179 00005942 E84801                  	call	$M_CHAR_REPLACE			;;AN000;;
 37180                                  ;; $ELSE					;;AN000;; Get the rest of the message to display
 37181 00005945 EB28                    	jmp	short $MEN200
 37182                                  $MIF200:
 37183                                  ;; ENDIF					;;AN000;;
 37184                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37185 00005947 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37186                                  	;test	byte [si+7],0Dh			;;AN000;;
 37187                                  ;; $IF Z,OR					;;AN000;;
 37188 0000594B 740C                    	jz	short $MLL202
 37189                                  	;test	byte ptr $M_SL.$M_S_FLAG,NOT Unsgn_Bin_Type AND $M_TYPE_MASK
 37190 0000594D F644070E                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37191                                  	;test	byte [si+7],0Eh			;;AN000;;
 37192                                  ;;; $IF Z,OR					;;AN000;;
 37193 00005951 7406                    	jz	short $MLL202
 37194                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Bin_Hex_Type and $M_TYPE_MASK
 37195 00005953 F644070C                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Ch
 37196                                  	;test	byte [si+7],0Ch			;;AN000;;
 37197                                  ;;;; $IF Z 					;;AN000;;
 37198 00005957 7508                    	jnz	short $MIF202
 37199                                  $MLL202:
 37200                                  
 37201                                  ;; Numeric type requested
 37202                                  
 37203                                  	;les	di,dword ptr $M_SL.$M_S_VALUE	;;AN000;; Load pointer to replacing parameter
 37204 00005959 C47C02                  	les	di,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 37205                                  	;les	di,[si+2]
 37206 0000595C E85601                  	call	$M_BIN2ASC_REPLACE		;;AN000;;
 37207                                  ;;;; $ELSE					;;AN000;; Get the rest of the message to display
 37208 0000595F EB0E                    	jmp	short $MEN202
 37209                                  $MIF202:
 37210                                  ;;;; ENDIF					;;AN000;;
 37211                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Date_Type and $M_TYPE_MASK
 37212 00005961 F644070B                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Bh
 37213                                  	;test	byte [si+7],0Bh			;;AN000;;
 37214                                  ;;;; $IF E					;;AN000;;
 37215 00005965 7505                    	jnz	short $MIF204
 37216                                  
 37217                                  ;; Date type requested
 37218                                  
 37219 00005967 E8EC01                  	call	$M_DATE_REPLACE			;;AN000;;
 37220                                  ;;;; $ELSE					;;AN000;; Get the rest of the message to display
 37221 0000596A EB03                    	jmp	short $MEN204
 37222                                  $MIF204:					;;AN000;;
 37223                                  
 37224                                  ;; Time type requested (Default if we have not matched until here)
 37225                                  
 37226 0000596C E89E02                  	call	$M_TIME_REPLACE			;;AN000;;
 37227                                  
 37228                                  ;;;; $ENDIF					;;AN000;;
 37229                                  $MEN204:
 37230                                  ;;; $ENDIF					;;AN000;;
 37231                                  $MEN202:
 37232                                  ;; $ENDIF					;;AN000;;
 37233                                  $MEN200:
 37234                                  
 37235                                  ;; With the replace information of the Stack, display the replaceable field
 37236                                  
 37237 0000596F E85F00                  	call	$M_DISPLAY_REPLACE		;;AN000;; Display the replace
 37238                                  
 37239                                  ;; None of the above - Extended/Parse replace
 37240                                  ; $ELSE 					;;AN000;;
 37241 00005972 EB03                    	jmp	short $MEN199
 37242                                  $MIF199:
 37243 00005974 E81600                  	call	$M_EXT_PAR_REPLACE		;;AN000;;
 37244                                  ; $ENDIF					;;AN000;;
 37245                                  $MEN199:
 37246                                  
 37247                                  ;; We must go back and complete the message after the replacable parameter if there is any left
 37248                                  
 37249                                  ; $IF NC					;;AN000;; IF there was an error displaying then EXIT
 37250 00005977 7207                    	jc	short $MIF211
 37251                                  	;
 37252 00005979 59                      	pop	cx				;;AN000;; Get size of the rest of the message
 37253 0000597A 07                      	pop	es				;;AN000;; Get address of the rest of the message
 37254 0000597B 5F                      	pop	di				;;AN000;;
 37255 0000597C 5D                      	pop	bp				;;AN000;; Get replacment count
 37256 0000597D 5E                      	pop	si				;;AN000;; ELSE get address of first sublist structure
 37257                                  ; $ELSE						;;AN000;;
 37258 0000597E EB03                    	jmp	short $MEN211
 37259                                  $MIF211:
 37260 00005980 83C40A                  	add	sp,10				;;AN000;; Clean up stack if error
 37261                                  	; 28/04/2023
 37262                                  	;stc					;;AN000;;
 37263                                  ; $ENDIF					;;AN000;;
 37264                                  $MEN211:
 37265 00005983 833E[C598]00            	cmp	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0 ; $M_NULL
 37266                                  	;cmp	word [$M_RT+72],0		;;AN000;; Is this an Extended/Parse case
 37267                                  ; $ENDDO NE,OR					;;AN000;;
 37268 00005988 758C                    	jne	short $MLL214
 37269                                  ; $ENDDO C,LONG					;;AN000;; Go back and display the rest of the message
 37270                                  	; 10/04/2023
 37271                                  	;jc	short $MXL4
 37272 0000598A E90CFF                  	jmp	$MDO165
 37273                                  
 37274                                  ; 28/04/2023
 37275                                  ;$MXL4:
 37276                                  ;$MLL214:
 37277                                  ;$MEN165:
 37278                                  ;	mov	word [$M_RT+$M_RES_ADDRS.$M_MSG_NUM],0
 37279                                  ;	;mov	word [$M_RT+72],0		;;AN000;; IF there was an error displaying then EXIT
 37280                                  ;						;;AN000;; Reset message number to null
 37281                                  ;	retn					;;AN000;; Return
 37282                                  
 37283                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37284                                  ;;
 37285                                  ;;	PROC NAME: $M_EXT_PAR_REPLACE
 37286                                  ;;
 37287                                  ;;	FUNCTION:
 37288                                  ;;	INPUTS:
 37289                                  ;;	OUPUTS:
 37290                                  ;;
 37291                                  ;;	REGS USED:
 37292                                  ;;
 37293                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37294                                  
 37295                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37296                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37297                                  
 37298                                  $M_EXT_PAR_REPLACE:
 37299 0000598D 31D2                    	xor	dx,dx				;;AN000;; Prepare for get binary value (HIGH)
 37300 0000598F A1[C598]                	mov	ax,[$M_RT+$M_RES_ADDRS.$M_MSG_NUM]
 37301                                  	;mov	ax,[$M_RT+72]			;;AN000;; Prepare for get binary value (LOW)
 37302 00005992 C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37303                                  	;mov	word [$M_RT+74],10 ; $M_BASE10	;;AN000;; Set default divisor
 37304 00005998 E8B0FE                  	call	$M_CONVERT2ASC			;;AN000;;
 37305                                  $MDO215:
 37306 0000599B 58                      	pop	ax				;;AN000;; Get character in register
 37307 0000599C 8887[C998]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37308                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move char into the buffer
 37309 000059A0 43                      	inc	bx				;;AN000;; Increase buffer count
 37310 000059A1 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; cmp bx,64	;;AN000;; Is buffer full?
 37311 000059A4 7503                    	jne	short $MIF216			;;AN000;; No
 37312 000059A6 E80D00                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37313                                  $MIF216:
 37314 000059A9 FEC9                    	dec	cl				;;AN000;; Have we completed replace?
 37315 000059AB 75EE                    	jnz	short $MDO215
 37316                                  
 37317 000059AD B80D0A                  	mov	ax,0A0Dh ; mov ax,$M_CR_LF	;;AN000;; Move char into the buffer
 37318 000059B0 8987[C998]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],ax
 37319                                  	;;mov	[bx+$M_RT+76],ax		;;AN000;; Move char into the buffer
 37320 000059B4 43                      	inc	bx				;;AN000;; Increase buffer count
 37321 000059B5 43                      	inc	bx				;;AN000;; Increase buffer count
 37322                                  	;call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37323                                  	;retn					;;AN000::
 37324                                  	; 11/04/2023
 37325                                  	;jmp	$M_FLUSH_BUF
 37326                                  
 37327                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37328                                  ;;
 37329                                  ;;	PROC NAME: $M_FLUSH_BUFFER
 37330                                  ;;
 37331                                  ;;	FUNCTION: Display the contents of the temporary buffer
 37332                                  ;;	INPUTS: DI contains the number of bytes to display
 37333                                  ;;	OUTPUTS: BX reset to zero
 37334                                  ;;
 37335                                  ;;	REGS USED:
 37336                                  ;;
 37337                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37338                                  	
 37339                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37340                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:56C8h
 37341                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37342                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5E95h
 37343                                  $M_FLUSH_BUF:
 37344 000059B6 51                      	push	cx				;;AN000;; Save changed regs
 37345 000059B7 06                      	push	es				;;AN000;;
 37346 000059B8 57                      	push	di				;;AN000;;
 37347 000059B9 1E                      	push	ds				;;AN000;; Set ES pointing to buffer
 37348 000059BA 07                      	pop	es				;;AN000;;
 37349 000059BB 89D9                    	mov	cx,bx				;;AN000;; Set number of bytes to display
 37350 000059BD 31DB                    	xor	bx,bx				;;AN000;; Reset buffer counter
 37351 000059BF 8D3E[C998]              	lea	di,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37352                                  	;lea	di,[$M_RT+76]			;;AN000;; Reset buffer location pointer
 37353 000059C3 E86BFD                  	call	$M_DISPLAY_STRING		;;AN000;; Display the buffer
 37354 000059C6 7204                    	jc	short $MIF314
 37355 000059C8 5F                      	pop	di				;;AN000;; No, Restore changed regs
 37356 000059C9 07                      	pop	es				;;AN000;;
 37357 000059CA 59                      	pop	cx				;;AN000;;
 37358                                  	;jmp	short $MEN314
 37359                                  	; 11/04/2023
 37360 000059CB C3                      	retn
 37361                                  $MIF314:
 37362 000059CC 83C406                  	add	sp,6				;;AN000;; Fix stack
 37363 000059CF F9                      	stc					;;AN000;;
 37364                                  $MEN314:
 37365 000059D0 C3                      	retn					;;AN000;; Return
 37366                                  
 37367                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37368                                  ;;
 37369                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37370                                  
 37371                                  	; 11/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37372                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5609h
 37373                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37374                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5DD6h
 37375                                  $M_DISPLAY_REPLACE:
 37376 000059D1 31DB                    	xor	bx,bx				;;AN000;; Use BX for buffer count
 37377                                  	;;cmp	$M_SL.$M_S_ID,$M_SPECIAL_CASE-30h ; 0
 37378 000059D3 807C0600                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_ID],0	
 37379                                  	;cmp	byte [si+6],0			;;AN000;; Is this the special case (convert to ASCII)
 37380 000059D7 7511                    	jne	short $MIF276
 37381                                  	
 37382 000059D9 C787[C998]202D          	mov	word [bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],2D20h ; $M_SPACE_HYP
 37383                                  	;mov	word [bx+$M_RT+76],2D20h	;;AN000;; Move in a " -"
 37384                                  	
 37385 000059DF 43                      	inc	bx				;;AN000;; Increment count
 37386 000059E0 43                      	inc	bx				;;AN000;; Increment count
 37387                                  	
 37388 000059E1 C687[C998]20            	mov	byte [bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],20h ; $M_SPACE
 37389                                  	;mov	byte [bx+$M_RT+76],20h		;;AN000;; Move in a " "
 37390                                  	
 37391 000059E6 43                      	inc	bx				;;AN000;; Increment count
 37392 000059E7 E8CCFF                  	call	$M_FLUSH_BUF			;;AN000;; Write out " - " to prepare for special case
 37393                                  $MIF276:
 37394 000059EA 5D                      	pop	bp				;;AN000;; Remember the return address
 37395 000059EB 31DB                    	xor	bx,bx				;;AN000;; Use BX for buffer count
 37396 000059ED 31D2                    	xor	dx,dx				;;AN000;; Use DX for count of parms taken off the stack
 37397                                  
 37398 000059EF 880E[BF98]              	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl	;;AN000;; Save size to later clear stack
 37399                                  	;mov	[$M_RT+66],cl
 37400                                  	
 37401                                  	;mov	al,byte ptr $M_SL.$M_S_MINW	;;AN000;; Get the minimum width
 37402 000059F3 8A4409                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_MINW]
 37403                                  	;mov	al,[si+9]
 37404                                  	
 37405 000059F6 38C8                    	cmp	al,cl				;;AN000;; Do we need pad chars added?
 37406 000059F8 761E                    	jna	short $MIF278
 37407 000059FA 28C8                    	sub	al,cl				;;AN000;; Calculate how many pad chars are needed.
 37408 000059FC 88C6                    	mov	dh,al				;;AN000;; Save the number of pad characters
 37409                                  	
 37410                                  	;test	byte ptr $M_SL.$M_S_FLAG,Right_Align
 37411 000059FE F6440780                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],80h
 37412                                  	;test	byte [si+7],80h			;;AN000;; Was replaceable parm to be right aligned?
 37413 00005A02 7414                    	jz	short $MIF279			;;AN000;; No
 37414                                  $MDO280:
 37415                                  	;mov	al,byte ptr $M_SL.$M_S_PAD	;;AN000;;
 37416 00005A04 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 37417                                  	;mov	al,[si+0Ah]
 37418 00005A07 8887[C998]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37419                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move in a pad char
 37420                                  	
 37421 00005A0B 43                      	inc	bx				;;AN000;;
 37422 00005A0C 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; 64		;;AN000;; Is buffer full?
 37423 00005A0F 7503                    	jne	short $MIF281
 37424 00005A11 E8A2FF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37425                                  $MIF281:
 37426 00005A14 FECE                    	dec	dh				;;AN000;; Have we filled with enough pad chars?
 37427 00005A16 75EC                    	jnz	short $MDO280
 37428                                  $MIF279:
 37429                                  $MIF278:
 37430                                  	;cmp	byte ptr $M_SL.$M_S_MAXW,$M_UNLIM_W
 37431 00005A18 807C0800                	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_MAXW],0 ; $M_UNLIM_W
 37432                                  	;cmp	byte [si+8],0			;;AN000;; Is maximum width unlimited
 37433 00005A1C 740C                    	je	short $MIF286
 37434                                  	
 37435                                  	;cmp	byte ptr $M_SL.$M_S_MAXW,CL	;;AN000;; Will we exceed maximum width?
 37436 00005A1E 384C08                  	cmp	byte [si+$M_SUBLIST_STRUC.$M_S_MAXW],cl
 37437                                  	;;cmp	byte [si+8],cl
 37438 00005A21 7307                    	jnb	short $MIF287
 37439                                  
 37440                                  	; 03/05/2023
 37441                                  	;;sub	cl,byte ptr $M_SL.$M_S_MAXW	;;AN000;; Calculate how many extra chars
 37442                                  	;sub	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37443                                  	;;sub	cl,[si+8]
 37444 00005A23 88CA                    	mov	dl,cl				;;AN000;; Remember how many chars to pop off
 37445                                  	;;mov	cl,byte ptr $M_SL.$M_S_MAXW	;;AN000;; Set new string length
 37446                                  	;mov	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37447                                  	;;mov	cl,[si+8]
 37448                                  	; 03/05/2023
 37449 00005A25 8A4C08                  	mov	cl,[si+$M_SUBLIST_STRUC.$M_S_MAXW]
 37450 00005A28 28CA                    	sub	dl,cl
 37451                                  $MIF287:
 37452                                  $MIF286:
 37453 00005A2A 09C9                    	or	cx,cx				;;AN000;;
 37454 00005A2C 7424                    	jz	short $MIF290			;;AN000;;
 37455                                  $MDO291:
 37456                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type not $M_TYPE_MASK
 37457 00005A2E F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37458                                  	;test	byte [si+7],0Fh			;;AN000;;
 37459 00005A32 750C                    	jnz	short $MIF292
 37460                                  
 37461                                  	;test	$M_SL.$M_S_FLAG,Char_field_ASCIIZ and $M_SIZE_MASK
 37462 00005A34 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37463                                  	;test	byte [si+7],10h			;;AN000;; Is this replace a ASCIIZ string?			 
 37464 00005A38 7406                    	jz	short $MIF292			;;AN000;; No
 37465                                  
 37466 00005A3A 268A05                  	mov	al,[es:di]			;;AN000;; Get first character from string
 37467 00005A3D 47                      	inc	di				;;AN000;; Next character in string
 37468 00005A3E EB01                    	jmp	short $MEN292
 37469                                  $MIF292:
 37470 00005A40 58                      	pop	ax				;;AN000;; Get character in register
 37471                                  $MEN292:
 37472                                  	;mov	byte ptr $M_RT.$M_TEMP_BUF[bx],al
 37473 00005A41 8887[C998]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37474                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move char into the buffer
 37475                                  	; 03/05/2023
 37476 00005A45 43                      	inc	bx				;;AN000;; Increase buffer count
 37477 00005A46 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ ; cmp bx,64	;;AN000;; Is buffer full?
 37478 00005A49 7503                    	jne	short $MIF295			;;AN000;;
 37479 00005A4B E868FF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37480                                  $MIF295:
 37481 00005A4E FEC9                    	dec	cl				;;AN000;; Have we completed replace?
 37482 00005A50 75DC                    	jnz	short $MDO291
 37483                                  $MIF290:
 37484                                  	;test	byte ptr $M_SL.$M_S_FLAG,Right_Align
 37485 00005A52 F6440780                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],80h
 37486                                  	;test	byte [si+7],80h			;;AN000;; Was replaceable parm to be left aligned?
 37487 00005A56 7518                    	jnz	short $MIF299			;;AN000;; Yes
 37488 00005A58 08F6                    	or	dh,dh				;;AN000;; Do we need pad chars added?
 37489 00005A5A 7414                    	jz	short $MIF300
 37490                                  $MDO301:
 37491                                  	;mov	al,byte ptr $M_SL.$M_S_PAD	;;AN000;;
 37492 00005A5C 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 37493                                  	;mov	al,[si+0Ah]
 37494                                  
 37495                                  	;mov	byte ptr $M_RT.$M_TEMP_BUF[bx],al
 37496 00005A5F 8887[C998]              	mov	[bx+$M_RT+$M_RES_ADDRS.$M_TEMP_BUF],al
 37497                                  	; 03/05/2023
 37498                                  	;mov	[bx+$M_RT+76],al		;;AN000;; Move in a pad char
 37499                                  
 37500 00005A63 43                      	inc	bx				;;AN000;;
 37501 00005A64 83FB40                  	cmp	bx,$M_TEMP_BUF_SZ  ; 64		;;AN000;; Is buffer full?
 37502 00005A67 7503                    	jne	short $MIF302			;;AN000;; No
 37503                                  						;;AN000;; Yes
 37504 00005A69 E84AFF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer
 37505                                  $MIF302:
 37506 00005A6C FECE                    	dec	dh				;;AN000;; Have we filled with enough pad chars?
 37507 00005A6E 75EC                    	jnz	short $MDO301			;;AN000;;
 37508                                  $MIF300:
 37509                                  $MIF299:
 37510                                  	;test	byte ptr $M_SL.$M_S_FLAG,not Char_Type and $M_TYPE_MASK
 37511 00005A70 F644070F                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Fh
 37512                                  	;test	byte [si+7],0Fh			;;AN000;;
 37513 00005A74 7506                    	jnz	short $MIF307
 37514                                  	
 37515                                  	;test	$M_SL.$M_S_FLAG,Char_field_ASCIIZ and $M_SIZE_MASK
 37516 00005A76 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37517                                  	;test	byte [si+7],10h			;;AN000;; Is this replace a ASCIIZ string?
 37518                                  	; 11/04/2023
 37519                                  	;jz	short $MIF307			;;AN000;;
 37520                                  	;jmp	short $MEN307			;;AN000;;
 37521 00005A7A 750C                    	jnz	short $MEN307
 37522                                  $MIF307:
 37523 00005A7C 08D2                    	or	dl,dl				;;AN000;;
 37524 00005A7E 7408                    	jz	short $MIF309			;;AN000;;
 37525                                  $MDO310:
 37526 00005A80 8F06[C398]              	pop	word [$M_RT+$M_RES_ADDRS.$M_RETURN_ADDR]
 37527                                  	;pop	word [$M_RT+70]			;;AN000;; Clean Up stack using spare variable
 37528 00005A84 FECA                    	dec	dl				;;AN000;; Are we done?
 37529 00005A86 75F8                    	jnz	short $MDO310
 37530                                  $MIF309:
 37531                                  $MEN307:
 37532 00005A88 E82BFF                  	call	$M_FLUSH_BUF			;;AN000;; Flush the buffer for the final time
 37533 00005A8B 55                      	push	bp				;;AN000;; Restore the return address
 37534 00005A8C C3                      	retn					;;AN000;;
 37535                                  
 37536                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37537                                  ;;
 37538                                  ;;	PROC NAME: $M_CHAR_REPLACE
 37539                                  ;;
 37540                                  ;;	FUNCTION: Will prepare a single char or ASCIIZ string for replace
 37541                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37542                                  ;;		ES:DI contains the VALUE from SUBLIST
 37543                                  ;;	OUTPUTS: CX contains number of characters on stack
 37544                                  ;;		 Top of stack  --> Last character
 37545                                  ;;					. . .
 37546                                  ;;		 Bot of stack  --> First character
 37547                                  ;;
 37548                                  ;;	OTHER REGS Revised: AX
 37549                                  ;;
 37550                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37551                                  
 37552                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37553                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37554                                  $M_CHAR_REPLACE:
 37555 00005A8D 5D                      	pop	bp				;;AN000;; Save return address
 37556                                  	;test	$M_SL.$M_S_FLAG,not Char_Field_Char and $M_SIZE_MASK
 37557 00005A8E F6440730                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],30h
 37558                                  	;test	byte [si+7],30h			;;AN000;; Was Character specified?
 37559 00005A92 7512                    	jnz	short $MIF317			;;AN000;; No
 37560 00005A94 268A05                  	mov	al,[es:di]			;;AN000;; Get the character
 37561 00005A97 50                      	push	ax				;;AN000;; Put it on the stack
 37562 00005A98 41                      	inc	cx				;;AN000;; Increase the count
 37563 00005A99 E88BFD                  	call	$M_IS_IT_DBCS			;;AN000;; Is this the first byte of a DB character
 37564 00005A9C 7306                    	jnc	short $MIF318
 37565 00005A9E 268A4501                	mov	al,[es:di+1]			;;AN000;; Get the next character
 37566 00005AA2 50                      	push	ax				;;AN000;; Put it on the stack
 37567 00005AA3 F8                      	clc					;;AN000;; Clear the carry
 37568                                  $MIF318:
 37569 00005AA4 EB0D                    	jmp	short $MEN317
 37570                                  $MIF317:
 37571                                  $MDO321:
 37572 00005AA6 268A05                  	mov	al,[es:di]			;;AN000;; Get the character
 37573 00005AA9 08C0                    	or	al,al				;;AN000;; Is it the NULL?
 37574 00005AAB 7404                    	jz	short $MEN321			;;AN000;; Yes
 37575 00005AAD 47                      	inc	di				;;AN000;; Next character
 37576 00005AAE 41                      	inc	cx				;;AN000;; Increment the count
 37577 00005AAF EBF5                    	jmp	short $MDO321
 37578                                  $MEN321:
 37579 00005AB1 29CF                    	sub	di,cx				;;AN000;; Set DI at the beginning of the string
 37580                                  $MEN317:
 37581 00005AB3 55                      	push	bp				;;AN000;; Restore return address
 37582 00005AB4 C3                      	retn					;;AN000;;	
 37583                                  
 37584                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37585                                  ;;
 37586                                  ;;	PROC NAME: $M_BIN2ASC_REPLACE
 37587                                  ;;
 37588                                  ;;	FUNCTION: Convert a signed or unsigned binary number to an ASCII string
 37589                                  ;;		  and prepare to display
 37590                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37591                                  ;;		ES:DI contains the VALUE from SUBLIST
 37592                                  ;;	OUTPUTS: CX contains number of characters on stack
 37593                                  ;;		 Top of stack  --> Last character
 37594                                  ;;					. . .
 37595                                  ;;		 Bot of stack  --> First character
 37596                                  ;;	OTHER REGS Revised: BX,DX,AX
 37597                                  ;;
 37598                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37599                                  
 37600                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37601                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37602                                  $M_BIN2ASC_REPLACE:
 37603 00005AB5 5D                      	pop	bp				;;AN000;; Save return address
 37604 00005AB6 31D2                    	xor	dx,dx				;;AN000;; Prepare for get binary value (HIGH)
 37605 00005AB8 31C0                    	xor	ax,ax				;;AN000;; Prepare for get binary value (LOW)
 37606 00005ABA C706[C798]1000          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],16 ; $M_BASE16
 37607                                  	;mov	word [$M_RT+74],16  ; $M_BASE16	;;AN000;; Set default divisor
 37608                                  
 37609 00005AC0 31DB                    	xor	bx,bx				;;AN000;; Use BX as the NEG flag (if applicable)
 37610                                  
 37611                                  	;test	$M_SL.$M_S_FLAG,not $M_BYTE and $M_SIZE_MASK
 37612 00005AC2 F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 37613                                  	;test	byte [si+7],20h			;;AN000;; Was BYTE specified?		
 37614 00005AC6 7511                    	jnz	short $MIF325			;;AN000;; No
 37615                                  	
 37616 00005AC8 268A05                  	mov	al,[es:di]			;;AN000;; Setup byte in AL
 37617                                  
 37618                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37619 00005ACB F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37620                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?
 37621 00005ACF 753D                    	jnz	short $MIF326			;;AN000;; No
 37622                                  			 
 37623 00005AD1 A880                    	test	al,10000000b ; 80h		;;AN000;; Is this number negative?
 37624 00005AD3 7433                    	jz	short $MIF327			;;AN000;; No
 37625                                  						;;AN000;; Yes				
 37626                                  	; 12/04/2023
 37627                                  	;inc	bx				;;AN000;; Remember that it was negative
 37628 00005AD5 247F                    	and	al,01111111b			;;AN000;; Make it positive
 37629                                  
 37630                                  	; 12/04/2023 - Retrop DOS v4.0 COMMAND.COM
 37631                                  	;jmp	short $MIF327
 37632 00005AD7 EB2E                    	jmp	short $MIF350 ; inc bx
 37633                                  
 37634                                  ; 12/04/2023
 37635                                  %if 0
 37636                                  
 37637                                  $MIF327:
 37638                                  $MIF335:	; 12/04/2023
 37639                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37640                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37641                                  $MIF326:
 37642                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 37643                                  	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37644                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 37645                                  	jnz	short $MIF330			;;AN000;; No
 37646                                  						;;AN000;; Yes
 37647                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37648                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37649                                  $MIF330:
 37650                                  	jmp	short $MEN325
 37651                                  
 37652                                  %endif
 37653                                  
 37654                                  $MIF325:
 37655                                  	;test	$M_SL.$M_S_FLAG,not $M_WORD and $M_SIZE_MASK
 37656 00005AD9 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37657                                  	;test	byte [si+7],10h			;;AN000;; Was WORD specified?
 37658 00005ADD 7513                    	jnz	short $MIF333			;;AN000;; No
 37659                                  						;;AN000;; Yes
 37660 00005ADF 268B05                  	mov	ax,[es:di]			;;AN000;; Setup byte in AL
 37661                                  
 37662                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37663 00005AE2 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37664                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?	
 37665 00005AE6 7526                    	jnz	short $MIF334			;;AN000;; No
 37666                                  						;;AN000;; Yes
 37667 00005AE8 F6C480                  	test	ah,10000000b ; 80h		;;AN000;; Is this number negative?
 37668 00005AEB 741B                    	jz	short $MIF335			;;AN000;; No
 37669                                  						;;AN000;; Yes
 37670                                  	; 12/04/2023
 37671                                  	;inc	bx				;;AN000;; Remember that it was negative
 37672 00005AED 80E47F                  	and	ah,01111111b			;;AN000;; Make it positive
 37673                                  
 37674                                  	; 12/04/2023 - Retro DOS v4.0 COMMAND.COM
 37675                                  	;jmp	short $MIF335
 37676 00005AF0 EB15                    	jmp	short $MIF350 ; inc bx
 37677                                  
 37678                                  ; 12/04/2023
 37679                                  %if 0
 37680                                  
 37681                                  $MIF335:
 37682                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37683                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37684                                  $MIF334:
 37685                                  	test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK ;;AN000;; Was Signed binary specified?
 37686                                  	jnz	short $MIF338
 37687                                  
 37688                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 37689                                  	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37690                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 37691                                  	jnz	short $MIF338			;;AN000;; No
 37692                                  						;;AN000;; Yes
 37693                                  	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37694                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37695                                  $MIF338:
 37696                                  	jmp	short $MEN333			;;AN000;;
 37697                                  %endif
 37698                                  
 37699                                  $MIF333:
 37700 00005AF2 268B05                  	mov	ax,[es:di]			;;AN000;; Setup Double word in DX:AX
 37701 00005AF5 268B5502                	mov	dx,[es:di+2]			;;AN000;;
 37702                                  
 37703                                  	;test	$M_SL.$M_S_FLAG,not Sgn_Bin_Type and $M_TYPE_MASK
 37704 00005AF9 F644070D                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Dh
 37705                                  	;test	byte [si+7],0Dh			;;AN000;; Was Signed binary specified?	
 37706 00005AFD 750F                    	jnz	short $MIF341			;;AN000;; No
 37707                                  						;;AN000;; Yes
 37708 00005AFF F6C680                  	test	dh,10000000b ; 80h		;;AN000;; Is this number negative?
 37709 00005B02 7404                    	jz	short $MIF342			;;AN000;; No
 37710                                  						;;AN000;; Yes
 37711                                  	; 12/04/2023
 37712                                  	;inc	bx				;;AN000;; Remember that it was negative
 37713 00005B04 80E67F                  	and	dh,01111111b			;;AN000;; Make it positive
 37714                                  	
 37715                                  	; 12/04/2023 - Retro DOS v4.0 COMMAND.COM
 37716                                  $MIF350:
 37717 00005B07 43                      	inc	bx
 37718                                  $MIF342:
 37719                                  	; 12/04/2023
 37720                                  $MIF327:
 37721                                  $MIF335:
 37722 00005B08 C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37723                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37724                                  $MIF341:
 37725                                  $MIF326:
 37726                                  	; 18/04/2023
 37727                                  $MIF334:
 37728                                  	;test	$M_SL.$M_S_FLAG,not Unsgn_Bin_Type and $M_TYPE_MASK
 37729 00005B0E F644070E                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],0Eh
 37730                                  	;test	byte [si+7],0Eh			;;AN000;; Was Signed binary specified?
 37731 00005B12 7506                    	jnz	short $MIF345			;;AN000;; No
 37732                                  						;;AN000;; Yes
 37733 00005B14 C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37734                                  	;mov	word [$M_RT+74],10		;;AN000;;
 37735                                  
 37736                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37737                                  	; ****************************************
 37738                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:5F64h
 37739                                  $MIF345:
 37740                                  	; *** (Disassembled MSDOS 6.22 COMMAND.COM source code.)
 37741                                  $MEN333:
 37742 00005B1A F6440740                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],40h
 37743                                  	;test	byte [si+7],40h		; MSDOS 6.22
 37744                                  				; (Custom/International flag for thousand separator)
 37745 00005B1E 7428                    	jz	short $MEN325
 37746 00005B20 50                      	push	ax			; MSDOS 6.22
 37747 00005B21 52                      	push	dx
 37748 00005B22 B438                    	mov	ah,38h	 ; International
 37749 00005B24 30C0                    	xor	al,al
 37750 00005B26 8D16[C998]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37751 00005B2A CD21                    	int	21h		; DOS - 2+ - GET COUNTRY-DEPENDENT INFORMATION
 37752                                  				; get current-country info
 37753                                  				; DS:DX -> buffer for returned info
 37754 00005B2C 7305                    	jnb	short $MEN341		; (use country depended thousand separator)
 37755 00005B2E C606[D098]2C            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_THOU_SEPARA],','
 37756                                  $MEN341:
 37757 00005B33 8A440A                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_PAD]
 37758                                  	;mov	al,[si+0Ah]		; (save pad character)
 37759 00005B36 89C7                    	mov	di,ax
 37760 00005B38 5A                      	pop	dx
 37761 00005B39 58                      	pop	ax
 37762 00005B3A C6440A2C                	mov	byte [si+$M_SUBLIST_STRUC.$M_S_PAD],','  ; $M_COMMA
 37763                                  	;mov	byte [si+0Ah],','	; (comma is needed for converting procedure)
 37764 00005B3E E80AFD                  	call	$M_CONVERT2ASC
 37765 00005B41 89F8                    	mov	ax,di
 37766 00005B43 88440A                  	mov	[si+$M_SUBLIST_STRUC.$M_S_PAD],al
 37767                                  	;mov	[si+0Ah],al		; (restore pad character)
 37768 00005B46 EB03                    	jmp	short $MEN345		; MSDOS 6.22
 37769                                  	; *** (end of disassembled MSDOS 6.22 COMMAND.COM source code porehion) 
 37770                                  	; ****************************************
 37771                                  ;$MIF345:
 37772                                  ;$MEN333:
 37773                                  $MEN325:
 37774 00005B48 E800FD                  	call	$M_CONVERT2ASC			;;AN000;; Convert to ASCII string
 37775                                  $MEN345: 	; 15/06/2023 - MSDOS 6.22
 37776 00005B4B 09DB                    	or	bx,bx				;;AN000;; Was number negative?
 37777 00005B4D 7405                    	jz	short $MIF349			;;AN000;; No
 37778                                  						;;AN000;; Yes
 37779 00005B4F 31D2                    	xor	dx,dx				;;AN000;;
 37780 00005B51 B22D                    	mov	dl,'-'	; $M_NEG_SIGN		;;AN000;; Put "-" on the stack with the number
 37781 00005B53 52                      	push	dx				;;AN000;;
 37782                                  $MIF349:
 37783 00005B54 55                      	push	bp				;;AN000;; Restore return address
 37784 00005B55 C3                      	retn					;;AN000;; Return
 37785                                  
 37786                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37787                                  ;;
 37788                                  ;;	PROC NAME: $M_DATE_REPLACE
 37789                                  ;;
 37790                                  ;;	FUNCTION: Convert a date to a decimal ASCII string using current
 37791                                  ;;		  country format and prepare to display
 37792                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37793                                  ;;		ES:DI points at VALUE from SUBLIST
 37794                                  ;;	OUTPUTS: CX contains number of characters on stack
 37795                                  ;;		 Top of stack  --> Last character
 37796                                  ;;					. . .
 37797                                  ;;		 Bot of stack  --> First character
 37798                                  ;;	OTHER REGS Revised: DX,AX
 37799                                  ;;
 37800                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37801                                  
 37802                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37803                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37804                                  $M_DATE_REPLACE:
 37805 00005B56 5D                      	pop	bp				;;AN000;; Save return address
 37806                                  
 37807 00005B57 C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 37808                                  	;mov	word [$M_RT+74],10		;;AN000;; Set default divisor
 37809                                  	
 37810 00005B5D E86700                  	call	$M_GET_DATE			;;AN000;; Set date format/separator in $M_RT
 37811                                  						;;AN000;; All O.K.?
 37812 00005B60 31D2                    	xor	dx,dx				;;AN000;; Reset DX value
 37813                                  	; 12/04/2023
 37814                                  	;xor	ax,ax				;;AN000;; Reset AX value
 37815                                  	
 37816                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],0
 37817                                  	;;cmp	word [$M_RT+76],0		;;AN000;; USA Date Format
 37818                                  	;jne	short $MIF351
 37819                                  	; 12/04/2023
 37820 00005B62 A1[C998]                	mov	ax,[$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] ; *
 37821 00005B65 09C0                    	or	ax,ax
 37822 00005B67 751D                    	jnz	short $MIF351
 37823                                  
 37824 00005B69 E87200                  	call	$M_YEAR				;;AN000;; Get Year
 37825 00005B6C E88100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37826                                  
 37827 00005B6F FF36[D498]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37828                                  	;push	word [$M_RT+87]			;;AN000;;
 37829                                  	
 37830 00005B73 41                      	inc	cx				;;AN000;; Increment count
 37831 00005B74 31C0                    	xor	ax,ax				;;AN000;; Reset AX value
 37832                                  
 37833 00005B76 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 37834                                  	;mov	al,[si+5]			;;AN000;; Get Day
 37835 00005B79 E87400                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37836                                  	
 37837 00005B7C FF36[D498]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37838                                  	;push	word [$M_RT+87]			;;AN000;;
 37839                                  
 37840 00005B80 41                      	inc	cx				;;AN000;; Increment count
 37841 00005B81 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 37842                                  	;mov	al,[si+4]			;;AN000;; Get Month
 37843                                  	; 12/04/2023
 37844                                  	;call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37845 00005B84 EB3C                    	jmp	short $MIF354 ; **
 37846                                  $MIF351:
 37847                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],1
 37848                                  	;;cmp	word [$M_RT+76],1		;;AN000;; EUROPE Date Format
 37849                                  	;jne	short $MIF353
 37850                                  	; 12/04/2023
 37851                                  	; ax = [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] ; *
 37852 00005B86 48                      	dec	ax 
 37853 00005B87 751D                    	jnz	short $MIF352 ; word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] <> 1
 37854                                  
 37855 00005B89 E85200                  	call	$M_YEAR				;;AN000;; Get Year
 37856 00005B8C E86100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37857                                  
 37858 00005B8F FF36[D498]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37859                                  	;push	word [$M_RT+87]			;;AN000;;
 37860                                  	
 37861 00005B93 41                      	inc	cx				;;AN000;; Increment count
 37862 00005B94 31C0                    	xor	ax,ax				;;AN000;; Reset AX
 37863                                  
 37864 00005B96 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 37865                                  	;mov	al,[si+4]			;;AN000;; Get Month
 37866 00005B99 E85400                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37867                                  
 37868 00005B9C FF36[D498]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37869                                  	;push	word [$M_RT+87]			;;AN000;;
 37870                                  
 37871 00005BA0 41                      	inc	cx				;;AN000;;
 37872                                  	      
 37873 00005BA1 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 37874                                  	;mov	al,[si+5]			;;AN000;; Get Day
 37875                                  
 37876                                  	; 12/04/2023
 37877                                  	;call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37878 00005BA4 EB1C                    	jmp	short $MIF354 ; **
 37879                                  	; 12/04/2023
 37880                                  $MIF352:
 37881                                  	; ax = [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT]-1 ; *
 37882 00005BA6 48                      	dec	ax
 37883                                  	;jz	short $MIF353 ; word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT] = 2
 37884                                  	;xor	ax,ax
 37885                                  	;jmp	short $MIF355
 37886                                  	; 12/04/2023
 37887 00005BA7 751C                    	jnz	short $MIF355
 37888                                  $MIF353:
 37889                                  	;cmp	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],2
 37890                                  	;;cmp	word [$M_RT+76],2		;;AN000;; JAPAN Date Format
 37891                                  	;jne	short $MIF355
 37892                                  
 37893 00005BA9 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 37894                                  	;mov	al,[si+5]			;;AN000;; Get Day
 37895 00005BAC E84100                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37896                                  	
 37897 00005BAF FF36[D498]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37898                                  	;push	word [$M_RT+87]			;;AN000;;
 37899                                  
 37900 00005BB3 41                      	inc	cx				;;AN000;;
 37901                                  
 37902 00005BB4 8A4404                  	 mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 37903                                  	;mov	al,[si+4]			;;AN000;; Get Month
 37904 00005BB7 E83600                  	call	$M_CONVERTDATE			;;AN000;; Convert it to an ASCII string
 37905                                  	
 37906 00005BBA FF36[D498]              	 push	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA]
 37907                                  	;push	word [$M_RT+87]			;;AN000;;
 37908                                  	
 37909 00005BBE 41                      	inc	cx				;;AN000;;
 37910                                  
 37911 00005BBF E81C00                  	call	$M_YEAR				;;AN000;; Get Year
 37912                                  	; 12/04/2023
 37913                                  $MIF354:
 37914 00005BC2 E82B00                  	call	$M_CONVERTDATE	; **		;;AN000;; Convert it to an ASCII string
 37915                                  $MIF355:
 37916 00005BC5 55                      	push	bp				;;AN000;; Restore return address
 37917 00005BC6 C3                      	retn					;;AN000;; Return
 37918                                  
 37919                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37920                                  ;;
 37921                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37922                                  
 37923                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37924                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37925                                  $M_GET_DATE:
 37926                                  	;mov	ah,38h ; DOS_GET_COUNTRY	;;AN000;; Call DOS for country dependant info
 37927                                  	;mov	al,0 				;;AN000;; Get current country info
 37928                                  	; 12/04/2023
 37929 00005BC7 B80038                  	mov	ax,3800h
 37930                                  	;
 37931 00005BCA 8D16[C998]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37932                                  	;lea	dx,[$M_RT+76]			;;AN000;; Set up addressibility to buffer
 37933 00005BCE CD21                    	int	21h				;;AN000;;
 37934 00005BD0 730B                    	jnc	short $MIF357
 37935                                  	;
 37936 00005BD2 C706[C998]0000          	mov	word [$M_RT+$M_COUNTRY_INFO.$M_DATE_FORMAT],0 ; $M_DEF_DATE_FORM
 37937                                  	;mov	word [$M_RT+76+0],0		;;AN000;; Set default date format (BH)
 37938 00005BD8 C606[D498]2D            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_DATE_SEPARA],'-' ; $M_DEF_DATE_SEP
 37939                                  	;mov	byte [$M_RT+87],'-'		;;AN000;; Set default date separator (BL)
 37940                                  $MIF357:
 37941 00005BDD C3                      	retn					;;AN000;;
 37942                                  
 37943                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37944                                  ;;
 37945                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37946                                  
 37947                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37948                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 37949                                  $M_YEAR:
 37950 00005BDE 8B4402                  	mov	ax,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 37951                                  	;mov	ax,[si+2]			;;AN000;; Get Year
 37952                                  
 37953                                  	;test	$M_SL.$M_S_FLAG,Date_MDY_4 and $M_DATE_MASK
 37954 00005BE1 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 37955                                  	;test	byte [si+7],10h			;;AN000;; Was Month/Day/Year (2 Digits) specified?
 37956 00005BE5 7508                    	jnz	short $MIF359			;;AN000;; No
 37957                                  						;;AN000;; Yes
 37958 00005BE7 83F863                  	cmp	ax,99 ; $M_MAX_2_YEAR		;;AN000;;
 37959 00005BEA 7603                    	jna	short $MIF360			;;AN000;;
 37960 00005BEC B86300                  	mov	ax,99 ; $M_MAX_2_YEAR		;;AN000;;
 37961                                  $MIF360:
 37962                                  $MIF359:
 37963 00005BEF C3                      	retn					;;AN000;;
 37964                                  
 37965                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37966                                  ;;
 37967                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37968                                  
 37969                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 37970                                  $M_CONVERTDATE:
 37971                                  $M_CONVERTTIME: ; *!*!  ; 12/04/2023
 37972 00005BF0 8F06[C998]              	pop	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37973                                  	;pop	word [$M_RT+76]			;;AN000;; Save return address
 37974 00005BF4 880E[BF98]              	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl
 37975                                  	;mov	[$M_RT+66],cl			;;AN000;; Save the size before conversion
 37976 00005BF8 E850FC                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to an ASCII string
 37977 00005BFB 49                      	dec	cx				;;AN000;; Test if size only grew by 1
 37978 00005BFC 3A0E[BF98]              	cmp	cl,[$M_RT+$M_RES_ADDRS.$M_SIZE] ;;AN000;; Did size only grow by one?
 37979 00005C00 7505                    	jne	short $MIF363			;;AN000;; No
 37980 00005C02 B83000                  	mov	ax,'0' ; $M_TIMEDATE_PAD ; 30h  ;;AN000;; Get a pad character (0)
 37981 00005C05 50                      	push	ax				;;AN000;; Save it
 37982 00005C06 41                      	inc	cx				;;AN000;; Count it
 37983                                  $MIF363:
 37984 00005C07 41                      	inc	cx				;;AN000;; Restore CX
 37985 00005C08 FF36[C998]              	push	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 37986                                  	;push	word [$M_RT+76]			;;AN000;; Restore return address
 37987 00005C0C C3                      	retn
 37988                                  
 37989                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 37990                                  ;;
 37991                                  ;;	PROC NAME: $M_TIME_REPLACE
 37992                                  ;;
 37993                                  ;;	FUNCTION: Convert a time to a decimal ASCII string
 37994                                  ;;		  and prepare to display
 37995                                  ;;	INPUTS: DS:SI points at corresponding SUBLIST
 37996                                  ;;		ES:DI points at VALUE from SUBLIST
 37997                                  ;;	OUTPUTS: CX contains number of characters on stack
 37998                                  ;;		 Top of stack  --> Last character
 37999                                  ;;					. . .
 38000                                  ;;		 Bot of stack  --> First character
 38001                                  ;;	REGS USED: BP,CX,AX
 38002                                  ;;
 38003                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38004                                  
 38005                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38006                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM							     ;;
 38007                                  $M_TIME_REPLACE:
 38008 00005C0D 5D                      	pop	bp				;;AN000;; Save return address
 38009                                  
 38010 00005C0E C706[C798]0A00          	mov	word [$M_RT+$M_RES_ADDRS.$M_DIVISOR],10 ; $M_BASE10
 38011                                  	;mov	word [$M_RT+74],10		;;AN000;; Set default divisor
 38012                                  
 38013 00005C14 E87800                  	call	$M_GET_TIME			;;AN000;; All O.K.?
 38014                                  
 38015                                  	;test	$M_SL.$M_S_FLAG,Time_Cty_Type and $M_TIME_MASK
 38016 00005C17 F6440701                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],1
 38017                                  	;test	byte [si+7],1			;;AN000;; Is this a request for current country info?
 38018 00005C1B 741A                    	jz	short $MIF365			;;AN000;; No
 38019                                  						;;AN000;; Yes
 38020 00005C1D 803E[DA98]00            	cmp	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],0
 38021                                  	;cmp	byte [$M_RT+93],0		;;AN000;; Is the current country format 12 Hour?
 38022 00005C22 7513                    	jne	short $MIF366			;;AN000;; No
 38023                                  						;;AN000;; Yes
 38024 00005C24 8A4402                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 38025                                  	;mov	al,[si+2]			;;AN000;; Get Hours
 38026 00005C27 3C0C                    	cmp	al,12				;;AN000;; Is hour 12 or less?
 38027 00005C29 7C04                    	jl	short $MLL367 ; jnge		;;AN000;; Yes	
 38028 00005C2B 3C17                    	cmp	al,23				;;AN000;; Is hour 24 or greater?
 38029 00005C2D 7E04                    	jng	short $MIF367 ; jle		;;AN000;; No
 38030                                  $MLL367:
 38031 00005C2F B061                    	mov	al,'a'	; $M_AM			;;AN000;;
 38032                                  	;push	ax				;;AN000;; Push an "a" to represent AM.
 38033                                  	;inc	cx				;;AN000;;
 38034                                  	;jmp	short $MEN367			;;AN000;;
 38035                                  	; 12/04/2023
 38036 00005C31 EB02                    	jmp	short $MEN367 ; *
 38037                                  $MIF367:
 38038 00005C33 B070                    	mov	al,'p'	; $M_PM			;;AN000;;
 38039                                  $MEN367:	; * ; 12/04/2023
 38040 00005C35 50                      	push	ax				;;AN000;; Push an "p" to represent PM.
 38041 00005C36 41                      	inc	cx				;;AN000;;
 38042                                  ;$MEN367:
 38043                                  $MIF366:
 38044                                  $MIF365:					;;AN000;;
 38045 00005C37 31C0                    	xor	ax,ax				;;AN000;;
 38046 00005C39 31D2                    	xor	dx,dx				;;AN000;;
 38047                                  	
 38048                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSSHH_Cty and $M_SIZE_MASK
 38049 00005C3B F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 38050                                  	;test	byte [si+7],20h			;;AN000;; Was Hour/Min/Sec/Hunds (12 Hour) specified?
 38051 00005C3F 740B                    	jz	short $MIF372			;;AN000;;
 38052                                  
 38053 00005C41 8A4405                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+3]
 38054                                  	;mov	al,[si+5]			;;AN000;; Get Hundreds
 38055 00005C44 E8A9FF                  	call	$M_CONVERTTIME			;;AN000;;
 38056                                  
 38057 00005C47 FF36[D298]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_DECI_SEPARA]
 38058                                  	;push	word [$M_RT+85]			;;AN000;;
 38059 00005C4B 41                      	inc	cx				;;AN000;;
 38060                                  $MIF372:
 38061                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSSHH_Cty and $M_SIZE_MASK
 38062 00005C4C F6440720                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],20h
 38063                                  	;test	byte [si+7],20h			;;AN000;; Was Hour/Min/Sec/Hunds (12 Hour) specified?
 38064 00005C50 7506                    	jnz	short $MLL374			;;AN000;; No
 38065                                  
 38066                                  	;test	$M_SL.$M_S_FLAG,Time_HHMMSS_Cty AND $M_SIZE_MASK
 38067 00005C52 F6440710                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],10h
 38068                                  	;test	byte [si+7],10h			;;AN000;; Was Hour/Min/Sec (12 Hour) specified?
 38069 00005C56 740B                    	jz	short $MIF374			;;AN000;; No
 38070                                  $MLL374:
 38071 00005C58 8A4404                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+2]
 38072                                  	;mov	al,[si+4]			;;AN000;; Get Seconds
 38073 00005C5B E892FF                  	call	$M_CONVERTTIME			;;AN000;;
 38074                                  
 38075 00005C5E FF36[D698]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA]
 38076                                  	;push	word [$M_RT+89]			;;AN000;;
 38077 00005C62 41                      	inc	cx				;;AN000;;
 38078                                  $MIF374:	;;  Do Hour/Min (12 Hour)
 38079 00005C63 8A4403                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE+1]
 38080                                  	;mov	al,[si+3]			;;AN000;; Get Minutes
 38081 00005C66 E887FF                  	call	$M_CONVERTTIME			;;AN000;;
 38082                                  
 38083 00005C69 FF36[D698]              	push	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA]
 38084                                  	;push	word [$M_RT+89]			;;AN000;;
 38085 00005C6D 41                      	inc	cx				;;AN000;;
 38086                                  
 38087 00005C6E 8A4402                  	mov	al,[si+$M_SUBLIST_STRUC.$M_S_VALUE]
 38088                                  	;mov	al,[si+2]			;;AN000;; Get Hours
 38089                                  
 38090                                  	;test	$M_SL.$M_S_FLAG,Time_Cty_Type and $M_TIME_MASK
 38091 00005C71 F6440701                	test	byte [si+$M_SUBLIST_STRUC.$M_S_FLAG],1 
 38092                                  	;test	byte [si+7],1			;;AN000;; Is this a request for current country info?
 38093 00005C75 7413                    	jz	short $MIF376			;;AN000;; No
 38094                                  
 38095 00005C77 803E[DA98]00            	cmp	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],0
 38096                                  	;cmp	byte [$M_RT+93],0		;;AN000;; Is the current country format 12 Hour?
 38097 00005C7C 750C                    	jne	short $MIF377			;;AN000;; No
 38098                                  
 38099 00005C7E 3C0D                    	cmp	al,13				;;AN000;; Is hour less than 12?
 38100 00005C80 7C02                    	jnge	short $MIF378 ; jl
 38101 00005C82 2C0C                    	sub	al,12				;;AN000;; Set to a 12 hour value
 38102                                  $MIF378:
 38103                                  	;cmp	al,0				;;AN000;; Is hour less than 12?
 38104                                  	;jne	short $MIF380			;;AN000;; No
 38105                                  	; 12/04/2023
 38106 00005C84 20C0                    	and	al,al
 38107 00005C86 7502                    	jnz	short $MIF380	
 38108 00005C88 B00C                    	mov	al,12				;;AN000;; Set to a 12 hour value
 38109                                  $MIF380:
 38110                                  $MIF377:
 38111                                  $MIF376:
 38112 00005C8A E8BEFB                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to ASCII
 38113 00005C8D 55                      	push	bp				;;AN000;; Restore return address
 38114 00005C8E C3                      	retn					;;AN000;; Return
 38115                                  
 38116                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38117                                  ;;
 38118                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38119                                  
 38120                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38121                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38122                                  $M_GET_TIME:
 38123                                  	;mov	ah,38h ; DOS_GET_COUNTRY	;;AN000;; Call DOS for country dependant info
 38124                                  	;mov	al,0 				;;AN000;; Get current country info
 38125                                  	; 12/04/2023
 38126 00005C8F B80038                  	mov	ax,3800h
 38127                                  	;
 38128 00005C92 8D16[C998]              	lea	dx,[$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38129                                  	;lea	dx,[$M_RT+76]			;;AN000;; Set up addressibility to buffer
 38130 00005C96 CD21                    	int	21h				;;AN000;;
 38131 00005C98 7310                    	jnc	short $MIF384
 38132                                  
 38133 00005C9A C706[DA98]0100          	mov	word [$M_RT+$M_COUNTRY_INFO.$M_TIME_FORMAT],1 ; $M_DEF_TIME_FORM
 38134                                  	;mov	word [$M_RT+93],1		;;AN000;; Set default time format (BH)
 38135 00005CA0 C606[D698]3A            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_TIME_SEPARA],':' ; $M_DEF_TIME_SEP
 38136                                  	;mov	byte [$M_RT+89],':'		;;AN000;; Set default time separator (BL)
 38137 00005CA5 C606[D298]2E            	mov	byte [$M_RT+$M_COUNTRY_INFO.$M_DECI_SEPARA],'.' ; $M_DEF_DECI_SEP
 38138                                  	;mov	byte [$M_RT+85],'.'		;;AN000;; Set default time separator (BL)		
 38139                                  $MIF384:
 38140 00005CAA C3                      	retn					;;AN000;;
 38141                                  
 38142                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38143                                  ;;
 38144                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38145                                  
 38146                                  	; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 38147                                  
 38148                                  ; 12/04/2023 
 38149                                  ;; ($M_CONVERTTIME is same with $M_CONVERTDATE)
 38150                                  %if 0
 38151                                  $M_CONVERTTIME:
 38152                                  $M_CONVERTDATE: ; *!*!  ; 12/04/2023
 38153                                  	pop	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38154                                  	;pop	word [$M_RT+76]			;;AN000;; Save return address
 38155                                  	mov	[$M_RT+$M_RES_ADDRS.$M_SIZE],cl
 38156                                  	;mov	[$M_RT+66],cl			;;AN000;; Save the size before conversion
 38157                                  	call	$M_CONVERT2ASC			;;AN000;; Convert it to an ASCII string
 38158                                  	dec	cx				;;AN000;; Test if size only grew by 1
 38159                                  	cmp	cl,[$M_RT+$M_RES_ADDRS.$M_SIZE] ;;AN000;; Did size only grow by one?
 38160                                  	jne	short $MIF386			;;AN000;; No
 38161                                  	mov	ax,'0' ; $M_TIMEDATE_PAD ; 30h  ;;AN000;; Get a pad character (0)
 38162                                  	push	ax				;;AN000;; Save it
 38163                                  	inc	cx				;;AN000;; Count itount it
 38164                                  $MIF386:
 38165                                  	inc	cx				;;AN000;; Restore CX
 38166                                  	push	word [$M_RT+$M_RES_ADDRS.$M_TEMP_BUF]
 38167                                  	;push	word [$M_RT+76]			;;AN000;; Restore return address
 38168                                  	retn
 38169                                  %endif
 38170                                  
 38171                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38172                                  ;;
 38173                                  ;;	PROC NAME: $M_WAIT_FOR_INPUT
 38174                                  ;;
 38175                                  ;;	FUNCTION:  To accept keyed input and return extended key value
 38176                                  ;;		   in AX register
 38177                                  ;;	INPUTS:    DL contains the DOS function requested for input
 38178                                  ;;	OUTPUTS:   AX contains the extended key value that was read
 38179                                  ;;	REGS USED:
 38180                                  ;;
 38181                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 38182                                  
 38183                                  	; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38184                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6123h
 38185                                  $M_WAIT_FOR_INPUT:
 38186 00005CAB 51                      	push	cx				;;AN000;; Save CX
 38187 00005CAC 52                      	push	dx				;;AN000;; Save DX
 38188 00005CAD 1E                      	push	ds				;;AN000;; Save Data segment
 38189                                  
 38190 00005CAE 80FAC0                  	cmp	dl,0C0h ; DOS_CLR_KEYB_BUF_MASK	;;AN001;; Are we to clear the keyboard buffer?
 38191 00005CB1 7608                    	jna	short $MIF388	; jbe		;;AN001;; No,
 38192                                  						;;AN001;; Yes,
 38193 00005CB3 88D0                    	mov	al,dl				;;AN001;; Mov function into AL
 38194 00005CB5 240F                    	and	al,0Fh	; LOW_NIB_MASK		;;AN001;; Mask out the C in high nibble
 38195 00005CB7 B40C                    	mov	ah,0Ch	; DOS_CLR_KEYB_BUF 	;;AN001;; Set input function
 38196 00005CB9 EB02                    	jmp	short $MEN388
 38197                                  $MIF388:
 38198 00005CBB 88D4                    	mov	ah,dl				;;AN000;; Put DOS function in AH
 38199                                  $MEN388:
 38200 00005CBD 06                      	push	es				;;AN000;; Get output buffer segment
 38201 00005CBE 1F                      	pop	ds				;;AN000;;
 38202 00005CBF 89FA                    	mov	dx,di				;;AN000;; Get output buffer offset in case needed
 38203 00005CC1 CD21                    	int	21h				;;AN000;; Get keyboard input
 38204 00005CC3 1F                      	pop	ds				;;AN000;;
 38205 00005CC4 80FA0A                  	cmp	dl,0Ah	; DOS_BUF_KEYB_INP	;;AN000;;
 38206                                  	;clc					;;AN000;;
 38207 00005CC7 7412                    	je	short $MIF391
 38208 00005CC9 E85BFB                  	call	$M_IS_IT_DBCS			;;AN000;; Is this character DBCS?
 38209 00005CCC 730B                    	jnc	short $MIF392
 38210 00005CCE 88C1                    	mov	cl,al				;;AN000;; Save first character
 38211 00005CD0 88D4                    	mov	ah,dl				;;AN001;; Get back function
 38212 00005CD2 CD21                    	int	21h				;;AN000;; Get keyboard input
 38213 00005CD4 88CC                    	mov	ah,cl				;;AN000;; Retreive first character  AX = xxxx
 38214 00005CD6 F8                      	clc					;;AN000;; Clear carry condition
 38215 00005CD7 EB02                    	jmp	short $MEN392
 38216                                  $MIF392:
 38217 00005CD9 B400                    	mov	ah,0				;;AN000;; AX = 00xx where xx is SBCS
 38218                                  $MEN392:
 38219                                  $MIF391:
 38220                                  	;jc	short $MIF396 ; 15/06/2023
 38221 00005CDB 5A                      	pop	dx				;;AN000;;
 38222 00005CDC 59                      	pop	cx				;;AN000;;
 38223                                  	;jmp	short $MEN396
 38224 00005CDD C3                      	retn
 38225                                  
 38226                                  	; 15/06/2023
 38227                                  ;$MIF396:
 38228                                  	;add	sp,4				;;AN000;;
 38229                                  	;stc					;;AN000;; Reset carry flag
 38230                                  ;$MEN396:
 38231                                  	;retn					;;AN000;; Return
 38232                                  
 38233                                  ; ----------------------------
 38234                                  ; MSDOS 6.0, TPRINTF.ASM, 1991
 38235                                  ; ----------------------------
 38236                                  ; include msgdcl.inc
 38237                                  ; ----------------------------
 38238                                  
 38239                                  ;============================================================================
 38240                                  ; HIGHLOAD.INC, MSDOS 6.0, 1992
 38241                                  ;============================================================================
 38242                                  ; 15/06/2023 - Retro DOS v4.2 COMMAND.COM
 38243                                  
 38244                                  ;****************************************************************************
 38245                                  ;
 38246                                  ; This file contains routines needed to parse and implement user-given
 38247                                  ; command-line options of the form "/S/L:3,0x500;2;7,127;0x0BE4". InitVar()
 38248                                  ; and Parsevar() are used to parse this data and place it in encoded form into
 38249                                  ; the variables in highvar.inc, for use by the rest of the routines.
 38250                                  ;
 38251                                  ; DeviceHigh accepts this command-line (handled in sysconf.asm, not here):
 38252                                  ;    DEVICEHIGH SIZE=hhhhhh module opts
 38253                                  ; Or, DeviceHigh and LoadHigh accept any of the following:
 38254                                  ;    DH/LH module opts
 38255                                  ;    DH/LH [/S][/L:umb[,size][;umb[,size]]*] module opts
 38256                                  ;    DH/LH [/L:umb[,size][;umb[,size]]*][/S] module opts
 38257                                  ; The initial UMB,SIZE pair designates the module's load address; the remainder
 38258                                  ; of the UMB and SIZE pairs are used to indicate specific UMBs to be left
 38259                                  ; available during the load.
 38260                                  ;
 38261                                  ; When an actual load is ready to be performed, a call to HideUMBs() will
 38262                                  ; temporarily allocate (as owner 8+"HIDDEN  ") all free elements in any
 38263                                  ; upper-memory block which was not specified by the user... in addition, if
 38264                                  ; UMBs were marked to shrink (/S option) to a certain size ("umb,size"), any
 38265                                  ; elements in that umb SAVE the lower-half of the newly-shrunken one are also
 38266                                  ; allocated.  After the load, the function UnHideUMBs() (in highexit.inc) will
 38267                                  ; free any UMBs so allocated.
 38268                                  ;
 38269                                  ; When a device driver loads, there is the additional problem of allocating its
 38270                                  ; initial load site; this should be restricted to the first UMB specified on
 38271                                  ; the command-line.  The function FreezeUM temporarily allocates all remaining
 38272                                  ; free upper-memory elements (as owner 8+"FROZEN  "), except those in the load
 38273                                  ; UMB.  Then the initial allocation may be made, and a call to UnFreeze will
 38274                                  ; return any so-allocated memory elements to FREE, for the true load.  Note
 38275                                  ; that UnFreeze leaves HIDDEN elements allocated; it only frees FROZEN ones.
 38276                                  ;
 38277                                  ;****************************************************************************
 38278                                  
 38279                                  ;___PROCEDURES_______________________________________________________________
 38280                                  ;
 38281                                  ;   AddrToUmb   - converts a segment address in AX to its appropriate UMB #
 38282                                  ;   BigFree     - makes ES:0 point to the largest free MCB in UMB given as AL
 38283                                  ;   FixMem      - scans the UM chain and concatenates adjacent free MCBs
 38284                                  ;   FreezeUM    - Marks FROZEN all UM elements now FREE, save those in load UMB
 38285                                  ;   GetLoadSize - Returns the load UMB minimum size (0 if not specified)
 38286                                  ;   GetLoadUMB  - Returns the load UMB number in AL (-1 if not specified)
 38287                                  ;   GetSize     - Returns the UMB in AL's minimum size (0 if not specified)
 38288                                  ;   GetXNum     - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 38289                                  ;   HideUMBs    - links UMBs and hides upper-memory as appropriate
 38290                                  ;   InitVar     - initializes all the variables used in ParseVar and HideUMBs
 38291                                  ;   NextMCB     - moves an MCB pointer forward to the next MCB
 38292                                  ;   ParseVar    - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 38293                                  ;   PrTable     - produces a printout of the variables in highvar.inc
 38294                                  ;   StoLoadSize - Overrides the load UMB minimum size with what's in AX
 38295                                  ;   StoLoadUMB  - Overrides the load UMB number with what's in AL
 38296                                  ;   UmbHead     - returns in AX the address of the first UMB block (0x9FFF)
 38297                                  ;   UnFreeze    - Marks FROZEN elements as FREE
 38298                                  ;
 38299                                  ;___VARIABLES________________________________________________________________
 38300                                  ;
 38301                                  ;   gnradix     - After a call to GetXNum, is 16 or 10, depending on the # read
 38302                                  ;
 38303                                  ;   Internal:
 38304                                  ;___PROCEDURES_______________________________________________________________
 38305                                  ;
 38306                                  ;   convUMB     - checks after GetXNum to convert an address to a UMB number
 38307                                  ;   findUMB     - makes ES:0 point to the first MCB in UMB given as AL
 38308                                  ;   fm_link     - links UMBs not already linked in
 38309                                  ;   fm_unlink   - unlinks UMBs if fm_umb is set to 0
 38310                                  ;   frezMCB     - marks as 8+FROZEN the MCB at ES:0
 38311                                  ;   hideMCB     - marks as HIDDEN the MCB at ES:0
 38312                                  ;   hideUMB     - marks as HIDDEN all FREE elements in UMB passed as AL
 38313                                  ;   hideUMB?    - hides as appropriate the UMB in CL
 38314                                  ;   hl_unlink   - unlinks UMBs if fm_umb is set to 0; restores strategy too
 38315                                  ;   incArgc     - increments fm_argc, for use with LH command-line parsing
 38316                                  ;   isEOL       - returns with ZF set iff AL contains CR or LF, or 0
 38317                                  ;   isFreeMCB   - returns with ZF set if current MCB (ES:0) is FREE
 38318                                  ;   isFrozMCB   - returns with ZF set if current MCB (ES:0) is FROZEN
 38319                                  ;   isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 38320                                  ;   isSysMCB    - sets ZF iff ES points to an MCB owned by "SC" + (8 or 9)
 38321                                  ;   isTiny      - returns with ZF set if user didn't specify /S
 38322                                  ;   isWhite     - returns with ZF set iff AL contains whitespace (or "=")
 38323                                  ;   loadLow     - returns AL==0 if UMB0 == 0, else AL==1
 38324                                  ;   mul32       - multiplies the number in DX:AX by gnradix
 38325                                  ;   parseL      - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 38326                                  ;   setUMBs     - links umbs and sets allocation strategy for a load
 38327                                  ;   shrinkMCB   - breaks an MCB into two pieces, the lowest one's size==AX
 38328                                  ;   stowSiz     - marks a given UMB as having a given minimum size
 38329                                  ;   stowUMB     - marks a given UMB as used, if it hasn't been so marked before
 38330                                  ;   toDigit     - converts a character-digit to its binary counterpart
 38331                                  ;   toPara      - divides DX:AX by 16; result in AX only
 38332                                  ;   toUpper     - accepts one argument (probly a register), and upper-cases it.
 38333                                  ;   unHideMCB   - marks as FREE the MCB at ES:0
 38334                                  ;   unMarkUMB   - marks a given UMB as unused, even if previously marked used
 38335                                  ;
 38336                                  ;****************************************************************************
 38337                                  
 38338                                  ;DOS_CHECK_STRATEGY equ 5800h ; Int 21h, Func 58h, Svc 0 = check alloc strat
 38339                                  ;DOS_SET_STRATEGY   equ 5801h ; Int 21h, Func 58h, Svc 1 = set alloc strategy
 38340                                  ;DOS_CHECK_UMBLINK  equ 5802h ; Int 21h, Func 58h, Svc 2 = check link state
 38341                                  ;DOS_SET_UMBLINK    equ 5803h ; Int 21h, Func 58h, Svc 3 = set link state
 38342                                  ;DOS_GET_DOS_LISTS  equ   52h ; Int 21h, Func 52h = return list of lists
 38343                                  ;DOS_UMB_HEAD       equ   8Ch ; Offset from ES (after func52h) to get UMBHead
 38344                                  
 38345                                  ; -----------------------------------------------------------------------------
 38346                                  ;*** InitVar - initializes all the variables used in ParseVar and HideUMBs
 38347                                  ; -----------------------------------------------------------------------------
 38348                                  ; ENTRY:       None
 38349                                  ; EXIT:        Variables listed in highvar.inc are initialized
 38350                                  ; ERROR EXIT:  None
 38351                                  ; USES:        Flags, variables in highvar.inc
 38352                                  ; -----------------------------------------------------------------------------
 38353                                  ; Note that element 0 references UMB 0 (conventional), not UMB 1.  Its contents
 38354                                  ; are largely ignored, but it is initialized nonetheless.
 38355                                  ; -----------------------------------------------------------------------------
 38356                                  
 38357                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38358                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:615Fh
 38359                                  InitVar:	; proc	near
 38360                                  	;push	ax
 38361                                  	;push	cx
 38362                                  	;push	di
 38363 00005CDE 06                      	push	es ; * es = ds
 38364 00005CDF 8E06[539C]              	mov	es,[RESSEG]		;Point ES into appropriate data segment
 38365 00005CE3 31C0                    	xor	ax,ax
 38366                                  	;mov	[es:fUmbTiny],al	;Shrink UMBs? (made 1 if /S given)
 38367                                  	;mov	[es:fInHigh],al		;Set to 1 when DH/LH has been called
 38368 00005CE5 26A3[3005]              	mov	[es:fInHigh],ax ; 16/06/2023
 38369 00005CE9 26A3[3205]              	mov	[es:SegLoad],ax		;Load Address (seg), used for DH only
 38370 00005CED 26C606[3405]FF          	mov	byte [es:UmbLoad],0FFh ;UNSPECIFIED
 38371                                  					;Later is the # of the 1st spec'd UMB
 38372 00005CF3 26A2[3705]              	mov	[es:fm_argc],al		;Start with zero args having been read
 38373                                  
 38374 00005CF7 FC                      	cld
 38375                                  
 38376 00005CF8 B91000                  	mov	cx,16 ; MAXUMB		;For each entry
 38377 00005CFB BF[5E04]                	mov	di,UmbUsed		;on the UmbUsed array,
 38378 00005CFE F3AA                    	rep	stosb			;	Store 0
 38379                                  
 38380                                  	;mov	cx,16 ; MAXUMB		;Okay... for each entry
 38381 00005D00 B110                    	mov	cl,16
 38382 00005D02 BF[6E04]                	mov	di,UmbSize		;on the UmbSize array,
 38383 00005D05 F3AB                    	rep	stosw			;	Store 0
 38384                                  
 38385 00005D07 07                      	pop	es ; * es = ds
 38386                                  	;pop	di
 38387                                  	;pop	cx
 38388                                  	;pop	ax
 38389 00005D08 C3                       	retn
 38390                                  
 38391                                  ;InitVar endp
 38392                                  
 38393                                  ; -----------------------------------------------------------------------------
 38394                                  ;*** FixMem - scans the upper memory chain and concatenates adjacent free MCBs
 38395                                  ; -----------------------------------------------------------------------------
 38396                                  ; ENTRY   : None
 38397                                  ; EXIT    : None
 38398                                  ; ERROR   : None
 38399                                  ; USES    : Flags, fm_umb, fm_strat
 38400                                  ; -----------------------------------------------------------------------------
 38401                                  
 38402                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38403                                  FixMem:
 38404                                  	;push	ax
 38405                                  	;push	bx
 38406                                  	;push	cx
 38407                                  	;push	dx
 38408 00005D09 06                      	push	es
 38409                                  
 38410 00005D0A E84900                  	call	fm_link			; Link in UMBs
 38411                                  
 38412 00005D0D E82302                  	call	UmbHead			; Get first upper-memory MCB address (0x9FFF)
 38413 00005D10 723F                    	jc	short fmX		; (if couldn't get it, leave now).
 38414                                  
 38415 00005D12 8EC0                    	mov	es,ax			; It returns in AX, so move it to ES.
 38416                                  
 38417                                  ; - Walk MCB Chain ------------------------------------------------------------
 38418                                  
 38419 00005D14 31D2                    	xor	dx,dx			; We're keeping the address of the last MCB
 38420 00005D16 89D1                    	mov 	cx,dx			; in CX... and the last owner
 38421 00005D18 42                      	inc	dx			; in dx as we go through the loop:
 38422                                  
 38423                                  ; ------------------------------------------
 38424                                  ; FM10--DX  = last MCB's owner's PSP address
 38425                                  ;       CX  = last MCB's address (segment)
 38426                                  ; ------------------------------------------
 38427                                  
 38428                                  fm10:	
 38429 00005D19 26A00000                	mov	al,[es:arena_signature]	; if 'Z', don't repeat loop
 38430                                  	;mov	al,[es:0]
 38431 00005D1D 268B1E0100              	mov	bx,[es:arena_owner]	; if not zero, do nothing
 38432                                  	;mov	bx,[es:1]
 38433 00005D22 09D3                    	or	bx,dx			; dx was owner of previous MCB
 38434 00005D24 7516                    	jnz	short fm30		; If not both zero, don't cat.
 38435                                  
 38436                                  ; - Coalesce memory blocks at ES:00 and CX:00 ---------------------------------
 38437                                  
 38438                                  fm20:	
 38439 00005D26 268B1E0300              	mov	bx,[es:arena_size]	; Grab this block's Size,
 38440                                  	;mov	bx,[es:3]
 38441 00005D2B 8EC1                    	mov	es,cx			; Go back to prev MCB's address
 38442 00005D2D 26A20000                	mov	[es:arena_signature], al ; & move the SECOND sig here
 38443                                  	;mov	[es:0],al
 38444                                  
 38445 00005D31 26031E0300              	add	bx,[es:arena_size]	; Size += first MCB's size
 38446                                  	;add	bx,1			; And add one for the header
 38447 00005D36 43                      	inc	bx
 38448 00005D37 26891E0300              	mov	[es:arena_size],bx	; Write the size
 38449                                  
 38450                                  	; ---------------------------------------------------------------------
 38451                                  fm30:	
 38452 00005D3C 8CC1                    	mov	cx,es			; Put this address on the stack
 38453 00005D3E 268B160100              	mov	dx,[es:arena_owner]	; And remember its owner
 38454                                  	;mov	dx,[es:1]
 38455                                  
 38456                                  	;NextMCB es,bx			; Move to the next MCB
 38457                                  	
 38458 00005D43 8CC3                    	mov	bx,es
 38459                                  	;add	bx,[es:3]
 38460 00005D45 26031E0300              	add	bx,[es:arena_size]
 38461 00005D4A 43                      	inc	bx
 38462 00005D4B 8EC3                    	mov	es,bx
 38463                                  
 38464                                  	;cmp	al,'Z'	; cmp al,5Ah
 38465 00005D4D 3C5A                    	cmp	al,arena_signature_end
 38466 00005D4F 75C8                    	jnz	short fm10		; If signature != 'Z', there are more.
 38467                                  fmX:	
 38468 00005D51 E81900                  	call	fm_unlink		; Unlink UMBs
 38469                                  
 38470 00005D54 07                      	pop	es
 38471                                  	;pop	dx
 38472                                  	;pop	cx
 38473                                  	;pop	bx
 38474                                  	;pop	ax
 38475 00005D55 C3                      	retn
 38476                                  
 38477                                  ; -----------------------------------------------------------------------------
 38478                                  ; 16/06/2023
 38479                                  
 38480                                  ;INT 21h - DOS 5+ - GET OR SET UMB LINK STATE
 38481                                  ; .......................................................
 38482                                  ;     AH = 58h
 38483                                  ;     AL = subfunction
 38484                                  ;	02h get UMB link state
 38485                                  ;	    Return:
 38486                                  ;		AL = current link state
 38487                                  ;		  00h - UMBs not part of DOS memory chain
 38488                                  ;		  01h - UMBs in DOS memory chain
 38489                                  ;	03h set UMB link state
 38490                                  ;	    BX = new link state
 38491                                  ;		0000h - remove UMBs from DOS memory chain
 38492                                  ;		0001h - add UMBs to DOS memory chain
 38493                                  ;
 38494                                  ;Return: CF clear if successful
 38495                                  ;	CF set on error
 38496                                  ;	AX = error code (01h) (see #01680)
 38497                                  ; .......................................................
 38498                                  
 38499                                  ; -----------------------------------------------------------------------------
 38500                                  ;*** fm_link - links UMBs not already linked in
 38501                                  ; -----------------------------------------------------------------------------
 38502                                  ; ENTRY:    None
 38503                                  ; EXIT:     fm_umb == 0 if not linked in previously, 1 if already linked in
 38504                                  ; ERROR:    None
 38505                                  ; USES:     AX, BX, fm_umb
 38506                                  ; -----------------------------------------------------------------------------
 38507                                  
 38508                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38509                                  fm_link:
 38510 00005D56 B80258                  	mov	ax,5802h ; DOS_CHECK_UMBLINK
 38511 00005D59 CD21                    	int	21h			; Current link-state is now in al
 38512                                  
 38513                                  	;putdata fm_umb,al		; So store it in fm_umb for later
 38514                                  
 38515                                  	;push	es
 38516                                  	;mov	es,[RESSEG]
 38517                                  	;mov	[es:fm_umb],al
 38518                                  	;pop	es
 38519 00005D5B 1E                      	push	ds
 38520 00005D5C 8E1E[539C]              	mov	ds,[RESSEG]
 38521 00005D60 A2[3505]                	mov	[fm_umb],al
 38522 00005D63 1F                      	pop	ds
 38523                                  
 38524 00005D64 B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 38525 00005D67 BB0100                  	mov	bx,1
 38526 00005D6A CD21                    	int	21h
 38527 00005D6C C3                      	retn
 38528                                  
 38529                                  ; -----------------------------------------------------------------------------
 38530                                  ;*** fm_unlink - unlinks UMBs if fm_umb is set to 0
 38531                                  ; -----------------------------------------------------------------------------
 38532                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 38533                                  ; EXIT:     None
 38534                                  ; ERROR:    None
 38535                                  ; USES:     AX, BX
 38536                                  ; -----------------------------------------------------------------------------
 38537                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38538                                  fm_unlink:
 38539 00005D6D 31DB                    	xor	bx,bx
 38540                                  	
 38541                                  	;getdata bl,fm_umb		; fm_umb already has the old link-state
 38542                                  
 38543 00005D6F 1E                      	push    ds
 38544 00005D70 8E1E[539C]              	mov     ds,[RESSEG]
 38545 00005D74 8A1E[3505]              	mov     bl,[fm_umb]
 38546 00005D78 1F                      	pop     ds
 38547                                  	
 38548 00005D79 B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 38549 00005D7C CD21                    	int	21h			; so just use that, and call int 21h
 38550 00005D7E C3                      	retn
 38551                                  
 38552                                  ; -----------------------------------------------------------------------------
 38553                                  ;*** ParseVar - parses [/S][/L:umb[,size][;umb[,size]]*] and builds the table
 38554                                  ; laid out in highvar.inc
 38555                                  ; -----------------------------------------------------------------------------
 38556                                  ; ENTRY:    ES:SI points to command tail of LoadHigh/DeviceHigh (whitespace ok)
 38557                                  ; EXIT:     ES:SI points to first character in child program name
 38558                                  ; ERROR:    ES:SI points to character which caused error, carry set, AX == code
 38559                                  ; USES:     ES:SI, AX, flags, variables in highvar.inc
 38560                                  ; -----------------------------------------------------------------------------
 38561                                  ; Error codes (in AX if carry set on return):
 38562                                  ;
 38563                                  
 38564                                  ;PV_InvArg	equ	1	; Invalid argument passed
 38565                                  ;PV_BadUMB	equ	2	; Bad UMB number passed (duplicate?)
 38566                                  ;PV_InvSwt	equ	3	; Unrecognized switch passed
 38567                                  
 38568                                  ;
 38569                                  ; This routine exects ES:SI to point to a string much like the following:
 38570                                  ;    "/S/L:1,200;2 module options"
 38571                                  ; Optionally, the string can begin with whitespace; neither /S nor /L is
 38572                                  ; required, though that's what this routine is supposed to parse.
 38573                                  ;
 38574                                  
 38575                                  ;optS		equ	'S'	; /S
 38576                                  ;optL		equ	'L'	; /L:...
 38577                                  
 38578                                  ;
 38579                                  ; -----------------------------------------------------------------------------
 38580                                  ; LoadHigh has a list of arguments, returned by cparse, which is used to create
 38581                                  ; a command-line for spawning a child process. For a typical LH command, say,
 38582                                  ;     lh /l:1,1000;2 print/d:lpt2
 38583                                  ; the arguments would look like (one per line):
 38584                                  ;     lh
 38585                                  ;     /l
 38586                                  ;     1
 38587                                  ;     1000
 38588                                  ;     2
 38589                                  ;     print
 38590                                  ;     /d
 38591                                  ;     :lpt2
 38592                                  ; In short, if "print" were, say, "43", there'd be no way to determine which
 38593                                  ; arg was the filename. So, inside this routine, we keep a running counter
 38594                                  ; of the number of arguments LH will need to skip in order to get to the
 38595                                  ; program name. The "lh" is implicit--it'll always have to skip that. So if
 38596                                  ; there's no "/l" or "/s", fm_argc will be 0 ... other than that, 1 is added
 38597                                  ; for:
 38598                                  ;    Each /L
 38599                                  ;    Each /S (there should be only one)
 38600                                  ;    Each UMB number (they follow ":" or ";")
 38601                                  ;    Each UMB size   (they follow ",")
 38602                                  ; So, in the above example, fm_argc would be 4-- and LH would skip right to
 38603                                  ; "print". Note that InitVar initializes fm_argc to zero.
 38604                                  ; -----------------------------------------------------------------------------
 38605                                  
 38606                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38607                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6216h
 38608                                  ParseVar:	; proc	near
 38609                                  	;push	di
 38610                                  	;push	ds ; *
 38611                                  	;push	es
 38612                                  	;
 38613                                  	; 16/06/2023
 38614                                  	; es = ds (from 'ParseLhCmd')
 38615                                  	;push	es		; Make DS:SI point to it, as well as ES:SI
 38616                                  	;pop	ds		; (regardless if we're in devhigh or loadhigh)
 38617                                  	
 38618 00005D7F FC                      	cld
 38619                                  
 38620                                  ; ------------------------------------------------
 38621                                  ; PV10--ES:SI = any whitespace on the command-line
 38622                                  ; ------------------------------------------------
 38623                                  
 38624                                  pv10:	
 38625 00005D80 AC                      	lodsb			; here, ES:SI=="  /L..."--must eat whitespace
 38626 00005D81 E8A800                  	call	isWhite
 38627 00005D84 74FA                    	jz	short pv10	;       ES:SI==" /L..."--keep eating.
 38628 00005D86 3C2F                    	cmp	al,'/' ; SWTCH
 38629 00005D88 7404                    	je	short pv20	;       ES:SI=="/L..."--go process a switch
 38630                                  
 38631 00005D8A 4E                      	dec	si		; Backup--it's now "odule options", and we need
 38632 00005D8B F8                      	clc			; that "m" we just read (or whatever it is).
 38633 00005D8C EB2C                    	jmp	short pvX	; Then return with carry clear == we're done.
 38634                                  pv20:
 38635 00005D8E AC                      	lodsb			; Just read 'S' or 'L', hopefully
 38636                                  
 38637                                  	;toUpper al		; So we make it upper-case, and...
 38638 00005D8F 24DF                    	and	al,0DFh
 38639                                  
 38640 00005D91 3C53                    	cmp	al,'S' ; optS	; just read 'S'?
 38641 00005D93 7510                    	jne	short pv30
 38642                                  
 38643 00005D95 E87E00                  	call	incArgc		; If it's /S, it's another arg for LH to skip.
 38644                                  
 38645                                  	;putdata fUmbTiny,1	; /S, so ES:SI=="  /L..." or " module opts", or
 38646                                  
 38647                                  	;push	es
 38648                                  	;mov	es,[RESSEG]
 38649                                  	;mov	byte [es:fUmbTiny],1
 38650                                  	;pop	es
 38651 00005D98 1E                      	push	ds
 38652 00005D99 8E1E[539C]              	mov	ds,[RESSEG]
 38653 00005D9D C606[3105]01            	mov	byte [fUmbTiny],1
 38654 00005DA2 1F                      	pop	ds
 38655                                  
 38656 00005DA3 EBDB                    	jmp	short pv10	; possibly even "/L...".
 38657                                  pv30:	
 38658 00005DA5 3C4C                    	cmp	al,'L' ; optL	; If it's not 'L' either, then it's a bad
 38659 00005DA7 750B                    	jne	short pvE1	; switch!
 38660                                  
 38661 00005DA9 E86A00                  	call	incArgc		; If it's /L, it's another arg for LH to skip.
 38662                                  
 38663 00005DAC E80C00                  	call	parseL
 38664 00005DAF 73CF                    	jnc	short pv10	; If no carry, go back and look for more
 38665                                  
 38666 00005DB1 4E                      	dec	si		; Else, back up and exit.
 38667 00005DB2 EB03                    	jmp	short pvErr	; AX has already been set by parseL
 38668                                  pvE1:	
 38669 00005DB4 B80300                  	mov	ax,3 ; PV_InvSwt
 38670                                  				; Unrecognized switch passed
 38671                                  pvErr:
 38672 00005DB7 4E                      	dec	si
 38673 00005DB8 4E                      	dec	si
 38674 00005DB9 F9                      	stc
 38675                                  pvX:	
 38676                                  	;pop	es
 38677                                  	;pop	ds ; *
 38678                                  	;pop	di
 38679 00005DBA C3                      	retn
 38680                                  
 38681                                  ;ParseVar endp
 38682                                  
 38683                                  ; -----------------------------------------------------------------------------
 38684                                  ;*** parseL - parses ":nnnn[,nnnn][;nnnn[,nnnn]]*" for ParseVar
 38685                                  ; -----------------------------------------------------------------------------
 38686                                  ; ENTRY:    ES:SI points to colon
 38687                                  ; EXIT:     ES:SI points to first character not parsed
 38688                                  ; ERROR:    Carry set; rewind three characters and return (see ParseVar)
 38689                                  ; USES:     ES:SI, flags, AX, CX, DX, variables in highvar.inc
 38690                                  ; -----------------------------------------------------------------------------
 38691                                  ; If the string here is terminated with anything other than whitespace or a
 38692                                  ; switchchar (perhaps it's /S or another /L:... ), then we return with carry
 38693                                  ; set, indicating that they've screwed up the syntax.  The 3-character rewind
 38694                                  ; makes sure the app /L: is reported as being the culprit.
 38695                                  ; -----------------------------------------------------------------------------
 38696                                  
 38697                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38698                                  parseL:
 38699 00005DBB AC                      	lodsb
 38700 00005DBC 3C3A                    	cmp	al,':'		; Make sure they did /L:
 38701 00005DBE 754A                    	jne	short plE1	; If they didn't, return with carry set.
 38702                                  
 38703                                  ; ------------------------------------------
 38704                                  ; PL10--ES:SI = a UMB number, after /L: or ;
 38705                                  ; ------------------------------------------
 38706                                  
 38707                                  pl10:
 38708 00005DC0 E8FD00                  	call	GetXNum		; After this, 'tis ",size" or ";umb" or " mod"
 38709 00005DC3 724B                    	jc	short plE2	; And error if it's a bad number.
 38710 00005DC5 E8C801                  	call	convUMB		; Convert any address to a UMB number
 38711                                  
 38712 00005DC8 88C1                    	mov	cl,al	; !*	; Remember the UMB number
 38713 00005DCA E88300                  	call	stowUMB		; Mark this UMB # as used;
 38714 00005DCD 7241                    	jc	short plE2	; If it was already marked, it'll error
 38715                                  
 38716 00005DCF E84400                  	call	incArgc		; Each UMB number is another arg for LH to skip
 38717                                  
 38718 00005DD2 AC                      	lodsb
 38719 00005DD3 3C3B                    	cmp	al,';'		; Did "umb;" ?
 38720 00005DD5 74E9                    	je	short pl10	; Yep: go back and get another UMB.
 38721                                  
 38722 00005DD7 E85200                  	call	isWhite		; Did "umb " ?
 38723 00005DDA 7439                    	jz	short plX	; Yep: return (it'll go back to whitespace)
 38724                                  
 38725 00005DDC E84200                  	call	isEOL		; Did "umb" ?
 38726 00005DDF 7433                    	jz	short plSwX	; If so, backup and exit like everything's ok
 38727                                  
 38728 00005DE1 3C2F                    	cmp	al,'/' ; SWTCH	; Did "umb/" ? (as in, "/L:1,100;2/S")
 38729 00005DE3 742F                    	je	short plSwX	; If so, back up ES:SI one character and return
 38730                                  
 38731 00005DE5 3C2C                    	cmp	al,','		; Did "umb," ?
 38732 00005DE7 7521                    	jne	short plE1	; Just what the heck DID they do? Return error.
 38733                                  
 38734                                  ; --- Read a size -------------------------------------------------------------
 38735                                  
 38736 00005DE9 E8D400                  	call	GetXNum		; Stop on "size;" or "size " or anything else
 38737 00005DEC 721C                    	jc	short plE1	; And error if it's a bad size.
 38738                                  
 38739 00005DEE E83401                  	call	toPara		; Convert from bytes to paragraphs
 38740                                  
 38741 00005DF1 E88600                  	call	stowSiz		; CL still has the UMB number for this routine
 38742                                  
 38743 00005DF4 E81F00                  	call	incArgc		; Each UMB size is another arg for LH to skip
 38744                                  
 38745 00005DF7 AC                      	lodsb
 38746 00005DF8 3C3B                    	cmp	al,';'		; They did "umb,size;", so get another UMB.
 38747 00005DFA 74C4                    	je	short pl10		;
 38748                                  
 38749 00005DFC E82D00                  	call	isWhite		; Did it end with whitespace?
 38750 00005DFF 7414                    	jz	short plX	; If so, we're done here--go back.
 38751                                  
 38752 00005E01 E81D00                  	call	isEOL		; Did they do "umb,size" and end??? (stupid)
 38753 00005E04 740E                    	jz	short plSwX	; If so, backup and exit like everything's ok
 38754                                  
 38755 00005E06 3C2F                    	cmp	al,'/' ; SWTCH	; Did they do "umb,size/" ?
 38756 00005E08 740A                    	je	short plSwX	; If so, again, we're done here.
 38757                                  plE1:	
 38758 00005E0A B80100                  	mov	ax,1 ; PV_InvArg
 38759                                  				; If not, we don't know WHAT they did...
 38760 00005E0D 4E                      	dec	si
 38761 00005E0E F9                      	stc
 38762 00005E0F C3                      	retn
 38763                                  plE2:
 38764                                  	; cf = 1 
 38765 00005E10 B80200                  	mov	ax,2 ; PV_BadUMB
 38766                                  				; In this case, they've specified a UMB twice
 38767                                  	;stc
 38768 00005E13 C3                      	retn
 38769                                  plSwX:
 38770 00005E14 4E                      	dec	si		; If we hit a '/' character, back up one char
 38771                                  				; so the whitespace checker will see it too.
 38772                                  plX:
 38773                                  	; cf = 0
 38774                                  	;clc			; Then just return with carry clear, so
 38775 00005E15 C3                      	retn			; ParseVar will go about its business.
 38776                                  
 38777                                  ; -----------------------------------------------------------------------------
 38778                                  ;*** incArgc - increments fm_argc, for use with LoadHigh command-line parsing
 38779                                  ; -----------------------------------------------------------------------------
 38780                                  ; ENTRY:    None
 38781                                  ; EXIT:     None
 38782                                  ; ERROR:    None
 38783                                  ; USES:     fm_argc, flags
 38784                                  ; -----------------------------------------------------------------------------
 38785                                  
 38786                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38787                                  incArgc:
 38788                                  	;push	ax
 38789                                  
 38790                                  	;;getdata al,fm_argc	; Obtain previous value of fm_argc,
 38791                                  	;
 38792                                  	;push	ds		; getdata (macro)
 38793                                  	;			; getdata al, fm_argc
 38794                                  	;mov	ds,[RESSEG]
 38795                                  	;mov	al,[fm_argc]	; Obtain previous value of fm_argc,
 38796                                  	;pop	ds
 38797                                  	;
 38798                                  	;inc	al		; Increment it,
 38799                                  	;
 38800                                  	;;putdata fm_argc,al	; And store it right back.
 38801                                  	;
 38802                                  	;push	es		; putdata (macro)
 38803                                  	;			; putdata fm_argc, al
 38804                                  	;mov	es,[RESSEG]
 38805                                  	;mov	[es:fm_argc],al	; and store it right back.
 38806                                  	;pop	es
 38807                                  
 38808                                  	; 16/06/2023
 38809 00005E16 1E                      	push	ds
 38810 00005E17 8E1E[539C]              	mov	ds,[RESSEG]
 38811 00005E1B FE06[3705]              	inc	byte [fm_argc]	; increment fm_argc
 38812 00005E1F 1F                      	pop	ds
 38813                                  
 38814                                  	;pop	ax
 38815 00005E20 C3                      	retn
 38816                                  
 38817                                  ; -----------------------------------------------------------------------------
 38818                                  ;*** isEOL - returns with ZF set iff AL contains CR or LF, or 0
 38819                                  ; -----------------------------------------------------------------------------
 38820                                  ; ENTRY:    AL contains character to test
 38821                                  ; EXIT:     ZF set if AL contains CR or LF, or 0
 38822                                  ; ERROR:    None
 38823                                  ; USES:     ZF
 38824                                  ; -----------------------------------------------------------------------------
 38825                                  
 38826                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38827                                  isEOL:
 38828                                  	;cmp	al,0		; Null-terminator
 38829 00005E21 20C0                    	and	al,al
 38830 00005E23 7406                    	jz	short ieX
 38831 00005E25 3C0D                    	cmp	al,0Dh ; CR	; Carriage Return
 38832 00005E27 7402                    	je	short ieX
 38833 00005E29 3C0A                    	cmp	al,0Ah ; LF	; LineFeed
 38834                                  ieX:
 38835 00005E2B C3                      	retn
 38836                                  
 38837                                  
 38838                                  ; -----------------------------------------------------------------------------
 38839                                  ;*** isWhite - returns with ZF set iff AL contains whitespace (or "=")
 38840                                  ; -----------------------------------------------------------------------------
 38841                                  ; ENTRY:    AL contains character to test
 38842                                  ; EXIT:     ZF set if AL contains space, tab, or equals
 38843                                  ; ERROR:    None
 38844                                  ; USES:     ZF
 38845                                  ; -----------------------------------------------------------------------------
 38846                                  
 38847                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38848                                  isWhite:
 38849 00005E2C 3C20                    	cmp	al,' '		; Space
 38850 00005E2E 7406                    	je	short iwX
 38851 00005E30 3C3D                    	cmp	al,'='		; Equals (treat as whitespace)
 38852 00005E32 7402                    	je	short iwX
 38853 00005E34 3C09                    	cmp	al,09h ; TAB	; Tab
 38854                                  iwX:
 38855 00005E36 C3                      	retn
 38856                                  
 38857                                  ; -----------------------------------------------------------------------------
 38858                                  ;*** unMarkUMB - marks a given UMB as unused, even if previously marked used
 38859                                  ; -----------------------------------------------------------------------------
 38860                                  ; ENTRY:    AL contains UMB number
 38861                                  ; EXIT:     None
 38862                                  ; ERROR:    None
 38863                                  ; USES:     Flags, variables in highvar.inc
 38864                                  ; -----------------------------------------------------------------------------
 38865                                  
 38866                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38867                                  unMarkUMB:
 38868                                  	;;pushreg <ax,bx,di,es>
 38869                                  	;push	ax ; ***
 38870                                  	
 38871                                  	;push	bx ; **
 38872                                  	
 38873                                  	;push	di
 38874                                  	;push	es
 38875 00005E37 1E                      	push	ds ; *	
 38876                                  
 38877                                  	;;dataseg es
 38878                                  	;mov	es,[RESSEG]
 38879                                  
 38880 00005E38 8E1E[539C]              	mov	ds,[RESSEG] ; *
 38881                                  	
 38882                                  	;xor	ah,ah ; 0
 38883                                  	;mov	bx,ax
 38884                                  	;mov	byte [es:bx+UmbUsed],0
 38885                                  	;mov	[bx+UmbUsed],ah ; marks the UMB as unused
 38886 00005E3C 88C3                    	mov	bl,al
 38887 00005E3E 30FF                    	xor	bh,bh ; 0	
 38888 00005E40 88BF[5E04]              	mov	[bx+UmbUsed],bh ; 0 ; **
 38889                                  
 38890                                  	;cmp	[es:UmbLoad],al
 38891                                  	;jnz	short umu10
 38892 00005E44 3806[3405]              	cmp	[UmbLoad],al
 38893 00005E48 7504                    	jne	short umu10
 38894                                  
 38895                                  	;mov	byte [es:UmbLoad],0
 38896                                  	;mov	[UmbLoad],ah	; If unmarked the load UMB, load into convent.
 38897 00005E4A 883E[3405]              	mov	[UmbLoad],bh ; 0 ; **
 38898                                  umu10:	
 38899 00005E4E 1F                      	pop	ds ; *
 38900                                  	;;popreg <es,di,bx,ax>
 38901                                  	;pop	es
 38902                                  	;pop	di
 38903                                  	
 38904                                  	;pop	bx ; **
 38905                                  	
 38906                                  	;pop	ax ; ***
 38907                                  
 38908                                  	;;normseg es
 38909                                  	
 38910 00005E4F C3                      	retn
 38911                                  
 38912                                  ; -----------------------------------------------------------------------------
 38913                                  ;*** stowUMB - marks a given UMB as used, if it hasn't been so marked before
 38914                                  ;            -- accepts a UMB # in AL, and makes sure it hasn't yet been
 38915                                  ; listed in the /L:... chain.  If it's the first one specified, it sets UmbLoad
 38916                                  ; to that UMB #... and in any case, it marks the UMB as specified.
 38917                                  ; -----------------------------------------------------------------------------
 38918                                  ; ENTRY:    AL contains UMB number, as specified by the user
 38919                                  ; EXIT:     None
 38920                                  ; ERROR:    Carry set if UMB # is less than 0 or >= MAXUMB (see highvar.inc)
 38921                                  ; USES:     AX, Flags, variables in highvar.inc
 38922                                  ; -----------------------------------------------------------------------------
 38923                                  
 38924                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38925                                  stowUMB:
 38926 00005E50 3C10                    	cmp	al,16 ; MAXUMB
 38927 00005E52 7202                    	jb	short su10
 38928 00005E54 F9                      	stc
 38929 00005E55 C3                      	retn			; Ooops-- UMB>=MAXUMB
 38930                                  su10:
 38931                                  	;pushreg <bx,di,si,ds,es>
 38932                                  	;dataseg es		; Point ES into appropriate data segment
 38933                                  	;dataseg ds		; Point DS into appropriate data segment
 38934                                  
 38935                                  	;push	bx ; **
 38936                                  	
 38937                                  	;push	di
 38938                                  	;push	si
 38939                                  
 38940 00005E56 1E                      	push	ds ; *
 38941                                  
 38942                                  	;push	es
 38943                                  	;mov	es,[RESSEG]
 38944 00005E57 8E1E[539C]              	mov	ds,[RESSEG]
 38945                                  
 38946 00005E5B 803E[3405]FF            	cmp	byte [UmbLoad],0FFh ; UNSPECIFIED
 38947                                  				; If this, we haven't been here before
 38948 00005E60 7503                    	jne	short su20
 38949 00005E62 A2[3405]                	mov	[UmbLoad],al	; So remember this UMB as the load UMB slot.
 38950                                  su20:	
 38951 00005E65 08C0                    	or	al,al		; If they gave UMB 0, there's really nothing
 38952 00005E67 740F                    	jz	short su30	; that we should do here.
 38953                                  
 38954                                  	;mov	bl,al
 38955                                  	;xor	bh,bh
 38956                                  	;mov	ax,1		; Now, AX = 1, and BX = UMB Number
 38957 00005E69 30E4                    	xor	ah,ah
 38958 00005E6B 89C3                    	mov	bx,ax
 38959 00005E6D B001                    	mov	al,1
 38960                                  
 38961                                  	;xchg	[es:bx+UmbUsed],al
 38962 00005E6F 8687[5E04]              	xchg	[bx+UmbUsed],al
 38963                                  
 38964 00005E73 08C0                    	or	al,al		; If it was already 1, then al==1... and that
 38965 00005E75 7401                    	jz	short su30	; means an error.
 38966                                  
 38967 00005E77 F9                      	stc			; OOOPS! This one's been used before. :(
 38968                                  su30:	
 38969                                  	;popreg	<es,ds,si,di,bx>
 38970                                  	;normseg ds
 38971                                  	;normseg es
 38972                                  	;retn
 38973                                  
 38974                                  	;pop	es
 38975                                  	
 38976 00005E78 1F                      	pop	ds ; *
 38977                                  	
 38978                                  	;pop	si
 38979                                  	;pop	di
 38980                                  	
 38981                                  	;pop	bx ; **
 38982                                  
 38983 00005E79 C3                      	retn
 38984                                  
 38985                                  ; -----------------------------------------------------------------------------
 38986                                  ;*** stowSiz - marks a given UMB as having a given minimum size
 38987                                  ; -----------------------------------------------------------------------------
 38988                                  ; ENTRY:    CL contains UMB number, AX contains size
 38989                                  ; EXIT:     None
 38990                                  ; ERROR:    None
 38991                                  ; USES:     AX, DX, Flags, variables in highvar.inc
 38992                                  ; -----------------------------------------------------------------------------
 38993                                  	
 38994                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 38995                                  stowSiz:
 38996                                  	;pushreg <bx,di,es>
 38997                                  	;dataseg es		; Point ES into appropriate data seg
 38998                                  
 38999                                  	;push	bx ; **
 39000                                  	
 39001                                  	;push	di
 39002                                  	;push	es
 39003                                  	;mov	es,[RESSEG]
 39004 00005E7A 1E                      	push	ds ; *
 39005 00005E7B 8E1E[539C]              	mov	ds,[RESSEG]
 39006                                  
 39007 00005E7F 88CB                    	mov	bl,cl		; Now bl==UMB number, AX==size
 39008 00005E81 B700                    	mov	bh,0		;     bx==UMB number, AX==size
 39009 00005E83 D0E3                    	shl	bl,1		;     bx==offset into array, AX=size
 39010                                  	;mov	[es:bx+UmbSize],ax
 39011 00005E85 8987[6E04]              	mov	[bx+UmbSize],ax	; Store the size
 39012                                  
 39013 00005E89 1F                      	pop	ds ; *
 39014                                  
 39015                                  	;popreg	<es,di,bx>
 39016                                  	;normseg es		; Return ES to where it was
 39017                                  
 39018                                  	;pop	es
 39019                                  	;pop	di
 39020                                  	
 39021                                  	;pop	bx ; **
 39022                                  
 39023 00005E8A C3                      	retn
 39024                                  
 39025                                  ; -----------------------------------------------------------------------------
 39026                                  ;*** toDigit - converts a character-digit to its binary counterpart
 39027                                  ;            -- verifies that CL contains a valid character-digit; if so, it
 39028                                  ; changes CL to its counterpart binary digit ((CL-'0') or (CL-'A'+10)).  A-F
 39029                                  ; are considered valid iff gnradix is 16.
 39030                                  ; -----------------------------------------------------------------------------
 39031                                  ; ENTRY:    CL contains a digit ('0' to '9' or, if gnradix==16, 'A' to 'F')
 39032                                  ; EXIT:     CL contains digit in binary (0 to 9 or, if gnradix==16, 0 to 15)
 39033                                  ; ERROR:    Carry set indicates invalid digit; carry clear indicates good digit
 39034                                  ; USES:     CL, Flags
 39035                                  ; -----------------------------------------------------------------------------
 39036                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 39037                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 39038                                  ; will be 10 or 16.
 39039                                  ; -----------------------------------------------------------------------------
 39040                                  
 39041                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39042                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6358h
 39043                                  gnradix:
 39044 00005E8B 0000                    	dw	0		; Must be a word--16x16 multiplication
 39045                                  
 39046                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39047                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:635Ah
 39048                                  toDigit:
 39049                                  	;cmp	word [gnradix],16
 39050 00005E8D 803E[8B5E]10            	cmp	byte [gnradix],16
 39051 00005E92 751C                    	jne	short td20	; Don't check hex digits if radix isn't 16
 39052                                  
 39053 00005E94 80F961                  	cmp	cl,'a'
 39054 00005E97 7209                    	jb	short td10
 39055 00005E99 80F966                  	cmp	cl,'f'
 39056 00005E9C 7720                    	ja	short tdE	; Nothing valid above 'z' at all...
 39057 00005E9E 80E957                  	sub	cl,'a'-10 ; 57h	; Make 'a'==10 and return.
 39058                                  ;	clc			; <- CLC is implicit from last SUB
 39059 00005EA1 C3                      	retn
 39060                                  td10:
 39061 00005EA2 80F941                  	cmp	cl,'A'
 39062 00005EA5 7209                    	jb	short td20	; Below 'A'?  Not a letter...
 39063 00005EA7 80F946                  	cmp	cl,'F'
 39064 00005EAA 7712                    	ja	short tdE	; Above 'F'?  Not a digit.
 39065 00005EAC 80E937                  	sub	cl,'A'-10 ; 37h	; Make 'A'==10 and return.
 39066                                  ;	clc			; <- CLC is implicit from last SUB
 39067                                  tdErr:
 39068 00005EAF C3                      	retn
 39069                                  td20:
 39070 00005EB0 80F930                  	cmp	cl,'0'		; If less than zero,
 39071                                  	;jb	short tdE	; Done.
 39072 00005EB3 72FA                    	jb	short tdErr ; cf = 1
 39073 00005EB5 80F939                  	cmp	cl,'9'		; Or, if greater than nine,
 39074 00005EB8 7704                    	ja	short tdE	; Done.
 39075 00005EBA 80E930                  	sub	cl,'0'	  ; 30h	; Okay--make '0'==0 and return.
 39076                                  ;	clc			; <- CLC is implicit from last SUB
 39077 00005EBD C3                      	retn
 39078                                  tdE:
 39079 00005EBE F9                      	stc
 39080 00005EBF C3                      	retn
 39081                                  
 39082                                  ; -----------------------------------------------------------------------------
 39083                                  ;*** GetXNum - reads a 32-bit ASCII number at ES:SI and returns it in DX:AX
 39084                                  ; -----------------------------------------------------------------------------
 39085                                  ; ENTRY:    ES:SI points to an ascii string to scan
 39086                                  ; EXIT:     ES:SI moved to first invalid digit, DX:AX contains value read
 39087                                  ; ERROR:    Carry set if # is too big, or has no digits (EOL possibly)
 39088                                  ; USES:     ES:SI, DX, AX, Flags, gnradix
 39089                                  ; -----------------------------------------------------------------------------
 39090                                  ; If the string is preceeded with "0x", the value is read as hexadecimal; else,
 39091                                  ; as decimal. After a read, you may check the radix by examining gnradix--it
 39092                                  ; will be 10 or 16.
 39093                                  ; -----------------------------------------------------------------------------
 39094                                  
 39095                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 39096                                  GetXNum:
 39097                                  	;pushreg <bx,cx,ds>
 39098                                  	
 39099                                  	;push	bx ; **
 39100 00005EC0 51                      	push	cx ; *
 39101                                  	
 39102                                  	;push	ds
 39103                                  
 39104 00005EC1 FC                      	cld
 39105 00005EC2 31C0                    	xor	ax,ax
 39106 00005EC4 31DB                    	xor	bx,bx
 39107 00005EC6 31C9                    	xor	cx,cx
 39108 00005EC8 31D2                    	xor	dx,dx		; Start with 0 (makes sense)
 39109                                  
 39110                                  	;mov	word [gnradix],10 ; And default to a radix of 10 (dec)
 39111 00005ECA C606[8B5E]0A            	mov	byte [gnradix],10
 39112                                  
 39113 00005ECF 268A0C                  	mov	cl,[es:si]	; Now AX=0, BX=0, CH=0/CL=char, DX=0
 39114 00005ED2 E8B8FF                  	call	toDigit
 39115 00005ED5 722D                    	jc	short gxnE	; If it's not a digit, leave now.
 39116                                  
 39117 00005ED7 08C9                    	or	cl,cl
 39118 00005ED9 7515                    	jnz	short gxn20	; Doesn't have '0x'
 39119 00005EDB 268A4C01                	mov	cl,[es:si+1]
 39120 00005EDF 80F978                  	cmp	cl,'x'		; Either 'x'...
 39121 00005EE2 7405                    	je	short gxn10
 39122 00005EE4 80F958                  	cmp	cl,'X'		; ...or 'X' means it's hexadecimal
 39123 00005EE7 7507                    	jne	short gxn20
 39124                                  
 39125                                  gxn10:
 39126                                  	;mov	word [gnradix],16
 39127 00005EE9 C606[8B5E]10            	mov	byte [gnradix],16
 39128 00005EEE 46                      	inc	si		; Since we read "0x", march over it.
 39129 00005EEF 46                      	inc	si
 39130                                  
 39131                                  ; ------------------------------------------------------
 39132                                  ; GXN20--ES:SI = a digit in a number; if not, we're done
 39133                                  ;        DX:AX = current total
 39134                                  ;        BX    = 0
 39135                                  ;        CH    = 0
 39136                                  ; ------------------------------------------------------
 39137                                  
 39138                                  gxn20:
 39139 00005EF0 268A0C                  	mov	cl,[es:si]	; Now DX:AX=current total, CH=0/CL=char
 39140 00005EF3 46                      	inc	si
 39141                                  
 39142 00005EF4 E896FF                  	call	toDigit		; Accepts only valid digits, A-F -> 10-16
 39143 00005EF7 720D                    	jc	short gxnQ	; <- Ah... wasn't a digit. Stop.
 39144                                  
 39145 00005EF9 E80E00                  	call	mul32		; Multiply DX:AX by gnradix
 39146 00005EFC 7206                    	jc	short gxnX	; (if it's too big, error out)
 39147                                  
 39148 00005EFE 01C8                    	add	ax,cx		; Add the digit
 39149 00005F00 11DA                    	adc	dx,bx		; (BX is 0!)--Adds 1 if last add wrapped
 39150                                  	;jc	short gxnX	; If _that_ wrapped, it's too big.
 39151                                  	;jmp	short gxn20
 39152 00005F02 73EC                    	jnc	short gxn20
 39153                                  gxnE:
 39154                                  	; cf = 1
 39155                                  	;stc			; In this case, we need to set the carry
 39156                                  	;jmp	short gxnX	; and leave--there were no digits given.
 39157                                  ;gxnQ:
 39158                                  	;dec	si		; Don't read in the offensive character.
 39159                                  	;clc			; And clear carry, so they know it's okay.
 39160                                  gxnX:
 39161                                  	;popreg	<ds,cx,bx>
 39162                                  
 39163                                  	;pop	ds
 39164                                  
 39165 00005F04 59                      	pop	cx ; *
 39166                                  	;pop	bx ; **
 39167                                  
 39168 00005F05 C3                      	retn
 39169                                  gxnQ:
 39170 00005F06 4E                      	dec	si
 39171 00005F07 F8                      	clc
 39172 00005F08 EBFA                    	jmp	short gxnX
 39173                                  
 39174                                  ; -----------------------------------------------------------------------------
 39175                                  ;*** mul32 - multiplies the number in DX:AX by gnradix
 39176                                  ; -----------------------------------------------------------------------------
 39177                                  ; ENTRY:   DX:AX = the number to be multiplied, BX = 0, gnradix = multiplier
 39178                                  ; EXIT:    DX:AX has been multiplied by gnradix if carry clear; BX still 0
 39179                                  ; ERROR:   Carry set if number was too large
 39180                                  ; USES:    Flags, AX, DX
 39181                                  ; -----------------------------------------------------------------------------
 39182                                  
 39183                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39184                                  mul32:
 39185 00005F0A 50                      	push	ax		; DX=old:hi, AX=old:lo, TOS=old:lo, BX=0
 39186 00005F0B 89D0                    	mov	ax,dx		; DX=old:hi, AX=old:hi, TOS=old:lo, BX=0
 39187 00005F0D F726[8B5E]              	mul	word [gnradix]	; DX=?,      AX=new:hi, TOS=old:lo, BX=0
 39188 00005F11 7210                    	jc	short m32E	; Too big?
 39189                                  
 39190 00005F13 89C2                    	mov	dx,ax		; DX=new:hi, AX=new:hi, TOS=old:lo, BX=0
 39191 00005F15 58                      	pop	ax		; DX=new:hi, AX=old:lo, TOS=orig,   BX=0
 39192                                  
 39193 00005F16 87D3                    	xchg	dx,bx		; DX=0,      AX=old:lo, TOS=orig,   BX=new:hi
 39194 00005F18 F726[8B5E]              	mul	word [gnradix]	; DX=carry,  AX=new:lo, TOS=orig,   BX=new:hi
 39195 00005F1C 87D3                    	xchg	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=carry
 39196 00005F1E 01DA                    	add	dx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=carry
 39197 00005F20 31DB                    	xor	bx,bx		; DX=new:hi, AX=new:lo, TOS=orig,   BX=0
 39198 00005F22 C3                      	retn
 39199                                  m32E:
 39200 00005F23 58                      	pop	ax
 39201 00005F24 C3                      	retn
 39202                                  
 39203                                  ; -----------------------------------------------------------------------------
 39204                                  ;*** toPara - divides DX:AX by 16; result in AX only (discards extra DX data)
 39205                                  ; -----------------------------------------------------------------------------
 39206                                  ; ENTRY:   DX:AX = the number to be divided
 39207                                  ; EXIT:    Interpereting DX:AX as bytes, AX=paragraph equivalent, 0xFFFF max
 39208                                  ; ERROR:   None
 39209                                  ; USES:    Flags, AX, DX
 39210                                  ; -----------------------------------------------------------------------------
 39211                                  ; Note: The 386 has a 32-bit SHR, which would work perfectly for this... but we
 39212                                  ;       can't ensure a 386 host machine. Sorry.
 39213                                  ; -----------------------------------------------------------------------------
 39214                                  
 39215                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39216                                  toPara:
 39217 00005F25 51                      	push	cx		; DX:AX=HHHH hhhh hhhh hhhh:LLLL llll llll llll
 39218                                  
 39219 00005F26 B104                    	mov	cl,4		;
 39220 00005F28 D3E8                    	shr	ax,cl		; DX:AX=HHHH hhhh hhhh hhhh:0000 LLLL llll llll
 39221 00005F2A 92                      	xchg	ax,dx		; DX:AX=0000 LLLL llll llll:HHHH hhhh hhhh hhhh
 39222 00005F2B B10C                    	mov	cl,12
 39223 00005F2D D3E0                    	shl	ax,cl		; DX:AX=0000 LLLL llll llll:hhhh 0000 0000 0000
 39224 00005F2F 09D0                    	or	ax,dx		;    AX=hhhh LLLL llll llll
 39225                                  
 39226 00005F31 59                      	pop	cx
 39227 00005F32 C3                      	retn
 39228                                  
 39229                                  ; -----------------------------------------------------------------------------
 39230                                  ;*** UmbHead - returns in AX the address of the first UMB block (0x9FFF)
 39231                                  ; -----------------------------------------------------------------------------
 39232                                  ; ENTRY:  Nothing
 39233                                  ; EXIT:   AX contains 0x9FFF for most systems
 39234                                  ; ERROR:  Carry set if pointer is 0xFFFF (if not set up yet--DH runs into this)
 39235                                  ; USES:   Flags, AX
 39236                                  ; -----------------------------------------------------------------------------
 39237                                  ; Early in the boot-cycle, the pointer used to obtain this value isn't set up;
 39238                                  ; to be precise, before a UMB provider is around.  In this event, the pointer
 39239                                  ; is always set to 0xFFFF; it changes once a provider is around.  On most
 39240                                  ; machines (all of 'em I've seen), it changes to 0x9FFF at that point.
 39241                                  ; -----------------------------------------------------------------------------
 39242                                  
 39243                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39244                                  UmbHead:
 39245                                  	;pushreg <si,ds,es>
 39246                                  	
 39247                                  	;push	si
 39248                                  	;push	ds
 39249                                  	;push	es
 39250                                  
 39251 00005F33 B452                    	mov	ah,52h	; DOS_GET_DOS_LISTS
 39252                                  					; Call int 21h, function 52h...
 39253 00005F35 CD21                    	int	21h
 39254                                  			; DOS - 2+ internal - GET LIST OF LISTS
 39255                                  			; Return: ES:BX -> DOS list of lists
 39256                                  
 39257                                  	;mov	ax,[es:DOS_UMB_HEAD]	; And read what's in ES:[008C]
 39258 00005F37 26A18C00                	mov	ax,[es:8Ch]
 39259 00005F3B 83F8FF                  	cmp	ax,0FFFFh
 39260                                  	;je	short uhE		; If it's 0xFFFF, it's an error...
 39261                                  
 39262                                  	;clc				; Else, it isn't (CLC done by prev cmp)
 39263                                  	;jmp	short uhX
 39264                                  	; 17/06/2023
 39265 00005F3E F5                      	cmc	; cf = 0 <--> cf = 1
 39266                                  uhE:
 39267                                  	;stc
 39268                                  uhX:	
 39269                                  	;popreg	<es,ds,si>
 39270                                  	
 39271                                  	;pop	es
 39272                                  	;pop	ds
 39273                                  	;pop	si
 39274                                  
 39275 00005F3F C3                      	retn
 39276                                  
 39277                                  ; -----------------------------------------------------------------------------
 39278                                  ;*** isSysMCB - sets ZF iff ES points to an MCB owned by "SC" + (8 or 9)
 39279                                  ; -----------------------------------------------------------------------------
 39280                                  ; ENTRY:  ES:0 should point to a valid MCB
 39281                                  ; EXIT:   ZF set if owned by SC+8 or SC+9 (for japan)
 39282                                  ; USES:   Flags
 39283                                  ; -----------------------------------------------------------------------------
 39284                                  
 39285                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39286                                  isSysMCB:
 39287                                  	;push	ax
 39288                                  	
 39289                                  	;mov	ax,[es:1]
 39290 00005F40 26A10100                	mov	ax,[es:arena_owner]	; Check the owner...
 39291 00005F44 83F808                  	cmp	ax,8 ; SystemPSPOwner	; 8 (for US OR Japan) is valid
 39292 00005F47 7405                    	jz	short ism10
 39293 00005F49 83F809                  	cmp	ax,9 ; JapanPSPOwner	; 9 (for Japan) is valid
 39294                                  	;jz	short ism10
 39295                                  	;jmp	short ismX		; Anything else isn't.
 39296 00005F4C 7507                    	jnz	short ismX
 39297                                  ism10:
 39298                                  	;mov	ax,[es:8]
 39299 00005F4E 26A10800                	mov	ax,[es:arena_name]	; Check the name...
 39300 00005F52 3D5343                  	cmp	ax,'SC' ; cmp ax,4353h
 39301                                  ismX:
 39302                                  	;pop	ax
 39303 00005F55 C3                      	retn
 39304                                  
 39305                                  ; -----------------------------------------------------------------------------
 39306                                  ;*** AddrToUmb - converts a segment address in AX to its appropriate UMB number
 39307                                  ; -----------------------------------------------------------------------------
 39308                                  ; ENTRY:  AX contains a segment address
 39309                                  ; EXIT:   AX will contain the UMB number which contains the address (0==conv)
 39310                                  ; ERROR:  If the address is above UM Range, AX will return as FFFF.
 39311                                  ; USES:   Flags, AX
 39312                                  ; -----------------------------------------------------------------------------
 39313                                  ; An address in the following areas is treated as:
 39314                                  ;    0      <-> umbhead (0x9FFF)          = Conventional memory
 39315                                  ;    0x9FFF <-> addr of first UM sys MCB  = UMB #1
 39316                                  ;      ...
 39317                                  ;    addr of last UM sys MCB <-> TOM      = invalid; returns #0xFFFF
 39318                                  ; -----------------------------------------------------------------------------
 39319                                  
 39320                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39321                                  AddrToUmb:
 39322                                  	;pushreg <cx,dx,es>
 39323                                  	
 39324                                  	;push	cx
 39325                                  	;push	dx
 39326 00005F56 06                      	push	es
 39327                                  
 39328 00005F57 89C2                    	mov	dx,ax		; DX = address to search for
 39329                                  
 39330 00005F59 E8D7FF                  	call	UmbHead		; AX = first segment
 39331 00005F5C 722B                    	jc	short atuE	; If it couldn't get it, error out.
 39332                                  
 39333                                  	;mov	es,ax ; *	; ES = first UMB segment
 39334 00005F5E 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now... (cx = UMB#)
 39335                                  
 39336                                  ; ----------------------------------------
 39337                                  ; ATU10--ES - Current MCB address
 39338                                  ;        DX - Address given for conversion
 39339                                  ;        CX - Current UMB #
 39340                                  ; ----------------------------------------
 39341                                  
 39342                                  	; 17/06/2023
 39343                                  atu10:
 39344 00005F60 8EC0                    	mov	es,ax ; *
 39345                                  ;atu10:
 39346                                  	;mov	ax,es
 39347 00005F62 39D0                            cmp	ax,dx		; Present segment >= given segment?
 39348 00005F64 7326                    	jae	short atuX	; Yep--done.
 39349                                  
 39350 00005F66 E8D7FF                  	call	isSysMCB	; Returns with ZF set if this is a system MCB
 39351 00005F69 7501                    	jnz	short atu20
 39352                                  
 39353 00005F6B 41                      	inc	cx		; If it _was_ a system MCB, we're in a new UMB.
 39354                                  atu20:
 39355                                  	;mov	al,[es:0]
 39356 00005F6C 26A00000                	mov	al,[es:arena_signature]
 39357                                  	;cmp	al,'Z' ; 5Ah
 39358 00005F70 3C5A                    	cmp	al,arena_signature_end
 39359 00005F72 740A                    	je	short atu30	; 'Z' means this was the last MCB... that's it.
 39360                                  
 39361                                  	;NextMCB es,ax
 39362 00005F74 8CC0                    	mov	ax,es
 39363                                  	;add	ax,[es:3]	; NextMCB (macro)
 39364 00005F76 2603060300              	add	ax,[es:arena_size]
 39365 00005F7B 40                      	inc	ax
 39366                                  	;mov	es,ax ; * ; 17/06/2023
 39367 00005F7C EBE2                    	jmp	short atu10
 39368                                  
 39369                                  ; -----------------------------------------------------------------------------
 39370                                  ; if we get to atu30, they specified a number that was past the last MCB.
 39371                                  ; make sure it's not _inside_ that MCB before we return an error condition.
 39372                                  ; -----------------------------------------------------------------------------
 39373                                  
 39374                                  atu30:
 39375 00005F7E 8CC0                    	mov	ax,es
 39376                                  	;add	ax,[es:3]
 39377 00005F80 2603060300              	add	ax,[es:arena_size]
 39378 00005F85 39D0                    	cmp	ax,dx		; Present >= given?
 39379 00005F87 7303                    	jae	short atuX	; Yep! It _was_ inside.
 39380                                  atuE:
 39381 00005F89 31C9                    	xor	cx,cx		; Else, fall through with UMB # == -1
 39382 00005F8B 49                      	dec	cx		; (that makes it return 0xFFFF and sets CF)
 39383                                  atuX:	
 39384 00005F8C 89C8                    	mov	ax,cx		; Return the UMB number in AX
 39385                                  	
 39386                                  	;popreg	<es,dx,cx>
 39387                                  
 39388 00005F8E 07                      	pop	es
 39389                                  	;pop	dx
 39390                                  	;pop	cx
 39391                                  	
 39392 00005F8F C3                      	retn
 39393                                  
 39394                                  ; -----------------------------------------------------------------------------
 39395                                  ;*** convUMB - checks after GetXNum to convert an address to a UMB number
 39396                                  ;            -- if GetXNum read a hex number, we interperete that as a segment
 39397                                  ; address rather than a UMB number... and use that address to look up a UMB.
 39398                                  ; This routine checks for that condition and calls AddrToUmb if necessary.
 39399                                  ; -----------------------------------------------------------------------------
 39400                                  ; ENTRY:  AX contains a UMB number or segment, gnradix has been set by GetXNum
 39401                                  ; EXIT:   AX will contain a UMB number
 39402                                  ; ERROR:  None
 39403                                  ; USES:   Flags, AX
 39404                                  ; -----------------------------------------------------------------------------
 39405                                  
 39406                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39407                                  convUMB:
 39408                                  	;cmp	word [gnradix],16
 39409 00005F90 803E[8B5E]10            	cmp	byte [gnradix],16
 39410 00005F95 7509                    	jne	short cu10	; If it didn't read in hex, it's not an address
 39411 00005F97 E8BCFF                  	call	AddrToUmb	; Else, convert the address to a UMB number
 39412 00005F9A 83F8FF                  	cmp	ax,0FFFFh
 39413 00005F9D 7501                    	jne	short cu10
 39414 00005F9F 40                      	inc	ax ; ax = 0	; If too high, ignore it (make it conventional)
 39415                                  cu10:
 39416 00005FA0 C3                      	retn
 39417                                  
 39418                                  ; -----------------------------------------------------------------------------
 39419                                  ;*** setUMBs - links umbs and sets allocation strategy for a load
 39420                                  ;            -- if LoadHigh, the allocation strategy MAY be LOW_FIRST instead
 39421                                  ; of the usual HIGH_FIRST.  See the code.
 39422                                  ; -----------------------------------------------------------------------------
 39423                                  ; ENTRY:  None
 39424                                  ; EXIT:   None
 39425                                  ; ERROR:  None
 39426                                  ; USES:   Flags, fm_umb, fm_strat
 39427                                  ; -----------------------------------------------------------------------------
 39428                                  
 39429                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39430                                  setUMBs:
 39431                                  	;pushreg <ax,bx>
 39432                                  	
 39433                                  	;push	ax
 39434                                  	;push	bx
 39435                                  
 39436 00005FA1 E8B2FD                  	call	fm_link
 39437                                  
 39438 00005FA4 B80058                  	mov	ax,5800h ; DOS_CHECK_STRATEGY
 39439 00005FA7 CD21                    	int	21h
 39440                                  
 39441                                  	;putdata fm_strat,al	; Store the current strategy for later restore
 39442                                  
 39443                                  	;push	es
 39444                                  	;mov	es,[RESSEG]
 39445                                  	;mov	[es:fm_strat],al ; store the current strategy
 39446                                  	;pop	es
 39447 00005FA9 1E                      	push	ds ; *
 39448 00005FAA 8E1E[539C]              	mov	ds,[RESSEG]
 39449 00005FAE A2[3605]                	mov	[fm_strat],al
 39450                                  	;pop	ds ; *
 39451                                  
 39452 00005FB1 83E07F                  	and	ax,007Fh	; 0000.0000.0111.1111 == All that other stuff
 39453 00005FB4 50                      	push	ax ; **		; Watch this carefully...
 39454                                  
 39455 00005FB5 E80C00                  	call	loadLow		; returns al==0 if load low, al==1 if loadhigh
 39456 00005FB8 D0C8                    	ror	al,1		; Shift that to al==0 or al==0x80
 39457                                  
 39458 00005FBA 5B                      	pop	bx ; **		; ...pushed as AX above
 39459                                  	
 39460 00005FBB 1F                      	pop	ds ; *
 39461                                  	
 39462 00005FBC 08C3                    	or	bl,al		; Now we have 0000.0000.?111.1111 in BX;
 39463                                  
 39464 00005FBE B80158                  	mov	ax,5801h ; DOS_SET_STRATEGY
 39465                                  				; with ? ==1 if load highfirst. Perfect!
 39466 00005FC1 CD21                    	int	21h
 39467                                  
 39468                                  	;popreg	<bx,ax>
 39469                                  
 39470                                  	;pop	bx
 39471                                  	;pop	ax
 39472                                  
 39473 00005FC3 C3                      	retn
 39474                                  
 39475                                  ; -----------------------------------------------------------------------------
 39476                                  ;*** loadLow - returns AL==0 if UMB0 == 0, else AL==1
 39477                                  ; -----------------------------------------------------------------------------
 39478                                  ; ENTRY:  None
 39479                                  ; EXIT:   AL==0 if mem strategy should be set to LOW_FIRST, else AL==1
 39480                                  ;         Carry set if UMB0 not specified (_NOT_ an error)
 39481                                  ; ERROR:  None
 39482                                  ; USES:   Flags, fm_strat, fm_umb
 39483                                  ; -----------------------------------------------------------------------------
 39484                                  ; We want to set the memory strategy to LOW_FIRST if the user specified a
 39485                                  ; load UMB, and it is 0.  That 0 can be either from the user having _specified_
 39486                                  ; zero (/L:0;...), or from having specified a too-big min size (/L:1,99999999)
 39487                                  ; such that the load UMB is too small, and shouldn't be used.
 39488                                  ; -----------------------------------------------------------------------------
 39489                                  
 39490                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39491                                  loadLow:
 39492                                  	;push	ds ; *	
 39493                                  	
 39494                                  	;dataseg ds		; Point DS into appropriate data segment
 39495                                  	;mov	ds,[RESSEG]
 39496                                  
 39497                                  	; * ; ds = [RESSEG] from 'setUMBs') ; 17/06/2023
 39498                                  
 39499 00005FC4 A0[3405]                	mov	al,[UmbLoad]
 39500 00005FC7 3CFF                    	cmp	al,0FFh ; UNSPECIFIED
 39501 00005FC9 7503                    	jne	short ll10
 39502                                  
 39503                                  	;mov	al,1		; Return with AL==1 && STC if no UMBs specified
 39504 00005FCB F9                      	stc
 39505                                  	;jmp	short llX
 39506 00005FCC EB04                    	jmp	short lly ; 17/06/2023
 39507                                  ll10:
 39508 00005FCE 08C0                    	or	al,al		; AL=the load UMB: Is it == 0?
 39509 00005FD0 7402                    	jz	short llX	; Yep... CF==0 (from OR) && AL=0, so just exit
 39510                                  	; cf= 0
 39511                                  
 39512                                  	;mov	al,1
 39513                                  	;clc	
 39514                                  lly:		; 17/06/2023
 39515 00005FD2 B001                    	mov	al,1
 39516                                  llX:
 39517                                  	;pop	ds ; *		; Return DS to where it was
 39518                                  	
 39519                                  	;normseg ds		;
 39520                                  	
 39521 00005FD4 C3                      	retn
 39522                                  
 39523                                  ; -----------------------------------------------------------------------------
 39524                                  ;*** HideUMBs - links UMBs and hides upper-memory as appropriate
 39525                                  ; -----------------------------------------------------------------------------
 39526                                  ; ENTRY:  None
 39527                                  ; EXIT:   None
 39528                                  ; ERROR:  None
 39529                                  ; USES:   Flags, fm_strat, fm_umb
 39530                                  ; -----------------------------------------------------------------------------
 39531                                  
 39532                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39533                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:64D0h
 39534                                  HideUMBs:
 39535                                  	;pushreg <ax,cx,ds,es>
 39536                                  	
 39537                                  	;push	ax
 39538                                  	;push	cx
 39539                                  	;push	ds
 39540                                  	;push	es
 39541                                  
 39542 00005FD5 E8EF01                  	call	UmbTest		; See if we REALLY linked in anything...
 39543 00005FD8 7236                    	jc	short husX	; ...if not, there's nothing for us to do.
 39544                                  
 39545 00005FDA E82CFD                  	call	FixMem		; Concatenate adjacent free MCBs in upper mem
 39546 00005FDD E8C1FF                  	call	setUMBs		; Link UMBs and set memory-allocation strategy
 39547                                  
 39548                                  	;putdata fInHigh,1	; Remember that we're now running high
 39549                                  	;push	es
 39550                                  	;mov	es,[RESSEG]
 39551                                  	;mov	byte [es:fInHigh], 1
 39552                                  	;			; remember that we're now running high
 39553                                  	;pop	es
 39554 00005FE0 1E                      	push	ds
 39555 00005FE1 8E1E[539C]              	mov	ds,[RESSEG]
 39556 00005FE5 C606[3005]01            	mov	byte [fInHigh], 1
 39557 00005FEA 1F                      	pop	ds
 39558                                  
 39559 00005FEB E82300                  	call	GetLoadUMB	; See if they gave us a list to leave free
 39560 00005FEE 3CFF                    	cmp	al,0FFh	; UNSPECIFIED
 39561                                  				; If they didn't,
 39562 00005FF0 741E                    	je	short husX	; then we shouldn't do this loop:
 39563                                  
 39564 00005FF2 31C9                    	xor	cx,cx
 39565                                  
 39566                                  ; -----------------------------------------------
 39567                                  ; HUS10-CX - UMB number (after inc, 1==first UMB)
 39568                                  ; -----------------------------------------------
 39569                                  
 39570                                  hus10:
 39571 00005FF4 41                      	inc	cx		; For each UMB:
 39572 00005FF5 83F910                  	cmp	cx,16 ; MAXUMB
 39573 00005FF8 730C                    	jae	short hus20
 39574                                  
 39575 00005FFA 88C8                    	mov	al,cl		; (stopping as soon as we're outside of the
 39576                                  	; 17/06/2023
 39577                                  	;push	es
 39578 00005FFC E8A900                  	call	findumb		; valid range of UMBs)
 39579                                  	;pop	es		; push/pop: trash what findumb finds.  :-)
 39580 00005FFF 7205                    	jc	short hus20
 39581                                  
 39582 00006001 E87901                  	call	hideUMB?	; hide what we need to hide.
 39583                                  
 39584 00006004 EBEE                    	jmp	short hus10
 39585                                  hus20:
 39586 00006006 E80800                  	call	GetLoadUMB	; Now check if they offered /L:0
 39587 00006009 08C0                    	or	al,al		; --Is the load UMB 0? (-1==unspecified)
 39588 0000600B 7503                    	jnz	short husX	; If not, we're done.
 39589                                  
 39590 0000600D E8E701                  	call	hl_unlink	; If so, however, fix UMBs and strategy.
 39591                                  husX:
 39592                                  	;popreg	<es,ds,cx,ax>
 39593                                  	
 39594                                  	;pop	es
 39595                                  	;pop	ds
 39596                                  	;pop	cx
 39597                                  	;pop	ax
 39598                                  
 39599 00006010 C3                      	retn
 39600                                  
 39601                                  ; -----------------------------------------------------------------------------
 39602                                  ;*** GetLoadUMB - Returns the load UMB number in AL (-1 if not specified)
 39603                                  ; -----------------------------------------------------------------------------
 39604                                  ; ENTRY:  None
 39605                                  ; EXIT:   AL == load UMB
 39606                                  ; ERROR:  None
 39607                                  ; USES:   Flags, AX
 39608                                  ; -----------------------------------------------------------------------------
 39609                                  
 39610                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39611                                  GetLoadUMB:
 39612                                  	;getdata al,UmbLoad
 39613                                  
 39614 00006011 1E                      	push    ds
 39615 00006012 8E1E[539C]              	mov     ds,[RESSEG]   ; getdata (macro)
 39616 00006016 A0[3405]                	mov     al,[UmbLoad]
 39617 00006019 1F                      	pop     ds
 39618                                  
 39619 0000601A C3                      	retn
 39620                                  
 39621                                  ; -----------------------------------------------------------------------------
 39622                                  ;*** GetSize - Returns the UMB in AL's minimum size (0 if not specified)
 39623                                  ; -----------------------------------------------------------------------------
 39624                                  ; ENTRY:  AL == a UMB number
 39625                                  ; EXIT:   AX == UMB minimum size, as specified by the user
 39626                                  ; ERROR:  None
 39627                                  ; USES:   Flags, AX
 39628                                  ; -----------------------------------------------------------------------------
 39629                                  
 39630                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39631                                  GetSize:
 39632                                  	;pushreg <bx,si,ds>
 39633                                  	;push	bx
 39634                                  	;push	si
 39635 0000601B 1E                      	push	ds
 39636                                  	
 39637                                  	;dataseg ds
 39638 0000601C 8E1E[539C]              	mov	ds,[RESSEG]
 39639                                  
 39640 00006020 30E4                    	xor	ah,ah			;    ax==UMB
 39641                                  	;mov	bx,offset UmbSize
 39642 00006022 BB[6E04]                	mov	bx,UmbSize		;    bx==array
 39643 00006025 D0E0                    	shl	al,1	                ;    ax==offset
 39644                                  	;add	ax,bx			;    ax==element index
 39645                                  	;mov	si,ax			; ds:si==element index
 39646                                  	;lodsw				;    ax==size
 39647 00006027 01C3                    	add	bx,ax
 39648 00006029 8B07                    	mov	ax,[bx]
 39649                                  
 39650                                  	;popreg	<ds,si,bx>
 39651 0000602B 1F                      	pop	ds
 39652                                  	;pop	si
 39653                                  	;pop	bx
 39654                                  
 39655                                  	;normseg ds
 39656 0000602C C3                      	retn
 39657                                  
 39658                                  ; -----------------------------------------------------------------------------
 39659                                  ;*** hideUMB - marks as HIDDEN all FREE elements in UMB passed as AL
 39660                                  ; -----------------------------------------------------------------------------
 39661                                  ; ENTRY:    AL must indicate a valid UMB; 0==conv && is invalid.
 39662                                  ; EXIT:     None; free elements in UMB marked as hidden
 39663                                  ; ERROR:    None
 39664                                  ; USES:     Flags
 39665                                  ; -----------------------------------------------------------------------------
 39666                                  
 39667                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39668                                  hideUMB:
 39669                                  	;pushreg <ax,es>
 39670                                  	
 39671                                  	;push	ax
 39672                                  	;push	es
 39673                                  
 39674 0000602D E87800                  	call	findumb		; Returns with carry if err, else ES == MCB
 39675 00006030 7221                    	jc	short huX
 39676                                  
 39677                                  ; ------------------------------------------------
 39678                                  ; HU10--ES - MCB inside UMB; if it's a system MCB,
 39679                                  ;            we're not in the same UMB, so exit.
 39680                                  ; ------------------------------------------------
 39681                                  
 39682                                  hu10:
 39683 00006032 E80BFF                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 39684 00006035 741C                    	jz	short huX	; If it is, we've finished the UMB.
 39685 00006037 E82800                  	call	isFreeMCB	; Returns with ZF set if owner is 0
 39686 0000603A 7503                    	jnz	short hu20
 39687                                  
 39688 0000603C E82A00                  	call	hideMCB
 39689                                  hu20:
 39690                                  	;mov	al,[es:0]
 39691 0000603F 26A00000                	mov	al,[es:arena_signature]
 39692                                  	;cmp	al,'Z'
 39693 00006043 3C5A                    	cmp	al,arena_signature_end
 39694 00006045 740C                    	je	short huX	; 'Z' means this was the last MCB... that's it.
 39695                                  
 39696                                  	;NextMCB es,ax		; Go on forward.
 39697                                  
 39698 00006047 8CC0                     	mov	ax,es		; NextMCB (macro)
 39699                                  	;add	ax,[es:3]
 39700 00006049 2603060300              	add	ax,[es:arena_size]
 39701 0000604E 40                      	inc	ax
 39702 0000604F 8EC0                    	mov	es,ax
 39703                                  
 39704 00006051 EBDF                    	jmp	short hu10
 39705                                  huX:
 39706                                  	;popreg	<es,ax>
 39707                                  	
 39708                                  	;pop	es
 39709                                  	;pop	ax
 39710                                  
 39711 00006053 C3                      	retn
 39712                                  
 39713                                  ; -----------------------------------------------------------------------------
 39714                                  ;*** isTiny - returns with ZF set if user didn't specify /S
 39715                                  ; -----------------------------------------------------------------------------
 39716                                  ; ENTRY:    None
 39717                                  ; EXIT:     ZF set if user DIDN'T specify /S
 39718                                  ; ERROR:    None
 39719                                  ; USES:     Flags
 39720                                  ; -----------------------------------------------------------------------------
 39721                                  
 39722                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39723                                  isTiny:
 39724 00006054 50                      	push	ax
 39725                                  
 39726                                  	;getdata al,fUmbTiny
 39727 00006055 1E                      	push    ds
 39728 00006056 8E1E[539C]              	mov     ds,[RESSEG]   ; getdata (macro)
 39729 0000605A A0[3105]                	mov     al,[fUmbTiny]
 39730 0000605D 1F                      	pop     ds
 39731                                  
 39732 0000605E 08C0                    	or	al,al
 39733 00006060 58                      	pop	ax
 39734 00006061 C3                      	retn
 39735                                  
 39736                                  ; -----------------------------------------------------------------------------
 39737                                  ;*** isFreeMCB - returns with ZF set if current MCB (ES:0) is FREE
 39738                                  ; -----------------------------------------------------------------------------
 39739                                  ; ENTRY:    ES:0 should point to an MCB
 39740                                  ; EXIT:     ZF set if MCB is free, else !ZF
 39741                                  ; ERROR:    None
 39742                                  ; USES:     Flags
 39743                                  ; -----------------------------------------------------------------------------
 39744                                  
 39745                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39746                                  isFreeMCB:
 39747                                  	;or	word [es:1],0
 39748 00006062 26830E010000            	or	word [es:arena_owner],0
 39749 00006068 C3                      	retn
 39750                                  
 39751                                  ; -----------------------------------------------------------------------------
 39752                                  ;*** hideMCB - marks as HIDDEN the MCB at ES:0
 39753                                  ; -----------------------------------------------------------------------------
 39754                                  ; ENTRY:    ES:0 should point to an MCB
 39755                                  ; EXIT:     None; MCB marked as HIDDEN
 39756                                  ; ERROR:    None
 39757                                  ; USES:     None
 39758                                  ; -----------------------------------------------------------------------------
 39759                                  
 39760                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39761                                  hideMCB:
 39762                                  	;mov	word [es:1],8
 39763 00006069 26C70601000800          	mov	word [es:arena_owner],8 ; SystemPSPOwner
 39764                                  	;mov	word [es:8],4948h     ; 'HIDDEN  ' 
 39765 00006070 26C70608004849          	mov	word [es:arena_name+0], 'HI' ; 4948h
 39766 00006077 26C7060A004444          	mov	word [es:arena_name+2], 'DD' ; 4444h
 39767 0000607E 26C7060C00454E          	mov	word [es:arena_name+4], 'EN' ; 4E45h
 39768                                  	;mov	word [es:14],2020h
 39769 00006085 26C7060E002020          	mov	word [es:arena_name+6], '  ' ; 2020h 
 39770 0000608C C3                      	retn
 39771                                  
 39772                                  ; -----------------------------------------------------------------------------
 39773                                  ;*** unHideMCB - marks as FREE the MCB at ES:0
 39774                                  ; -----------------------------------------------------------------------------
 39775                                  ; ENTRY:    ES:0 should point to an MCB
 39776                                  ; EXIT:     None; MCB marked as FREE
 39777                                  ; ERROR:    None
 39778                                  ; USES:     None
 39779                                  ; -----------------------------------------------------------------------------
 39780                                  
 39781                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39782                                  unHideMCB:
 39783                                  	;push	ax
 39784                                  	;mov	word [es:1],0
 39785 0000608D 26C70601000000          	mov	word [es:arena_owner],0 ; FreePSPOwner
 39786 00006094 B82020                  	mov	ax, '  '  ; mov ax,2020h
 39787                                  	;mov	[es:8],ax
 39788 00006097 26A30800                	mov	[es:arena_name+0],ax
 39789 0000609B 26A30A00                	mov	[es:arena_name+2],ax
 39790 0000609F 26A30C00                	mov	[es:arena_name+4],ax
 39791                                  	;mov	[es:14],ax
 39792 000060A3 26A30E00                	mov	[es:arena_name+6],ax
 39793                                  	;pop	ax
 39794 000060A7 C3                      	retn
 39795                                  
 39796                                  ; -----------------------------------------------------------------------------
 39797                                  ;*** findUMB - makes ES:0 point to the first MCB in UMB given as AL
 39798                                  ;            -- returns UmbHEAD pointer (0x9FFF) if passed AL==0
 39799                                  ; -----------------------------------------------------------------------------
 39800                                  ; ENTRY:    AL should be to a valid UMB number
 39801                                  ; EXIT:     ES:0 points to first MCB in UMB (_not_ the 8+SC MCB that heads it)
 39802                                  ; ERROR:    Carry set if couldn't reach UMB (too high)
 39803                                  ; USES:     Flags, ES
 39804                                  ; -----------------------------------------------------------------------------
 39805                                  
 39806                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39807                                  findumb:
 39808                                  	;pushreg <ax,cx,dx>
 39809                                  	
 39810                                  	;push	ax
 39811 000060A8 51                      	push	cx
 39812 000060A9 52                      	push	dx
 39813                                  
 39814 000060AA 30E4                    	xor	ah,ah		; Zap ah, so al==ax
 39815                                  
 39816 000060AC 89C2                    	mov	dx,ax		; Store the to-be-found UMB number in DX
 39817                                  
 39818 000060AE E882FE                  	call	UmbHead		; Returns first UMB segment in AX
 39819                                  
 39820 000060B1 8EC0                    	mov	es,ax
 39821 000060B3 31C9                    	xor	cx,cx		; Pretend we're on UMB 0 for now...
 39822                                  
 39823                                  ; ---------------------------------------------
 39824                                  ; FU10--CX - This UMB number; 0 == conventional
 39825                                  ;       DX - The UMB number they're looking for
 39826                                  ;       ES - The current MCB address
 39827                                  ; ---------------------------------------------
 39828                                  
 39829                                  fu10:	
 39830 000060B5 39D1                    	cmp	cx,dx		; If CX==DX, we've found the UMB we're
 39831 000060B7 741B                    	je	short fuX	; searching for--so exit.
 39832                                  
 39833 000060B9 E884FE                  	call	isSysMCB	; Returns with ZF set if owner is SYSTEM
 39834 000060BC 7501                    	jnz	short fu20
 39835                                  
 39836 000060BE 41                      	inc	cx		; If it _was_ SYSTEM, we're in a new UMB.
 39837                                  fu20:
 39838                                  	;mov	al,[es:0]
 39839 000060BF 26A00000                	mov	al,[es:arena_signature]
 39840                                  	;cmp	al,'Z'
 39841 000060C3 3C5A                    	cmp	al,arena_signature_end
 39842 000060C5 740C                    	je	short fuE	; 'Z' means this was the last MCB... that's it.
 39843                                  
 39844                                  	;NextMCB es,ax		; Go on forward.
 39845                                  
 39846 000060C7 8CC0                     	mov	ax,es		; NextMCB (macro)
 39847                                  	;add	ax,[es:3]
 39848 000060C9 2603060300              	add	ax,[es:arena_size]
 39849 000060CE 40                      	inc	ax
 39850 000060CF 8EC0                    	mov	es,ax
 39851                                  
 39852 000060D1 EBE2                    	jmp	short fu10
 39853                                  fuE:
 39854 000060D3 F9                      	stc
 39855                                  fuX:
 39856                                  	;popreg	<dx,cx,ax>	; The address is already in ES.
 39857                                  	
 39858 000060D4 5A                      	pop	dx
 39859 000060D5 59                      	pop	cx
 39860                                  	
 39861                                  	;pop	ax
 39862 000060D6 C3                      	retn
 39863                                  
 39864                                  ; -----------------------------------------------------------------------------
 39865                                  ;*** BigFree - makes ES:0 point to the largest free MCB in UMB given as AL
 39866                                  ; -----------------------------------------------------------------------------
 39867                                  ; ENTRY:    AL should be to a valid UMB number
 39868                                  ; EXIT:     ES:0 points to largest free MCB in UMB, AX returns its size
 39869                                  ; ERROR:    Carry set if couldn't reach UMB (0 or too high)
 39870                                  ; USES:     Flags, ES
 39871                                  ; -----------------------------------------------------------------------------
 39872                                  
 39873                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39874                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6624h
 39875                                  BigFree:
 39876                                  	;pushreg <bx,cx>
 39877                                  	
 39878                                  	;push	bx
 39879 000060D7 51                      	push	cx
 39880                                  
 39881 000060D8 E8CDFF                  	call	findumb			; Returns with CF if err, else ES==MCB
 39882 000060DB 7239                    	jc	short bfX		; (would be "jc bfE"; it just does stc)
 39883                                  
 39884 000060DD 31DB                    	xor	bx,bx			; Segment address of largest free MCB
 39885 000060DF 31C9                    	xor	cx,cx			; Size of largest free MCB
 39886                                  
 39887                                  ; ---------------------------------------------
 39888                                  ; BF10--ES - Current MCB address
 39889                                  ;       BX - Address of largest free MCB so far
 39890                                  ;       CX - Size of largest free MCB so far
 39891                                  ; ---------------------------------------------
 39892                                  
 39893                                  bf10:
 39894 000060E1 E85CFE                  	call	isSysMCB		; If we've left the MCB, we're done.
 39895 000060E4 7427                    	jz	short bf30
 39896                                  
 39897 000060E6 E879FF                  	call	isFreeMCB		; Returns with ZF set if owner is 0
 39898 000060E9 750E                    	jnz	short bf20
 39899                                  
 39900                                  	;cmp	cx,[es:3]
 39901 000060EB 263B0E0300              	cmp	cx,[es:arena_size]	; Compare sizes...
 39902 000060F0 7F07                    	jg	short bf20		; Unless we're bigger,
 39903                                  
 39904 000060F2 8CC3                    	mov	bx,es			; Store this new element's address,
 39905                                  	;mov	cx,[es:3]
 39906 000060F4 268B0E0300              	mov	cx,[es:arena_size]	; and its size.
 39907                                  bf20:
 39908                                  	;mov	al,[es:0]
 39909 000060F9 26A00000                	mov	al,[es:arena_signature]
 39910                                  	;cmp	al,'Z'  ; 5Ah
 39911 000060FD 3C5A                    	cmp	al,arena_signature_end
 39912 000060FF 740C                    	je	short bf30		; 'Z' means this was the last MCB.
 39913                                  
 39914                                  	;NextMCB es,ax			; Go on forward.
 39915                                  
 39916 00006101 8CC0                    	mov	ax,es 
 39917                                  	;add	ax,[es:3]
 39918 00006103 2603060300              	add	ax,[es:arena_size]
 39919 00006108 40                      	inc	ax
 39920 00006109 8EC0                    	mov	es,ax
 39921                                  
 39922 0000610B EBD4                    	jmp	short bf10
 39923                                  bf30:
 39924 0000610D 8EC3                    	mov	es,bx			; Return the address
 39925 0000610F 89C8                    	mov	ax,cx			; Return the size
 39926 00006111 09DB                    	or	bx,bx
 39927 00006113 7501                    	jnz	short bfX		; (if size==0, there's nothing free)
 39928                                  bfE:
 39929 00006115 F9                      	stc
 39930                                  bfX:
 39931                                  	;popreg	<cx,bx>
 39932                                  
 39933 00006116 59                      	pop	cx
 39934                                  	;pop	bx
 39935                                  
 39936 00006117 C3                      	retn
 39937                                  
 39938                                  ; -----------------------------------------------------------------------------
 39939                                  ;*** isSpecified - sets ZF if UMB in AL wasn't specified in DH/LH line.
 39940                                  ; -----------------------------------------------------------------------------
 39941                                  ; ENTRY:    AL should be to a valid UMB number
 39942                                  ; EXIT:     ZF set if UMB wasn't specified, ZF clear if it was
 39943                                  ; ERROR:    None
 39944                                  ; USES:     Flags
 39945                                  ; -----------------------------------------------------------------------------
 39946                                  
 39947                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39948                                  isSpecified:
 39949                                  	;push	ax
 39950                                  
 39951 00006118 30FF                    	xor	bh,bh
 39952 0000611A 88C3                    	mov	bl,al
 39953                                  
 39954                                  	;getdata al,DS:UmbUsed[bx]
 39955                                  
 39956 0000611C 1E                      	push	ds
 39957 0000611D 8E1E[539C]              	mov	ds,[RESSEG]
 39958 00006121 8A87[5E04]              	mov	al,[bx+UmbUsed]
 39959 00006125 1F                      	pop     ds
 39960                                  
 39961 00006126 08C0                    	or	al,al		; Sets ZF if al==0 (ie, if unspecified)
 39962                                  
 39963                                  	;pop	ax
 39964 00006128 C3                      	retn
 39965                                  
 39966                                  ; -----------------------------------------------------------------------------
 39967                                  ;*** shrinkMCB - breaks an MCB into two pieces, the lowest one's size==AX
 39968                                  ; -----------------------------------------------------------------------------
 39969                                  ; ENTRY:    AX == new size, ES:0 == current MCB
 39970                                  ; EXIT:     None; MCB broken if carry clear
 39971                                  ; ERROR:    Carry set if MCB isn't as large as AX+0x20 (not a useful split)
 39972                                  ; USES:     Flags
 39973                                  ; -----------------------------------------------------------------------------
 39974                                  ; If the size of the to-be-split MCB isn't at least 0x20 bytes greater than
 39975                                  ; the specified new size, the split is useless; if it's onnly 0x10 bytes, that
 39976                                  ; 0x10 will be used to make a header that mentions a 0-byte free space, and
 39977                                  ; that just sucks up 0x10 bytes for nothing. So we make 0x20 bytes the
 39978                                  ; minimum for performing a split.
 39979                                  ; -----------------------------------------------------------------------------
 39980                                  
 39981                                  ;MIN_SPLIT_SIZE	equ 20h
 39982                                  
 39983                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 39984                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:667Ah
 39985                                  shrinkMCB:
 39986                                  	;pushreg <bx,cx,es>
 39987                                  
 39988                                  	;push	bx
 39989 00006129 51                      	push	cx ; *
 39990 0000612A 26                      	psuh	es ; **
 39991                                  
 39992 0000612B 89C3                    	mov	bx,ax			; Move things around... and
 39993 0000612D 8CC0                    	mov	ax,es			; save this one for later.
 39994                                  
 39995 0000612F 268B0E0300              	mov	cx,[es:arena_size]
 39996 00006134 83E920                  	sub	cx,32 ; sub cx,MIN_SPLIT_SIZE
 39997                                  	;cmp	bx,cx			; {New size} vs {Current Size-20h}
 39998                                  	;ja	short smE		; if wanted_size > cur-20h, abort.
 39999 00006137 39D9                    	cmp	cx,bx
 40000 00006139 723E                    	jb	short smE ; cf = 1 (***)
 40001                                  
 40002                                  	;mov	dl,[es:0]
 40003 0000613B 268A160000              	mov	dl,[es:arena_signature]
 40004                                  
 40005                                  	;;mov	cx,[es:3]
 40006                                  	;mov	cx,[es:arena_size] ; *!
 40007                                  
 40008 00006140 26891E0300              	mov	[es:arena_size],bx
 40009                                  	;mov	byte [es:0],'M' ; 4Dh
 40010 00006145 26C60600004D            	mov	byte [es:arena_signature],'M'
 40011                                  
 40012 0000614B 01D8                    	add	ax,bx
 40013 0000614D 40                      	inc	ax
 40014 0000614E 8EC0                    	mov	es,ax			; Move to new arena area
 40015                                  
 40016                                  	;mov	ax,cx ; !*
 40017 00006150 26A10300                	mov	ax,[es:arena_size] ; *!
 40018 00006154 29D8                    	sub	ax,bx
 40019 00006156 48                      	dec	ax			; And prepare the new size
 40020                                  
 40021                                  	;mov	[es:0],dl
 40022 00006157 2688160000              	mov	[es:arena_signature],dl
 40023                                  	;;mov	word [es:1],0
 40024                                  	;mov	word [es:arena_owner],0
 40025                                  	;mov	[es:3],ax
 40026 0000615C 26A30300                	mov	[es:arena_size],ax
 40027 00006160 B82020                  	mov	ax,'  ' ; mov ax,2020h
 40028                                  	;mov	[es:8],ax
 40029 00006163 26A30800                	mov	[es:arena_name+0],ax
 40030 00006167 26A30A00                	mov	[es:arena_name+2],ax
 40031 0000616B 26A30C00                	mov	[es:arena_name+4],ax
 40032                                  	;mov	[es:14],ax
 40033 0000616F 26A30E00                	mov	[es:arena_name+6],ax
 40034                                  
 40035                                  	;clc
 40036 00006173 31C0                    	xor	ax,ax
 40037 00006175 26A30100                	mov	[es:arena_owner],ax ; 0
 40038                                  	; cf = 0
 40039                                  	;jmp	short smX
 40040                                  smE:
 40041                                  	;stc	 ; cf = 1 (***)
 40042                                  smX:
 40043                                  	;popreg	<es,cx,bx>
 40044 00006179 07                      	pop	es ; **
 40045 0000617A 59                      	pop	cx ; *
 40046 0000617B 5B                      	pop	bx
 40047                                  
 40048 0000617C C3                      	retn
 40049                                  
 40050                                  ; -----------------------------------------------------------------------------
 40051                                  ;*** hideUMB? - hides as appropriate the UMB in CL
 40052                                  ; -----------------------------------------------------------------------------
 40053                                  ; ENTRY:    CL should be to a valid UMB number, and AX to its address (findUMB)
 40054                                  ; EXIT:     None; UMB is hidden as necessary
 40055                                  ; ERROR:    None
 40056                                  ; USES:     Flags, AX, CX
 40057                                  ; -----------------------------------------------------------------------------
 40058                                  ; PRIMARY LOGIC:
 40059                                  ;
 40060                                  ; If the UMB is specified in the DH/LH statement, then:
 40061                                  ;    If the largest free segment is too small (check specified size), then:
 40062                                  ;       Pretend it wasn't ever specified, and fall out of this IF.
 40063                                  ;    Else, if largest free segment is LARGER than specified size, then:
 40064                                  ;       If /S was given on the command-line, then:
 40065                                  ;          Break that element into two pieces
 40066                                  ;          Set a flag that we're shrinking
 40067                                  ;       Endif
 40068                                  ;    Endif
 40069                                  ; Endif
 40070                                  ; If the UMB is NOT specified (or was removed by the above):
 40071                                  ;    Hide all free elements in the UMB
 40072                                  ;    If the flag that we're shrinking was set, then:
 40073                                  ;       UN-hide the lower portion of the shrunken UMB
 40074                                  ;    ENDIF
 40075                                  ; ENDIF
 40076                                  ; -----------------------------------------------------------------------------
 40077                                  
 40078                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40079                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:66D7h
 40080                                  hideUMB?:
 40081                                  	;pushreg <bx,dx,es>
 40082                                  
 40083                                  	;push	bx
 40084                                  	;push	dx
 40085                                  	;push	es
 40086                                  
 40087 0000617D 88C8                    	mov	al,cl
 40088 0000617F E896FF                  	call	isSpecified	; Returns ZF set if al's umb was NOT specified
 40089                                  	;jz	short hu?20
 40090                                  	; 17/06/2023
 40091 00006182 7432                    	jz	short hu?25 ; *
 40092                                  
 40093 00006184 88C8                    	mov	al,cl		; Retrieve the size of the largest
 40094 00006186 E84EFF                  	call	BigFree		; free element in AX; put its address in ES
 40095                                  	;jc	short hu?20	; Oops. Errors mean skip this part.
 40096                                  	; 17/06/2023
 40097 00006189 723B                    	jc	short hu?X ; **
 40098                                  
 40099 0000618B 50                      	push	ax		; TOS==size of BigFree in UMB (popped as BX)
 40100 0000618C 88C8                    	mov	al,cl		; Retrieve the user's specified
 40101 0000618E E88AFE                  	call	GetSize		; minimum size for this umb (into AX)
 40102 00006191 5B                      	pop	bx		; Now BX==BigFree, AX==Specified Size
 40103                                  
 40104 00006192 09C0                    	or	ax,ax		; If they didn't specify one,
 40105                                  	;jz	short hu?20	; Skip over all this.
 40106                                  	; 17/06/2023
 40107 00006194 7530                    	jnz	short hu?X ; **
 40108                                  
 40109 00006196 39D8                    	cmp	ax,bx		; Ah... if (specified > max free)
 40110 00006198 7607                    	jbe	short hu?10
 40111                                  
 40112 0000619A 88C8                    	mov	al,cl		;  Then mark that UMB as unused. Nya nya.
 40113 0000619C E898FC                  	call	unMarkUMB
 40114                                  	;jmp	short hu?20 ; ***
 40115                                  	; 17/06/2023
 40116                                  	; ('isSpecified' would return with ZF=1) ; ***
 40117 0000619F EB15                    	jmp	short hu?25
 40118                                  hu?10:
 40119 000061A1 E8B0FE                  	call	isTiny		; Returns ZF clear if user specified /S
 40120                                  	;jz	short hu?20
 40121                                  	; 17/06/2023
 40122                                  	; ('isSpecified' would return with ZF=0) ; **
 40123 000061A4 7420                    	jz	short hu?X
 40124                                  
 40125 000061A6 E880FF                  	call	shrinkMCB	; They specified /S, so shrink the MCB to AX
 40126                                  	;jc	short hu?20	; Ah... if didn't shrink after all, skip this:
 40127                                  	; 17/06/2023
 40128                                  	; ('isSpecified' would return with ZF=0) ; **
 40129 000061A9 721B                    	jc	short hu?X
 40130                                  
 40131 000061AB 8CC2                    	mov	dx,es
 40132 000061AD EB09                    	jmp	short hu?30	; Skip the spec check.. we wanna hide this one.
 40133                                  hu?20:
 40134                                  	;mov	al,cl
 40135 000061AF 89C8                    	mov	ax,cx
 40136 000061B1 E864FF                  	call	isSpecified	; If they specified this UMB, we're done...
 40137 000061B4 7510                    	jnz	short hu?X ; **	; so leave.
 40138                                  hu?25:	; 17/06/2023 ; *
 40139 000061B6 31D2                    	xor	dx,dx
 40140                                  hu?30:
 40141 000061B8 88C8                    	mov	al,cl
 40142                                  
 40143 000061BA E870FE                  	call	hideUMB		; Hides everything in UMB #al
 40144                                  
 40145 000061BD 09D2                    	or	dx,dx		; Did we shrink a UMB? If not, DX==0,
 40146 000061BF 7405                    	jz	short hu?X	; So we should leave.
 40147                                  
 40148 000061C1 8EC2                    	mov	es,dx		; Ah, but if it isn't, DX==the MCB's address;
 40149 000061C3 E8C7FE                  	call	unHideMCB	; Un-hides the lower portion of that MCB.
 40150                                  hu?X:
 40151                                  	;popreg	<es,dx,bx>
 40152                                  
 40153                                  	;pop	es
 40154                                  	;pop	dx
 40155                                  	;pop	bx
 40156                                  
 40157 000061C6 C3                      	retn
 40158                                  
 40159                                  ; -----------------------------------------------------------------------------
 40160                                  ;*** UmbTest - returns with carry set if UMBs are not available, else CF==false
 40161                                  ; -----------------------------------------------------------------------------
 40162                                  ; ENTRY:    None
 40163                                  ; EXIT:     Carry is clear if UMBs are available, or set if they are not
 40164                                  ; ERROR:    None
 40165                                  ; USES:     CF (AX,BX,DS,ES pushed 'cause they're used by others)
 40166                                  ; -----------------------------------------------------------------------------
 40167                                  
 40168                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40169                                  UmbTest:
 40170                                  	;pushreg <ax,bx,ds,es>
 40171                                  	
 40172                                  	;push	ax
 40173                                  	;push	bx
 40174                                  	;push	ds
 40175                                  	;push	es
 40176                                  
 40177 000061C7 E88CFB                  	call	fm_link		; Link in UMBs (if not already linked)
 40178 000061CA E80600                  	call	WalkMem		; Check to see if they're really linked
 40179 000061CD 9C                      	pushf			; And remember what we found out
 40180 000061CE E89CFB                  	call	fm_unlink	; Unlink UMBs (if WE have linked 'em)
 40181 000061D1 9D                      	popf			; And restore what we found out.
 40182                                  
 40183                                  	;popreg	<es,ds,bx,ax>
 40184                                  	
 40185                                  	;pop	es
 40186                                  	;pop	ds
 40187                                  	;pop	bx
 40188                                  	;pop	ax
 40189                                  	
 40190 000061D2 C3                      	retn
 40191                                  
 40192                                  ; -----------------------------------------------------------------------------
 40193                                  ;*** WalkMem - travels memory chain and returns carry clear iff UMBs are linked
 40194                                  ; -----------------------------------------------------------------------------
 40195                                  ; ENTRY:    None
 40196                                  ; EXIT:     Carry SET if MCB chain stops before 9FFF, CLEAR if stops >= 9FFF.
 40197                                  ; ERROR:    None
 40198                                  ; USES:     Flags
 40199                                  ; -----------------------------------------------------------------------------
 40200                                  
 40201                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40202                                  WalkMem:
 40203                                  	;pushreg <ax,bx,es>
 40204                                  	
 40205                                  	;push	ax
 40206                                  	;push	bx
 40207 000061D3 06                      	push	es
 40208                                  
 40209 000061D4 B452                    	mov	ah,52h ; DOS_GET_DOS_LISTS
 40210                                  				; Call int 21h, function 52h...
 40211 000061D6 CD21                    	int	21h
 40212                                  
 40213 000061D8 268B47FE                	mov	ax,[es:bx-2]
 40214                                  	;mov	es,ax ; *
 40215                                  
 40216                                  ; ------------------------------
 40217                                  ; UM10: ES = Current MCB pointer
 40218                                  ; ------------------------------
 40219                                  
 40220                                  um10:	
 40221 000061DC 8EC0                    	mov	es,ax ; *
 40222                                  
 40223                                  	;mov	al,[es:0]
 40224 000061DE 26A00000                	mov	al,[es:arena_signature]
 40225                                  	;cmp	al,'Z' ; 5Ah
 40226 000061E2 3C5A                    	cmp	al,arena_signature_end
 40227 000061E4 740A                    	je	short um20	; If signature == 'Z', hay no more.
 40228                                  
 40229                                  	;NextMCB es,bx		; Move to the next MCB
 40230                                  	
 40231                                  	;mov	bx,es
 40232                                  	;;add	bx,[es:3]
 40233                                  	;add	bx,[es:arena_size]
 40234                                  	;inc	bx
 40235                                  	;mov	es,bx
 40236 000061E6 8CC0                    	mov	ax,es
 40237 000061E8 2603060300              	add	ax,[es:arena_size]
 40238 000061ED 40                      	inc	ax
 40239                                  	;mov	es,ax ; *
 40240                                  
 40241 000061EE EBEC                    	jmp	short um10	; And restart the loop.
 40242                                  um20:
 40243 000061F0 8CC0                    	mov	ax,es
 40244 000061F2 3DFF9F                  	cmp	ax,9FFFh	; This sets CF if ax < 9FFF.
 40245                                  
 40246                                  	;popreg	<es,bx,ax>
 40247 000061F5 07                      	pop	es
 40248                                  	;pop	bx
 40249                                  	;pop	ax
 40250                                  
 40251 000061F6 C3                      	retn
 40252                                  
 40253                                  ; -----------------------------------------------------------------------------
 40254                                  ;*** hl_unlink - unlinks UMBs if fm_umb is set to 0; restores strategy too
 40255                                  ; -----------------------------------------------------------------------------
 40256                                  ; ENTRY:    fm_umb == 1 : leave linked, else unlink
 40257                                  ; EXIT:     None
 40258                                  ; ERROR:    None
 40259                                  ; USES:     AX, BX
 40260                                  ; -----------------------------------------------------------------------------
 40261                                  
 40262                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40263                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:681Ch
 40264                                  hl_unlink:
 40265 000061F7 1E                      	push	ds ; *
 40266                                  
 40267 000061F8 30FF                    	xor	bh,bh
 40268                                  	;getdata bl,fm_umb	; Restore original link-state
 40269                                  
 40270                                  	;push	ds
 40271 000061FA 8E1E[539C]              	mov	ds,[RESSEG]
 40272 000061FE 8A1E[3505]              	mov	bl,[fm_umb]	; Restore original link-state
 40273                                  	;pop	ds
 40274                                  	
 40275 00006202 B80358                  	mov	ax,5803h ; DOS_SET_UMBLINK
 40276 00006205 CD21                    	int	21h
 40277                                  
 40278 00006207 30FF                    	xor	bh,bh
 40279                                  
 40280                                  	;getdata bl,fm_strat	; Restore original mem-alloc strategy
 40281                                  
 40282                                  	;push	ds
 40283                                  	;mov	ds,[RESSEG]
 40284 00006209 8A1E[3605]              	mov	bl,[fm_strat]	;Restore original mem-alloc strategy
 40285                                  	;pop	ds
 40286                                  
 40287 0000620D B80158                  	mov	ax,5801h ; DOS_SET_STRATEGY
 40288 00006210 CD21                    	int	21h
 40289                                  
 40290 00006212 1F                      	pop	ds ; *
 40291                                  
 40292 00006213 C3                      	retn
 40293                                  
 40294                                  ;============================================================================
 40295                                  ; LOADHIGH.ASM, MSDOS 6.0, 1991
 40296                                  ;============================================================================
 40297                                  ; 12/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40298                                  
 40299                                  ; This is a new module added to support loading programs into UMBs provided
 40300                                  ; by DOS 5.0. 
 40301                                  ; ---------------------------------------------------------------------------
 40302                                  ; Usage:
 40303                                  ;
 40304                                  ; LOADHIGH [/L:umb[,size][;umb[,size]]*] <filespec>
 40305                                  ;
 40306                                  ; <filespec> has to be a filename that is not wildcarded.
 40307                                  
 40308                                  ; ---------------------------------------------------------------------------
 40309                                  ;
 40310                                  ;	Revision History
 40311                                  ;	================
 40312                                  ;
 40313                                  ;	M009	SR	08/01/90	Set flags to indicate that we are
 40314                                  ;				loading and high and also remember
 40315                                  ;				current UMB state.
 40316                                  ;
 40317                                  ;	M016	SR	08/09/90	Give special error message on attempt
 40318                                  ;				to loadhigh batch files and invalid
 40319                                  ;				filename on Loadhigh command line.
 40320                                  ;
 40321                                  ;	M039	SR	11/19/90	Bug #4270. Copy all the whitespaces
 40322                                  ;				after the program name also as part
 40323                                  ;				of the command line being passed to
 40324                                  ;				the program to be invoked.
 40325                                  ;
 40326                                  ; ---------------------------------------------------------------------------
 40327                                  
 40328                                  ; ---------------------------------------------------------------------------
 40329                                  ;
 40330                                  ;	include highload.inc		; Grab code for ParseVar and such
 40331                                  
 40332                                  iCmdLine	equ	81h		; PSP:81h points to command-line
 40333                                  
 40334                                  ;
 40335                                  ; ---------------------------------------------------------------------------
 40336                                  
 40337                                  ;****	LoadHigh -- Main routine for Loadhigh command
 40338                                  ;
 40339                                  ;	ENTRY	Command line tail is at PSP:iCmdLine terminated by 0dh
 40340                                  ;		CS = DS = SS = TRANGROUP
 40341                                  ;
 40342                                  ;	EXIT	None
 40343                                  ;
 40344                                  ;	USED	ax, bx, cx, dx, si, di, es
 40345                                  ;
 40346                                  ;	ERROR EXITS
 40347                                  ;		Message pointers are setup at the error locations and then
 40348                                  ;	we jump back to CERROR which is the transient error recycle point.
 40349                                  ;	Apart from parse errors, the other errors handled are too many
 40350                                  ;	switches anf invalid filenames.
 40351                                  ;
 40352                                  ;	EFFECTS
 40353                                  ;		The allocation strategy and the state of the arena chain are
 40354                                  ;	put in the requested state according to the given options. If a 
 40355                                  ;	filename is also given, it is executed as well.
 40356                                  ; ---------------------------------------------------------------------------
 40357                                  
 40358                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40359                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5927h
 40360                                  
 40361                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40362                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:683Fh
 40363                                  LoadHigh:
 40364 00006214 1E                      	push	ds
 40365 00006215 07                      	pop	es
 40366                                  	
 40367                                  	; 16/06/2023
 40368                                  	;call	SkipLhDelims	; MSDOS 5.0 !
 40369                                  
 40370                                  ;Get command tail to be passed to the program. This includes any whitespace
 40371                                  ;chars between the program name and its parameters as well.
 40372                                  ;On return, ds:si points at the start of the command tail.
 40373                                  
 40374                                  	; 16/06/2023
 40375                                  	;push	si		; MSDOS 5.0 !
 40376 00006216 E81300                  	call	ParseLhCmd
 40377                                  	;pop	si		; MSDOS 5.0 !	
 40378 00006219 720E                    	jc	short LhErr
 40379                                  	
 40380 0000621B E86500                  	call	SetupCmdLine		;setup pgm's command line
 40381                                  
 40382 0000621E E88700                  	call	SetupPath		;setup path for file
 40383 00006221 7206                    	jc	short LhErr		;file not found
 40384                                  
 40385                                  ;Set allocation strategy to HighFirst and link in UMBs for exec. This will
 40386                                  ;be reset after return from the Exec
 40387                                  ;We will also set a resident flag to indicate that UMBs were activated for
 40388                                  ;the Exec. On return from the Exec, this flag will be used to deactivate UMBs
 40389                                  
 40390 00006223 E8AFFD                  	call	HideUMBs		;prepare upper-memory for load
 40391                                  
 40392 00006226 E904CB                  	jmp	LH_EXECUTE		;go and exec file ;M051
 40393                                  
 40394                                  LhErr:
 40395                                  ;The error message has been setup at this stage
 40396                                  
 40397 00006229 E9F8CA                  	jmp	cerror			;print error message and recycle 
 40398                                  
 40399                                  ; ---------------------------------------------------------------------------
 40400                                  					
 40401                                  ;*** 	ParseLhCmd - parses any command-line options
 40402                                  ;
 40403                                  ;	ENTRY	None
 40404                                  ;
 40405                                  ;	EXIT	Carry clear -- command line parsed successfully
 40406                                  ;		Carry set -- appropriate error message setup
 40407                                  ;
 40408                                  ;	USED	ax, si
 40409                                  ;
 40410                                  ;	EFFECTS
 40411                                  ;		Options set up (see highvar.inc)
 40412                                  ;		Filename to be executed setup
 40413                                  ;
 40414                                  ;	ParseLhCmd calls InitVar to initialize data filled in by ParseVar,
 40415                                  ;	then calls ParseVar itself to actually parse the commmand-line.  On
 40416                                  ;	return from ParseVar, DS:SI will point to the beginning of the child
 40417                                  ;	module's name on the command-line; thus it calls LhCopyFilename to
 40418                                  ;	prepare the command-line for that program.
 40419                                  ; ---------------------------------------------------------------------------
 40420                                  
 40421                                  ; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40422                                  %if 0
 40423                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40424                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5944h
 40425                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 40426                                  	; 11/06/2023
 40427                                  ParseLhCmd:
 40428                                  	;mov	si,81h
 40429                                  	mov	si,iCmdLine	;ds:si points at command line
 40430                                  
 40431                                  	mov	word [COMSW],0
 40432                                  	mov	di,Parse_LoadHi
 40433                                  	xor	cx,cx
 40434                                  	call	Parse_With_Msg
 40435                                  
 40436                                  	; 11/06/2023
 40437                                  	;cmp	ax,0FFFFh ; -1
 40438                                  	;jz	short PLhCmd2
 40439                                  	;cmp	ax,0
 40440                                  	;jnz	short PLhCmd1
 40441                                  	; 11/06/2023
 40442                                  	inc	ax ; cmp ax,-1
 40443                                  	jz	short PLhCmd2 ; 0FFFFh -> 0
 40444                                  	dec	ax ; cmp ax,0
 40445                                  	jnz	short PLhCmd1 ; 1 -> 0
 40446                                  	; ax = 0
 40447                                  
 40448                                  	mov	bx,dx
 40449                                  	; 14/04/2023
 40450                                  	;call	LhCopyFilename
 40451                                  	;; 13/04/2023
 40452                                  	;;;jc	short PLhCmd2  ; !!! jmp short PLhCmd2 !!!
 40453                                  	;;jmp	short PLhCmd2
 40454                                  	;retn
 40455                                  	; 14/04/2023
 40456                                  	jmp	short LhCopyFilename
 40457                                  PLhCmd1:
 40458                                  	stc
 40459                                  PLhCmd2:
 40460                                  	retn
 40461                                  %endif
 40462                                  
 40463                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40464                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6857h
 40465                                  	; MSDOS 6.0
 40466                                  ParseLhCmd:
 40467                                  	;assume	ds:TRANGROUP, es:TRANGROUP
 40468                                  	
 40469                                  	;mov	si,81h
 40470 0000622C BE8100                  	mov	si,iCmdLine	;ds:si points at command line
 40471                                  
 40472                                  	; es = ds (from 'LoadHigh') 
 40473                                  	;push	es		;Store ES 'cause we're gonna change it:
 40474                                  
 40475                                  	;push	ds
 40476                                  	;pop	es		;Make sure es:si points to cmd line as well
 40477                                  
 40478 0000622F E8ACFA                  	call	InitVar		;Initialize data for ParseVar
 40479                                  
 40480 00006232 E84AFB                  	call	ParseVar	;And parse the command line
 40481                                  
 40482                                  	;pop	es		;Restore ES now; we're done with it.
 40483                                  
 40484 00006235 7317                    	jnc	short plcC	;If no error, continue on our way.
 40485                                  
 40486 00006237 83F802                  	cmp	ax,2 ; PV_BadUMB
 40487                                  				;Bad UMB passed?
 40488 0000623A 7505                    	jne	short plc10
 40489                                  	;mov	dx,offset TRANGROUP:LhBadUMB_Ptr
 40490 0000623C BA[C692]                	mov	dx,LhBadUMB_Ptr
 40491 0000623F F9                      	stc
 40492 00006240 C3                      	retn
 40493                                  plc10:	
 40494                                  	;mov	dx,offset TRANGROUP:LhInvSwt_Ptr
 40495 00006241 BA[C392]                	mov	dx,LhInvSwt_Ptr
 40496 00006244 83F803                  	cmp	ax,3 ; PV_InvSwt
 40497                                  				;Unrecognized switch passed?
 40498 00006247 7403                    	je	short plc20
 40499                                  	;mov	dx,offset TRANGROUP:LhInvArg_Ptr
 40500 00006249 BA[BD92]                	mov	dx,LhInvArg_Ptr
 40501                                  plc20:
 40502 0000624C F9                      	stc
 40503 0000624D C3                      	retn
 40504                                  plcC:
 40505                                  	;call	LhCopyFilename	;copy filename into our buffer
 40506                                  	;retn			;Return-- carry=status
 40507                                  	; 16/06/2023
 40508                                  	;jmp	short LhCopyFilename
 40509                                  
 40510                                  ; ---------------------------------------------------------------------------
 40511                                  
 40512                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40513                                  
 40514                                  ; ---------------------------------------------------------------------------
 40515                                  ; HIGHlOAD.INC, MSDOS 6.0, 1992
 40516                                  ; ---------------------------------------------------------------------------
 40517                                  
 40518                                  	; 13/04/2023
 40519                                  	; MSDOS 5.0 COMMAND.COM only !
 40520                                  	; (Procedure names are not from original Microsoft source code!)
 40521                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:596Ah
 40522                                  ;set_strategy:
 40523                                  	;mov	ax,5800h	; DOS_CHECK_STRATEGY
 40524                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40525                                  	;		; AL = function code: get allocation strategy
 40526                                  	;mov	bx,ax
 40527                                  	;or	bx,80h
 40528                                  	;mov	ax,5801h	; DOS_SET_STRATEGY
 40529                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40530                                  	;		; AL = function code: set allocation strategy
 40531                                  	;retn
 40532                                  
 40533                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:597Bh
 40534                                  ;set_umblink:
 40535                                  	;mov	ax,5803h	; DOS_SET_UMBLINK
 40536                                  	;mov	bx,1
 40537                                  	;int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40538                                  	;		; AL = function code: (DOS 5beta) set UMB link state
 40539                                  	;retn
 40540                                  
 40541                                  ; ---------------------------------------------------------------------------
 40542                                  
 40543                                  ;***	LhCopyFilename -- copy filename from command line to buffer
 40544                                  ;
 40545                                  ;	ENTRY	ds:si points at primary argument (filename)
 40546                                  ;
 40547                                  ;	EXIT	Carry set -- filename has wildcards. In this event, DX will
 40548                                  ;				already contain an appropriate error number.
 40549                                  ;		Carry clear -- filename has been copied as needed; DS:SI
 40550                                  ;				points to first character (most likely space)
 40551                                  ;				after filename.
 40552                                  ;
 40553                                  ;	USED	ax, si
 40554                                  ;
 40555                                  ;	EFFECTS
 40556                                  ;		ExecPath contains the filename
 40557                                  ;
 40558                                  ; If there are any wildcards in the filename, then we have an error
 40559                                  ; ---------------------------------------------------------------------------
 40560                                  
 40561                                  ; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40562                                  %if 0
 40563                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40564                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5984h
 40565                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 40566                                  LhCopyFilename:
 40567                                  	push	ds
 40568                                  	push	si
 40569                                  	push	di
 40570                                  	lds	si,[bx+4]
 40571                                  	mov	di,EXECPATH
 40572                                  lhcpfn1:
 40573                                  	lodsb
 40574                                  	cmp	al,2Ah ; '*'
 40575                                  	jz	short lhfilerr
 40576                                  	cmp	al,3Fh ; '?'
 40577                                  	jz	short lhfilerr
 40578                                  	stosb
 40579                                  	or	al,al
 40580                                  	jnz	short lhcpfn1
 40581                                  	; 14/04/2023
 40582                                  	; cf = 0
 40583                                  	;clc
 40584                                  lhfilerr2:
 40585                                  	pop	di
 40586                                  	pop	si
 40587                                  	pop	ds
 40588                                  	retn
 40589                                  lhfilerr:
 40590                                  	mov	dx,LhInvFil_Ptr
 40591                                  	stc
 40592                                  	jmp	short lhfilerr2
 40593                                  
 40594                                  %endif
 40595                                  
 40596                                  	; 16/06/2023 - Retro DOS v4.2 COMMAND.COM
 40597                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6881h
 40598                                  	; MSDOS 6.0
 40599                                  LhCopyFilename:
 40600                                  	;assume	ds:TRANGROUP, es:TRANGROUP
 40601                                  
 40602                                  	;mov	di,offset TRANGROUP:ExecPath
 40603 0000624E BF[7B9B]                	mov	di,EXECPATH
 40604                                  
 40605                                  	;mov	cx,0	; Copied zero characters
 40606 00006251 29C9                    	sub	cx,cx
 40607                                  ;@@:
 40608                                  lhcpfn1:
 40609 00006253 AC                      	lodsb
 40610 00006254 3C2A                    	cmp	al,'*'			;wildcard?
 40611 00006256 7421                    	je	short lhfilerr		;yes, error
 40612 00006258 3C3F                    	cmp	al,'?'			;wildcard?
 40613 0000625A 741D                    	je	short lhfilerr		;yes, error
 40614                                  
 40615 0000625C 3C0D                    	cmp	al,0Dh			;carriage return?
 40616                                  	;jz	@f
 40617 0000625E 7410                    	je	short lhcpfn2
 40618 00006260 3C2F                    	cmp	al,'/' ; SwitChar	;'/'?
 40619                                  	;jz	@f
 40620 00006262 740C                    	je	short lhcpfn2
 40621 00006264 08C0                    	or	al,al			;EOS?
 40622                                  	;jz	@f
 40623 00006266 7408                    	jz	short lhcpfn2
 40624 00006268 3C20                    	cmp	al,' '			;Space?
 40625                                  	;jz	@f
 40626 0000626A 7404                    	je	short lhcpfn2
 40627                                  	
 40628                                  	;or	al,al
 40629                                  	;;jz	@f
 40630                                  	;je	short lhcpfn2	
 40631                                  
 40632 0000626C AA                      	stosb				;store char
 40633 0000626D 41                      	inc	cx			;And remember that we did one more
 40634                                  	;jmp	short @b
 40635 0000626E EBE3                    	jmp	short lhcpfn1
 40636                                  ;@@:
 40637                                  lhcpfn2:
 40638 00006270 30C0                    	xor	al,al			;Indicate EOS reached
 40639 00006272 AA                      	stosb				;store char
 40640                                  
 40641 00006273 09C9                    	or	cx,cx			;If we didn't copy any characters,
 40642 00006275 7407                    	jz	short lhmissing	; they didn't give a filename.
 40643                                  
 40644 00006277 4E                      	dec	si			;Move back to the delimiting character
 40645                                  	; cf = 0
 40646                                  	;clc				;And indicate no error occurred
 40647 00006278 C3                      	retn
 40648                                  lhfilerr:
 40649                                  	;mov	dx,offset TRANGROUP:LhInvFil_Ptr
 40650 00006279 BA[B792]                	mov	dx,LhInvFil_Ptr		;"Invalid Filename" ; M016
 40651 0000627C F9                      	stc
 40652 0000627D C3                      	retn
 40653                                  lhmissing:
 40654                                  	;mov	dx,offset TRANGROUP:ReqParmMiss
 40655 0000627E BA[C092]                	mov	dx,ReqParmMiss		;"Required parm missing"
 40656 00006281 F9                      	stc
 40657 00006282 C3                      	retn
 40658                                  
 40659                                  ; ---------------------------------------------------------------------------
 40660                                  	
 40661                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 40662                                  %if 0
 40663                                  	; 14/04/2023
 40664                                  	; 13/04/2023
 40665                                  	; MSDOS 5.0 COMMAND.COM only !
 40666                                  	; (Procedure name is not from original Microsoft source code!)
 40667                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:596Ah
 40668                                  set_strategy:
 40669                                  	mov	ax,5800h	; DOS_CHECK_STRATEGY
 40670                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40671                                  			; AL = function code: get allocation strategy
 40672                                  	mov	bx,ax
 40673                                  	or	bx,80h
 40674                                  	mov	ax,5801h	; DOS_SET_STRATEGY
 40675                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40676                                  			; AL = function code: set allocation strategy
 40677                                  	retn
 40678                                  
 40679                                  ; ---------------------------------------------------------------------------
 40680                                  
 40681                                  	; 13/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40682                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59A6h
 40683                                  	; MSDOS 5.0 COMMAND.COM only !
 40684                                  	; (Procedure name is not from original Microsoft source code!)
 40685                                  SkipLhDelims:
 40686                                  	mov	si,81h
 40687                                  	call	scanoff
 40688                                  stfn1:
 40689                                  	lodsb
 40690                                  	call	DELIM
 40691                                  	jz	short stfn2
 40692                                  	cmp	al,0Dh
 40693                                  	jz	short stfn2
 40694                                  	cmp	al,[SWITCHAR]
 40695                                  	jnz	short stfn1
 40696                                  stfn2:
 40697                                  	dec	si
 40698                                  	retn
 40699                                  
 40700                                  %endif
 40701                                  
 40702                                  ; ---------------------------------------------------------------------------
 40703                                  
 40704                                  ;***	SetupCmdLine -- prepare command line for the program
 40705                                  ;
 40706                                  ;	ENTRY	{es/ds}:si = points just after the end of the child program
 40707                                  ;
 40708                                  ;	EXIT	None
 40709                                  ;
 40710                                  ;	USED
 40711                                  ;
 40712                                  ;	EFFECTS		
 40713                                  ;		The rest of the command line following the pgm name is 
 40714                                  ;	moved to the top of the command line buffer (at TRANGROUP:81h)
 40715                                  ;	and a new command line length is put in
 40716                                  ; ---------------------------------------------------------------------------
 40717                                  
 40718                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40719                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59BEh
 40720                                  
 40721                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40722                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:68BEh
 40723                                  SetupCmdLine:
 40724                                  	;mov	di,81h
 40725 00006283 BF8100                  	mov	di,iCmdLine
 40726 00006286 30C9                    	xor	cl,cl
 40727 00006288 FEC9                    	dec	cl			;just CR means count = 0
 40728                                  SetCmdL1:
 40729 0000628A AC                      	lodsb
 40730 0000628B AA                      	stosb
 40731 0000628C FEC1                    	inc	cl			;update count
 40732                                  	
 40733                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40734                                  	; MSDOS 6.0
 40735                                  	; 14/04/2023
 40736                                  	; * ; MSDOS 6.0 only !
 40737 0000628E 08C0                    	or	al,al	; *
 40738 00006290 7404                    	jz	short SetCmdL2 ; *
 40739                                  	
 40740 00006292 3C0D                    	cmp	al,0Dh			;carriage return?
 40741 00006294 75F4                    	jnz	short SetCmdL1		;no, continue storing
 40742                                  SetCmdL2:
 40743 00006296 26880E8000              	mov	[es:80h],cl		;store new cmd line length
 40744 0000629B C3                      	retn
 40745                                  
 40746                                  ; ---------------------------------------------------------------------------
 40747                                  
 40748                                  ;***	LhSetupErrMsg -- Sets up error messages
 40749                                  ;
 40750                                  ;	ENTRY	ax = error message number
 40751                                  ;
 40752                                  ;	EXIT	None
 40753                                  ;
 40754                                  ;	USED	dx
 40755                                  ;
 40756                                  ;	EFFECTS
 40757                                  ;		Everything setup to display error message
 40758                                  ; ---------------------------------------------------------------------------
 40759                                  	
 40760                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40761                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40762                                  LhSetupErrMsg:
 40763 0000629C C606[C98F]01            	mov	byte [msg_disp_class],ext_msg_class ; 1
 40764 000062A1 BA[CB8F]                	mov	dx,extend_buf_ptr
 40765 000062A4 A3[CB8F]                	mov	[extend_buf_ptr],ax
 40766 000062A7 C3                      	retn
 40767                                  
 40768                                  ; ---------------------------------------------------------------------------
 40769                                  
 40770                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 40771                                  %if 0
 40772                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40773                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59DFh
 40774                                  	; MSDOS 5.0 COMMAND.COM only !
 40775                                  	; (Procedure name is not from original Microsoft source code!)
 40776                                  check_umblink:
 40777                                  	mov	ax,5800h	; DOS_CHECK_STRATEGY
 40778                                  	int	21h 	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40779                                  			 ; AL = function code: get allocation strategy
 40780                                  	mov	bl,al
 40781                                  	mov	ax,5802h	; DOS_CHECK_UMBLINK
 40782                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40783                                  			; AL = function code: (DOS 5beta) get UMB link state
 40784                                  	mov	bh,al
 40785                                  	xchg	ax,bx
 40786                                  	rol	al,1
 40787                                  	and	al,1
 40788                                  	shl	ah,1
 40789                                  	or	al,ah
 40790                                  	retn
 40791                                  
 40792                                  ; ---------------------------------------------------------------------------
 40793                                  
 40794                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40795                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:59F7h
 40796                                  	; MSDOS 5.0 COMMAND.COM only ! (MSDOS 6.0 code is different)
 40797                                  HideUMBs:
 40798                                  	push	ds
 40799                                  	call	check_umblink
 40800                                  	mov	ds,[RESSEG]
 40801                                  	mov	[fInHigh],al
 40802                                  	or	byte [fInHigh],80h
 40803                                  	pop	ds
 40804                                  	call	set_strategy
 40805                                  	;call	set_umblink
 40806                                  	;retn
 40807                                  	; 14/04/023
 40808                                  	;jmp	short set_umblink
 40809                                  
 40810                                  ; ---------------------------------------------------------------------------
 40811                                  
 40812                                  	; 14/04/2023
 40813                                  	; 13/04/2023
 40814                                  	; MSDOS 5.0 COMMAND.COM only !
 40815                                  	; (Procedure name is not from original Microsoft source code!)
 40816                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:597Bh
 40817                                  set_umblink:
 40818                                  	mov	ax,5803h	; DOS_SET_UMBLINK
 40819                                  	mov	bx,1
 40820                                  	int	21h	; DOS - 3+ - GET/SET MEMORY ALLOCATION STRATEGY
 40821                                  			; AL = function code: (DOS 5beta) set UMB link state
 40822                                  	retn
 40823                                  %endif
 40824                                  
 40825                                  ; ---------------------------------------------------------------------------
 40826                                  
 40827                                  ;***	SetupPath -- Do path search for the file to be executed
 40828                                  ;
 40829                                  ;	ENTRY	None
 40830                                  ;
 40831                                  ;	EXIT	Carry set if file not found or not executable file
 40832                                  ;
 40833                                  ;	EFFECTS
 40834                                  ;		ExecPath contains the full path of the file to be executed
 40835                                  ; ---------------------------------------------------------------------------
 40836                                  
 40837                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40838                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5A0Fh
 40839                                  
 40840                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40841                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:68E3h
 40842                                  SetupPath:
 40843                                  
 40844                                  ;Juggle around the argv pointers to make argv[1] into argv[0]. This is 
 40845                                  ;because the path search routine that we are about to invoke expects the
 40846                                  ;filename to search for to be argv[0].
 40847                                  ;
 40848                                  ;If our new argv[0] starts with a switcharacter, it's an option... skip right
 40849                                  ;over it by doing the whole move again (smaller, of course, this time).
 40850                                  
 40851                                  
 40852                                  	;mov	ax,arg.argvcnt		;total number of arguments
 40853                                  	; 14/04/2023
 40854                                  	;mov	ax,[ARG_ARGVCNT]
 40855 000062A8 A1[6FA2]                	mov	ax,[ARG+ARG_UNIT.argvcnt]
 40856                                  
 40857 000062AB 48                      	dec	ax			;less one - skip "LoadHigh"
 40858                                  	;mov	bx,SIZE Argv_ele
 40859 000062AC BB0B00                  	mov	bx,ARGV_ELE.SIZE ; 11
 40860                                  	;mov	bx,11
 40861 000062AF F7E3                    	mul	bx			;dx:ax = size of argument lists
 40862                                  
 40863                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 40864                                  	; --------------------------------------
 40865                                  	; MSDOS 6.0
 40866                                  
 40867                                  	;getdata cl,fm_argc		;CL = number of arguments to skip
 40868 000062B1 1E                      	push	ds              ; getdata (macro)
 40869 000062B2 8E1E[539C]              	mov	ds,[RESSEG]
 40870 000062B6 8A0E[3705]              	mov	cl,[fm_argc]
 40871 000062BA 1F                      	pop	ds
 40872                                  	
 40873 000062BB FEC1                    	inc	cl			;Skip one arg, to get over "lh"
 40874                                  
 40875                                  ;Move argv[1]..argv[n] to argv[0]..argv[n-1]. Here, AX == the overall size
 40876                                  ;of the argument lists.
 40877                                  
 40878                                  argloop:
 40879 000062BD E31B                    	jcxz	argdone			;If we've finished copying args, leave.
 40880                                  
 40881 000062BF 49                      	dec	cx			;One less time we'll go through this.
 40882                                  
 40883 000062C0 50                      	push	ax			;Copy ( size of remaining list ) bytes
 40884 000062C1 51                      	push	cx			;And remember how many args there were
 40885                                  
 40886                                  	; --------------------------------------
 40887                                  
 40888                                  	; 14/04/2023
 40889 000062C2 89C1                    	mov	cx,ax			;size to move
 40890                                  
 40891                                  	;mov	di,offset TRANGROUP:Arg	;Copy TO argv[0]
 40892                                  	;mov	di,ARG_ARGV ;mov di,[ARG+ARG_UNIT.argv] ; mov di,[ARG]
 40893 000062C4 BF[AF9F]                	mov	di,ARG	
 40894 000062C7 89FE                    	mov	si,di			;
 40895                                  	;add	si,SIZE Argv_ele	;Copy FROM argv[1]
 40896 000062C9 83C60B                  	add	si,ARGV_ELE.SIZE ; 11
 40897                                  	
 40898                                  	; 14/04/2023
 40899                                  	;mov	cx,ax
 40900                                  
 40901 000062CC FC                      	cld
 40902 000062CD F3A4                    	rep	movsb			;Move the argument list
 40903                                  	
 40904                                  	;dec	arg.argvcnt		;Fake one less argument, and
 40905                                  	;dec	word [ARG_ARGVCNT]
 40906 000062CF FF0E[6FA2]              	dec	word [ARG+ARG_UNIT.argvcnt]
 40907                                  
 40908                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 40909                                  	; --------------------------------------
 40910                                  	; MSDOS 6.0
 40911                                  	
 40912                                  	;sub	ax,ARGV_ELE.SIZE ; 11	;there's one argument we don't copy.
 40913                                  
 40914 000062D3 59                      	pop	cx
 40915 000062D4 58                      	pop	ax			;Restore the size of the arg list
 40916                                  	; 17/06/2023
 40917                                  	;jmp	short argloop
 40918                                  	
 40919                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40920 000062D5 83E80B                  	sub	ax,ARGV_ELE.SIZE ; 11
 40921 000062D8 77E3                    	ja	short argloop
 40922                                  	; --------------------------------------
 40923                                  	
 40924                                  ; Done moving... argv[0] is now the child program's name, and [1] its first arg
 40925                                  
 40926                                  	; 17/06/2023
 40927                                  argdone:
 40928 000062DA E8C3D2                  	call	path_search		;look in the path
 40929                                  
 40930                                  ;ax = 0, no file found
 40931                                  ;ax < 4, batch file found -- cant be executed
 40932                                  ;ax = 4,8 => .com or .exe file found
 40933                                  
 40934 000062DD 09C0                    	or	ax,ax			;any file found?
 40935 000062DF 740B                    	jz	short no_exec_file	;no, error
 40936                                  
 40937 000062E1 83F804                  	cmp	ax,4			;executable file?
 40938                                  	;jl	short no_exec_bat	;no, indicate fail ; M016
 40939                                  	;clc
 40940                                  	;retn
 40941                                  	; 14/04/2023
 40942 000062E4 7201                    	jb	short no_exec_bat
 40943 000062E6 C3                      	retn 
 40944                                  
 40945                                  no_exec_bat:
 40946 000062E7 BA[B492]                	mov	dx,NoExecBat_Ptr	;Setup message ptr ; M016
 40947 000062EA EB06                    	jmp	short lhsp_errret	;return error; M016
 40948                                  
 40949                                  no_exec_file:
 40950 000062EC B80200                  	mov	ax,ERROR_FILE_NOT_FOUND ; 2
 40951 000062EF E8AAFF                  	call	LhSetupErrMsg		;setup error message
 40952                                  lhsp_errret:				; M016
 40953 000062F2 F9                      	stc
 40954 000062F3 C3                      	retn
 40955                                  
 40956                                  ;============================================================================
 40957                                  ; COMMAND.SKL (MESSAGE.SKL), BUILDMSG.C, MSDOS 6.0, 1991
 40958                                  ;============================================================================
 40959                                  ; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 40960                                  
 40961                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5A44h
 40962                                  
 40963                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 40964                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6930h
 40965                                  
 40966                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 40967                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:67ADh
 40968                                  
 40969                                  ; ---------------------------------------------------------------------------
 40970                                  ; Class 3 message table/structure
 40971                                  ; ---------------------------------------------------------------------------
 40972                                  
 40973                                  $M_CLASS_3_STRUC:
 40974 000062F4 FF                      	db 0FFh			; $M_CLASS_ID (Class identifer)
 40975                                  	;dw 5			; $M_COMMAND_VER (COMMAND.COM version)
 40976                                  	;db 162			; Total number of messages
 40977                                  	; 17/06/2023
 40978                                  	;dw 1606h		; MSDOS 6.22 COMMAND.COM (hb=22,lb=6)
 40979                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 40980 000062F5 070A                    	dw 0A07h  ; PCDOS 7.1 COMMAND.COM
 40981                                  	;db 187			; Total number of messages
 40982                                  	; 02/08/2024
 40983 000062F7 B7                      	db 183	; PCDOS 7.1 COMMAND.COM
 40984                                  $M_ID_3_1:
 40985                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:5A48h)
 40986 000062F8 FC03                    	dw 1020			; Message Number = 1020
 40987                                  	;dw MSG_1020-$+2 ; 288h	; Message offset from message number (5A48h+0288h=5CD0h)
 40988                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 40989 000062FA D802                    	dw MSG_1020-$+2 ; 2ECh	; Message offset from message number (6934h+02ECh=6C20h)
 40990                                  $M_ID_3_2:
 40991 000062FC F703                    	dw 1015			; Message Number = 1015
 40992                                  	;dw MSG_1015-$+2 ; 294h ; Message offset from message number (5A4Ch+0294h=5CE0h)
 40993                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 40994 000062FE E402                    	dw MSG_1015-$+2 ; 2F8h	; Message offset from message number (6938h+02F8h=6C30h)
 40995                                  $M_ID_3_3:	; 26/04/2023
 40996                                  			; 17/06/2023
 40997                                  			   ; 06/08/2024
 40998 00006300 EC030403                	dw 1004,MSG_1004-$ ; 776	
 40999 00006304 02041A03                	dw 1026,MSG_1026-$ ; 798
 41000 00006308 07042A03                	dw 1031,MSG_1031-$ ; 814
 41001 0000630C 0B043503                	dw 1035,MSG_1035-$ ; 825
 41002 00006310 26044003                	dw 1062,MSG_1062-$ ; 836
 41003 00006314 04044B03                	dw 1028,MSG_1028-$ ; 847
 41004 00006318 15046903                	dw 1045,MSG_1045-$ ; 877
 41005 0000631C 11048203                	dw 1041,MSG_1041-$ ; 902
 41006 00006320 1204A003                	dw 1042,MSG_1042-$ ; 932
 41007                                  $M_ID_3_12:
 41008 00006324 1304B703                	dw 1043,MSG_1043-$ ; 955
 41009 00006328 EA03D303                	dw 1002,MSG_1002-$ ; 983
 41010 0000632C EB03F703                	dw 1003,MSG_1003-$ ; 1019
 41011 00006330 EF030F04                	dw 1007,MSG_1007-$ ; 1043
 41012 00006334 F0032604                	dw 1008,MSG_1008-$ ; 1066
 41013 00006338 F1033804                	dw 1009,MSG_1009-$ ; 1084
 41014 0000633C F2034904                	dw 1010,MSG_1010-$ ; 1101
 41015 00006340 F3036504                	dw 1011,MSG_1011-$ ; 1129
 41016 00006344 F6039904                	dw 1014,MSG_1014-$ ; 1152
 41017 00006348 F803A604                	dw 1016,MSG_1016-$ ; 1177
 41018 0000634C F903CC04                	dw 1017,MSG_1017-$ ; 1190
 41019 00006350 FA03ED04                	dw 1018,MSG_1018-$ ; 1228
 41020                                  $M_ID_3_24:
 41021 00006354 FB03FD04                	dw 1019,MSG_1019-$ ; 1277
 41022 00006358 FD030505                	dw 1021,MSG_1021-$ ; 1285
 41023 0000635C FE031F05                	dw 1022,MSG_1022-$ ; 1311
 41024 00006360 FF034205                	dw 1023,MSG_1023-$ ; 1346
 41025 00006364 00046A05                	dw 1024,MSG_1024-$ ; 1386
 41026 00006368 01047D05                	dw 1025,MSG_1025-$ ; 1405
 41027 0000636C 03049105                	dw 1027,MSG_1027-$ ; 1425
 41028 00006370 0504AE05                	dw 1029,MSG_1029-$ ; 1454
 41029 00006374 0604BC05                	dw 1030,MSG_1030-$ ; 1468
 41030 00006378 0804C705                	dw 1032,MSG_1032-$ ; 1479
 41031 0000637C 0904DB05                	dw 1033,MSG_1033-$ ; 1499
 41032 00006380 0A04ED05                	dw 1034,MSG_1034-$ ; 1517
 41033 00006384 0C04FF05                	dw 1036,MSG_1036-$ ; 1535
 41034 00006388 0D041006                	dw 1037,MSG_1037-$ ; 1552
 41035 0000638C 0E041D06                	dw 1038,MSG_1038-$ ; 1565
 41036 00006390 0F042C06                	dw 1039,MSG_1039-$ ; 1580
 41037                                  $M_ID_3_40:
 41038 00006394 10046506                	dw 1040,MSG_1040-$ ; 1637
 41039 00006398 14047406                	dw 1044,MSG_1044-$ ; 1652
 41040 0000639C 16048406                	dw 1046,MSG_1046-$ ; 1668
 41041 000063A0 1704B706                	dw 1047,MSG_1047-$ ; 1719
 41042 000063A4 1804CC06                	dw 1048,MSG_1048-$ ; 1740
 41043 000063A8 1904DA06                	dw 1049,MSG_1049-$ ; 1754
 41044 000063AC 1A04E006                	dw 1050,MSG_1050-$ ; 1760
 41045 000063B0 1B04FB06                	dw 1051,MSG_1051-$ ; 1787
 41046 000063B4 1C040807                	dw 1052,MSG_1052-$ ; 1800
 41047 000063B8 1D041B07                	dw 1053,MSG_1053-$ ; 1819
 41048 000063BC 1E043D07                	dw 1054,MSG_1054-$ ; 1853
 41049                                  $M_ID_3_51:
 41050 000063C0 1F046007                	dw 1055,MSG_1055-$ ; 1888
 41051 000063C4 20046A07                	dw 1056,MSG_1056-$ ; 1898
 41052 000063C8 21047507                	dw 1057,MSG_1057-$ ; 1909
 41053 000063CC 23047E07                	dw 1059,MSG_1059-$ ; 1918
 41054 000063D0 24047F07                	dw 1060,MSG_1060-$ ; 1919
 41055 000063D4 25047F07                	dw 1061,MSG_1061-$ ; 1919
 41056 000063D8 27049507                	dw 1063,MSG_1063-$ ; 1941
 41057 000063DC 28049407                	dw 1064,MSG_1064-$ ; 1940
 41058 000063E0 29049307                	dw 1065,MSG_1065-$ ; 1939
 41059 000063E4 2A049207                	dw 1066,MSG_1066-$ ; 1938
 41060 000063E8 2B049107                	dw 1067,MSG_1067-$ ; 1937
 41061 000063EC 2C048F07                	dw 1068,MSG_1068-$ ; 1935
 41062 000063F0 2D049807                	dw 1069,MSG_1069-$ ; 1944
 41063 000063F4 2E049807                	dw 1070,MSG_1070-$ ; 1944
 41064 000063F8 2F049707                	dw 1071,MSG_1071-$ ; 1943
 41065 000063FC 30049607                	dw 1072,MSG_1072-$ ; 1942
 41066                                  $M_ID_3_67:
 41067 00006400 31049C07                	dw 1073,MSG_1073-$ ; 1948
 41068 00006404 3204A207                	dw 1074,MSG_1074-$ ; 1954
 41069 00006408 3304A807                	dw 1075,MSG_1075-$ ; 1960
 41070 0000640C 3404AA07                	dw 1076,MSG_1076-$ ; 1962
 41071 00006410 3504A907                	dw 1077,MSG_1077-$ ; 1961
 41072 00006414 3604AD07                	dw 1078,MSG_1078-$ ; 1965
 41073 00006418 3704C407                	dw 1079,MSG_1079-$ ; 1988
 41074 0000641C 3804CB07                	dw 1080,MSG_1080-$ ; 1995
 41075 00006420 3904DD07                	dw 1081,MSG_1081-$ ; 2013
 41076                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41077 00006424 3A040408                	dw 1082,MSG_1082-$ ; 2052	
 41078 00006428 3B040C08                	dw 1083,MSG_1083-$ ; 2060	
 41079                                  	;
 41080 0000642C 3C040B08                	dw 1084,MSG_1084-$ ; 2059
 41081 00006430 42041708                	dw 1090,MSG_1090-$ ; 2071
 41082 00006434 43042108                	dw 1091,MSG_1091-$ ; 2081
 41083 00006438 44042B08                	dw 1092,MSG_1092-$ ; 2091
 41084 0000643C 45043508                	dw 1093,MSG_1093-$ ; 2101
 41085 00006440 46044608                	dw 1094,MSG_1094-$ ; 2118
 41086 00006444 47045F08                	dw 1095,MSG_1095-$ ; 2143
 41087 00006448 48047808                	dw 1096,MSG_1096-$ ; 2168
 41088                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41089 0000644C 4904A508                	dw 1097,MSG_1097-$ ; 2213
 41090 00006450 4A04BE08                	dw 1098,MSG_1098-$ ; 2238
 41091 00006454 4B04D708                	dw 1099,MSG_1099-$ ; 2263
 41092 00006458 4C04E908                	dw 1100,MSG_1100-$ ; 2281
 41093                                  
 41094                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41095                                  %if 0
 41096                                  	dw 1101,MSG_1101-$ ; 2302
 41097                                  	dw 1102,MSG_1102-$ ; 2313
 41098                                  %endif
 41099 0000645C 4F040B09                	dw 1103,MSG_1103-$ ; 2315
 41100 00006460 50042209                	dw 1104,MSG_1104-$ ; 2338
 41101                                  
 41102                                  	; TRANGROUP:6AA8h ; MSDOS 6.22
 41103                                  	; TRANGROUP:6921h ; PCDOS 7.1
 41104                                  
 41105 00006464 51042209                	dw 1105,MSG_1105-$ ; 2338  ; TRANGROUP:7243h ; PCDOS 7.1
 41106                                  
 41107                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41108                                  %if 1
 41109 00006468 52042909                	dw 1106,MSG_1106-$ ; 2345
 41110                                  %endif
 41111                                  
 41112                                  ;$M_ID_3_84:
 41113                                  $M_ID_3_95: ; 17/06/2023	
 41114 0000646C B0043709                	dw 1200,MSG_1200-$ ; 2359
 41115 00006470 14053409                	dw 1300,MSG_1300-$ ; 2356
 41116 00006474 2805B709                	dw 1320,MSG_1320-$ ; 2487
 41117 00006478 2905F309                	dw 1321,MSG_1321-$ ; 2547
 41118 0000647C 3C05600A                	dw 1340,MSG_1340-$ ; 2656
 41119 00006480 3D05B80A                	dw 1341,MSG_1341-$ ; 2744
 41120 00006484 3E05170B                	dw 1342,MSG_1342-$ ; 2839
 41121 00006488 5005A50B                	dw 1360,MSG_1360-$ ; 2981
 41122 0000648C 7805BD0B                	dw 1400,MSG_1400-$ ; 3005
 41123 00006490 7905560C                	dw 1401,MSG_1401-$ ; 3158
 41124 00006494 7A05BB0C                	dw 1402,MSG_1402-$ ; 3259
 41125 00006498 7B052E0D                	dw 1403,MSG_1403-$ ; 3374
 41126 0000649C 7C056A0D                	dw 1404,MSG_1404-$ ; 3434 ; TRANGROUP:6ADCh ; MSDOS 6.22
 41127                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41128 000064A0 7D05DB0D                	dw 1405,MSG_1405-$ ; 3547 ; TRANGROUP:6AE0h ; MSDOS 6.22
 41129                                  		     ; 06/08/2024 ; TRANGROUP:695Dh ; PCDOS 7.1 
 41130 000064A4 7E054A0E                	dw 1406,MSG_1406-$ ; 3658
 41131 000064A8 7F05890E                	dw 1407,MSG_1407-$ ; 3721 ; (MSG_1404 for MSDOS 5.0 COMMAND.COM)
 41132                                  	;
 41133 000064AC 8C050D0F                	dw 1420,MSG_1420-$ ; 3853
 41134 000064B0 A005940F                	dw 1440,MSG_1440-$ ; 3988
 41135 000064B4 A105B70F                	dw 1441,MSG_1441-$ ; 4023
 41136                                  ;$M_ID_3_100:
 41137                                  $M_ID_3_114: ; 17/06/2023
 41138 000064B8 B4053710                	dw 1460,MSG_1460-$ ; 4151
 41139 000064BC B5059810                	dw 1461,MSG_1461-$ ; 4248
 41140 000064C0 B6051811                	dw 1462,MSG_1462-$ ; 4376
 41141 000064C4 C8056411                	dw 1480,MSG_1480-$ ; 4452
 41142 000064C8 C9050012                	dw 1481,MSG_1481-$ ; 4608
 41143 000064CC CA054A12                	dw 1482,MSG_1482-$ ; 4682
 41144 000064D0 CB05A012                	dw 1483,MSG_1483-$ ; 4770
 41145 000064D4 CC051B13                	dw 1484,MSG_1484-$ ; 4893
 41146 000064D8 CD059413                	dw 1485,MSG_1485-$ ; 5014
 41147 000064DC CE052614                	dw 1486,MSG_1486-$ ; 5160
 41148 000064E0 CF05B214                	dw 1487,MSG_1487-$ ; 5300
 41149 000064E4 D0050D15                	dw 1488,MSG_1488-$ ; 5391
 41150                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41151 000064E8 D1059C15                	dw 1489,MSG_1489-$ ; 5534
 41152                                  
 41153                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41154                                  %if 0
 41155                                  	dw 1490,MSG_1490-$ ; 5505
 41156                                  	dw 1491,MSG_1491-$ ; 5529
 41157                                  	dw 1492,MSG_1492-$ ; 5608
 41158                                  	dw 1493,MSG_1493-$ ; 5751
 41159                                  	dw 1494,MSG_1494-$ ; 5770
 41160                                  %endif
 41161                                  
 41162                                  ;$M_ID_3_112:
 41163                                  $M_ID_3_132: ; 17/06/2023
 41164 000064EC DC05E915                	dw 1500,MSG_1500-$ ; 5611
 41165 000064F0 F0052416                	dw 1520,MSG_1520-$ ; 5670
 41166 000064F4 04065E16                	dw 1540,MSG_1540-$ ; 5728
 41167 000064F8 0506B816                	dw 1541,MSG_1541-$ ; 5818
 41168 000064FC 06062017                	dw 1542,MSG_1542-$ ; 5922
 41169 00006500 18065817                	dw 1560,MSG_1560-$ ; 5978
 41170 00006504 19068C17                	dw 1561,MSG_1561-$ ; 6030
 41171 00006508 1A060518                	dw 1562,MSG_1562-$ ; 6151
 41172 0000650C 1B063118                	dw 1563,MSG_1563-$ ; 6195
 41173 00006510 1C065818                	dw 1564,MSG_1564-$ ; 6234
 41174 00006514 1D069218                	dw 1565,MSG_1565-$ ; 6292
 41175 00006518 1E06C318                	dw 1566,MSG_1566-$ ; 6341
 41176 0000651C 1F06EC18                	dw 1567,MSG_1567-$ ; 6382
 41177 00006520 20066219                	dw 1568,MSG_1568-$ ; 6500
 41178 00006524 2C06AB19                	dw 1580,MSG_1580-$ ; 6573
 41179                                  ;$M_ID_3_127:
 41180                                  $M_ID_3_147: ; 17/06/2023
 41181 00006528 4006EF19                	dw 1600,MSG_1600-$ ; 6641
 41182 0000652C 4106081A                	dw 1601,MSG_1601-$ ; 6666
 41183 00006530 4206581A                	dw 1602,MSG_1602-$ ; 6746
 41184 00006534 5406F51A                	dw 1620,MSG_1620-$ ; 6903
 41185 00006538 5506491B                	dw 1621,MSG_1621-$ ; 6987
 41186 0000653C 5606C71B                	dw 1622,MSG_1622-$ ; 7113
 41187 00006540 68060F1C                	dw 1640,MSG_1640-$ ; 7185
 41188 00006544 6906401C                	dw 1641,MSG_1641-$ ; 7234
 41189 00006548 7C06C01C                	dw 1660,MSG_1660-$ ; 7362
 41190 0000654C 9006031D                	dw 1680,MSG_1680-$ ; 7429
 41191 00006550 A406251D                	dw 1700,MSG_1700-$ ; 7463
 41192 00006554 B806D31D                	dw 1720,MSG_1720-$ ; 7637
 41193 00006558 CC06221E                	dw 1740,MSG_1740-$ ; 7716
 41194 0000655C CD067A1E                	dw 1741,MSG_1741-$ ; 7804
 41195 00006560 E006E91E                	dw 1760,MSG_1760-$ ; 7915
 41196 00006564 F406321F                	dw 1780,MSG_1780-$ ; 7988
 41197                                  ;$M_ID_3_143:
 41198                                  $M_ID_3_163: ; 17/06/2023
 41199 00006568 08079A1F                	dw 1800,MSG_1800-$ ; 8092
 41200 0000656C 0907E41F                	dw 1801,MSG_1801-$ ; 8166
 41201 00006570 1C073820                	dw 1820,MSG_1820-$ ; 8250
 41202 00006574 1D077C20                	dw 1821,MSG_1821-$ ; 8318
 41203 00006578 30070321                	dw 1840,MSG_1840-$ ; 8453
 41204 0000657C 44074A21                	dw 1860,MSG_1860-$ ; 8524
 41205 00006580 4507A121                	dw 1861,MSG_1861-$ ; 8611
 41206 00006584 4607E421                	dw 1862,MSG_1862-$ ; 8678
 41207 00006588 47075E22                	dw 1863,MSG_1863-$ ; 8800
 41208 0000658C 4807FD22                	dw 1864,MSG_1864-$ ; 9959
 41209 00006590 49076023                	dw 1865,MSG_1865-$ ; 9058
 41210 00006594 4A07C723                	dw 1866,MSG_1866-$ ; 9161
 41211 00006598 58072B24                	dw 1880,MSG_1880-$ ; 9261
 41212 0000659C 59079F24                	dw 1881,MSG_1881-$ ; 9377
 41213 000065A0 5A071925                	dw 1882,MSG_1882-$ ; 9499
 41214 000065A4 5B076C25                	dw 1883,MSG_1883-$ ; 9582
 41215 000065A8 6C070B26                	dw 1900,MSG_1900-$ ; 9741
 41216 000065AC 80075026                	dw 1920,MSG_1920-$ ; 9810
 41217 000065B0 81077C26                	dw 1921,MSG_1921-$ ; 9854
 41218                                  ;$M_ID_3_162:
 41219                                  $M_ID_3_182: ; 17/06/2023
 41220 000065B4 82071127                	dw 1922,MSG_1922-$ ; 10003
 41221                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 41222 000065B8 8307C427                	dw 1923,MSG_1923-$ ; 10182
 41223 000065BC 84074628                	dw 1924,MSG_1924-$ ; 10312
 41224 000065C0 8507BE28                	dw 1925,MSG_1925-$ ; 10432
 41225 000065C4 8607BD28                	dw 1926,MSG_1926-$ ; 10431
 41226                                  $M_ID_3_187:	; 17/06/2023
 41227 000065C8 8707                    	dw 1927	; 19/06/2023	; Message Number = 1927
 41228 000065CA 1129                    	dw MSG_1927-$+2	; 10515	; Message offset from message number
 41229                                  		; MSDOS 6.22	; (Msg addr: 6C1Ch+2A1Eh = TRANGROUP:963Ah)
 41230                                  ; 06/08/2024	; PCDOS 7.1	; (Msg addr: 6A85h+2913h = TRANGROUP:9398h)
 41231                                  
 41232                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41233                                  %if 1
 41234                                  $M_ID_3_183:
 41235 000065CC 53046829                	dw 1107,MSG_1107-$ ; 10602 *
 41236                                  			; (Msg addr: 6A89h+296Ah = TRANGROUP:96F3h)	
 41237                                  %endif
 41238                                  
 41239                                  ; ---------------------------------------------------------------------------
 41240                                  ; Class 3 messages
 41241                                  ; ---------------------------------------------------------------------------
 41242                                  	
 41243                                  	; 14/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 41244                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:5CD0h
 41245                                  
 41246                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41247                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:6C20h
 41248                                  
 41249                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 41250                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:6A8Dh
 41251                                  
 41252                                  MSG_1020:	; COMMON4
 41253 000065D0 0F                      	db 15	; (MSG_1015-MSG_1020)-1
 41254 000065D1 253120627974657320-     	db '%1 bytes free',0Dh,0Ah
 41254 000065DA 667265650D0A       
 41255                                  MSG_1015:	; COMMON18
 41256 000065E0 23                      	db 35
 41257 000065E1 46696C652063616E6E-     	db 'File cannot be copied onto itself',0Dh,0Ah
 41257 000065EA 6F7420626520636F70-
 41257 000065F3 696564206F6E746F20-
 41257 000065FC 697473656C660D0A   
 41258                                  MSG_1004:	; COMMON20
 41259 00006604 19                      	db 25
 41260 00006605 496E73756666696369-     	db 'Insufficient disk space',0Dh,0Ah
 41260 0000660E 656E74206469736B20-
 41260 00006617 73706163650D0A     
 41261                                  MSG_1026:	; COMMON22
 41262 0000661E 13                      	db 19
 41263 0000661F 496E76616C69642063-     	db 'Invalid code page',0Dh,0Ah
 41263 00006628 6F646520706167650D-
 41263 00006631 0A                 
 41264                                  MSG_1031:	; COMMON23
 41265 00006632 0E                      	db 14
 41266 00006633 496E76616C69642064-     	db 'Invalid date',0Dh,0Ah
 41266 0000663C 6174650D0A         
 41267                                  MSG_1035:	; COMMON24
 41268 00006641 0E                      	db 14
 41269 00006642 496E76616C69642074-     	db 'Invalid time',0Dh,0Ah
 41269 0000664B 696D650D0A         
 41270                                  MSG_1062:	; COMMON25
 41271 00006650 0E                      	db 14
 41272 00006651 496E76616C69642070-     	db 'Invalid path',0Dh,0Ah
 41272 0000665A 6174680D0A         
 41273                                  MSG_1028:	; COMMON28
 41274 0000665F 21                      	db 33
 41275 00006660 507265737320616E79-     	db 'Press any key to continue . . .',0Dh,0Ah
 41275 00006669 206B657920746F2063-
 41275 00006672 6F6E74696E7565202E-
 41275 0000667B 202E202E0D0A       
 41276                                  MSG_1045:	; COMMON32
 41277 00006681 1C                      	db 28
 41278 00006682 556E61626C6520746F-     	db 'Unable to create directory',0Dh,0Ah
 41278 0000668B 206372656174652064-
 41278 00006694 69726563746F72790D-
 41278 0000669D 0A                 
 41279                                  MSG_1041:	; COMMON33
 41280 0000669E 21                      	db 33
 41281 0000669F 566F6C756D6520696E-     	db 'Volume in drive %1 has no label',0Dh,0Ah
 41281 000066A8 206472697665202531-
 41281 000066B1 20686173206E6F206C-
 41281 000066BA 6162656C0D0A       
 41282                                  MSG_1042:	; COMMON34
 41283 000066C0 1A                      	db 26
 41284 000066C1 566F6C756D6520696E-     	db 'Volume in drive %1 is %2',0Dh,0Ah
 41284 000066CA 206472697665202531-
 41284 000066D3 2069732025320D0A   
 41285                                  MSG_1043:	; COMMON36
 41286 000066DB 1F                      	db 31  ; (MSG_1002-MSG_1043)-1
 41287 000066DC 566F6C756D65205365-     	db 'Volume Serial Number is %1-%2',0Dh,0Ah
 41287 000066E5 7269616C204E756D62-
 41287 000066EE 65722069732025312D-
 41287 000066F7 25320D0A           
 41288                                  MSG_1002:
 41289 000066FB 27                              db 39
 41290 000066FC 4475706C6963617465-     	db 'Duplicate file name or file not found',0Dh,0Ah
 41290 00006705 2066696C65206E616D-
 41290 0000670E 65206F722066696C65-
 41290 00006717 206E6F7420666F756E-
 41290 00006720 640D0A             
 41291                                  MSG_1003:
 41292 00006723 1B                      	db 27
 41293 00006724 496E76616C69642070-     	db 'Invalid path or file name',0Dh,0Ah
 41293 0000672D 617468206F72206669-
 41293 00006736 6C65206E616D650D0A 
 41294                                  MSG_1007:
 41295 0000673F 1A                      	db 26
 41296 00006740 4F7574206F6620656E-     	db 'Out of environment space',0Dh,0Ah
 41296 00006749 7669726F6E6D656E74-
 41296 00006752 2073706163650D0A   
 41297                                  MSG_1008:
 41298 0000675A 15                      	db 21
 41299 0000675B 46696C652063726561-     	db 'File creation error',0Dh,0Ah
 41299 00006764 74696F6E206572726F-
 41299 0000676D 720D0A             
 41300                                  MSG_1009:
 41301 00006770 14                      	db 20  ; (MSG_1010-MSG_1009)-1
 41302 00006771 42617463682066696C-     	db 'Batch file missing',0Dh,0Ah
 41302 0000677A 65206D697373696E67-
 41302 00006783 0D0A               
 41303                                  MSG_1010:
 41304 00006785 1F                      	db 31
 41305 00006786 0D0A                    	db 0Dh,0Ah
 41306 00006788 496E73657274206469-     	db 'Insert disk with batch file',0Dh,0Ah
 41306 00006791 736B20776974682062-
 41306 0000679A 617463682066696C65-
 41306 000067A3 0D0A               
 41307                                  MSG_1011:
 41308 000067A5 1A                      	db 26
 41309 000067A6 42616420636F6D6D61-     	db 'Bad command or file name',0Dh,0Ah
 41309 000067AF 6E64206F722066696C-
 41309 000067B8 65206E616D650D0A   
 41310                                  
 41311                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 41312                                  %if 1
 41313                                  MSG_1012:
 41314 000067C0 1C                      	db 28
 41315 000067C1 5245585820696E7465-     	db 'REXX interpreter not found',0Dh,0Ah	
 41315 000067CA 72707265746572206E-
 41315 000067D3 6F7420666F756E640D-
 41315 000067DC 0A                 
 41316                                  %endif
 41317                                  
 41318                                  MSG_1014:	; EXTEND5
 41319 000067DD 10                      	db 16
 41320 000067DE 416363657373206465-     	db 'Access denied ',0Dh,0Ah
 41320 000067E7 6E696564200D0A     
 41321                                  MSG_1016:
 41322 000067EE 29                      	db 41
 41323 000067EF 436F6E74656E74206F-     	db 'Content of destination lost before copy',0Dh,0Ah
 41323 000067F8 662064657374696E61-
 41323 00006801 74696F6E206C6F7374-
 41323 0000680A 206265666F72652063-
 41323 00006813 6F70790D0A         
 41324                                  MSG_1017:
 41325 00006818 24                      	db 36
 41326 00006819 496E76616C69642066-     	db 'Invalid filename or file not found',0Dh,0Ah
 41326 00006822 696C656E616D65206F-
 41326 0000682B 722066696C65206E6F-
 41326 00006834 7420666F756E640D0A 
 41327                                  MSG_1018:
 41328 0000683D 13                      	db 19
 41329 0000683E 25312066696C652873-     	db '%1 file(s) copied',0Dh,0Ah
 41329 00006847 2920636F706965640D-
 41329 00006850 0A                 
 41330                                  MSG_1019:
 41331 00006851 0B                      	db 11
 41332 00006852 25312066696C652873-     	db '%1 file(s) '
 41332 0000685B 2920               
 41333                                  MSG_1021:	; EXTEND15
 41334 0000685D 1D                      	db 29
 41335 0000685E 496E76616C69642064-     	db 'Invalid drive specification',0Dh,0Ah
 41335 00006867 726976652073706563-
 41335 00006870 696669636174696F6E-
 41335 00006879 0D0A               
 41336                                  MSG_1022:
 41337 0000687B 26                      	db 38
 41338 0000687C 436F64652070616765-     	db 'Code page %1 not prepared for system',0Dh,0Ah
 41338 00006885 202531206E6F742070-
 41338 0000688E 726570617265642066-
 41338 00006897 6F722073797374656D-
 41338 000068A0 0D0A               
 41339                                  MSG_1023:
 41340 000068A2 2B                      	db 43
 41341 000068A3 436F64652070616765-     	db 'Code page %1 not prepared for all devices',0Dh,0Ah
 41341 000068AC 202531206E6F742070-
 41341 000068B5 726570617265642066-
 41341 000068BE 6F7220616C6C206465-
 41341 000068C7 76696365730D0A     
 41342                                  MSG_1024:
 41343 000068CE 16                      	db 22
 41344 000068CF 41637469766520636F-     	db 'Active code page: %1',0Dh,0Ah
 41344 000068D8 646520706167653A20-
 41344 000068E1 25310D0A           
 41345                                  MSG_1025:
 41346 000068E5 17                      	db 23
 41347 000068E6 4E4C5346554E43206E-     	db 'NLSFUNC not installed',0Dh,0Ah
 41347 000068EF 6F7420696E7374616C-
 41347 000068F8 6C65640D0A         
 41348                                  MSG_1027:
 41349 000068FD 20                      	db 32
 41350 000068FE 43757272656E742064-     	db 'Current drive is no longer valid'
 41350 00006907 72697665206973206E-
 41350 00006910 6F206C6F6E67657220-
 41350 00006919 76616C6964         
 41351                                  MSG_1029:
 41352 0000691E 11                      	db 17
 41353 0000691F 4C6162656C206E6F74-     	db 'Label not found',0Dh,0Ah
 41353 00006928 20666F756E640D0A   
 41354                                  MSG_1030:
 41355 00006930 0E                      	db 14
 41356 00006931 53796E746178206572-     	db 'Syntax error',0Dh,0Ah
 41356 0000693A 726F720D0A         
 41357                                  MSG_1032:
 41358 0000693F 17                      	db 23
 41359 00006940 43757272656E742064-     	db 'Current date is %1 %2',0Dh,0Ah
 41359 00006949 617465206973202531-
 41359 00006952 2025320D0A         
 41360                                  MSG_1033:
 41361 00006957 15                      	db 21
 41362 00006958 53756E4D6F6E547565-     	db 'SunMonTueWedThuFriSat'
 41362 00006961 576564546875467269-
 41362 0000696A 536174             
 41363                                  MSG_1034:
 41364 0000696D 15                      	db 21
 41365 0000696E 456E746572206E6577-     	db 'Enter new date (%1): '
 41365 00006977 206461746520282531-
 41365 00006980 293A20             
 41366                                  MSG_1036:
 41367 00006983 14                      	db 20
 41368 00006984 43757272656E742074-     	db 'Current time is %1',0Dh,0Ah
 41368 0000698D 696D65206973202531-
 41368 00006996 0D0A               
 41369                                  MSG_1037:
 41370 00006998 10                      	db 16
 41371 00006999 456E746572206E6577-     	db 'Enter new time: '
 41371 000069A2 2074696D653A20     
 41372                                  MSG_1038:
 41373 000069A9 12                              db 18
 41374 000069AA 2C2020202044656C65-     	db ',    Delete (Y/N)?'
 41374 000069B3 74652028592F4E293F 
 41375                                  MSG_1039:
 41376 000069BC 3C                              db 60
 41377 000069BD 416C6C2066696C6573-     	db 'All files in directory will be deleted!',0Dh,0Ah
 41377 000069C6 20696E206469726563-
 41377 000069CF 746F72792077696C6C-
 41377 000069D8 2062652064656C6574-
 41377 000069E1 6564210D0A         
 41378 000069E6 41726520796F752073-     	db 'Are you sure (Y/N)?'
 41378 000069EF 7572652028592F4E29-
 41378 000069F8 3F                 
 41379                                  
 41380                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 41381                                  %if 0
 41382                                  MSG_1040:
 41383                                  	db 20
 41384                                  	db 'MS-DOS Version %1.%2'
 41385                                  %else
 41386                                  MSG_1040:
 41387 000069F9 12                      	db 18
 41388 000069FA 504320444F53205665-     	db 'PC DOS Version 7.1'
 41388 00006A03 7273696F6E20372E31 
 41389                                  %endif
 41390                                  
 41391                                  MSG_1044:
 41392 00006A0C 13                      	db 19
 41393 00006A0D 496E76616C69642064-     	db 'Invalid directory',0Dh,0Ah
 41393 00006A16 69726563746F72790D-
 41393 00006A1F 0A                 
 41394                                  MSG_1046:
 41395 00006A20 36                      	db 54
 41396 00006A21 496E76616C69642070-     	db 'Invalid path, not directory,',0Dh,0Ah
 41396 00006A2A 6174682C206E6F7420-
 41396 00006A33 6469726563746F7279-
 41396 00006A3C 2C0D0A             
 41397 00006A3F 6F7220646972656374-     	db 'or directory not empty',0Dh,0Ah
 41397 00006A48 6F7279206E6F742065-
 41397 00006A51 6D7074790D0A       
 41398                                  MSG_1047:
 41399 00006A57 18                      	db 24
 41400 00006A58 4D7573742073706563-     	db 'Must specify ON or OFF',0Dh,0Ah
 41400 00006A61 696679204F4E206F72-
 41400 00006A6A 204F46460D0A       
 41401                                  MSG_1048:
 41402 00006A70 11                      	db 17
 41403 00006A71 4469726563746F7279-     	db 'Directory of %1',0Dh,0Ah
 41403 00006A7A 206F662025310D0A   
 41404                                  MSG_1049:
 41405 00006A82 09                      	db 9
 41406 00006A83 4E6F20506174680D0A      	db 'No Path',0Dh,0Ah
 41407                                  MSG_1050:
 41408 00006A8C 1E                      	db 30
 41409 00006A8D 496E76616C69642064-     	db 'Invalid drive in search path',0Dh,0Ah
 41409 00006A96 7269766520696E2073-
 41409 00006A9F 656172636820706174-
 41409 00006AA8 680D0A             
 41410                                  MSG_1051:
 41411 00006AAB 10                      	db 16
 41412 00006AAC 496E76616C69642064-     	db 'Invalid device',0Dh,0Ah
 41412 00006AB5 65766963650D0A     
 41413                                  MSG_1052:
 41414 00006ABC 16                      	db 22
 41415 00006ABD 464F522063616E6E6F-     	db 'FOR cannot be nested',0Dh,0Ah
 41415 00006AC6 74206265206E657374-
 41415 00006ACF 65640D0A           
 41416                                  MSG_1053:
 41417 00006AD3 25                      	db 37
 41418 00006AD4 496E7465726D656469-     	db 'Intermediate file error during pipe',0Dh,0Ah
 41418 00006ADD 6174652066696C6520-
 41418 00006AE6 6572726F7220647572-
 41418 00006AEF 696E6720706970650D-
 41418 00006AF8 0A                 
 41419                                  MSG_1054:
 41420 00006AF9 26                      	db 38
 41421 00006AFA 43616E6E6F7420646F-     	db 'Cannot do binary reads from a device',0Dh,0Ah
 41421 00006B03 2062696E6172792072-
 41421 00006B0C 656164732066726F6D-
 41421 00006B15 206120646576696365-
 41421 00006B1E 0D0A               
 41422                                  
 41423                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:6205h)
 41424                                  	; 17/06/2023
 41425                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7155h)
 41426                                  	; 06/08/2024
 41427                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:6FDDh)
 41428                                  MSG_1055:
 41429 00006B20 0D                      	db 13
 41430 00006B21 425245414B20697320-     	db 'BREAK is %1',0Dh,0Ah
 41430 00006B2A 25310D0A           
 41431                                  MSG_1056:
 41432 00006B2E 0E                      	db 14
 41433 00006B2F 564552494659206973-     	db 'VERIFY is %1',0Dh,0Ah
 41433 00006B38 2025310D0A         
 41434                                  MSG_1057:
 41435 00006B3D 0C                      	db 12
 41436 00006B3E 4543484F2069732025-     	db 'ECHO is %1',0Dh,0Ah
 41436 00006B47 310D0A             
 41437                                  MSG_1059:
 41438 00006B4A 04                      	db 4
 41439 00006B4B 6F666600                	db 'off',0
 41440                                  MSG_1060:
 41441 00006B4F 03                      	db 3
 41442 00006B50 6F6E00                  	db 'on',0
 41443                                  MSG_1061:
 41444 00006B53 19                      	db 25
 41445 00006B54 4572726F7220777269-     	db 'Error writing to device',0Dh,0Ah
 41445 00006B5D 74696E6720746F2064-
 41445 00006B66 65766963650D0A     
 41446                                  MSG_1063:
 41447 00006B6D 02                      	db 2
 41448 00006B6E 2531                    	db '%1'
 41449                                  MSG_1064:
 41450 00006B70 02                      	db 2
 41451 00006B71 2531                    	db '%1'
 41452                                  MSG_1065:
 41453 00006B73 02                      	db 2
 41454 00006B74 2531                    	db '%1'
 41455                                  MSG_1066:
 41456 00006B76 02                      	db 2
 41457 00006B77 2531                    	db '%1'
 41458                                  MSG_1067:
 41459 00006B79 01                      	db 1
 41460 00006B7A 09                      	db 9
 41461                                  MSG_1068:
 41462                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41463                                  %if 0
 41464                                  	db 10
 41465                                  	db ' <DIR>    '
 41466                                  %else
 41467 00006B7B 0C                      	db 12
 41468 00006B7C 203C4449523E202020-     	db ' <DIR>      '
 41468 00006B85 202020             
 41469                                  %endif
 41470                                  MSG_1069:
 41471 00006B88 03                      	db 3
 41472 00006B89 082008                  	db 8, 20h, 8
 41473                                  MSG_1070:	; CRLF
 41474 00006B8C 02                      	db 2
 41475 00006B8D 0D                      	db 0Dh
 41476 00006B8E 0A                      	db 0Ah
 41477                                  MSG_1071:
 41478 00006B8F 02                      	db 2
 41479 00006B90 2531                    	db '%1'
 41480                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41481                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:71C5h
 41482                                  MSG_1072:
 41483                                  	;db 8
 41484                                  	;db 'mm-dd-yy'
 41485 00006B92 09                      	db 9
 41486 00006B93 6D6D2D64642D797900      	db 'mm-dd-yy',0
 41487                                  MSG_1073:
 41488                                  	;db 8
 41489                                  	;db 'dd-mm-yy'
 41490 00006B9C 09                      	db 9
 41491 00006B9D 64642D6D6D2D797900      	db 'dd-mm-yy',0
 41492                                  MSG_1074:
 41493                                  	;db 8
 41494                                  	;db 'yy-mm-dd'
 41495 00006BA6 09                      	db 9
 41496 00006BA7 79792D6D6D2D646400      	db 'yy-mm-dd',0
 41497                                  MSG_1075:
 41498 00006BB0 05                      	db 5
 41499 00006BB1 2531202532              	db '%1 %2'
 41500                                  MSG_1076:
 41501 00006BB6 02                      	db 2
 41502 00006BB7 2531                    	db '%1'
 41503                                  MSG_1077:
 41504 00006BB9 07                      	db 7
 41505 00006BBA 20253120202532          	db ' %1  %2'
 41506                                  MSG_1078:
 41507 00006BC1 1A                      	db 26
 41508 00006BC2 4469726563746F7279-     	db 'Directory already exists',0Dh,0Ah
 41508 00006BCB 20616C726561647920-
 41508 00006BD4 6578697374730D0A   
 41509                                  MSG_1079:
 41510 00006BDC 0A                      	db 10
 41511 00006BDD 25312062797465730D-     	db '%1 bytes',0Dh,0Ah
 41511 00006BE6 0A                 
 41512                                  MSG_1080:
 41513 00006BE7 15                      	db 21
 41514 00006BE8 546F74616C2066696C-     	db 'Total files listed:',0Dh,0Ah
 41514 00006BF1 6573206C6973746564-
 41514 00006BFA 3A0D0A             
 41515                                  MSG_1081:
 41516 00006BFD 2A                      	db 42
 41517 00006BFE 284572726F72206F63-     	db '(Error occurred in environment variable)',0Dh,0Ah
 41517 00006C07 63757272656420696E-
 41517 00006C10 20656E7669726F6E6D-
 41517 00006C19 656E74207661726961-
 41517 00006C22 626C65290D0A       
 41518                                  	;
 41519                                  ; 06/08/2024 -Retro DOS 5.0 COMMAND.COM
 41520                                  %if 0
 41521                                  	; 17/06/2023 - Retro DOS 4.2 COMMAND.COM
 41522                                  MSG_1082:
 41523                                          db 7
 41524                                  	db ' [Y/N]?'
 41525                                  %else
 41526                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41527                                  MSG_1082:
 41528 00006C28 0B                              db 11
 41529 00006C29 205B592C4E2C455343-     	db ' [Y,N,ESC]?'
 41529 00006C32 5D3F               
 41530                                  %endif
 41531                                  	;
 41532                                  MSG_1083:
 41533 00006C34 02                      	db 2
 41534 00006C35 594E                    	db 'YN'
 41535                                  	;
 41536                                  MSG_1084:
 41537 00006C37 0F                      	db 15
 41538 00006C38 28636F6E74696E7569-     	db '(continuing %1)'
 41538 00006C41 6E6720253129       
 41539                                  MSG_1090:
 41540 00006C47 0D                      	db 13
 41541 00006C48 5265766973696F6E20-     	db 'Revision %1',0Dh,0Ah
 41541 00006C51 25310D0A           
 41542                                  MSG_1091:
 41543 00006C55 0D                      	db 13
 41544 00006C56 444F5320697320696E-     	db 'DOS is in ROM'
 41544 00006C5F 20524F4D           
 41545                                  MSG_1092:
 41546 00006C63 0D                      	db 13
 41547 00006C64 444F5320697320696E-     	db 'DOS is in HMA'
 41547 00006C6D 20484D41           
 41548                                  MSG_1093:
 41549 00006C71 14                      	db 20
 41550 00006C72 444F5320697320696E-     	db 'DOS is in low memory'
 41550 00006C7B 206C6F77206D656D6F-
 41550 00006C84 7279               
 41551                                  MSG_1094:
 41552 00006C86 1C                      	db 28
 41553 00006C87 43616E6E6F74204C6F-     	db 'Cannot Loadhigh batch file',0Dh,0Ah
 41553 00006C90 616468696768206261-
 41553 00006C99 7463682066696C650D-
 41553 00006CA2 0A                 
 41554                                  MSG_1095:
 41555 00006CA3 1C                      	db 28
 41556 00006CA4 4C6F6164486967683A-     	db 'LoadHigh: Invalid filename',0Dh,0Ah
 41556 00006CAD 20496E76616C696420-
 41556 00006CB6 66696C656E616D650D-
 41556 00006CBF 0A                 
 41557                                  MSG_1096:
 41558 00006CC0 30                      	db 48
 41559 00006CC1 43616E6E6F74206F70-     	db 'Cannot open specified country information file',0Dh,0Ah
 41559 00006CCA 656E20737065636966-
 41559 00006CD3 69656420636F756E74-
 41559 00006CDC 727920696E666F726D-
 41559 00006CE5 6174696F6E2066696C-
 41559 00006CEE 650D0A             
 41560                                  
 41561                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41562                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7320h
 41563                                  MSG_1097:
 41564 00006CF1 1C                      	db 28
 41565 00006CF2 4C6F6164486967683A-     	db 'LoadHigh: Invalid argument',0Dh,0Ah
 41565 00006CFB 20496E76616C696420-
 41565 00006D04 617267756D656E740D-
 41565 00006D0D 0A                 
 41566                                  MSG_1098:
 41567 00006D0E 1C                      	db 28
 41568 00006D0F 526571756972656420-     	db 'Required parameter missing',0Dh,0Ah
 41568 00006D18 706172616D65746572-
 41568 00006D21 206D697373696E670D-
 41568 00006D2A 0A                 
 41569                                  MSG_1099:
 41570 00006D2B 15                      	db 21
 41571 00006D2C 556E7265636F676E69-     	db 'Unrecognized switch',0Dh,0Ah
 41571 00006D35 7A6564207377697463-
 41571 00006D3E 680D0A             
 41572                                  MSG_1100:
 41573 00006D41 25                      	db 37
 41574 00006D42 412062616420554D42-     	db 'A bad UMB number has been specified',0Dh,0Ah
 41574 00006D4B 206E756D6265722068-
 41574 00006D54 6173206265656E2073-
 41574 00006D5D 70656369666965640D-
 41574 00006D66 0A                 
 41575                                  
 41576                                  ; 02/08/2024 - PCDOS 7.1 COMMAND.COM
 41577                                  %if 0
 41578                                  MSG_1101:
 41579                                  	db 14
 41580                                  	db '  %1.%2 to 1.0'
 41581                                  MSG_1102:
 41582                                  	db 57
 41583                                  	db '                 %1.%2 to 1.0 average compression ratio',0Dh,0Ah
 41584                                  %endif
 41585                                  
 41586                                  MSG_1103:
 41587 00006D67 1A                      	db 26
 41588 00006D68 4F7665727772697465-     	db 'Overwrite %1 (Yes/No/All)?'
 41588 00006D71 20253120285965732F-
 41588 00006D7A 4E6F2F416C6C293F   
 41589                                  MSG_1104:
 41590 00006D82 03                      	db 3
 41591 00006D83 59                      _Y_es:	db 'Y'
 41592 00006D84 4E                      _N_o:	db 'N'
 41593 00006D85 41                      _A_ll:	db 'A'
 41594                                  
 41595                                  ; 02/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 41596                                  %if 0
 41597                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:73FEh)
 41598                                  MSG_1105:
 41599                                  	db 4
 41600                                  	db '    '
 41601                                  %else
 41602                                  	; 03/08/2024
 41603                                  MSG_1105:
 41604 00006D86 0A                      	db 10
 41605 00006D87 203C4449523E202020-     	db ' <DIR>    '
 41605 00006D90 20                 
 41606                                  
 41607                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:724Eh)
 41608                                  MSG_1106:
 41609 00006D91 11                      	db 17
 41610 00006D92 2531204B2062797465-     	db '%1 K bytes free',0Dh,0Ah
 41610 00006D9B 7320667265650D0A   
 41611                                  %endif
 41612                                  
 41613                                  	; ((MSDOS 5.0 COMMAND.COM - TRANGROUP:63C2h))
 41614                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7403h)
 41615                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:7260h
 41616                                  MSG_1200:
 41617 00006DA3 00                      	db 0	; /? unimplemented
 41618                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7404h)
 41619                                  MSG_1300:
 41620 00006DA4 86                      	db 134
 41621 00006DA5 53657473206F722063-     	db 'Sets or clears extended CTRL+C checking.',0Dh,0Ah
 41621 00006DAE 6C6561727320657874-
 41621 00006DB7 656E64656420435452-
 41621 00006DC0 4C2B4320636865636B-
 41621 00006DC9 696E672E0D0A       
 41622 00006DCF 0D0A                    	db 0Dh,0Ah
 41623 00006DD1 425245414B205B4F4E-     	db 'BREAK [ON | OFF]',0Dh,0Ah
 41623 00006DDA 207C204F46465D0D0A 
 41624 00006DE3 0D0A                    	db 0Dh,0Ah
 41625 00006DE5 547970652042524541-     	db 'Type BREAK without a parameter to display the current BREAK setting.',0Dh,0Ah
 41625 00006DEE 4B20776974686F7574-
 41625 00006DF7 206120706172616D65-
 41625 00006E00 74657220746F206469-
 41625 00006E09 73706C617920746865-
 41625 00006E12 2063757272656E7420-
 41625 00006E1B 425245414B20736574-
 41625 00006E24 74696E672E0D0A     
 41626                                  MSG_1320:
 41627 00006E2B 3F                      	db 63
 41628 00006E2C 446973706C61797320-     	db 'Displays or sets the active code page number.',0Dh,0Ah
 41628 00006E35 6F7220736574732074-
 41628 00006E3E 686520616374697665-
 41628 00006E47 20636F646520706167-
 41628 00006E50 65206E756D6265722E-
 41628 00006E59 0D0A               
 41629 00006E5B 0D0A                    	db 0Dh,0Ah
 41630 00006E5D 43484350205B6E6E6E-     	db 'CHCP [nnn]',0Dh,0Ah
 41630 00006E66 5D0D0A             
 41631 00006E69 0D0A                    	db 0Dh,0Ah
 41632                                  MSG_1321:
 41633 00006E6B 70                      	db 112
 41634 00006E6C 20206E6E6E20202053-     	db '  nnn   Specifies a code page number.',0Dh,0Ah
 41634 00006E75 706563696669657320-
 41634 00006E7E 6120636F6465207061-
 41634 00006E87 6765206E756D626572-
 41634 00006E90 2E0D0A             
 41635 00006E93 0D0A                    	db 0Dh,0Ah
 41636 00006E95 547970652043484350-     	db 'Type CHCP without a parameter to display the active code page number.',0Dh,0Ah
 41636 00006E9E 20776974686F757420-
 41636 00006EA7 6120706172616D6574-
 41636 00006EB0 657220746F20646973-
 41636 00006EB9 706C61792074686520-
 41636 00006EC2 61637469766520636F-
 41636 00006ECB 64652070616765206E-
 41636 00006ED4 756D6265722E0D0A   
 41637                                  MSG_1340:
 41638 00006EDC 5B                      	db 91
 41639 00006EDD 446973706C61797320-     	db 'Displays the name of or changes the current directory.',0Dh,0Ah
 41639 00006EE6 746865206E616D6520-
 41639 00006EEF 6F66206F7220636861-
 41639 00006EF8 6E6765732074686520-
 41639 00006F01 63757272656E742064-
 41639 00006F0A 69726563746F72792E-
 41639 00006F13 0D0A               
 41640 00006F15 0D0A                    	db 0Dh,0Ah
 41641 00006F17 4348444952205B6472-     	db 'CHDIR [drive:][path]',0Dh,0Ah
 41641 00006F20 6976653A5D5B706174-
 41641 00006F29 685D0D0A           
 41642 00006F2D 43484449525B2E2E5D-     	db 'CHDIR[..]',0Dh,0Ah
 41642 00006F36 0D0A               
 41643                                  MSG_1341:
 41644 00006F38 62                      	db 98
 41645 00006F39 4344205B6472697665-     	db 'CD [drive:][path]',0Dh,0Ah
 41645 00006F42 3A5D5B706174685D0D-
 41645 00006F4B 0A                 
 41646 00006F4C 43445B2E2E5D0D0A        	db 'CD[..]',0Dh,0Ah
 41647 00006F54 0D0A                    	db 0Dh,0Ah
 41648 00006F56 20202E2E2020205370-     	db '  ..   Specifies that you want to change to the parent directory.'
 41648 00006F5F 656369666965732074-
 41648 00006F68 68617420796F752077-
 41648 00006F71 616E7420746F206368-
 41648 00006F7A 616E676520746F2074-
 41648 00006F83 686520706172656E74-
 41648 00006F8C 206469726563746F72-
 41648 00006F95 792E               
 41649 00006F97 0D0A                    	db 0Dh,0Ah
 41650 00006F99 0D0A                    	db 0Dh,0Ah
 41651                                  MSG_1342:
 41652 00006F9B 91                      	db 145
 41653 00006F9C 547970652043442064-     	db 'Type CD drive: to display the current directory in the specified '
 41653 00006FA5 726976653A20746F20-
 41653 00006FAE 646973706C61792074-
 41653 00006FB7 68652063757272656E-
 41653 00006FC0 74206469726563746F-
 41653 00006FC9 727920696E20746865-
 41653 00006FD2 207370656369666965-
 41653 00006FDB 6420               
 41654 00006FDD 64726976652E0D0A        	db 'drive.',0Dh,0Ah
 41655 00006FE5 547970652043442077-     	db 'Type CD without parameters to display the current drive and directory.',0Dh,0Ah
 41655 00006FEE 6974686F7574207061-
 41655 00006FF7 72616D657465727320-
 41655 00007000 746F20646973706C61-
 41655 00007009 792074686520637572-
 41655 00007012 72656E742064726976-
 41655 0000701B 6520616E6420646972-
 41655 00007024 6563746F72792E0D0A 
 41656                                  MSG_1360:
 41657 0000702D 1B                      	db 27
 41658 0000702E 436C65617273207468-     	db 'Clears the screen.',0Dh,0Ah
 41658 00007037 652073637265656E2E-
 41658 00007040 0D0A               
 41659 00007042 0D0A                    	db 0Dh,0Ah
 41660 00007044 434C530D0A              	db 'CLS',0Dh,0Ah
 41661                                  MSG_1400:
 41662                                  	;db 145
 41663                                  	;db 'Copies one or more files to another location.',0Dh,0Ah
 41664                                  	;db 0Dh,0Ah
 41665                                  	;db 'COPY [/A | /B] source [/A | /B] [+ source [/A | /B] [+ ...]] [destination',0Dh,0Ah
 41666                                  	;db '  [/A | /B]] [/V]',0Dh,0Ah
 41667                                  	;db 0Dh,0Ah
 41668                                  	
 41669                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41670                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:76A9h)
 41671                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 41672                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:7506h)
 41673                                  
 41674 00007049 9C                      	db 156 ; 19/06/2023	
 41675 0000704A 436F70696573206F6E-     	db 'Copies one or more files to another location.',0Dh,0Ah
 41675 00007053 65206F72206D6F7265-
 41675 0000705C 2066696C657320746F-
 41675 00007065 20616E6F7468657220-
 41675 0000706E 6C6F636174696F6E2E-
 41675 00007077 0D0A               
 41676 00007079 0D0A                    	db 0Dh,0Ah
 41677 0000707B 434F5059205B2F4120-     	db 'COPY [/A | /B] source [/A | /B] [+ source [/A | /B] [+ ...]] [destination',0Dh,0Ah
 41677 00007084 7C202F425D20736F75-
 41677 0000708D 726365205B2F41207C-
 41677 00007096 202F425D205B2B2073-
 41677 0000709F 6F75726365205B2F41-
 41677 000070A8 207C202F425D205B2B-
 41677 000070B1 202E2E2E5D5D205B64-
 41677 000070BA 657374696E6174696F-
 41677 000070C3 6E0D0A             
 41678 000070C6 20205B2F41207C202F-     	db '  [/A | /B]] [/V] [/Y | /-Y]',0Dh,0Ah
 41678 000070CF 425D5D205B2F565D20-
 41678 000070D8 5B2F59207C202F2D59-
 41678 000070E1 5D0D0A             
 41679 000070E4 0D0A                    	db 0Dh,0Ah
 41680                                  MSG_1401:
 41681 000070E6 68                      	db 104
 41682 000070E7 2020736F7572636520-     	db '  source       Specifies the file or files to be copied.',0Dh,0Ah
 41682 000070F0 202020202020537065-
 41682 000070F9 636966696573207468-
 41682 00007102 652066696C65206F72-
 41682 0000710B 2066696C657320746F-
 41682 00007114 20626520636F706965-
 41682 0000711D 642E0D0A           
 41683 00007121 20202F412020202020-     	db '  /A           Indicates an ASCII text file.',0Dh,0Ah
 41683 0000712A 202020202020496E64-
 41683 00007133 69636174657320616E-
 41683 0000713C 204153434949207465-
 41683 00007145 78742066696C652E0D-
 41683 0000714E 0A                 
 41684                                  MSG_1402:
 41685 0000714F 76                      	db 118
 41686 00007150 20202F422020202020-     	db '  /B           Indicates a binary file.',0Dh,0Ah
 41686 00007159 202020202020496E64-
 41686 00007162 696361746573206120-
 41686 0000716B 62696E617279206669-
 41686 00007174 6C652E0D0A         
 41687 00007179 202064657374696E61-     	db '  destination  Specifies the directory and/or filename for the new file(s).',0Dh,0Ah
 41687 00007182 74696F6E2020537065-
 41687 0000718B 636966696573207468-
 41687 00007194 65206469726563746F-
 41687 0000719D 727920616E642F6F72-
 41687 000071A6 2066696C656E616D65-
 41687 000071AF 20666F722074686520-
 41687 000071B8 6E65772066696C6528-
 41687 000071C1 73292E0D0A         
 41688                                  MSG_1403:	
 41689                                  	;db 65  ;  MSDOS 5.0
 41690                                  	; 17/06/2023
 41691 000071C6 3F                      	db 63 ; MSDOS 6.22	
 41692 000071C7 20202F562020202020-     	db '  /V           Verifies that new files are written correctly.',0Dh,0Ah
 41692 000071D0 202020202020566572-
 41692 000071D9 696669657320746861-
 41692 000071E2 74206E65772066696C-
 41692 000071EB 657320617265207772-
 41692 000071F4 697474656E20636F72-
 41692 000071FD 726563746C792E0D0A 
 41693                                  	;db 0Dh,0Ah ; MSDOS 5.0
 41694                                  
 41695                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41696                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7866h
 41697                                  MSG_1404:
 41698 00007206 74                              db 116
 41699 00007207 20202F592020202020-     	db '  /Y           Suppresses prompting to confirm you want to overwrite an',0Dh,0Ah
 41699 00007210 202020202020537570-
 41699 00007219 707265737365732070-
 41699 00007222 726F6D7074696E6720-
 41699 0000722B 746F20636F6E666972-
 41699 00007234 6D20796F752077616E-
 41699 0000723D 7420746F206F766572-
 41699 00007246 777269746520616E0D-
 41699 0000724F 0A                 
 41700 00007250 202020202020202020-     	db '               existing destination file.',0Dh,0Ah
 41700 00007259 202020202020657869-
 41700 00007262 7374696E6720646573-
 41700 0000726B 74696E6174696F6E20-
 41700 00007274 66696C652E0D0A     
 41701                                  MSG_1405:
 41702 0000727B 72                      	db 114
 41703 0000727C 20202F2D5920202020-     	db '  /-Y          Causes prompting to confirm you want to overwrite an',0Dh,0Ah
 41703 00007285 202020202020436175-
 41703 0000728E 7365732070726F6D70-
 41703 00007297 74696E6720746F2063-
 41703 000072A0 6F6E6669726D20796F-
 41703 000072A9 752077616E7420746F-
 41703 000072B2 206F76657277726974-
 41703 000072BB 6520616E0D0A       
 41704 000072C1 202020202020202020-     	db '               existing destination file.',0Dh,0Ah
 41704 000072CA 202020202020657869-
 41704 000072D3 7374696E6720646573-
 41704 000072DC 74696E6174696F6E20-
 41704 000072E5 66696C652E0D0A     
 41705 000072EC 0D0A                    	db 0Dh,0Ah
 41706                                  MSG_1406:
 41707 000072EE 42                      	db 66
 41708 000072EF 546865207377697463-     	db 'The switch /Y may be preset in the COPYCMD environment variable.',0Dh,0Ah
 41708 000072F8 68202F59206D617920-
 41708 00007301 626520707265736574-
 41708 0000730A 20696E207468652043-
 41708 00007313 4F5059434D4420656E-
 41708 0000731C 7669726F6E6D656E74-
 41708 00007325 207661726961626C65-
 41708 0000732E 2E0D0A             
 41709                                  
 41710                                  ;MSG_1404: ; MSDOS 5.0 (TRANGROUP:681Ch)
 41711                                  	   ; MSDOS 6.22	(TRANGROUP:7991h)
 41712                                  MSG_1407:  ; PCDOS 7.1	(TRANGROUP:77EEh)
 41713 00007331 87                      	db 135
 41714 00007332 546F20617070656E64-     	db 'To append files, specify a single file for destination, but multiple files',0Dh,0Ah
 41714 0000733B 2066696C65732C2073-
 41714 00007344 706563696679206120-
 41714 0000734D 73696E676C65206669-
 41714 00007356 6C6520666F72206465-
 41714 0000735F 7374696E6174696F6E-
 41714 00007368 2C20627574206D756C-
 41714 00007371 7469706C652066696C-
 41714 0000737A 65730D0A           
 41715 0000737E 666F7220736F757263-     	db 'for source (using wildcards or file1+file2+file3 format).',0Dh,0Ah
 41715 00007387 6520287573696E6720-
 41715 00007390 77696C646361726473-
 41715 00007399 206F722066696C6531-
 41715 000073A2 2B66696C65322B6669-
 41715 000073AB 6C653320666F726D61-
 41715 000073B4 74292E0D0A         
 41716                                  MSG_1420:
 41717 000073B9 8A                      	db 138
 41718 000073BA 4368616E6765732074-     	db 'Changes the terminal device used to control your system.',0Dh,0Ah
 41718 000073C3 6865207465726D696E-
 41718 000073CC 616C20646576696365-
 41718 000073D5 207573656420746F20-
 41718 000073DE 636F6E74726F6C2079-
 41718 000073E7 6F7572207379737465-
 41718 000073F0 6D2E0D0A           
 41719 000073F4 0D0A                    	db 0Dh,0Ah
 41720 000073F6 435454592064657669-     	db 'CTTY device',0Dh,0Ah
 41720 000073FF 63650D0A           
 41721 00007403 0D0A                    	db 0Dh,0Ah
 41722 00007405 202064657669636520-     	db '  device   The terminal device you want to use, such as COM1.',0Dh,0Ah
 41722 0000740E 202054686520746572-
 41722 00007417 6D696E616C20646576-
 41722 00007420 69636520796F752077-
 41722 00007429 616E7420746F207573-
 41722 00007432 652C20737563682061-
 41722 0000743B 7320434F4D312E0D0A 
 41723                                  MSG_1440:
 41724                                  	;db 45
 41725                                  	;db 'Displays or sets the date.',0Dh,0Ah
 41726                                  	;db 0Dh,0Ah
 41727                                  	;db 'DATE [date]',0Dh,0Ah
 41728                                  	;db 0Dh,0Ah
 41729                                  
 41730                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41731                                  %if 0
 41732                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41733                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:7AA4h)
 41734                                  	db 93
 41735                                  	db 'Displays or sets the date.',0Dh,0Ah
 41736                                  	db 0Dh,0Ah
 41737                                  	db 'DATE [mm-dd-yy]',0Dh,0Ah
 41738                                  	db 0Dh,0Ah
 41739                                  	db '  mm-dd-yy    Sets the date you specify.',0Dh,0Ah
 41740                                  	db 0Dh,0Ah
 41741                                  %else
 41742                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 41743                                  	; (PCDOS 7.1 COMMAND.COM - TRANGROUP:7901h)
 41744 00007444 26                      	db 38
 41745 00007445 446973706C61797320-     	db 'Displays or sets the date.',0Dh,0Ah
 41745 0000744E 6F7220736574732074-
 41745 00007457 686520646174652E0D-
 41745 00007460 0A                 
 41746 00007461 0D0A                    	db 0Dh,0Ah
 41747 00007463 444154450D0A            	db 'DATE',0Dh,0Ah
 41748 00007469 0D0A                    	db 0Dh,0Ah	
 41749                                  %endif
 41750                                  
 41751                                  MSG_1441:
 41752 0000746B 83                      	db 131
 41753 0000746C 547970652044415445-     	db 'Type DATE without parameters to display the current date setting and',0Dh,0Ah
 41753 00007475 20776974686F757420-
 41753 0000747E 706172616D65746572-
 41753 00007487 7320746F2064697370-
 41753 00007490 6C6179207468652063-
 41753 00007499 757272656E74206461-
 41753 000074A2 74652073657474696E-
 41753 000074AB 6720616E640D0A     
 41754 000074B2 612070726F6D707420-     	db 'a prompt for a new one.  Press ENTER to keep the same date.',0Dh,0Ah
 41754 000074BB 666F722061206E6577-
 41754 000074C4 206F6E652E20205072-
 41754 000074CD 65737320454E544552-
 41754 000074D6 20746F206B65657020-
 41754 000074DF 7468652073616D6520-
 41754 000074E8 646174652E0D0A     
 41755                                  MSG_1460:	
 41756 000074EF 64                      	db 100
 41757 000074F0 44656C65746573206F-     	db 'Deletes one or more files.',0Dh,0Ah
 41757 000074F9 6E65206F72206D6F72-
 41757 00007502 652066696C65732E0D-
 41757 0000750B 0A                 
 41758 0000750C 0D0A                    	db 0Dh,0Ah
 41759 0000750E 44454C205B64726976-     	db 'DEL [drive:][path]filename [/P]',0Dh,0Ah
 41759 00007517 653A5D5B706174685D-
 41759 00007520 66696C656E616D6520-
 41759 00007529 5B2F505D0D0A       
 41760 0000752F 4552415345205B6472-     	db 'ERASE [drive:][path]filename [/P]',0Dh,0Ah
 41760 00007538 6976653A5D5B706174-
 41760 00007541 685D66696C656E616D-
 41760 0000754A 65205B2F505D0D0A   
 41761 00007552 0D0A                    	db 0Dh,0Ah
 41762                                  MSG_1461:
 41763 00007554 83                      	db 131
 41764 00007555 20205B64726976653A-     	db '  [drive:][path]filename  Specifies the file(s) to delete.  Specify multiple',0Dh,0Ah
 41764 0000755E 5D5B706174685D6669-
 41764 00007567 6C656E616D65202053-
 41764 00007570 706563696669657320-
 41764 00007579 7468652066696C6528-
 41764 00007582 732920746F2064656C-
 41764 0000758B 6574652E2020537065-
 41764 00007594 63696679206D756C74-
 41764 0000759D 69706C650D0A       
 41765 000075A3 202020202020202020-     	db '                          files by using wildcards.',0Dh,0Ah
 41765 000075AC 202020202020202020-
 41765 000075B5 202020202020202066-
 41765 000075BE 696C65732062792075-
 41765 000075C7 73696E672077696C64-
 41765 000075D0 63617264732E0D0A   
 41766                                  MSG_1462:
 41767 000075D8 4F                      	db 79
 41768 000075D9 20202F502020202020-     	db '  /P                      Prompts for confirmation before deleting each file.',0Dh,0Ah
 41768 000075E2 202020202020202020-
 41768 000075EB 202020202020202050-
 41768 000075F4 726F6D70747320666F-
 41768 000075FD 7220636F6E6669726D-
 41768 00007606 6174696F6E20626566-
 41768 0000760F 6F72652064656C6574-
 41768 00007618 696E67206561636820-
 41768 00007621 66696C652E0D0A     
 41769                                  
 41770                                  ; 17/06/2023
 41771                                  %if 0	; MSDOS 5.0 DIR Help messages
 41772                                  
 41773                                  MSG_1480:
 41774                                  	db 162
 41775                                  	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 41776                                  	db 0Dh,0Ah
 41777                                  	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attributes]]',0Dh,0Ah
 41778                                  	db '  [/O[[:]sortorder]] [/S] [/B] [/L]',0Dh,0Ah
 41779                                  	db 0Dh,0Ah
 41780                                  MSG_1481:
 41781                                  	db 93
 41782                                  	db '  [drive:][path][filename]',0Dh,0Ah
 41783                                  	db '              Specifies drive, directory, and/or files to list.',0Dh,0Ah
 41784                                  MSG_1482:
 41785                                  	db 97
 41786                                  	db '  /P          Pauses after each screenful of information.',0Dh,0Ah
 41787                                  	db '  /W          Uses wide list format.',0Dh,0Ah
 41788                                  MSG_1483:	
 41789                                  	db 122
 41790                                  	db '  /A          Displays files with specified attributes.',0Dh,0Ah
 41791                                  	db '  attributes   D  Directories                R  Read-only files',0Dh,0Ah
 41792                                  MSG_1484:
 41793                                  	db 191
 41794                                  	db '               H  Hidden files               A  Files ready for archiving',0Dh,0Ah
 41795                                  	db '               S  System files               -  Prefix meaning "not"',0Dh,0Ah
 41796                                  	db '  /O          List by files in sorted order.',0Dh,0Ah
 41797                                  MSG_1485:
 41798                                  	db 155
 41799                                  	db '  sortorder    N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 41800                                  	db '               E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 41801                                  MSG_1486:
 41802                                  	db 150
 41803                                  	db '               G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 41804                                  	db '  /S          Displays files in specified directory and all subdirectories.',0Dh,0Ah
 41805                                  MSG_1487:
 41806                                  	db 102
 41807                                  	db '  /B          Uses bare format (no heading information or summary).',0Dh,0Ah
 41808                                  	db '  /L          Uses lowercase.',0Dh,0Ah
 41809                                  	db 0Dh,0Ah
 41810                                  MSG_1488:
 41811                                  	db 146
 41812                                  	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 41813                                  	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 41814                                  %endif
 41815                                  
 41816                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 41817                                  %if 0
 41818                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 41819                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:7CBFh
 41820                                  MSG_1480:
 41821                                  	db 137
 41822                                  	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 41823                                  	db 0Dh,0Ah
 41824                                  	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attribs]] [/O[[:]sortord]]',0Dh,0Ah
 41825                                  MSG_1481:
 41826                                  	db 30
 41827                                  	db '    [/S] [/B] [/L] [/C[H]]',0Dh,0Ah
 41828                                  	db 0Dh,0Ah
 41829                                  MSG_1482:
 41830                                  	db 80
 41831                                  	db '  [drive:][path][filename]   Specifies drive, directory, and/or files to list.',0Dh,0Ah
 41832                                  MSG_1483:
 41833                                  	db 89
 41834                                  	db '  /P      Pauses after each screenful of information.',0Dh,0Ah
 41835                                  	db '  /W      Uses wide list format.',0Dh,0Ah
 41836                                  MSG_1484:
 41837                                  	db 126
 41838                                  	db '  /A      Displays files with specified attributes.',0Dh,0Ah
 41839                                  	db '  attribs   D  Directories   R  Read-only files         H  Hidden files',0Dh,0Ah
 41840                                  MSG_1485:
 41841                                  	db 123
 41842                                  	db '            S  System files  A  Files ready to archive  -  Prefix meaning "not"',0Dh,0Ah
 41843                                  	db '  /O      List by files in sorted order.',0Dh,0Ah
 41844                                  MSG_1486:
 41845                                  	db 149
 41846                                  	db '  sortord   N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 41847                                  	db '            E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 41848                                  MSG_1487:
 41849                                  	db 70
 41850                                  	db '            G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 41851                                  MSG_1488:
 41852                                  	db 127
 41853                                  	db '            C  By compression ratio (smallest first)',0Dh,0Ah
 41854                                  	db '  /S      Displays files in specified directory and all subdirectories.',0Dh,0Ah
 41855                                  MSG_1489:
 41856                                  	db 65
 41857                                  	db '  /B      Uses bare format (no heading information or summary).',0Dh,0Ah
 41858                                  
 41859                                  MSG_1490:
 41860                                  	db 27
 41861                                  	db '  /L      Uses lowercase.',0Dh,0Ah
 41862                                  MSG_1491:
 41863                                  	db 82
 41864                                  	db '  /C[H]   Displays file compression ratio; /CH uses host allocation unit size.',0Dh,0Ah
 41865                                  	db 0Dh,0Ah
 41866                                  MSG_1492:
 41867                                  	db 146
 41868                                  	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 41869                                  	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 41870                                  MSG_1493:
 41871                                  	db 22
 41872                                  	db '    [/S] [/B] [/L]',0Dh,0Ah
 41873                                  	db 0Dh,0Ah
 41874                                  MSG_1494:
 41875                                  	db 29
 41876                                  	db '  /L      Uses lowercase.',0Dh,0Ah
 41877                                  	db 0Dh,0Ah
 41878                                  %else
 41879                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 41880                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:7AE5h
 41881                                  MSG_1480:
 41882 00007628 9F                      	db 159
 41883 00007629 446973706C61797320-     	db 'Displays a list of files and subdirectories in a directory.',0Dh,0Ah
 41883 00007632 61206C697374206F66-
 41883 0000763B 2066696C657320616E-
 41883 00007644 642073756264697265-
 41883 0000764D 63746F726965732069-
 41883 00007656 6E2061206469726563-
 41883 0000765F 746F72792E0D0A     
 41884 00007666 0D0A                    	db 0Dh,0Ah
 41885 00007668 444952205B64726976-     	db 'DIR [drive:][path][filename] [/P] [/W] [/A[[:]attribs]] [/O[[:]sortord]]',0Dh,0Ah
 41885 00007671 653A5D5B706174685D-
 41885 0000767A 5B66696C656E616D65-
 41885 00007683 5D205B2F505D205B2F-
 41885 0000768C 575D205B2F415B5B3A-
 41885 00007695 5D617474726962735D-
 41885 0000769E 5D205B2F4F5B5B3A5D-
 41885 000076A7 736F72746F72645D5D-
 41885 000076B0 0D0A               
 41886 000076B2 202020205B2F535D20-     	db '    [/S] [/B] [/L]',0Dh,0Ah
 41886 000076BB 5B2F425D205B2F4C5D-
 41886 000076C4 0D0A               
 41887 000076C6 0D0A                    	db 0Dh,0Ah
 41888                                  MSG_1481:
 41889 000076C8 4D                      	db 77
 41890 000076C9 20205B64726976653A-     	db '  [drive:][path][filename]   Specifies drive, directory, and files to list.',0Dh,0Ah
 41890 000076D2 5D5B706174685D5B66-
 41890 000076DB 696C656E616D655D20-
 41890 000076E4 202053706563696669-
 41890 000076ED 65732064726976652C-
 41890 000076F6 206469726563746F72-
 41890 000076FF 792C20616E64206669-
 41890 00007708 6C657320746F206C69-
 41890 00007711 73742E0D0A         
 41891                                  MSG_1482:
 41892 00007716 5B                      	db 91
 41893 00007717 20202F502020202020-     	db '  /P      Pauses after each screenful of information.',0Dh,0Ah
 41893 00007720 205061757365732061-
 41893 00007729 667465722065616368-
 41893 00007732 2073637265656E6675-
 41893 0000773B 6C206F6620696E666F-
 41893 00007744 726D6174696F6E2E0D-
 41893 0000774D 0A                 
 41894 0000774E 20202F572020202020-     	db '  /W      Uses wide list format.',0Dh,0Ah
 41894 00007757 205573657320776964-
 41894 00007760 65206C69737420666F-
 41894 00007769 726D61742E0D0A     
 41895                                  MSG_1483:
 41896 00007770 7E                      	db 126
 41897 00007771 20202F412020202020-     	db '  /A      Displays files with specified attributes.',0Dh,0Ah
 41897 0000777A 20446973706C617973-
 41897 00007783 2066696C6573207769-
 41897 0000778C 746820737065636966-
 41897 00007795 696564206174747269-
 41897 0000779E 62757465732E0D0A   
 41898 000077A6 202061747472696273-     	db '  attribs   D  Directories   R  Read-only files         H  Hidden files',0Dh,0Ah
 41898 000077AF 202020442020446972-
 41898 000077B8 6563746F7269657320-
 41898 000077C1 202052202052656164-
 41898 000077CA 2D6F6E6C792066696C-
 41898 000077D3 657320202020202020-
 41898 000077DC 202048202048696464-
 41898 000077E5 656E2066696C65730D-
 41898 000077EE 0A                 
 41899                                  MSG_1484:
 41900 000077EF 7C                      	db 124
 41901 000077F0 202020202020202020-     	db '            S  System files  A  Files ready to archive  -  Prefix meaning "not"',0Dh,0Ah
 41901 000077F9 202020532020537973-
 41901 00007802 74656D2066696C6573-
 41901 0000780B 202041202046696C65-
 41901 00007814 732072656164792074-
 41901 0000781D 6F2061726368697665-
 41901 00007826 20202D202050726566-
 41901 0000782F 6978206D65616E696E-
 41901 00007838 6720226E6F74220D0A 
 41902 00007841 20202F4F2020202020-     	db '  /O      Lists by files in sorted order.',0Dh,0Ah
 41902 0000784A 204C69737473206279-
 41902 00007853 2066696C657320696E-
 41902 0000785C 20736F72746564206F-
 41902 00007865 726465722E0D0A     
 41903                                  MSG_1485:
 41904 0000786C 95                      	db 149
 41905 0000786D 2020736F72746F7264-     	db '  sortord   N  By name (alphabetic)       S  By size (smallest first)',0Dh,0Ah
 41905 00007876 2020204E2020427920-
 41905 0000787F 6E616D652028616C70-
 41905 00007888 686162657469632920-
 41905 00007891 202020202020532020-
 41905 0000789A 42792073697A652028-
 41905 000078A3 736D616C6C65737420-
 41905 000078AC 6669727374290D0A   
 41906 000078B4 202020202020202020-     	db '            E  By extension (alphabetic)  D  By date & time (earliest first)',0Dh,0Ah
 41906 000078BD 202020452020427920-
 41906 000078C6 657874656E73696F6E-
 41906 000078CF 2028616C7068616265-
 41906 000078D8 746963292020442020-
 41906 000078E1 427920646174652026-
 41906 000078EA 2074696D6520286561-
 41906 000078F3 726C69657374206669-
 41906 000078FC 727374290D0A       
 41907                                  MSG_1486:
 41908 00007902 8F                      	db 143
 41909 00007903 202020202020202020-     	db '            G  Group directories first    -  Prefix to reverse order',0Dh,0Ah
 41909 0000790C 20202047202047726F-
 41909 00007915 757020646972656374-
 41909 0000791E 6F7269657320666972-
 41909 00007927 7374202020202D2020-
 41909 00007930 50726566697820746F-
 41909 00007939 207265766572736520-
 41909 00007942 6F726465720D0A     
 41910 00007949 20202F532020202020-     	db '  /S      Displays files in specified directory and all subdirectories.',0Dh,0Ah
 41910 00007952 20446973706C617973-
 41910 0000795B 2066696C657320696E-
 41910 00007964 207370656369666965-
 41910 0000796D 64206469726563746F-
 41910 00007976 727920616E6420616C-
 41910 0000797F 6C2073756264697265-
 41910 00007988 63746F726965732E0D-
 41910 00007991 0A                 
 41911                                  MSG_1487:
 41912 00007992 5E                      	db 94
 41913 00007993 20202F422020202020-     	db '  /B      Uses bare format (no heading information or summary).',0Dh,0Ah
 41913 0000799C 205573657320626172-
 41913 000079A5 6520666F726D617420-
 41913 000079AE 286E6F206865616469-
 41913 000079B7 6E6720696E666F726D-
 41913 000079C0 6174696F6E206F7220-
 41913 000079C9 73756D6D617279292E-
 41913 000079D2 0D0A               
 41914 000079D4 20202F4C2020202020-     	db '  /L      Uses lowercase.',0Dh,0Ah
 41914 000079DD 2055736573206C6F77-
 41914 000079E6 6572636173652E0D0A 
 41915 000079EF 0D0A                    	db 0Dh,0Ah
 41916                                  MSG_1488:
 41917 000079F1 92                      	db 146
 41918 000079F2 537769746368657320-     	db 'Switches may be preset in the DIRCMD environment variable.  Override',0Dh,0Ah
 41918 000079FB 6D6179206265207072-
 41918 00007A04 6573657420696E2074-
 41918 00007A0D 686520444952434D44-
 41918 00007A16 20656E7669726F6E6D-
 41918 00007A1F 656E74207661726961-
 41918 00007A28 626C652E20204F7665-
 41918 00007A31 72726964650D0A     
 41919 00007A38 707265736574207377-     	db 'preset switches by prefixing any switch with - (hyphen)--for example, /-W.',0Dh,0Ah
 41919 00007A41 697463686573206279-
 41919 00007A4A 20707265666978696E-
 41919 00007A53 6720616E7920737769-
 41919 00007A5C 746368207769746820-
 41919 00007A65 2D202868797068656E-
 41919 00007A6E 292D2D666F72206578-
 41919 00007A77 616D706C652C202F2D-
 41919 00007A80 572E0D0A           
 41920                                  MSG_1489:
 41921 00007A84 50                      	db 80
 41922 00007A85 546F2072656D6F7665-     	db 'To remove the commas from the DIR output, use the NO_SEP environment variable.',0Dh,0Ah
 41922 00007A8E 2074686520636F6D6D-
 41922 00007A97 61732066726F6D2074-
 41922 00007AA0 686520444952206F75-
 41922 00007AA9 747075742C20757365-
 41922 00007AB2 20746865204E4F5F53-
 41922 00007ABB 455020656E7669726F-
 41922 00007AC4 6E6D656E7420766172-
 41922 00007ACD 6961626C652E0D0A   
 41923                                  %endif
 41924                                  
 41925                                  MSG_1500:
 41926 00007AD5 3E                      	db 62
 41927 00007AD6 517569747320746865-     	db 'Quits the COMMAND.COM program (command interpreter).',0Dh,0Ah
 41927 00007ADF 20434F4D4D414E442E-
 41927 00007AE8 434F4D2070726F6772-
 41927 00007AF1 616D2028636F6D6D61-
 41927 00007AFA 6E6420696E74657270-
 41927 00007B03 7265746572292E0D0A 
 41928 00007B0C 0D0A                    	db 0Dh,0Ah
 41929 00007B0E 455849540D0A            	db 'EXIT',0Dh,0Ah
 41930                                  MSG_1520:
 41931 00007B14 3D                      	db 61
 41932 00007B15 437265617465732061-     	db 'Creates a directory.',0Dh,0Ah
 41932 00007B1E 206469726563746F72-
 41932 00007B27 792E0D0A           
 41933 00007B2B 0D0A                    	db 0Dh,0Ah
 41934 00007B2D 4D4B444952205B6472-     	db 'MKDIR [drive:]path',0Dh,0Ah
 41934 00007B36 6976653A5D70617468-
 41934 00007B3F 0D0A               
 41935 00007B41 4D44205B6472697665-     	db 'MD [drive:]path',0Dh,0Ah
 41935 00007B4A 3A5D706174680D0A   
 41936                                  MSG_1540:
 41937 00007B52 5D                      	db 93
 41938 00007B53 446973706C61797320-     	db 'Displays or sets a search path for executable files.',0Dh,0Ah
 41938 00007B5C 6F7220736574732061-
 41938 00007B65 207365617263682070-
 41938 00007B6E 61746820666F722065-
 41938 00007B77 786563757461626C65-
 41938 00007B80 2066696C65732E0D0A 
 41939 00007B89 0D0A                    	db 0Dh,0Ah
 41940 00007B8B 50415448205B5B6472-     	db 'PATH [[drive:]path[;...]]',0Dh,0Ah
 41940 00007B94 6976653A5D70617468-
 41940 00007B9D 5B3B2E2E2E5D5D0D0A 
 41941 00007BA6 50415448203B0D0A        	db 'PATH ;',0Dh,0Ah
 41942 00007BAE 0D0A                    	db 0Dh,0Ah
 41943                                  MSG_1541:
 41944 00007BB0 6B                      	db 107
 41945 00007BB1 547970652050415448-     	db 'Type PATH ; to clear all search-path settings and direct PC DOS to search',0Dh,0Ah
 41945 00007BBA 203B20746F20636C65-
 41945 00007BC3 617220616C6C207365-
 41945 00007BCC 617263682D70617468-
 41945 00007BD5 2073657474696E6773-
 41945 00007BDE 20616E642064697265-
 41945 00007BE7 637420504320444F53-
 41945 00007BF0 20746F207365617263-
 41945 00007BF9 680D0A             
 41946 00007BFC 6F6E6C7920696E2074-     	db 'only in the current directory.',0Dh,0Ah
 41946 00007C05 68652063757272656E-
 41946 00007C0E 74206469726563746F-
 41946 00007C17 72792E0D0A         
 41947                                  MSG_1542:
 41948 00007C1C 3B                      	db 59
 41949 00007C1D 547970652050415448-     	db 'Type PATH without parameters to display the current path.',0Dh,0Ah
 41949 00007C26 20776974686F757420-
 41949 00007C2F 706172616D65746572-
 41949 00007C38 7320746F2064697370-
 41949 00007C41 6C6179207468652063-
 41949 00007C4A 757272656E74207061-
 41949 00007C53 74682E0D0A         
 41950                                  MSG_1560:
 41951 00007C58 37                      	db 55
 41952 00007C59 4368616E6765732074-     	db 'Changes the PC DOS command prompt.',0Dh,0Ah
 41952 00007C62 686520504320444F53-
 41952 00007C6B 20636F6D6D616E6420-
 41952 00007C74 70726F6D70742E0D0A 
 41953 00007C7D 0D0A                    	db 0Dh,0Ah
 41954 00007C7F 50524F4D5054205B74-     	db 'PROMPT [text]',0Dh,0Ah
 41954 00007C88 6578745D0D0A       
 41955 00007C8E 0D0A                    	db 0Dh,0Ah
 41956                                  MSG_1561:
 41957 00007C90 7C                      	db 124
 41958 00007C91 202074657874202020-     	db '  text    Specifies a new command prompt.',0Dh,0Ah
 41958 00007C9A 205370656369666965-
 41958 00007CA3 732061206E65772063-
 41958 00007CAC 6F6D6D616E64207072-
 41958 00007CB5 6F6D70742E0D0A     
 41959 00007CBC 0D0A                    	db 0Dh,0Ah
 41960 00007CBE 50726F6D7074206361-     	db 'Prompt can be made up of normal characters and the following special codes:',0Dh,0Ah
 41960 00007CC7 6E206265206D616465-
 41960 00007CD0 207570206F66206E6F-
 41960 00007CD9 726D616C2063686172-
 41960 00007CE2 61637465727320616E-
 41960 00007CEB 642074686520666F6C-
 41960 00007CF4 6C6F77696E67207370-
 41960 00007CFD 656369616C20636F64-
 41960 00007D06 65733A0D0A         
 41961 00007D0B 0D0A                    	db 0Dh,0Ah
 41962                                  MSG_1562:
 41963 00007D0D 2F                      	db 47
 41964 00007D0E 202024512020203D20-     	db '  $Q   = (equal sign)',0Dh,0Ah
 41964 00007D17 28657175616C207369-
 41964 00007D20 676E290D0A         
 41965 00007D25 202024242020202420-     	db '  $$   $ (dollar sign)',0Dh,0Ah
 41965 00007D2E 28646F6C6C61722073-
 41965 00007D37 69676E290D0A       
 41966                                  MSG_1563:
 41967 00007D3D 2A                      	db 42
 41968 00007D3E 202024542020204375-     	db '  $T   Current time',0Dh,0Ah
 41968 00007D47 7272656E742074696D-
 41968 00007D50 650D0A             
 41969 00007D53 202024442020204375-     	db '  $D   Current date',0Dh,0Ah
 41969 00007D5C 7272656E7420646174-
 41969 00007D65 650D0A             
 41970                                  MSG_1564:
 41971 00007D68 3D                      	db 61
 41972 00007D69 202024502020204375-     	db '  $P   Current drive and path',0Dh,0Ah
 41972 00007D72 7272656E7420647269-
 41972 00007D7B 766520616E64207061-
 41972 00007D84 74680D0A           
 41973 00007D88 202024562020204D53-     	db '  $V   MS-DOS version number',0Dh,0Ah
 41973 00007D91 2D444F532076657273-
 41973 00007D9A 696F6E206E756D6265-
 41973 00007DA3 720D0A             
 41974                                  MSG_1565:
 41975 00007DA6 34                      	db 52
 41976 00007DA7 2020244E2020204375-     	db '  $N   Current drive',0Dh,0Ah
 41976 00007DB0 7272656E7420647269-
 41976 00007DB9 76650D0A           
 41977 00007DBD 202024472020203E20-     	db '  $G   > (greater-than sign)',0Dh,0Ah
 41977 00007DC6 28677265617465722D-
 41977 00007DCF 7468616E207369676E-
 41977 00007DD8 290D0A             
 41978                                  MSG_1566:
 41979 00007DDB 2C                      	db 44
 41980 00007DDC 2020244C2020203C20-     	db '  $L   < (less-than sign)',0Dh,0Ah
 41980 00007DE5 286C6573732D746861-
 41980 00007DEE 6E207369676E290D0A 
 41981 00007DF7 202024422020207C20-     	db '  $B   | (pipe)',0Dh,0Ah
 41981 00007E00 2870697065290D0A   
 41982                                  MSG_1567:
 41983 00007E08 79                      	db 121
 41984 00007E09 202024482020204261-     	db '  $H   Backspace (erases previous character)',0Dh,0Ah
 41984 00007E12 636B73706163652028-
 41984 00007E1B 657261736573207072-
 41984 00007E24 6576696F7573206368-
 41984 00007E2D 61726163746572290D-
 41984 00007E36 0A                 
 41985 00007E37 202024452020204573-     	db '  $E   Escape code (ASCII code 27)',0Dh,0Ah
 41985 00007E40 6361706520636F6465-
 41985 00007E49 202841534349492063-
 41985 00007E52 6F6465203237290D0A 
 41986 00007E5B 2020245F2020204361-     	db '  $_   Carriage return and linefeed',0Dh,0Ah
 41986 00007E64 727269616765207265-
 41986 00007E6D 7475726E20616E6420-
 41986 00007E76 6C696E65666565640D-
 41986 00007E7F 0A                 
 41987 00007E80 0D0A                    	db 0Dh,0Ah
 41988                                  MSG_1568:
 41989 00007E82 4C                      	db 76
 41990 00007E83 547970652050524F4D-     	db 'Type PROMPT without parameters to reset the prompt to the default setting.',0Dh,0Ah
 41990 00007E8C 505420776974686F75-
 41990 00007E95 7420706172616D6574-
 41990 00007E9E 65727320746F207265-
 41990 00007EA7 736574207468652070-
 41990 00007EB0 726F6D707420746F20-
 41990 00007EB9 746865206465666175-
 41990 00007EC2 6C742073657474696E-
 41990 00007ECB 672E0D0A           
 41991                                  MSG_1580:
 41992 00007ECF 47                      	db 71
 41993 00007ED0 52656D6F7665732028-     	db 'Removes (deletes) a directory.',0Dh,0Ah
 41993 00007ED9 64656C657465732920-
 41993 00007EE2 61206469726563746F-
 41993 00007EEB 72792E0D0A         
 41994 00007EF0 0D0A                    	db 0Dh,0Ah
 41995 00007EF2 524D444952205B6472-     	db 'RMDIR [drive:]path',0Dh,0Ah
 41995 00007EFB 6976653A5D70617468-
 41995 00007F04 0D0A               
 41996 00007F06 5244205B6472697665-     	db 'RD [drive:]path',0Dh,0Ah
 41996 00007F0F 3A5D706174680D0A   
 41997                                  MSG_1600:
 41998 00007F17 1C                      	db 28
 41999 00007F18 52656E616D65732061-     	db 'Renames a file or files.',0Dh,0Ah
 41999 00007F21 2066696C65206F7220-
 41999 00007F2A 66696C65732E0D0A   
 42000 00007F32 0D0A                    	db 0Dh,0Ah
 42001                                  MSG_1601:
 42002 00007F34 53                      	db 83
 42003 00007F35 52454E414D45205B64-     	db 'RENAME [drive:][path]filename1 filename2',0Dh,0Ah
 42003 00007F3E 726976653A5D5B7061-
 42003 00007F47 74685D66696C656E61-
 42003 00007F50 6D65312066696C656E-
 42003 00007F59 616D65320D0A       
 42004 00007F5F 52454E205B64726976-     	db 'REN [drive:][path]filename1 filename2',0Dh,0Ah
 42004 00007F68 653A5D5B706174685D-
 42004 00007F71 66696C656E616D6531-
 42004 00007F7A 2066696C656E616D65-
 42004 00007F83 320D0A             
 42005 00007F86 0D0A                    	db 0Dh,0Ah
 42006                                  MSG_1602:
 42007                                  	;db 77
 42008                                  	;db 'Note that you cannot specify a new drive or path for your destination file.',0Dh,0Ah
 42009                                  
 42010                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42011                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:8697h
 42012                                  
 42013                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42014                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:8447h
 42015                                  MSG_1602:
 42016 00007F88 A0                      	db 160
 42017 00007F89 4E6F74652074686174-     	db 'Note that you cannot specify a new drive or path for your destination file.',0Dh,0Ah
 42017 00007F92 20796F752063616E6E-
 42017 00007F9B 6F7420737065636966-
 42017 00007FA4 792061206E65772064-
 42017 00007FAD 72697665206F722070-
 42017 00007FB6 61746820666F722079-
 42017 00007FBF 6F7572206465737469-
 42017 00007FC8 6E6174696F6E206669-
 42017 00007FD1 6C652E0D0A         
 42018 00007FD6 0D0A                    	db 0Dh,0Ah
 42019 00007FD8 557365204D4F564520-     	db 'Use MOVE to rename a directory, or to move files from one directory to another.',0Dh,0Ah
 42019 00007FE1 746F2072656E616D65-
 42019 00007FEA 206120646972656374-
 42019 00007FF3 6F72792C206F722074-
 42019 00007FFC 6F206D6F7665206669-
 42019 00008005 6C65732066726F6D20-
 42019 0000800E 6F6E65206469726563-
 42019 00008017 746F727920746F2061-
 42019 00008020 6E6F746865722E0D0A 
 42020                                  MSG_1620:
 42021 00008029 57                      	db 87
 42022                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42023                                  %if 0
 42024                                  	db 'Displays, sets, or removes MS-DOS environment variables.',0Dh,0Ah
 42025                                  %else
 42026 0000802A 446973706C6179732C-     	db 'Displays, sets, or removes PC DOS environment variables.',0Dh,0Ah
 42026 00008033 20736574732C206F72-
 42026 0000803C 2072656D6F76657320-
 42026 00008045 504320444F5320656E-
 42026 0000804E 7669726F6E6D656E74-
 42026 00008057 207661726961626C65-
 42026 00008060 732E0D0A           
 42027                                  %endif
 42028 00008064 0D0A                    	db 0Dh,0Ah
 42029 00008066 534554205B76617269-     	db 'SET [variable=[string]]',0Dh,0Ah
 42029 0000806F 61626C653D5B737472-
 42029 00008078 696E675D5D0D0A     
 42030 0000807F 0D0A                    	db 0Dh,0Ah
 42031                                  MSG_1621:
 42032 00008081 81                      	db 129
 42033 00008082 20207661726961626C-     	db '  variable  Specifies the environment-variable name.',0Dh,0Ah
 42033 0000808B 652020537065636966-
 42033 00008094 696573207468652065-
 42033 0000809D 6E7669726F6E6D656E-
 42033 000080A6 742D7661726961626C-
 42033 000080AF 65206E616D652E0D0A 
 42034 000080B8 2020737472696E6720-     	db '  string    Specifies a series of characters to assign to the variable.',0Dh,0Ah
 42034 000080C1 202020537065636966-
 42034 000080CA 696573206120736572-
 42034 000080D3 696573206F66206368-
 42034 000080DC 617261637465727320-
 42034 000080E5 746F2061737369676E-
 42034 000080EE 20746F207468652076-
 42034 000080F7 61726961626C652E0D-
 42034 00008100 0A                 
 42035 00008101 0D0A                    	db 0Dh,0Ah
 42036                                  MSG_1622:
 42037 00008103 4B                      	db 75
 42038 00008104 547970652053455420-     	db 'Type SET without parameters to display the current environment variables.',0Dh,0Ah
 42038 0000810D 776974686F75742070-
 42038 00008116 6172616D6574657273-
 42038 0000811F 20746F20646973706C-
 42038 00008128 617920746865206375-
 42038 00008131 7272656E7420656E76-
 42038 0000813A 69726F6E6D656E7420-
 42038 00008143 7661726961626C6573-
 42038 0000814C 2E0D0A             
 42039                                  MSG_1640:
 42040                                  	;db 52
 42041                                  	;db 'Displays or sets the system time.',0Dh,0Ah
 42042                                  	;db 0Dh,0Ah
 42043                                  	;db 'TIME [time]',0Dh,0Ah
 42044                                  	;db 0Dh,0Ah
 42045                                  
 42046                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42047                                  %if 0
 42048                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42049                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:885Eh)
 42050                                  	db 45
 42051                                  	db 'Displays or sets the time.',0Dh,0Ah
 42052                                  	db 0Dh,0Ah
 42053                                  	db 'TIME [time]',0Dh,0Ah
 42054                                  	db 0Dh,0Ah
 42055                                  %else
 42056                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42057                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:860Eh
 42058 0000814F 34                      	db 52
 42059 00008150 446973706C61797320-     	db 'Displays or sets the system time.',0Dh,0Ah
 42059 00008159 6F7220736574732074-
 42059 00008162 68652073797374656D-
 42059 0000816B 2074696D652E0D0A   
 42060 00008173 0D0A                    	db 0Dh,0Ah
 42061 00008175 54494D45205B74696D-     	db 'TIME [time]',0Dh,0Ah
 42061 0000817E 655D0D0A           
 42062 00008182 0D0A                    	db 0Dh,0Ah
 42063                                  %endif
 42064                                  
 42065                                  MSG_1641:
 42066 00008184 83                      	db 131
 42067 00008185 547970652054494D45-     	db 'Type TIME with no parameters to display the current time setting and a prompt',0Dh,0Ah
 42067 0000818E 2077697468206E6F20-
 42067 00008197 706172616D65746572-
 42067 000081A0 7320746F2064697370-
 42067 000081A9 6C6179207468652063-
 42067 000081B2 757272656E74207469-
 42067 000081BB 6D652073657474696E-
 42067 000081C4 6720616E6420612070-
 42067 000081CD 726F6D70740D0A     
 42068 000081D4 666F722061206E6577-     	db 'for a new one.  Press ENTER to keep the same time.',0Dh,0Ah
 42068 000081DD 206F6E652E20205072-
 42068 000081E6 65737320454E544552-
 42068 000081EF 20746F206B65657020-
 42068 000081F8 7468652073616D6520-
 42068 00008201 74696D652E0D0A     
 42069                                  MSG_1660:
 42070 00008208 46                      	db 70
 42071 00008209 446973706C61797320-     	db 'Displays the contents of a text file.',0Dh,0Ah
 42071 00008212 74686520636F6E7465-
 42071 0000821B 6E7473206F66206120-
 42071 00008224 746578742066696C65-
 42071 0000822D 2E0D0A             
 42072 00008230 0D0A                    	db 0Dh,0Ah
 42073 00008232 54595045205B647269-     	db 'TYPE [drive:][path]filename',0Dh,0Ah
 42073 0000823B 76653A5D5B70617468-
 42073 00008244 5D66696C656E616D65-
 42073 0000824D 0D0A               
 42074                                  MSG_1680:
 42075 0000824F 25                      	db 37
 42076                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42077                                  %if 0
 42078                                  	db 'Displays the MS-DOS version.',0Dh,0Ah
 42079                                  %else
 42080 00008250 446973706C61797320-     	db 'Displays the PC DOS version.',0Dh,0Ah
 42080 00008259 74686520504320444F-
 42080 00008262 532076657273696F6E-
 42080 0000826B 2E0D0A             
 42081                                  %endif
 42082 0000826E 0D0A                    	db 0Dh,0Ah
 42083 00008270 5645520D0A              	db 'VER',0Dh,0Ah
 42084                                  MSG_1700:
 42085 00008275 B1                      	db 177
 42086                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42087                                  %if 0
 42088                                  	db 'Tells MS-DOS whether to verify that your files are written correctly to a',0Dh,0Ah
 42089                                  	db 'disk.',0Dh,0Ah
 42090                                  %else
 42091 00008276 54656C6C7320504320-     	db 'Tells PC DOS whether to verify that your files are written correctly to a',0Dh,0Ah
 42091 0000827F 444F53207768657468-
 42091 00008288 657220746F20766572-
 42091 00008291 696679207468617420-
 42091 0000829A 796F75722066696C65-
 42091 000082A3 732061726520777269-
 42091 000082AC 7474656E20636F7272-
 42091 000082B5 6563746C7920746F20-
 42091 000082BE 610D0A             
 42092 000082C1 6469736B2E0D0A          	db 'disk.',0Dh,0Ah
 42093                                  %endif
 42094 000082C8 0D0A                    	db 0Dh,0Ah
 42095 000082CA 564552494659205B4F-     	db 'VERIFY [ON | OFF]',0Dh,0Ah
 42095 000082D3 4E207C204F46465D0D-
 42095 000082DC 0A                 
 42096 000082DD 0D0A                    	db 0Dh,0Ah
 42097 000082DF 547970652056455249-     	db 'Type VERIFY without a parameter to display the current VERIFY setting.',0Dh,0Ah
 42097 000082E8 465920776974686F75-
 42097 000082F1 74206120706172616D-
 42097 000082FA 6574657220746F2064-
 42097 00008303 6973706C6179207468-
 42097 0000830C 652063757272656E74-
 42097 00008315 205645524946592073-
 42097 0000831E 657474696E672E0D0A 
 42098                                  MSG_1720:
 42099 00008327 52                      	db 82
 42100 00008328 446973706C61797320-     	db 'Displays the disk volume label and serial number, if they exist.',0Dh,0Ah
 42100 00008331 746865206469736B20-
 42100 0000833A 766F6C756D65206C61-
 42100 00008343 62656C20616E642073-
 42100 0000834C 657269616C206E756D-
 42100 00008355 6265722C2069662074-
 42100 0000835E 686579206578697374-
 42100 00008367 2E0D0A             
 42101 0000836A 0D0A                    	db 0Dh,0Ah
 42102 0000836C 564F4C205B64726976-     	db 'VOL [drive:]',0Dh,0Ah
 42102 00008375 653A5D0D0A         
 42103                                  MSG_1740:
 42104 0000837A 5B                      	db 91
 42105 0000837B 43616C6C73206F6E65-     	db 'Calls one batch program from another.',0Dh,0Ah
 42105 00008384 206261746368207072-
 42105 0000838D 6F6772616D2066726F-
 42105 00008396 6D20616E6F74686572-
 42105 0000839F 2E0D0A             
 42106 000083A2 0D0A                    	db 0Dh,0Ah
 42107 000083A4 43414C4C205B647269-     	db 'CALL [drive:][path]filename [batch-parameters]',0Dh,0Ah
 42107 000083AD 76653A5D5B70617468-
 42107 000083B6 5D66696C656E616D65-
 42107 000083BF 205B62617463682D70-
 42107 000083C8 6172616D6574657273-
 42107 000083D1 5D0D0A             
 42108 000083D4 0D0A                    	db 0Dh,0Ah
 42109                                  MSG_1741:
 42110 000083D6 72                      	db 114
 42111 000083D7 202062617463682D70-     	db '  batch-parameters   Specifies any command-line information required by the',0Dh,0Ah
 42111 000083E0 6172616D6574657273-
 42111 000083E9 202020537065636966-
 42111 000083F2 69657320616E792063-
 42111 000083FB 6F6D6D616E642D6C69-
 42111 00008404 6E6520696E666F726D-
 42111 0000840D 6174696F6E20726571-
 42111 00008416 756972656420627920-
 42111 0000841F 7468650D0A         
 42112 00008424 202020202020202020-     	db '                     batch program.',0Dh,0Ah
 42112 0000842D 202020202020202020-
 42112 00008436 202020626174636820-
 42112 0000843F 70726F6772616D2E0D-
 42112 00008448 0A                 
 42113                                  MSG_1760:
 42114 00008449 4C                      	db 76
 42115 0000844A 5265636F7264732063-     	db 'Records comments (remarks) in a batch file or CONFIG.SYS.',0Dh,0Ah
 42115 00008453 6F6D6D656E74732028-
 42115 0000845C 72656D61726B732920-
 42115 00008465 696E20612062617463-
 42115 0000846E 682066696C65206F72-
 42115 00008477 20434F4E4649472E53-
 42115 00008480 59532E0D0A         
 42116 00008485 0D0A                    	db 0Dh,0Ah
 42117 00008487 52454D205B636F6D6D-     	db 'REM [comment]',0Dh,0Ah
 42117 00008490 656E745D0D0A       
 42118                                  MSG_1780:
 42119 00008496 6B                      	db 107
 42120 00008497 53757370656E647320-     	db 'Suspends processing of a batch program and displays the message "'
 42120 000084A0 70726F63657373696E-
 42120 000084A9 67206F662061206261-
 42120 000084B2 7463682070726F6772-
 42120 000084BB 616D20616E64206469-
 42120 000084C4 73706C617973207468-
 42120 000084CD 65206D657373616765-
 42120 000084D6 2022               
 42121 000084D8 507265737320616E79-     	db 'Press any',0Dh,0Ah
 42121 000084E1 0D0A               
 42122 000084E3 6B657920746F20636F-     	db 'key to continue...."',0Dh,0Ah
 42122 000084EC 6E74696E75652E2E2E-
 42122 000084F5 2E220D0A           
 42123 000084F9 0D0A                    	db 0Dh,0Ah
 42124 000084FB 50415553450D0A          	db 'PAUSE',0Dh,0Ah
 42125                                  MSG_1800:
 42126 00008502 4D                      	db 77
 42127 00008503 446973706C61797320-     	db 'Displays messages, or turns command-echoing on or off.',0Dh,0Ah
 42127 0000850C 6D657373616765732C-
 42127 00008515 206F72207475726E73-
 42127 0000851E 20636F6D6D616E642D-
 42127 00008527 6563686F696E67206F-
 42127 00008530 6E206F72206F66662E-
 42127 00008539 0D0A               
 42128 0000853B 0D0A                    	db 0Dh,0Ah
 42129 0000853D 20204543484F205B4F-     	db '  ECHO [ON | OFF]',0Dh,0Ah
 42129 00008546 4E207C204F46465D0D-
 42129 0000854F 0A                 
 42130                                  MSG_1801:
 42131 00008550 57                      	db 87
 42132 00008551 20204543484F205B6D-     	db '  ECHO [message]',0Dh,0Ah
 42132 0000855A 6573736167655D0D0A 
 42133 00008563 0D0A                    	db 0Dh,0Ah
 42134 00008565 54797065204543484F-     	db 'Type ECHO without parameters to display the current echo setting.'
 42134 0000856E 20776974686F757420-
 42134 00008577 706172616D65746572-
 42134 00008580 7320746F2064697370-
 42134 00008589 6C6179207468652063-
 42134 00008592 757272656E74206563-
 42134 0000859B 686F2073657474696E-
 42134 000085A4 672E               
 42135 000085A6 0D0A                    	db 0Dh,0Ah
 42136                                  MSG_1820:
 42137 000085A8 47                      	db 71
 42138                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42139                                  %if 0
 42140                                  	db 'Directs MS-DOS to a labelled line in a batch program.',0Dh,0Ah
 42141                                  %else
 42142 000085A9 446972656374732050-     	db 'Directs PC DOS to a labelled line in a batch program.',0Dh,0Ah
 42142 000085B2 4320444F5320746F20-
 42142 000085BB 61206C6162656C6C65-
 42142 000085C4 64206C696E6520696E-
 42142 000085CD 206120626174636820-
 42142 000085D6 70726F6772616D2E0D-
 42142 000085DF 0A                 
 42143                                  %endif
 42144 000085E0 0D0A                    	db 0Dh,0Ah
 42145 000085E2 474F544F206C616265-     	db 'GOTO label',0Dh,0Ah
 42145 000085EB 6C0D0A             
 42146 000085EE 0D0A                    	db 0Dh,0Ah
 42147                                  MSG_1821:
 42148 000085F0 8A                      	db 138
 42149 000085F1 20206C6162656C2020-     	db '  label   Specifies a text string used in the batch program as a label.',0Dh,0Ah
 42149 000085FA 205370656369666965-
 42149 00008603 732061207465787420-
 42149 0000860C 737472696E67207573-
 42149 00008615 656420696E20746865-
 42149 0000861E 206261746368207072-
 42149 00008627 6F6772616D20617320-
 42149 00008630 61206C6162656C2E0D-
 42149 00008639 0A                 
 42150 0000863A 0D0A                    	db 0Dh,0Ah
 42151 0000863C 596F75207479706520-     	db 'You type a label on a line by itself, beginning with a colon.',0Dh,0Ah
 42151 00008645 61206C6162656C206F-
 42151 0000864E 6E2061206C696E6520-
 42151 00008657 627920697473656C66-
 42151 00008660 2C20626567696E6E69-
 42151 00008669 6E6720776974682061-
 42151 00008672 20636F6C6F6E2E0D0A 
 42152                                  MSG_1840:
 42153 0000867B 4A                      	db 74
 42154 0000867C 4368616E6765732074-     	db 'Changes the position of replaceable parameters in a batch file.',0Dh,0Ah
 42154 00008685 686520706F73697469-
 42154 0000868E 6F6E206F6620726570-
 42154 00008697 6C61636561626C6520-
 42154 000086A0 706172616D65746572-
 42154 000086A9 7320696E2061206261-
 42154 000086B2 7463682066696C652E-
 42154 000086BB 0D0A               
 42155 000086BD 0D0A                    	db 0Dh,0Ah
 42156 000086BF 53484946540D0A          	db 'SHIFT',0Dh,0Ah
 42157                                  MSG_1860:
 42158 000086C6 5A                      	db 90
 42159 000086C7 506572666F726D7320-     	db 'Performs conditional processing in batch programs.',0Dh,0Ah
 42159 000086D0 636F6E646974696F6E-
 42159 000086D9 616C2070726F636573-
 42159 000086E2 73696E6720696E2062-
 42159 000086EB 617463682070726F67-
 42159 000086F4 72616D732E0D0A     
 42160 000086FB 0D0A                    	db 0Dh,0Ah
 42161 000086FD 4946205B4E4F545D20-     	db 'IF [NOT] ERRORLEVEL number command',0Dh,0Ah
 42161 00008706 4552524F524C455645-
 42161 0000870F 4C206E756D62657220-
 42161 00008718 636F6D6D616E640D0A 
 42162                                  MSG_1861:
 42163 00008721 46                      	db 70
 42164 00008722 4946205B4E4F545D20-     	db 'IF [NOT] string1==string2 command',0Dh,0Ah
 42164 0000872B 737472696E67313D3D-
 42164 00008734 737472696E67322063-
 42164 0000873D 6F6D6D616E640D0A   
 42165 00008745 4946205B4E4F545D20-     	db 'IF [NOT] EXIST filename command',0Dh,0Ah
 42165 0000874E 45584953542066696C-
 42165 00008757 656E616D6520636F6D-
 42165 00008760 6D616E640D0A       
 42166 00008766 0D0A                    	db 0Dh,0Ah
 42167                                  MSG_1862:
 42168 00008768 7D                      	db 125
 42169                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42170                                  %if 0
 42171                                  	db '  NOT               Specifies that MS-DOS should carry out the command only',0Dh,0Ah
 42172                                  %else
 42173 00008769 20204E4F5420202020-     	db '  NOT               Specifies that PC DOS should carry out the command only',0Dh,0Ah
 42173 00008772 202020202020202020-
 42173 0000877B 202053706563696669-
 42173 00008784 657320746861742050-
 42173 0000878D 4320444F532073686F-
 42173 00008796 756C64206361727279-
 42173 0000879F 206F75742074686520-
 42173 000087A8 636F6D6D616E64206F-
 42173 000087B1 6E6C790D0A         
 42174                                  %endif
 42175 000087B6 202020202020202020-     	db '                    if the condition is false.',0Dh,0Ah
 42175 000087BF 202020202020202020-
 42175 000087C8 202069662074686520-
 42175 000087D1 636F6E646974696F6E-
 42175 000087DA 2069732066616C7365-
 42175 000087E3 2E0D0A             
 42176                                  MSG_1863:
 42177 000087E6 A2                      	db 162
 42178 000087E7 20204552524F524C45-     	db '  ERRORLEVEL number Specifies a true condition if the last program run returned',0Dh,0Ah
 42178 000087F0 56454C206E756D6265-
 42178 000087F9 722053706563696669-
 42178 00008802 657320612074727565-
 42178 0000880B 20636F6E646974696F-
 42178 00008814 6E2069662074686520-
 42178 0000881D 6C6173742070726F67-
 42178 00008826 72616D2072756E2072-
 42178 0000882F 657475726E65640D0A 
 42179 00008838 202020202020202020-     	db '                    '
 42179 00008841 202020202020202020-
 42179 0000884A 2020               
 42180 0000884C 616E20657869742063-     	db 'an exit code equal to or greater than the number specified.',0Dh,0Ah
 42180 00008855 6F646520657175616C-
 42180 0000885E 20746F206F72206772-
 42180 00008867 656174657220746861-
 42180 00008870 6E20746865206E756D-
 42180 00008879 626572207370656369-
 42180 00008882 666965642E0D0A     
 42181                                  MSG_1864:
 42182 00008889 66                      	db 102
 42183 0000888A 2020636F6D6D616E64-     	db '  command           Specifies the command to carry out if the condition is',0Dh,0Ah
 42183 00008893 202020202020202020-
 42183 0000889C 202053706563696669-
 42183 000088A5 65732074686520636F-
 42183 000088AE 6D6D616E6420746F20-
 42183 000088B7 6361727279206F7574-
 42183 000088C0 206966207468652063-
 42183 000088C9 6F6E646974696F6E20-
 42183 000088D2 69730D0A           
 42184 000088D6 202020202020202020-     	db '                    met.',0Dh,0Ah
 42184 000088DF 202020202020202020-
 42184 000088E8 20206D65742E0D0A   
 42185                                  MSG_1865:
 42186 000088F0 6A                      	db 106
 42187 000088F1 2020737472696E6731-     	db '  string1==string2  Specifies a true condition if the specified text strings',0Dh,0Ah
 42187 000088FA 3D3D737472696E6732-
 42187 00008903 202053706563696669-
 42187 0000890C 657320612074727565-
 42187 00008915 20636F6E646974696F-
 42187 0000891E 6E2069662074686520-
 42187 00008927 737065636966696564-
 42187 00008930 207465787420737472-
 42187 00008939 696E67730D0A       
 42188 0000893F 202020202020202020-     	db '                    match.',0Dh,0Ah
 42188 00008948 202020202020202020-
 42188 00008951 20206D617463682E0D-
 42188 0000895A 0A                 
 42189                                  MSG_1866:
 42190 0000895B 67                      	db 103
 42191 0000895C 202045584953542066-     	db '  EXIST filename    Specifies a true condition if the specified filename',0Dh,0Ah
 42191 00008965 696C656E616D652020-
 42191 0000896E 202053706563696669-
 42191 00008977 657320612074727565-
 42191 00008980 20636F6E646974696F-
 42191 00008989 6E2069662074686520-
 42191 00008992 737065636966696564-
 42191 0000899B 2066696C656E616D65-
 42191 000089A4 0D0A               
 42192 000089A6 202020202020202020-     	db '                    exists.',0Dh,0Ah
 42192 000089AF 202020202020202020-
 42192 000089B8 20206578697374732E-
 42192 000089C1 0D0A               
 42193                                  MSG_1880:
 42194 000089C3 77                      	db 119
 42195 000089C4 52756E732061207370-     	db 'Runs a specified command for each file in a set of files.',0Dh,0Ah
 42195 000089CD 656369666965642063-
 42195 000089D6 6F6D6D616E6420666F-
 42195 000089DF 722065616368206669-
 42195 000089E8 6C6520696E20612073-
 42195 000089F1 6574206F662066696C-
 42195 000089FA 65732E0D0A         
 42196 000089FF 0D0A                    	db 0Dh,0Ah
 42197 00008A01 464F52202576617269-     	db 'FOR %variable IN (set) DO command [command-parameters]',0Dh,0Ah
 42197 00008A0A 61626C6520494E2028-
 42197 00008A13 7365742920444F2063-
 42197 00008A1C 6F6D6D616E64205B63-
 42197 00008A25 6F6D6D616E642D7061-
 42197 00008A2E 72616D65746572735D-
 42197 00008A37 0D0A               
 42198 00008A39 0D0A                    	db 0Dh,0Ah
 42199                                  MSG_1881:
 42200 00008A3B 7D                      	db 125
 42201 00008A3C 202025766172696162-     	db '  %variable  Specifies a replaceable parameter.',0Dh,0Ah
 42201 00008A45 6C6520205370656369-
 42201 00008A4E 666965732061207265-
 42201 00008A57 706C61636561626C65-
 42201 00008A60 20706172616D657465-
 42201 00008A69 722E0D0A           
 42202 00008A6D 202028736574292020-     	db '  (set)      Specifies a set of one or more files.  Wildcards may be used.',0Dh,0Ah
 42202 00008A76 202020205370656369-
 42202 00008A7F 666965732061207365-
 42202 00008A88 74206F66206F6E6520-
 42202 00008A91 6F72206D6F72652066-
 42202 00008A9A 696C65732E20205769-
 42202 00008AA3 6C646361726473206D-
 42202 00008AAC 617920626520757365-
 42202 00008AB5 642E0D0A           
 42203                                  MSG_1882:
 42204 00008AB9 56                      	db 86
 42205 00008ABA 2020636F6D6D616E64-     	db '  command    Specifies the command to carry out for each file.',0Dh,0Ah
 42205 00008AC3 202020205370656369-
 42205 00008ACC 666965732074686520-
 42205 00008AD5 636F6D6D616E642074-
 42205 00008ADE 6F206361727279206F-
 42205 00008AE7 757420666F72206561-
 42205 00008AF0 63682066696C652E0D-
 42205 00008AF9 0A                 
 42206 00008AFA 2020636F6D6D616E64-     	db '  command-parameters',0Dh,0Ah
 42206 00008B03 2D706172616D657465-
 42206 00008B0C 72730D0A           
 42207                                  MSG_1883:
 42208 00008B10 A2                      	db 162
 42209 00008B11 202020202020202020-     	db '             Specifies parameters or switches for the specified command.',0Dh,0Ah
 42209 00008B1A 202020205370656369-
 42209 00008B23 666965732070617261-
 42209 00008B2C 6D6574657273206F72-
 42209 00008B35 207377697463686573-
 42209 00008B3E 20666F722074686520-
 42209 00008B47 737065636966696564-
 42209 00008B50 20636F6D6D616E642E-
 42209 00008B59 0D0A               
 42210 00008B5B 0D0A                    	db 0Dh,0Ah
 42211 00008B5D 546F20757365207468-     	db 'To use the FOR command in a batch program, specify %%variable instead of',0Dh,0Ah
 42211 00008B66 6520464F5220636F6D-
 42211 00008B6F 6D616E6420696E2061-
 42211 00008B78 206261746368207072-
 42211 00008B81 6F6772616D2C207370-
 42211 00008B8A 656369667920252576-
 42211 00008B93 61726961626C652069-
 42211 00008B9C 6E7374656164206F66-
 42211 00008BA5 0D0A               
 42212 00008BA7 257661726961626C65-     	db '%variable.',0Dh,0Ah
 42212 00008BB0 2E0D0A             
 42213                                  MSG_1900:
 42214                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42215                                  %if 0
 42216                                  	; MSDOS 6.22 COMMAND.COM
 42217                                  	db 23
 42218                                  	db 'Reserved command name',0Dh,0Ah
 42219                                  %else
 42220                                  	; PCDOS 7.1 COMMAND.COM
 42221 00008BB3 48                      	db 72
 42222 00008BB4 52657475726E732061-     	db 'Returns a fully qualified filename.',0Dh,0Ah
 42222 00008BBD 2066756C6C79207175-
 42222 00008BC6 616C69666965642066-
 42222 00008BCF 696C656E616D652E0D-
 42222 00008BD8 0A                 
 42223 00008BD9 0D0A                    	db 0Dh,0Ah
 42224 00008BDB 545255454E414D4520-     	db 'TRUENAME [drive:][path]filename',0Dh,0Ah
 42224 00008BE4 5B64726976653A5D5B-
 42224 00008BED 706174685D66696C65-
 42224 00008BF6 6E616D650D0A       
 42225                                  %endif
 42226                                  MSG_1920:
 42227 00008BFC 2F                      	db 47
 42228 00008BFD 4C6F61647320612070-     	db 'Loads a program into the upper memory area.',0Dh,0Ah
 42228 00008C06 726F6772616D20696E-
 42228 00008C0F 746F20746865207570-
 42228 00008C18 706572206D656D6F72-
 42228 00008C21 7920617265612E0D0A 
 42229 00008C2A 0D0A                    	db 0Dh,0Ah
 42230                                  MSG_1921:
 42231                                  	;db 88
 42232                                  	;db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42233                                  	;db 'LH [drive:][path]filename [parameters]',0Dh,0Ah
 42234                                  	;db 0Dh,0Ah
 42235                                  
 42236                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42237                                  %if 0
 42238                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42239                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9303h
 42240                                  	db 157
 42241                                  	db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42242                                  	db 'LOADHIGH [/L:region1[,minsize1][;region2[,minsize2]...] [/S]]',0Dh,0Ah
 42243                                  	db '         [drive:][path]filename [parameters]',0Dh,0Ah
 42244                                  	db 0Dh,0Ah
 42245                                  %else
 42246                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42247                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:90EBh
 42248 00008C2C 98                      	db 152
 42249 00008C2D 4C4F41444849474820-     	db 'LOADHIGH [drive:][path]filename [parameters]',0Dh,0Ah
 42249 00008C36 5B64726976653A5D5B-
 42249 00008C3F 706174685D66696C65-
 42249 00008C48 6E616D65205B706172-
 42249 00008C51 616D65746572735D0D-
 42249 00008C5A 0A                 
 42250 00008C5B 4C4F41444849474820-     	db 'LOADHIGH [/L:region1[,minsize1][;region2[,minsize2]...]]',0Dh,0Ah
 42250 00008C64 5B2F4C3A726567696F-
 42250 00008C6D 6E315B2C6D696E7369-
 42250 00008C76 7A65315D5B3B726567-
 42250 00008C7F 696F6E325B2C6D696E-
 42250 00008C88 73697A65325D2E2E2E-
 42250 00008C91 5D5D0D0A           
 42251 00008C95 202020202020202020-     	db '         [drive:][path]filename [parameters]',0Dh,0Ah
 42251 00008C9E 5B64726976653A5D5B-
 42251 00008CA7 706174685D66696C65-
 42251 00008CB0 6E616D65205B706172-
 42251 00008CB9 616D65746572735D0D-
 42251 00008CC2 0A                 
 42252 00008CC3 0D0A                    	db 0Dh,0Ah	
 42253                                  %endif
 42254                                  	; (MSDOS 5.0 COMMAND.COM - TRANGROUP:8111h)
 42255                                  ;MSG_1922: 	; MSDOS 5.0 COMMAND.COM
 42256                                  	;db 113
 42257                                  	;db '  parameters   Specifies any command-line information required by the',0Dh,0Ah
 42258                                  	;db '               program you want to load.',0Dh,0Ah
 42259                                  
 42260                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42261                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:93A1h
 42262                                  MSG_1922:
 42263 00008CC5 B6                      	db 182
 42264 00008CC6 2F4C3A726567696F6E-     	db '/L:region1[,minsize1][;region2[,minsize2]]...',0Dh,0Ah
 42264 00008CCF 315B2C6D696E73697A-
 42264 00008CD8 65315D5B3B72656769-
 42264 00008CE1 6F6E325B2C6D696E73-
 42264 00008CEA 697A65325D5D2E2E2E-
 42264 00008CF3 0D0A               
 42265 00008CF5 202020202020202020-     	db '            Specifies the region(s) of memory into which to load',0Dh,0Ah
 42265 00008CFE 202020537065636966-
 42265 00008D07 696573207468652072-
 42265 00008D10 6567696F6E28732920-
 42265 00008D19 6F66206D656D6F7279-
 42265 00008D22 20696E746F20776869-
 42265 00008D2B 636820746F206C6F61-
 42265 00008D34 640D0A             
 42266 00008D37 202020202020202020-     	db '            the program.  Region1 specifies the number of the first',0Dh,0Ah
 42266 00008D40 202020746865207072-
 42266 00008D49 6F6772616D2E202052-
 42266 00008D52 6567696F6E31207370-
 42266 00008D5B 656369666965732074-
 42266 00008D64 6865206E756D626572-
 42266 00008D6D 206F66207468652066-
 42266 00008D76 697273740D0A       
 42267                                  MSG_1923:
 42268 00008D7C 85                      	db 133
 42269 00008D7D 202020202020202020-     	db '            memory region; minsize1 specifies the minimum size, if',0Dh,0Ah
 42269 00008D86 2020206D656D6F7279-
 42269 00008D8F 20726567696F6E3B20-
 42269 00008D98 6D696E73697A653120-
 42269 00008DA1 737065636966696573-
 42269 00008DAA 20746865206D696E69-
 42269 00008DB3 6D756D2073697A652C-
 42269 00008DBC 2069660D0A         
 42270 00008DC1 202020202020202020-     	db '            any, for region1.  Region2 and minsize2 specify the',0Dh
 42270 00008DCA 202020616E792C2066-
 42270 00008DD3 6F7220726567696F6E-
 42270 00008DDC 312E2020526567696F-
 42270 00008DE5 6E3220616E64206D69-
 42270 00008DEE 6E73697A6532207370-
 42270 00008DF7 656369667920746865-
 42270 00008E00 0D                 
 42271 00008E01 0A                      	db 0Ah
 42272                                  MSG_1924:
 42273                                  ; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42274                                  %if 0
 42275                                  	db 127
 42276                                  	db '            number and minimum size of the second region, if any.',0Dh,0Ah
 42277                                  	db '            You can specify as many regions as you want.',0Dh,0Ah
 42278                                  	db 0Dh,0Ah
 42279                                  MSG_1925:
 42280                                  	db 131
 42281                                  	db '/S          Shrinks a UMB to its minimum size while the program',0Dh,0Ah
 42282                                  	db '            is loading.  /S is normally used only by MemMaker.',0Dh,0Ah
 42283                                  	db 0Dh,0Ah
 42284                                  %else
 42285 00008E02 7B                      	db 123
 42286 00008E03 202020202020202020-     	db '            number and minimum size of the second region, if any.',0Dh,0Ah
 42286 00008E0C 2020206E756D626572-
 42286 00008E15 20616E64206D696E69-
 42286 00008E1E 6D756D2073697A6520-
 42286 00008E27 6F6620746865207365-
 42286 00008E30 636F6E642072656769-
 42286 00008E39 6F6E2C20696620616E-
 42286 00008E42 792E0D0A           
 42287 00008E46 202020202020202020-     	db '            You can specify as many regions as you want.'
 42287 00008E4F 202020596F75206361-
 42287 00008E58 6E2073706563696679-
 42287 00008E61 206173206D616E7920-
 42287 00008E6A 726567696F6E732061-
 42287 00008E73 7320796F752077616E-
 42287 00008E7C 742E               
 42288                                  MSG_1925:
 42289 00008E7E 02                      	db 2
 42290 00008E7F 0D0A                    	db 0Dh,0Ah
 42291                                  %endif
 42292                                  MSG_1926:
 42293 00008E81 57                      	db 87
 42294 00008E82 5B64726976653A5D5B-     	db '[drive:][path]filename',0Dh,0Ah
 42294 00008E8B 706174685D66696C65-
 42294 00008E94 6E616D650D0A       
 42295 00008E9A 202020202020202020-     	db '            Specifies the location and name of the program.',0Dh,0Ah
 42295 00008EA3 202020537065636966-
 42295 00008EAC 69657320746865206C-
 42295 00008EB5 6F636174696F6E2061-
 42295 00008EBE 6E64206E616D65206F-
 42295 00008EC7 66207468652070726F-
 42295 00008ED0 6772616D2E0D0A     
 42296 00008ED7 0D0A                    	db 0Dh,0Ah
 42297                                  
 42298                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42299                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:963Ah
 42300                                  
 42301                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42302                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9398h
 42303                                  MSG_1927:
 42304 00008ED9 5A                      	db 90
 42305 00008EDA 706172616D65746572-     	db 'parameters  Specifies any command-line information required by',0Dh,0Ah
 42305 00008EE3 732020537065636966-
 42305 00008EEC 69657320616E792063-
 42305 00008EF5 6F6D6D616E642D6C69-
 42305 00008EFE 6E6520696E666F726D-
 42305 00008F07 6174696F6E20726571-
 42305 00008F10 75697265642062790D-
 42305 00008F19 0A                 
 42306 00008F1A 202020202020202020-     	db '            the program.',0Dh,0Ah
 42306 00008F23 202020746865207072-
 42306 00008F2C 6F6772616D2E0D0A   
 42307                                  
 42308                                  	; 02/08/2024 - Retro DOS v5.0 COMMAND.COM
 42309                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:96F3h
 42310                                  MSG_1107:
 42311 00008F34 0C                      	db 12
 42312 00008F35 2531204B2062797465-     	db '%1 K bytes',0Dh,0Ah
 42312 00008F3E 730D0A             
 42313                                  
 42314                                  ; ---------------------------------------------------------------------------
 42315                                  
 42316                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42317                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8183h
 42318                                  
 42319                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42320                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9695h
 42321                                  
 42322                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42323                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9400h
 42324                                  
 42325                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42326                                  
 42327                                  $M_CLS_3:
 42328 00008F41 0E                      	push	cs		; CLASS_F
 42329 00008F42 07                      	pop	es
 42330 00008F43 8D3E[F462]              	lea	di,$M_CLASS_3_STRUC ; LEA DI,$M_CLASS_3_STRUC
 42331                                  	; 15/04/2023
 42332                                  	;add	cx,10053	; ADD CX,$-$M_CLASS_3_STRUC ; 8189h-5A44h
 42333                                  	; 17/06/2023
 42334                                  	;add	cx,11627	; ADD CX,$-$M_CLASS_3_STRUC ; 969Bh-6930h
 42335                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42336                                  	;add	cx,11353	; ADD CX,$-$M_CLASS_3_STRUC ; 9406h-67ADh
 42337 00008F47 81C1532C                	add	cx,$-$M_CLASS_3_STRUC
 42338 00008F4B C3                      	retn
 42339                                  
 42340                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42341                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:818Eh
 42342                                  
 42343                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42344                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:96A0h
 42345                                  
 42346                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42347                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:940Bh
 42348                                  
 42349                                  ; ---------------------------------------------------------------------------
 42350                                  ; Class 1 messages
 42351                                  ; ---------------------------------------------------------------------------
 42352                                  	
 42353                                  $M_CLASS_1_STRUC:
 42354 00008F4C 01                      	db 1			; $M_CLASS_ID
 42355                                  	;dw 5			; EXPECTED_VERSION (COMMAND.COM version)
 42356                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42357                                  	;dw 1606h  ; MSDOS 6.22 COMMAND.COM
 42358                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 42359 00008F4D 070A                    	dw 0A07h  ; PCDOS 7.10 COMMAND.COM
 42360 00008F4F 04                      	db 4			; Class_1_MessageCount
 42361                                  $M_ID_1_1:
 42362 00008F50 0200                    	dw 2			; Message Number = 2
 42363 00008F52 1000                    	dw EXTEND2-$+2 ; 10h	; Message offset from message number
 42364                                  $M_ID_1_2:
 42365 00008F54 0300                    	dw 3			; Message Number = 3
 42366 00008F56 1B00                    	dw EXTEND3-$+2 ; 1Bh	; Message offset from message number
 42367                                  $M_ID_1_3:
 42368 00008F58 0800                    	dw 8			; Message Number = 8
 42369 00008F5A 2600                    	dw EXTEND8-$+2 ; 26h	; Message offset from message number
 42370                                  $M_ID_1_4:
 42371 00008F5C FFFF                    	dw 0FFFFh		; Message Number = -1
 42372 00008F5E 3600                    	dw EXTEND999-$+2 ; 36h	; Message offset from message number
 42373                                  
 42374                                  ; ---------------------------------------------------------------------------
 42375                                  
 42376                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81A2h
 42377                                  EXTEND2:
 42378 00008F60 0E                      	db 14
 42379 00008F61 46696C65206E6F7420-     	db 'File not found'
 42379 00008F6A 666F756E64         
 42380                                  EXTEND3:
 42381 00008F6F 0E                      	db 14
 42382 00008F70 50617468206E6F7420-     	db 'Path not found'
 42382 00008F79 666F756E64         
 42383                                  EXTEND8:
 42384 00008F7E 13                      	db 19
 42385 00008F7F 496E73756666696369-     	db 'Insufficient memory'
 42385 00008F88 656E74206D656D6F72-
 42385 00008F91 79                 
 42386                                  EXTEND999:
 42387 00008F92 11                      	db 17
 42388 00008F93 457874656E64656420-     	db 'Extended Error %1'
 42388 00008F9C 4572726F72202531   
 42389                                  
 42390                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42391                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81E6h
 42392                                  
 42393                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42394                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:96F8h
 42395                                  
 42396                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42397                                  $M_MSGSERV_1:
 42398 00008FA4 0E                      	push	cs
 42399 00008FA5 07                      	pop	es
 42400 00008FA6 8D3E[4C8F]              	lea	di,$M_CLASS_1_STRUC
 42401                                  	; 15/04/2023
 42402                                  	;add	cx,94		; $-$M_CLASS_1_STRUC ; 81ECh-818Eh
 42403                                  			; 17/06/2023 MSDOS 6.22 COMMAND.COM
 42404                                  				; 96FEh-96A0h = 5Eh = 94
 42405                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42406                                  	;add	cx,94 ; Retro DOS v5.0 COMMAND.COM
 42407 00008FAA C3                      	retn
 42408                                  
 42409                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42410                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81F0h
 42411                                  
 42412                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42413                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9702h
 42414                                  
 42415                                  ; ---------------------------------------------------------------------------
 42416                                  ; Class 2 messages
 42417                                  ; ---------------------------------------------------------------------------
 42418                                  	
 42419                                  $M_CLASS_2_STRUC:
 42420 00008FAB 02                      	db 2			; $M_CLASS_ID
 42421                                  	;dw 5			; EXPECTED_VERSION (COMMAND.COM version)
 42422                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42423                                  	;dw 1606h  ; MSDOS 6.22 COMMAND.COM
 42424                                  	; 21/07/2024 - Retro DOS v5.0 COMMAND.COM
 42425 00008FAC 070A                    	dw 0A07h  ; PCDOS 7.10 COMMAND.COM
 42426 00008FAE 01                      	db 1			; Class_2_MessageCount
 42427                                  $M_ID_2_1:
 42428 00008FAF FFFF                    	dw 0FFFFh		; Message Number = -1
 42429 00008FB1 0400                    	dw PARSE999-$+2 ; 4	; Message offset from message number
 42430                                  ; ---------------------------------------------------------------------------
 42431                                  
 42432                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:81F8h
 42433                                  PARSE999:
 42434 00008FB3 0E                      	db 14
 42435 00008FB4 506172736520457272-     	db 'Parse Error %1'
 42435 00008FBD 6F72202531         
 42436                                  
 42437                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42438                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8207h
 42439                                  
 42440                                  	; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42441                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9719h
 42442                                  
 42443                                  	; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42444                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9484h
 42445                                  
 42446                                  ; --------------- S U B R O U T I N E ---------------------------------------
 42447                                  $M_MSGSERV_2:
 42448 00008FC2 0E                      	push	cs
 42449 00008FC3 07                      	pop	es
 42450 00008FC4 8D3E[AB8F]              	lea	di,$M_CLASS_2_STRUC
 42451                                  	; 15/04/2023
 42452                                  	;add	cx,29		; $-$M_CLASS_2_STRUC ; 820Dh-81F0h
 42453                                  			; 17/06/2023 MSDOS 6.22 COMMAND.COM
 42454                                  				; 971Fh-9702h = 1Dh = 29
 42455                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 42456                                  	;add	cx,29 ; Retro DOS v5.0 COMMAND.COM
 42457 00008FC8 C3                      	retn
 42458                                  
 42459                                  ;============================================================================
 42460                                  ; TRANMSG.ASM, MSDOS 6.0, 1991
 42461                                  ;============================================================================
 42462                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 42463                                  ; 17/06/2023 - Retro DOS v4.2 COMMAND.COM
 42464                                  ; 06/08/2024 - Retro DOS v5.0 COMMAND.COM
 42465                                  
 42466                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8211h
 42467                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9723h
 42468                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:948Eh
 42469                                  
 42470                                  ;****************************************************
 42471                                  ;* TRANSIENT MESSAGE POINTERS & SUBSTITUTION BLOCKS *
 42472                                  ;****************************************************
 42473                                  
 42474                                  msg_disp_class:
 42475 00008FC9 FF                      	db	util_msg_class ; 0FFh
 42476                                  msg_cont_flag:
 42477 00008FCA 00                      	db	no_cont_flag ; 0
 42478                                  
 42479                                  ;  extended error string output
 42480                                  extend_buf_ptr:
 42481 00008FCB 0000                    	dw	0			;AN000;set to no message
 42482                                  extend_buf_sub:
 42483 00008FCD 00                      	db	0			;AN000;set to no substitutions
 42484 00008FCE 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42485 00008FCF 00                      	db	0			;AN000;reserved
 42486                                  extend_buf_off:
 42487 00008FD0 [019E]                  	dw	string_ptr_2		;AN000;offset of arg
 42488                                  extend_buf_seg:
 42489 00008FD2 0000                    	dw	0			;AN000;segment of arg
 42490 00008FD4 00                      	db	0			;AN000;first subst
 42491 00008FD5 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42492 00008FD6 80                      	db	128			;AN000;maximum width
 42493 00008FD7 00                      	db	0			;AN000;minimum width
 42494 00008FD8 20                      	db	blank ; 20h		;AN000;pad character
 42495                                  
 42496                                  ;  "Duplicate file name or file not found"
 42497                                  RENERR_PTR:
 42498 00008FD9 EA03                    	dw	1002			;AN000;message number
 42499 00008FDB 00                      	db	no_subst ; 0		;AN000;number of subst
 42500                                  
 42501                                  ;  "Invalid path or file name"
 42502                                  BADCPMES_PTR:
 42503 00008FDC EB03                    	dw	1003			;AN000;message number
 42504 00008FDE 00                      	db	no_subst ; 0		;AN000;number of subst
 42505                                  
 42506                                  ;  "Insufficient disk space"
 42507                                  NOSPACE_PTR:
 42508 00008FDF EC03                    	dw	1004			;AN000;message number
 42509 00008FE1 00                      	db	no_subst ; 0		;AN000;number of subst
 42510                                  
 42511                                  ;  "Out of environment space"
 42512                                  ENVERR_PTR:
 42513 00008FE2 EF03                    	dw	1007			;AN000;message number
 42514 00008FE4 00                      	db	no_subst ; 0		;AN000;number of subst
 42515                                  
 42516                                  ;  "File creation error"
 42517                                  FULLDIR_PTR:
 42518 00008FE5 F003                    	dw	1008			;AN000;message number
 42519 00008FE7 00                      	db	no_subst ; 0		;AN000;number of subst
 42520                                  
 42521                                  ;  "Batch file missing",13,10
 42522                                  BADBAT_PTR:
 42523 00008FE8 F103                    	dw	1009			;AN000;message number
 42524 00008FEA 00                      	db	no_subst ; 0		;AN000;number of subst
 42525                                  
 42526                                  ;  "Insert disk with batch file",13,10
 42527                                  NEEDBAT_PTR:
 42528 00008FEB F203                    	dw	1010			;AN000;message number
 42529 00008FED 00                      	db	no_subst ; 0		;AN000;number of subst
 42530                                  
 42531                                  ;  "Bad command or file name",13,10
 42532                                  BADNAM_PTR:
 42533 00008FEE F303                    	dw	1011			;AN000;message number
 42534 00008FF0 00                      	db	no_subst ; 0		;AN000;number of subst
 42535                                  
 42536                                  ; 04/08/2024 - PCDOS 7.1 COMMAND.COM
 42537                                  %if 1
 42538                                  ; "REXX interpreter not found",13,10
 42539                                  REXXNOTF_PTR:
 42540 00008FF1 F403                    	dw	1012
 42541 00008FF3 00                      	db	no_subst ; 0
 42542                                  %endif
 42543                                  
 42544                                  ;  "Access denied",13,10
 42545                                  ACCDEN_PTR:
 42546 00008FF4 F603                    	dw	1014			;AN000;message number
 42547 00008FF6 00                      	db	no_subst ; 0		;AN000;number of subst
 42548                                  
 42549                                  ;  "File cannot be copied onto itself",13,10
 42550                                  OVERWR_PTR:
 42551 00008FF7 F703                    	dw	1015			;AN000;message number
 42552 00008FF9 00                      	db	no_subst ; 0		;AN000;number of subst
 42553                                  
 42554                                  ;  "Content of destination lost before copy",13,10
 42555                                  LOSTERR_PTR:
 42556 00008FFA F803                    	dw	1016			;AN000;message number
 42557 00008FFC 00                      	db	no_subst ; 0		;AN000;number of subst
 42558                                  
 42559                                  ;  "Invalid filename or file not found",13,10
 42560                                  INORNOT_PTR:
 42561 00008FFD F903                    	dw	1017			;AN000;message number
 42562 00008FFF 00                      	db	no_subst		;AN000;number of subst
 42563                                  
 42564                                  ;  "%1 File(s) copied",13,10
 42565                                  copied_ptr:
 42566 00009000 FA03                    	dw	1018			;AN000;message number
 42567 00009002 01                      	db	1			;AN000;number of subst
 42568 00009003 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42569 00009004 00                      	db	0			;AN000;reserved
 42570 00009005 [039E]                  	dw	Copy_num		;AN000;offset of arg
 42571 00009007 0000                    	dw	0			;AN000;segment of arg
 42572 00009009 01                      	db	1			;AN000;first subst
 42573 0000900A A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42574                                  					;AN000;binary to decimal
 42575 0000900B 09                      	db	9			;AN000;maximum width
 42576 0000900C 09                      	db	9			;AN000;minimum width
 42577 0000900D 20                      	db	blank ; 20h		;AN000;pad character
 42578                                  
 42579                                  ;  "%1 File(s) "
 42580                                  dirmes_ptr:
 42581 0000900E FB03                    	dw	1019			;AN000;message number
 42582 00009010 01                      	db	1			;AN000;number of subst
 42583 00009011 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42584 00009012 00                      	db	0			;AN000;reserved
 42585 00009013 [069E]                  	dw	Dir_Num			;AN000;offset of arg
 42586 00009015 0000                    	dw	0			;AN000;segment of arg
 42587 00009017 01                      	db	1			;AN000;first subst
 42588                                  	; MSDOS 5.0 COMMAND.COM
 42589                                  	;db	0A1h ; Right_Align+Unsgn_Bin_Word
 42590                                  	; 17/06/2023
 42591                                  ;screen_f_3:
 42592 00009018 E1                      	db	0E1h ; MSDOS 6.22 COMMAND.COM
 42593                                  					;AN000;binary to decimal
 42594 00009019 09                      	db	9			;AN000;maximum width
 42595 0000901A 09                      	db	9			;AN000;minimum width
 42596 0000901B 20                      	db	blank ; 20h		;AN000;pad character
 42597                                  
 42598                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 42599                                  %if 0
 42600                                  ;  "%1 bytes free",13,10
 42601                                  bytmes_ptr:
 42602                                  	dw	1020			;AN000;message number
 42603                                  	db	1			;AN000;number of subst
 42604                                  	db	parm_block_size ; 11	;AN000;size of sublist
 42605                                  	db	0			;AN000;reserved
 42606                                  	dw	Bytes_Free		;AN000;offset of arg
 42607                                  	dw	0			;AN000;segment of arg
 42608                                  	db	1			;AN000;first subst
 42609                                  	; MSDOS 5.0 COMMAND.COM
 42610                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 42611                                  	; 17/06/2023
 42612                                  screen_f_6:
 42613                                  	db	0F1h			;AN000;long binary to decimal
 42614                                  	; MSDOS 5.0 COMMAND.COM
 42615                                  	;db	28			;AN000;maximum width
 42616                                  	;db	28			;AN000;minimum width
 42617                                  	; 17/06/2023
 42618                                  screen_f_7:
 42619                                  	db	32 ; MSDOS 6.22 COMMAND.COM
 42620                                  	db	32
 42621                                  
 42622                                  	db	blank ; 20h		;AN000;pad character
 42623                                  %else
 42624                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 42625                                  	; PCDOS 7.1 COMMAND.COM
 42626                                  dirmes_w_ptr:
 42627 0000901C FB03                    	dw	1019
 42628 0000901E 01                      	db	1
 42629 0000901F 0B                      	db	11
 42630 00009020 00                      	db	0
 42631 00009021 [069E]                  	dw	Dir_Num
 42632 00009023 0000                    	dw	0
 42633 00009025 01                      	db	1
 42634 00009026 F1                      	db	0F1h			; long binary to decimal
 42635 00009027 0A                      	db	10
 42636 00009028 0A                      	db	10
 42637 00009029 20                      	db	20h
 42638                                  dirmes2_ptr:
 42639 0000902A FB03                    	dw	1019
 42640 0000902C 01                      	db	1
 42641 0000902D 0B                      	db	11
 42642 0000902E 00                      	db	0
 42643 0000902F [069E]                  	dw	Dir_Num
 42644 00009031 0000                    	dw	0
 42645 00009033 01                      	db	1
 42646 00009034 B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 42647 00009035 09                      	db	9
 42648 00009036 09                      	db	9
 42649 00009037 20                      	db	20h
 42650                                  bytmes1_ptr:
 42651 00009038 FC03                    	dw	1020
 42652 0000903A 01                      	db	1
 42653 0000903B 0B                      	db	11
 42654 0000903C 00                      	db	0
 42655 0000903D [089E]                  	dw	Bytes_Free
 42656 0000903F 0000                    	dw	0
 42657 00009041 01                      	db	1
 42658 00009042 F1                      	db	0F1h			; long binary to decimal
 42659 00009043 1E                      	db	30			; maximum width
 42660 00009044 1E                      	db	30			; minimum width
 42661 00009045 20                      	db	20h			; blank
 42662                                  bytmes2_ptr:
 42663 00009046 FC03                    	dw	1020
 42664 00009048 01                      	db	1
 42665 00009049 0B                      	db	11
 42666 0000904A 00                      	db	0
 42667 0000904B [089E]                  	dw 	Bytes_Free
 42668 0000904D 0000                    	dw	0
 42669 0000904F 01                      	db	1
 42670 00009050 F1                      	db	0F1h			; long binary to decimal
 42671 00009051 21                      	db	33			; maximum width
 42672 00009052 21                      	db	33			; minimum width
 42673 00009053 20                      	db	20h			; pad
 42674                                  bytmes_n_ptr:
 42675 00009054 FC03                    	dw	1020
 42676 00009056 01                      	db	1
 42677 00009057 0B                      	db	11			; parm_block_size
 42678 00009058 00                      	db	0
 42679 00009059 [089E]                  	dw	Bytes_Free
 42680 0000905B 0000                    	dw	0
 42681 0000905D 01                      	db	1
 42682 0000905E B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 42683 0000905F 1C                      	db	28
 42684 00009060 1C                      	db	28
 42685 00009061 20                      	db	20h
 42686                                  %endif
 42687                                  
 42688                                  ;  "Invalid drive specification",13,10
 42689                                  baddrv_ptr:
 42690 00009062 FD03                    	dw	1021			;AN000;message number
 42691 00009064 00                      	db	no_subst ; 0		;AN000;number of subst
 42692                                  
 42693                                  ;  "Code page %1 not prepared for system",13,10
 42694                                  cp_not_set_ptr:
 42695 00009065 FE03                    	dw	1022			;AN000;message number
 42696 00009067 01                      	db	1			;AN000;number of subst
 42697 00009068 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42698 00009069 00                      	db	0			;AN000;reserved
 42699 0000906A [FB9D]                  	dw	system_cpage		;AN000;offset of arg
 42700 0000906C 0000                    	dw	0			;AN000;segment of arg
 42701 0000906E 01                      	db	1			;AN000;first subst
 42702 0000906F A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42703                                  					;AN000;binary to decimal
 42704 00009070 05                      	db	5			;AN000;maximum width
 42705 00009071 01                      	db	1			;AN000;minimum width
 42706 00009072 20                      	db	blank ; 20h		;AN000;pad character
 42707                                  
 42708                                  ;  "Code page %1 not prepared for all devices",13,10
 42709                                  cp_not_all_ptr:
 42710 00009073 FF03                    	dw	1023			;AN000;message number
 42711 00009075 01                      	db	1			;AN000;number of subst
 42712 00009076 0B                      	db	parm_block_size ; 11 	;AN000;size of sublist
 42713 00009077 00                      	db	0			;AN000;reserved
 42714 00009078 [FB9D]                  	dw	system_cpage		;AN000;offset of arg
 42715 0000907A 0000                    	dw	0			;AN000;segment of arg
 42716 0000907C 01                      	db	1			;AN000;first subst
 42717 0000907D A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42718                                  					;AN000;binary to decimal
 42719 0000907E 05                      	db	5			;AN000;maximum width
 42720 0000907F 01                      	db	1			;AN000;minimum width
 42721 00009080 20                      	db	blank ; 20h		;AN000;pad character
 42722                                  
 42723                                  ;  "Active code page: %1",13,10
 42724                                  cp_active_ptr:
 42725 00009081 0004                    	dw	1024			;AN000;message number
 42726 00009083 01                      	db	1			;AN000;number of subst
 42727 00009084 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42728 00009085 00                      	db	0			;AN000;reserved
 42729 00009086 [FB9D]                  	dw	system_cpage		;AN000;offset of arg
 42730 00009088 0000                    	dw	0			;AN000;segment of arg
 42731 0000908A 01                      	db	1			;AN000;first subst
 42732 0000908B A1                      	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42733                                  					;AN000;binary to decimal
 42734 0000908C 05                      	db	5			;AN000;maximum width
 42735 0000908D 01                      	db	1			;AN000;minimum width
 42736 0000908E 20                      	db	blank ; 20h		;AN000;pad character
 42737                                  
 42738                                  ;  "NLSFUNC not installed",13,10
 42739                                  NLSFUNC_PTR:
 42740 0000908F 0104                    	dw	1025			;AN000;message number
 42741 00009091 00                      	db	no_subst ; 0		;AN000;number of subst
 42742                                  
 42743                                  ;  "Invalid code page",13,10
 42744                                  INV_CODE_PAGE:
 42745 00009092 0204                    	dw	1026			;AN000;message number
 42746 00009094 00                      	db	no_subst ; 0		;AN000;number of subst
 42747                                  
 42748                                  ;  "Current drive is no longer valid"
 42749                                  BADCURDRV:
 42750 00009095 0304                    	dw	1027			;AN000;message number
 42751 00009097 00                      	db	no_subst ; 0		;AN000;number of subst
 42752                                  
 42753                                  ;  "Press any key to continue"
 42754                                  PAUSEMES_PTR:
 42755 00009098 0404                    	dw	1028			;AN000;message number
 42756 0000909A 00                      	db	no_subst ; 0		;AN000;number of subst
 42757                                  
 42758                                  ;  "Label not found",13,10
 42759                                  BADLAB_PTR:
 42760 0000909B 0504                    	dw	1029			;AN000;message number
 42761 0000909D 00                      	db	no_subst ; 0		;AN000;number of subst
 42762                                  
 42763                                  ;  "Syntax error",13,10
 42764                                  SYNTMES_PTR:
 42765 0000909E 0604                    	dw	1030			;AN000;message number
 42766 000090A0 00                      	db	no_subst ; 0		;AN000;number of subst
 42767                                  
 42768                                  ;  "Invalid date",13,10
 42769                                  BADDAT_PTR:
 42770 000090A1 0704                    	dw	1031			;AN000;message number
 42771 000090A3 00                      	db	no_subst ; 0		;AN000;number of subst
 42772                                  
 42773                                  ;  "Current date is %1 %2",13,10
 42774                                  CurDat_Ptr:
 42775 000090A4 0804                    	dw	1032			;AN000;message number
 42776 000090A6 02                      	db	2			;AN000;number of subst
 42777 000090A7 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42778 000090A8 00                      	db	0			;AN000;reserved
 42779 000090A9 [F5A3]                  	dw	Arg_Buf			;AN000;offset of arg
 42780 000090AB 0000                    	dw	0			;AN000;segment of arg
 42781 000090AD 01                      	db	1			;AN000;first subst
 42782 000090AE 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42783 000090AF 03                      	db	3			;AN000;maximum width
 42784 000090B0 03                      	db	3			;AN000;minimum width
 42785 000090B1 20                       	db	blank ; 20h		;AN000;pad character
 42786 000090B2 0B                      	db	parm_block_size 	;AN000;size of sublist
 42787 000090B3 00                      	db	0			;AN000;reserved
 42788                                  CurDat_yr:
 42789 000090B4 0000                    	dw	0			;AN000;year
 42790                                  CurDat_mo_day:
 42791 000090B6 0000                    	dw	0			;AN000;month,day
 42792 000090B8 02                      	db	2			;AN000;second subst
 42793 000090B9 34                      	db	34h ; DATE_MDY_4	;AN000;date
 42794 000090BA 0A                      	db	10			;AN000;maximum width
 42795 000090BB 0A                      	db	10			;AN000;minimum width
 42796 000090BC 20                      	db	blank ; 20h		;AN000;pad character
 42797                                  
 42798                                  ;  "SunMonTueWedThuFriSat"
 42799                                  WeekTab:
 42800 000090BD 0904                    	dw	1033			;AN000;message number
 42801 000090BF 00                      	db	no_subst ; 0		;AN000;number of subst
 42802                                  
 42803                                  ;  "Enter new date (%1):"
 42804                                  
 42805                                  NewDat_Ptr:
 42806 000090C0 0A04                    	dw	1034			;AN000;message number
 42807 000090C2 01                      	db	1			;AN000;number of subst
 42808 000090C3 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42809 000090C4 00                      	db	0			;AN000;reserved
 42810                                  NewDat_Format:
 42811 000090C5 0000                    	dw	0			;AN000;offset of replacement
 42812 000090C7 0000                    	dw	0			;AN000;segment of arg
 42813 000090C9 01                      	db	1			;AN000;first subst
 42814 000090CA 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42815 000090CB 08                      	db	8			;AN000;maximum width
 42816 000090CC 08                      	db	8			;AN000;minimum width
 42817 000090CD 20                      	db	blank ; 20h		;AN000;pad character
 42818                                  
 42819                                  ;  "Invalid time",13,10
 42820                                  
 42821                                  BadTim_Ptr:
 42822 000090CE 0B04                    	dw	1035			;AN000;message number
 42823 000090D0 00                      	db	no_subst ; 0		;AN000;number of subst
 42824                                  
 42825                                  ;  "Current time is %1",13,10
 42826                                  CurTim_Ptr:
 42827 000090D1 0C04                    	dw	1036			;AN000;message number
 42828 000090D3 01                      	db	1			;AN000;number of subst
 42829 000090D4 0B                      	db	parm_block_size 	;AN000;size of sublist
 42830 000090D5 00                      	db	0			;AN000;reserved
 42831                                  CurTim_hr_min:
 42832 000090D6 0000                    	dw	0			;AN000;hours,minutes
 42833                                  CurTim_Sec_hn:
 42834 000090D8 0000                    	dw	0			;AN000;seconds,hundredths
 42835 000090DA 01                      	db	1			;AN000;first subst
 42836 000090DB A5                      	db	0A5h ; Right_Align+TIME_HHMMSSHH_Cty
 42837                                  					;AC059;time
 42838 000090DC 0C                      	db	12			;AC059;maximum width
 42839 000090DD 0C                      	db	12			;AC059;minimum width
 42840 000090DE 20                      	db	blank ; 20h		;AN000;pad character
 42841                                  
 42842                                  ;  "Enter new time:"
 42843                                  NewTim_Ptr:
 42844 000090DF 0D04                    	dw	1037			;AN000;message number
 42845 000090E1 00                      	db	no_subst ; 0		;AN000;number of subst
 42846                                  
 42847                                  ;  ",    Delete (Y/N)?",13,10
 42848                                  Del_Y_N_Ptr:
 42849 000090E2 0E04                    	dw	1038			;AN000;message number
 42850 000090E4 00                      	db	no_subst ; 0		;AN000;number of subst
 42851                                  
 42852                                  ;  "All files in directory will be deleted!",13,10
 42853                                  ;  "Are you sure (Y/N)?",13,10
 42854                                  SureMes_Ptr:
 42855 000090E5 0F04                    	dw	1039			;AN000;message number
 42856 000090E7 00                      	db	no_subst ; 0		;AN000;number of subst
 42857                                  
 42858                                  ;  "Microsoft DOS Version %1.%2",13,10
 42859                                  VerMes_Ptr:
 42860 000090E8 1004                    	dw	1040			;AN000;message number
 42861                                  
 42862                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 42863                                  %if 0
 42864                                  	db	2			;AN000;number of subst
 42865                                  	db	parm_block_size ; 11 	;AN000;size of sublist
 42866                                  	db	0			;AN000;reserved
 42867                                  	dw	Major_Ver_Num		;AN000;offset of arg
 42868                                  	dw	0			;AN000;segment of arg
 42869                                  	db	1			;AN000;first subst
 42870                                  	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42871                                  					;AN000;binary to decimal
 42872                                  	db	1			;AN000;maximum width
 42873                                  	db	1			;AN000;minimum width
 42874                                  	db	blank ; 20h		;AN000;pad character
 42875                                  	db	parm_block_size ; 11	;AN000;size of sublist
 42876                                  	db	0			;AN000;reserved
 42877                                  	dw	Minor_Ver_Num	;AN000;offset of arg
 42878                                  	dw	0			;AN000;segment of arg
 42879                                  	db	2			;AN000;second subst
 42880                                  	db	0A1h ; Right_Align+Unsgn_Bin_Word
 42881                                  					;AN000;binary to decimal
 42882                                  	db	2			;AN000;maximum width
 42883                                  	db	2			;AN000;minimum width
 42884                                  	db	'0' ; 30h		;AN000;pad character
 42885                                  %else
 42886 000090EA 00                      	db	0	; no_subst
 42887                                  %endif
 42888                                  
 42889                                  ;  "Volume in drive %1 has no label",13,10
 42890                                  VolMes_Ptr_2:
 42891 000090EB 1104                    	dw	1041			;AN000;message number
 42892 000090ED 01                      	db	1			;AN000;number of subst
 42893 000090EE 0B                      	db	parm_block_size ; 11  	;AN000;size of sublist
 42894 000090EF 00                      	db	0			;AN000;reserved
 42895 000090F0 [129E]                  	dw	vol_drv			;AN000;offset of drive
 42896 000090F2 0000                    	dw	0			;AN000;segment of arg
 42897 000090F4 01                      	db	1			;AN000;first subst
 42898 000090F5 00                      	db	0 ; Char_field_Char 	;AN000;character
 42899 000090F6 80                      	db	128			;AN000;maximum width
 42900 000090F7 01                      	db	1			;AN000;minimum width
 42901 000090F8 20                      	db	blank ; 20h		;AN000;pad character
 42902                                  
 42903                                  ;  "Volume in drive %1 is %2",13,10
 42904                                  VolMes_Ptr:
 42905 000090F9 1204                    	dw	1042			;AN000;message number
 42906 000090FB 02                      	db	2			;AN000;number of subst
 42907 000090FC 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42908 000090FD 00                      	db	0			;AN000;reserved
 42909 000090FE [129E]                  	dw	vol_drv			;AN000;offset of drive
 42910 00009100 0000                    	dw	0			;AN000;segment of arg
 42911 00009102 01                      	db	1			;AN000;first subst
 42912 00009103 00                      	db	00000000b		;AN000;character
 42913 00009104 80                      	db	128			;AN000;maximum width
 42914 00009105 01                      	db	1			;AN000;minimum width
 42915 00009106 20                      	db	blank ; 20h		;AN000;pad character
 42916 00009107 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42917 00009108 00                      	db	0			;AN000;reserved
 42918 00009109 [CB9C]                  	dw	CHARBUF			;AN000;offset of string
 42919 0000910B 0000                    	dw	0			;AN000;segment of arg
 42920 0000910D 02                      	db	2			;AN000;second subst
 42921 0000910E 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42922 0000910F 80                      	db	128			;AN000;maximum width
 42923 00009110 01                      	db	1			;AN000;minimum width
 42924 00009111 20                      	db	blank ; 20h		;AN000;pad character
 42925                                  
 42926                                  ;  "Volume Serial Number is %1-%2",13,10
 42927                                  VolSerMes_Ptr:
 42928 00009112 1304                    	dw	1043			;AN000;message number
 42929 00009114 02                      	db	2			;AN000;number of subst
 42930 00009115 0B                      	db	parm_block_size ; 11  	;AN000;size of sublist
 42931 00009116 00                      	db	0			;AN000;reserved
 42932 00009117 [7C9F]                  	dw	vol_serial+2		;AN000;offset of serial
 42933 00009119 0000                    	dw	0			;AN000;segment of arg
 42934 0000911B 01                      	db	1			;AN000;first subst
 42935 0000911C A3                      	db	0A3h ; Right_Align+Bin_Hex_Word 
 42936                                  					;AN000;binary to hex
 42937 0000911D 04                      	db	4			;AN000;maximum width
 42938 0000911E 04                      	db	4			;AN000;minimum width
 42939 0000911F 30                      	db	'0' ; 30h		;AN000;pad character
 42940 00009120 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 42941 00009121 00                      	db	0			;AN000;reserved
 42942 00009122 [7A9F]                  	dw	vol_serial		;AN000;offset of serial
 42943 00009124 0000                    	dw	0			;AN000;segment of arg
 42944 00009126 02                      	db	2			;AN000;second subst
 42945 00009127 A3                      	db	0A3h ; Right_Align+Bin_Hex_Word
 42946                                  					;AN000;binary to hex
 42947 00009128 04                      	db	4			;AN000;maximum width
 42948 00009129 04                      	db	4			;AN000;minimum width
 42949 0000912A 30                      	db	'0' ; 30h		;AN000;pad character
 42950                                  
 42951                                  ;  "Invalid directory",13,10
 42952                                  badcd_ptr:
 42953 0000912B 1404                    	dw	1044			;AN000;message number
 42954 0000912D 00                      	db	no_subst ; 0		;AN000;number of subst
 42955                                  
 42956                                  ;  "Unable to create directory",13,10
 42957                                  badmkd_ptr:
 42958 0000912E 1504                    	dw	1045			;AN000;message number
 42959 00009130 00                      	db	no_subst ; 0		;AN000;number of subst
 42960                                  
 42961                                  ;  "Invalid path, not directory,",13,10
 42962                                  ;  "or directory not empty",13,10
 42963                                  badrmd_ptr:
 42964 00009131 1604                    	dw	1046			;AN000;message number
 42965 00009133 00                      	db	no_subst ; 0		;AN000;number of subst
 42966                                  
 42967                                  ;  "Must specify ON or OFF",13,10
 42968                                  bad_on_off_ptr:
 42969 00009134 1704                    	dw	1047			;AN000;message number
 42970 00009136 00                      	db	no_subst ; 0		;AN000;number of subst
 42971                                  
 42972                                  ;  "Directory of %1",13,10
 42973                                  dirhead_ptr:
 42974 00009137 1804                    	dw	1048			;AN000;message number
 42975 00009139 01                      	db	1			;AN000;number of subst
 42976 0000913A 0B                      	db	parm_block_size ; 11 	;AN000;size of sublist
 42977 0000913B 00                      	db	0			;AN000;reserved
 42978 0000913C [9A9D]                  	dw	BWDBUF			;AN000;offset of arg
 42979 0000913E 0000                    	dw	0			;AN000;segment of arg
 42980 00009140 01                      	db	1			;AN000;first subst
 42981 00009141 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 42982 00009142 80                      	db	128			;AN000;maximum width
 42983 00009143 00                      	db	0			;AN000;minimum width
 42984 00009144 20                      	db	blank ; 20h		;AN000;pad character
 42985                                  
 42986                                  ;  "No Path",13,10
 42987                                  NULLPATH_PTR:
 42988 00009145 1904                    	dw	1049			;AN000;message number
 42989 00009147 00                      	db	no_subst ; 0		;AN000;number of subst
 42990                                  
 42991                                  ;  "Invalid drive in search path",13,10
 42992                                  BADPMES_PTR:
 42993 00009148 1A04                    	dw	1050			;AN000;message number
 42994 0000914A 00                      	db	no_subst ; 0		;AN000;number of subst
 42995                                  
 42996                                  ;  "Invalid device",13,10
 42997                                  BADDEV_PTR:
 42998 0000914B 1B04                    	dw	1051			;AN000;message number
 42999 0000914D 00                      	db	no_subst ; 0		;AN000;number of subst
 43000                                  
 43001                                  ;  "FOR cannot be nested",13,10
 43002                                  FORNESTMES_PTR:
 43003 0000914E 1C04                    	dw	1052			;AN000;message number
 43004 00009150 00                      	db	no_subst ; 0		;AN000;number of subst
 43005                                  
 43006                                  ;  "Intermediate file error during pipe",13,10
 43007                                  PIPEEMES_PTR:
 43008 00009151 1D04                    	dw	1053			;AN000;message number
 43009 00009153 00                      	db	no_subst ; 0		;AN000;number of subst
 43010                                  
 43011                                  ;  "Cannot do binary reads from a device",13,10
 43012                                  INBDEV_PTR:
 43013 00009154 1E04                    	dw	1054			;AN000;message number
 43014 00009156 00                      	db	no_subst ; 0		;AN000;number of subst
 43015                                  
 43016                                  ;  "BREAK is %1",13,10
 43017                                  CtrlcMes_Ptr:
 43018 00009157 1F04                    	dw	1055			;AN000;message number
 43019 00009159 01                      	db	1			;AN000;number of subst
 43020 0000915A 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43021 0000915B 00                      	db	0			;AN000;reserved
 43022 0000915C 0000                    	dw	0			;AN000;offset of on/off (new)
 43023 0000915E 0000                    	dw	0			;AN000;segment of arg
 43024 00009160 01                      	db	1			;AN000;first subst
 43025 00009161 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43026 00009162 80                      	db	128			;AN000;maximum width
 43027 00009163 01                      	db	1			;AN000;minimum width
 43028 00009164 20                      	db	blank ; 20h		;AN000;pad character
 43029                                  
 43030                                  ;  "VERIFY is %1",13,10
 43031                                  VeriMes_Ptr:
 43032 00009165 2004                    	dw	1056			;AN000;message number
 43033 00009167 01                      	db	1			;AN000;number of subst
 43034 00009168 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43035 00009169 00                      	db	0			;AN000;reserved
 43036 0000916A 0000                    	dw	0			;AN000;offset of on/off (new)
 43037 0000916C 0000                    	dw	0			;AN000;segment of arg
 43038 0000916E 01                      	db	1			;AN000;first subst
 43039 0000916F 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43040 00009170 80                      	db	128			;AN000;maximum width
 43041 00009171 01                      	db	1			;AN000;minimum width
 43042 00009172 20                      	db	blank ; 20h		;AN000;pad character
 43043                                  
 43044                                  ;  "ECHO is %1",13,10
 43045                                  EchoMes_Ptr:
 43046 00009173 2104                    	dw	1057			;AN000;message number
 43047 00009175 01                      	db	1			;AN000;number of subst
 43048 00009176 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43049 00009177 00                      	db	0			;AN000;reserved
 43050 00009178 0000                    	dw	0			;AN000;offset of on/off (new)
 43051 0000917A 0000                    	dw	0			;AN000;segment of arg
 43052 0000917C 01                      	db	1			;AN000;first subst
 43053 0000917D 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43054 0000917E 80                      	db	128			;AN000;maximum width
 43055 0000917F 01                      	db	1			;AN000;minimum width
 43056 00009180 20                      	db	blank ; 20h		;AN000;pad character
 43057                                  
 43058                                  ;  "off"
 43059                                  OFFMES_PTR:
 43060 00009181 2304                    	dw	1059			;AN000;message number
 43061 00009183 00                      	db	no_subst		;AN000;number of subst
 43062                                  ;  "on"
 43063                                  ONMES_PTR:
 43064 00009184 2404                    	dw	1060			;AN000;message number
 43065 00009186 00                      	db	no_subst ; 0		;AN000;number of subst
 43066                                  
 43067                                  ;  "Error writing to device",13,10
 43068                                  DEVWMES_PTR:
 43069 00009187 2504                    	dw	1061			;AN000;message number
 43070 00009189 00                      	db	no_subst ; 0		;AN000;number of subst
 43071                                  
 43072                                  ;  "Invalid path",13,10
 43073                                  INVAL_PATH_PTR:
 43074 0000918A 2604                    	dw	1062			;AN000;message number
 43075 0000918C 00                      	db	no_subst ; 0		;AN000;number of subst
 43076                                  
 43077                                  ;  unformatted string output
 43078                                  arg_buf_ptr:
 43079 0000918D 2704                    	dw	1063			;AN000;message number
 43080 0000918F 01                      	db	1			;AN000;number of subst
 43081 00009190 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43082 00009191 00                      	db	0			;AN000;reserved
 43083 00009192 [F5A3]                  	dw	Arg_Buf 		;AN000;offset of arg
 43084 00009194 0000                    	dw	0			;AN000;segment of arg
 43085 00009196 01                      	db	1			;AN000;first subst
 43086 00009197 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43087 00009198 80                      	db	128			;AN000;maximum width
 43088 00009199 00                      	db	0			;AN000;minimum width
 43089 0000919A 20                      	db	blank ; 20h		;AN000;pad character
 43090                                  
 43091                                  ;  file name output
 43092                                  file_name_ptr:
 43093 0000919B 2804                    	dw	1064			;AN000;message number
 43094 0000919D 01                      	db	1			;AN000;number of subst
 43095 0000919E 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43096 0000919F 00                      	db	0			;AN000;reserved
 43097 000091A0 [809E]                  	dw	SrcBuf			;AN000;offset of arg
 43098 000091A2 0000                    	dw	0			;AN000;segment of arg
 43099 000091A4 01                      	db	1			;AN000;first subst
 43100 000091A5 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43101 000091A6 80                      	db	128			;AN000;maximum width
 43102 000091A7 00                      	db	0			;AN000;minimum width
 43103 000091A8 20                      	db	blank ; 20h		;AN000;pad character
 43104                                  
 43105                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43106                                  %if 0
 43107                                  
 43108                                  ;  file size output for dir
 43109                                  disp_file_size_ptr:
 43110                                  	dw	1065			;AN000;message number
 43111                                  	db	1			;AN000;number of subst
 43112                                  	db	parm_block_size ; 11 	;AN000;size of sublist
 43113                                  	db	0			;AN000;reserved
 43114                                  	dw	File_Size_Low		;AN000;offset of arg
 43115                                  	dw	0			;AN000;segment of arg
 43116                                  	db	1			;AN000;first subst
 43117                                  	; MSDOS 5.0 COMMAND.COM
 43118                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 43119                                  	; 17/06/2023
 43120                                  screen_f_1:
 43121                                  	db	0F1h ; MSDOS 6.22 COMMAND.COM
 43122                                  					;AN000;long binary to decimal
 43123                                  	; MSDOS 5.0 COMMAND.COM
 43124                                  	;db	10			;AN000;maximum width
 43125                                  	;db	10			;AN000;minimum width
 43126                                  screen_f_2:
 43127                                  	db	14 ; MSDOS 6.22 COMMAND.COM		
 43128                                  	db	14
 43129                                  	
 43130                                  	db	blank ; 20h		;AN000;pad character
 43131                                  %else
 43132                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43133                                  	; PCDOS 7.1 COMMAND.COM
 43134                                  disp_file_size_ptr:
 43135 000091A9 2904                    	dw	1065
 43136 000091AB 01                      	db	1
 43137 000091AC 0B                      	db	11
 43138 000091AD 00                      	db	0
 43139 000091AE [FD9D]                  	dw	File_Size_Low
 43140 000091B0 0000                    	dw	0
 43141 000091B2 01                      	db	1
 43142 000091B3 F1                      	db	0F1h
 43143 000091B4 0C                      	db	12
 43144 000091B5 0C                      	db	12
 43145 000091B6 20                      	db	20h
 43146                                  disp_file_size_w_ptr:
 43147 000091B7 2904                    	dw	1065
 43148 000091B9 01                      	db	1
 43149 000091BA 0B                      	db	11
 43150 000091BB 00                      	db	0
 43151 000091BC [FD9D]                  	dw	File_Size_Low
 43152 000091BE 0000                    	dw	0
 43153 000091C0 01                      	db	1
 43154 000091C1 F1                      	db	0F1h			; long binary to decimal
 43155 000091C2 0E                      	db	14
 43156 000091C3 0E                      	db	14
 43157 000091C4 20                      	db	20h
 43158                                  disp_file_size_n_ptr:
 43159 000091C5 2904                    	dw	1065
 43160 000091C7 01                      	db	1
 43161 000091C8 0B                      	db	11
 43162 000091C9 00                      	db	0
 43163 000091CA [FD9D]                  	dw	File_Size_Low
 43164 000091CC 0000                    	dw	0
 43165 000091CE 01                      	db	1
 43166 000091CF B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 43167 000091D0 0A                      	db	10
 43168 000091D1 0A                      	db	10
 43169 000091D2 20                      	db	20h
 43170                                  %endif
 43171                                  
 43172                                  ;  unformatted string output
 43173                                  ; %s
 43174                                  string_buf_ptr:
 43175 000091D3 2A04                    	dw	1066			;AN000;message number
 43176 000091D5 01                      	db	1			;AN000;number of subst
 43177 000091D6 0B                      	db	parm_block_size 	;AN000;size of sublist
 43178 000091D7 00                      	db	0			;AN000;reserved
 43179 000091D8 [019E]                  	dw	string_ptr_2		;AN000;offset of arg
 43180 000091DA 0000                    	dw	0			;AN000;segment of arg
 43181 000091DC 01                      	db	1			;AN000;first subst
 43182 000091DD 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43183 000091DE 80                      	db	128			;AN000;maximum width
 43184 000091DF 00                      	db	0			;AN000;minimum width
 43185 000091E0 20                      	db	blank ; 20h		;AN000;pad character
 43186 000091E1 00                      	db	0			;AN000;
 43187                                  
 43188                                  ;  tab character
 43189                                  tab_ptr:
 43190 000091E2 2B04                    	dw	1067			;AN000;message number
 43191 000091E4 00                      	db	no_subst ; 0		;AN000;number of subst
 43192                                  
 43193                                  ;  " <DIR>   "
 43194                                  dmes_ptr:
 43195 000091E5 2C04                    	dw	1068			;AN000;message number
 43196 000091E7 00                      	db	no_subst ; 0		;AN000;number of subst
 43197                                  
 43198                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43199                                  space_4_ptr :
 43200 000091E8 5104                    	dw	1105 
 43201 000091EA 00                      	db	no_subst ; 0
 43202                                  
 43203                                  ;  destructive back space
 43204                                  dback_ptr:
 43205 000091EB 2D04                    	dw	1069			;AN000;message number
 43206 000091ED 00                      	db	no_subst ; 0		;AN000;number of subst
 43207                                  
 43208                                  ;  carriage return / line feed
 43209                                  acrlf_ptr:
 43210 000091EE 2E04                    	dw	1070			;AN000;message number
 43211 000091F0 00                      	db	no_subst ; 0		;AN000;number of subst
 43212                                  
 43213                                  ;  "mm-dd-yy"
 43214                                  usadat_ptr:
 43215 000091F1 3004                    	dw	1072			;AN000;message number
 43216 000091F3 00                      	db	no_subst ; 0		;AN000;number of subst
 43217                                  
 43218                                  ;  "dd-mm-yy"
 43219                                  eurdat_ptr:
 43220 000091F4 3104                    	dw	1073			;AN000;message number
 43221 000091F6 00                      	db	no_subst ; 0		;AN000;number of subst
 43222                                  
 43223                                  ;  "yy-mm-dd"
 43224                                  japdat_ptr:
 43225 000091F7 3204                    	dw	1074			;AN000;message number
 43226 000091F9 00                      	db	no_subst ; 0		;AN000;number of subst
 43227                                  
 43228                                  ;  date string for prompt
 43229                                  promptdat_ptr:
 43230 000091FA 3304                    	dw	1075			;AN000;message number
 43231 000091FC 02                      	db	2			;AN000;number of subst
 43232 000091FD 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43233 000091FE 00                      	db	0			;AN000;reserved
 43234 000091FF [F5A3]                  	dw	Arg_Buf			;AN000;offset of arg
 43235 00009201 0000                    	dw	0			;AN000;segment of arg
 43236 00009203 01                      	db	1			;AN000;first subst
 43237 00009204 10                      	db	10h ; Char_field_ASCIIZ ;AN000;character string
 43238 00009205 03                      	db	3			;AN000;maximum width
 43239 00009206 03                      	db	3			;AN000;minimum width
 43240 00009207 20                       	db	blank ; 20h		;AN000;pad character
 43241 00009208 0B                      	db	parm_block_size  ; 11	;AN000;size of sublist
 43242 00009209 00                      	db	0			;AN000;reserved
 43243                                  promptDat_yr:
 43244 0000920A 0000                    	dw	0			;AN000;year
 43245                                  promptDat_moday:
 43246 0000920C 0000                    	dw	0			;AN000;month,day
 43247 0000920E 02                      	db	2			;AN000;second subst
 43248 0000920F 34                       	db	34h ; DATE_MDY_4	;AN000;date
 43249 00009210 0A                      	db	10			;AN000;maximum width
 43250 00009211 08                      	db	8			;AN000;minimum width
 43251 00009212 20                      	db	blank ; 20h		;AN000;pad character
 43252                                  
 43253                                  ;  Time for prompt
 43254                                  promtim_ptr:
 43255 00009213 3404                    	dw	1076			;AN000;message number
 43256 00009215 01                      	db	1			;AN000;number of subst
 43257 00009216 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43258 00009217 00                      	db	0			;AN000;reserved
 43259                                  PromTim_hr_min:
 43260 00009218 0000                    	dw	0			;AN000;hours,minutes
 43261                                  PromTim_Sec_hn:
 43262 0000921A 0000                    	dw	0			;AN000;seconds,hundredths
 43263 0000921C 01                      	db	1			;AN000;first subst
 43264 0000921D A6                      	db	0A6h ; Right_Align+TIME_HHMMSSHH_24
 43265                                  					;AC013;time
 43266 0000921E 0B                      	db	11			;AN000;maximum width
 43267 0000921F 0B                      	db	11			;AC013;minimum width
 43268 00009220 20                      	db	blank ; 20h		;AN000;pad character
 43269                                  
 43270                                  ;  Date and time for DIR
 43271                                  dirdattim_ptr:
 43272 00009221 3504                    	dw	1077			;AN000;message number
 43273 00009223 02                      	db	2			;AN000;number of subst
 43274 00009224 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43275 00009225 00                      	db	0			;AN000;reserved
 43276                                  DirDat_Yr:
 43277 00009226 0000                    	dw	0			;AN000;year
 43278                                  DirDat_Mo_Day:
 43279 00009228 0000                    	dw	0			;AN000;month,day
 43280 0000922A 01                      	db	1			;AN000;first subst
 43281                                  DirDat_form:	; 03/08/2024 - PCDOS 7.1
 43282 0000922B A4                      	db	0A4h ; Right_Align+DATE_MDY_2
 43283                                  					;AN000;date
 43284                                  DirDat_width:	; 03/08/2024 - PCDOS 7.1	
 43285 0000922C 0A                      	db	10			;AN000;maximum width
 43286 0000922D 08                      	db	8			;AN000;minimum width
 43287 0000922E 20                      	db	blank ; 20h		;AN000;pad character
 43288 0000922F 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43289 00009230 00                      	db	0			;AN000;reserved
 43290                                  DirTim_Hr_Min:
 43291 00009231 0000                    	dw	0			;AN000;hours,minutes
 43292                                  DirTim_Sec_hn:
 43293 00009233 0000                    	dw	0			;AN000;seconds,hundredths
 43294 00009235 02                      	db	2			;AN000;second subst
 43295 00009236 85                      	db	85h ; Right_align+TIME_HHMM_Cty
 43296                                  					;AN000;time
 43297 00009237 06                      	db	6			;AN000;maximum width
 43298 00009238 06                      	db	6			;AN000;minimum width
 43299 00009239 20                      	db	blank ; 20h		;AN000;pad character
 43300                                  
 43301                                  ;  "Directory already exists"
 43302                                  MD_EXISTS_PTR:
 43303 0000923A 3604                    	dw	1078			;AN000;message number
 43304 0000923C 00                      	db	no_subst		;AN000;number of subst
 43305                                  
 43306                                  ;  "%1 bytes",13,10
 43307                                  
 43308                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 43309                                  %if 0
 43310                                  bytes_ptr:
 43311                                  	dw	1079			; message number
 43312                                  	db	1			; number of subst
 43313                                  	db	parm_block_size ; 11	; size of sublist
 43314                                  	db	0			; reserved
 43315                                  	dw	FileSiz			; offset of arg
 43316                                  	dw	0			; segment of arg
 43317                                  	db	1			; first subst
 43318                                  	; MSDOS 5.0 COMMAND.COM
 43319                                  	;db	0B1h ; Right_Align+Unsgn_Bin_DWord
 43320                                  	; 17/06/2023
 43321                                  screen_f_4:
 43322                                  	db	0F1h ; MSDOS 6.22 COMMAND.COM
 43323                                  					; long binary to decimal
 43324                                  	; MSDOS 5.0 COMMAND.COM
 43325                                  	;db	10			; maximum width
 43326                                  	;db	10			; minimum width
 43327                                  screen_f_5:
 43328                                  	db	14 ; MSDOS 6.22 COMMAND.COM
 43329                                  	db	14	
 43330                                  	db	blank ; 20h		; pad character
 43331                                  %else
 43332                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43333                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9718h
 43334                                  bytes_ptr:
 43335 0000923D 3704                    	dw	1079
 43336 0000923F 01                      	db	1
 43337 00009240 0B                      	db	11
 43338 00009241 00                      	db	0
 43339 00009242 [839C]                  	dw	FileSiz
 43340 00009244 0000                    	dw	0
 43341 00009246 01                      	db	1
 43342 00009247 F1                      	db	0F1h
 43343 00009248 0C                      	db	12
 43344 00009249 0C                      	db	12
 43345 0000924A 20                      	db	20h
 43346                                  bytes_w_tr:
 43347 0000924B 3704                    	dw	1079
 43348 0000924D 01                      	db	1
 43349 0000924E 0B                      	db	11
 43350 0000924F 00                      	db	0
 43351 00009250 [839C]                  	dw	FileSiz
 43352 00009252 0000                    	dw	0
 43353 00009254 01                      	db	1
 43354 00009255 F1                      	db	0F1h
 43355 00009256 0E                      	db	14
 43356 00009257 0E                      	db	14
 43357 00009258 20                      	db	20h
 43358                                  bytes_n_ptr:
 43359 00009259 3704                    	dw	1079
 43360 0000925B 01                      	db	1
 43361 0000925C 0B                      	db	11
 43362 0000925D 00                      	db	0
 43363 0000925E B1                      	db	0B1h
 43364 0000925F A0                      	db	160
 43365 00009260 00                      	db	0
 43366 00009261 00                      	db	0
 43367 00009262 01                      	db	1
 43368 00009263 B1                      	db	0B1h
 43369 00009264 0A                      	db	10
 43370 00009265 0A                      	db	10
 43371 00009266 20                      	db	20h
 43372                                  kbytes_ptr:
 43373 00009267 5304                    	dw	1107
 43374 00009269 01                      	db	1
 43375 0000926A 0B                      	db	11
 43376 0000926B 00                      	db	0
 43377 0000926C B1                      	db	0B1h
 43378 0000926D A0                      	db	160
 43379 0000926E 00                      	db	0
 43380 0000926F 00                      	db	0
 43381 00009270 01                      	db	1
 43382 00009271 F1                      	db	0F1h
 43383 00009272 0E                      	db	14
 43384 00009273 0E                      	db	14
 43385 00009274 20                      	db	20h
 43386                                  kybytes_n_ptr:
 43387 00009275 5304                    	dw	1107
 43388 00009277 01                      	db	1
 43389 00009278 0B                      	db	11
 43390 00009279 00                      	db	0
 43391 0000927A [839C]                  	dw	FileSiz
 43392 0000927C 0000                    	dw	0
 43393 0000927E 01                      	db	1
 43394 0000927F B1                      	db	0B1h
 43395 00009280 0A                      	db	10
 43396 00009281 0A                      	db	10
 43397 00009282 20                      	db	20h
 43398                                  %endif
 43399                                  
 43400                                  ;  "Total:",13,10
 43401                                  total_ptr:
 43402 00009283 3804                    	dw	1080			; message number
 43403 00009285 00                      	db	no_subst ; 0		; number of subst
 43404                                  
 43405                                  ;  "Error parsing environment variable:",13,10
 43406                                  errparsenv_ptr:
 43407 00009286 3904                    	dw	1081			; message number
 43408 00009288 00                      	db	no_subst ; 0		; number of subst
 43409                                  
 43410                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43411                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:996Ah)
 43412                                  cox_Y_quest_ptr:
 43413 00009289 3A04                    	dw	1082
 43414 0000928B 00                      	db	no_subst ; 0
 43415                                  cox_Y_answ_ptr:
 43416 0000928C 3B04                    	dw	1083
 43417 0000928E 00                      	db	no_subst ; 0
 43418                                  
 43419                                  ;  "(continuing %1)",13,10
 43420                                  dircont_ptr:
 43421 0000928F 3C04                    	dw	1084			;AN000;message number
 43422 00009291 01                      	db	1			;AN000;number of subst
 43423 00009292 0B                      	db	parm_block_size ; 11	;AN000;size of sublist
 43424 00009293 00                      	db	0			;AN000;reserved
 43425 00009294 [9A9D]                  	dw	BWDBUF			;AN000;offset of arg
 43426 00009296 0000                    	dw	0			;AN000;segment of arg
 43427 00009298 01                      	db	1			;AN000;first subst
 43428 00009299 10                      	db	10h ; Char_field_ASCIIZ	;AN000;character string
 43429 0000929A 80                      	db	128			;AN000;maximum width
 43430 0000929B 00                      	db	0			;AN000;minimum width
 43431 0000929C 20                      	db	blank ; 20h		;AN000;pad character
 43432                                  
 43433                                  ;  "Revision %1",CR,LF
 43434                                  dosrev_ptr:
 43435 0000929D 4204                    	dw	1090
 43436 0000929F 01                      	db	1			; one substitution
 43437 000092A0 0B                      	db	parm_block_size ; 11
 43438 000092A1 00                      	db	0
 43439 000092A2 [109E]                  	dw	One_Char_Val		; ptr to char
 43440 000092A4 0000                    	dw	0			; segment addr?
 43441 000092A6 01                      	db	1			; 1st substitution
 43442 000092A7 00                      	db	0 ; CHAR_FIELD_CHAR	; character
 43443 000092A8 01                      	db	1			; max width
 43444 000092A9 01                      	db	1			; min width
 43445 000092AA 20                      	db	blank ; 20h		; pad char
 43446                                  
 43447                                  ;  "DOS is in ROM"
 43448                                  DosRom_Ptr:
 43449 000092AB 4304                    	dw	1091
 43450 000092AD 00                      	db	no_subst ; 0		
 43451                                  
 43452                                  ;  "DOS is in HMA"
 43453                                  DosHma_Ptr:
 43454 000092AE 4404                    	dw	1092
 43455 000092B0 00                      	db	no_subst ; 0		
 43456                                  
 43457                                  ;  "DOS is in low memory"
 43458                                  DosLow_Ptr:
 43459 000092B1 4504                    	dw	1093
 43460 000092B3 00                      	db	no_subst ; 0		
 43461                                  
 43462                                  ;  "Cannot Loadhigh batch file" ;M016
 43463                                  NoExecBat_Ptr:
 43464 000092B4 4604                    	dw	1094			; M016
 43465 000092B6 00                      	db	no_subst ; 0		; M016
 43466                                  
 43467                                  ;  "LoadHigh: Invalid filename" ; M016
 43468                                  LhInvFil_Ptr:
 43469 000092B7 4704                    	dw	1095			; M016
 43470 000092B9 00                      	db	no_subst ; 0		; M016
 43471                                  
 43472                                  ;  "Could not open specified country information file" ; M045
 43473                                  NoCntry_Ptr:
 43474 000092BA 4804                    	dw	1096			; M045
 43475 000092BC 00                      	db	no_subst ; 0		; M045
 43476                                  
 43477                                  ; 15/04/2023
 43478                                  ; MSDOS 6.0 COMMAND.COM only !
 43479                                  ; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43480                                  ;%if 0
 43481                                  
 43482                                  ;* The next four errors emulate those reported by the normal parse
 43483                                  ;  mechanism, with a little more accurate wording; that parser has been
 43484                                  ;  replaced with a custom routine (ParseVar) for LoadHigh and DeviceHigh.
 43485                                  ;  These errors aren't normally generated by LoadHigh except by the normal
 43486                                  ;  parser, so they've been added here.
 43487                                  
 43488                                  ;  "LoadHigh: Invalid argument"
 43489                                  LhInvArg_Ptr:
 43490 000092BD 4904                    	dw	1097
 43491 000092BF 00                      	db	no_subst ; 0		
 43492                                  
 43493                                  ;  "Required parameter missing"
 43494                                  ReqParmMiss:
 43495 000092C0 4A04                    	dw	1098
 43496 000092C2 00                      	db	no_subst ; 0		
 43497                                  
 43498                                  ;  "Unrecognized switch"
 43499                                  LhInvSwt_Ptr:
 43500 000092C3 4B04                    	dw	1099
 43501 000092C5 00                      	db	no_subst ; 0		
 43502                                  
 43503                                  ;  "A bad UMB number has been specified"
 43504                                  LhBadUMB_Ptr:
 43505 000092C6 4C04                    	dw	1100
 43506 000092C8 00                      	db	no_subst ; 0
 43507                                  ;%endif	
 43508                                  
 43509                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43510                                  %if 0
 43511                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 43512                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99AAh
 43513                                  
 43514                                  DirCompRatio_Ptr:
 43515                                  	dw	1101			;message number
 43516                                  	db	2			;number of subst
 43517                                  	db	parm_block_size ; 11	;size of sublist
 43518                                  	db	0			;reserved
 43519                                  	dw	Dir_CRatio_1		;offset of arg
 43520                                  	dw	0			;segment of arg
 43521                                  	db	1			;first subst
 43522                                  	db	91h			;format
 43523                                  	db	2			;maximum width
 43524                                  	db	2			;minimum width
 43525                                  	db	blank ; 20h		;pad character
 43526                                  	db	parm_block_size  ; 11	;size of sublist
 43527                                  	db	0			; reserved
 43528                                  	dw	Dir_CRatio_2		;offset of arg
 43529                                  	dw	0			;segment of arg
 43530                                  	db	2			;second subst
 43531                                  	db	11h			;format
 43532                                  	db	1			;maximum width
 43533                                  	db	1			;minimum width
 43534                                  	db	blank ; 20h		;pad character
 43535                                  
 43536                                  AveCompRatio_Ptr:
 43537                                  	dw	1102			;message number
 43538                                  	db	2			;number of subst
 43539                                  	db	parm_block_size ; 11	;size of sublist
 43540                                  	db	0			;reserved
 43541                                  	dw	Dir_CRatio_1		;offset of arg
 43542                                  	dw	0			;segment of arg
 43543                                  	db	1			;first subst
 43544                                  	db	91h			;format
 43545                                  	db	2			;maximum width
 43546                                  	db	2			;minimum width
 43547                                  	db	blank ; 20h		;pad character
 43548                                  	db	parm_block_size  ; 11	;size of sublist
 43549                                  	db	0			; reserved
 43550                                  	dw	Dir_CRatio_2		;offset of arg
 43551                                  	dw	0			;segment of arg
 43552                                  	db	2			;second subst
 43553                                  	db	11h			;format
 43554                                  	db	1			;maximum width
 43555                                  	db	1			;minimum width
 43556                                  	db	blank ; 20h		;pad character
 43557                                  %else
 43558                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43559                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:97A4h
 43560                                  kbytesf_ptr:
 43561 000092C9 5204                    	dw	1106
 43562 000092CB 01                      	db	1
 43563 000092CC 0B                      	db	11
 43564 000092CD 00                      	db	0
 43565 000092CE [089E]                  	dw	Bytes_Free
 43566 000092D0 0000                    	dw	0
 43567 000092D2 01                      	db	1
 43568 000092D3 F1                      	db	0F1h			; long binary to decimal
 43569 000092D4 1E                      	db	30
 43570 000092D5 1E                      	db	30
 43571 000092D6 20                      	db	20h
 43572                                  kbytesf_n_ptr:
 43573 000092D7 5204                    	dw	1106
 43574 000092D9 01                      	db	1
 43575 000092DA 0B                      	db	11
 43576 000092DB 00                      	db	0
 43577 000092DC [089E]                  	dw	Bytes_Free
 43578 000092DE 0000                    	dw	0
 43579 000092E0 01                      	db	1
 43580 000092E1 B1                      	db	0B1h			; Right_Align+Unsgn_Bin_DWord
 43581 000092E2 1C                      	db	28
 43582 000092E3 1C                      	db	28
 43583 000092E4 20                      	db	20h
 43584                                  %endif
 43585                                  
 43586                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 43587                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8483h
 43588                                  
 43589                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 43590                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99DCh
 43591                                  
 43592                                  	; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43593                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:97C0h
 43594                                  
 43595                                  ; ---------------------------------------------------------------------------
 43596                                  
 43597                                  PATH_TEXT:
 43598 000092E5 504154483D              	db	"PATH="
 43599                                  PROMPT_TEXT:
 43600 000092EA 50524F4D50543D          	db	"PROMPT="
 43601                                  COMSPECSTR:
 43602 000092F1 434F4D535045433D        	db	"COMSPEC="
 43603                                  DirEnvVar:
 43604 000092F9 444952434D443D          	db	"DIRCMD="		; DIR's environment variable
 43605                                  
 43606                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43607                                  ; PCDOS 7.1 COMMAND.COM
 43608                                  %if 1
 43609                                  no_sep_text:
 43610 00009300 4E4F5F5345503D          	db	'NO_SEP='	; 1 = do not use commas as num separator
 43611                                  %endif
 43612                                  
 43613                                  ;============================================================================
 43614                                  ; TDATA.ASM, MSDOS 6.0, 1991
 43615                                  ;============================================================================
 43616                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 43617                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 43618                                  
 43619                                  	; 15/04/2023
 43620 00009307 00                      	db	0
 43621                                  align 2
 43622                                  
 43623                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:849Eh
 43624                                  ; ---------------------------------------------------------------------------
 43625                                  	; 18/06/2023
 43626                                  	;db	0
 43627                                  
 43628                                  ; Lists of help message numbers for internal commands and /?
 43629                                  
 43630                                  	; 18/06/2023
 43631                                  ;;NoHelpMsgs:
 43632                                  	;dw	1200,0		;M014
 43633                                  
 43634                                  	; 18/06/2023
 43635                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:99F7h
 43636                                  
 43637                                  BreakHelpMsgs:
 43638 00009308 14050000                	dw	1300,0
 43639                                  ChcpHelpMsgs:
 43640 0000930C 280529050000            	dw	1320,1321,0
 43641                                  CdHelpMsgs:
 43642 00009312 3C053D053E050000        	dw	1340,1341,1342,0
 43643                                  ClsHelpMsgs:
 43644 0000931A 50050000                	dw	1360,0
 43645                                  CopyHelpMsgs:
 43646                                  	;dw	1400,1401,1402,1403,1404,0
 43647                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 43648 0000931E 780579057A057B057C-     	dw	1400,1401,1402,1403,1404,1405,1406,1407,0
 43648 00009327 057D057E057F050000 
 43649                                  CttyHelpMsgs:
 43650 00009330 8C050000                	dw	1420,0
 43651                                  DateHelpMsgs:
 43652 00009334 A005A1050000            	dw	1440,1441,0
 43653                                  DelHelpMsgs:
 43654 0000933A B405B505B6050000        	dw	1460,1461,1462,0
 43655                                  DirHelpMsgs:
 43656 00009342 C805C905CA05CB05CC-     	dw	1480,1481,1482,1483,1484,1485,1486,1487,1488
 43656 0000934B 05CD05CE05CF05D005 
 43657                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 43658                                  	; MSDOS 6.0 COMMAND.COM
 43659                                  	;dw	1489,1490,1491,1492
 43660                                  	; 06/08/2024 - Retro DOS v5.0 (PCDOS 7.1) COMMAND.COM 
 43661 00009354 D105                    	dw	1489	
 43662 00009356 0000                    	dw	0
 43663                                  ExitHelpMsgs:
 43664 00009358 DC050000                	dw	1500,0
 43665                                  MdHelpMsgs:
 43666 0000935C F0050000                	dw	1520,0
 43667                                  PathHelpMsgs:
 43668 00009360 0406050606060000        	dw	1540,1541,1542,0
 43669                                  PromptHelpMsgs:
 43670 00009368 180619061A061B061C-     	dw	1560,1561,1562,1563,1564,1565,1566,1567,1568,0
 43670 00009371 061D061E061F062006-
 43670 0000937A 0000               
 43671                                  RdHelpMsgs:
 43672 0000937C 2C060000                	dw	1580,0
 43673                                  RenHelpMsgs:
 43674 00009380 4006410642060000        	dw	1600,1601,1602,0
 43675                                  SetHelpMsgs:
 43676 00009388 5406550656060000        	dw	1620,1621,1622,0
 43677                                  TimeHelpMsgs:
 43678 00009390 680669060000            	dw	1640,1641,0
 43679                                  TypeHelpMsgs:
 43680 00009396 7C060000                	dw	1660,0
 43681                                  VerHelpMsgs:
 43682 0000939A 90060000                	dw	1680,0
 43683                                  VerifyHelpMsgs:
 43684 0000939E A4060000                	dw	1700,0
 43685                                  VolHelpMsgs:
 43686 000093A2 B8060000                	dw	1720,0
 43687                                  CallHelpMsgs:
 43688 000093A6 CC06CD060000            	dw	1740,1741,0	;M014
 43689                                  RemHelpMsgs:
 43690 000093AC E0060000                	dw	1760,0		;M014
 43691                                  PauseHelpMsgs:
 43692 000093B0 F4060000                	dw	1780,0		;M014
 43693                                  EchoHelpMsgs:
 43694 000093B4 080709070000            	dw	1800,1801,0	;M014
 43695                                  GotoHelpMsgs:
 43696 000093BA 1C071D070000            	dw	1820,1821,0	;M014
 43697                                  ShiftHelpMsgs:
 43698 000093C0 30070000                	dw	1840,0		;M014
 43699                                  IfHelpMsgs:
 43700 000093C4 440745074607470748-     	dw	1860,1861,1862,1863,1864,1865,1866,0	;M014
 43700 000093CD 0749074A070000     
 43701                                  ForHelpMsgs:
 43702 000093D4 580759075A075B0700-     	dw	1880,1881,1882,1883,0 ;M014
 43702 000093DD 00                 
 43703                                  TruenameHelpMsgs:
 43704 000093DE 6C070000                	 dw	1900,0		;M014
 43705                                  LoadhighHelpMsgs:
 43706 000093E2 800781078207            	dw	1920,1921,1922
 43707                                  	; 17/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM 
 43708                                  	; MSDOS 6.0 COMMAND.COM
 43709 000093E8 830784078507860787-     	dw	1923,1924,1925,1926,1927 ;M014
 43709 000093F1 07                 
 43710 000093F2 0000                    	dw	0
 43711                                  
 43712                                  ; 03/08/2024 - Retro DOS v5.0 COMMAND.COM
 43713                                  %if 1
 43714                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:98CEh
 43715                                  twospacechars:
 43716 000093F4 202000                  	db	'  ',0
 43717                                  %endif
 43718                                  
 43719                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8578h
 43720                                  CLSSTRING:
 43721 000093F7 041B5B324A              	db	4,1Bh,"[2J"		; ANSI Clear screen
 43722                                  
 43723                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:98D6h
 43724                                  PROMPT_TABLE:
 43725 000093FC 42                      	db	"B"
 43726 000093FD [AA21]                  	dw	Print_B
 43727 000093FF 44                      	db	"D"
 43728 00009400 [0A3B]                  	dw	PRINT_DATE
 43729 00009402 45                      	db	"E"
 43730 00009403 [9E21]                  	dw	PRINT_ESC
 43731 00009405 47                      	db	"G"
 43732 00009406 [A221]                  	dw	PRINT_G
 43733 00009408 48                      	db	"H"
 43734 00009409 [5D21]                  	dw	PRINT_BACK
 43735 0000940B 4C                      	db	"L"
 43736 0000940C [A621]                  	dw	PRINT_L
 43737 0000940E 4E                      	db	"N"
 43738 0000940F [BB21]                  	dw	PRINT_DRIVE
 43739 00009411 50                      	db	"P"
 43740 00009412 [C321]                  	dw	build_dir_for_prompt
 43741 00009414 51                      	db	"Q"
 43742 00009415 [6321]                  	dw	PRINT_EQ
 43743                                  	;
 43744                                  	; 06/08/2024 - PCDOS 7.1 COMMAND.COM
 43745 00009417 52                      	db	"R"
 43746 00009418 [6721]                  	dw	PRINT_R ; PRINT Return code, [Retcode]
 43747                                  	;
 43748 0000941A 54                      	db	"T"
 43749 0000941B [BD33]                  	dw	PRINT_TIME
 43750 0000941D 56                      	db	"V"
 43751 0000941E [D620]                  	dw	PRINT_VERSION
 43752 00009420 5F                      	db	"_"
 43753 00009421 [7729]                  	dw	CRLF2
 43754 00009423 24                      	db	"$"
 43755 00009424 [AC21]                  	dw	PRINT_CHAR
 43756 00009426 00                      	db	0			; NUL TERMINATED
 43757                                  
 43758                                  ; Table of IF conditionals
 43759                                  IFTAB:
 43760 00009427 034E4F54                	db	3,"NOT"			; First byte is count
 43761 0000942B [F80B]                  	dw	IFNOT
 43762 0000942D 0A4552524F524C4556-     	db	10,"ERRORLEVEL"
 43762 00009436 454C               
 43763 00009438 [B70C]                  	dw	IFERLEV
 43764 0000943A 054558495354            	db	5,"EXIST"
 43765 00009440 [4C0C]                  	dw	IFEXISTS
 43766 00009442 00                      	db	0
 43767                                  
 43768                                  	; 06/08/2024
 43769                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:991Dh
 43770                                  
 43771                                  ; Table for internal command names
 43772                                  COMTAB:
 43773 00009443 0344495203              	db	3,"DIR",fSwitchAllowed+fCheckDrive ; 3
 43774 00009448 [8011]                  	dw	CATALOG			; In TCMD1.ASM
 43775 0000944A [4293]                  	dw	DirHelpMsgs
 43776                                  
 43777 0000944C 0443414C4C02            	db	4,"CALL",fSwitchAllowed	; 2
 43778 00009452 [2C0D]                  	dw	_$CALL			; In TBATCH2.ASM
 43779 00009454 [A693]                  	dw	CallHelpMsgs
 43780                                  
 43781 00009456 044348435002            	db	4,"CHCP",fSwitchAllowed ; 2
 43782 0000945C [0624]                  	dw	CHCP			; In TCMD2B.ASM
 43783 0000945E [0C93]                  	dw	ChcpHelpMsgs
 43784                                  
 43785 00009460 0652454E414D4503        	db	6,"RENAME",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 43786 00009468 [8C1D]                  	dw	CRENAME			; In TCMD1.ASM
 43787 0000946A [8093]                  	dw	RenHelpMsgs
 43788                                  
 43789 0000946C 0352454E03              	db	3,"REN",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 43790 00009471 [8C1D]                  	dw	CRENAME			; In TCMD1.ASM
 43791 00009473 [8093]                  	dw	RenHelpMsgs
 43792                                  	
 43793 00009475 05455241534503          	db	5,"ERASE",fSwitchAllowed+fCheckDrive	; 3
 43794 0000947C [0A1D]                  	dw	ERASE			; In TCMD1.ASM
 43795 0000947E [3A93]                  	dw	DelHelpMsgs
 43796                                  	
 43797 00009480 0344454C03              	db	3,"DEL",fSwitchAllowed+fCheckDrive	; 3
 43798 00009485 [0A1D]                  	dw	ERASE			; In TCMD1.ASM
 43799 00009487 [3A93]                  	dw	DelHelpMsgs
 43800                                  	
 43801 00009489 045459504503            	db	4,"TYPE",fSwitchAllowed+fCheckDrive	; 3 ;AC018; P3903
 43802 0000948F [331E]                  	dw	TYPEFIL			; In TCMD1.ASM
 43803 00009491 [9693]                  	dw	TypeHelpMsgs
 43804                                  	
 43805 00009493 0352454D06              	db	3,"REM",fSwitchAllowed+fLimitHelp	; 6
 43806 00009498 [0401]                  	dw	TCOMMAND		; In TCODE.ASM
 43807 0000949A [AC93]                  	dw	RemHelpMsgs
 43808                                  	
 43809 0000949C 04434F505903            	db	4,"COPY",fSwitchAllowed+fCheckDrive	; 3
 43810 000094A2 [573B]                  	dw	COPY			; In COPY.ASM
 43811 000094A4 [1E93]                  	dw	CopyHelpMsgs
 43812                                  	
 43813 000094A6 05504155534506          	db	5,"PAUSE",fSwitchAllowed+fLimitHelp	; 6
 43814 000094AD [FE1C]                  	dw	PAUSE			; In TCMD1.ASM
 43815 000094AF [B093]                  	dw	PauseHelpMsgs
 43816                                  	
 43817 000094B1 044441544502            	db	4,"DATE",fSwitchAllowed	; 2
 43818 000094B7 [CD32]                  	dw	DATE			; In TPIPE.ASM
 43819 000094B9 [3493]                  	dw	DateHelpMsgs
 43820                                  	
 43821 000094BB 0454494D4502            	db	4,"TIME",fSwitchAllowed ; 2		;AC018; P3903
 43822 000094C1 [2D33]                  	dw	CTIME			; In TPIPE.ASM
 43823 000094C3 [9093]                  	dw	TimeHelpMsgs
 43824                                  	
 43825 000094C5 0356455202              	db	3,"VER",fSwitchAllowed ; 2
 43826 000094CA [6020]                  	dw	VERSION			; In TCMD2.ASM
 43827 000094CC [9A93]                  	dw	VerHelpMsgs
 43828                                  	
 43829 000094CE 03564F4C03              	db	3,"VOL",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 43830 000094D3 [611F]                  	dw	VOLUME			; In TCMD1.ASM
 43831 000094D5 [A293]                  	dw	VolHelpMsgs
 43832                                  	
 43833 000094D7 02434403                	db	2,"CD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 43834 000094DB [3A28]                  	dw	_$CHDIR			; In TENV.ASM
 43835 000094DD [1293]                  	dw	CdHelpMsgs
 43836                                  	
 43837 000094DF 05434844495203          	db	5,"CHDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 43838 000094E6 [3A28]                  	dw	_$CHDIR			; In TENV.ASM
 43839 000094E8 [1293]                  	dw	CdHelpMsgs
 43840                                  	
 43841 000094EA 024D4403                	db	2,"MD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 43842 000094EE [A028]                  	dw	_$MKDIR			; In TENV.ASM
 43843 000094F0 [5C93]                  	dw	MdHelpMsgs
 43844                                  	
 43845 000094F2 054D4B44495203          	db	5,"MKDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 43846 000094F9 [A028]                  	dw	_$MKDIR			; In TENV.ASM
 43847 000094FB [5C93]                  	dw	MdHelpMsgs
 43848                                  	
 43849 000094FD 02524403                	db	2,"RD",fSwitchAllowed+fCheckDrive ; 3	;AC018; P3903
 43850 00009501 [E528]                  	dw	_$RMDIR			; In TENV.ASM
 43851 00009503 [7C93]                  	dw	RdHelpMsgs
 43852                                  	
 43853 00009505 05524D44495203          	db	5,"RMDIR",fSwitchAllowed+fCheckDrive	;AC018; P3903
 43854 0000950C [E528]                  	dw	_$RMDIR			; In TENV.ASM
 43855 0000950E [7C93]                  	dw	RdHelpMsgs
 43856                                  	
 43857 00009510 05425245414B02          	db	5,"BREAK",fSwitchAllowed ; 2		;AC018; P3903
 43858 00009517 [543A]                  	dw	CNTRLC			; In TUCODE.ASM
 43859 00009519 [0893]                  	dw	BreakHelpMsgs
 43860                                  	
 43861 0000951B 0656455249465902        	db	6,"VERIFY",fSwitchAllowed ; 2		;AC018; P3903
 43862 00009523 [963A]                  	dw	VERIFY			; In TUCODE.ASM
 43863 00009525 [9E93]                  	dw	VerifyHelpMsgs
 43864                                  	
 43865 00009527 0353455406              	db	3,"SET",fSwitchAllowed+fLimitHelp ; 6
 43866 0000952C [A425]                  	dw	ADD_NAME_TO_ENVIRONMENT	; In TENV.ASM
 43867 0000952E [8893]                  	dw	SetHelpMsgs
 43868                                  	
 43869 00009530 0650524F4D505406        	db	6,"PROMPT",fSwitchAllowed+fLimitHelp ; 6
 43870 00009538 [8A25]                  	dw	ADD_PROMPT		; In TENV.ASM
 43871 0000953A [6893]                  	dw	PromptHelpMsgs
 43872                                  	
 43873 0000953C 045041544802            	db	4,"PATH",fSwitchAllowed ; 2
 43874 00009542 [2A22]                  	dw	PATH			; In TCMD2.ASM
 43875 00009544 [6093]                  	dw	PathHelpMsgs
 43876                                  	
 43877 00009546 044558495400            	db	4,"EXIT",0
 43878 0000954C [FB24]                  	dw	_$EXIT			; In TCMD2.ASM
 43879 0000954E [5893]                  	dw	ExitHelpMsgs
 43880                                  	
 43881 00009550 044354545903            	db	4,"CTTY",fCheckDrive+fSwitchAllowed ; 3
 43882 00009556 [6823]                  	dw	CTTY			; In TCMD2.ASM
 43883 00009558 [3093]                  	dw	CttyHelpMsgs
 43884                                  	
 43885 0000955A 044543484F06            	db	4,"ECHO",fSwitchAllowed+fLimitHelp ; 6
 43886 00009560 [1B3A]                  	dw	_ECHO			; In TUCODE.ASM
 43887 00009562 [B493]                  	dw	EchoHelpMsgs
 43888                                  	
 43889 00009564 04474F544F06            	db	4,"GOTO",fSwitchAllowed+fLimitHelp
 43890 0000956A [600D]                  	dw	_GOTO			; In TBATCH.ASM
 43891 0000956C [BA93]                  	dw	GotoHelpMsgs
 43892                                  	
 43893 0000956E 05534849465402          	db	5,"SHIFT",fSwitchAllowed ; 2
 43894 00009575 [E50C]                  	dw	_SHIFT			; In TBATCH.ASM
 43895 00009577 [C093]                  	dw	ShiftHelpMsgs
 43896                                  	
 43897 00009579 02494606                	db	2,"IF",fSwitchAllowed+fLimitHelp ; 6
 43898 0000957D [910B]                  	dw	_$IF			; In TBATCH.ASM
 43899 0000957F [C493]                  	dw	IfHelpMsgs
 43900                                  	
 43901 00009581 03464F5206              	db	3,"FOR",fSwitchAllowed+fLimitHelp ; 6
 43902 00009586 [1910]                  	dw	_$FOR			; In TBATCH.ASM
 43903 00009588 [D493]                  	dw	ForHelpMsgs
 43904                                  	
 43905 0000958A 03434C5300              	db	3,"CLS",0
 43906 0000958F [CF22]                  	dw	CLS			; In TCMD2.ASM
 43907 00009591 [1A93]                  	dw	ClsHelpMsgs
 43908                                  	
 43909 00009593 08545255454E414D45-     	db	8,"TRUENAME",fSwitchAllowed+fCheckDrive	;AN000; P3903 changed
 43909 0000959C 03                 
 43910 0000959D [8424]                  	dw	TRUENAME		;AN000;
 43911 0000959F [DE93]                  	dw	TruenameHelpMsgs
 43912                                  	
 43913 000095A1 084C4F414448494748-     	db	8,"LOADHIGH",fSwitchAllowed ; 2	; M003
 43913 000095AA 02                 
 43914 000095AB [1462]                  	dw	LoadHigh		; In loadhi.asm ; M003
 43915 000095AD [E293]                  	dw	LoadhighHelpMsgs	; M003
 43916                                  	
 43917 000095AF 024C4802                	db	2,"LH",fSwitchAllowed ; 2 ; Short form; M003
 43918 000095B3 [1462]                  	dw	LoadHigh		; In loadhi.asm ; M003
 43919 000095B5 [E293]                  	dw	LoadhighHelpMsgs	; M003
 43920                                  	
 43921 000095B7 00                      	db	0			; Terminate command table
 43922                                  
 43923                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8736h
 43924                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9A92h ; 06/08/2024
 43925                                  
 43926 000095B8 2E434F4D                comext:	db	".COM"
 43927 000095BC 2E455845                exeext:	db	".EXE"
 43928 000095C0 2E424154                batext:	db	".BAT"
 43929                                  
 43930                                  switch_list:
 43931                                  	; MSDOS 5.0 (& 6.0) COMMAND.COM
 43932                                  	;db	"?VBAPW"		; flags we can recognize
 43933                                  	; 18/06/2023
 43934                                  	; MSDOS 6.22 COMMAND.COM
 43935 000095C4 2D593F5642415057        	db	"-Y?VBAPW" ; PCDOS 7.1 COMMAND.COM ; 06/08/2024
 43936                                  
 43937                                  AttrLtrs:
 43938 000095CC 524853764441            	db	"RHSvDA"		; attribute letters for DIR
 43939                                  
 43940                                  ;	Attribute letters in AttrLtrs must appear in the order that
 43941                                  ;	attribute bits occur in the attribute byte returned by
 43942                                  ;	directory searches, starting with bit 0.
 43943                                  ;	The volume label attribute is lowercased to keep it from
 43944                                  ;	being matched (by an uppercase comparison).
 43945                                  
 43946                                  OrderLtrs:
 43947                                  	; MSDOS 5.0
 43948                                  	;db	"NEDSG"			; sort order letters for DIR
 43949                                  	; 18/06/2023
 43950                                  	; MSDOS 6.0 COMMAND.COM
 43951                                  	;db	"NEDSGC"		; sort order letters for DIR
 43952                                  	; 06/08/2024
 43953                                  	; PCDOS 7.1 COMMAND.COM
 43954 000095D2 4E45445347              	db	"NEDSG"
 43955                                  
 43956                                  ;	Sort order letters stand for file name, extension,
 43957                                  ;	date/time, size, grouped (directory files before others),
 43958                                  ;	and compression ratio. DIR routines rely on the specific
 43959                                  ;	order of the letters in this list.
 43960                                  
 43961                                  comspec_flag:
 43962 000095D7 00                      	db	0                       ;AN071;
 43963                                  
 43964                                  BATBUFLEN:
 43965 000095D8 2000                    	dw	BatLen ; 32
 43966                                  
 43967                                  ; *****************************************************
 43968                                  ; EMG 4.00
 43969                                  ; DATA STARTING HERE WAS ADDED BY EMG FOR 4.00
 43970                                  ; FOR IMPLEMENTATION OF COMMON PARSE ROUTINE
 43971                                  ; *****************************************************
 43972                                  
 43973                                  ; COMMON PARSE BLOCKS
 43974                                  
 43975                                  ; Indicates no value list for PARSE.
 43976                                  
 43977                                  NO_VALUES:
 43978 000095DA 0000                    	dw	0			;AN000;  no values
 43979                                  
 43980                                  NULL_VALUE_LIST:  ; for unvalidated value
 43981 000095DC 00                       	db	0                       ; no value lists
 43982                                  
 43983                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 43984                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8759h
 43985                                  
 43986                                  ; PARSE control block for a required file specification (upper cased)
 43987                                  
 43988                                  FILE_REQUIRED:
 43989 000095DD 0002                    	dw	0200h			;AN000;  filespec - required
 43990 000095DF 0100                    	dw	1			;AN000;  capitalize - file table
 43991 000095E1 [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 43992 000095E3 [DA95]                  	dw	NO_VALUES		;AN000;
 43993 000095E5 00                      	db	0			;AN000;  no keywords
 43994                                  
 43995                                  ; PARSE control block for an optional file specification (upper cased)
 43996                                  ; or drive number
 43997                                  
 43998                                  FILE_OPTIONAL:
 43999 000095E6 0103                    	dw	0301h			;AN000;  filespec or drive number
 44000                                  					;	 optional
 44001 000095E8 0100                    	dw	1			;AN000;  capitalize - file table
 44002 000095EA [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44003 000095EC [DA95]                  	dw	NO_VALUES		;AN000;
 44004 000095EE 00                      	db	0			;AN000;  no keywords
 44005                                  
 44006                                  ; PARSE control block for an optional file specification (upper cased)
 44007                                  
 44008                                  FILE_OPTIONAL2:
 44009 000095EF 0102                    	dw	0201h                   ;AN000;  filespec optional
 44010 000095F1 0100                    	dw	1                       ;AN000;  capitalize - file table
 44011 000095F3 [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44012 000095F5 [DA95]                  	dw	NO_VALUES		;AN000;
 44013 000095F7 00                      	db	0			;AN000;  no keywords
 44014                                  
 44015                                  ; PARSE control block for an optional /P switch
 44016                                  
 44017                                  SLASH_P_SWITCH:
 44018 000095F8 0000                    	dw	0			;AN000;  no match flags
 44019 000095FA 0200                    	dw	2			;AN000;  capitalize - char table
 44020 000095FC [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44021 000095FE [DA95]                  	dw	NO_VALUES		;AN000;
 44022 00009600 01                      	db	1			;AN000;  1 keyword
 44023                                  SLASH_P_SYN:
 44024 00009601 2F5000                  	db	"/P",0                  ;AN000;  /P switch
 44025                                  
 44026                                  ; PARSE BLOCK FOR BREAK, VERIFY, ECHO
 44027                                  
 44028                                  ; The following parse control block can be used for any command which
 44029                                  ; needs only the optional "ON" and "OFF" keywords as operands. Allows
 44030                                  ; the equal sign as an additional delimiter. Returns verified result
 44031                                  ; in PARSE1_OUTPUT. Currently used for the BREAK, VERIFY, and ECHO
 44032                                  ; internal commands.
 44033                                  
 44034                                  PARSE_BREAK:
 44035 00009604 [0796]                  	dw	BREAK_PARMS		;AN000;
 44036 00009606 00                      	db	0			;AN032; no extra delimiter
 44037                                  
 44038                                  BREAK_PARMS:
 44039 00009607 0001                    	db	0,1			;AN000;  1 positional parm
 44040 00009609 [0D96]                  	dw	BREAK_CONTROL1		;AN000;
 44041 0000960B 00                      	db	0			;AN000;  no switches
 44042 0000960C 00                      	db	0			;AN000;  no keywords
 44043                                  
 44044                                  BREAK_CONTROL1:
 44045 0000960D 0120                    	dw	2001h			;AN000;  string value - optional
 44046 0000960F 0200                    	dw	2			;AN000;  capitalize - char table
 44047 00009611 [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44048 00009613 [1696]                  	dw	BREAK_VALUES		;AN000;
 44049 00009615 00                      	db	0			;AN000;  no keywords
 44050                                  
 44051                                  BREAK_VALUES:
 44052 00009616 03                      	db	3			;AN000;
 44053 00009617 00                      	db	0			;AN000;  no ranges
 44054 00009618 00                      	db	0			;AN000;  no numeric values
 44055 00009619 02                      	db	2			;AN000;  2 string values
 44056 0000961A 00                      	db	0			;AN000;  returned if ON
 44057 0000961B [2096]                  	dw	BREAK_ON		;AN000;  point to ON string
 44058 0000961D 66                      	db	'f'                     ;AN000;  returned if OFF
 44059 0000961E [2396]                  	dw	BREAK_OFF		;AN000;  point to OFF string
 44060                                  
 44061                                  BREAK_ON:
 44062 00009620 4F4E00                  	db	"ON",0                  ;AN000;
 44063                                  BREAK_OFF:
 44064 00009623 4F464600                	db	"OFF",0                 ;AN000;
 44065                                  
 44066                                  	; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44067                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:87A3h
 44068                                  
 44069                                  ; PARSE BLOCK FOR CHCP
 44070                                  
 44071                                  ; The following parse control block can be used for any command which
 44072                                  ; needs only one optional three digit decimal parameter for operands.
 44073                                  ; Returns verified result in PARSE1_OUTPUT. Currently used for the
 44074                                  ; CHCP internal command.
 44075                                  
 44076                                  CHCP_MINVAL	EQU	100			;AN000;
 44077                                  CHCP_MAXVAL	EQU	999			;AN000;
 44078                                  
 44079                                  PARSE_CHCP:
 44080 00009627 [2A96]                  	dw	CHCP_PARMS			;AN000;
 44081 00009629 00                      	db	0				;AN000;  no extra delimiter
 44082                                  CHCP_PARMS:
 44083 0000962A 0001                    	db	0,1				;AN000;  1 positional parm
 44084 0000962C [3096]                  	dw	CHCP_CONTROL1			;AN000;
 44085 0000962E 00                      	db	0				;AN000;  no switches
 44086 0000962F 00                      	db	0				;AN000;  no keywords
 44087                                  
 44088                                  CHCP_CONTROL1:
 44089 00009630 0180                    	dw	8001h				;AN000;  numeric value - optional
 44090 00009632 0000                    	dw	0				;AN000;  no function flags
 44091 00009634 [4BA6]                  	dw	PARSE1_OUTPUT			;AN000;  result buffer
 44092 00009636 [3996]                  	dw	CHCP_VALUES			;AN000;
 44093 00009638 00                      	db	0				;AN000;  no keywords
 44094                                  
 44095                                  CHCP_VALUES:
 44096 00009639 01                      	db	1				;AN000;
 44097 0000963A 01                      	db	1				;AN000;  1 range
 44098 0000963B 01                      	db	1				;AN000;  returned if result
 44099 0000963C 64000000E7030000        	dd	CHCP_MINVAL,CHCP_MAXVAL		;AN000;  minimum & maximum value
 44100 00009644 00                      	db	0				;AN000;  no numeric values
 44101 00009645 00                      	db	0				;AN000;  no string values
 44102                                  
 44103                                  ; PARSE BLOCK FOR DATE
 44104                                  
 44105                                  ; The following parse control block can be used for any command which
 44106                                  ; needs only an optional date string as an operand. Returns unverified
 44107                                  ; result in DATE_OUTPUT. Currently used for the DATE internal command.
 44108                                  
 44109                                  PARSE_DATE:
 44110 00009646 [4996]                  	dw	DATE_PARMS			;AN000;
 44111 00009648 00                      	db	0				;AN000;  no extra delimiter
 44112                                  DATE_PARMS:
 44113 00009649 0001                    	db	0,1				;AN000;  1 positional parm
 44114 0000964B [4F96]                  	dw	DATE_CONTROL1			;AN000;
 44115 0000964D 00                      	db	0				;AN000;  no switches
 44116 0000964E 00                      	db	0				;AN000;  no keywords
 44117                                  
 44118                                  DATE_CONTROL1:
 44119 0000964F 0110                    	dw	1001h				;AN000;  date - optional
 44120 00009651 0000                    	dw	0				;AN000;  no function flags
 44121 00009653 [53A6]                  	dw	DATE_OUTPUT			;AN000;  result buffer
 44122 00009655 [DA95]                  	dw	NO_VALUES			;AN000;
 44123 00009657 00                      	db	0				;AN000;  no keywords
 44124                                  
 44125                                  ; PARSE BLOCK FOR TIME
 44126                                  
 44127                                  ; The following parse control block can be used for any command which
 44128                                  ; needs only an optional time string as an operand. Returns unverified
 44129                                  ; result in TIME_OUTPUT. Currently used for the TIME internal command.
 44130                                  
 44131                                  PARSE_TIME:
 44132 00009658 [5B96]                  	dw	TIME_PARMS			;AN000;
 44133 0000965A 00                      	db	0				;AN000;  no extra delimiter
 44134                                  TIME_PARMS:
 44135 0000965B 0001                    	db	0,1				;AN000;  1 positional parm
 44136 0000965D [6196]                  	dw	TIME_CONTROL1			;AN000;
 44137 0000965F 00                      	db	0				;AN000;  no switches
 44138 00009660 00                      	db	0				;AN000;  no keywords
 44139                                  
 44140                                  TIME_CONTROL1:
 44141 00009661 0108                    	dw	0801h				;AN000;  TIME - optional
 44142 00009663 0000                    	dw	0				;AN000;  no function flags
 44143 00009665 [5BA6]                  	dw	TIME_OUTPUT			;AN000;  result buffer
 44144 00009667 [DA95]                  	dw	NO_VALUES			;AN000;
 44145 00009669 00                      	db	0				;AN000;  no keywords
 44146                                  
 44147                                  ; PARSE BLOCK FOR VOL
 44148                                  
 44149                                  ; The following parse control block can be used for any command which
 44150                                  ; needs only an optional drive letter as an operand.  Returns unverified
 44151                                  ; drive number (one based) in DRIVE_OUTPUT. Currently used for the VOL
 44152                                  ; internal command.
 44153                                  
 44154                                  PARSE_VOL:
 44155 0000966A [6D96]                  	dw	VOL_PARMS			;AN000;
 44156 0000966C 00                      	db	0				;AN000;  no extra delimiter
 44157                                  VOL_PARMS:
 44158 0000966D 0001                    	db	0,1				;AN000;  1 positional parm
 44159 0000966F [7396]                  	dw	DRIVE_CONTROL1			;AN000;
 44160 00009671 00                      	db	0				;AN000;  no switches
 44161 00009672 00                      	db	0				;AN000;  no keywords
 44162                                  
 44163                                  DRIVE_CONTROL1:
 44164 00009673 0101                    	dw	0101h				;AN000;  DRIVE - optional
 44165 00009675 0100                    	dw	1				;AN000;  capitalize - file table
 44166 00009677 [63A6]                  	dw	DRIVE_OUTPUT			;AN000;  result buffer
 44167 00009679 [DA95]                  	dw	NO_VALUES			;AN000;
 44168 0000967B 00                      	db	0				;AN000;  no keywords
 44169                                  
 44170                                  ; PARSE BLOCK FOR MKDIR, RMDIR, TYPE
 44171                                  
 44172                                  ; The following parse control block can be used for any command which
 44173                                  ; needs only one required file specification as an operand. Returns a
 44174                                  ; pointer to the unverified string in PARSE1_OUTPUT. Currently used
 44175                                  ; for the MKDIR, RMDIR, and TYPE internal commands.
 44176                                  
 44177                                  PARSE_MRDIR:
 44178 0000967C [7F96]                  	dw	MRDIR_PARMS			;AN000;
 44179 0000967E 00                      	db	0				;AN000;  no extra delimiter
 44180                                  MRDIR_PARMS:
 44181 0000967F 0101                    	db	1,1				;AN000;  1 positional parm
 44182 00009681 [DD95]                  	dw	FILE_REQUIRED			;AN000;
 44183 00009683 00                      	db	0				;AN000;  no switches
 44184 00009684 00                      	db	0				;AN000;  no keywords
 44185                                  
 44186                                  ; PARSE BLOCK FOR CHDIR, TRUENAME
 44187                                  
 44188                                  ; The following parse control block can be used for any command which
 44189                                  ; needs only one optional file specification an operand. Returns a
 44190                                  ; pointer to the unverified string in PARSE1_OUTPUT. Currently used
 44191                                  ; for the CHDIR and TRUENAME internal commands.
 44192                                  
 44193                                  PARSE_CHDIR:
 44194 00009685 [8896]                  	dw	CHDIR_PARMS			;AN000;
 44195 00009687 00                      	db	0				;AN000;  no extra delimiter
 44196                                  CHDIR_PARMS:
 44197 00009688 0001                    	db	0,1				;AN000;  1 positional parm
 44198 0000968A [E695]                  	dw	FILE_OPTIONAL			;AN000;
 44199 0000968C 00                      	db	0				;AN000;  no switches
 44200 0000968D 00                      	db	0				;AN000;  no keywords
 44201                                  
 44202                                  ; PARSE BLOCK FOR ERASE
 44203                                  
 44204                                  ; The following parse control block is used for the DEL/ERASE internal
 44205                                  ; commands. This command has one required file specification and an
 44206                                  ; optional switch (/p) as operands. The verified switch or unverified
 44207                                  ; file specification is returned in PARSE1_OUTPUT.
 44208                                  
 44209                                  PARSE_ERASE:
 44210 0000968E [9196]                  	dw	ERASE_PARMS			;AN000;
 44211 00009690 00                      	db	0				;AN000;  no extra delimiter
 44212                                  
 44213                                  ERASE_PARMS:
 44214 00009691 0101                    	db	1,1				;AN000;  1 positional parm
 44215 00009693 [DD95]                  	dw	FILE_REQUIRED			;AN000;
 44216 00009695 01                      	db	1				;AN000;  1 switch
 44217 00009696 [F895]                  	dw	SLASH_P_SWITCH			;AN000;
 44218 00009698 00                      	db	0				;AN000;  no keywords
 44219                                  
 44220                                  ; PARSE BLOCK FOR DIR
 44221                                  
 44222                                  ; The following parse control block is used for the DIR internal command.
 44223                                  ; This command has one optional file specification and several optional
 44224                                  ; switches. Switches, switch values, and the filespec are returned in 
 44225                                  ; PARSE1_OUTPUT.
 44226                                  ;
 44227                                  ; Switches are /a[value], /-a, /o[value], /-o, /s, /-s, /?, /b, /-b,
 44228                                  ; /w, /-w, /p, and /-p. The string values for /a and /o are optional,
 44229                                  ; do not require colons, and are not checked against a value list.
 44230                                  ;
 44231                                  ; Switch /h has been removed from the DIR command	;M008
 44232                                  ; Switch /? is no longer handled internally		;M008
 44233                                  ;
 44234                                  ; A list of pointers to all the switch synonyms is provided here to
 44235                                  ; help identify which switch has been matched.
 44236                                  
 44237                                  	; 15/04/2023 - Retro DOS v4.0 COMMAND.COM
 44238                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8815h
 44239                                  
 44240                                  PARSE_DIR:
 44241 00009699 [9C96]                  	dw	DIR_PARMS
 44242 0000969B 00                      	db	0			; no extra delimiters
 44243                                  DIR_PARMS:
 44244 0000969C 0001                    	db	0,1			; 1 optional positional param
 44245 0000969E [EF95]                  	dw	FILE_OPTIONAL2
 44246 000096A0 02                      	db	2			; 2 kinds of switches
 44247 000096A1 [A696]                  	dw	DIR_SW_VALUED
 44248 000096A3 [B896]                  	dw	DIR_SW_UNVALUED
 44249 000096A5 00                      	db	0			; no keywords
 44250                                  
 44251                                  DIR_SW_VALUED:
 44252 000096A6 0120                    	dw	2001h			; optional string value
 44253 000096A8 2100                    	dw	21h			; optional colon; capitalize 
 44254 000096AA [4BA6]                  	dw	PARSE1_OUTPUT		; result buffer
 44255 000096AC [DC95]                  	dw	NULL_VALUE_LIST		; don't validate value
 44256                                  
 44257                                  	; 18/06/2023
 44258                                  	;db	2
 44259                                  
 44260                                  ; MSDOS 6.0 COMMAND.COM
 44261                                  ;ifdef DBLSPACE_HOOKS
 44262                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44263 000096AE 03                      	db	3		; 3 'synonyms'
 44264                                  ;else
 44265                                  ;	db	2		; 2 'synonyms'
 44266                                  ;endif
 44267                                  
 44268                                  DIR_SW_A:
 44269 000096AF 2F4100                  	db	"/A",0
 44270                                  DIR_SW_O:
 44271 000096B2 2F4F00                  	db	"/O",0
 44272                                  
 44273                                  ; MSDOS 6.0 COMMAND.COM
 44274                                  ;ifdef DBLSPACE_HOOKS
 44275                                  	; 18/06/2023
 44276                                  DIR_SW_C:
 44277 000096B5 2F4300                  	db	"/C",0
 44278                                  ;endif
 44279                                  
 44280                                  DIR_SW_UNVALUED:
 44281 000096B8 0000                    	dw	0			; no value
 44282 000096BA 0000                    	dw	0			; no format functions
 44283 000096BC [4BA6]                  	dw	PARSE1_OUTPUT		; result buffer
 44284 000096BE [DA95]                  	dw	NO_VALUES
 44285                                  
 44286                                  	; 15/04/2023 - Retro DOS v4.0 COMMAND.COM
 44287                                  	;;db	12
 44288                                  	
 44289                                  	; 18/06/2023
 44290                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8839h
 44291                                  	;db	14		; 14 'synonyms' !?
 44292                                  
 44293                                  ; MSDOS 6.0 COMMAND.COM
 44294                                  ;ifdef DBLSPACE_HOOKS
 44295                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44296                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9DB0h
 44297 000096C0 0D                      	db	13		; 13 'synonyms'
 44298                                  ;else
 44299                                  ;	db	12		; 12 'synonyms'
 44300                                  ;endif
 44301                                  
 44302                                  DIR_SW_NEG_A:
 44303 000096C1 2F2D4100                	db	"/-A",0
 44304                                  DIR_SW_NEG_O:
 44305 000096C5 2F2D4F00                	db	"/-O",0
 44306                                  DIR_SW_S:
 44307 000096C9 2F5300                  	db	"/S",0
 44308                                  DIR_SW_NEG_S:
 44309 000096CC 2F2D5300                	db	"/-S",0
 44310                                  DIR_SW_B:
 44311 000096D0 2F4200                  	db	"/B",0
 44312                                  DIR_SW_NEG_B:
 44313 000096D3 2F2D4200                	db	"/-B",0
 44314                                  DIR_SW_W:
 44315 000096D7 2F5700                  	db	"/W",0
 44316                                  DIR_SW_NEG_W:
 44317 000096DA 2F2D5700                	db	"/-W",0
 44318                                  DIR_SW_P:
 44319 000096DE 2F5000                  	db	"/P",0
 44320                                  DIR_SW_NEG_P:
 44321 000096E1 2F2D5000                	db	"/-P",0
 44322                                  DIR_SW_L:
 44323 000096E5 2F4C00                  	db	"/L",0		;M010
 44324                                  DIR_SW_NEG_L:
 44325 000096E8 2F2D4C00                	db	"/-L",0 	;M010
 44326                                  
 44327                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44328                                  ; MSDOS 6.0 COMMAND.COM (DBLSPACE_HOOKS)
 44329                                  DIR_SW_NEG_C:
 44330 000096EC 2F2D4300                	db	"/-C",0
 44331                                  
 44332                                  ; Here's a list of pointers to DIR's switch synonyms, for easier
 44333                                  ; identification. Order is critical - DIR routines rely on the
 44334                                  ; specific order in this list. Negated options appear at odd 
 44335                                  ; positions in the list, and simple on/off options appear first.
 44336                                  
 44337                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44338                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9DE0h
 44339                                  Dir_Sw_Ptrs:			; list of ptrs to switch synonyms
 44340                                  	; 18/06/2023
 44341                                  	; MSDOS 6.0 COMMAND.COM ; *
 44342 000096F0 [EC96]                  	dw	DIR_SW_NEG_C	; * 
 44343                                  Dir_Sw_Ptrs_2:
 44344 000096F2 [B596]                  	dw	DIR_SW_C	; *
 44345                                  	; MSDOS 5.0 COMMAND.COM	
 44346                                  ;Dir_Sw_Ptrs:
 44347 000096F4 [DA96]                  	dw	DIR_SW_NEG_W
 44348                                  ;Dir_Sw_Ptrs_2:
 44349 000096F6 [D796]                  	dw	DIR_SW_W
 44350 000096F8 [E196]                  	dw	DIR_SW_NEG_P
 44351 000096FA [DE96]                  	dw	DIR_SW_P
 44352 000096FC [CC96]                  	dw	DIR_SW_NEG_S
 44353 000096FE [C996]                  	dw	DIR_SW_S
 44354 00009700 [D396]                  	dw	DIR_SW_NEG_B
 44355 00009702 [D096]                  	dw	DIR_SW_B
 44356 00009704 [E896]                  	dw	DIR_SW_NEG_L	;M010
 44357 00009706 [E596]                  	dw	DIR_SW_L	;M010
 44358 00009708 [C596]                  	dw	DIR_SW_NEG_O
 44359 0000970A [B296]                  	dw	DIR_SW_O
 44360 0000970C [C196]                  	dw	DIR_SW_NEG_A
 44361 0000970E [AF96]                  	dw	DIR_SW_A
 44362                                  
 44363                                  ; PARSE BLOCK FOR RENAME
 44364                                  
 44365                                  ; The following parse control block can be used for any command which
 44366                                  ; needs only two required file specifications as operands. Returns
 44367                                  ; pointers to the unverified string in PARSE1_OUTPUT.
 44368                                  ; Currently used for the RENAME internal command.
 44369                                  
 44370                                  PARSE_RENAME:
 44371 00009710 [1397]                  	dw	RENAME_PARMS		;AN000;
 44372 00009712 00                      	db	0			;AN000;  no extra delimiter
 44373                                  RENAME_PARMS:
 44374 00009713 0202                    	db	2,2			;AN000;  2 positional parms
 44375 00009715 [DD95]                  	dw	FILE_REQUIRED		;AN000;
 44376 00009717 [DD95]                  	dw	FILE_REQUIRED		;AN000;
 44377 00009719 00                      	db	0			;AN000;  no switches
 44378 0000971A 00                      	db	0			;AN000;  no keywords
 44379                                  
 44380                                  ; PARSE BLOCK FOR CTTY
 44381                                  
 44382                                  ; The following parse control block can be used for any command which
 44383                                  ; needs one required device name as an operand. Returns a pointer to
 44384                                  ; unverified string in PARSE1_OUTPUT. Currently used for the CTTY
 44385                                  ; internal command.
 44386                                  
 44387                                  PARSE_CTTY:
 44388 0000971B [1E97]                  	dw	CTTY_PARMS		;AN000;
 44389 0000971D 00                      	db	0			;AN000;  no extra delimiter
 44390                                  CTTY_PARMS:
 44391 0000971E 0101                    	db	1,1			;AN000;  1 positional parm
 44392 00009720 [2497]                  	dw	CTTY_CONTROL1		;AN000;
 44393 00009722 00                      	db	0			;AN000;  no switches
 44394 00009723 00                      	db	0			;AN000;  no keywords
 44395                                  CTTY_CONTROL1:
 44396 00009724 0020                    	dw	2000h			;AN000;  string value - required
 44397 00009726 1100                    	dw	11h			;AN000;  capitalize - file table
 44398                                  					;AN000;  remove colon at end
 44399 00009728 [4BA6]                  	dw	PARSE1_OUTPUT		;AN000;  result buffer
 44400 0000972A [DA95]                  	dw	NO_VALUES		;AN000;
 44401 0000972C 00                      	db	0			;AN000;  no keywords
 44402                                  
 44403                                  ; PARSE BLOCK FOR VER
 44404                                  
 44405                                  ; The following parse control block can be used for any command which
 44406                                  ; needs an optional switch "/debug". Currently used for the VER command.
 44407                                  
 44408                                  PARSE_VER:
 44409 0000972D [3097]                  	dw	VER_PARMS
 44410 0000972F 00                      	db	0			; no extra delimiters
 44411                                  VER_PARMS:
 44412 00009730 0000                    	db	0,0			; no positional parameters
 44413                                  ; 20/07/2024 - Retro DOS v5 COMMAND.COM
 44414                                  %if 0	; PCDOS 7.1 (& MSDOS 5.0-6.22) COMMAND.COM 
 44415                                  	db	1			; one switch
 44416                                  	dw	SLASH_R
 44417                                  %else
 44418                                  	; 20/07/2024 - Retro DOS v4-v5 COMMAND.COM
 44419 00009732 02                      	db	2
 44420 00009733 [3897]                  	dw	SLASH_R
 44421 00009735 [4497]                  	dw	SLASH_T ; Retro DOS v4-v5 COMMAND.COM switch
 44422                                  %endif
 44423 00009737 00                      	db	0			; no keywords
 44424                                  SLASH_R:
 44425 00009738 0000                    	dw	0			; no values
 44426 0000973A 0200                    	dw	2			; capitalize by filename table
 44427 0000973C [4BA6]                  	dw	PARSE1_OUTPUT		; result buffer
 44428 0000973E [DA95]                  	dw	NO_VALUES		; no values
 44429 00009740 01                      	db	1			; one synonym
 44430                                  SLASH_R_SYN:
 44431 00009741 2F5200                  	db	"/R",0
 44432                                  
 44433                                  ; 20/07/2024 - Retro DOS v5 COMMAND.COM
 44434                                  %if 1
 44435                                  SLASH_T:
 44436 00009744 0000                    	dw	0			; no values
 44437 00009746 0200                    	dw	2			; capitalize by filename table
 44438 00009748 [4BA6]                  	dw	PARSE1_OUTPUT		; result buffer
 44439 0000974A [DA95]                  	dw	NO_VALUES		; no values
 44440 0000974C 01                      	db	1			; one synonym
 44441                                  SLASH_T_SYN:
 44442 0000974D 2F5400                  	db	"/T",0
 44443                                  %endif
 44444                                  
 44445                                  ; M003 ; Start of changes for LoadHigh support
 44446                                  
 44447                                  ;Parse Control Block for LOADHIGH command
 44448                                  
 44449                                  Parse_LoadHi:
 44450 00009750 [5397]                  	dw	LoadHi_Parms		;extended parm table
 44451 00009752 00                      	db	0			;no extra delimiters
 44452                                  
 44453                                  LoadHi_Parms:
 44454 00009753 0101                    	db	1,1			;min. 1 parm, max. 1 parm
 44455 00009755 [DD95]                  	dw	FILE_REQUIRED		;control struc for filename
 44456 00009757 00                      	db	0			;no switches
 44457 00009758 00                      	db	0			;no keywords
 44458                                  
 44459                                  ; M003 ; End of changes for LoadHigh support
 44460                                  
 44461                                  TempVarName:
 44462 00009759 54454D503D00            	db	"TEMP=",0
 44463                                  
 44464                                  	; 16/04/2023 - Retro DOS v4.0 (MSDOS 5.0) COMMAND.COM
 44465                                  ;TRANDATAEND:		; TRANGROUP:88C2h
 44466                                  
 44467                                  	; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 44468                                  copycmd:
 44469 0000975F 434F5059434D443D        	db 'COPYCMD='
 44470                                  
 44471                                  ; 06/08/2024 - Retro DOS v5.0 - PCDOS 7.1 COMMAND.COM
 44472                                  %if 0
 44473                                  sCVFRoot:
 44474                                  	db '\DBLSPACE.'
 44475                                  %else
 44476                                  	; 06/08/2024
 44477                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:9C3Eh
 44478                                  REXX_EXE:
 44479 00009767 524558582E45584500      	db 'REXX.EXE',0		
 44480                                  %endif
 44481                                  
 44482                                  ; ----------------------------------------------------------------------------
 44483                                  ; 20/07/2024 - Retro DOS v5.0 COMMAND.COM
 44484                                  %if 1
 44485 00009770 0D0A                    RD5CMD_VER_MSG: db 0Dh, 0Ah
 44486 00009772 526574726F20444F53-     		db 'Retro DOS v5 COMMAND.COM'
 44486 0000977B 20763520434F4D4D41-
 44486 00009784 4E442E434F4D       
 44487 0000978A 0D0A                    		db 0Dh, 0Ah 
 44488 0000978C 32303234202D204572-     		db '2024 - Erdogan Tan'
 44488 00009795 646F67616E2054616E 
 44489 0000979E 0D0A                    		db 0Dh,0Ah
 44490 000097A0 24                      		db '$'
 44491                                  %endif
 44492                                  ; ----------------------------------------------------------------------------
 44493                                  
 44494                                  	; 18/06/2023
 44495                                  	; MSDOS 6.22 COMMAND.COM
 44496                                  TRANDATAEND:		; TRANGROUP:9E53h
 44497                                  
 44498                                  ;============================================================================
 44499                                  ; PSDATA.INC, MSDOS 6.0, 1991
 44500                                  ;============================================================================
 44501                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44502                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44503                                  
 44504                                  ; 18/04/2023
 44505                                  TRANSPACESTART:
 44506                                  
 44507                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:88C2h
 44508                                  	
 44509                                  	; 18/06/2023
 44510                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9E53h
 44511                                  
 44512                                  ;********************** Local Data *************************************
 44513                                  
 44514                                  $P_ORDINAL:
 44515 000097A1 0000                    	dw	0		;AN000; Operand ordinal save area
 44516                                  $P_RC:
 44517 000097A3 0000                    	dw	0		;AN000; Return code from parser
 44518                                  $P_SI_Save:
 44519 000097A5 0000                    	dw	0		;AN000; Pointer of command buffer
 44520                                  $P_DX:
 44521 000097A7 0000                    	dw	0		;AN000; Return result buffer address
 44522                                  $P_Terminator:
 44523 000097A9 00                      	db	0		;AN000; Terminator code (ASCII)
 44524                                  $P_DBCSEV_OFF:
 44525 000097AA 0000                    	dw	0		;AN000; Offset of DBCS EV
 44526                                  $P_DBCSEV_SEG:
 44527 000097AC 0000                    	dw	0		;AN000; Segment of DBCS EV
 44528                                  $P_Flags:			;AN000; Parser internal flags
 44529                                  $P_Flags1:
 44530 000097AE 00                      	db	0		;AN038; to reference first byte flags
 44531                                  $P_Flags2:
 44532 000097AF 00                      	db	0		;AN038; to reference second byte flags only
 44533                                  $P_SaveSI_Cmpx:
 44534 000097B0 0000                    	dw	0		;AN000; save si for later use by complex
 44535                                  $P_KEYorSW_Ptr:
 44536 000097B2 0000                    	dw	0		;AN000; points next to "=" or ":" code
 44537                                  $P_Save_EOB:
 44538 000097B4 0000                    	dw	0		;AN000; save pointer to EOB
 44539                                  $P_Found_SYNONYM:
 44540 000097B6 0000                    	dw	0		;AN000; es:@ points to found synonym
 44541                                  $P_STRING_BUF:
 44542 000097B8 00<rep 80h>             	times  128 db 0		;AN000; Pick a operand from command line
 44543                                  $P_ORIG_ORD:
 44544 00009838 0000                    	dw	0		;AN039; ORIGINAL ORDINAL FROM CX
 44545                                  $P_ORIG_STACK:
 44546 0000983A 0000                    	dw	0		;AN039; ORIGINAL VALUE OF STACK FROM SP
 44547                                  $P_ORIG_SI:
 44548 0000983C 0000                    	dw	0		;AN039; ORIGINAL START PARSE POINTER FROM SI
 44549                                  $P_Got_Time:
 44550 0000983E 00                      	db	0		;AN023; if 1, use Time delimiters
 44551                                  $P_Country_Info:
 44552 0000983F FFFF                    	dw	-1 ; 0FFFFh
 44553 00009841 00<rep 20h>             	times	32 db 0	
 44554                                  $P_1st_Val:
 44555 00009861 0000                    	dw	0		;AN000; used when process date or time
 44556                                  $P_2nd_Val:
 44557 00009863 0000                    	dw	0		;AN000; used when process date or time
 44558                                  $P_3rd_Val:
 44559 00009865 0000                    	dw	0		;AN000; used when process date or time
 44560                                  $P_4th_Val:
 44561 00009867 0000                    	dw	0		;AN000; used when process date or time
 44562                                  $P_Char_CAP_Ptr:
 44563 00009869 FF                      	db	0FFh		;AN000; info id
 44564 0000986A 0000                    	dw	0		;AN000; offset	of char case map table
 44565 0000986C 0000                    	dw	0		;AN000; segment of char case map table
 44566                                  $P_File_CAP_Ptr:
 44567 0000986E FF                      	db	0FFh		;AN000; info id
 44568 0000986F 0000                    	dw	0		;AN000; offset	of file case map table
 44569 00009871 0000                    	dw	0		;AN000; segment of file case map table
 44570                                  
 44571                                  	; 18/04/2023
 44572                                  ;M029
 44573                                  ;!!!WARNING!!!
 44574                                  ; In routine SYSPARSE (parse.asm), $P_FileSp_Char is reinitialized using 
 44575                                  ;hardcoded strings. If the chars in the string are changed here, corresponding
 44576                                  ;changes need to be made in SYSPARSE
 44577                                  
 44578                                  $P_FileSp_Char:
 44579 00009873 5B5D7C3C3E2B3D3B22      	db	'[]|<>+=;"'     ;AN000; delimitter of file spec
 44580                                  $P_FileSp_Len equ $-$P_FileSp_Char ;AN000;
 44581                                  
 44582                                  ;filespec error flag
 44583                                  $P_err_flag:
 44584 0000987C 00                      	db	0		;AN033; flag set if filespec parsing error
 44585                                  				;AN033;  was detected.
 44586                                  
 44587                                  ;============================================================================
 44588                                  ; MSGSERV.ASM, MSDOS 6.0, 1991
 44589                                  ;============================================================================
 44590                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44591                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44592                                  
 44593                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:899Eh
 44594                                  
 44595                                  	; 18/06/2023
 44596                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9F2Fh
 44597                                  
 44598                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 44599                                  ;;
 44600                                  ;; STRUCTURE: $M_RES_ADDRS
 44601                                  ;;
 44602                                  ;; Resident data area definition of variables
 44603                                  ;;
 44604                                  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
 44605                                  
 44606                                  $M_RT:
 44607 0000987D 00<rep 8Dh>             	times $M_RES_ADDRS_SZ db 0   ; times 141 db 0
 44608                                  
 44609                                  ;============================================================================
 44610                                  ; COPYRIGHT.INC, MSDOS 6.0, 1993
 44611                                  ;============================================================================
 44612                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44613                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44614                                  
 44615                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:8A2Bh
 44616                                  ; ---------------------------------------------------------------------------
 44617                                  ;;M00 - changed to DOS 5.0 copyright - MD 9 Jul 90
 44618                                  ;;M031 - changed copyright to 1991
 44619                                  ;;9/16 - changed version to 6.0 and copyright to 1992
 44620                                  ;;9/21 - Added international translations, language passed through COUNTRY macro
 44621                                  ;;B49,50 - changed version to 6 and copyright to 1993
 44622                                  ; ---------------------------------------------------------------------------
 44623                                  	
 44624                                  	; 18/06/2023
 44625                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:9FBCh
 44626                                  ;ifdef USA
 44627                                  MsDosVer6_CCopy:
 44628                                  	; MSDOS 6.0
 44629                                  	;db	"MS DOS Version 6 (C)Copyright 1981-1993 Microsoft Corp "
 44630                                  	; 18/06/2023
 44631                                  	; MSDOS 6.22
 44632 0000990A 4D5320444F53205665-     	db	"MS DOS Version 6 (C)Copyright 1981-1994 Microsoft Corp "
 44632 00009913 7273696F6E20362028-
 44632 0000991C 4329436F7079726967-
 44632 00009925 687420313938312D31-
 44632 0000992E 393934204D6963726F-
 44632 00009937 736F667420436F7270-
 44632 00009940 20                 
 44633 00009941 4C6963656E73656420-     	db	"Licensed Material - Property of Microsoft "
 44633 0000994A 4D6174657269616C20-
 44633 00009953 2D2050726F70657274-
 44633 0000995C 79206F66204D696372-
 44633 00009965 6F736F667420       
 44634 0000996B 416C6C207269676874-     	db	"All rights reserved "
 44634 00009974 732072657365727665-
 44634 0000997D 6420               
 44635                                  ;endif
 44636                                  
 44637                                  ; ---------------------------------------------------------------------------
 44638                                  ; 18/06/2023
 44639                                  ; 15/04/2023
 44640                                  ;MsDosVer5_CCopy:
 44641                                  	;db	"MS DOS Version 5.00 (C)Copyright 1981-1991 Microsoft Corp "
 44642                                  	;db	"Licensed Material - Property of Microsoft "
 44643                                  	;db	"All rights reserved "
 44644                                  ; ---------------------------------------------------------------------------
 44645                                  ; 15/04/2023
 44646                                  	; 16/04/2023 - 21/04/2023
 44647                                  	;db 	0
 44648                                  	;db	0Dh,0Ah
 44649                                  	;db	'Retro DOS v4.0 (& v4.1) COMMAND.COM '
 44650                                  	;db	0
 44651                                  	;db	'by Erdogan Tan - 05/05/2023'
 44652                                  	;db	0
 44653                                  
 44654                                  	; 19/06/2023
 44655                                  	; 18/06/2023
 44656                                  	;db 	0
 44657                                  	;db	0Dh,0Ah
 44658                                  	;db	'Retro DOS v4.2 COMMAND.COM '
 44659                                  	;db	0
 44660                                  	;db	'by Erdogan Tan - 19/6/2023'
 44661                                  	;db	0
 44662                                  
 44663                                  ;============================================================================
 44664                                  ; TPRINTF.ASM, MSDOS 6.0, 1991
 44665                                  ;============================================================================
 44666                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44667                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44668                                  
 44669                                  PRINTF_HANDLE:
 44670 0000997F 0000                    	dw	0		;AC000;
 44671                                  
 44672                                  ;============================================================================
 44673                                  ; TSPC.ASM, MSDOS 6.0, 1991
 44674                                  ;============================================================================
 44675                                  ; 15/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44676                                  ; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44677                                  
 44678                                  ;TITLE	COMMAND Transient Uninitialized DATA
 44679                                  
 44680                                  ;The TRANSPACE segment contains variable data that is considered
 44681                                  ;volatile between command cycles, and therefore is not included in the
 44682                                  ;transient checksum area. Contents of these variables MUST be
 44683                                  ;initialized before use, and must not be relied upon from command
 44684                                  ;cycle to command cycle.
 44685                                  ;
 44686                                  ;No constant data values should be stored here.
 44687                                  
 44688                                  ; ---------------------------------------------------------------------------
 44689                                  ; START OF UNITIALIZED DATA
 44690                                  ; ---------------------------------------------------------------------------
 44691                                  
 44692                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 8AA5h
 44693                                  
 44694                                  	; 18/06/2023
 44695                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A033h
 44696                                  
 44697 00009981 00<rep 57h>             SRCXNAME: times	DIRSTRLEN+20 db 0 ; 87	; buffer for name translate
 44698 000099D8 00<rep 57h>             TRGXNAME: times	DIRSTRLEN+20 db 0 ; 87	; buffer for name translate
 44699 00009A2F 00<rep 83h>             UCOMBUF:  times COMBUFLEN+3  db 0 ; 131	; Raw console buffer
 44700 00009AB2 00<rep 83h>             COMBUF:	  times COMBUFLEN+3  db 0 ; 131	; Cooked console buffer
 44701 00009B35 00<rep 46h>             USERDIR1: times	DIRSTRLEN+3  db 0 ; 70  ; Storage for users current directory
 44702 00009B7B 00<rep 83h>             EXECPATH: times COMBUFLEN+3  db 0 ; 131 ; Path for external command
 44703 00009BFE 00<rep 53h>             RE_INSTR: times DIRSTRLEN+16 db 0 ; 83  ; path for input to redirection
 44704                                  
 44705                                  ; Variables passed up from resident	; in the Resident portion: (initial values)	
 44706                                  HEADCALL:
 44707 00009C51 0000                    	dw 0			; TRANVARS  (dw THEADFIX)
 44708 00009C53 0000                    RESSEG:	dw 0			; MYSEG     (dw 0) 	 	
 44709 00009C55 0000                    TPA:	dw 0			; LTPA	    (dw 0)	
 44710                                  SWITCHAR:
 44711 00009C57 00                      	db 0			; RSWITCHAR (db '-')
 44712                                  DIRCHAR:
 44713 00009C58 00                      	db 0			; RDIRCHAR  (db '/')
 44714                                  EXEC_ADDR:
 44715 00009C59 00000000                	dd 0			; 	    (dw EXT_EXEC)	 
 44716                                  				; MYSEG1    (dw 0)	
 44717                                  RCH_ADDR:
 44718 00009C5D 00000000                	dd 0			;	    (dw TREMCHECK) 	
 44719                                  				; MYSEG2    (dw 0)	
 44720 00009C61 0000                    	dw 0			; RESTEST   (dw 0)	
 44721                                  TRAN_TPA:
 44722 00009C63 0000                    	dw 0			; RES_TPA   (dw 0)	
 44723                                  
 44724 00009C65 00                      CHKDRV:	db 0
 44725                                  IFNOTFLAG:
 44726                                  FILTYP:
 44727 00009C66 00                      RDEOF:	db 0			; Misc flags
 44728 00009C67 00                      CURDRV:	db 0
 44729                                  PARM1:
 44730 00009C68 00                      Concat:	db 0
 44731                                  PARM2:
 44732 00009C69 00                      ArgC:	db 0
 44733 00009C6A 0000                    COMSW:	dw 0			; Switches between command and 1st arg
 44734 00009C6C 0000                    ARG1S:	dw 0			; Switches between 1st and 2nd arg
 44735                                  ARG2S:				; Switches after 2nd arg		
 44736                                  DestSwitch:
 44737 00009C6E 0000                    	dw 0
 44738                                  ARGTS:
 44739                                  AllSwitch:
 44740 00009C70 0000                    	dw 0			; ALL switches except for COMSW
 44741 00009C72 00                      CFLAG:	db 0
 44742                                  DestClosed:
 44743                                  SPECDRV:
 44744 00009C73 00                      	db 0
 44745 00009C74 0000                    BYTCNT:	dw 0			; Size of buffer between RES and TRANS
 44746                                  
 44747                                  ; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 44748                                  ;ifdef DBLSPACE_HOOKS
 44749                                  savBytCnt: ; MSDOS 6.0
 44750 00009C76 0000                    	dw 0
 44751                                  ;endif
 44752                                  	
 44753 00009C78 0000                    NXTADD:	dw 0
 44754                                  FRSTSRCH:
 44755 00009C7A 00                      	db 0
 44756                                  ; 15/04/2023
 44757                                  LeftOnLine:
 44758 00009C7B 00                      	db 0			; entries left on line u.b. DIR
 44759                                  PerLine:
 44760 00009C7C 00                      	db 0			; entries/line u.b. DIR
 44761 00009C7D 00                      LINCNT:	db 0
 44762 00009C7E 00                      LINLEN:	db 0
 44763                                  LeftOnPage:
 44764 00009C7F 0000                    	dw 0			; lines left on page u.b. DIR
 44765                                  FileCnt:
 44766 00009C81 0000                    	dw 0			; file count u.b. DIR
 44767                                  FileSiz:
 44768 00009C83 00000000                	dd 0			; file size u.b. DIR
 44769                                  
 44770                                  ; 31/07/2024 - PCDOS 7.1 COMMAND.COM - TRANGROUP:A0B5h
 44771                                  %if 1
 44772 00009C87 00000000                	dd 0
 44773 00009C8B 00                      narrow:	db 0
 44774                                  nocommas:
 44775 00009C8C 00                      	db 0
 44776                                  yeardigit4:
 44777 00009C8D 00                      	db 0
 44778                                  bfree_not_kilo:
 44779 00009C8E 00                      	db 0
 44780                                  efs_buffer:
 44781 00009C8F 000000000000000000-     	db 44 dup(0)  ; times 44 db 0
 44781 00009C98 000000000000000000-
 44781 00009CA1 000000000000000000-
 44781 00009CAA 000000000000000000-
 44781 00009CB3 0000000000000000   
 44782                                  efs_drive:
 44783 00009CBB 433A5C00                	db 'C:\',0
 44784                                  %endif
 44785                                  
 44786                                  ; Note: keep FileCntTotal through csecUsedTotal together!
 44787                                  
 44788                                  FileCntTotal:
 44789 00009CBF 00000000                	dd 0			; total file count u.b. DIR
 44790                                  FileSizTotal:
 44791 00009CC3 00000000                	dd 0			; total file size u.b. DIR
 44792                                  
 44793                                  ; 31/07/2024 - Retro DOS v5.0 COMMAND.COM
 44794                                  %if 1
 44795                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:A0F5h
 44796 00009CC7 00000000                	dd 0
 44797                                  %else
 44798                                  	; 18/06/2023 - Retro DOS v4.2 (MSDOS 6.22) COMMAND.COM
 44799                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A33Fh
 44800                                  	; MSDOS 6.0
 44801                                  ;ifdef DBLSPACE_HOOKS
 44802                                  ccluUsed:
 44803                                  	dw 0			; count of DOS clusters used
 44804                                  ccluUsedDir:
 44805                                  	dw 0			
 44806                                  ccluUsedTotal:
 44807                                  	dw 0			
 44808                                  csecUsed:
 44809                                  	dd 0			; count of comp sectors used
 44810                                  csecUsedDir:
 44811                                  	dd 0			
 44812                                  csecUsedTotal:
 44813                                  	dd 0			
 44814                                  
 44815                                  ; Note:  keep FileCntTotal through csecUsedTotal together!
 44816                                  
 44817                                  fhCVF:
 44818                                  	dw 0			; Compressed Volume File handle
 44819                                  szCVF:
 44820                                  	times	16 db 0		; "X:\\12345678.123\0"
 44821                                  MDBPB:
 44822                                  	;MD_BPB	<>		; Extended MagicDrv BPB
 44823                                  	times	64 db 0
 44824                                  csecPerCluster:
 44825                                  	db 0			; sectors/cluster for ratio calc
 44826                                  fUseHostSize:
 44827                                  	db 0			; NZ if using host cluster size
 44828                                  cFATEntries:
 44829                                  	dw 0			; # FAT entries in buffers
 44830                                  entInBuf:
 44831                                  	dw 0			; 1st entry # in FAT buffers
 44832                                  segFATBuf:
 44833                                  	dw 0			; seg of DOS & MD FAT buffers
 44834                                  pbufDOSFAT:
 44835                                  	dw 0			; off of DOS FAT buffer
 44836                                  pbufMDFAT:
 44837                                  	dw 0			; off of MD FAT buffer
 44838                                  bufDOSFAT:
 44839                                  	;times (cRES_FAT_ENTRIES*2) db 0
 44840                                  	times 64 db 0	 	; small DOS FAT buffer
 44841                                  bufMDFAT:
 44842                                  	;times (cRES_FAT_ENTRIES*4) db 0
 44843                                  	times 128 db 0		; small MD FAT buffer
 44844                                  ;endif
 44845                                  %endif
 44846                                  
 44847                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 8DAFh
 44848                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A46Fh
 44849                                  	; 31/07/2024
 44850                                  	; PCDOS 7.1 COMMAND.COM - TRANGROUP:A0F9h
 44851                                  CHARBUF:
 44852 00009CCB 00<rep 50h>             	times	80 db 0		;line byte character buffer for xenix write
 44853                                  DESTFCB2:
 44854 00009D1B 00                      IDLEN:	db 0
 44855 00009D1C 00<rep 8h>              ID:	times	8  db 0
 44856 00009D24 00<rep 3h>              COM:	times	3  db 0 
 44857 00009D27 00<rep 25h>             DEST:	times	37 db 0
 44858                                  DESTNAME:
 44859 00009D4C 00<rep Bh>              	times	11 db 0
 44860                                  DESTDIR:
 44861                                  DestFcb:
 44862 00009D57 00<rep 43h>             	times DIRSTRLEN db 0 ; 67 ; Directory for PATH searches
 44863                                  GOTOLEN: ; word
 44864                                  BWDBUF:  ; byte
 44865                                  EXEFCB:  ; word
 44866 00009D9A 00<rep 46h>             DIRBUF:	times DIRSTRLEN+3 db 0 ; 70
 44867                                  
 44868                                  DIRBUF_ATTRIB1 equ DIRBUF+19  ; byte	; INT 21h AH=11h (8+DIR_ENTRY struc)
 44869                                  DIRBUF_ATTRIB2 equ DIRBUF+21  ; byte	; INT 21h AH=4Eh (FIND_BUF struc)
 44870                                  DIRBUF_FTIME   equ DIRBUF+30  ; word
 44871                                  DIRBUF_FDATE   equ DIRBUF+32  ; word	
 44872                                  DIRBUF_FSIZ_L  equ DIRBUF+36  ; word
 44873                                  DIRBUF_FSIZ_H  equ DIRBUF+38  ; word
 44874                                  
 44875                                  	; 16/04/2023 - Retro DOS v4.0 (& v4.1) COMMAND.COM
 44876                                  
 44877                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44878                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0A584h
 44879                                  SDIRBUF:
 44880 00009DE0 00<rep Ch>              	times 12 db 0	
 44881                                  _Bits:
 44882 00009DEC 0000                    	dw 0
 44883                                  PathCnt:
 44884 00009DEE 0000                    	dw 0
 44885                                  PathPos:
 44886 00009DF0 0000                    	dw 0
 44887 00009DF2 0000                    PathSw:	dw 0
 44888                                  AttrSpecified:
 44889 00009DF4 00                      	db 0			; attribute bits u.b. DIR
 44890                                  AttrSelect:
 44891 00009DF5 00                      	db 0			; attribute bits u.b. DIR
 44892 00009DF6 00                      comma:	db 0			; flag set if +,, occurs
 44893                                  plus_comma:
 44894 00009DF7 00                      	db 0			; flag set if +,, occurs
 44895                                  DirFlag:
 44896 00009DF8 00                       	db 0			;AN015; set when pathcrunch called from DIR
 44897                                  parse_last:
 44898 00009DF9 0000                    	dw 0			;AN018; used to hold parsing position
 44899                                  system_cpage:
 44900 00009DFB 0000                    	dw 0			;AC001; used for CHCP variable
 44901                                  
 44902                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 44903                                  %if 0
 44904                                  Arg_Buf:
 44905                                  	times 128 db 0	
 44906                                  %endif
 44907                                  
 44908                                  File_Size_Low:
 44909 00009DFD 0000                    	dw 0	
 44910                                  File_Size_High:
 44911 00009DFF 0000                    	dw 0		
 44912                                  string_ptr_2:
 44913 00009E01 0000                    	dw 0	
 44914                                  Copy_num:
 44915 00009E03 0000                    	dw 0
 44916                                  cpyflag:
 44917 00009E05 00                      	db 0
 44918                                  Dir_Num:
 44919 00009E06 0000                    	dw 0
 44920                                  
 44921                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 44922                                  %if 0
 44923                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 44924                                  	; MSDOS 6.0
 44925                                  ;ifdef DBLSPACE_HOOKS
 44926                                  Dir_CRatio_1:
 44927                                  	db 0
 44928                                  Dir_CRatio_2:
 44929                                  	db 0
 44930                                  ;endif
 44931                                  %endif
 44932                                  
 44933                                  Bytes_Free:
 44934 00009E08 00000000                	dd 0
 44935                                  
 44936                                  Major_Ver_Num:
 44937 00009E0C 0000                    	dw 0
 44938                                  Minor_Ver_Num:
 44939 00009E0E 0000                    	dw 0
 44940                                  
 44941                                  One_Char_Val:
 44942 00009E10 00                      	db 0
 44943 00009E11 00                      	db 0
 44944                                  vol_drv:
 44945 00009E12 00                      	db 0
 44946                                  ROM_CALL:
 44947 00009E13 00                      	db 0			; flag for rom function
 44948 00009E14 0000                    ROM_IP:	dw 0
 44949 00009E16 0000                    ROM_CS:	dw 0
 44950                                  
 44951                                  DestVars:
 44952                                  DestIsDir:
 44953 00009E18 00                      	db 0
 44954                                  DestSiz:
 44955 00009E19 00                      	db 0
 44956                                  DestTail:
 44957 00009E1A 0000                    	dw 0
 44958                                  DestInfo:
 44959 00009E1C 00                      	db 0
 44960                                  DestBuf:
 44961 00009E1D 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 44962                                  EndDestBuf:
 44963                                  DESTHAND:
 44964 00009E74 0000                    	dw 0
 44965                                  DESTISDEV:
 44966 00009E76 00                      	db 0
 44967                                  FIRSTDEST:
 44968 00009E77 00                      	db 0
 44969                                  MELCOPY:
 44970 00009E78 00                      	db 0
 44971                                  MELSTART:
 44972 00009E79 0000                    	dw 0
 44973                                  SrcVars:
 44974                                  SrcIsDir:
 44975 00009E7B 00                      	db 0
 44976 00009E7C 00                      SrcSiz:	db 0
 44977                                  SrcTail:
 44978 00009E7D 0000                    	dw 0
 44979                                  SrcInfo:
 44980 00009E7F 00                      	db 0
 44981                                  SrcBuf:
 44982 00009E80 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 44983                                  SRCHAND:
 44984 00009ED7 0000                    	dw 0
 44985                                  SRCISDEV:
 44986 00009ED9 00                      	db 0
 44987                                  ScanBuf:
 44988 00009EDA 00<rep 57h>             	times DIRSTRLEN+20 db 0 ; 87
 44989                                  
 44990 00009F31 0000                    SRCPT:	dw 0
 44991                                  INEXACT:
 44992 00009F33 00                      	db 0
 44993                                  NOWRITE:
 44994 00009F34 00                      	db 0
 44995                                  BINARY:
 44996 00009F35 00                      	db 0
 44997                                  WRITTEN:
 44998 00009F36 0000                    	dw 0
 44999                                  TERMREAD:
 45000 00009F38 00                      	db 0
 45001 00009F39 00                      ASCII:	db 0
 45002 00009F3A 00                      PLUS:	db 0
 45003 00009F3B 00                      objcnt:	db 0			; Used in copy
 45004 00009F3C 0000                    CPDATE:	dw 0
 45005 00009F3E 0000                    CPTIME:	dw 0
 45006                                  
 45007                                  OFilePtr_Lo:
 45008 00009F40 0000                    	dw 0			; original file ptr for COPY when
 45009                                  OFilePtr_Hi:
 45010 00009F42 0000                    	dw 0			; 1st source is also destination
 45011 00009F44 00                      OCtrlZ:	db 0			; original ctrl+Z for COPY when ditto
 45012                                  
 45013                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45014                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0A76Bh
 45015                                  cox_sublist_buff:
 45016 00009F45 00<rep Bh>              	times 11 db 0
 45017                                  cox_y_override:
 45018 00009F50 00                      	db 0
 45019                                  cox_dest_file:
 45020 00009F51 00                      	db 0
 45021                                  cox_src_file:
 45022 00009F52 00                      	db 0
 45023                                  
 45024                                  	; (MSDOS 6.22 COMMAND.COM - TRANGROUP:0A779h)
 45025                                  BATHAND:
 45026 00009F53 0000                    	dw 0			; Batch handle
 45027                                  STARTEL:
 45028 00009F55 0000                    	dw 0
 45029 00009F57 00                      ELCNT:	db 0
 45030 00009F58 00                      ELPOS:	db 0
 45031                                  
 45032                                  ; 28/03/2023 - Retro DOS v4.0 COMMAND.COM
 45033                                  ; MSDOS 5.0
 45034                                  SKPDEL:
 45035                                  	; 18/06/2023
 45036 00009F59 00                      	db 0	; MSDOS 6.22 (& MSDOS 5.0)  	
 45037 00009F5A 00<rep Bh>              SOURCE:	times 11 db 0
 45038                                  
 45039                                  ext_entered:
 45040 00009F65 00                      	db 0			;AN005;
 45041                                  
 45042                                  ; MSDOS 5.0 COMMAND.COM - TRANGROUP:90BCh
 45043                                  
 45044                                  Display_Ioctl:
 45045 00009F66 00                      	db 0			;AN000; info level
 45046 00009F67 00                      	db 0			;AN000; reserved
 45047 00009F68 0E00                    	dw crt_ioctl_ln		;AN000; length of data
 45048 00009F6A 0000                    	dw 0			;AN000; control flags
 45049                                  display_mode:
 45050 00009F6C 00                      	db 0			;AN000; display mode, colors
 45051 00009F6D 00                      	db 0			;AN000; reserved
 45052 00009F6E 0000                    	dw 0			;AN023; colors
 45053 00009F70 0000                    	dw 0			;AN000; display width (PELS)
 45054 00009F72 0000                    	dw 0			;AN000; display length (PELS)
 45055                                  display_width:
 45056 00009F74 0000                    	dw 0			;AN000; display width
 45057                                  LinPerPag:
 45058 00009F76 1900                    	dw LINESPERPAGE	; 25	;AN000; display length (default to linesperpage)
 45059                                  
 45060                                  vol_ioctl_buf:			;AN000; buffer for ioctl volume label/serial call
 45061 00009F78 0000                    	dw 0			;AN000; info level
 45062                                  vol_serial:
 45063 00009F7A 00000000                	dd 0			;AN000; volume serial number
 45064                                  vol_label:
 45065 00009F7E 20<rep Bh>              	times 11 db 20h ; " "	;AN000; volume label - init to blanks
 45066 00009F89 20<rep 8h>              	times 8  db 20h ; " "	;AN000; file system type
 45067                                  
 45068                                  expand_star:
 45069 00009F91 00                      	db 0
 45070                                  
 45071                                  msg_flag:
 45072 00009F92 00                      	db 0			;AN022; flag set if non-utility message issued
 45073                                  Msg_Numb:
 45074 00009F93 0000                    	dw 0			;AN022; set with extended error message issued
 45075                                  append_exec:
 45076 00009F95 00                      	db 0			;AN041; set if internal append executed
 45077                                  print_err_flag:
 45078 00009F96 0000                    	dw 0			;AN000; flag set if error during sysdispmsg
 45079                                  subst_buffer:
 45080 00009F98 00<rep 16h>             	times parm_block_size*2 db 0 ; times 22 db 0 
 45081                                  				;AN061;
 45082                                  ; 15/04/2023
 45083 00009FAE 00                      KPARSE:	db 0	; 3/3/KK	
 45084                                  
 45085                                  ; Data declarations taken out of parse.asm
 45086                                  
 45087                                  ; MSDOS 6.0
 45088                                  ;arg	arg_unit	<>		; pointers, arg count, string buffer
 45089                                  ;argbufptr	dw	?		; index for argv[].argpointer
 45090                                  ;tpbuf		db	128 DUP (?)	; temporary buffer
 45091                                  ;LAST_ARG	dw	?		; point at which to accumulate switch info
 45092                                  ;comptr		dw	?		; ptr into combuf
 45093                                  
 45094                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9105h
 45095                                  
 45096                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45097                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0A7D5h
 45098                                  ARG:
 45099                                  ARG_ARGV:
 45100                                  ARGV0_ARGPOINTER:
 45101 00009FAF 0000                    	dw 0	; ARGV[0]
 45102                                  ARGV0_ARG_FLAGS:
 45103 00009FB1 00                      	db 0
 45104                                  ARGV0_ARGSTARTEL:
 45105 00009FB2 0000                    	dw 0
 45106                                  ARGV0_ARGLEN:
 45107 00009FB4 0000                    	dw 0
 45108                                  ARGV0_ARGSW_WORD:
 45109 00009FB6 0000                    	dw 0
 45110                                  ARGV0_OCOMPTR:
 45111 00009FB8 0000                    	dw 0
 45112                                  ARGV1_ARGPOINTER:
 45113 00009FBA 0000                    	dw 0	; ARGV[1]	
 45114 00009FBC 00<rep 5h>              	times 5 db 0
 45115                                  ARGV1_ARGSW_WORD:
 45116 00009FC1 0000                    	dw 0
 45117 00009FC3 0000                    	dw 0
 45118                                  ARGV2_ARGPOINTER:
 45119 00009FC5 0000                    	dw 0	; ARGV[2]
 45120 00009FC7 00<rep 5h>              	times 5 db 0
 45121                                  ARGV2_ARGSW_WORD:
 45122 00009FCC 0000                    	dw 0
 45123 00009FCE 0000                    	dw 0
 45124 00009FD0 00<rep 29Fh>            	times 671 db 0  ; ARGV[3] to ARGV[63]
 45125                                  ARG_ARGVCNT:
 45126 0000A26F 0000                    	dw 0
 45127                                  ARG_ARGSWINFO:
 45128 0000A271 0000                    	dw 0
 45129                                  ARG_ARGBUF:
 45130                                  	;times 256 dw 0	; times ARGBLEN dw 0 
 45131                                  	; 27/07/2024 PCDOS 7.1 COMMAND.COM
 45132 0000A273 0000<rep 80h>           	times 128 dw 0	; times ARGBLEN dw 0 
 45133                                  ARG_ARGFORCOMBUF:
 45134 0000A373 00<rep 80h>             	times 128 db 0  ; times COMBUFLEN db 0 
 45135                                  
 45136                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9649h
 45137                                  	; 18/06/2023
 45138                                  	; MSDOS 6.22 COMMAND.COM (1994) Transient portion offset 0AD19h
 45139                                  	; 03/08/2024
 45140                                  	; PCDOS 7.1 COMMAND.COM (2003) Transient portion offset 0A823h
 45141                                  ARGBUF_PTR:
 45142 0000A3F3 0000                    	dw 0			; index for argv[].argpointer
 45143                                  TPBUF:				; temporary buffer
 45144                                  Arg_Buf: ; 03/08/2024 - PCDOS 7.1 COMMAND.COM	
 45145 0000A3F5 00<rep 80h>             	times 128 db 0
 45146                                  LASTARG:
 45147 0000A475 0000                    	dw 0			; point at which to accumulate switch info
 45148 0000A477 0000                    COMPTR:	dw 0			; ptr into combuf
 45149                                  
 45150                                  ; Data declarations taken out of path.asm
 45151                                  ;fbuf	find_buf	<>		; dma buffer for findfirst/findnext
 45152                                  ;pathinfo	DW	3 DUP (?)	; ES, SI(old), and SI(new) of user path
 45153                                  ;psep_char	DB	?		; '/' or '\'
 45154                                  ;search_best	DB	(?)		; best code, best filename so far
 45155                                  ;fname_max_len	equ	13
 45156                                  ;search_best_buf DB	fname_max_len DUP (?)
 45157                                  ;search_curdir_buf DB	64 DUP (?)	; a place for CurDir info, if successful
 45158                                  ;search_error	DW	(?)		; address of error message to be printed
 45159                                  
 45160                                  FINDBUFLEN equ FIND_BUF.size ; 43
 45161                                  
 45162                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 96CFh
 45163                                  
 45164                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45165                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AD9Fh
 45166                                  
 45167 0000A479 00<rep 2Bh>             FBUF:	times FINDBUFLEN db 0	; times 43 db 0
 45168                                  FBUF_PNAME equ FBUF+30		; packed name, 13 bytes
 45169                                  pathinfo:
 45170                                  ;pathinfo_0:
 45171 0000A4A4 0000                    	dw 0
 45172                                  ;pathinfo_2:
 45173 0000A4A6 0000                    	dw 0
 45174                                  ;pathinfo_4:
 45175 0000A4A8 0000                    	dw 0
 45176                                  psep_char:
 45177 0000A4AA 00                      	db 0
 45178                                  search_best:
 45179 0000A4AB 00                      	db 0
 45180                                  FNAME_MAX_LEN equ 13
 45181                                  search_best_buf:
 45182 0000A4AC 00<rep Dh>              	times FNAME_MAX_LEN db 0 ; times 13 db 0
 45183                                  search_curdir_buf:
 45184 0000A4B9 00<rep 40h>             	times 64 db 0
 45185                                  search_error:
 45186 0000A4F9 0000                    	dw 0
 45187                                  
 45188                                  ; Data declarations taken out of tbatch.asm
 45189                                  
 45190                                  ;if_not_count	DW	?
 45191                                  ;
 45192                                  ;zflag		db	?		; Used by typefil to indicate ^Z's
 45193                                  ;
 45194                                  ;		DW	80H DUP(0)	; Init to 0 to make sure the linker is not fooled
 45195                                  
 45196                                  ; 31/03/2023
 45197                                  ;STACK:	;LABEL	WORD
 45198                                  
 45199                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9751h
 45200                                  
 45201                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45202                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AE21h
 45203                                  
 45204                                  IF_NOT_COUNT:
 45205 0000A4FB 0000                    	dw 0
 45206 0000A4FD 00                      zflag:	db 0
 45207                                  
 45208                                  align 2	; 18/06/2023
 45209                                  
 45210 0000A4FE 00<rep 100h>            	times 256 db 0 
 45211                                  
 45212                                  	; 16/04/2023
 45213                                  	; MSDOS 5.0 COMMAND.COM - TRANGROUP:9854h
 45214                                  
 45215                                  	; 18/06/2023 - Retro DOS v4.2 COMMAND.COM
 45216                                  	; MSDOS 6.22 COMMAND.COM - TRANGROUP:0AF24h
 45217                                  STACK:
 45218                                  
 45219                                  ;INTERNATVARS	internat_block <>
 45220                                  ;	db	(internat_block_max - ($ - INTERNATVARS)) DUP (?)
 45221                                  
 45222                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9854h
 45223                                  INTERNATVARS:
 45224                                  		; (24+8 = 32 bytes)
 45225                                  DATE_TIME_FORMAT:
 45226 0000A5FE 0000                    	dw 0			; 0-USA, 1-EUR, 2-JAP
 45227                                  CURRENCY_SYM:
 45228 0000A600 0000000000              	db 0,0,0,0,0 		; times 5 db 0	; Currency Symbol 5 bytes
 45229                                  THOUS_SEP:
 45230 0000A605 0000                    	db 0,0			; Thousands separator 2 bytes
 45231                                  DECIMAL_SEP:
 45232 0000A607 0000                    	db 0,0			; Decimal separator 2 bytes
 45233                                  DATE_SEP:
 45234 0000A609 0000                    	db 0,0			; Date separator 2 bytes
 45235                                  TIME_SEP:
 45236 0000A60B 0000                    	db 0,0			; Time separator 2 bytes	
 45237                                  BIT_FIELD:
 45238 0000A60D 00                      	db 0			; Bit values
 45239                                  				;   Bit 0 = 0 if currency symbol first
 45240                                  				;	  = 1 if currency symbol last
 45241                                  				;   Bit 1 = 0 if No space after currency symbol
 45242                                  				;	  = 1 if space after currency symbol
 45243                                  CURRENCY_CENTS:
 45244 0000A60E 00                      	db 0			; Number of places after currency dec point
 45245                                  TIME_24:
 45246 0000A60F 00                      	db 0			; 1 if 24 hour time, 0 if 12 hour time
 45247                                  MAP_CALL:
 45248 0000A610 00000000                	dw 0,0  ; dd 0 		; Address of case mapping call (DWORD)
 45249                                  				; THIS IS TWO WORDS SO IT CAN BE INITIALIZED
 45250                                  				;  in pieces.
 45251                                  DATA_SEP:
 45252 0000A614 0000                    	db 0,0			; Data list separator character		
 45253                                  
 45254 0000A616 00<rep 8h>              	times 8 db 0
 45255                                  
 45256                                  ; Max size of the block returned by the INTERNATIONAL call
 45257                                  
 45258                                  INTERNAT_BLOCK_SIZE EQU	32
 45259                                  
 45260                                  ;;	Buffer for DOS function 64h (Get extended country information)
 45261                                  ;;	subfunctions 2, 4, 6, or 7:
 45262                                  ;
 45263                                  ;CountryPtrInfo	label	byte
 45264                                  ;CountryPtrId	db	?
 45265                                  ;CountryPtr	dd	?
 45266                                  ;		.erre	(($ - CountryPtrInfo) GE 5)
 45267                                  	
 45268                                  	; MSDOS 5.0 COMMAND.COM (1991) Transient portion offset 9874h
 45269                                  CountryPtrInfo:
 45270                                  CountryPtrId:	
 45271 0000A61E 00                      	db 0
 45272                                  CountryPtr:
 45273 0000A61F 00000000                	dd 0
 45274                                  
 45275                                  OldCtrlCHandler:
 45276 0000A623 00000000                	dd 0			; previous int 23 vector		
 45277                                  
 45278                                  BATLEN equ 32
 45279                                  
 45280                                  BATBUFPOS:
 45281 0000A627 0000                    	dw 0			; integer position in buffer of next byte
 45282                                  
 45283 0000A629 00<rep 20h>             BATBUF:	times BATLEN db 0 ; times 32 db 0
 45284                                  BATBUFEND:
 45285 0000A649 0000                    	dw 0
 45286                                  
 45287                                  ; 03/08/2024 - PCDOS 7.1 COMMAND.COM
 45288                                  %if 0
 45289                                  TypeFilSiz:
 45290                                  	dd 0			; stores size of file to be typed
 45291                                  %endif
 45292                                  
 45293                                  ; *****************************************************
 45294                                  ; EMG 4.00
 45295                                  ; DATA STARTING HERE WAS ADDED BY EMG FOR 4.00
 45296                                  ; FOR IMPLEMENTATION OF COMMON PARSE ROUTINE
 45297                                  ; *****************************************************
 45298                                  ;
 45299                                  ; COMMON PARSE OUTPUT BLOCKS
 45300                                  
 45301                                  ; Common output blocks for PARSE number, complex, or string values.
 45302                                  
 45303                                  PARSE1_OUTPUT:
 45304                                  PARSE1_TYPE:
 45305 0000A64B 00                      	db 0			;AN000;  type
 45306                                  PARSE1_CODE:
 45307 0000A64C 00                      	db 0			;AN000;  return value
 45308                                  PARSE1_SYN:
 45309 0000A64D 0000                    	dw 0			;AN000;  es offset of synonym
 45310                                  PARSE1_ADDR:
 45311 0000A64F 00000000                	dd 0			;AN000;  numeric value / address
 45312                                  				;	 of string value
 45313                                  
 45314                                  ;  Common output block for PARSE date strings.
 45315                                  
 45316                                  DATE_OUTPUT:
 45317                                  DATE_TYPE:
 45318 0000A653 00                      	db 0			;AN000;  type
 45319 0000A654 00                      	db 0			;AN000;  return value
 45320 0000A655 0000                    	dw 0			;AN000;  es offset of synonym
 45321                                  DATE_YEAR:
 45322 0000A657 0000                    	dw 0			;AN000;  year
 45323                                  DATE_MONTH:
 45324 0000A659 00                      	db 0			;AN000;  month
 45325                                  DATE_DAY:
 45326 0000A65A 00                      	db 0			;AN000;  day
 45327                                  
 45328                                  ;  Common output block for PARSE time strings.
 45329                                  
 45330                                  TIME_OUTPUT:
 45331                                  TIME_TYPE:
 45332 0000A65B 00                      	db 0			;AN000;  type
 45333 0000A65C 00                      	db 0			;AN000;  return value
 45334 0000A65D 0000                    	dw 0			;AN000;  es offset of synonym
 45335                                  TIME_HOUR:
 45336 0000A65F 00                      	db 0			;AN000;  hour
 45337                                  TIME_MINUTES:
 45338 0000A660 00                      	db 0			;AN000;  minutes
 45339                                  TIME_SECONDS:
 45340 0000A661 00                      	db 0			;AN000;  seconds
 45341                                  TIME_FRACTION:
 45342 0000A662 00                      	db 0			;AN000;  hundredths
 45343                                  
 45344                                  ;  Common output block for PARSE drive specifier (one based drive number).
 45345                                  
 45346                                  DRIVE_OUTPUT:
 45347                                  DRIVE_TYPE:
 45348 0000A663 00                      	db 0			;AN000;  type
 45349                                  DRIVE_VALUE:
 45350 0000A664 00                      	db 0			;AN000;  return value
 45351 0000A665 0000                    	dw 0			;AN000;  es offset of synonym
 45352                                  DRIVE_NUMBER:
 45353 0000A667 00                      	db 0			;AN000;  drive number
 45354 0000A668 000000                  	db 0,0,0		;AN000;  reserved
 45355                                  
 45356                                  	; 18/04/2023
 45357                                  	; 16/04/2023
 45358                                  ;TRANSPACEEND:	; 98C5h
 45359                                  		; End of MSDOS 5.0 COMMAND.COM (1991) Transient portion
 45360                                  
 45361                                  	; 18/06/2023
 45362                                  ;TRANSPACEEND:	; 0AF95h 
 45363                                  		; End of MSDOS 6.22 COMMAND.COM (1994) Transient portion
 45364                                  
 45365                                  ; ----------------------------------------------------------------------------
 45366                                  ; 18/06/2023
 45367                                  ; 20/04/2023
 45368                                  TRANSPACEEND equ ($-TRANSIENTSTART)	; Transient portion size
